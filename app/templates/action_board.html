{% extends "base.html" %}

{% block title %}Action Board — PulsePoint{% endblock %}

{% block content %}
<div x-data="actionBoard()" x-init="init()" style="max-width:900px;margin:0 auto;padding:24px 16px 100px;">

    <!-- Header -->
    <div style="margin-bottom:32px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
            <div>
                <h1 style="font-size:20px;font-weight:700;color:var(--pp-text);letter-spacing:-0.03em;">Action Board</h1>
                <p style="font-size:13px;color:var(--pp-textMuted);margin-top:4px;" x-text="lastRunText"></p>
            </div>
            <div style="display:flex;gap:8px;">
                <button @click="triggerAIAssessmentAll()"
                        :disabled="aiAssessmentRunning || topMatches.length === 0"
                        x-show="topMatches.some(m => !m.ai_checked_at)"
                        style="padding:8px 14px;border-radius:8px;font-size:12px;font-weight:500;border:1px solid var(--pp-border);cursor:pointer;transition:all .15s;background:var(--pp-surface);color:var(--pp-accent);"
                        :style="aiAssessmentRunning ? 'cursor:not-allowed;opacity:0.5;' : ''"
                        x-text="aiAssessmentRunning ? 'KI laeuft...' : 'Alle KI-bewerten'">
                </button>
                <button @click="startMatching()"
                        :disabled="matchingRunning"
                        style="padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .15s;"
                        :style="matchingRunning
                            ? 'background:var(--pp-surface3);color:var(--pp-textDim);cursor:not-allowed;'
                            : 'background:var(--pp-accent);color:#fff;'"
                        x-text="matchingRunning ? 'Laeuft...' : 'Matching starten'">
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;">
                <div style="font-size:22px;font-weight:700;color:var(--pp-text);" x-text="summary.total_top || 0"></div>
                <div style="font-size:11px;color:var(--pp-textMuted);font-weight:500;">Neue Matches</div>
            </div>
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;">
                <div style="font-size:22px;font-weight:700;color:var(--pp-textMuted);" x-text="summary.total_followups || 0"></div>
                <div style="font-size:11px;color:var(--pp-textMuted);font-weight:500;">Follow-ups</div>
            </div>
        </div>
    </div>

    <!-- Progress Bar (sichtbar wenn Matching laeuft ODER Ergebnisse vorhanden) -->
    <div x-show="matchingRunning || showResults" x-transition style="margin-bottom:24px;background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:16px;position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-size:12px;font-weight:600;color:var(--pp-text);" x-text="progressText"></span>
            <div style="display:flex;gap:8px;align-items:center;">
                <!-- Weiter-Button (pulsiert wenn pausiert) -->
                <button x-show="progress.waiting_for_continue"
                        @click="continueMatching()"
                        style="padding:6px 20px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;animation:pulse 1.5s infinite;">
                    Weiter &rarr;
                </button>
                <!-- Stop-Button (nur waehrend Lauf) -->
                <button @click="stopMatching()"
                        x-show="matchingRunning && !progress.waiting_for_continue"
                        style="padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-textDim);">Stop</button>
                <!-- Schliessen-Button (nach Lauf-Ende) -->
                <button @click="showResults = false"
                        x-show="!matchingRunning"
                        style="border:none;background:none;cursor:pointer;font-size:16px;color:var(--pp-textDim);padding:2px 6px;" title="Schliessen">&#10005;</button>
            </div>
        </div>
        <div style="height:6px;background:var(--pp-surface3);border-radius:3px;overflow:hidden;">
            <div style="height:100%;border-radius:3px;transition:width .3s;"
                 :style="'width:' + progressPercent + '%;background:' + (progress.waiting_for_continue ? 'var(--pp-orange)' : 'var(--pp-accent)')"></div>
        </div>
        <div style="display:flex;gap:16px;margin-top:8px;flex-wrap:wrap;">
            <span style="font-size:11px;color:var(--pp-textDim);" x-text="'Geo-Paare: ' + (progress.geo_pairs_found || 0)"></span>
            <span style="font-size:11px;color:var(--pp-green);" x-text="'Rollen-Matches: ' + (progress.role_matches || 0)"></span>
            <span style="font-size:11px;color:var(--pp-accent);" x-text="'Fahrzeit: ' + (progress.drive_time_done || 0) + '/' + (progress.drive_time_total || 0)"></span>
            <span style="font-size:11px;color:var(--pp-textDim);" x-text="'Gespeichert: ' + (progress.matches_saved || 0)"></span>
        </div>

        <!-- Phasen-Ergebnisse (Zwischenergebnisse) -->
        <template x-if="progress.phase_results">
            <div style="margin-top:14px;">

                <!-- Cleanup -->
                <template x-if="progress.phase_results.cleanup">
                    <div style="padding:8px 12px;background:var(--pp-surface3);border-radius:6px;margin-bottom:6px;font-size:12px;color:var(--pp-text);">
                        <span style="font-weight:600;">Phase 0 — Cleanup:</span>
                        <span x-text="progress.phase_results.cleanup.message" style="margin-left:6px;color:var(--pp-textMuted);"></span>
                    </div>
                </template>

                <!-- Geo-Filter Ergebnisse -->
                <template x-if="progress.phase_results.geo_filter && progress.phase_results.geo_filter.length > 0">
                    <div style="margin-bottom:8px;">
                        <div style="font-size:11px;font-weight:700;color:var(--pp-textDim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;">
                            Phase A — Geo-Filter: <span x-text="progress.geo_pairs_found" style="color:var(--pp-text);"></span> Paare in 27km
                        </div>
                        <div style="max-height:200px;overflow-y:auto;border:1px solid var(--pp-border);border-radius:8px;">
                            <table style="width:100%;border-collapse:collapse;font-size:11px;">
                                <thead><tr style="background:var(--pp-surface3);position:sticky;top:0;">
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Kandidat</th>
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Rolle</th>
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Stelle</th>
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Firma</th>
                                    <th style="padding:6px 8px;text-align:right;font-weight:600;color:var(--pp-textMuted);">km</th>
                                    <th style="padding:6px 4px;text-align:center;font-weight:600;color:var(--pp-textMuted);width:30px;"></th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="r in progress.phase_results.geo_filter" :key="r.candidate_id + r.job_id">
                                        <tr style="border-top:1px solid var(--pp-borderLight);">
                                            <td style="padding:5px 8px;color:var(--pp-text);" x-text="r.kandidat"></td>
                                            <td style="padding:5px 8px;color:var(--pp-accent);" x-text="r.kandidat_rolle"></td>
                                            <td style="padding:5px 8px;color:var(--pp-text);" x-text="r.job"></td>
                                            <td style="padding:5px 8px;color:var(--pp-textMuted);" x-text="r.firma"></td>
                                            <td style="padding:5px 8px;text-align:right;color:var(--pp-textDim);" x-text="r.distanz_km"></td>
                                            <td style="padding:5px 4px;text-align:center;">
                                                <button @click="openCompare(r.candidate_id, r.job_id)"
                                                        style="border:none;background:none;cursor:pointer;font-size:14px;color:var(--pp-accent);padding:0;" title="Vergleichen">&#128269;</button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>

                <!-- Rollen-Filter Ergebnisse -->
                <template x-if="progress.phase_results.role_filter && progress.phase_results.role_filter.length > 0">
                    <div style="margin-bottom:8px;">
                        <div style="font-size:11px;font-weight:700;color:var(--pp-textDim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;">
                            Phase B — Rollen-Match: <span x-text="progress.role_matches" style="color:var(--pp-green);"></span> Treffer
                        </div>
                        <div style="max-height:200px;overflow-y:auto;border:1px solid var(--pp-border);border-radius:8px;">
                            <table style="width:100%;border-collapse:collapse;font-size:11px;">
                                <thead><tr style="background:var(--pp-surface3);position:sticky;top:0;">
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Kandidat</th>
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Stelle / Firma</th>
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Gematchte Rollen</th>
                                    <th style="padding:6px 8px;text-align:right;font-weight:600;color:var(--pp-textMuted);">km</th>
                                    <th style="padding:6px 4px;text-align:center;font-weight:600;color:var(--pp-textMuted);width:30px;"></th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="r in progress.phase_results.role_filter" :key="r.candidate_id + r.job_id">
                                        <tr style="border-top:1px solid var(--pp-borderLight);">
                                            <td style="padding:5px 8px;color:var(--pp-text);" x-text="r.kandidat"></td>
                                            <td style="padding:5px 8px;color:var(--pp-text);"><span x-text="r.job"></span> <span style="color:var(--pp-textMuted);" x-text="r.firma"></span></td>
                                            <td style="padding:5px 8px;">
                                                <div style="display:flex;flex-wrap:wrap;gap:3px;">
                                                    <template x-for="role in (r.gematchte_rollen || [])">
                                                        <span style="font-size:10px;padding:1px 6px;border-radius:4px;background:var(--pp-greenSoft);color:var(--pp-green);font-weight:500;" x-text="role"></span>
                                                    </template>
                                                </div>
                                            </td>
                                            <td style="padding:5px 8px;text-align:right;color:var(--pp-textDim);" x-text="r.distanz_km"></td>
                                            <td style="padding:5px 4px;text-align:center;">
                                                <button @click="openCompare(r.candidate_id, r.job_id)"
                                                        style="border:none;background:none;cursor:pointer;font-size:14px;color:var(--pp-accent);padding:0;" title="Vergleichen">&#128269;</button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>

                <!-- Fahrzeit Ergebnisse -->
                <template x-if="progress.phase_results.drive_time && progress.phase_results.drive_time.length > 0">
                    <div style="margin-bottom:8px;">
                        <div style="font-size:11px;font-weight:700;color:var(--pp-textDim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;">
                            Phase C — Fahrzeit: <span x-text="progress.drive_time_done" style="color:var(--pp-accent);"></span> berechnet
                        </div>
                        <div style="max-height:200px;overflow-y:auto;border:1px solid var(--pp-border);border-radius:8px;">
                            <table style="width:100%;border-collapse:collapse;font-size:11px;">
                                <thead><tr style="background:var(--pp-surface3);position:sticky;top:0;">
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Kandidat</th>
                                    <th style="padding:6px 8px;text-align:left;font-weight:600;color:var(--pp-textMuted);">Stelle</th>
                                    <th style="padding:6px 8px;text-align:right;font-weight:600;color:var(--pp-textMuted);">km</th>
                                    <th style="padding:6px 8px;text-align:right;font-weight:600;color:var(--pp-textMuted);">Auto</th>
                                    <th style="padding:6px 8px;text-align:right;font-weight:600;color:var(--pp-textMuted);">OEPNV</th>
                                    <th style="padding:6px 4px;text-align:center;font-weight:600;color:var(--pp-textMuted);width:30px;"></th>
                                </tr></thead>
                                <tbody>
                                    <template x-for="r in progress.phase_results.drive_time" :key="r.candidate_id + r.job_id">
                                        <tr style="border-top:1px solid var(--pp-borderLight);">
                                            <td style="padding:5px 8px;color:var(--pp-text);" x-text="r.kandidat"></td>
                                            <td style="padding:5px 8px;color:var(--pp-text);" x-text="r.job"></td>
                                            <td style="padding:5px 8px;text-align:right;color:var(--pp-textDim);" x-text="r.distanz_km"></td>
                                            <td style="padding:5px 8px;text-align:right;"
                                                :style="'font-weight:600;color:' + (r.auto_min != null ? (r.auto_min <= 20 ? 'var(--pp-green)' : r.auto_min <= 40 ? 'var(--pp-orange)' : 'var(--pp-textDim)') : 'var(--pp-textDim)')"
                                                x-text="r.auto_min != null ? r.auto_min + ' Min' : '—'"></td>
                                            <td style="padding:5px 8px;text-align:right;color:var(--pp-textMuted);"
                                                x-text="r.oepnv_min != null ? r.oepnv_min + ' Min' : '—'"></td>
                                            <td style="padding:5px 4px;text-align:center;">
                                                <button @click="openCompare(r.candidate_id, r.job_id)"
                                                        style="border:none;background:none;cursor:pointer;font-size:14px;color:var(--pp-accent);padding:0;" title="Vergleichen">&#128269;</button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>

                <!-- Gespeichert -->
                <template x-if="progress.phase_results.saved">
                    <div style="padding:8px 12px;background:var(--pp-surface3);border-radius:6px;margin-bottom:6px;font-size:12px;color:var(--pp-text);">
                        <span style="font-weight:600;">Phase D — Gespeichert:</span>
                        <span x-text="progress.phase_results.saved.message" style="margin-left:6px;color:var(--pp-textMuted);"></span>
                    </div>
                </template>

                <!-- Telegram -->
                <template x-if="progress.phase_results.telegram && progress.phase_results.telegram.length > 0">
                    <div style="padding:8px 12px;background:var(--pp-surface3);border-radius:6px;margin-bottom:6px;font-size:12px;color:var(--pp-text);">
                        <span style="font-weight:600;">Phase E — Telegram:</span>
                        <span style="margin-left:6px;color:var(--pp-green);" x-text="progress.telegram_sent + ' Notifications gesendet'"></span>
                    </div>
                </template>
            </div>
        </template>
    </div>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(1.03); }
        }
    </style>

    <!-- Loading -->
    <div x-show="loading" style="text-align:center;padding:40px;color:var(--pp-textMuted);font-size:13px;">
        Lade Matches...
    </div>

    <!-- Empty State -->
    <div x-show="!loading && topMatches.length === 0 && followUps.length === 0 && !matchingRunning"
         style="text-align:center;padding:60px 20px;color:var(--pp-textMuted);">
        <div style="font-size:32px;margin-bottom:12px;">&#128640;</div>
        <p style="font-size:15px;font-weight:600;color:var(--pp-text);margin-bottom:6px;">Keine neuen Matches</p>
        <p style="font-size:13px;">Klicke "Matching starten" um neue Rollen-Matches zu finden.</p>
    </div>

    <!-- TOP MATCHES -->
    <div x-show="!loading && topMatches.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-text);margin-bottom:12px;letter-spacing:-0.02em;">
            Neue Matches
            <span style="font-size:12px;font-weight:500;color:var(--pp-textMuted);margin-left:6px;" x-text="'(' + topMatches.length + ')'"></span>
        </h2>

        <template x-for="match in topMatches" :key="match.match_id">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:12px;padding:18px;margin-bottom:10px;">
                <!-- Header: Kandidat-Name + Rolle → Job -->
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="flex:1;">
                        <span style="font-size:14px;font-weight:700;color:var(--pp-text);"
                              x-text="(match.candidate_first_name || '') + ' ' + (match.candidate_last_name || '')"></span>
                        <span style="font-size:11px;color:var(--pp-accent);font-weight:500;margin-left:4px;"
                              x-text="'(' + (match.candidate_role || '?') + ')'"></span>
                        <div style="font-size:12px;color:var(--pp-textMuted);margin-top:2px;">
                            <span x-text="match.job_position"></span>
                            <span x-text="' bei ' + match.job_company + ', ' + match.job_city"></span>
                        </div>
                    </div>
                    <!-- KI-Badge oder Fahrzeit-Pill -->
                    <div style="flex-shrink:0;margin-left:12px;display:flex;gap:6px;align-items:center;">
                        <span x-show="match.ai_checked_at"
                              style="font-size:10px;font-weight:600;padding:3px 10px;border-radius:50px;background:var(--pp-greenSoft);color:var(--pp-green);">KI bewertet</span>
                        <div x-show="match.ai_checked_at && match.v2_score"
                             style="border-radius:50px;padding:4px 12px;font-weight:700;font-size:14px;color:#fff;flex-shrink:0;"
                             :style="'background:' + (match.v2_score >= 85 ? 'var(--pp-green)' : match.v2_score >= 70 ? 'var(--pp-accent)' : 'var(--pp-orange)')"
                             x-text="Math.round(match.v2_score)"></div>
                    </div>
                </div>

                <!-- Gematchte Rollen -->
                <div x-show="match.v2_score_breakdown && match.v2_score_breakdown.matched_roles && match.v2_score_breakdown.matched_roles.length > 0"
                     style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;">
                    <template x-for="role in (match.v2_score_breakdown?.matched_roles || [])">
                        <span style="font-size:11px;padding:2px 8px;border-radius:50px;background:var(--pp-greenSoft);color:var(--pp-green);font-weight:500;" x-text="role"></span>
                    </template>
                </div>

                <!-- Fahrzeit + Distanz -->
                <div style="display:flex;gap:12px;margin-top:8px;font-size:12px;">
                    <span x-show="match.drive_time_car_min != null"
                          :style="'font-weight:600;color:' + (match.drive_time_car_min <= 20 ? 'var(--pp-green)' : match.drive_time_car_min <= 40 ? 'var(--pp-orange)' : 'var(--pp-textDim)')"
                          x-text="match.drive_time_car_min + ' Min Auto'"></span>
                    <span x-show="match.drive_time_transit_min != null"
                          style="color:var(--pp-textMuted);"
                          x-text="match.drive_time_transit_min + ' Min OEPNV'"></span>
                    <span x-show="match.distance_km" style="color:var(--pp-textDim);"
                          x-text="match.distance_km + ' km'"></span>
                    <span x-show="match.candidate_city" style="color:var(--pp-textMuted);"
                          x-text="'aus ' + match.candidate_city"></span>
                </div>

                <!-- KI-Bewertung Ergebnisse (wenn vorhanden) -->
                <template x-if="match.ai_checked_at && match.ai_explanation">
                    <div style="margin-top:10px;padding:10px 14px;background:var(--pp-surface3);border-radius:8px;">
                        <p style="font-size:13px;color:var(--pp-text);line-height:1.5;" x-text="match.ai_explanation"></p>
                        <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;">
                            <template x-for="s in (match.ai_strengths || [])">
                                <span style="font-size:11px;padding:2px 8px;border-radius:50px;background:var(--pp-greenSoft);color:var(--pp-green);font-weight:500;" x-text="'+ ' + s"></span>
                            </template>
                            <template x-for="w in (match.ai_weaknesses || [])">
                                <span style="font-size:11px;padding:2px 8px;border-radius:50px;background:var(--pp-redSoft);color:var(--pp-red);font-weight:500;" x-text="'- ' + w"></span>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Action Buttons -->
                <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
                    <button @click="prepareEmail(match.match_id, 'job_an_kandidat')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-green);color:#fff;">Job an Kandidat</button>
                    <button @click="openContactDialog(match.match_id, match.candidate_id, match.job_id)"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;">Profil an Kunden</button>
                    <button @click="openCompare(match.candidate_id, match.job_id)"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-accent);">Vergleich</button>
                    <a :href="'/kandidaten/' + match.candidate_id"
                       style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-text);text-decoration:none;">Kandidat</a>
                    <button @click="triggerAIAssessment([match.match_id])"
                            x-show="!match.ai_checked_at"
                            :disabled="aiAssessmentRunning"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-accent);"
                            :style="aiAssessmentRunning ? 'opacity:0.5;cursor:not-allowed;' : ''">KI-Bewertung</button>
                    <button @click="doAction(match.match_id, 'spaeter')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-textMuted);">Spaeter</button>
                    <button @click="doAction(match.match_id, 'ablehnen')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:transparent;color:var(--pp-textDim);">Ablehnen</button>
                </div>
            </div>
        </template>
    </div>

    <!-- FOLLOW-UPS -->
    <div x-show="!loading && followUps.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-textMuted);margin-bottom:12px;">
            Follow-ups
            <span style="font-size:12px;font-weight:500;margin-left:6px;" x-text="'(' + followUps.length + ')'"></span>
        </h2>

        <template x-for="match in followUps" :key="match.match_id">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                <div style="flex:1;">
                    <span style="font-size:13px;font-weight:600;color:var(--pp-text);"
                          x-text="(match.candidate_first_name || '') + ' ' + (match.candidate_last_name || match.candidate_role || 'Kandidat')"></span>
                    <span style="font-size:12px;color:var(--pp-textDim);"> &rarr; </span>
                    <span style="font-size:12px;color:var(--pp-text);" x-text="match.job_position + ' bei ' + match.job_company"></span>
                    <div style="font-size:11px;color:var(--pp-textMuted);margin-top:2px;">
                        <span x-show="match.drive_time_car_min != null" x-text="match.drive_time_car_min + ' Min Auto'"></span>
                        <span x-show="match.distance_km" x-text="' | ' + match.distance_km + ' km'"></span>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex-shrink:0;margin-left:12px;flex-wrap:wrap;">
                    <span x-show="match.ai_checked_at"
                          style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:50px;background:var(--pp-greenSoft);color:var(--pp-green);">KI</span>
                    <div x-show="match.v2_score"
                         style="border-radius:50px;padding:3px 10px;font-weight:700;font-size:12px;color:#fff;background:var(--pp-accent);" x-text="Math.round(match.v2_score || 0)"></div>
                    <button @click="prepareEmail(match.match_id, 'job_an_kandidat')"
                            style="padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;background:var(--pp-green);color:#fff;">Job an Kandidat</button>
                    <button @click="openContactDialog(match.match_id, match.candidate_id, match.job_id)"
                            style="padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;">Profil an Kunden</button>
                    <button @click="doAction(match.match_id, 'ablehnen')"
                            style="padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-textDim);">X</button>
                </div>
            </div>
        </template>
    </div>

    <!-- REGIONALE INSIGHTS -->
    <div x-show="!loading && regions.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-text);margin-bottom:12px;">
            Regionale Uebersicht
            <span style="font-size:12px;font-weight:500;color:var(--pp-textMuted);margin-left:6px;" x-text="'(' + regions.length + ' Staedte)'"></span>
        </h2>

        <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px;">
            <template x-for="region in regions" :key="region.city">
                <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="region.city"></span>
                        <span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:50px;"
                              :style="region.status === 'gut_abgedeckt' ? 'background:var(--pp-greenSoft);color:var(--pp-green);'
                                    : region.status === 'ausbaufaehig' ? 'background:var(--pp-orangeSoft);color:var(--pp-orange);'
                                    : region.status === 'sourcing_chance' ? 'background:#e0e7ff;color:#4338ca;'
                                    : 'background:var(--pp-surface3);color:var(--pp-textDim);'"
                              x-text="region.status === 'gut_abgedeckt' ? 'Gut abgedeckt'
                                    : region.status === 'ausbaufaehig' ? 'Ausbaufaehig'
                                    : region.status === 'sourcing_chance' ? 'Sourcing-Chance'
                                    : 'Keine Abdeckung'"></span>
                    </div>
                    <div style="display:flex;gap:16px;font-size:11px;color:var(--pp-textMuted);">
                        <span x-text="region.candidate_count + ' Kandidaten'"></span>
                        <span x-text="region.job_count + ' Jobs'"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Compare Modal -->
    <div x-show="compareOpen" x-transition
         style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:50;display:flex;align-items:center;justify-content:center;"
         @click.self="compareOpen = false">
        <div style="background:var(--pp-surface);border-radius:16px;width:90%;max-width:800px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--pp-border);">
                <h3 style="font-size:15px;font-weight:700;color:var(--pp-text);">Vergleich</h3>
                <button @click="compareOpen = false" style="border:none;background:none;cursor:pointer;font-size:18px;color:var(--pp-textDim);">&#10005;</button>
            </div>
            <div id="compare-content" style="padding:20px;" x-html="compareHtml">
                <div style="text-align:center;color:var(--pp-textMuted);padding:40px;">Lade Vergleich...</div>
            </div>
        </div>
    </div>

    <!-- Contact Selection Dialog -->
    <div x-show="contactDialogOpen" x-transition
         style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:60;display:flex;align-items:center;justify-content:center;"
         @click.self="contactDialogOpen = false">
        <div style="background:var(--pp-surface);border-radius:16px;width:90%;max-width:480px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding:20px 24px;border-bottom:1px solid var(--pp-border);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="font-size:15px;font-weight:700;color:var(--pp-text);">Kandidat vorstellen bei:</h3>
                    <button @click="contactDialogOpen = false" style="border:none;background:none;cursor:pointer;font-size:18px;color:var(--pp-textDim);">&#10005;</button>
                </div>
                <p style="font-size:13px;color:var(--pp-accent);margin-top:4px;" x-text="contactData.company_name + ' — ' + contactData.job_position"></p>
            </div>

            <div style="padding:16px 24px;">
                <!-- Loading -->
                <div x-show="contactLoading" style="text-align:center;padding:20px;color:var(--pp-textMuted);font-size:13px;">Lade Kontakte...</div>

                <!-- Kontakt-Liste -->
                <div x-show="!contactLoading">
                    <p style="font-size:12px;font-weight:600;color:var(--pp-textMuted);margin-bottom:10px;">An wen senden?</p>

                    <template x-for="(contact, idx) in contactData.contacts || []" :key="contact.contact_id">
                        <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;margin-bottom:6px;border:1px solid var(--pp-border);"
                               :style="selectedContactEmail === contact.email ? 'border-color:var(--pp-accent);background:var(--pp-surface3);' : ''">
                            <input type="radio" name="contact" :value="contact.email" x-model="selectedContactEmail"
                                   style="accent-color:var(--pp-accent);" />
                            <div>
                                <div style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="contact.name"></div>
                                <div style="font-size:11px;color:var(--pp-textMuted);" x-text="contact.position"></div>
                                <div style="font-size:11px;color:var(--pp-accent);" x-text="contact.email"></div>
                            </div>
                        </label>
                    </template>

                    <!-- Keine Kontakte -->
                    <div x-show="!contactData.contacts || contactData.contacts.length === 0"
                         style="padding:12px;font-size:12px;color:var(--pp-textMuted);text-align:center;">
                        Keine Kontakte im Unternehmen hinterlegt.
                    </div>

                    <!-- Manuelle E-Mail -->
                    <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;margin-top:10px;border:1px solid var(--pp-border);"
                           :style="selectedContactEmail === '__custom__' ? 'border-color:var(--pp-accent);background:var(--pp-surface3);' : ''">
                        <input type="radio" name="contact" value="__custom__" x-model="selectedContactEmail"
                               style="accent-color:var(--pp-accent);" />
                        <div style="flex:1;">
                            <div style="font-size:13px;font-weight:600;color:var(--pp-text);">Andere E-Mail</div>
                            <input x-show="selectedContactEmail === '__custom__'" type="email" x-model="customContactEmail"
                                   placeholder="email@firma.de"
                                   style="margin-top:6px;width:100%;padding:6px 10px;border-radius:6px;border:1px solid var(--pp-border);background:var(--pp-surfaceHover);color:var(--pp-text);font-size:12px;outline:none;" />
                        </div>
                    </label>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding:16px 24px;border-top:1px solid var(--pp-border);display:flex;gap:8px;justify-content:flex-end;">
                <button @click="contactDialogOpen = false"
                        style="padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-textMuted);">Abbrechen</button>
                <button @click="submitProfilAnKunden()"
                        :disabled="!canSubmitContact"
                        style="padding:8px 20px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;"
                        :style="!canSubmitContact ? 'opacity:0.5;cursor:not-allowed;' : ''">Profil senden</button>
            </div>
        </div>
    </div>

    <!-- Email Preview Dialog -->
    <div x-show="emailPreviewOpen" x-transition
         style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:70;display:flex;align-items:center;justify-content:center;"
         @click.self="emailPreviewOpen = false">
        <div style="background:var(--pp-surface);border-radius:16px;width:92%;max-width:600px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="padding:20px 24px;border-bottom:1px solid var(--pp-border);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="font-size:15px;font-weight:700;color:var(--pp-text);">E-Mail vorbereiten</h3>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:11px;padding:3px 10px;border-radius:50px;font-weight:600;"
                              :style="emailPreviewData.variant === 'erstkontakt'
                                  ? 'background:rgba(52,211,153,0.15);color:#34D399;'
                                  : 'background:rgba(167,139,250,0.15);color:#a78bfa;'"
                              x-text="emailPreviewData.variant === 'erstkontakt' ? 'Erstkontakt' : 'Folgekontakt'"></span>
                        <button @click="emailPreviewOpen = false" style="border:none;background:none;cursor:pointer;font-size:18px;color:var(--pp-textDim);">&#10005;</button>
                    </div>
                </div>
                <p style="font-size:12px;color:var(--pp-textMuted);margin-top:4px;"
                   x-text="(emailPreviewData.direction === 'job_an_kandidat' ? 'Job an Kandidat' : 'Profil an Kunden') + ' — ' + (emailPreviewData.candidate_name || '') + ' / ' + (emailPreviewData.job_position || '')"></p>
            </div>

            <!-- Loading -->
            <div x-show="emailPreviewLoading" style="text-align:center;padding:40px;color:var(--pp-textMuted);font-size:13px;">
                E-Mail wird vorbereitet...
            </div>

            <!-- Content -->
            <div x-show="!emailPreviewLoading" style="padding:16px 24px;">
                <!-- Empfaenger -->
                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;font-weight:600;color:var(--pp-textMuted);display:block;margin-bottom:4px;">An:</label>
                    <div style="font-size:13px;color:var(--pp-accent);font-weight:500;" x-text="emailPreviewData.recipient_email"></div>
                </div>

                <!-- Betreff (editierbar) -->
                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;font-weight:600;color:var(--pp-textMuted);display:block;margin-bottom:4px;">Betreff:</label>
                    <input type="text" x-model="emailPreviewData.subject"
                           style="width:100%;padding:8px 12px;border-radius:8px;border:1px solid var(--pp-border);background:var(--pp-surfaceHover);color:var(--pp-text);font-size:13px;outline:none;" />
                </div>

                <!-- E-Mail-Text (editierbar) -->
                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;font-weight:600;color:var(--pp-textMuted);display:block;margin-bottom:4px;">Nachricht:</label>
                    <textarea x-model="emailPreviewData.body_text"
                              rows="14"
                              style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--pp-border);background:var(--pp-surfaceHover);color:var(--pp-text);font-size:13px;line-height:1.6;outline:none;resize:vertical;font-family:inherit;"></textarea>
                </div>

                <!-- Info -->
                <div style="font-size:11px;color:var(--pp-textDim);margin-bottom:8px;">
                    PDF wird automatisch angehaengt. Text kann vor dem Senden bearbeitet werden.
                </div>
            </div>

            <!-- Footer -->
            <div x-show="!emailPreviewLoading" style="padding:16px 24px;border-top:1px solid var(--pp-border);display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;">
                <button @click="emailPreviewOpen = false"
                        style="padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-textMuted);">Abbrechen</button>
                <button @click="emailNurPdf()"
                        style="padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-text);">Nur PDF</button>
                <button @click="sendEmail()"
                        :disabled="emailSending"
                        style="padding:8px 20px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-green);color:#fff;"
                        :style="emailSending ? 'opacity:0.5;cursor:not-allowed;' : ''">
                    <span x-text="emailSending ? 'Sende...' : 'Senden'"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function actionBoard() {
    return {
        // Matches
        topMatches: [],
        followUps: [],
        regions: [],
        summary: {},
        loading: true,
        matchingRunning: false,
        progress: {},
        lastRun: null,
        pollInterval: null,

        // Ergebnisse anzeigen (nach Lauf-Ende)
        showResults: false,

        // KI-Bewertung
        aiAssessmentRunning: false,

        // Compare Modal
        compareOpen: false,
        compareHtml: '',

        // Contact Dialog
        contactDialogOpen: false,
        contactLoading: false,
        contactData: {},
        contactMatchId: null,
        selectedContactEmail: '',
        customContactEmail: '',

        // Email Preview Dialog
        emailPreviewOpen: false,
        emailPreviewLoading: false,
        emailPreviewData: {},
        emailPreviewMatchId: '',
        emailSending: false,

        get lastRunText() {
            if (this.lastRun) {
                try {
                    const d = new Date(this.lastRun);
                    const mins = Math.round((Date.now() - d.getTime()) / 60000);
                    if (mins < 1) return 'Letzter Lauf: gerade eben';
                    if (mins < 60) return 'Letzter Lauf: vor ' + mins + ' Min';
                    const hrs = Math.round(mins / 60);
                    return 'Letzter Lauf: vor ' + hrs + ' Std';
                } catch(e) {}
            }
            return 'Noch kein Lauf';
        },

        get progressPercent() {
            const phase = this.progress.phase || '';
            if (phase === 'cleanup') return 5;
            if (phase === 'cleanup_done') return 8;
            if (phase === 'geo_filter') return 15;
            if (phase === 'geo_filter_done') return 20;
            if (phase === 'role_filter') return 30;
            if (phase === 'role_filter_done') return 35;
            if (phase === 'drive_time') {
                const done = this.progress.drive_time_done || 0;
                const total = this.progress.drive_time_total || 1;
                return 35 + Math.round((done / total) * 45);
            }
            if (phase === 'drive_time_done') return 82;
            if (phase === 'saving') return 85;
            if (phase === 'saving_done') return 92;
            if (phase === 'telegram') return 95;
            if (phase === 'done') return 100;
            return 3;
        },

        get progressText() {
            const phase = this.progress.phase || '';
            const waiting = this.progress.waiting_for_continue;
            if (phase === 'cleanup') return 'Alte Matches aufraemen...';
            if (phase === 'cleanup_done') return 'Cleanup fertig — Weiter fuer Geo-Filter';
            if (phase === 'geo_filter') return 'Geo-Filter (27km)...';
            if (phase === 'geo_filter_done') return (this.progress.geo_pairs_found || 0) + ' Geo-Paare gefunden — Weiter fuer Rollen-Abgleich';
            if (phase === 'role_filter') return 'Rollen-Abgleich...';
            if (phase === 'role_filter_done') return (this.progress.role_matches || 0) + ' Rollen-Matches — Weiter fuer Fahrzeit';
            if (phase === 'drive_time') return 'Fahrzeit: ' + (this.progress.drive_time_done || 0) + '/' + (this.progress.drive_time_total || '?');
            if (phase === 'drive_time_done') return 'Fahrzeit fertig — Weiter zum Speichern';
            if (phase === 'saving') return 'Speichere Matches...';
            if (phase === 'saving_done') return (this.progress.matches_saved || 0) + ' Matches gespeichert — Weiter fuer Telegram';
            if (phase === 'telegram') return 'Telegram-Benachrichtigungen...';
            if (phase === 'done') return 'Fertig! ' + (this.progress.matches_saved || 0) + ' Matches';
            if (phase === 'error') return 'FEHLER: ' + (this.progress.error_message || '');
            return 'Initialisierung...';
        },

        async init() {
            await this.loadStatus();
            await this.loadMatches();
            await this.loadRegionalInsights();
            this.loading = false;
        },

        async loadMatches() {
            try {
                const res = await fetch('/api/v4/claude-match/daily?limit=20');
                const data = await res.json();
                this.topMatches = data.top_matches || [];
                this.followUps = data.follow_ups || [];
                this.summary = data.summary || {};
            } catch(e) {
                console.error('Fehler beim Laden:', e);
            }
        },

        async loadRegionalInsights() {
            try {
                const res = await fetch('/api/v4/claude-match/regional-insights');
                const data = await res.json();
                this.regions = data.regions || [];
            } catch(e) {
                console.error('Regional Insights Fehler:', e);
            }
        },

        async loadStatus() {
            try {
                const res = await fetch('/api/v4/claude-match/status');
                const data = await res.json();
                this.matchingRunning = data.running || false;
                this.progress = data.progress || {};
                this.lastRun = data.last_run;

                if (this.matchingRunning && !this.pollInterval) {
                    this.startPolling();
                }
            } catch(e) {}
        },

        // ── Matching starten (mit Pausen-Modus) ──
        async startMatching() {
            if (this.matchingRunning) return;
            this.matchingRunning = true;
            this.showResults = false;
            this.progress = {};
            try {
                await fetch('/api/v4/claude-match/run?pause=true', {method: 'POST'});
                this.startPolling();
            } catch(e) {
                this.matchingRunning = false;
                console.error('Start fehlgeschlagen:', e);
            }
        },

        // ── Weiter-Button: naechste Phase starten ──
        async continueMatching() {
            try {
                await fetch('/api/v4/claude-match/continue', {method: 'POST'});
            } catch(e) {
                console.error('Weiter fehlgeschlagen:', e);
            }
        },

        // ── Matching stoppen ──
        async stopMatching() {
            try {
                await fetch('/api/v4/claude-match/stop', {method: 'POST'});
            } catch(e) {
                console.error('Stop fehlgeschlagen:', e);
            }
        },

        startPolling() {
            if (this.pollInterval) clearInterval(this.pollInterval);
            this.pollInterval = setInterval(async () => {
                await this.loadStatus();
                if (!this.matchingRunning) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    // Ergebnisse anzeigen lassen
                    if (this.progress.phase_results && Object.keys(this.progress.phase_results).length > 0) {
                        this.showResults = true;
                    }
                    await this.loadMatches();
                }
            }, 2000);
        },

        // ── KI-Bewertung ──
        async triggerAIAssessment(matchIds) {
            if (this.aiAssessmentRunning) return;
            this.aiAssessmentRunning = true;
            try {
                const res = await fetch('/api/v4/claude-match/ai-assessment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({match_ids: matchIds}),
                });
                const data = await res.json();
                if (data.status === 'started') {
                    // Polling fuer KI-Bewertung
                    const aiPoll = setInterval(async () => {
                        const sRes = await fetch('/api/v4/claude-match/status');
                        const sData = await sRes.json();
                        if (!sData.running) {
                            clearInterval(aiPoll);
                            this.aiAssessmentRunning = false;
                            await this.loadMatches();
                        }
                    }, 3000);
                } else {
                    this.aiAssessmentRunning = false;
                    if (data.message) alert(data.message);
                }
            } catch(e) {
                this.aiAssessmentRunning = false;
                console.error('KI-Bewertung fehlgeschlagen:', e);
            }
        },

        async triggerAIAssessmentAll() {
            const matchIds = this.topMatches
                .filter(m => !m.ai_checked_at)
                .map(m => m.match_id);
            if (matchIds.length === 0) return;
            await this.triggerAIAssessment(matchIds);
        },

        // ── Vergleich oeffnen ──
        async openCompare(candidateId, jobId) {
            this.compareOpen = true;
            this.compareHtml = '<div style="text-align:center;color:var(--pp-textMuted);padding:40px;">Lade Vergleich...</div>';
            try {
                const res = await fetch('/api/v4/claude-match/compare-pair?candidate_id=' + candidateId + '&job_id=' + jobId);
                const data = await res.json();
                if (data.data) {
                    const d = data.data;
                    this.compareHtml = this.buildCompareHtml(d);
                } else {
                    this.compareHtml = '<div style="text-align:center;color:var(--pp-red);padding:40px;">Keine Daten gefunden</div>';
                }
            } catch(e) {
                this.compareHtml = '<div style="text-align:center;color:var(--pp-red);padding:40px;">Fehler: ' + e.message + '</div>';
            }
        },

        _esc(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        },

        _sectionHeader(title) {
            return '<div style="font-size:11px;font-weight:700;color:var(--pp-textDim);text-transform:uppercase;letter-spacing:0.05em;margin-top:14px;margin-bottom:6px;border-bottom:1px solid var(--pp-borderLight);padding-bottom:4px;">' + title + '</div>';
        },

        _tagList(items, bg, color) {
            if (!items || !Array.isArray(items) || items.length === 0) return '';
            let html = '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;">';
            items.forEach(s => {
                const text = typeof s === 'object' ? (s.name || s.skill || JSON.stringify(s)) : String(s);
                html += '<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:' + (bg || 'var(--pp-surface3)') + ';color:' + (color || 'var(--pp-text)') + ';">' + this._esc(text) + '</span>';
            });
            html += '</div>';
            return html;
        },

        buildCompareHtml(d) {
            let html = '';

            // ── Distanz / Fahrzeit Header ──
            if (d.distance_km || d.drive_time_car_min || d.drive_time_transit_min) {
                html += '<div style="display:flex;gap:16px;margin-bottom:16px;padding:10px 14px;background:var(--pp-surface3);border-radius:8px;font-size:12px;align-items:center;">';
                if (d.distance_km) html += '<span style="color:var(--pp-textMuted);">Distanz: <b style="color:var(--pp-text);">' + this._esc(d.distance_km) + ' km</b></span>';
                if (d.drive_time_car_min) {
                    const carColor = d.drive_time_car_min <= 20 ? 'var(--pp-green)' : d.drive_time_car_min <= 40 ? 'var(--pp-orange)' : 'var(--pp-textDim)';
                    html += '<span style="color:var(--pp-textMuted);">Auto: <b style="color:' + carColor + ';">' + d.drive_time_car_min + ' Min</b></span>';
                }
                if (d.drive_time_transit_min) html += '<span style="color:var(--pp-textMuted);">OEPNV: <b style="color:var(--pp-text);">' + d.drive_time_transit_min + ' Min</b></span>';
                html += '</div>';
            }

            // ── Zwei-Spalten-Layout ──
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';

            // ═══ LINKE SPALTE: Kandidat ═══
            html += '<div style="min-width:0;">';
            html += '<h4 style="font-size:14px;font-weight:700;color:var(--pp-accent);margin-bottom:10px;">Kandidat</h4>';
            html += '<div style="font-size:14px;color:var(--pp-text);font-weight:600;">' + this._esc(d.candidate_name || 'Unbekannt') + '</div>';
            if (d.candidate_current_position) html += '<div style="font-size:12px;color:var(--pp-text);margin-top:2px;">' + this._esc(d.candidate_current_position) + '</div>';
            if (d.candidate_current_company) html += '<div style="font-size:12px;color:var(--pp-textMuted);">' + this._esc(d.candidate_current_company) + '</div>';

            // Adresse
            let candAddr = '';
            if (d.candidate_street_address) candAddr += d.candidate_street_address + ', ';
            if (d.candidate_postal_code) candAddr += d.candidate_postal_code + ' ';
            if (d.candidate_city) candAddr += d.candidate_city;
            if (candAddr) html += '<div style="font-size:11px;color:var(--pp-textMuted);margin-top:4px;">' + this._esc(candAddr.trim()) + '</div>';

            // Gehalt
            if (d.candidate_salary) html += '<div style="font-size:12px;color:var(--pp-green);font-weight:600;margin-top:6px;">Gehalt: ' + this._esc(d.candidate_salary) + '</div>';

            // Skills
            if (d.skills && d.skills.length > 0) {
                html += this._sectionHeader('Skills');
                html += this._tagList(d.skills, 'var(--pp-surface3)', 'var(--pp-text)');
            }

            // Berufserfahrung
            if (d.work_history && Array.isArray(d.work_history) && d.work_history.length > 0) {
                html += this._sectionHeader('Berufserfahrung');
                d.work_history.forEach(w => {
                    if (typeof w === 'object') {
                        html += '<div style="margin-top:6px;font-size:12px;color:var(--pp-text);">';
                        html += '<b>' + this._esc(w.position || '') + '</b>';
                        if (w.company) html += ' bei ' + this._esc(w.company);
                        if (w.start_date) html += ' <span style="color:var(--pp-textDim);">(' + this._esc(w.start_date) + ' - ' + this._esc(w.end_date || 'heute') + ')</span>';
                        html += '</div>';
                        if (w.description) html += '<div style="font-size:11px;color:var(--pp-textMuted);margin-top:2px;line-height:1.4;">' + this._esc((w.description || '').substring(0, 300)) + '</div>';
                    }
                });
            }

            // Ausbildung
            if (d.education && Array.isArray(d.education) && d.education.length > 0) {
                html += this._sectionHeader('Ausbildung');
                d.education.forEach(e => {
                    if (typeof e === 'object') {
                        html += '<div style="margin-top:4px;font-size:12px;color:var(--pp-text);">';
                        html += '<b>' + this._esc(e.degree || e.qualification || '') + '</b>';
                        if (e.institution) html += ' — ' + this._esc(e.institution);
                        if (e.year || e.end_date) html += ' <span style="color:var(--pp-textDim);">(' + this._esc(e.year || e.end_date) + ')</span>';
                        html += '</div>';
                    } else {
                        html += '<div style="font-size:12px;color:var(--pp-text);margin-top:4px;">' + this._esc(e) + '</div>';
                    }
                });
            }

            // Weiterbildung / Zertifikate
            if (d.further_education && Array.isArray(d.further_education) && d.further_education.length > 0) {
                html += this._sectionHeader('Weiterbildung / Zertifikate');
                d.further_education.forEach(fe => {
                    if (typeof fe === 'object') {
                        html += '<div style="font-size:12px;color:var(--pp-text);margin-top:4px;">' + this._esc(fe.name || fe.title || JSON.stringify(fe)) + '</div>';
                    } else {
                        html += '<div style="font-size:12px;color:var(--pp-text);margin-top:4px;">' + this._esc(fe) + '</div>';
                    }
                });
            }

            // IT-Skills
            if (d.it_skills && Array.isArray(d.it_skills) && d.it_skills.length > 0) {
                html += this._sectionHeader('IT-Skills / Software');
                html += this._tagList(d.it_skills, 'var(--pp-surface3)', 'var(--pp-accent)');
            }

            // Sprachen
            if (d.languages && Array.isArray(d.languages) && d.languages.length > 0) {
                html += this._sectionHeader('Sprachen');
                d.languages.forEach(lang => {
                    if (typeof lang === 'object') {
                        html += '<div style="font-size:12px;color:var(--pp-text);margin-top:3px;">' + this._esc(lang.language || lang.name || '') + (lang.level ? ' — <span style="color:var(--pp-textMuted);">' + this._esc(lang.level) + '</span>' : '') + '</div>';
                    } else {
                        html += '<div style="font-size:12px;color:var(--pp-text);margin-top:3px;">' + this._esc(lang) + '</div>';
                    }
                });
            }

            html += '</div>';

            // ═══ RECHTE SPALTE: Job ═══
            html += '<div style="min-width:0;">';
            html += '<h4 style="font-size:14px;font-weight:700;color:var(--pp-green);margin-bottom:10px;">Stelle</h4>';
            html += '<div style="font-size:14px;color:var(--pp-text);font-weight:600;">' + this._esc(d.job_position || '') + '</div>';
            if (d.job_company_name) html += '<div style="font-size:12px;color:var(--pp-text);margin-top:2px;">' + this._esc(d.job_company_name) + '</div>';

            // Job Adresse
            let jobAddr = '';
            if (d.job_street_address) jobAddr += d.job_street_address + ', ';
            if (d.job_postal_code) jobAddr += d.job_postal_code + ' ';
            if (d.job_city) jobAddr += d.job_city;
            if (jobAddr) html += '<div style="font-size:11px;color:var(--pp-textMuted);margin-top:4px;">' + this._esc(jobAddr.trim()) + '</div>';

            // Job Text
            if (d.job_text) {
                html += this._sectionHeader('Stellenbeschreibung');
                html += '<div style="font-size:12px;color:var(--pp-text);margin-top:4px;line-height:1.5;max-height:500px;overflow-y:auto;white-space:pre-line;">' + this._esc(d.job_text) + '</div>';
            }

            html += '</div>';
            html += '</div>'; // grid end

            // ── Score + KI-Bewertung (wenn Match existiert) ──
            if (d.ai_score) {
                const scoreVal = Math.round(d.ai_score * 100);
                const scoreBg = scoreVal >= 70 ? 'var(--pp-green)' : scoreVal >= 40 ? 'var(--pp-orange)' : 'var(--pp-red)';
                html += '<div style="margin-top:20px;padding:14px;background:var(--pp-surface3);border-radius:10px;">';
                html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">';
                html += '<span style="display:inline-block;padding:4px 14px;border-radius:50px;font-weight:700;font-size:15px;color:#fff;background:' + scoreBg + ';">' + scoreVal + '</span>';
                html += '<span style="font-size:13px;font-weight:600;color:var(--pp-text);">KI-Bewertung</span>';
                html += '</div>';
                if (d.ai_explanation) html += '<p style="font-size:12px;color:var(--pp-text);line-height:1.5;margin-bottom:10px;">' + this._esc(d.ai_explanation) + '</p>';

                // Staerken + Schwaechen
                if ((d.ai_strengths && d.ai_strengths.length > 0) || (d.ai_weaknesses && d.ai_weaknesses.length > 0)) {
                    html += '<div style="display:flex;flex-wrap:wrap;gap:5px;">';
                    if (d.ai_strengths) d.ai_strengths.forEach(s => { html += '<span style="font-size:11px;padding:2px 8px;border-radius:50px;background:var(--pp-greenSoft);color:var(--pp-green);font-weight:500;">+ ' + this._esc(s) + '</span>'; });
                    if (d.ai_weaknesses) d.ai_weaknesses.forEach(w => { html += '<span style="font-size:11px;padding:2px 8px;border-radius:50px;background:var(--pp-redSoft);color:var(--pp-red);font-weight:500;">- ' + this._esc(w) + '</span>'; });
                    html += '</div>';
                }
                html += '</div>';
            }

            return html;
        },

        // ── Kontakt-Dialog ──
        get canSubmitContact() {
            if (this.selectedContactEmail === '__custom__') return this.customContactEmail && this.customContactEmail.includes('@');
            return !!this.selectedContactEmail;
        },

        async openContactDialog(matchId, candidateId, jobId) {
            this.contactMatchId = matchId;
            this.selectedContactEmail = '';
            this.customContactEmail = '';
            this.contactData = {};
            this.contactLoading = true;
            this.contactDialogOpen = true;

            try {
                const res = await fetch('/api/v4/claude-match/' + matchId + '/contacts');
                const data = await res.json();
                this.contactData = data;
            } catch(e) {
                console.error('Kontakte laden fehlgeschlagen:', e);
                this.contactData = {contacts: [], company_name: '', job_position: ''};
            }
            this.contactLoading = false;
        },

        async submitProfilAnKunden() {
            if (!this.canSubmitContact || !this.contactMatchId) return;
            const email = this.selectedContactEmail === '__custom__' ? this.customContactEmail : this.selectedContactEmail;
            const matchId = this.contactMatchId;
            this.contactDialogOpen = false;
            // Email-Vorschau oeffnen mit Kontakt-E-Mail
            await this.prepareEmail(matchId, 'profil_an_kunden', email);
        },

        // ── E-Mail-Vorschau-Flow ──
        async prepareEmail(matchId, direction, contactEmail) {
            this.emailPreviewMatchId = matchId;
            this.emailPreviewLoading = true;
            this.emailPreviewOpen = true;
            this.emailPreviewData = {};
            try {
                const res = await fetch('/api/v4/claude-match/' + matchId + '/prepare-email', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({direction: direction, contact_email: contactEmail || null}),
                });
                if (!res.ok) throw new Error('prepare-email fehlgeschlagen');
                this.emailPreviewData = await res.json();
            } catch(e) {
                console.error('E-Mail vorbereiten fehlgeschlagen:', e);
                this.emailPreviewOpen = false;
                alert('E-Mail konnte nicht vorbereitet werden: ' + e.message);
            }
            this.emailPreviewLoading = false;
        },

        async sendEmail() {
            if (this.emailSending) return;
            this.emailSending = true;
            try {
                const d = this.emailPreviewData;
                const res = await fetch('/api/v4/claude-match/' + this.emailPreviewMatchId + '/send-email', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        direction: d.direction,
                        recipient_email: d.recipient_email,
                        subject: d.subject,
                        body_text: d.body_text,
                    }),
                });
                const result = await res.json();
                if (!res.ok || !result.success) throw new Error(result.message || 'Senden fehlgeschlagen');
                // Karte entfernen
                const mid = this.emailPreviewMatchId;
                this.topMatches = this.topMatches.filter(m => m.match_id !== mid);
                this.followUps = this.followUps.filter(m => m.match_id !== mid);
                this.summary.total_top = this.topMatches.length;
                this.summary.total_followups = this.followUps.length;
                this.emailPreviewOpen = false;
            } catch(e) {
                console.error('E-Mail senden fehlgeschlagen:', e);
                alert('Fehler beim Senden: ' + e.message);
            }
            this.emailSending = false;
        },

        emailNurPdf() {
            const d = this.emailPreviewData;
            const mid = this.emailPreviewMatchId;
            // PDF oeffnen
            if (d.direction === 'job_an_kandidat') {
                const allM = [...this.topMatches, ...this.followUps];
                const m = allM.find(x => x.match_id === mid);
                if (m) window.open('/api/jobs/' + m.job_id + '/vorstellung-pdf?candidate_id=' + m.candidate_id + '&match_id=' + mid, '_blank');
            } else {
                const allM = [...this.topMatches, ...this.followUps];
                const m = allM.find(x => x.match_id === mid);
                if (m) window.open('/api/candidates/' + m.candidate_id + '/profile-pdf', '_blank');
            }
            // Status setzen + Karte entfernen
            this.emailPreviewOpen = false;
            this.doAction(mid, d.direction, d.recipient_email);
        },

        async doAction(matchId, action, contactEmail) {
            try {
                let note = '';
                if (action === 'ablehnen') {
                    const reason = prompt('Ablehnungsgrund (optional):');
                    if (reason) note = reason;
                }
                if (contactEmail) {
                    note = 'Empfaenger: ' + contactEmail;
                }
                await fetch('/api/v4/claude-match/' + matchId + '/action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action, note: note || undefined}),
                });
                // Karte sofort aus der Liste entfernen
                this.topMatches = this.topMatches.filter(m => m.match_id !== matchId);
                this.followUps = this.followUps.filter(m => m.match_id !== matchId);
                // Summary aktualisieren
                this.summary.total_top = this.topMatches.length;
                this.summary.total_followups = this.followUps.length;
            } catch(e) {
                console.error('Aktion fehlgeschlagen:', e);
            }
        }
    };
}
</script>
{% endblock %}
