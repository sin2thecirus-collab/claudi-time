{% extends "base.html" %}

{% block title %}Action Board — PulsePoint{% endblock %}

{% block content %}
<div x-data="actionBoard()" x-init="init()" style="max-width:900px;margin:0 auto;padding:24px 16px 100px;">

    <!-- Header -->
    <div style="margin-bottom:32px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
            <div>
                <h1 style="font-size:20px;font-weight:700;color:var(--pp-text);letter-spacing:-0.03em;">Action Board</h1>
                <p style="font-size:13px;color:var(--pp-textMuted);margin-top:4px;" x-text="lastRunText"></p>
            </div>
            <div style="display:flex;gap:8px;">
                <button @click="startKontrolliertesMatching()"
                        :disabled="matchingRunning"
                        style="padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .15s;"
                        :style="matchingRunning
                            ? 'background:var(--pp-surface3);color:var(--pp-textDim);cursor:not-allowed;'
                            : 'background:var(--pp-accent);color:#fff;'"
                        x-text="matchingRunning ? 'Laeuft...' : 'Kontrolliertes Matching'">
                </button>
                <button @click="startMatching()"
                        :disabled="matchingRunning"
                        style="padding:8px 14px;border-radius:8px;font-size:12px;font-weight:500;border:1px solid var(--pp-border);cursor:pointer;transition:all .15s;background:var(--pp-surface);color:var(--pp-textMuted);"
                        :style="matchingRunning ? 'cursor:not-allowed;opacity:0.5;' : ''"
                        title="Alle 3 Stufen automatisch ohne Kontrolle">Auto
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;">
                <div style="font-size:22px;font-weight:700;color:var(--pp-text);" x-text="summary.total_top || 0"></div>
                <div style="font-size:11px;color:var(--pp-textMuted);font-weight:500;">Top Matches</div>
            </div>
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;">
                <div style="font-size:22px;font-weight:700;color:var(--pp-orange);" x-text="summary.total_wow || 0"></div>
                <div style="font-size:11px;color:var(--pp-textMuted);font-weight:500;">Goldene Chancen</div>
            </div>
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;">
                <div style="font-size:22px;font-weight:700;color:var(--pp-textMuted);" x-text="summary.total_followups || 0"></div>
                <div style="font-size:11px;color:var(--pp-textMuted);font-weight:500;">Follow-ups</div>
            </div>
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;">
                <div style="font-size:22px;font-weight:700;color:var(--pp-textDim);" x-text="summary.total_proximity || 0"></div>
                <div style="font-size:11px;color:var(--pp-textMuted);font-weight:500;">Naehe-Matches</div>
            </div>
        </div>
    </div>

    <!-- Progress Bar (nur sichtbar wenn Matching laeuft) -->
    <div x-show="matchingRunning" x-transition style="margin-bottom:24px;background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="font-size:12px;font-weight:600;color:var(--pp-text);" x-text="'Stufe: ' + (progress.stufe || '...')"></span>
            <span style="font-size:12px;color:var(--pp-textMuted);" x-text="progressText"></span>
        </div>
        <div style="height:6px;background:var(--pp-surface3);border-radius:3px;overflow:hidden;">
            <div style="height:100%;background:var(--pp-accent);border-radius:3px;transition:width .3s;"
                 :style="'width:' + progressPercent + '%'"></div>
        </div>
        <div style="display:flex;gap:16px;margin-top:8px;">
            <span style="font-size:11px;color:var(--pp-textDim);" x-text="'Stufe 1: ' + (progress.processed_stufe_1 || 0) + '/' + (progress.total_pairs || 0)"></span>
            <span style="font-size:11px;color:var(--pp-green);" x-text="'Bestanden: ' + (progress.passed_stufe_1 || 0)"></span>
            <span style="font-size:11px;color:var(--pp-accent);" x-text="'Stufe 2: ' + (progress.processed_stufe_2 || 0)"></span>
            <span style="font-size:11px;color:var(--pp-textDim);" x-text="'Kosten: $' + (progress.cost_estimate_usd || 0).toFixed(2)"></span>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════ -->
    <!-- KONTROLLIERTES MATCHING — Stufen-Ansicht      -->
    <!-- ══════════════════════════════════════════════ -->

    <!-- STUFE 0: Paare-Uebersicht -->
    <div x-show="stufenView === 'stufe_0'" x-transition style="margin-bottom:32px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
                <h2 style="font-size:16px;font-weight:700;color:var(--pp-text);">Stufe 0 — Gefundene Paare</h2>
                <p style="font-size:12px;color:var(--pp-textMuted);margin-top:2px;"
                   x-text="stufenData.total_claude_pairs + ' Claude-Paare, ' + stufenData.total_proximity_pairs + ' Naehe-Paare'"></p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <span style="font-size:11px;color:var(--pp-textDim);"
                      x-text="'Geschaetzte Kosten Stufe 1: $' + (stufenData.cost_stufe_1?.cost_estimate_usd || 0).toFixed(2)"></span>
                <button @click="startStufe1()"
                        :disabled="matchingRunning"
                        style="padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;">
                    Stufe 1 starten
                </button>
            </div>
        </div>

        <!-- Paare-Tabelle -->
        <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;overflow:hidden;">
            <template x-for="(pair, idx) in stufenData.claude_pairs || []" :key="pair.candidate_id + pair.job_id">
                <div style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--pp-borderLight);"
                     :style="pair.excluded ? 'opacity:0.35;text-decoration:line-through;' : ''">
                    <div style="flex:1;">
                        <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="pair.candidate_role"></span>
                        <span style="font-size:12px;color:var(--pp-textDim);"> aus </span>
                        <span style="font-size:12px;color:var(--pp-text);" x-text="pair.candidate_city"></span>
                        <span style="font-size:12px;color:var(--pp-textDim);"> &rarr; </span>
                        <span style="font-size:13px;color:var(--pp-text);" x-text="pair.job_position"></span>
                        <span style="font-size:12px;color:var(--pp-textMuted);" x-text="' bei ' + pair.job_company + ', ' + pair.job_city"></span>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;margin-left:12px;">
                        <span style="font-size:11px;color:var(--pp-green);font-weight:600;" x-text="pair.distance_km ? pair.distance_km + ' km' : '?'"></span>
                        <button @click="openCompare(pair.candidate_id, pair.job_id)"
                                style="padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-accent);">Vergleich</button>
                        <button @click="toggleExclude(pair)"
                                style="padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;border:none;cursor:pointer;"
                                :style="pair.excluded ? 'background:var(--pp-greenSoft);color:var(--pp-green);' : 'background:var(--pp-redSoft);color:var(--pp-red);'"
                                x-text="pair.excluded ? 'Zurueck' : 'Ausschliessen'">
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- STUFE 1: Quick-Check Ergebnisse -->
    <div x-show="stufenView === 'stufe_1'" x-transition style="margin-bottom:32px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
                <h2 style="font-size:16px;font-weight:700;color:var(--pp-text);">Stufe 1 — Quick-Check Ergebnisse</h2>
                <p style="font-size:12px;color:var(--pp-textMuted);margin-top:2px;"
                   x-text="stufe1Data.passed_count + ' bestanden, ' + stufe1Data.failed_count + ' durchgefallen, $' + (stufe1Data.cost_usd || 0).toFixed(2)"></p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <span style="font-size:11px;color:var(--pp-textDim);"
                      x-text="'Geschaetzte Kosten Stufe 2: $' + (stufe1Data.cost_stufe_2?.cost_estimate_usd || 0).toFixed(2)"></span>
                <button @click="startStufe2()"
                        :disabled="matchingRunning"
                        style="padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;">
                    Stufe 2 starten
                </button>
            </div>
        </div>

        <!-- Bestanden -->
        <h3 style="font-size:13px;font-weight:600;color:var(--pp-green);margin-bottom:8px;">Bestanden</h3>
        <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;overflow:hidden;margin-bottom:16px;">
            <template x-for="pair in stufe1Data.passed || []" :key="pair.candidate_id + pair.job_id">
                <div style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--pp-borderLight);">
                    <div style="flex:1;">
                        <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="pair.candidate_role"></span>
                        <span style="font-size:12px;color:var(--pp-textDim);"> &rarr; </span>
                        <span style="font-size:13px;color:var(--pp-text);" x-text="pair.job_position"></span>
                        <span style="font-size:12px;color:var(--pp-textMuted);" x-text="' bei ' + pair.job_company"></span>
                        <div style="font-size:11px;color:var(--pp-green);margin-top:2px;" x-text="pair.quick_reason"></div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;margin-left:12px;">
                        <span style="font-size:11px;color:var(--pp-green);font-weight:600;" x-text="pair.distance_km ? pair.distance_km + ' km' : '?'"></span>
                        <button @click="openCompare(pair.candidate_id, pair.job_id)"
                                style="padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-accent);">Vergleich</button>
                        <button @click="excludeFromStufe1(pair)"
                                style="padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;border:none;cursor:pointer;background:var(--pp-redSoft);color:var(--pp-red);">Ausschliessen</button>
                    </div>
                </div>
            </template>
            <div x-show="!stufe1Data.passed || stufe1Data.passed.length === 0" style="padding:20px;text-align:center;color:var(--pp-textMuted);font-size:13px;">
                Keine Paare bestanden
            </div>
        </div>

        <!-- Durchgefallen (eingeklappt) -->
        <details style="margin-bottom:16px;">
            <summary style="font-size:13px;font-weight:600;color:var(--pp-textDim);cursor:pointer;margin-bottom:8px;"
                     x-text="'Durchgefallen (' + (stufe1Data.failed?.length || 0) + ')'"></summary>
            <div style="background:var(--pp-surface);border:1px solid var(--pp-borderLight);border-radius:10px;overflow:hidden;">
                <template x-for="pair in stufe1Data.failed || []" :key="pair.candidate_id + pair.job_id">
                    <div style="padding:10px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--pp-borderLight);opacity:0.6;">
                        <div>
                            <span style="font-size:12px;color:var(--pp-textMuted);" x-text="pair.candidate_role + ' → ' + pair.job_position"></span>
                            <span style="font-size:11px;color:var(--pp-red);margin-left:8px;" x-text="pair.quick_reason"></span>
                        </div>
                    </div>
                </template>
            </div>
        </details>
    </div>

    <!-- STUFE 2: Ergebnisse (nach Abschluss) -->
    <div x-show="stufenView === 'stufe_2_done'" x-transition style="margin-bottom:32px;">
        <div style="margin-bottom:16px;">
            <h2 style="font-size:16px;font-weight:700;color:var(--pp-text);">Stufe 2 — Ergebnisse</h2>
            <p style="font-size:12px;color:var(--pp-textMuted);margin-top:2px;"
               x-text="(stufe2Data.matches_saved_count || 0) + ' Matches gespeichert, ' + (stufe2Data.top_matches || 0) + ' Top, ' + (stufe2Data.wow_matches || 0) + ' Wow, $' + (stufe2Data.total_session_cost_usd || 0).toFixed(2) + ' gesamt'"></p>
        </div>

        <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;overflow:hidden;">
            <template x-for="m in stufe2Data.matches_saved || []" :key="m.match_id">
                <div style="padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--pp-borderLight);">
                    <div style="flex:1;">
                        <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="m.empfehlung === 'vorstellen' ? 'VORSTELLEN' : m.empfehlung"></span>
                        <span style="font-size:12px;color:var(--pp-textMuted);margin-left:8px;" x-text="m.zusammenfassung"></span>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span x-show="m.wow_faktor" style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:50px;background:var(--pp-orange);color:#000;">WOW</span>
                        <div style="border-radius:50px;padding:3px 10px;font-weight:700;font-size:13px;color:#fff;"
                             :style="'background:' + (m.score >= 85 ? 'var(--pp-green)' : m.score >= 70 ? 'var(--pp-accent)' : 'var(--pp-orange)')"
                             x-text="m.score"></div>
                    </div>
                </div>
            </template>
        </div>

        <button @click="stufenView = ''; loadMatches();"
                style="margin-top:16px;padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surface);color:var(--pp-text);">
            Zum Action Board
        </button>
    </div>

    <!-- ══════════════════════════════════════════════ -->
    <!-- NORMALES ACTION BOARD (Matches-Ansicht)        -->
    <!-- ══════════════════════════════════════════════ -->

    <div x-show="!stufenView">

    <!-- Loading -->
    <div x-show="loading" style="text-align:center;padding:40px;color:var(--pp-textMuted);font-size:13px;">
        Lade Matches...
    </div>

    <!-- Empty State -->
    <div x-show="!loading && topMatches.length === 0 && wowMatches.length === 0 && followUps.length === 0 && !matchingRunning"
         style="text-align:center;padding:60px 20px;color:var(--pp-textMuted);">
        <div style="font-size:32px;margin-bottom:12px;">&#128640;</div>
        <p style="font-size:15px;font-weight:600;color:var(--pp-text);margin-bottom:6px;">Keine neuen Matches</p>
        <p style="font-size:13px;">Klicke "Kontrolliertes Matching" um neue Paare zu pruefen.</p>
    </div>

    <!-- TOP MATCHES -->
    <div x-show="!loading && topMatches.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-text);margin-bottom:12px;letter-spacing:-0.02em;">
            Top Matches
            <span style="font-size:12px;font-weight:500;color:var(--pp-textMuted);margin-left:6px;" x-text="'(' + topMatches.length + ')'"></span>
        </h2>

        <template x-for="match in topMatches" :key="match.match_id">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:12px;padding:18px;margin-bottom:10px;">
                <!-- Header: Kandidat → Job -->
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="flex:1;">
                        <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="match.candidate_role || 'Kandidat'"></span>
                        <span style="color:var(--pp-textDim);font-size:12px;"> &rarr; </span>
                        <span style="font-size:13px;color:var(--pp-text);" x-text="match.job_position"></span>
                        <span style="font-size:12px;color:var(--pp-textMuted);" x-text="' bei ' + match.job_company + ', ' + match.job_city"></span>
                    </div>
                    <div style="border-radius:50px;padding:4px 12px;font-weight:700;font-size:14px;color:#fff;flex-shrink:0;margin-left:12px;"
                         :style="'background:' + (match.ai_score >= 85 ? 'var(--pp-green)' : match.ai_score >= 70 ? 'var(--pp-accent)' : 'var(--pp-orange)')">
                        <span x-text="Math.round(match.ai_score)"></span>
                    </div>
                </div>

                <!-- Meta -->
                <div style="display:flex;gap:12px;margin-top:6px;font-size:11px;color:var(--pp-textMuted);">
                    <span x-show="match.drive_time_car_min" x-text="match.drive_time_car_min + ' Min Auto'"
                          :style="'color:' + (match.drive_time_car_min <= 20 ? 'var(--pp-green)' : match.drive_time_car_min <= 40 ? 'var(--pp-orange)' : 'var(--pp-textDim)')"></span>
                    <span x-show="!match.drive_time_car_min && match.distance_km" x-text="match.distance_km + ' km'"></span>
                    <span x-show="match.candidate_salary" x-text="match.candidate_salary"></span>
                    <span x-text="match.candidate_city"></span>
                </div>

                <!-- Claude Begruendung -->
                <p style="margin-top:10px;font-size:13px;color:var(--pp-text);line-height:1.5;" x-text="match.ai_explanation"></p>

                <!-- Staerken + Luecken Tags -->
                <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:10px;">
                    <template x-for="s in (match.ai_strengths || [])">
                        <span style="font-size:11px;padding:2px 8px;border-radius:50px;background:var(--pp-greenSoft);color:var(--pp-green);font-weight:500;" x-text="'+ ' + s"></span>
                    </template>
                    <template x-for="w in (match.ai_weaknesses || [])">
                        <span style="font-size:11px;padding:2px 8px;border-radius:50px;background:var(--pp-redSoft);color:var(--pp-red);font-weight:500;" x-text="'- ' + w"></span>
                    </template>
                </div>

                <!-- Action Buttons -->
                <div style="display:flex;gap:8px;margin-top:14px;">
                    <button @click="doAction(match.match_id, 'vorstellen')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;">Vorstellen</button>
                    <a :href="'/kandidaten/' + match.candidate_id"
                       style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-text);text-decoration:none;">Kandidat</a>
                    <button @click="doAction(match.match_id, 'spaeter')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-textMuted);">Spaeter</button>
                    <button @click="doAction(match.match_id, 'ablehnen')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:transparent;color:var(--pp-textDim);">Ablehnen</button>
                </div>
            </div>
        </template>
    </div>

    <!-- GOLDENE CHANCEN (wow_faktor) -->
    <div x-show="!loading && wowMatches.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-orange);margin-bottom:12px;letter-spacing:-0.02em;">
            Goldene Chancen
            <span style="font-size:12px;font-weight:500;color:var(--pp-textMuted);margin-left:6px;" x-text="'(' + wowMatches.length + ')'"></span>
        </h2>

        <template x-for="match in wowMatches" :key="match.match_id">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-orange);border-radius:12px;padding:18px;margin-bottom:10px;position:relative;">
                <!-- Wow Badge -->
                <div style="position:absolute;top:-8px;right:16px;background:var(--pp-orange);color:#000;font-size:10px;font-weight:700;padding:2px 10px;border-radius:50px;">WOW</div>

                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="flex:1;">
                        <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="match.candidate_role || 'Kandidat'"></span>
                        <span style="font-size:12px;color:var(--pp-textDim);" x-show="match.willingness_to_change === 'nein'"> — NICHT aktiv suchend</span>
                        <div style="font-size:12px;color:var(--pp-textMuted);margin-top:2px;" x-text="match.job_position + ' bei ' + match.job_company + ', ' + match.job_city"></div>
                    </div>
                    <div style="border-radius:50px;padding:4px 12px;font-weight:700;font-size:14px;color:#fff;background:var(--pp-orange);flex-shrink:0;margin-left:12px;">
                        <span x-text="Math.round(match.ai_score)"></span>
                    </div>
                </div>

                <!-- Wow Grund -->
                <p style="margin-top:8px;font-size:13px;color:var(--pp-orange);font-weight:500;" x-text="match.wow_grund"></p>
                <p style="margin-top:6px;font-size:13px;color:var(--pp-text);line-height:1.5;" x-text="match.ai_explanation"></p>

                <!-- Meta -->
                <div style="display:flex;gap:12px;margin-top:8px;font-size:11px;color:var(--pp-textMuted);">
                    <span x-show="match.drive_time_car_min" x-text="match.drive_time_car_min + ' Min Fahrzeit'"></span>
                    <span x-show="match.distance_km" x-text="match.distance_km + ' km'"></span>
                </div>

                <!-- Actions -->
                <div style="display:flex;gap:8px;margin-top:14px;">
                    <button @click="doAction(match.match_id, 'vorstellen')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-orange);color:#000;">Anrufen &amp; vorschlagen</button>
                    <button @click="doAction(match.match_id, 'spaeter')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-textMuted);">Merken</button>
                    <button @click="doAction(match.match_id, 'ablehnen')"
                            style="padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:transparent;color:var(--pp-textDim);">Ignorieren</button>
                </div>
            </div>
        </template>
    </div>

    <!-- FOLLOW-UPS -->
    <div x-show="!loading && followUps.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-textMuted);margin-bottom:12px;">
            Follow-ups
            <span style="font-size:12px;font-weight:500;margin-left:6px;" x-text="'(' + followUps.length + ')'"></span>
        </h2>

        <template x-for="match in followUps" :key="match.match_id">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                <div style="flex:1;">
                    <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="match.candidate_role || 'Kandidat'"></span>
                    <span style="font-size:12px;color:var(--pp-textDim);"> &rarr; </span>
                    <span style="font-size:12px;color:var(--pp-text);" x-text="match.job_position + ' bei ' + match.job_company"></span>
                    <div style="font-size:11px;color:var(--pp-textMuted);margin-top:2px;" x-text="match.ai_explanation"></div>
                </div>
                <div style="display:flex;gap:6px;flex-shrink:0;margin-left:12px;">
                    <div style="border-radius:50px;padding:3px 10px;font-weight:700;font-size:12px;color:#fff;background:var(--pp-accent);" x-text="Math.round(match.ai_score)"></div>
                    <button @click="doAction(match.match_id, 'vorstellen')"
                            style="padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;background:var(--pp-accent);color:#fff;">Vorstellen</button>
                    <button @click="doAction(match.match_id, 'ablehnen')"
                            style="padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-textDim);">X</button>
                </div>
            </div>
        </template>
    </div>

    <!-- NAEHE-MATCHES -->
    <div x-show="!loading && proximityMatches.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-textDim);margin-bottom:12px;">
            Naehe-Matches (ohne Bewertung)
            <span style="font-size:12px;font-weight:500;margin-left:6px;" x-text="'(' + proximityMatches.length + ')'"></span>
        </h2>
        <p style="font-size:11px;color:var(--pp-textDim);margin-bottom:10px;">Kandidaten/Jobs ohne vollstaendige Daten, aber unter 10 km Entfernung.</p>

        <template x-for="match in proximityMatches" :key="match.match_id">
            <div style="background:var(--pp-surface);border:1px solid var(--pp-borderLight);border-radius:8px;padding:12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <span style="font-size:12px;font-weight:600;color:var(--pp-textMuted);" x-text="match.candidate_role || '?'"></span>
                    <span style="font-size:11px;color:var(--pp-textDim);"> &rarr; </span>
                    <span style="font-size:12px;color:var(--pp-textMuted);" x-text="match.job_position + ' (' + match.job_company + ')'"></span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span style="font-size:11px;color:var(--pp-green);font-weight:600;" x-text="(match.distance_km || '?') + ' km'"></span>
                    <a :href="'/kandidaten/' + match.candidate_id"
                       style="font-size:11px;color:var(--pp-accent);text-decoration:none;font-weight:500;">Ansehen</a>
                </div>
            </div>
        </template>
    </div>

    <!-- REGIONALE INSIGHTS -->
    <div x-show="!loading && regions.length > 0" style="margin-bottom:32px;">
        <h2 style="font-size:14px;font-weight:700;color:var(--pp-text);margin-bottom:12px;">
            Regionale Uebersicht
            <span style="font-size:12px;font-weight:500;color:var(--pp-textMuted);margin-left:6px;" x-text="'(' + regions.length + ' Staedte)'"></span>
        </h2>

        <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px;">
            <template x-for="region in regions" :key="region.city">
                <div style="background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:10px;padding:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-size:13px;font-weight:600;color:var(--pp-text);" x-text="region.city"></span>
                        <span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:50px;"
                              :style="region.status === 'gut_abgedeckt' ? 'background:var(--pp-greenSoft);color:var(--pp-green);'
                                    : region.status === 'ausbaufaehig' ? 'background:var(--pp-orangeSoft);color:var(--pp-orange);'
                                    : region.status === 'sourcing_chance' ? 'background:#e0e7ff;color:#4338ca;'
                                    : 'background:var(--pp-surface3);color:var(--pp-textDim);'"
                              x-text="region.status === 'gut_abgedeckt' ? 'Gut abgedeckt'
                                    : region.status === 'ausbaufaehig' ? 'Ausbaufaehig'
                                    : region.status === 'sourcing_chance' ? 'Sourcing-Chance'
                                    : 'Keine Abdeckung'"></span>
                    </div>
                    <div style="display:flex;gap:16px;font-size:11px;color:var(--pp-textMuted);">
                        <span x-text="region.candidate_count + ' Kandidaten'"></span>
                        <span x-text="region.job_count + ' Jobs'"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    </div><!-- Ende normales Action Board -->

    <!-- Compare Modal -->
    <div x-show="compareOpen" x-transition
         style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:50;display:flex;align-items:center;justify-content:center;"
         @click.self="compareOpen = false">
        <div style="background:var(--pp-surface);border-radius:16px;width:90%;max-width:800px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--pp-border);">
                <h3 style="font-size:15px;font-weight:700;color:var(--pp-text);">Vergleich</h3>
                <button @click="compareOpen = false" style="border:none;background:none;cursor:pointer;font-size:18px;color:var(--pp-textDim);">✕</button>
            </div>
            <div id="compare-content" style="padding:20px;" x-html="compareHtml">
                <div style="text-align:center;color:var(--pp-textMuted);padding:40px;">Lade Vergleich...</div>
            </div>
        </div>
    </div>
</div>

<script>
function actionBoard() {
    return {
        // Normales Action Board
        topMatches: [],
        wowMatches: [],
        followUps: [],
        proximityMatches: [],
        regions: [],
        summary: {},
        loading: true,
        matchingRunning: false,
        progress: {},
        lastRun: null,
        pollInterval: null,

        // Kontrolliertes Matching
        stufenView: '',  // '', 'stufe_0', 'stufe_1', 'stufe_2_done'
        sessionId: null,
        stufenData: {},   // Stufe 0 Daten
        stufe1Data: {},   // Stufe 1 Ergebnisse
        stufe2Data: {},   // Stufe 2 Ergebnisse

        // Compare Modal
        compareOpen: false,
        compareHtml: '',

        get lastRunText() {
            if (this.lastRun) {
                try {
                    const d = new Date(this.lastRun);
                    const mins = Math.round((Date.now() - d.getTime()) / 60000);
                    if (mins < 1) return 'Letzter Lauf: gerade eben';
                    if (mins < 60) return 'Letzter Lauf: vor ' + mins + ' Min';
                    const hrs = Math.round(mins / 60);
                    return 'Letzter Lauf: vor ' + hrs + ' Std';
                } catch(e) {}
            }
            return 'Noch kein Lauf';
        },

        get progressPercent() {
            const total = this.progress.total_pairs || 1;
            const s1 = this.progress.processed_stufe_1 || 0;
            const s2 = this.progress.processed_stufe_2 || 0;
            const passed = this.progress.passed_stufe_1 || 0;
            const p1 = Math.min(100, (s1 / total) * 60);
            const p2 = passed > 0 ? Math.min(100, (s2 / passed) * 40) : 0;
            return Math.min(100, Math.round(p1 + p2));
        },

        get progressText() {
            if (this.progress.stufe === 'stufe_0') return 'Lade Paare aus DB...';
            if (this.progress.stufe === 'stufe_1') return 'Quick-Check: ' + (this.progress.processed_stufe_1 || 0) + '/' + (this.progress.total_pairs || '?');
            if (this.progress.stufe === 'stufe_2') return 'Deep Assessment: ' + (this.progress.processed_stufe_2 || 0) + '/' + (this.progress.total_pairs || '?');
            if (this.progress.stufe === 'speichern') return 'Speichere Matches...';
            if (this.progress.stufe === 'fahrzeit') return 'Berechne Fahrzeiten...';
            if (this.progress.stufe === 'fertig' || this.progress.stufe === 'stufe_1_fertig') return 'Fertig!';
            return 'Initialisierung...';
        },

        async init() {
            await this.loadStatus();
            await this.loadMatches();
            await this.loadRegionalInsights();
            this.loading = false;
        },

        async loadMatches() {
            try {
                const res = await fetch('/api/v4/claude-match/daily?limit=20&include_wow=true&include_followups=true');
                const data = await res.json();
                this.topMatches = data.top_matches || [];
                this.wowMatches = data.wow_matches || [];
                this.followUps = data.follow_ups || [];
                this.proximityMatches = data.proximity_matches || [];
                this.summary = data.summary || {};
            } catch(e) {
                console.error('Fehler beim Laden:', e);
            }
        },

        async loadRegionalInsights() {
            try {
                const res = await fetch('/api/v4/claude-match/regional-insights');
                const data = await res.json();
                this.regions = data.regions || [];
            } catch(e) {
                console.error('Regional Insights Fehler:', e);
            }
        },

        async loadStatus() {
            try {
                const res = await fetch('/api/v4/claude-match/status');
                const data = await res.json();
                this.matchingRunning = data.running || false;
                this.progress = data.progress || {};
                this.lastRun = data.last_run;
                if (this.matchingRunning && !this.pollInterval) {
                    this.startPolling();
                }
            } catch(e) {}
        },

        // ── Automatisches Matching (alle Stufen) ──
        async startMatching() {
            if (this.matchingRunning) return;
            this.matchingRunning = true;
            try {
                await fetch('/api/v4/claude-match/run', {method: 'POST'});
                this.startPolling();
            } catch(e) {
                this.matchingRunning = false;
                console.error('Start fehlgeschlagen:', e);
            }
        },

        // ── Kontrolliertes Matching ──
        async startKontrolliertesMatching() {
            if (this.matchingRunning) return;
            try {
                const res = await fetch('/api/v4/claude-match/run-stufe-0', {method: 'POST'});
                const data = await res.json();
                if (data.status === 'ok') {
                    this.sessionId = data.session_id;
                    this.stufenData = data;
                    this.stufenView = 'stufe_0';
                } else {
                    alert('Stufe 0 Fehler: ' + (data.message || 'Unbekannt'));
                }
            } catch(e) {
                console.error('Stufe 0 fehlgeschlagen:', e);
                alert('Stufe 0 fehlgeschlagen: ' + e.message);
            }
        },

        async startStufe1() {
            if (this.matchingRunning || !this.sessionId) return;
            try {
                // Zuerst ausgeschlossene Paare senden
                const excludedPairs = (this.stufenData.claude_pairs || [])
                    .filter(p => p.excluded)
                    .map(p => ({candidate_id: p.candidate_id, job_id: p.job_id}));

                if (excludedPairs.length > 0) {
                    await fetch('/api/v4/claude-match/exclude-pairs', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({session_id: this.sessionId, pairs: excludedPairs}),
                    });
                }

                // Stufe 1 starten
                const res = await fetch('/api/v4/claude-match/run-stufe-1?session_id=' + this.sessionId, {method: 'POST'});
                const data = await res.json();
                if (data.status === 'started') {
                    this.matchingRunning = true;
                    this.startPollingStufe1();
                } else {
                    alert('Stufe 1 Fehler: ' + (data.message || data.detail || 'Unbekannt'));
                }
            } catch(e) {
                console.error('Stufe 1 fehlgeschlagen:', e);
            }
        },

        startPollingStufe1() {
            if (this.pollInterval) clearInterval(this.pollInterval);
            this.pollInterval = setInterval(async () => {
                await this.loadStatus();
                if (!this.matchingRunning) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    // Session-Daten laden fuer Stufe 1 Ergebnisse
                    await this.loadSessionData();
                }
            }, 2000);
        },

        async loadSessionData() {
            if (!this.sessionId) return;
            try {
                const res = await fetch('/api/v4/claude-match/session/' + this.sessionId);
                const data = await res.json();
                if (data.current_stufe >= 1 && data.current_stufe < 2) {
                    this.stufe1Data = {
                        passed: data.passed_pairs.filter(p => !p.excluded),
                        failed: data.failed_pairs,
                        passed_count: data.passed_pairs.filter(p => !p.excluded).length,
                        failed_count: data.failed_pairs.length,
                        cost_usd: 0, // wird aus progress geladen
                        cost_stufe_2: {},
                    };
                    // Kosten aus letztem progress
                    if (this.progress.cost_estimate_usd) {
                        this.stufe1Data.cost_usd = this.progress.cost_estimate_usd;
                    }
                    // Stufe 2 Kosten schaetzen (~$0.002 pro Paar)
                    const passedCount = this.stufe1Data.passed_count;
                    this.stufe1Data.cost_stufe_2 = {
                        cost_estimate_usd: Math.round(passedCount * 0.002 * 10000) / 10000,
                    };
                    this.stufenView = 'stufe_1';
                } else if (data.current_stufe >= 2) {
                    this.stufe2Data = {
                        matches_saved: data.deep_results,
                        matches_saved_count: data.matches_saved,
                        top_matches: data.deep_results.filter(m => m.empfehlung === 'vorstellen').length,
                        wow_matches: data.deep_results.filter(m => m.wow_faktor).length,
                        total_session_cost_usd: 0,
                    };
                    this.stufenView = 'stufe_2_done';
                }
            } catch(e) {
                console.error('Session laden fehlgeschlagen:', e);
            }
        },

        async startStufe2() {
            if (this.matchingRunning || !this.sessionId) return;
            try {
                // Ausgeschlossene Paare von Stufe 1 senden
                const excludedPairs = (this.stufe1Data.passed || [])
                    .filter(p => p._excluded)
                    .map(p => ({candidate_id: p.candidate_id, job_id: p.job_id}));

                if (excludedPairs.length > 0) {
                    await fetch('/api/v4/claude-match/exclude-pairs', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({session_id: this.sessionId, pairs: excludedPairs}),
                    });
                }

                const res = await fetch('/api/v4/claude-match/run-stufe-2?session_id=' + this.sessionId, {method: 'POST'});
                const data = await res.json();
                if (data.status === 'started') {
                    this.matchingRunning = true;
                    this.startPollingStufe2();
                } else {
                    alert('Stufe 2 Fehler: ' + (data.message || data.detail || 'Unbekannt'));
                }
            } catch(e) {
                console.error('Stufe 2 fehlgeschlagen:', e);
            }
        },

        startPollingStufe2() {
            if (this.pollInterval) clearInterval(this.pollInterval);
            this.pollInterval = setInterval(async () => {
                await this.loadStatus();
                if (!this.matchingRunning) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    await this.loadSessionData();
                }
            }, 2000);
        },

        // ── Paare ausschliessen ──
        toggleExclude(pair) {
            pair.excluded = !pair.excluded;
        },

        excludeFromStufe1(pair) {
            pair._excluded = true;
            this.stufe1Data.passed = this.stufe1Data.passed.filter(p =>
                p.candidate_id !== pair.candidate_id || p.job_id !== pair.job_id
            );
            this.stufe1Data.passed_count = this.stufe1Data.passed.length;
            // Kosten-Schaetzung aktualisieren
            this.stufe1Data.cost_stufe_2 = {
                cost_estimate_usd: Math.round(this.stufe1Data.passed_count * 0.002 * 10000) / 10000,
            };
        },

        // ── Vergleich oeffnen ──
        async openCompare(candidateId, jobId) {
            this.compareOpen = true;
            this.compareHtml = '<div style="text-align:center;color:var(--pp-textMuted);padding:40px;">Lade Vergleich...</div>';
            try {
                const res = await fetch('/api/v4/claude-match/compare-pair?candidate_id=' + candidateId + '&job_id=' + jobId);
                const data = await res.json();
                if (data.data) {
                    const d = data.data;
                    this.compareHtml = this.buildCompareHtml(d);
                } else {
                    this.compareHtml = '<div style="text-align:center;color:var(--pp-red);padding:40px;">Keine Daten gefunden</div>';
                }
            } catch(e) {
                this.compareHtml = '<div style="text-align:center;color:var(--pp-red);padding:40px;">Fehler: ' + e.message + '</div>';
            }
        },

        buildCompareHtml(d) {
            let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">';

            // Kandidat
            html += '<div>';
            html += '<h4 style="font-size:14px;font-weight:700;color:var(--pp-accent);margin-bottom:12px;">Kandidat</h4>';
            html += '<div style="font-size:13px;color:var(--pp-text);margin-bottom:4px;"><b>' + (d.candidate_name || 'Unbekannt') + '</b></div>';
            html += '<div style="font-size:12px;color:var(--pp-textMuted);margin-bottom:4px;">' + (d.candidate_current_position || '') + '</div>';
            html += '<div style="font-size:12px;color:var(--pp-textMuted);margin-bottom:12px;">' + (d.candidate_city || '') + ' ' + (d.candidate_postal_code || '') + '</div>';

            // Skills
            if (d.skills && d.skills.length > 0) {
                html += '<div style="margin-bottom:8px;"><span style="font-size:11px;font-weight:600;color:var(--pp-textDim);">Skills:</span>';
                html += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;">';
                const skills = Array.isArray(d.skills) ? d.skills.slice(0, 10) : [];
                skills.forEach(s => {
                    html += '<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:var(--pp-surface3);color:var(--pp-text);">' + s + '</span>';
                });
                html += '</div></div>';
            }

            // Berufserfahrung
            if (d.work_history && d.work_history.length > 0) {
                html += '<div style="margin-top:12px;"><span style="font-size:11px;font-weight:600;color:var(--pp-textDim);">Berufserfahrung:</span>';
                const wh = Array.isArray(d.work_history) ? d.work_history.slice(0, 3) : [];
                wh.forEach(w => {
                    if (typeof w === 'object') {
                        html += '<div style="margin-top:6px;font-size:12px;color:var(--pp-text);">';
                        html += '<b>' + (w.position || '') + '</b>';
                        if (w.company) html += ' bei ' + w.company;
                        if (w.start_date) html += ' (' + w.start_date + ' - ' + (w.end_date || 'heute') + ')';
                        html += '</div>';
                        if (w.description) {
                            html += '<div style="font-size:11px;color:var(--pp-textMuted);margin-top:2px;">' + w.description.substring(0, 200) + '</div>';
                        }
                    }
                });
                html += '</div>';
            }
            html += '</div>';

            // Job
            html += '<div>';
            html += '<h4 style="font-size:14px;font-weight:700;color:var(--pp-green);margin-bottom:12px;">Stelle</h4>';
            html += '<div style="font-size:13px;color:var(--pp-text);margin-bottom:4px;"><b>' + (d.job_position || '') + '</b></div>';
            html += '<div style="font-size:12px;color:var(--pp-textMuted);margin-bottom:4px;">' + (d.job_company_name || '') + '</div>';
            html += '<div style="font-size:12px;color:var(--pp-textMuted);margin-bottom:12px;">' + (d.job_city || '') + ' ' + (d.job_postal_code || '') + '</div>';

            // Job Text
            if (d.job_text) {
                html += '<div style="margin-top:8px;"><span style="font-size:11px;font-weight:600;color:var(--pp-textDim);">Stellenbeschreibung:</span>';
                html += '<div style="font-size:12px;color:var(--pp-text);margin-top:4px;line-height:1.5;max-height:300px;overflow-y:auto;">' + d.job_text.substring(0, 1000).replace(/\n/g, '<br>') + '</div>';
                html += '</div>';
            }
            html += '</div>';

            html += '</div>';

            // Score wenn vorhanden
            if (d.ai_score) {
                html += '<div style="margin-top:16px;padding:12px;background:var(--pp-surface3);border-radius:8px;">';
                html += '<span style="font-size:13px;font-weight:700;">Score: ' + Math.round(d.ai_score * 100) + '</span>';
                if (d.ai_explanation) html += '<p style="font-size:12px;color:var(--pp-text);margin-top:4px;">' + d.ai_explanation + '</p>';
                html += '</div>';
            }

            return html;
        },

        startPolling() {
            if (this.pollInterval) clearInterval(this.pollInterval);
            this.pollInterval = setInterval(async () => {
                await this.loadStatus();
                if (!this.matchingRunning) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    await this.loadMatches();
                }
            }, 2000);
        },

        async doAction(matchId, action) {
            try {
                let note = '';
                if (action === 'ablehnen') {
                    const reason = prompt('Ablehnungsgrund (optional):');
                    if (reason) note = reason;
                }
                await fetch('/api/v4/claude-match/' + matchId + '/action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action, note: note || undefined}),
                });
                // Karte sofort aus der Liste entfernen
                this.topMatches = this.topMatches.filter(m => m.match_id !== matchId);
                this.wowMatches = this.wowMatches.filter(m => m.match_id !== matchId);
                this.followUps = this.followUps.filter(m => m.match_id !== matchId);
                this.proximityMatches = this.proximityMatches.filter(m => m.match_id !== matchId);
                // Summary aktualisieren
                this.summary.total_top = this.topMatches.length;
                this.summary.total_wow = this.wowMatches.length;
                this.summary.total_followups = this.followUps.length;
                this.summary.total_proximity = this.proximityMatches.length;
            } catch(e) {
                console.error('Aktion fehlgeschlagen:', e);
            }
        }
    };
}
</script>
{% endblock %}
