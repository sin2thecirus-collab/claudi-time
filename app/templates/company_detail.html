{% extends "base.html" %}

{% block title %}{{ company.name }} - Pulspoint{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        --pp-blue: #0b69b6; --pp-blueD: #095a9e; --pp-blueL: #0d7fd4;
        --pp-blue50: #eef5fb; --pp-blue100: #d4e8f7; --pp-blue200: #a8d1ef;
        --pp-green: #63b731; --pp-greenD: #4a9624; --pp-green50: #f0fdf4; --pp-green100: #dcfce7;
        --pp-s50: #f8fafc; --pp-s100: #f1f5f9; --pp-s200: #e2e8f0; --pp-s300: #cbd5e1;
        --pp-s400: #94a3b8; --pp-s500: #64748b; --pp-s600: #475569; --pp-s700: #334155; --pp-s800: #1e293b;
        --pp-red: #ef4444; --pp-redD: #dc2626; --pp-red50: #fef2f2;
        --pp-amber: #f59e0b; --pp-amberD: #d97706; --pp-amber50: #fffbeb;
        --pp-ff: 'Outfit', sans-serif;
    }
    .pp-page, .pp-page * { font-family: var(--pp-ff); box-sizing: border-box; margin: 0; }
    .pp-page { background: var(--pp-s50); color: var(--pp-s800); font-size: 14px; min-height: 100vh; }

    .pp-page ::-webkit-scrollbar { width: 6px; height: 8px; }
    .pp-page ::-webkit-scrollbar-track { background: var(--pp-s100); border-radius: 4px; }
    .pp-page ::-webkit-scrollbar-thumb { background: var(--pp-s300); border-radius: 4px; }
    .pp-page ::-webkit-scrollbar-thumb:hover { background: var(--pp-s400); }
    .pp-page ::selection { background: var(--pp-blue200); }

    @keyframes ppFadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    @keyframes ppSlideIn { from { opacity:0; transform:translateX(8px); } to { opacity:1; transform:translateX(0); } }
    .pp-anim { opacity:0; animation: ppFadeUp 0.5s cubic-bezier(0.16,1,0.3,1) forwards; }
    .pp-anim-side { opacity:0; animation: ppSlideIn 0.4s ease forwards; }

    /* Header Card */
    .pp-hdr { background:#fff; border-radius:14px; border:1px solid var(--pp-s200); box-shadow:0 1px 3px rgba(0,0,0,0.04); overflow:hidden; }
    .pp-hdr-stripe { height:3px; background:linear-gradient(90deg, var(--pp-green), var(--pp-blue)); }
    .pp-hdr-top { padding:16px 24px; display:flex; align-items:center; gap:16px; }
    .pp-hdr-avatar { width:48px; height:48px; border-radius:12px; flex-shrink:0; background:linear-gradient(145deg, var(--pp-green), #1a7050, var(--pp-blue)); box-shadow:0 3px 10px rgba(42,138,74,0.25); display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:800; color:#fff; }
    .pp-hdr-name { font-size:19px; font-weight:800; color:var(--pp-s800); letter-spacing:-0.02em; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pp-hdr-meta { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--pp-s400); margin-top:3px; }
    .pp-hdr-meta .sep { color:var(--pp-s200); }
    .pp-hdr-bottom { border-top:1px solid var(--pp-s100); padding:9px 24px; display:flex; align-items:center; background:var(--pp-s50); gap:20px; font-size:13px; flex-wrap:wrap; }
    .pp-hdr-bottom .sep { color:var(--pp-s200); }
    .pp-hdr-bottom a { color:var(--pp-blue); text-decoration:none; font-weight:600; }
    .pp-hdr-bottom a:hover { text-decoration:underline; }

    /* Status */
    .pp-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:12px; font-size:12px; font-weight:700; flex-shrink:0; }
    .pp-dot { width:6px; height:6px; border-radius:50%; }

    /* Copy Btn */
    .pp-cp { width:22px; height:22px; border-radius:5px; border:none; cursor:pointer; flex-shrink:0; padding:0; background:transparent; color:var(--pp-s300); display:inline-flex; align-items:center; justify-content:center; font-size:12px; transition:all 0.15s; }
    .pp-cp:hover { background:var(--pp-s100); color:var(--pp-s500); }

    /* Buttons */
    .pp-btn { padding:7px 14px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:5px; transition:all 0.15s; white-space:nowrap; border:1.5px solid var(--pp-s200); background:#fff; color:var(--pp-s600); font-family:var(--pp-ff); }
    .pp-btn:hover { background:var(--pp-s50); }
    .pp-btn-a { color:var(--pp-blue); border-color:var(--pp-blue200); }
    .pp-btn-a:hover { background:var(--pp-blue50); }
    .pp-btn-p { background:linear-gradient(135deg, var(--pp-green), #2a8a4a); color:#fff; border:none; box-shadow:0 2px 8px rgba(99,183,49,0.25); }
    .pp-btn-p:hover { opacity:0.9; }
    .pp-btn-sm { padding:5px 12px; font-size:12px; }
    .pp-btn-ghost { background:transparent; border:none; color:var(--pp-s400); padding:7px 10px; cursor:pointer; font-size:18px; }
    .pp-btn-ghost:hover { color:var(--pp-s600); }

    /* Tabs */
    .pp-tabs { display:flex; align-items:center; border-bottom:2px solid var(--pp-s200); margin-top:20px; overflow-x:auto; }
    .pp-tab { padding:10px 16px; font-size:14px; font-weight:500; cursor:pointer; border:none; background:transparent; color:var(--pp-s400); border-bottom:2px solid transparent; margin-bottom:-2px; transition:all 0.2s; display:flex; align-items:center; gap:6px; white-space:nowrap; font-family:var(--pp-ff); }
    .pp-tab:hover { color:var(--pp-s600); }
    .pp-tab.active { color:var(--pp-blue); font-weight:700; border-bottom-color:var(--pp-blue); }
    .pp-tab-count { padding:0 6px; border-radius:6px; font-size:11px; font-weight:700; }
    .pp-tab.active .pp-tab-count { background:var(--pp-blue50); color:var(--pp-blue); }
    .pp-tab:not(.active) .pp-tab-count { background:var(--pp-s100); color:var(--pp-s400); }
    .pp-tab-sep { width:1px; height:20px; background:var(--pp-s200); margin:0 10px; flex-shrink:0; }
    .pp-tab-action { padding:10px 14px; font-size:14px; font-weight:500; cursor:pointer; border:none; background:transparent; color:var(--pp-s400); border-bottom:2px solid transparent; margin-bottom:-2px; transition:all 0.2s; display:flex; align-items:center; gap:6px; white-space:nowrap; font-family:var(--pp-ff); }
    .pp-tab-action:hover { color:var(--pp-blue); }

    /* Sections */
    .pp-sec { background:#fff; border-radius:12px; border:1px solid var(--pp-s200); overflow:hidden; }
    .pp-sec-h { display:flex; align-items:center; justify-content:space-between; padding:12px 16px 8px; }
    .pp-sec-t { font-size:14px; font-weight:700; color:var(--pp-s700); }
    .pp-sec-b { padding:0 14px 14px; }

    /* Sidebar */
    .pp-side { background:#fff; border-radius:12px; border:1px solid var(--pp-s200); overflow:hidden; }
    .pp-side-h { padding:12px 14px; border-bottom:1px solid var(--pp-s100); font-size:14px; font-weight:700; color:var(--pp-s700); display:flex; align-items:center; justify-content:space-between; }
    .pp-side-b { padding:12px 14px; }
    .pp-side-cnt { background:var(--pp-blue50); color:var(--pp-blue); font-size:11px; font-weight:700; padding:2px 8px; border-radius:6px; }

    /* Status Menu */
    .pp-stm { position:absolute; right:0; top:100%; margin-top:6px; width:220px; background:#fff; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.12); border:1px solid var(--pp-s200); padding:6px; z-index:50; }
    .pp-stm-i { width:100%; text-align:left; padding:10px 14px; border-radius:8px; font-size:14px; cursor:pointer; display:flex; align-items:center; gap:10px; border:none; background:transparent; color:var(--pp-s700); transition:background 0.15s; font-family:var(--pp-ff); }
    .pp-stm-i:hover { background:var(--pp-s50); }
    .pp-stm-d { color:var(--pp-redD); }
    .pp-stm-d:hover { background:var(--pp-red50); }

    /* Inputs */
    .pp-inp { width:100%; padding:10px 14px; border:1.5px solid var(--pp-s200); border-radius:10px; font-size:14px; color:var(--pp-s800); background:#fff; transition:border-color 0.2s, box-shadow 0.2s; outline:none; font-family:var(--pp-ff); }
    .pp-inp:focus { border-color:var(--pp-blue); box-shadow:0 0 0 3px rgba(11,105,182,0.1); }
    .pp-inp::placeholder { color:var(--pp-s400); }
    .pp-sel { padding:10px 14px; border:1.5px solid var(--pp-s200); border-radius:10px; font-size:14px; color:var(--pp-s800); background:#fff; outline:none; cursor:pointer; font-family:var(--pp-ff); }
    .pp-sel:focus { border-color:var(--pp-blue); box-shadow:0 0 0 3px rgba(11,105,182,0.1); }
    .pp-ta { width:100%; padding:12px 14px; border:1.5px solid var(--pp-s200); border-radius:10px; font-size:14px; color:var(--pp-s800); background:#fff; outline:none; resize:vertical; font-family:var(--pp-ff); }
    .pp-ta:focus { border-color:var(--pp-blue); box-shadow:0 0 0 3px rgba(11,105,182,0.1); }
    .pp-ta::placeholder { color:var(--pp-s400); }
    .pp-iform { margin-top:16px; padding:20px; background:var(--pp-s50); border-radius:12px; border:1.5px solid var(--pp-s200); }

    /* Loading */
    .pp-load { font-size:14px; color:var(--pp-s400); padding:12px 0; }
    @keyframes ppPulse { 0%,100% { opacity:0.6; } 50% { opacity:1; } }
    .pp-load { animation:ppPulse 1.5s ease-in-out infinite; }

    /* Dropzone */
    .pp-dz { border:2px dashed var(--pp-s300); border-radius:12px; padding:24px; text-align:center; cursor:pointer; transition:all 0.2s; background:var(--pp-s50); }
    .pp-dz:hover, .pp-dz.dragover { border-color:var(--pp-blue); background:var(--pp-blue50); }
</style>
{% endblock %}

{% block content %}
{% set invalid_vals = ['not available', 'n/a', 'na', 'none', 'null', '-', '—', ''] %}

<div class="pp-page" x-data="{ tab: 'overview', statusOpen: false }">
    <div style="max-width:1440px; margin:0 auto; padding:16px 24px 40px;">

        {# ════ BREADCRUMB ════ #}
        <div class="pp-anim" style="margin-bottom:10px; font-size:13px; color:var(--pp-s400); font-weight:500;">
            <a href="/" style="color:var(--pp-blue); text-decoration:none;">&#x1F3E0;</a>
            <span style="margin:0 5px;">&#x203A;</span>
            <a href="/unternehmen" style="color:var(--pp-blue); text-decoration:none; font-weight:600;">Unternehmen</a>
            <span style="margin:0 5px;">&#x203A;</span>
            <span style="color:var(--pp-s500);">{{ company.name }}</span>
        </div>

        {# ════ HEADER CARD ════ #}
        <div class="pp-hdr pp-anim" style="animation-delay:80ms;">
            <div class="pp-hdr-stripe"></div>
            <div class="pp-hdr-top">
                <div class="pp-hdr-avatar">{% set np = company.name.split() %}{% if np|length >= 2 %}{{ np[0][0]|upper }}{{ np[1][0]|upper }}{% else %}{{ company.name[0:2]|upper }}{% endif %}</div>
                <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="pp-hdr-name">{{ company.name }}</span>
                        {% if company.status.value == 'active' %}
                        <span class="pp-badge" style="background:var(--pp-green50); color:var(--pp-greenD);"><span class="pp-dot" style="background:var(--pp-green);"></span> Aktiv</span>
                        {% elif company.status.value == 'blacklist' %}
                        <span class="pp-badge" style="background:var(--pp-red50); color:var(--pp-redD);"><span class="pp-dot" style="background:var(--pp-red);"></span> Blacklist</span>
                        {% else %}
                        <span class="pp-badge" style="background:var(--pp-amber50); color:var(--pp-amberD);"><span class="pp-dot" style="background:var(--pp-amber);"></span> Laufende Prozesse</span>
                        {% endif %}
                    </div>
                    <div class="pp-hdr-meta">
                        {% if company.city and company.city|string|lower|trim not in invalid_vals %}
                        <span>&#x1F4CD; {{ company.city }}</span>
                        {% endif %}
                        {% if company.employee_count and company.employee_count|string|lower|trim not in invalid_vals %}
                        {% if company.city and company.city|string|lower|trim not in invalid_vals %}<span class="sep">|</span>{% endif %}
                        <span>&#x1F465; {{ company.employee_count }} MA</span>
                        {% endif %}
                        {% if job_count is defined %}
                        <span class="sep">|</span>
                        <span>&#x1F4BC; {{ job_count }} Job{{ 's' if job_count != 1 else '' }}</span>
                        {% endif %}
                    </div>
                </div>
                <div style="position:relative; flex-shrink:0;">
                    <button @click="statusOpen = !statusOpen" class="pp-btn-ghost" title="Status ändern">&#x2699;&#xFE0F;</button>
                    <div x-show="statusOpen" @click.away="statusOpen = false" x-transition class="pp-stm" style="display:none;">
                        <button onclick="setStatus('active')" class="pp-stm-i"><span style="width:8px;height:8px;border-radius:50%;background:var(--pp-green);"></span> Aktiv</button>
                        <button onclick="setStatus('laufende_prozesse')" class="pp-stm-i"><span style="width:8px;height:8px;border-radius:50%;background:var(--pp-amber);"></span> Laufende Prozesse</button>
                        <button onclick="setStatus('blacklist')" class="pp-stm-i pp-stm-d"><span style="width:8px;height:8px;border-radius:50%;background:var(--pp-red);"></span> Blacklist</button>
                    </div>
                </div>
            </div>

            {# Bottom Bar #}
            {% set addr_valid = company.address and company.address|string|lower|trim not in invalid_vals %}
            {% set phone_valid = company.phone and company.phone|string|lower|trim not in invalid_vals %}
            {% set domain_valid = company.domain and company.domain|string|lower|trim not in invalid_vals %}
            {% if addr_valid or phone_valid or domain_valid %}
            <div class="pp-hdr-bottom">
                {% if addr_valid %}
                <span style="display:flex;align-items:center;gap:5px;color:var(--pp-s500);">&#x1F4CD; {{ company.address }}<button onclick="copyToClipboard('{{ company.address|replace('\n',' ')|replace("'","\\'") }}')" class="pp-cp" title="Kopieren">&#x1F4CB;</button></span>
                {% endif %}
                {% if addr_valid and (phone_valid or domain_valid) %}<span class="sep">|</span>{% endif %}
                {% if phone_valid %}
                <span style="display:flex;align-items:center;gap:5px;"><a href="tel:{{ company.phone }}">&#x1F4DE; {{ company.phone }}</a><button onclick="copyToClipboard('{{ company.phone }}')" class="pp-cp" title="Kopieren">&#x1F4CB;</button></span>
                {% endif %}
                {% if phone_valid and domain_valid %}<span class="sep">|</span>{% endif %}
                {% if domain_valid %}
                <span style="display:flex;align-items:center;gap:5px;"><a href="{% if 'http' in company.domain %}{{ company.domain }}{% else %}https://{{ company.domain }}{% endif %}" target="_blank">&#x1F310; {{ company.domain }}</a><button onclick="copyToClipboard('{{ company.domain }}')" class="pp-cp" title="Kopieren">&#x1F4CB;</button></span>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {# ════ CONTENT GRID (Tabs inside grid, same as JSX prototype) ════ #}
        <div style="display:grid; grid-template-columns:1fr 280px; gap:16px; align-items:start;">

            {# ═══ LEFT COLUMN ═══ #}
            <div style="min-width:0;">

                {# Tab Bar with Quick Actions #}
                <div class="pp-tabs pp-anim" style="animation-delay:200ms;">
                    <button class="pp-tab" :class="{ active: tab==='overview' }" @click="tab='overview'"><span style="font-size:15px;">&#x1F4CB;</span> Übersicht</button>
                    <button class="pp-tab" :class="{ active: tab==='contacts' }" @click="tab='contacts'"><span style="font-size:15px;">&#x1F464;</span> Kontakte</button>
                    <button class="pp-tab" :class="{ active: tab==='activities' }" @click="tab='activities'"><span style="font-size:15px;">&#x1F4C8;</span> Aktivitäten</button>
                    <button class="pp-tab" :class="{ active: tab==='emails' }" @click="tab='emails'"><span style="font-size:15px;">&#x1F4E7;</span> E-Mails</button>
                    <button class="pp-tab" :class="{ active: tab==='documents' }" @click="tab='documents'"><span style="font-size:15px;">&#x1F4C1;</span> Dokumente</button>
                    {# Quick Actions — rechts, gleicher Stil wie im Prototyp #}
                    <div style="margin-left:auto; display:flex; align-items:center;">
                        <div class="pp-tab-sep"></div>
                        <button class="pp-tab-action" onclick="toggleCorrForm()">&#x1F4E7; E-Mail</button>
                        <button class="pp-tab-action" onclick="document.getElementById('company-notes').focus()">&#x1F4DD; Notiz</button>
                    </div>
                </div>

                {# ── Übersicht ── #}
                <div x-show="tab==='overview'" style="display:flex;flex-direction:column;gap:12px;padding-top:12px;">
                    {# Kontakte #}
                    <div class="pp-sec pp-anim" style="animation-delay:250ms;">
                        <div class="pp-sec-h"><span class="pp-sec-t">&#x1F464; Kontakte</span><button onclick="toggleContactForm()" class="pp-btn pp-btn-a pp-btn-sm">&#xFF0B; Hinzufügen</button></div>
                        <div class="pp-sec-b">
                            <div id="contacts-container" hx-get="/partials/company-contacts/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Kontakte...</p></div>
                            <div id="contact-form" style="display:none" class="pp-iform">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                    <input type="text" id="cf-first-name" placeholder="Vorname" class="pp-inp">
                                    <input type="text" id="cf-last-name" placeholder="Nachname" class="pp-inp">
                                    <input type="text" id="cf-position" placeholder="Position" class="pp-inp">
                                    <input type="text" id="cf-phone" placeholder="Telefon" class="pp-inp">
                                    <input type="email" id="cf-email" placeholder="E-Mail" class="pp-inp" style="grid-column:span 2;">
                                </div>
                                <div style="display:flex;gap:10px;margin-top:14px;">
                                    <button onclick="saveContact()" class="pp-btn pp-btn-p pp-btn-sm">Speichern</button>
                                    <button onclick="toggleContactForm()" class="pp-btn pp-btn-sm">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# 3-Spalten Grid: ATS-Stellen | Aufgaben | Notizen #}
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                        {# ATS-Stellen #}
                        <div class="pp-sec pp-anim" style="animation-delay:300ms;">
                            <div class="pp-sec-h"><span class="pp-sec-t">&#x1F3AF; Stellen</span></div>
                            <div class="pp-sec-b"><div id="company-ats-jobs" hx-get="/partials/company-ats-jobs/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Stellen...</p></div></div>
                        </div>
                        {# Aufgaben #}
                        <div class="pp-sec pp-anim" style="animation-delay:350ms;">
                            <div class="pp-sec-h"><span class="pp-sec-t">&#x2705; Aufgaben</span></div>
                            <div class="pp-sec-b"><div id="todos-container" hx-get="/partials/company/{{ company.id }}/todos" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Aufgaben...</p></div></div>
                        </div>
                        {# Notizen #}
                        <div class="pp-sec pp-anim" style="animation-delay:400ms;">
                            <div class="pp-sec-h"><span class="pp-sec-t">&#x1F4DD; Notizen</span></div>
                            <div class="pp-sec-b">
                                <textarea id="company-notes" placeholder="Notizen zum Unternehmen..." rows="5" onblur="saveNotes()" class="pp-ta" style="font-size:13px;">{{ company.notes or '' }}</textarea>
                                <div style="text-align:right;margin-top:4px;font-size:11px;color:var(--pp-s400);">Auto-Save bei Fokusverlust</div>
                            </div>
                        </div>
                    </div>

                    {# Letzte Aktivitäten #}
                    <div class="pp-sec pp-anim" style="animation-delay:450ms;">
                        <div class="pp-sec-h"><span class="pp-sec-t">&#x1F4C8; Letzte Aktivitäten</span><button class="pp-tab-action" style="padding:4px 8px;font-size:13px;font-weight:600;color:var(--pp-blue);margin-bottom:0;border-bottom:none;" @click="tab='activities'">Alle &#x2192;</button></div>
                        <div class="pp-sec-b"><div id="activities-container" hx-get="/partials/company/{{ company.id }}/activities" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Aktivitäten...</p></div></div>
                    </div>
                </div>

                {# ── Tab: Kontakte ── #}
                <div x-show="tab==='contacts'" x-cloak style="padding-top:12px;">
                    <div class="pp-sec">
                        <div class="pp-sec-h"><span class="pp-sec-t">&#x1F464; Alle Kontakte</span><button onclick="toggleContactForm()" class="pp-btn pp-btn-a pp-btn-sm">&#xFF0B; Hinzufügen</button></div>
                        <div class="pp-sec-b"><div hx-get="/partials/company-contacts/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Kontakte...</p></div></div>
                    </div>
                </div>

                {# ── Tab: Aktivitäten ── #}
                <div x-show="tab==='activities'" x-cloak style="padding-top:12px;">
                    <div class="pp-sec">
                        <div class="pp-sec-h"><span class="pp-sec-t">&#x1F4C8; Alle Aktivitäten</span><span style="font-size:12px;color:var(--pp-s400);font-weight:500;">Chronologisch — neueste zuerst</span></div>
                        <div class="pp-sec-b"><div hx-get="/partials/company/{{ company.id }}/activities" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Aktivitäten...</p></div></div>
                    </div>
                </div>

                {# ── Tab: E-Mails ── #}
                <div x-show="tab==='emails'" x-cloak style="padding-top:12px;">
                    <div class="pp-sec">
                        <div class="pp-sec-h"><span class="pp-sec-t">&#x1F4E7; Alle E-Mails</span><button onclick="toggleCorrForm()" class="pp-btn pp-btn-a pp-btn-sm">&#xFF0B; Neue E-Mail</button></div>
                        <div class="pp-sec-b">
                            <div id="correspondence-container" hx-get="/partials/company-correspondence/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade E-Mails...</p></div>
                            <div id="corr-form" style="display:none" class="pp-iform">
                                <div style="display:flex;flex-direction:column;gap:12px;">
                                    <div style="display:flex;gap:12px;">
                                        <select id="corr-direction" class="pp-sel"><option value="outbound">Ausgehend</option><option value="inbound">Eingehend</option></select>
                                        <input type="text" id="corr-subject" placeholder="Betreff" class="pp-inp" style="flex:1;">
                                    </div>
                                    <textarea id="corr-body" placeholder="Inhalt / Notizen" rows="3" class="pp-ta"></textarea>
                                </div>
                                <div style="display:flex;gap:10px;margin-top:14px;">
                                    <button onclick="saveCorrespondence()" class="pp-btn pp-btn-p pp-btn-sm">Speichern</button>
                                    <button onclick="toggleCorrForm()" class="pp-btn pp-btn-sm">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {# ── Tab: Dokumente ── #}
                <div x-show="tab==='documents'" x-cloak style="padding-top:12px;">
                    <div class="pp-sec">
                        <div class="pp-sec-h"><span class="pp-sec-t">&#x1F4C1; Alle Dokumente</span><button onclick="toggleDocForm()" class="pp-btn pp-btn-a pp-btn-sm">&#x2B06; Hochladen</button></div>
                        <div class="pp-sec-b">
                            <div id="documents-container" hx-get="/partials/company/{{ company.id }}/documents" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Dokumente...</p></div>
                            <div id="doc-upload-form" style="display:none" class="pp-iform">
                                <div class="pp-dz" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFileDrop(event)" onclick="document.getElementById('doc-file-input').click()">
                                    <div style="font-size:28px;margin-bottom:6px;">&#x1F4C4;</div>
                                    <div style="font-size:14px;font-weight:600;color:var(--pp-s500);">Datei hierher ziehen oder klicken</div>
                                    <div style="font-size:12px;color:var(--pp-s400);margin-top:4px;">PDF, Word, Bilder, etc.</div>
                                </div>
                                <input type="file" id="doc-file-input" onchange="handleFileSelect(this)" style="display:none;">
                                <div id="doc-file-name" class="hidden" style="margin-top:10px;font-size:13px;font-weight:600;color:var(--pp-blue);padding:8px 12px;background:var(--pp-blue50);border-radius:8px;"></div>
                                <input type="text" id="doc-notes" placeholder="Notizen zum Dokument (optional)" class="pp-inp" style="margin-top:12px;">
                                <div style="display:flex;gap:10px;margin-top:14px;">
                                    <button id="doc-upload-btn" onclick="uploadDocument()" disabled class="pp-btn pp-btn-p pp-btn-sm" style="opacity:0.5;">Hochladen</button>
                                    <button onclick="toggleDocForm()" class="pp-btn pp-btn-sm">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ═══ SIDEBAR 280px ═══ #}
            <div style="display:flex;flex-direction:column;gap:10px;position:sticky;top:16px;margin-top:56px;">
                {# ATS-Stellen #}
                <div class="pp-side pp-anim-side" style="animation-delay:150ms;">
                    <div class="pp-side-h"><span style="display:flex;align-items:center;gap:6px;">&#x1F3AF; ATS-Stellen <span class="pp-side-cnt">{{ ats_job_count }}</span></span><a href="/ats/stellen" style="font-size:12px;color:var(--pp-blue);font-weight:600;text-decoration:none;">Alle &#x2192;</a></div>
                    <div class="pp-side-b"><div hx-get="/partials/company-ats-jobs/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade ATS-Stellen...</p></div></div>
                </div>
                {# Jobs #}
                <div class="pp-side pp-anim-side" style="animation-delay:200ms;">
                    <div class="pp-side-h"><span style="display:flex;align-items:center;gap:6px;">&#x1F4BC; Jobs <span class="pp-side-cnt">{{ job_count }}</span></span></div>
                    <div class="pp-side-b"><div id="company-jobs" hx-get="/partials/company-jobs/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML"><p class="pp-load">Lade Jobs...</p></div></div>
                </div>
                {# Details #}
                <div class="pp-side pp-anim-side" style="animation-delay:250ms;">
                    <div class="pp-side-h">&#x2139;&#xFE0F; Details</div>
                    <div class="pp-side-b">
                        <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 10px;font-size:13px;">
                            <span style="color:var(--pp-s400);">Erstellt</span><span style="color:var(--pp-s700);font-weight:600;text-align:right;">{{ company.created_at | datetime }}</span>
                            <span style="color:var(--pp-s400);">Aktualisiert</span><span style="color:var(--pp-s700);font-weight:600;text-align:right;">{{ company.updated_at | datetime }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const COMPANY_ID = '{{ company.id }}';

function copyToClipboard(text) {
    navigator.clipboard.writeText(text.trim()).then(() => { showToast('Kopiert!', 'success'); });
}

function setStatus(status) {
    fetch(`/api/companies/${COMPANY_ID}/status?status=${status}`, { method: 'PUT' })
        .then(r => r.json())
        .then(() => { showToast('Status geaendert', 'success'); setTimeout(() => location.reload(), 500); })
        .catch(() => showToast('Fehler', 'error'));
}

function saveNotes() {
    const notes = document.getElementById('company-notes').value;
    fetch(`/api/companies/${COMPANY_ID}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ notes: notes }) })
        .then(() => showToast('Notizen gespeichert', 'success'));
}

function toggleContactForm() { const f = document.getElementById('contact-form'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }

function saveContact() {
    const data = { first_name: document.getElementById('cf-first-name').value || null, last_name: document.getElementById('cf-last-name').value || null, position: document.getElementById('cf-position').value || null, phone: document.getElementById('cf-phone').value || null, email: document.getElementById('cf-email').value || null };
    fetch(`/api/companies/${COMPANY_ID}/contacts`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(r => r.json()).then(() => { showToast('Kontakt erstellt', 'success'); toggleContactForm(); ['cf-first-name','cf-last-name','cf-position','cf-phone','cf-email'].forEach(id => document.getElementById(id).value = ''); htmx.trigger('#contacts-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

function deleteContact(contactId) { if (!confirm('Kontakt loeschen?')) return; fetch(`/api/companies/contacts/${contactId}`, { method: 'DELETE' }).then(r => r.json()).then(() => { showToast('Kontakt geloescht', 'success'); htmx.trigger('#contacts-container', 'load'); }).catch(() => showToast('Fehler', 'error')); }

function toggleCorrForm() { const f = document.getElementById('corr-form'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }

function saveCorrespondence() {
    const data = { direction: document.getElementById('corr-direction').value, subject: document.getElementById('corr-subject').value, body: document.getElementById('corr-body').value || null };
    if (!data.subject) { showToast('Betreff erforderlich', 'error'); return; }
    fetch(`/api/companies/${COMPANY_ID}/correspondence`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(r => r.json()).then(() => { showToast('Korrespondenz erstellt', 'success'); toggleCorrForm(); document.getElementById('corr-subject').value = ''; document.getElementById('corr-body').value = ''; htmx.trigger('#correspondence-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

function deleteCorrespondence(corrId) { if (!confirm('Korrespondenz loeschen?')) return; fetch(`/api/companies/correspondence/${corrId}`, { method: 'DELETE' }).then(r => r.json()).then(() => { showToast('Geloescht', 'success'); htmx.trigger('#correspondence-container', 'load'); }).catch(() => showToast('Fehler', 'error')); }

function deleteCompanyCallNote(noteId) { if (!confirm('Anrufprotokoll loeschen?')) return; fetch(`/api/ats/call-notes/${noteId}`, { method: 'DELETE' }).then(r => r.json()).then(() => { showToast('Geloescht', 'success'); htmx.trigger('#call-notes-container', 'load'); }).catch(() => showToast('Fehler', 'error')); }

function deleteCompanyTodo(todoId) { if (!confirm('Aufgabe loeschen?')) return; fetch(`/api/ats/todos/${todoId}`, { method: 'DELETE' }).then(r => r.json()).then(() => { showToast('Geloescht', 'success'); htmx.trigger('#todos-container', 'load'); }).catch(() => showToast('Fehler', 'error')); }

var selectedDocFile = null;
function toggleDocForm() { const f = document.getElementById('doc-upload-form'); if (f) f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
function handleFileDrop(event) { const files = event.dataTransfer.files; if (files.length > 0) setDocFile(files[0]); }
function handleFileSelect(input) { if (input.files.length > 0) setDocFile(input.files[0]); }
function setDocFile(file) { selectedDocFile = file; const n = document.getElementById('doc-file-name'); if (n) { n.textContent = file.name + ' (' + (file.size/1024).toFixed(1) + ' KB)'; n.classList.remove('hidden'); } const b = document.getElementById('doc-upload-btn'); if (b) { b.disabled = false; b.style.opacity = '1'; } }
function uploadDocument() {
    if (!selectedDocFile) return;
    const fd = new FormData(); fd.append('file', selectedDocFile);
    const notes = document.getElementById('doc-notes'); if (notes && notes.value) fd.append('notes', notes.value);
    const btn = document.getElementById('doc-upload-btn'); if (btn) { btn.disabled = true; btn.textContent = 'Hochladen...'; }
    fetch(`/api/companies/${COMPANY_ID}/documents`, { method: 'POST', body: fd })
        .then(r => r.json()).then(() => { showToast('Dokument hochgeladen', 'success'); toggleDocForm(); selectedDocFile = null; if (notes) notes.value = ''; const n = document.getElementById('doc-file-name'); if (n) n.classList.add('hidden'); if (btn) { btn.disabled = true; btn.textContent = 'Hochladen'; btn.style.opacity = '0.5'; } htmx.trigger('#documents-container', 'load'); })
        .catch(() => { showToast('Upload fehlgeschlagen', 'error'); if (btn) { btn.disabled = false; btn.textContent = 'Hochladen'; btn.style.opacity = '1'; } });
}
function deleteDocument(docId) { if (!confirm('Dokument loeschen?')) return; fetch(`/api/companies/documents/${docId}`, { method: 'DELETE' }).then(r => r.json()).then(() => { showToast('Geloescht', 'success'); htmx.trigger('#documents-container', 'load'); }).catch(() => showToast('Fehler', 'error')); }
</script>
{% endblock %}
