{% extends "base.html" %}

{% block title %}{{ company.name }} - Pulspoint{% endblock %}

{% block head %}
<style>
    /* ‚ïê‚ïê‚ïê Company Detail Dark Theme ‚ïê‚ïê‚ïê */
    .cd-page { color: var(--pp-text); }
    .cd-page * { box-sizing: border-box; }

    /* Animations */
    @keyframes cdFadeUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
    .cd-anim { opacity:0; animation: cdFadeUp 0.4s cubic-bezier(0.16,1,0.3,1) forwards; }

    /* Company Header */
    .cd-header {
        padding: 24px 32px 0;
        border-bottom: 1px solid var(--pp-border);
        background: linear-gradient(180deg, rgba(24,26,35,0.53), transparent);
    }
    .cd-breadcrumb {
        font-size: 14px; color: var(--pp-textDim); margin-bottom: 16px;
        display: flex; align-items: center; gap: 8px;
    }
    .cd-breadcrumb a { color: var(--pp-accent); text-decoration: none; cursor: pointer; }
    .cd-breadcrumb a:hover { text-decoration: underline; }

    .cd-info-row {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 42px;
    }
    .cd-info-left { display: flex; align-items: center; gap: 16px; min-width: 0; flex: 1; }

    .cd-avatar {
        width: 56px; height: 56px; border-radius: 14px; flex-shrink: 0;
        background: linear-gradient(135deg, #2563EB22, #2563EB44);
        border: 1px solid #2563EB44;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; font-weight: 700; color: var(--pp-accent);
    }
    .cd-name {
        font-size: 27px; font-weight: 700; margin: 0;
        letter-spacing: -0.02em; color: var(--pp-text);
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .cd-meta {
        display: flex; align-items: center; gap: 18px; margin-top: 8px;
        font-size: 20px; color: var(--pp-textMuted);
    }
    .cd-meta .sep { color: var(--pp-textDim); }
    .cd-meta a { color: var(--pp-accent); text-decoration: none; display: flex; align-items: center; gap: 5px; }
    .cd-meta a:hover { text-decoration: underline; }

    /* Status Badge */
    .cd-badge {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 3px 10px; border-radius: 7px; font-size: 13px; font-weight: 600;
        letter-spacing: 0.03em;
    }

    /* Action Buttons */
    .cd-btn-call {
        display: flex; align-items: center; gap: 8px;
        padding: 10px 18px; border-radius: 10px;
        border: 1px solid rgba(52,211,153,0.27);
        background: var(--pp-greenSoft); color: var(--pp-green);
        font-size: 14px; font-weight: 600; cursor: pointer;
        transition: all 0.15s; font-family: var(--pp-ff);
    }
    .cd-btn-call:hover { background: rgba(52,211,153,0.14); }
    .cd-btn-gear {
        padding: 10px 14px; border-radius: 10px;
        border: 1px solid var(--pp-border); background: transparent;
        color: var(--pp-textMuted); font-size: 16px; cursor: pointer;
        transition: all 0.15s;
    }
    .cd-btn-gear:hover { border-color: var(--pp-borderLight); color: var(--pp-text); }

    /* Status Menu */
    .cd-status-menu {
        position: absolute; right: 0; top: 100%; margin-top: 8px;
        width: 240px; background: var(--pp-surface); border-radius: 14px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.35); border: 1px solid var(--pp-border);
        padding: 6px; z-index: 50;
    }
    .cd-status-item {
        width: 100%; text-align: left; padding: 12px 16px; border-radius: 10px;
        font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;
        border: none; background: transparent; color: var(--pp-text);
        transition: background 0.15s; font-family: var(--pp-ff);
    }
    .cd-status-item:hover { background: var(--pp-surfaceHover); }
    .cd-status-item.danger { color: var(--pp-red); }
    .cd-status-item.danger:hover { background: var(--pp-redSoft); }

    /* Tabs */
    .cd-tabs { display: flex; gap: 2px; }
    .cd-tab {
        padding: 12px 20px; border-radius: 10px 10px 0 0; border: none;
        cursor: pointer; font-size: 15px; font-weight: 600;
        display: flex; align-items: center; gap: 8px;
        color: var(--pp-textMuted); background: transparent;
        border-bottom: 2px solid transparent;
        transition: all 0.15s; font-family: var(--pp-ff);
    }
    .cd-tab:hover { color: var(--pp-text); }
    .cd-tab.active {
        position: relative;
        border-bottom-color: var(--pp-accent);
        background: linear-gradient(90deg, #4F8CFF, #B8D4FF);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .cd-tab.active::before {
        content: '';
        position: absolute;
        inset: 0;
        background: var(--pp-accentSoft);
        border-radius: 10px 10px 0 0;
        border-bottom: 2px solid var(--pp-accent);
        z-index: -1;
    }
    .cd-tab .icon { font-size: 16px; }
    .cd-tab.active .icon {
        -webkit-text-fill-color: initial;
        -webkit-background-clip: initial;
        background-clip: initial;
        background: none;
    }

    /* Main Grid */
    .cd-grid {
        display: grid; grid-template-columns: 1fr 380px; gap: 0;
        min-height: calc(100vh - 200px);
    }
    .cd-main { padding: 24px 28px; border-right: 1px solid var(--pp-border); }
    .cd-sidebar {
        padding: 28px 24px; background: rgba(24,26,35,0.4);
        display: flex; flex-direction: column;
    }

    /* Overview Cards */
    .cd-overview-card {
        background: var(--pp-surface);
        border: 1px solid var(--pp-border);
        border-radius: 14px;
        padding: 20px;
        overflow: hidden;
    }

    /* Section Header */
    .cd-sec-hdr {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 16px; padding: 0 2px;
    }
    .cd-sec-hdr-left { display: flex; align-items: center; gap: 10px; }
    .cd-sec-hdr-left .icon { font-size: 22px; }
    .cd-sec-hdr-left .title {
        font-size: 18px; font-weight: 750; letter-spacing: 0.01em;
        background: linear-gradient(90deg, #4F8CFF, #B8D4FF);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .cd-sec-hdr-left .count {
        font-size: 13px; font-weight: 600; color: var(--pp-textDim);
        background: var(--pp-surfaceHover); padding: 2px 8px; border-radius: 6px;
    }
    .cd-sec-action {
        background: none; border: 1px solid var(--pp-border); border-radius: 8px;
        color: var(--pp-textMuted); font-size: 13px; font-weight: 500;
        padding: 6px 12px; cursor: pointer; transition: all 0.15s;
        font-family: var(--pp-ff);
    }
    .cd-sec-action:hover { border-color: var(--pp-accent); color: var(--pp-accent); }

    /* Card */
    .cd-card {
        background: var(--pp-surface); border: 1px solid var(--pp-border);
        border-radius: 14px; padding: 20px; transition: all 0.2s ease;
    }

    /* Sidebar Sections */
    .cd-side-sec { margin-bottom: 32px; }
    .cd-side-hdr {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 16px;
    }
    .cd-side-hdr-left { display: flex; align-items: center; gap: 10px; }
    .cd-side-hdr-left .icon { font-size: 18px; }
    .cd-side-hdr-left .title { font-size: 16px; font-weight: 650; color: var(--pp-text); }
    .cd-side-hdr-left .cnt {
        font-size: 13px; font-weight: 700; padding: 3px 8px; border-radius: 6px;
    }
    .cd-side-link { font-size: 14px; color: var(--pp-accent); cursor: pointer; text-decoration: none; }
    .cd-side-link:hover { text-decoration: underline; }
    .cd-side-empty {
        padding: 28px; border-radius: 12px; border: 1px dashed var(--pp-border);
        text-align: center;
    }
    .cd-side-empty-text { font-size: 14px; color: var(--pp-textDim); margin-bottom: 10px; }
    .cd-side-empty-link { font-size: 14px; color: var(--pp-accent); cursor: pointer; }

    /* Call Stats */
    .cd-stat-box {
        padding: 20px; border-radius: 12px; background: var(--pp-surface);
        border: 1px solid var(--pp-border); text-align: center;
    }
    .cd-stat-val { font-size: 32px; font-weight: 700; }
    .cd-stat-label { font-size: 13px; color: var(--pp-textDim); margin-top: 4px; }

    /* Date Footer */
    .cd-date-footer {
        padding: 14px 0; border-top: 1px solid var(--pp-border);
        display: flex; justify-content: space-between;
        font-size: 12px; color: var(--pp-textDim); letter-spacing: 0.02em;
    }

    /* Loading */
    .cd-load { font-size: 14px; color: var(--pp-textMuted); padding: 14px 0; }
    @keyframes cdPulse { 0%,100% { opacity:0.6; } 50% { opacity:1; } }
    .cd-load { animation: cdPulse 1.5s ease-in-out infinite; }

    /* Inputs Dark */
    .cd-inp {
        width: 100%; padding: 11px 14px; border-radius: 10px;
        border: 1px solid var(--pp-border); background: var(--pp-bg);
        color: var(--pp-text); font-size: 14px; outline: none;
        transition: border-color 0.15s; font-family: var(--pp-ff);
    }
    .cd-inp:focus { border-color: var(--pp-accent); box-shadow: 0 0 0 3px rgba(79,140,255,0.1); }
    .cd-inp::placeholder { color: var(--pp-textDim); }
    .cd-sel {
        padding: 11px 14px; border-radius: 10px;
        border: 1px solid var(--pp-border); background: var(--pp-bg);
        color: var(--pp-text); font-size: 14px; outline: none;
        cursor: pointer; font-family: var(--pp-ff);
    }
    .cd-sel:focus { border-color: var(--pp-accent); box-shadow: 0 0 0 3px rgba(79,140,255,0.1); }
    .cd-sel option { background: var(--pp-surface); color: var(--pp-text); }
    .cd-ta {
        width: 100%; padding: 11px 14px; border-radius: 10px;
        border: 1px solid var(--pp-border); background: var(--pp-bg);
        color: var(--pp-text); font-size: 14px; outline: none;
        resize: vertical; font-family: var(--pp-ff);
    }
    .cd-ta:focus { border-color: var(--pp-accent); box-shadow: 0 0 0 3px rgba(79,140,255,0.1); }
    .cd-ta::placeholder { color: var(--pp-textDim); }
    .cd-iform {
        margin-top: 18px; padding: 22px; background: var(--pp-bg);
        border-radius: 12px; border: 1px solid var(--pp-border);
    }

    /* Buttons Dark */
    .cd-btn {
        padding: 9px 16px; border-radius: 10px; font-size: 14px; font-weight: 600;
        cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
        transition: all 0.15s; font-family: var(--pp-ff);
        border: 1px solid var(--pp-border); background: var(--pp-surface);
        color: var(--pp-textMuted);
    }
    .cd-btn:hover { background: var(--pp-surfaceHover); border-color: var(--pp-borderLight); }
    .cd-btn-accent { color: var(--pp-accent); border-color: rgba(79,140,255,0.27); }
    .cd-btn-accent:hover { background: var(--pp-accentSoft); }
    .cd-btn-primary {
        background: linear-gradient(135deg, var(--pp-accent), #6C63FF);
        color: #fff; border: none;
        box-shadow: 0 4px 16px rgba(79,140,255,0.25);
    }
    .cd-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

    /* Dropzone Dark */
    .cd-dz {
        border: 2px dashed var(--pp-border); border-radius: 12px;
        padding: 28px; text-align: center; cursor: pointer;
        transition: all 0.2s; background: var(--pp-bg);
    }
    .cd-dz:hover, .cd-dz.dragover { border-color: var(--pp-accent); background: var(--pp-accentSoft); }

    /* Call Modal */
    .cd-modal-overlay {
        position: fixed; inset: 0; z-index: 1000;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        display: flex; align-items: center; justify-content: center;
    }
    .cd-modal {
        background: var(--pp-surface); border-radius: 20px; padding: 40px;
        width: 620px; border: 1px solid var(--pp-border);
        box-shadow: 0 24px 80px rgba(0,0,0,0.5);
    }
    .cd-modal-hdr {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 32px;
    }
    .cd-modal-icon {
        width: 48px; height: 48px; border-radius: 12px;
        background: var(--pp-accentSoft); display: flex;
        align-items: center; justify-content: center; font-size: 24px;
    }
    .cd-modal-title { font-size: 22px; font-weight: 700; color: var(--pp-text); }
    .cd-modal-close {
        background: none; border: none; color: var(--pp-textDim);
        font-size: 28px; cursor: pointer;
    }
    .cd-modal-close:hover { color: var(--pp-text); }
    .cd-modal-label {
        font-size: 14px; font-weight: 600; color: var(--pp-textMuted);
        margin-bottom: 8px; display: block; letter-spacing: 0.05em;
        text-transform: uppercase;
    }
    .cd-modal-dir-btn {
        flex: 1; padding: 14px 0; border-radius: 10px; font-size: 15px;
        font-weight: 600; cursor: pointer; transition: all 0.15s;
        font-family: var(--pp-ff);
    }
    .cd-modal-submit {
        width: 100%; padding: 16px 0; border-radius: 14px; border: none;
        background: linear-gradient(135deg, var(--pp-accent), #6C63FF);
        color: #fff; font-size: 17px; font-weight: 700; cursor: pointer;
        box-shadow: 0 4px 16px rgba(79,140,255,0.25);
        transition: all 0.2s; font-family: var(--pp-ff);
        margin-top: 8px;
    }
    .cd-modal-submit:hover { transform: translateY(-1px); }

    /* Modal-specific input overrides for larger sizing */
    .cd-modal .cd-inp,
    .cd-modal .cd-sel {
        padding: 14px 18px; font-size: 16px; border-radius: 12px;
    }
    .cd-modal .cd-ta {
        padding: 14px 18px; font-size: 16px; border-radius: 12px;
        min-height: 120px;
    }

    /* Tab Content Sections */
    .cd-tab-sec {
        background: var(--pp-surface); border-radius: 14px;
        border: 1px solid var(--pp-border); overflow: hidden;
    }
    .cd-tab-sec-h {
        display: flex; align-items: center; justify-content: space-between;
        padding: 16px 22px 12px;
    }
    .cd-tab-sec-t {
        display: flex; align-items: center; gap: 10px;
        font-size: 16px; font-weight: 650; color: var(--pp-text);
    }
    .cd-tab-sec-t .icon { font-size: 18px; }
    .cd-tab-sec-b { padding: 0 20px 20px; }
    .cd-tab-sec-sub { font-size: 13px; color: var(--pp-textDim); font-weight: 500; }

    /* Responsive */
    @media (max-width: 900px) {
        .cd-grid { grid-template-columns: 1fr; }
        .cd-sidebar { border-top: 1px solid var(--pp-border); }
        .cd-main { border-right: none; }
    }
</style>
{% endblock %}

{% block content %}
{% set invalid_vals = ['not available', 'n/a', 'na', 'none', 'null', '-', '‚Äî', ''] %}

<div class="cd-page" id="cd-page" x-data="{ tab: 'overview', statusOpen: false, showCallModal: false, callDir: 'outbound' }" x-effect="if (showCallModal) { $nextTick(() => { const d = document.getElementById('call-date'); const t = document.getElementById('call-time'); if (d) d.value = new Date().toISOString().split('T')[0]; if (t) t.value = new Date().toTimeString().slice(0,5); }); }">

    {# ‚ïê‚ïê‚ïê COMPANY HEADER ‚ïê‚ïê‚ïê #}
    <div class="cd-header cd-anim">
        {# Breadcrumb #}
        <div class="cd-breadcrumb">
            <a href="/unternehmen">üè¢ Unternehmen</a>
            <span>‚Ä∫</span>
            <span>{{ company.name }}</span>
        </div>

        {# Company Info Row #}
        <div class="cd-info-row">
            <div class="cd-info-left">
                <div class="cd-avatar">{% set np = company.name.split() %}{% if np|length >= 2 %}{{ np[0][0]|upper }}{{ np[1][0]|upper }}{% else %}{{ company.name[0:2]|upper }}{% endif %}</div>
                <div style="min-width:0; flex:1;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <h1 class="cd-name">{{ company.name }}</h1>
                        {% if company.status.value == 'active' %}
                        <span class="cd-badge" style="color:var(--pp-green); background:var(--pp-greenSoft);">‚óè Aktiv</span>
                        {% elif company.status.value == 'blacklist' %}
                        <span class="cd-badge" style="color:var(--pp-red); background:var(--pp-redSoft);">‚óè Blacklist</span>
                        {% else %}
                        <span class="cd-badge" style="color:var(--pp-orange); background:var(--pp-orangeSoft);">‚óè Laufende Prozesse</span>
                        {% endif %}
                    </div>
                    <div class="cd-meta">
                        {% if company.city and company.city|string|lower|trim not in invalid_vals %}
                        <span style="display:flex; align-items:center; gap:5px;">üìç {{ company.city }}</span>
                        {% endif %}
                        {% if company.address and company.address|string|lower|trim not in invalid_vals %}
                        {% if company.city and company.city|string|lower|trim not in invalid_vals %}<span class="sep">|</span>{% endif %}
                        <span style="display:flex; align-items:center; gap:5px;">üè† {{ company.address }}</span>
                        {% endif %}
                        {% if company.domain and company.domain|string|lower|trim not in invalid_vals %}
                        <span class="sep">|</span>
                        <a href="{% if 'http' in company.domain %}{{ company.domain }}{% else %}https://{{ company.domain }}{% endif %}" target="_blank">üåê {{ company.domain }}</a>
                        {% endif %}
                        {% if job_count is defined %}
                        <span class="sep">|</span>
                        <span>üíº {{ job_count }} Job{{ 's' if job_count != 1 else '' }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; flex-shrink:0;">
                <button class="cd-btn-call" @click="showCallModal = true">üìû Anruf protokollieren</button>
                <div style="position:relative;">
                    <button class="cd-btn-gear" @click="statusOpen = !statusOpen">‚öô</button>
                    <div x-show="statusOpen" @click.away="statusOpen = false" x-transition class="cd-status-menu" style="display:none;">
                        <button onclick="setStatus('active')" class="cd-status-item"><span style="width:8px;height:8px;border-radius:50%;background:var(--pp-green);flex-shrink:0;"></span> Aktiv</button>
                        <button onclick="setStatus('laufende_prozesse')" class="cd-status-item"><span style="width:8px;height:8px;border-radius:50%;background:var(--pp-orange);flex-shrink:0;"></span> Laufende Prozesse</button>
                        <button onclick="setStatus('blacklist')" class="cd-status-item danger"><span style="width:8px;height:8px;border-radius:50%;background:var(--pp-red);flex-shrink:0;"></span> Blacklist</button>
                    </div>
                </div>
            </div>
        </div>

        {# Tabs #}
        <div class="cd-tabs">
            <button class="cd-tab" :class="{ active: tab==='overview' }" @click="tab='overview'"><span class="icon">üìã</span> √úbersicht</button>
            <button class="cd-tab" :class="{ active: tab==='contacts' }" @click="tab='contacts'"><span class="icon">üë§</span> Kontakte</button>
            <button class="cd-tab" :class="{ active: tab==='activities' }" @click="tab='activities'"><span class="icon">üìä</span> Aktivit√§ten</button>
            <button class="cd-tab" :class="{ active: tab==='emails' }" @click="tab='emails'"><span class="icon">‚úâÔ∏è</span> E-Mails</button>
            <button class="cd-tab" :class="{ active: tab==='notes' }" @click="tab='notes'"><span class="icon">üìù</span> Notizen</button>
            <button class="cd-tab" :class="{ active: tab==='documents' }" @click="tab='documents'"><span class="icon">üìÅ</span> Dokumente</button>
        </div>
    </div>

    {# ‚ïê‚ïê‚ïê MAIN GRID ‚ïê‚ïê‚ïê #}
    <div class="cd-grid">

        {# ‚ïê‚ïê‚ïê LEFT MAIN ‚ïê‚ïê‚ïê #}
        <div class="cd-main">

            {# ‚îÄ‚îÄ √úbersicht ‚îÄ‚îÄ #}
            <div x-show="tab==='overview'" style="display:flex; flex-direction:column; gap:20px;">

                {# ‚îÄ‚îÄ ROW 1: Kontakte + Aufgaben ‚îÄ‚îÄ #}
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">

                    {# Kontakte #}
                    <div class="cd-anim cd-overview-card" style="animation-delay:100ms;">
                        <div class="cd-sec-hdr">
                            <div class="cd-sec-hdr-left">
                                <span class="icon">üë•</span>
                                <span class="title">Kontakte</span>
                                <span class="count">{{ contact_count if contact_count is defined else '0' }}</span>
                            </div>
                            <button class="cd-sec-action" onclick="toggleContactForm()">+ Hinzuf√ºgen</button>
                        </div>
                        <div id="contacts-container" hx-get="/partials/company-contacts/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML">
                            <p class="cd-load">Lade Kontakte...</p>
                        </div>
                        <div id="contact-form" style="display:none" class="cd-iform">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <input type="text" id="cf-first-name" placeholder="Vorname" class="cd-inp">
                                <input type="text" id="cf-last-name" placeholder="Nachname" class="cd-inp">
                                <input type="text" id="cf-position" placeholder="Position" class="cd-inp">
                                <input type="text" id="cf-phone" placeholder="Telefon" class="cd-inp">
                                <input type="email" id="cf-email" placeholder="E-Mail" class="cd-inp" style="grid-column:span 2;">
                            </div>
                            <div style="display:flex; gap:10px; margin-top:14px;">
                                <button onclick="saveContact()" class="cd-btn cd-btn-primary">Speichern</button>
                                <button onclick="toggleContactForm()" class="cd-btn">Abbrechen</button>
                            </div>
                        </div>
                    </div>

                    {# Aufgaben #}
                    <div class="cd-anim cd-overview-card" style="animation-delay:200ms;">
                        <div class="cd-sec-hdr">
                            <div class="cd-sec-hdr-left">
                                <span class="icon">‚úÖ</span>
                                <span class="title">Aufgaben</span>
                            </div>
                            <button class="cd-sec-action" onclick="openQuickAdd('aufgabe', {company_id: '{{ company.id }}'})">+ Neu</button>
                        </div>
                        <div id="todos-container" hx-get="/partials/company/{{ company.id }}/todos" hx-trigger="load, refreshTodos from:body" hx-swap="innerHTML">
                            <p class="cd-load">Lade Aufgaben...</p>
                        </div>
                    </div>
                </div>

                {# Trennlinie #}
                <div style="border-top:1px solid var(--pp-border); margin:4px 0;"></div>

                {# ‚îÄ‚îÄ ROW 2: Anruf-Protokoll + Letzte Aktivit√§ten ‚îÄ‚îÄ #}
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">

                    {# Anruf-Protokoll #}
                    <div class="cd-anim cd-overview-card" style="animation-delay:300ms;">
                        <div class="cd-sec-hdr">
                            <div class="cd-sec-hdr-left">
                                <span class="icon">üìû</span>
                                <span class="title">Anruf-Protokoll</span>
                                <span class="count">{{ call_count if call_count is defined else '0' }}</span>
                            </div>
                            <button class="cd-sec-action" @click="showCallModal = true">+ Anruf</button>
                        </div>
                        <div id="call-log-container" hx-get="/partials/company/{{ company.id }}/call-log" hx-trigger="load, refreshCallLog from:body" hx-swap="innerHTML">
                            <p class="cd-load">Lade Anrufe...</p>
                        </div>
                    </div>

                    {# Letzte Aktivit√§ten #}
                    <div class="cd-anim cd-overview-card" style="animation-delay:400ms;">
                        <div class="cd-sec-hdr">
                            <div class="cd-sec-hdr-left">
                                <span class="icon">üìà</span>
                                <span class="title">Letzte Aktivit√§ten</span>
                            </div>
                            <button class="cd-sec-action" @click="tab='activities'">Alle ‚Üí</button>
                        </div>
                        <div id="activities-container" hx-get="/partials/company/{{ company.id }}/activities" hx-trigger="load" hx-swap="innerHTML">
                            <p class="cd-load">Lade Aktivit√§ten...</p>
                        </div>
                    </div>
                </div>
            </div>

            {# ‚îÄ‚îÄ Tab: Kontakte ‚îÄ‚îÄ #}
            <div x-show="tab==='contacts'" x-cloak style="padding-top:16px;">
                <div class="cd-tab-sec">
                    <div class="cd-tab-sec-h">
                        <span class="cd-tab-sec-t"><span class="icon">üë§</span> Alle Kontakte</span>
                        <button class="cd-btn cd-btn-accent" onclick="toggleContactForm()">+ Hinzuf√ºgen</button>
                    </div>
                    <div class="cd-tab-sec-b">
                        <div hx-get="/partials/company-contacts/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML">
                            <p class="cd-load">Lade Kontakte...</p>
                        </div>
                    </div>
                </div>
            </div>

            {# ‚îÄ‚îÄ Tab: Aktivit√§ten ‚îÄ‚îÄ #}
            <div x-show="tab==='activities'" x-cloak style="padding-top:16px;">
                <div class="cd-tab-sec">
                    <div class="cd-tab-sec-h">
                        <span class="cd-tab-sec-t"><span class="icon">üìä</span> Alle Aktivit√§ten</span>
                        <span class="cd-tab-sec-sub">Chronologisch ‚Äî neueste zuerst</span>
                    </div>
                    <div class="cd-tab-sec-b">
                        <div hx-get="/partials/company/{{ company.id }}/activities" hx-trigger="load" hx-swap="innerHTML">
                            <p class="cd-load">Lade Aktivit√§ten...</p>
                        </div>
                    </div>
                </div>
            </div>

            {# ‚îÄ‚îÄ Tab: E-Mails ‚îÄ‚îÄ #}
            <div x-show="tab==='emails'" x-cloak style="padding-top:16px;">
                <div class="cd-tab-sec">
                    <div class="cd-tab-sec-h">
                        <span class="cd-tab-sec-t"><span class="icon">‚úâÔ∏è</span> Alle E-Mails</span>
                        <button class="cd-btn cd-btn-accent" onclick="toggleCorrForm()">+ Neue E-Mail</button>
                    </div>
                    <div class="cd-tab-sec-b">
                        <div id="correspondence-container" hx-get="/partials/company-correspondence/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML">
                            <p class="cd-load">Lade E-Mails...</p>
                        </div>
                        <div id="corr-form" style="display:none" class="cd-iform">
                            <div style="display:flex; flex-direction:column; gap:12px;">
                                <div style="display:flex; gap:12px;">
                                    <select id="corr-direction" class="cd-sel"><option value="outbound">Ausgehend</option><option value="inbound">Eingehend</option></select>
                                    <select id="corr-contact" class="cd-sel" style="flex:1;">
                                        <option value="">‚Äî Kontakt zuordnen ‚Äî</option>
                                        {% for c in contacts %}
                                        <option value="{{ c.id }}">{{ c.first_name }} {{ c.last_name }}{% if c.email %} ({{ c.email }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <input type="text" id="corr-subject" placeholder="Betreff" class="cd-inp">
                                <textarea id="corr-body" placeholder="Inhalt / Notizen" rows="3" class="cd-ta"></textarea>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:14px;">
                                <button onclick="saveCorrespondence()" class="cd-btn cd-btn-primary">Speichern</button>
                                <button onclick="toggleCorrForm()" class="cd-btn">Abbrechen</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ‚îÄ‚îÄ Tab: Notizen ‚îÄ‚îÄ #}
            <div x-show="tab==='notes'" x-cloak style="padding-top:16px;">
                <div class="cd-tab-sec">
                    <div class="cd-tab-sec-h">
                        <span class="cd-tab-sec-t"><span class="icon">üìù</span> Alle Notizen</span>
                        <button class="cd-btn cd-btn-accent" onclick="toggleNoteForm()">+ Neue Notiz</button>
                    </div>
                    <div class="cd-tab-sec-b">
                        <div id="notes-container" hx-get="/partials/company/{{ company.id }}/notes" hx-trigger="load" hx-swap="innerHTML">
                            <p class="cd-load">Lade Notizen...</p>
                        </div>
                        <div id="note-form" style="display:none" class="cd-iform">
                            <div style="display:flex; flex-direction:column; gap:12px;">
                                <input type="text" id="note-title" placeholder="Titel (optional)" class="cd-inp">
                                <textarea id="note-content" placeholder="Notiz schreiben..." rows="4" class="cd-ta"></textarea>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:14px;">
                                <button onclick="saveCompanyNote()" class="cd-btn cd-btn-primary">Speichern</button>
                                <button onclick="toggleNoteForm()" class="cd-btn">Abbrechen</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ‚îÄ‚îÄ Tab: Dokumente ‚îÄ‚îÄ #}
            <div x-show="tab==='documents'" x-cloak style="padding-top:16px;">
                <div class="cd-tab-sec">
                    <div class="cd-tab-sec-h">
                        <span class="cd-tab-sec-t"><span class="icon">üìÅ</span> Alle Dokumente</span>
                        <button class="cd-btn cd-btn-accent" onclick="toggleDocForm()">‚¨Ü Hochladen</button>
                    </div>
                    <div class="cd-tab-sec-b">
                        <div id="documents-container" hx-get="/partials/company/{{ company.id }}/documents" hx-trigger="load" hx-swap="innerHTML">
                            <p class="cd-load">Lade Dokumente...</p>
                        </div>
                        <div id="doc-upload-form" style="display:none" class="cd-iform">
                            <div class="cd-dz" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFileDrop(event)" onclick="document.getElementById('doc-file-input').click()">
                                <div style="font-size:32px; margin-bottom:8px;">üìÑ</div>
                                <div style="font-size:14px; font-weight:600; color:var(--pp-textMuted);">Datei hierher ziehen oder klicken</div>
                                <div style="font-size:13px; color:var(--pp-textDim); margin-top:5px;">PDF, Word, Bilder, etc.</div>
                            </div>
                            <input type="file" id="doc-file-input" onchange="handleFileSelect(this)" style="display:none;">
                            <div id="doc-file-name" class="hidden" style="margin-top:12px; font-size:14px; font-weight:600; color:var(--pp-accent); padding:10px 14px; background:var(--pp-accentSoft); border-radius:10px;"></div>
                            <input type="text" id="doc-notes" placeholder="Notizen zum Dokument (optional)" class="cd-inp" style="margin-top:12px;">
                            <div style="display:flex; gap:10px; margin-top:14px;">
                                <button id="doc-upload-btn" onclick="uploadDocument()" disabled class="cd-btn cd-btn-primary" style="opacity:0.5;">Hochladen</button>
                                <button onclick="toggleDocForm()" class="cd-btn">Abbrechen</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        {# ‚ïê‚ïê‚ïê RIGHT SIDEBAR ‚ïê‚ïê‚ïê #}
        <div class="cd-sidebar">

            {# ATS-Stellen #}
            <div class="cd-side-sec cd-anim" style="animation-delay:150ms;">
                <div class="cd-side-hdr">
                    <div class="cd-side-hdr-left">
                        <span class="icon">üéØ</span>
                        <span class="title">ATS-Stellen</span>
                        <span class="cnt" style="color:var(--pp-orange); background:var(--pp-orangeSoft);">{{ ats_job_count }}</span>
                    </div>
                    <a href="/ats/stellen" class="cd-side-link">Alle ‚Üí</a>
                </div>
                <div id="sidebar-ats-jobs" hx-get="/partials/company-ats-jobs/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML">
                    <p class="cd-load">Lade ATS-Stellen...</p>
                </div>
            </div>

            {# Jobs #}
            <div class="cd-side-sec cd-anim" style="animation-delay:200ms;">
                <div class="cd-side-hdr">
                    <div class="cd-side-hdr-left">
                        <span class="icon">üíº</span>
                        <span class="title">Jobs</span>
                        <span class="cnt" style="color:var(--pp-textDim); background:var(--pp-surfaceHover);">{{ job_count }}</span>
                    </div>
                </div>
                <div id="sidebar-jobs" hx-get="/partials/company-jobs/{{ company.id }}" hx-trigger="load" hx-swap="innerHTML">
                    <p class="cd-load">Lade Jobs...</p>
                </div>
            </div>

            {# Trennlinie #}
            <div style="height:1px; background:var(--pp-border); margin:8px 0 28px;"></div>

            {# Anruf-Statistik #}
            <div class="cd-side-sec cd-anim" style="animation-delay:250ms;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
                    <span style="font-size:18px;">üìä</span>
                    <span style="font-size:16px; font-weight:650; color:var(--pp-text);">Anruf-Statistik</span>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="cd-stat-box">
                        <div class="cd-stat-val" style="color:var(--pp-accent);">{{ call_count if call_count is defined else '0' }}</div>
                        <div class="cd-stat-label">Gesamt</div>
                    </div>
                    <div class="cd-stat-box">
                        <div class="cd-stat-val" style="color:var(--pp-green);">{{ call_total_duration if call_total_duration is defined else '0' }}m</div>
                        <div class="cd-stat-label">Gesamtdauer</div>
                    </div>
                </div>
            </div>

            {# Spacer #}
            <div style="flex:1;"></div>

            {# Dates Footer #}
            <div class="cd-date-footer">
                <span>Erstellt {{ company.created_at.strftime('%d.%m.%y') if company.created_at else '‚Äî' }}</span>
                <span>¬∑</span>
                <span>Akt. {{ company.updated_at.strftime('%d.%m.%y') if company.updated_at else '‚Äî' }}</span>
            </div>
        </div>
    </div>

    {# ‚ïê‚ïê‚ïê CALL MODAL ‚ïê‚ïê‚ïê #}
    <template x-if="showCallModal">
        <div class="cd-modal-overlay" @click.self="showCallModal = false">
            <div class="cd-modal" @click.stop>
                <div class="cd-modal-hdr">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="cd-modal-icon">üìû</div>
                        <span class="cd-modal-title">Anruf protokollieren</span>
                    </div>
                    <button class="cd-modal-close" @click="showCallModal = false">√ó</button>
                </div>

                <div style="display:flex; flex-direction:column; gap:24px;">
                    {# Kontakt #}
                    <div>
                        <label class="cd-modal-label">Kontakt</label>
                        <select id="call-contact" class="cd-sel" style="width:100%;">
                            <option value="">Kontakt w√§hlen...</option>
                            {% if contacts is defined %}
                            {% for c in contacts %}
                            <option value="{{ c.id }}">{{ c.first_name }} {{ c.last_name }}{% if c.position %} ‚Äì {{ c.position }}{% endif %}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    {# Richtung + Dauer #}
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div>
                            <label class="cd-modal-label">Richtung</label>
                            <div style="display:flex; gap:10px;">
                                <button class="cd-modal-dir-btn"
                                    :style="callDir === 'outbound' ? 'background:var(--pp-accentSoft); color:var(--pp-accent); border:1px solid rgba(79,140,255,0.27);' : 'background:transparent; color:var(--pp-textMuted); border:1px solid var(--pp-border);'"
                                    @click="callDir = 'outbound'">üì§ Ausgehend</button>
                                <button class="cd-modal-dir-btn"
                                    :style="callDir === 'inbound' ? 'background:var(--pp-greenSoft); color:var(--pp-green); border:1px solid rgba(52,211,153,0.27);' : 'background:transparent; color:var(--pp-textMuted); border:1px solid var(--pp-border);'"
                                    @click="callDir = 'inbound'">üì• Eingehend</button>
                            </div>
                        </div>
                        <div>
                            <label class="cd-modal-label">Dauer</label>
                            <input id="call-duration" class="cd-inp" placeholder="z.B. 15">
                        </div>
                    </div>

                    {# Datum + Uhrzeit #}
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div>
                            <label class="cd-modal-label">Datum</label>
                            <input id="call-date" type="date" class="cd-inp">
                        </div>
                        <div>
                            <label class="cd-modal-label">Uhrzeit</label>
                            <input id="call-time" type="time" class="cd-inp">
                        </div>
                    </div>

                    {# Notizen #}
                    <div>
                        <label class="cd-modal-label">Notizen</label>
                        <textarea id="call-notes" class="cd-ta" rows="3" placeholder="Gespr√§chsnotizen..."></textarea>
                    </div>

                    {# Submit #}
                    <button class="cd-modal-submit" onclick="saveCall()">Anruf speichern</button>
                </div>
            </div>
        </div>
    </template>
</div>
{% endblock %}

{% block scripts %}
<script>
const COMPANY_ID = '{{ company.id }}';

function copyToClipboard(text) {
    navigator.clipboard.writeText(text.trim()).then(() => { showToast('Kopiert!', 'success'); });
}

function setStatus(status) {
    fetch(`/api/companies/${COMPANY_ID}/status?status=${status}`, { method: 'PUT' })
        .then(r => r.json())
        .then(() => { showToast('Status ge√§ndert', 'success'); setTimeout(() => location.reload(), 500); })
        .catch(() => showToast('Fehler', 'error'));
}

function toggleContactForm() {
    const f = document.getElementById('contact-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveContact() {
    const data = {
        first_name: document.getElementById('cf-first-name').value || null,
        last_name: document.getElementById('cf-last-name').value || null,
        position: document.getElementById('cf-position').value || null,
        phone: document.getElementById('cf-phone').value || null,
        email: document.getElementById('cf-email').value || null
    };
    fetch(`/api/companies/${COMPANY_ID}/contacts`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(r => r.json())
        .then(() => {
            showToast('Kontakt erstellt', 'success');
            toggleContactForm();
            ['cf-first-name','cf-last-name','cf-position','cf-phone','cf-email'].forEach(id => document.getElementById(id).value = '');
            htmx.trigger('#contacts-container', 'load');
        })
        .catch(() => showToast('Fehler', 'error'));
}

function deleteContact(contactId) {
    if (!confirm('Kontakt l√∂schen?')) return;
    fetch(`/api/companies/contacts/${contactId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Kontakt gel√∂scht', 'success'); htmx.trigger('#contacts-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

function toggleCorrForm() {
    const f = document.getElementById('corr-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveCorrespondence() {
    const contactVal = document.getElementById('corr-contact').value;
    const data = {
        direction: document.getElementById('corr-direction').value,
        contact_id: contactVal || null,
        subject: document.getElementById('corr-subject').value,
        body: document.getElementById('corr-body').value || null
    };
    if (!data.subject) { showToast('Betreff erforderlich', 'error'); return; }
    fetch(`/api/companies/${COMPANY_ID}/correspondence`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(r => r.json())
        .then(() => {
            showToast('E-Mail protokolliert', 'success');
            toggleCorrForm();
            document.getElementById('corr-subject').value = '';
            document.getElementById('corr-body').value = '';
            document.getElementById('corr-contact').value = '';
            htmx.trigger('#correspondence-container', 'load');
        })
        .catch(() => showToast('Fehler', 'error'));
}

function deleteCorrespondence(corrId) {
    if (!confirm('Korrespondenz l√∂schen?')) return;
    fetch(`/api/companies/correspondence/${corrId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Gel√∂scht', 'success'); htmx.trigger('#correspondence-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

function deleteCompanyCallNote(noteId) {
    if (!confirm('Anrufprotokoll l√∂schen?')) return;
    fetch(`/api/ats/call-notes/${noteId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => {
            showToast('Gel√∂scht', 'success');
            htmx.trigger('#call-notes-container', 'load');
            document.body.dispatchEvent(new CustomEvent('refreshCallLog'));
        })
        .catch(() => showToast('Fehler', 'error'));
}

function deleteCompanyTodo(todoId) {
    if (!confirm('Aufgabe l√∂schen?')) return;
    fetch(`/api/ats/todos/${todoId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Gel√∂scht', 'success'); document.body.dispatchEvent(new CustomEvent('refreshTodos')); })
        .catch(() => showToast('Fehler', 'error'));
}

function saveCall() {
    const contactId = document.getElementById('call-contact').value;
    const duration = document.getElementById('call-duration').value;
    const date = document.getElementById('call-date').value;
    const time = document.getElementById('call-time').value;
    const notes = document.getElementById('call-notes').value;

    // Alpine v3: use Alpine.$data() on the specific cd-page element
    const pageEl = document.getElementById('cd-page');
    const alpineData = Alpine.$data(pageEl);
    const dir = alpineData.callDir;

    let calledAt = null;
    if (date) {
        calledAt = time ? `${date}T${time}:00` : `${date}T00:00:00`;
    }

    const data = {
        company_id: COMPANY_ID,
        contact_id: contactId || null,
        summary: notes || null,
        raw_notes: notes || null,
        duration_minutes: duration ? parseInt(duration) : null,
        called_at: calledAt,
        direction: dir || 'outbound',
        call_type: 'acquisition'
    };

    fetch('/api/ats/calls', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(r => { if (!r.ok) throw new Error('Failed'); return r.json(); })
        .then(() => {
            showToast('Anruf gespeichert', 'success');
            // Alpine v3: close modal via specific cd-page element
            Alpine.$data(document.getElementById('cd-page')).showCallModal = false;
            // Reset form
            document.getElementById('call-contact').value = '';
            document.getElementById('call-duration').value = '';
            document.getElementById('call-date').value = '';
            document.getElementById('call-time').value = '';
            document.getElementById('call-notes').value = '';
            // Refresh call log
            document.body.dispatchEvent(new CustomEvent('refreshCallLog'));
            // Refresh call notes container if exists
            const cn = document.getElementById('call-notes-container');
            if (cn) htmx.trigger(cn, 'load');
        })
        .catch(() => showToast('Fehler beim Speichern', 'error'));
}

var selectedDocFile = null;
function toggleDocForm() {
    const f = document.getElementById('doc-upload-form');
    if (f) f.style.display = f.style.display === 'none' ? 'block' : 'none';
}
function handleFileDrop(event) { const files = event.dataTransfer.files; if (files.length > 0) setDocFile(files[0]); }
function handleFileSelect(input) { if (input.files.length > 0) setDocFile(input.files[0]); }
function setDocFile(file) {
    selectedDocFile = file;
    const n = document.getElementById('doc-file-name');
    if (n) { n.textContent = file.name + ' (' + (file.size/1024).toFixed(1) + ' KB)'; n.classList.remove('hidden'); }
    const b = document.getElementById('doc-upload-btn');
    if (b) { b.disabled = false; b.style.opacity = '1'; }
}
function uploadDocument() {
    if (!selectedDocFile) return;
    const fd = new FormData(); fd.append('file', selectedDocFile);
    const notes = document.getElementById('doc-notes'); if (notes && notes.value) fd.append('notes', notes.value);
    const btn = document.getElementById('doc-upload-btn'); if (btn) { btn.disabled = true; btn.textContent = 'Hochladen...'; }
    fetch(`/api/companies/${COMPANY_ID}/documents`, { method: 'POST', body: fd })
        .then(r => r.json())
        .then(() => {
            showToast('Dokument hochgeladen', 'success');
            toggleDocForm(); selectedDocFile = null;
            if (notes) notes.value = '';
            const n = document.getElementById('doc-file-name'); if (n) n.classList.add('hidden');
            if (btn) { btn.disabled = true; btn.textContent = 'Hochladen'; btn.style.opacity = '0.5'; }
            htmx.trigger('#documents-container', 'load');
        })
        .catch(() => { showToast('Upload fehlgeschlagen', 'error'); if (btn) { btn.disabled = false; btn.textContent = 'Hochladen'; btn.style.opacity = '1'; } });
}
function deleteDocument(docId) {
    if (!confirm('Dokument l√∂schen?')) return;
    fetch(`/api/companies/documents/${docId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Gel√∂scht', 'success'); htmx.trigger('#documents-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

function toggleNoteForm() {
    const f = document.getElementById('note-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveCompanyNote() {
    const content = document.getElementById('note-content').value;
    if (!content.trim()) { showToast('Notiz darf nicht leer sein', 'error'); return; }
    const data = { content: content, title: document.getElementById('note-title').value || null };
    fetch(`/api/companies/${COMPANY_ID}/notes`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(r => r.json())
        .then(() => {
            showToast('Notiz erstellt', 'success');
            toggleNoteForm();
            document.getElementById('note-content').value = '';
            document.getElementById('note-title').value = '';
            htmx.trigger('#notes-container', 'load');
        })
        .catch(() => showToast('Fehler', 'error'));
}

function deleteCompanyNote(noteId) {
    if (!confirm('Notiz l√∂schen?')) return;
    fetch(`/api/companies/notes/${noteId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Gel√∂scht', 'success'); htmx.trigger('#notes-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

// Date/time auto-fill is handled by x-effect on #cd-page
</script>
{% endblock %}
