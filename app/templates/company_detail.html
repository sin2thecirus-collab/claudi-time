{% extends "base.html" %}

{% block title %}{{ company.name }} - Pulspoint{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    .kd-wrap, .kd-wrap * { font-family: 'Outfit', 'DM Sans', -apple-system, sans-serif; }
    .kd-wrap { background: #f4f5f8; color: #1e293b; font-size: 15px; }

    .kd-wrap ::-webkit-scrollbar { width: 5px; }
    .kd-wrap ::-webkit-scrollbar-track { background: transparent; }
    .kd-wrap ::-webkit-scrollbar-thumb { background: #d4d9e3; border-radius: 3px; }

    @keyframes kdFadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes kdSlideIn {
        from { opacity: 0; transform: translateX(12px); }
        to   { opacity: 1; transform: translateX(0); }
    }
    .kd-anim { opacity: 0; animation: kdFadeUp 0.5s cubic-bezier(0.4,0,0.2,1) forwards; }
    .kd-anim-side { opacity: 0; animation: kdSlideIn 0.5s cubic-bezier(0.4,0,0.2,1) forwards; }

    .kd-section {
        background: #fff; border-radius: 16px; border: 1px solid #e6e9ef; overflow: hidden;
    }
    .kd-section-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 18px 26px; border-bottom: 1px solid #f0f2f5;
        background: linear-gradient(135deg, #fafbfd 0%, #f7f8fb 100%);
    }
    .kd-section-title {
        display: flex; align-items: center; gap: 12px;
        font-size: 17px; font-weight: 750; color: #0f172a; letter-spacing: -0.02em;
    }
    .kd-section-body { padding: 22px 26px; }

    .kd-sidebar-card {
        background: #fff; border-radius: 14px; border: 1px solid #e6e9ef; overflow: hidden;
    }
    .kd-sidebar-header {
        padding: 16px 22px; border-bottom: 1px solid #f0f2f5;
        display: flex; align-items: center; justify-content: space-between;
        background: linear-gradient(135deg, #fafbfd, #f7f8fb);
        font-size: 15px; font-weight: 700; color: #334155;
    }
    .kd-sidebar-body { padding: 18px 22px; }

    .kd-quickbtn {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 11px 20px; border-radius: 10px;
        font-size: 14px; font-weight: 630; cursor: pointer;
        font-family: inherit; transition: all 0.2s; border: 1.5px solid #e2e5ec;
        background: #fff; color: #475569;
    }
    .kd-quickbtn:hover { background: #f8fafc; }
    .kd-quickbtn-primary {
        background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; border: none;
        box-shadow: 0 2px 8px rgba(99,102,241,0.25);
    }
    .kd-quickbtn-primary:hover { background: linear-gradient(135deg, #4f46e5, #7c3aed); }
    .kd-quickbtn-accent {
        background: #fff; color: #4f46e5; border: 1.5px solid #c7d2fe;
    }
    .kd-quickbtn-accent:hover { background: #eef2ff; }
    .kd-quickbtn-danger {
        background: #fff; color: #dc2626; border: 1.5px solid #fecaca;
    }
    .kd-quickbtn-danger:hover { background: #fef2f2; }

    .kd-copy-btn {
        background: #f4f6f8; border: none; border-radius: 7px; padding: 5px 10px;
        font-size: 13px; cursor: pointer; color: #94a3b8; font-weight: 600;
        transition: all 0.2s; font-family: inherit;
    }
    .kd-copy-btn:hover { background: #e8ecf1; color: #64748b; }

    /* Form inputs inside kd-wrap */
    .kd-input {
        width: 100%; padding: 10px 14px; border: 1.5px solid #e2e5ec; border-radius: 10px;
        font-size: 14px; font-family: inherit; color: #1e293b; background: #fff;
        transition: border-color 0.2s, box-shadow 0.2s; outline: none;
    }
    .kd-input:focus {
        border-color: #818cf8; box-shadow: 0 0 0 3px rgba(129,140,248,0.12);
    }
    .kd-input::placeholder { color: #94a3b8; }

    .kd-select {
        padding: 10px 14px; border: 1.5px solid #e2e5ec; border-radius: 10px;
        font-size: 14px; font-family: inherit; color: #1e293b; background: #fff;
        transition: border-color 0.2s; outline: none; cursor: pointer;
    }
    .kd-select:focus { border-color: #818cf8; box-shadow: 0 0 0 3px rgba(129,140,248,0.12); }

    .kd-textarea {
        width: 100%; padding: 12px 14px; border: 1.5px solid #e2e5ec; border-radius: 10px;
        font-size: 14px; font-family: inherit; color: #1e293b; background: #fff;
        transition: border-color 0.2s; outline: none; resize: vertical;
    }
    .kd-textarea:focus {
        border-color: #818cf8; box-shadow: 0 0 0 3px rgba(129,140,248,0.12);
    }
    .kd-textarea::placeholder { color: #94a3b8; }

    /* Inline form styling */
    .kd-inline-form {
        margin-top: 16px; padding: 20px; background: #fafbfd; border-radius: 12px;
        border: 1.5px solid #e6e9ef;
    }

    /* Status dropdown */
    .kd-status-menu {
        position: absolute; right: 0; top: 100%; margin-top: 6px; width: 220px;
        background: #fff; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        border: 1px solid #e6e9ef; padding: 6px; z-index: 50;
    }
    .kd-status-item {
        width: 100%; text-align: left; padding: 10px 14px; border-radius: 8px;
        font-size: 14px; font-family: inherit; cursor: pointer;
        display: flex; align-items: center; gap: 10px; border: none;
        background: transparent; color: #334155; transition: background 0.15s;
    }
    .kd-status-item:hover { background: #f8fafc; }
    .kd-status-item--danger { color: #dc2626; }
    .kd-status-item--danger:hover { background: #fef2f2; }

    /* Loading skeleton */
    .kd-skeleton {
        font-size: 14px; color: #94a3b8; padding: 12px 0;
    }
    @keyframes kdPulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }
    .kd-skeleton { animation: kdPulse 1.5s ease-in-out infinite; }

    /* Drop zone for documents */
    .kd-dropzone {
        border: 2px dashed #d4d9e3; border-radius: 12px; padding: 24px; text-align: center;
        cursor: pointer; transition: all 0.2s; background: #fafbfd;
    }
    .kd-dropzone:hover, .kd-dropzone.dragover {
        border-color: #818cf8; background: #eef2ff;
    }
</style>
{% endblock %}

{% block content %}
{# ── Data helpers ── #}
{% set invalid_vals = ['not available', 'n/a', 'na', 'none', 'null', '-', '—', ''] %}
{% macro is_valid(val) %}{{ val and val|string|lower|trim not in invalid_vals }}{% endmacro %}

<div class="kd-wrap min-h-screen" x-data="{ editing: false }">

    {# ════════════════════════════════════════════════════
       VIOLET HERO HEADER
    ════════════════════════════════════════════════════ #}
    <div style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 40%, #4338ca 100%); padding: 28px 40px 0; position: relative; overflow: hidden;">
        {# Decorative circles #}
        <div style="position: absolute; top: -60px; right: -60px; width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, rgba(129,140,248,0.15) 0%, transparent 70%);"></div>
        <div style="position: absolute; bottom: -40px; left: 20%; width: 160px; height: 160px; border-radius: 50%; background: radial-gradient(circle, rgba(167,139,250,0.08) 0%, transparent 70%);"></div>

        {# Breadcrumb #}
        <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 20px; font-weight: 500;">
            <a href="/" style="cursor: pointer; color: rgba(255,255,255,0.6); text-decoration: none;">&#x1F3E0;</a>
            <span>&#x203A;</span>
            <a href="/unternehmen" style="cursor: pointer; color: rgba(255,255,255,0.6); text-decoration: none;">Unternehmen</a>
            <span>&#x203A;</span>
            <span style="color: rgba(255,255,255,0.85);">{{ company.name }}</span>
        </div>

        {# Avatar + Name + Meta + Action #}
        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 22px;">
            {# Company initials avatar #}
            <div style="width: 68px; height: 68px; border-radius: 18px; background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px; font-weight: 800; border: 3px solid rgba(255,255,255,0.2); box-shadow: 0 4px 20px rgba(0,0,0,0.2); flex-shrink: 0;">
                {% set name_parts = company.name.split() %}
                {% if name_parts | length >= 2 %}
                    {{ name_parts[0][0] | upper }}{{ name_parts[1][0] | upper }}
                {% else %}
                    {{ company.name[0:2] | upper }}
                {% endif %}
            </div>

            <div style="flex: 1; min-width: 0;">
                {# Company name #}
                <div style="font-size: 26px; font-weight: 800; color: #fff; letter-spacing: -0.03em;">
                    {{ company.name }}
                </div>

                {# Meta badges #}
                <div style="display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap;">
                    {% if company.city and company.city|string|lower|trim not in invalid_vals %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4CD;</span>
                        {{ company.city }}
                    </span>
                    {% endif %}

                    {# Status badge #}
                    {% if company.status.value == 'active' %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; font-weight: 600; padding: 4px 10px; border-radius: 8px; background: rgba(16,185,129,0.15); color: #6ee7b7;">
                        <span style="width: 6px; height: 6px; border-radius: 50%; background: #34d399;"></span>
                        Aktiv
                    </span>
                    {% elif company.status.value == 'blacklist' %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; font-weight: 600; padding: 4px 10px; border-radius: 8px; background: rgba(239,68,68,0.15); color: #fca5a5;">
                        <span style="width: 6px; height: 6px; border-radius: 50%; background: #f87171;"></span>
                        Blacklist
                    </span>
                    {% else %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; font-weight: 600; padding: 4px 10px; border-radius: 8px; background: rgba(245,158,11,0.15); color: #fcd34d;">
                        <span style="width: 6px; height: 6px; border-radius: 50%; background: #fbbf24;"></span>
                        Laufende Prozesse
                    </span>
                    {% endif %}

                    {# Jobs count badge #}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4BC;</span>
                        {{ job_count }} Job{{ 's' if job_count != 1 else '' }}
                    </span>

                    {# Employee count badge #}
                    {% if company.employee_count and company.employee_count|string|lower|trim not in invalid_vals %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F465;</span>
                        {{ company.employee_count }} Mitarbeiter
                    </span>
                    {% endif %}
                </div>
            </div>

            {# Status change button #}
            <div style="flex-shrink: 0; margin-top: 6px;" x-data="{ statusOpen: false }">
                <div style="position: relative;">
                    <button @click="statusOpen = !statusOpen" class="kd-quickbtn" style="background: rgba(255,255,255,0.1); border: 1.5px solid rgba(255,255,255,0.2); color: #fff;">
                        <svg style="width: 15px; height: 15px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                        </svg>
                        Status ändern
                    </button>
                    <div x-show="statusOpen" @click.away="statusOpen = false" x-transition class="kd-status-menu" style="display: none;">
                        <button onclick="setStatus('active')" class="kd-status-item">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e;"></span> Aktiv
                        </button>
                        <button onclick="setStatus('laufende_prozesse')" class="kd-status-item">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></span> Laufende Prozesse
                        </button>
                        <button onclick="setStatus('blacklist')" class="kd-status-item kd-status-item--danger">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span> Blacklist
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {# Bottom spacer for visual padding #}
        <div style="height: 18px;"></div>
    </div>

    {# ════════════════════════════════════════════════════
       CONTENT: 2-Column Grid
    ════════════════════════════════════════════════════ #}
    <div style="display: grid; grid-template-columns: 1fr 340px; gap: 24px; padding: 28px 40px 40px; align-items: start;">

        {# ======== LEFT COLUMN (Main Content) ======== #}
        <div style="display: flex; flex-direction: column; gap: 24px;">

            {# ── Stammdaten Card ── #}
            {% set addr_valid = company.address and company.address|string|lower|trim not in invalid_vals %}
            {% set city_valid = company.city and company.city|string|lower|trim not in invalid_vals %}
            {% set domain_valid = company.domain and company.domain|string|lower|trim not in invalid_vals %}
            {% set phone_valid = company.phone and company.phone|string|lower|trim not in invalid_vals %}
            {% set size_valid = company.employee_count and company.employee_count|string|lower|trim not in invalid_vals %}
            {% set has_any_stamm = addr_valid or city_valid or domain_valid or phone_valid or size_valid %}

            {% if has_any_stamm %}
            <div class="kd-section kd-anim" style="animation-delay: 0.05s;">
                <div class="kd-section-header">
                    <div class="kd-section-title">
                        <svg style="width: 20px; height: 20px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5M3.75 3v18h16.5V3H3.75zm3 3.75h3v3h-3v-3zm6 0h3v3h-3v-3zm-6 6h3v3h-3v-3zm6 0h3v3h-3v-3z" />
                        </svg>
                        Stammdaten
                    </div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px 32px;">
                        {% if addr_valid %}
                        <div>
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #94a3b8; margin-bottom: 6px;">Adresse</div>
                            <div style="display: flex; align-items: flex-start; gap: 8px;">
                                <span style="font-size: 14px; color: #1e293b; font-weight: 500; white-space: pre-line;">{{ company.address }}</span>
                                <button onclick="copyToClipboard('{{ company.address|replace('\n', ' ')|replace("'", "\\'") }}')" class="kd-copy-btn" title="Kopieren" style="flex-shrink: 0; margin-top: 1px;">
                                    <svg style="width: 13px; height: 13px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        {% if city_valid %}
                        <div>
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #94a3b8; margin-bottom: 6px;">Stadt</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 14px; color: #1e293b; font-weight: 500;">{{ company.city }}</span>
                                <button onclick="copyToClipboard('{{ company.city }}')" class="kd-copy-btn" title="Kopieren">
                                    <svg style="width: 13px; height: 13px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        {% if domain_valid %}
                        <div>
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #94a3b8; margin-bottom: 6px;">Website</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <a href="{% if 'http' in company.domain %}{{ company.domain }}{% else %}https://{{ company.domain }}{% endif %}" target="_blank" style="font-size: 14px; color: #6366f1; font-weight: 500; text-decoration: none;">{{ company.domain }}</a>
                                <button onclick="copyToClipboard('{{ company.domain }}')" class="kd-copy-btn" title="Kopieren">
                                    <svg style="width: 13px; height: 13px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        {% if phone_valid %}
                        <div>
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #94a3b8; margin-bottom: 6px;">Telefon Zentrale</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <a href="tel:{{ company.phone }}" style="font-size: 14px; color: #1e293b; font-weight: 500; text-decoration: none;">{{ company.phone }}</a>
                                <button onclick="copyToClipboard('{{ company.phone }}')" class="kd-copy-btn" title="Kopieren">
                                    <svg style="width: 13px; height: 13px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        {% if size_valid %}
                        <div>
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #94a3b8; margin-bottom: 6px;">Unternehmensgröße</div>
                            <span style="font-size: 14px; color: #1e293b; font-weight: 500;">{{ company.employee_count }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {# ── Ansprechpartner Card ── #}
            <div class="kd-section kd-anim" style="animation-delay: 0.1s;">
                <div class="kd-section-header">
                    <div class="kd-section-title">
                        <svg style="width: 20px; height: 20px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                        </svg>
                        Ansprechpartner
                    </div>
                    <button onclick="toggleContactForm()" class="kd-quickbtn-accent" style="display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 8px; font-size: 13px; font-weight: 630; cursor: pointer; font-family: inherit; border: 1.5px solid #c7d2fe; background: #fff; color: #4f46e5; transition: all 0.2s;">
                        <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Hinzufügen
                    </button>
                </div>
                <div class="kd-section-body">
                    <div id="contacts-container"
                         hx-get="/partials/company-contacts/{{ company.id }}"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="kd-skeleton">Lade Kontakte...</p>
                    </div>
                    {# Inline Add-Form (hidden) #}
                    <div id="contact-form" style="display:none" class="kd-inline-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <input type="text" id="cf-first-name" placeholder="Vorname" class="kd-input">
                            <input type="text" id="cf-last-name" placeholder="Nachname" class="kd-input">
                            <input type="text" id="cf-position" placeholder="Position" class="kd-input">
                            <input type="text" id="cf-phone" placeholder="Telefon" class="kd-input">
                            <input type="email" id="cf-email" placeholder="E-Mail" class="kd-input" style="grid-column: span 2;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 14px;">
                            <button onclick="saveContact()" class="kd-quickbtn kd-quickbtn-primary" style="padding: 9px 18px; font-size: 13px;">Speichern</button>
                            <button onclick="toggleContactForm()" class="kd-quickbtn" style="padding: 9px 18px; font-size: 13px;">Abbrechen</button>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Korrespondenz Card ── #}
            <div class="kd-section kd-anim" style="animation-delay: 0.15s;">
                <div class="kd-section-header">
                    <div class="kd-section-title">
                        <svg style="width: 20px; height: 20px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                        </svg>
                        E-Mail-Korrespondenz
                    </div>
                    <button onclick="toggleCorrForm()" class="kd-quickbtn-accent" style="display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 8px; font-size: 13px; font-weight: 630; cursor: pointer; font-family: inherit; border: 1.5px solid #c7d2fe; background: #fff; color: #4f46e5; transition: all 0.2s;">
                        <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Neue Korrespondenz
                    </button>
                </div>
                <div class="kd-section-body">
                    <div id="correspondence-container"
                         hx-get="/partials/company-correspondence/{{ company.id }}"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="kd-skeleton">Lade Korrespondenz...</p>
                    </div>
                    {# Inline Add-Form (hidden) #}
                    <div id="corr-form" style="display:none" class="kd-inline-form">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; gap: 12px;">
                                <select id="corr-direction" class="kd-select">
                                    <option value="outbound">Ausgehend</option>
                                    <option value="inbound">Eingehend</option>
                                </select>
                                <input type="text" id="corr-subject" placeholder="Betreff" class="kd-input" style="flex: 1;">
                            </div>
                            <textarea id="corr-body" placeholder="Inhalt / Notizen" rows="3" class="kd-textarea"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 14px;">
                            <button onclick="saveCorrespondence()" class="kd-quickbtn kd-quickbtn-primary" style="padding: 9px 18px; font-size: 13px;">Speichern</button>
                            <button onclick="toggleCorrForm()" class="kd-quickbtn" style="padding: 9px 18px; font-size: 13px;">Abbrechen</button>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Anrufprotokoll Card ── #}
            <div class="kd-section kd-anim" style="animation-delay: 0.2s;">
                <div class="kd-section-header">
                    <div class="kd-section-title">
                        <svg style="width: 20px; height: 20px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                        </svg>
                        Anrufprotokoll
                    </div>
                </div>
                <div class="kd-section-body">
                    <div id="call-notes-container"
                         hx-get="/partials/company/{{ company.id }}/call-notes"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="kd-skeleton">Lade Anrufprotokolle...</p>
                    </div>
                </div>
            </div>

            {# ── Aufgaben Card ── #}
            <div class="kd-section kd-anim" style="animation-delay: 0.25s;">
                <div class="kd-section-header">
                    <div class="kd-section-title">
                        <svg style="width: 20px; height: 20px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Aufgaben
                    </div>
                </div>
                <div class="kd-section-body">
                    <div id="todos-container"
                         hx-get="/partials/company/{{ company.id }}/todos"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="kd-skeleton">Lade Aufgaben...</p>
                    </div>
                </div>
            </div>

            {# ── Dokumente Card ── #}
            <div class="kd-section kd-anim" style="animation-delay: 0.3s;">
                <div class="kd-section-header">
                    <div class="kd-section-title">
                        <svg style="width: 20px; height: 20px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        Dokumente
                    </div>
                    <button onclick="toggleDocForm()" class="kd-quickbtn-accent" style="display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 8px; font-size: 13px; font-weight: 630; cursor: pointer; font-family: inherit; border: 1.5px solid #c7d2fe; background: #fff; color: #4f46e5; transition: all 0.2s;">
                        <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                        Hochladen
                    </button>
                </div>
                <div class="kd-section-body">
                    <div id="documents-container"
                         hx-get="/partials/company/{{ company.id }}/documents"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="kd-skeleton">Lade Dokumente...</p>
                    </div>
                    {# Inline Upload Form (hidden) #}
                    <div id="doc-upload-form" style="display:none" class="kd-inline-form">
                        <div class="kd-dropzone"
                             ondragover="event.preventDefault(); this.classList.add('dragover')"
                             ondragleave="this.classList.remove('dragover')"
                             ondrop="event.preventDefault(); this.classList.remove('dragover'); handleFileDrop(event)"
                             onclick="document.getElementById('doc-file-input').click()">
                            <svg style="width: 32px; height: 32px; color: #94a3b8; margin: 0 auto 8px;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                            </svg>
                            <div style="font-size: 14px; font-weight: 600; color: #64748b;">Datei hierher ziehen oder klicken</div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">PDF, Word, Bilder, etc.</div>
                        </div>
                        <input type="file" id="doc-file-input" onchange="handleFileSelect(this)" style="display: none;">
                        <div id="doc-file-name" class="hidden" style="margin-top: 10px; font-size: 13px; font-weight: 600; color: #4f46e5; padding: 8px 12px; background: #eef2ff; border-radius: 8px;"></div>
                        <input type="text" id="doc-notes" placeholder="Notizen zum Dokument (optional)" class="kd-input" style="margin-top: 12px;">
                        <div style="display: flex; gap: 10px; margin-top: 14px;">
                            <button id="doc-upload-btn" onclick="uploadDocument()" disabled class="kd-quickbtn kd-quickbtn-primary" style="padding: 9px 18px; font-size: 13px; opacity: 0.5;">Hochladen</button>
                            <button onclick="toggleDocForm()" class="kd-quickbtn" style="padding: 9px 18px; font-size: 13px;">Abbrechen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ======== RIGHT SIDEBAR (340px) ======== #}
        <div style="display: flex; flex-direction: column; gap: 20px;">

            {# ── Notizen Card ── #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 0.1s;">
                <div class="kd-sidebar-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                        </svg>
                        Notizen
                    </span>
                    <span style="font-size: 11px; color: #94a3b8; font-weight: 500;">Auto-Save</span>
                </div>
                <div class="kd-sidebar-body">
                    <textarea id="company-notes"
                              placeholder="Notizen zum Unternehmen..."
                              rows="5"
                              onblur="saveNotes()"
                              class="kd-textarea" style="font-size: 13px;">{{ company.notes or '' }}</textarea>
                </div>
            </div>

            {# ── ATS-Stellen Card ── #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 0.15s;">
                <div class="kd-sidebar-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0M12 12.75h.008v.008H12v-.008z" />
                        </svg>
                        ATS-Stellen
                        <span style="background: #eef2ff; color: #4f46e5; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px;">{{ ats_job_count }}</span>
                    </span>
                    <a href="/ats/stellen" style="font-size: 12px; color: #6366f1; font-weight: 600; text-decoration: none;">Alle anzeigen</a>
                </div>
                <div class="kd-sidebar-body">
                    <div id="company-ats-jobs"
                         hx-get="/partials/company-ats-jobs/{{ company.id }}"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="kd-skeleton">Lade ATS-Stellen...</p>
                    </div>
                </div>
            </div>

            {# ── Zugehörige Jobs Card ── #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 0.2s;">
                <div class="kd-sidebar-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
                        </svg>
                        Zugehörige Jobs
                        <span style="background: #eef2ff; color: #4f46e5; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px;">{{ job_count }}</span>
                    </span>
                </div>
                <div class="kd-sidebar-body">
                    <div id="company-jobs"
                         hx-get="/partials/company-jobs/{{ company.id }}"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="kd-skeleton">Lade Jobs...</p>
                    </div>
                </div>
            </div>

            {# ── Details Card ── #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 0.25s;">
                <div class="kd-sidebar-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px; color: #6366f1;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                        Details
                    </span>
                </div>
                <div class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px; color: #94a3b8; font-weight: 500;">Erstellt</span>
                            <span style="font-size: 13px; color: #1e293b; font-weight: 600;">{{ company.created_at | datetime }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px; color: #94a3b8; font-weight: 500;">Aktualisiert</span>
                            <span style="font-size: 13px; color: #1e293b; font-weight: 600;">{{ company.updated_at | datetime }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const COMPANY_ID = '{{ company.id }}';

function copyToClipboard(text) {
    navigator.clipboard.writeText(text.trim()).then(() => {
        showToast('Kopiert!', 'success');
    });
}

function setStatus(status) {
    fetch(`/api/companies/${COMPANY_ID}/status?status=${status}`, { method: 'PUT' })
        .then(r => r.json())
        .then(() => { showToast('Status geaendert', 'success'); setTimeout(() => location.reload(), 500); })
        .catch(() => showToast('Fehler', 'error'));
}

function saveNotes() {
    const notes = document.getElementById('company-notes').value;
    fetch(`/api/companies/${COMPANY_ID}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: notes })
    }).then(() => showToast('Notizen gespeichert', 'success'));
}

// --- Contacts ---
function toggleContactForm() {
    const f = document.getElementById('contact-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveContact() {
    const data = {
        first_name: document.getElementById('cf-first-name').value || null,
        last_name: document.getElementById('cf-last-name').value || null,
        position: document.getElementById('cf-position').value || null,
        phone: document.getElementById('cf-phone').value || null,
        email: document.getElementById('cf-email').value || null,
    };
    fetch(`/api/companies/${COMPANY_ID}/contacts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(() => {
        showToast('Kontakt erstellt', 'success');
        toggleContactForm();
        // Clear form
        ['cf-first-name','cf-last-name','cf-position','cf-phone','cf-email'].forEach(id => document.getElementById(id).value = '');
        // Reload contacts
        htmx.trigger('#contacts-container', 'load');
    }).catch(() => showToast('Fehler', 'error'));
}

function deleteContact(contactId) {
    if (!confirm('Kontakt loeschen?')) return;
    fetch(`/api/companies/contacts/${contactId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Kontakt geloescht', 'success'); htmx.trigger('#contacts-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

// --- Correspondence ---
function toggleCorrForm() {
    const f = document.getElementById('corr-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveCorrespondence() {
    const data = {
        direction: document.getElementById('corr-direction').value,
        subject: document.getElementById('corr-subject').value,
        body: document.getElementById('corr-body').value || null,
    };
    if (!data.subject) { showToast('Betreff erforderlich', 'error'); return; }
    fetch(`/api/companies/${COMPANY_ID}/correspondence`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(() => {
        showToast('Korrespondenz erstellt', 'success');
        toggleCorrForm();
        document.getElementById('corr-subject').value = '';
        document.getElementById('corr-body').value = '';
        htmx.trigger('#correspondence-container', 'load');
    }).catch(() => showToast('Fehler', 'error'));
}

function deleteCorrespondence(corrId) {
    if (!confirm('Korrespondenz loeschen?')) return;
    fetch(`/api/companies/correspondence/${corrId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Geloescht', 'success'); htmx.trigger('#correspondence-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

// --- Call Notes ---
function deleteCompanyCallNote(noteId) {
    if (!confirm('Anrufprotokoll loeschen?')) return;
    fetch(`/api/ats/call-notes/${noteId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Geloescht', 'success'); htmx.trigger('#call-notes-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

// --- Todos ---
function deleteCompanyTodo(todoId) {
    if (!confirm('Aufgabe loeschen?')) return;
    fetch(`/api/ats/todos/${todoId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Geloescht', 'success'); htmx.trigger('#todos-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

// --- Documents ---
var selectedDocFile = null;

function toggleDocForm() {
    const f = document.getElementById('doc-upload-form');
    if (f) f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function handleFileDrop(event) {
    const files = event.dataTransfer.files;
    if (files.length > 0) setDocFile(files[0]);
}

function handleFileSelect(input) {
    if (input.files.length > 0) setDocFile(input.files[0]);
}

function setDocFile(file) {
    selectedDocFile = file;
    const nameEl = document.getElementById('doc-file-name');
    if (nameEl) { nameEl.textContent = file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)'; nameEl.classList.remove('hidden'); }
    const btn = document.getElementById('doc-upload-btn');
    if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
}

function uploadDocument() {
    if (!selectedDocFile) return;
    const formData = new FormData();
    formData.append('file', selectedDocFile);
    const notes = document.getElementById('doc-notes');
    if (notes && notes.value) formData.append('notes', notes.value);

    const btn = document.getElementById('doc-upload-btn');
    if (btn) { btn.disabled = true; btn.textContent = 'Hochladen...'; }

    fetch(`/api/companies/${COMPANY_ID}/documents`, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(() => {
            showToast('Dokument hochgeladen', 'success');
            toggleDocForm();
            selectedDocFile = null;
            if (notes) notes.value = '';
            const nameEl = document.getElementById('doc-file-name');
            if (nameEl) nameEl.classList.add('hidden');
            if (btn) { btn.disabled = true; btn.textContent = 'Hochladen'; btn.style.opacity = '0.5'; }
            htmx.trigger('#documents-container', 'load');
        })
        .catch(() => { showToast('Upload fehlgeschlagen', 'error'); if (btn) { btn.disabled = false; btn.textContent = 'Hochladen'; btn.style.opacity = '1'; } });
}

function deleteDocument(docId) {
    if (!confirm('Dokument loeschen?')) return;
    fetch(`/api/companies/documents/${docId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => { showToast('Geloescht', 'success'); htmx.trigger('#documents-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}
</script>
{% endblock %}
