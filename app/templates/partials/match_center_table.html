{# Match Center — Kandidatentabelle mit Pagination, Status-Filter, Bulk-Aktionen #}
{# Wird via HTMX in #matches-table-content geladen #}

{% set all_match_ids = matches|map(attribute='match_id')|list %}

<div>

    {# ═══════ BULK-AKTIONSLEISTE ═══════ #}
    <div x-show="selectedMatchIds.length > 0"
         x-transition
         class="bg-primary-50 border border-primary-200 rounded-lg px-4 py-3 mb-4 flex items-center justify-between flex-wrap gap-2">
        <span class="text-sm font-medium text-primary-800">
            <span x-text="selectedMatchIds.length"></span> ausgewaehlt
        </span>
        <div class="flex items-center gap-2 flex-wrap">
            <button @click="bulkEmail()"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                E-Mail
            </button>
            <button @click="bulkSendProfiles()"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                Profile senden
            </button>
            <button @click="bulkStatus('presented')"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-green-700 bg-green-50 border border-green-200 rounded-md hover:bg-green-100 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Vorgestellt
            </button>
            <button @click="bulkStatus('rejected')"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-700 bg-red-50 border border-red-200 rounded-md hover:bg-red-50 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                Abgelehnt
            </button>
            <button @click="bulkExport()"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Exportieren
            </button>
            <span class="text-gray-300 mx-1">|</span>
            <button @click="selectedMatchIds = []"
                    class="text-xs text-gray-500 hover:text-gray-700 underline">
                Auswahl aufheben
            </button>
        </div>
    </div>

    {# ═══════ STATUS-FILTER PILLS ═══════ #}
    <div class="flex items-center gap-2 mb-4">
        <button @click="setStatusFilter(null)"
                :class="!statusFilter ? 'bg-primary-100 text-primary-700 border-primary-300' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium border rounded-full transition-colors">
            Alle <span class="text-gray-400 ml-0.5">{{ status_counts.all }}</span>
        </button>
        <button @click="setStatusFilter('new')"
                :class="statusFilter === 'new' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium border rounded-full transition-colors">
            Neu <span class="text-gray-400 ml-0.5">{{ status_counts.new }}</span>
        </button>
        <button @click="setStatusFilter('presented')"
                :class="statusFilter === 'presented' ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium border rounded-full transition-colors">
            Vorgestellt <span class="text-gray-400 ml-0.5">{{ status_counts.presented }}</span>
        </button>
        <button @click="setStatusFilter('rejected')"
                :class="statusFilter === 'rejected' ? 'bg-red-100 text-red-700 border-red-300' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium border rounded-full transition-colors">
            Abgelehnt <span class="text-gray-400 ml-0.5">{{ status_counts.rejected }}</span>
        </button>

        {# Ergebnis-Info rechts #}
        <div class="ml-auto text-xs text-gray-500">
            {% if total > 0 %}
                {{ (page - 1) * per_page + 1 }}–{{ [page * per_page, total]|min }} von {{ total }}
            {% else %}
                Keine Ergebnisse
            {% endif %}
        </div>
    </div>

    {# ═══════ TABELLE ═══════ #}
    {% if matches %}
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full divide-y divide-gray-200 table-fixed">
                <thead class="bg-gray-50">
                    <tr>
                        {# Checkbox #}
                        <th class="w-[40px] px-3 py-3">
                            <input type="checkbox"
                                   @change="toggleAllMatches({{ all_match_ids|tojson }})"
                                   :checked="selectedMatchIds.length === {{ matches|length }}"
                                   class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        </th>
                        {# Rang #}
                        <th class="w-[36px] px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                        {# Score — sortierbar #}
                        <th class="w-[90px] px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer select-none hover:text-gray-700"
                            @click="toggleSort('score')">
                            <span class="flex items-center gap-1">
                                Score
                                <template x-if="sortBy === 'score'">
                                    <svg :class="sortDir === 'asc' ? 'rotate-180' : ''" class="w-3 h-3 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                </template>
                            </span>
                        </th>
                        {# Kandidat — sortierbar, nimmt verfuegbaren Platz #}
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer select-none hover:text-gray-700"
                            @click="toggleSort('name')">
                            <span class="flex items-center gap-1">
                                Kandidat
                                <template x-if="sortBy === 'name'">
                                    <svg :class="sortDir === 'asc' ? 'rotate-180' : ''" class="w-3 h-3 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                </template>
                            </span>
                        </th>
                        {# Status #}
                        <th class="w-[90px] px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        {# Entfernung — sortierbar #}
                        <th class="w-[70px] px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer select-none hover:text-gray-700"
                            @click="toggleSort('distance')">
                            <span class="flex items-center gap-1">
                                km
                                <template x-if="sortBy === 'distance'">
                                    <svg :class="sortDir === 'asc' ? 'rotate-180' : ''" class="w-3 h-3 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                </template>
                            </span>
                        </th>
                        {# Aktivitaet — sortierbar #}
                        <th class="w-[70px] px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer select-none hover:text-gray-700"
                            @click="toggleSort('activity')">
                            <span class="flex items-center gap-1">
                                Aktiv
                                <template x-if="sortBy === 'activity'">
                                    <svg :class="sortDir === 'asc' ? 'rotate-180' : ''" class="w-3 h-3 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                </template>
                            </span>
                        </th>
                        {# Gehalt #}
                        <th class="w-[80px] px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gehalt</th>
                        {# Aktionen #}
                        <th class="w-[130px] px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for m in matches %}
                    {% set display_name = m.current_position if (m.name in ['Not Available', 'Unbekannt', 'N/A', ''] or not m.name) else m.name %}
                    {% set is_name_missing = (m.name in ['Not Available', 'Unbekannt', 'N/A', ''] or not m.name) %}
                    <tr class="group hover:bg-gray-50 transition-colors"
                        :class="selectedMatchIds.includes('{{ m.match_id }}') ? 'bg-primary-50/50' : ''">

                        {# Checkbox #}
                        <td class="px-3 py-3">
                            <input type="checkbox"
                                   value="{{ m.match_id }}"
                                   @change="toggleMatch('{{ m.match_id }}')"
                                   :checked="selectedMatchIds.includes('{{ m.match_id }}')"
                                   class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        </td>

                        {# Rang #}
                        <td class="px-2 py-3 text-xs text-gray-400 font-medium">{{ m.rank }}</td>

                        {# Score mit farbcodiertem Balken (Fix 1) #}
                        <td class="px-3 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-12 bg-gray-200 rounded-full h-1.5">
                                    <div class="h-1.5 rounded-full"
                                         style="width: {{ [m.score, 100]|min }}%; background-color: {% if m.score >= 85 %}#22c55e{% elif m.score >= 75 %}#4ade80{% elif m.score >= 65 %}#eab308{% elif m.score >= 55 %}#f97316{% else %}#ef4444{% endif %};"></div>
                                </div>
                                <span class="text-xs font-bold"
                                      style="color: {% if m.score >= 85 %}#22c55e{% elif m.score >= 75 %}#4ade80{% elif m.score >= 65 %}#eab308{% elif m.score >= 55 %}#f97316{% else %}#ef4444{% endif %};">
                                    {{ m.score|int }}
                                </span>
                            </div>
                        </td>

                        {# Kandidat (Name + Position) — Fix 9 + 10 #}
                        <td class="px-3 py-3 overflow-hidden">
                            <div class="flex items-center gap-2.5 min-w-0">
                                {# Initial-Kreis — ? bei fehlenden Namen #}
                                {% if is_name_missing %}
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-400 flex-shrink-0 border border-dashed border-gray-300">?</div>
                                {% else %}
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600 flex-shrink-0">{{ display_name[0] if display_name else '?' }}</div>
                                {% endif %}
                                <div class="min-w-0 flex-1">
                                    <p class="text-sm font-medium truncate {% if is_name_missing %}text-gray-400 italic{% else %}text-gray-900{% endif %}">{{ display_name or 'Unbekannt' }}</p>
                                    {% if not is_name_missing %}
                                    <p class="text-xs text-gray-500 truncate">{{ m.current_position or '' }}{% if m.current_company %} bei {{ m.current_company }}{% endif %}</p>
                                    {% elif m.current_company %}
                                    <p class="text-xs text-gray-500 truncate">bei {{ m.current_company }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        {# Status Badge #}
                        <td class="px-3 py-3">
                            {% if m.status in ['new', 'ai_checked'] %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Neu</span>
                            {% elif m.status == 'presented' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">Vorgestellt</span>
                            {% elif m.status == 'rejected' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">Abgelehnt</span>
                            {% elif m.status == 'placed' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">Vermittelt</span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">{{ m.status }}</span>
                            {% endif %}
                        </td>

                        {# Entfernung #}
                        <td class="px-3 py-3 text-xs text-gray-600 text-right">
                            {% if m.distance_km is not none and m.distance_km %}
                                {{ m.distance_km|int }} km
                            {% else %}
                                <span class="text-gray-300">—</span>
                            {% endif %}
                        </td>

                        {# Aktivitaet (Fix 7 — echte Farbcodierung) #}
                        <td class="px-3 py-3 text-xs">
                            {% if m.activity_days is not none %}
                                {% if m.activity_days == 0 %}
                                    <span style="color: #22c55e;" class="font-medium">heute</span>
                                {% elif m.activity_days <= 7 %}
                                    <span style="color: #22c55e;">{{ m.activity_days }}d</span>
                                {% elif m.activity_days <= 30 %}
                                    <span style="color: #eab308;">{{ m.activity_days }}d</span>
                                {% else %}
                                    <span style="color: #64748b;">{{ m.activity_days }}d</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-300">—</span>
                            {% endif %}
                        </td>

                        {# Gehalt (Fix 8) #}
                        <td class="px-3 py-3 text-xs text-gray-600">
                            {% if m.salary %}
                                {{ m.salary }}
                            {% else %}
                                <span class="text-gray-300">—</span>
                            {% endif %}
                        </td>

                        {# Aktionen — Fix 5: Hover-Opacity #}
                        <td class="px-3 py-3">
                            <div class="flex items-center justify-end gap-1 opacity-30 group-hover:opacity-100 transition-opacity duration-150">
                                {# Profil oeffnen #}
                                <a href="/kandidaten/{{ m.candidate_id }}" target="_blank"
                                   class="p-1.5 text-gray-400 hover:text-primary-600 rounded-md hover:bg-primary-50 transition-colors"
                                   title="Profil oeffnen">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                </a>
                                {# Vergleich oeffnen #}
                                <button onclick="openCompareModal('{{ m.match_id }}')"
                                        class="p-1.5 text-gray-400 hover:text-primary-600 rounded-md hover:bg-primary-50 transition-colors"
                                        title="Vergleich">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                </button>
                                {# E-Mail #}
                                {% if m.email %}
                                <a href="mailto:{{ m.email }}"
                                   class="p-1.5 text-gray-400 hover:text-primary-600 rounded-md hover:bg-primary-50 transition-colors"
                                   title="E-Mail senden">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                </a>
                                {% endif %}
                                {# Ablehnen #}
                                {% if m.status not in ['rejected', 'placed'] %}
                                <button onclick="rejectMatch('{{ m.match_id }}')"
                                        class="p-1.5 text-gray-400 hover:text-red-500 rounded-md hover:bg-red-50 transition-colors"
                                        title="Ablehnen">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {# ═══════ PAGINATION ═══════ #}
    {% if pages > 1 %}
    <div class="flex items-center justify-between mt-4">
        <div class="text-xs text-gray-500">
            {{ (page - 1) * per_page + 1 }}–{{ [page * per_page, total]|min }} von {{ total }} Kandidaten
        </div>
        <div class="flex items-center gap-1">
            {# Zurueck #}
            {% if page > 1 %}
            <button @click="setPage({{ page - 1 }})"
                    class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                &larr;
            </button>
            {% endif %}

            {# Seitenzahlen #}
            {% for p in range(1, pages + 1) %}
                {% if p == page %}
                <span class="px-3 py-1.5 text-xs font-medium text-white bg-primary-600 rounded-md">{{ p }}</span>
                {% elif p <= 3 or p >= pages - 1 or (p >= page - 1 and p <= page + 1) %}
                <button @click="setPage({{ p }})"
                        class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                    {{ p }}
                </button>
                {% elif p == 4 or p == pages - 2 %}
                <span class="px-1 text-gray-400">...</span>
                {% endif %}
            {% endfor %}

            {# Vor #}
            {% if page < pages %}
            <button @click="setPage({{ page + 1 }})"
                    class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                &rarr;
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    {# Keine Matches #}
    <div class="bg-white rounded-xl border border-gray-200 p-8 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        <p class="text-sm text-gray-500">
            {% if current_status_filter %}
                Keine Kandidaten mit diesem Status-Filter gefunden.
            {% else %}
                Keine Kandidaten fuer diese Kombination gefunden.
            {% endif %}
        </p>
    </div>
    {% endif %}

</div>
