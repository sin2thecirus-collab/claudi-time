{# Gruppen-Detail: Jobs + Matches fuer eine Jobtitel+Stadt Kombination #}
{# Wird via HTMX in das Gruppen-Detail-Modal geladen #}

{% if jobs %}
<div class="space-y-4" x-data="matchGroupSelection()">

    {# ═══ Batch-Aktionsleiste (erscheint wenn Matches ausgewaehlt) ═══ #}
    <div x-show="selectedIds.length > 0" x-cloak
         class="sticky top-0 z-10 bg-primary-50 border border-primary-200 rounded-lg px-4 py-3 flex items-center justify-between">
        <span class="text-sm font-medium text-primary-700">
            <span x-text="selectedIds.length"></span> Match(es) ausgewaehlt
        </span>
        <div class="flex items-center gap-2">
            <button @click="triggerDeepMatch()"
                    :disabled="deepMatchRunning"
                    class="inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-lg bg-primary-600 text-white hover:bg-primary-700 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <svg x-show="!deepMatchRunning" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                </svg>
                <svg x-show="deepMatchRunning" class="w-3.5 h-3.5 animate-spin" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                </svg>
                <span x-text="deepMatchRunning ? 'KI bewertet...' : 'DeepMatch starten'"></span>
            </button>
            <button @click="selectedIds = []"
                    class="text-xs px-3 py-1.5 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-colors">
                Abwaehlen
            </button>
        </div>
    </div>

    {# ═══ DeepMatch Ergebnis-Banner ═══ #}
    <div x-show="deepMatchResult" x-cloak
         class="bg-green-50 border border-green-200 rounded-lg px-4 py-3">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm font-medium text-green-700" x-text="deepMatchResult"></span>
        </div>
    </div>

    {% for job in jobs %}
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <!-- Job-Header -->
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-semibold text-gray-900 text-sm">{{ job.position }}</h3>
                    <p class="text-xs text-gray-500 mt-0.5">
                        {{ job.company_name }}{% if job.city %} &middot; {{ job.city }}{% endif %}
                        &middot; {{ job.match_count }} Match{{ 'es' if job.match_count != 1 else '' }}
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    {# Alle auswaehlen fuer diesen Job #}
                    <button @click="toggleJobMatches('{{ job.job_id }}')"
                            class="text-xs px-2 py-1 rounded-lg text-gray-500 hover:bg-gray-100 border border-gray-200 transition-colors font-medium">
                        Alle
                    </button>
                    <a href="/match-center/job/{{ job.job_id }}"
                       class="text-xs text-primary-600 hover:text-primary-700 font-medium transition-colors">
                        Detail &rarr;
                    </a>
                </div>
            </div>
        </div>

        <!-- Matches -->
        <div class="divide-y divide-gray-50">
            {% for m in job.matches %}
            <div class="flex items-center justify-between px-4 py-2.5 hover:bg-gray-50 transition-colors"
                 :class="selectedIds.includes('{{ m.match_id }}') ? 'bg-primary-50/50 border-l-2 border-primary-400' : ''"
                 data-job-id="{{ job.job_id }}">
                <!-- Links: Checkbox + Score + Name -->
                <div class="flex items-center gap-3 min-w-0 flex-1">
                    {# Checkbox fuer Mehrfachauswahl #}
                    <input type="checkbox"
                           value="{{ m.match_id }}"
                           :checked="selectedIds.includes('{{ m.match_id }}')"
                           @change="toggleMatch('{{ m.match_id }}')"
                           class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 flex-shrink-0">

                    <div class="flex-shrink-0 w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold
                                {% if m.ai_score and m.ai_score >= 70 %}bg-green-100 text-green-700
                                {% elif m.ai_score and m.ai_score >= 40 %}bg-yellow-100 text-yellow-700
                                {% elif m.ai_score %}bg-gray-100 text-gray-600
                                {% else %}bg-gray-50 text-gray-400{% endif %}">
                        {% if m.ai_score %}{{ m.ai_score|int }}{% else %}&mdash;{% endif %}
                    </div>

                    <div class="min-w-0">
                        <div class="flex items-center gap-2">
                            {% if m.candidate_id %}
                            <span class="font-medium text-gray-900 text-sm truncate">{{ m.candidate_name }}</span>
                            {% else %}
                            <span class="font-medium text-gray-400 text-sm truncate">Geloeschter Kandidat</span>
                            {% endif %}

                            <span id="grp-status-{{ m.match_id }}"
                                  class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium
                                         {% if m.status == 'presented' %}bg-green-100 text-green-700
                                         {% elif m.status == 'rejected' %}bg-red-100 text-red-700
                                         {% elif m.status == 'placed' %}bg-purple-100 text-purple-700
                                         {% elif m.status == 'ai_checked' %}bg-blue-100 text-blue-700
                                         {% else %}bg-gray-100 text-gray-600{% endif %}">
                                {% if m.status == 'new' %}Neu
                                {% elif m.status == 'ai_checked' %}Bewertet
                                {% elif m.status == 'presented' %}Vorgestellt
                                {% elif m.status == 'rejected' %}Abgelehnt
                                {% elif m.status == 'placed' %}Vermittelt
                                {% else %}{{ m.status }}{% endif %}
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 truncate">
                            {% if m.candidate_title %}{{ m.candidate_title }}{% endif %}
                            {% if m.candidate_city %} &middot; {{ m.candidate_city }}{% endif %}
                            {% if m.distance_km %} &middot; {{ m.distance_km }} km{% endif %}
                        </p>
                    </div>
                </div>

                <!-- Rechts: Aktionen -->
                <div class="flex items-center gap-1.5 flex-shrink-0 ml-3">
                    <button onclick="openCompareModal('{{ m.match_id }}')"
                            class="text-xs px-2 py-1 rounded-lg bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200 transition-colors font-medium">
                        Vergleich
                    </button>

                    {% if m.status not in ['presented', 'placed'] %}
                    <button hx-post="/api/match-center/status/{{ m.match_id }}?status=presented"
                            hx-target="#grp-status-{{ m.match_id }}"
                            hx-swap="innerHTML"
                            class="text-xs px-2 py-1 rounded-lg bg-green-50 text-green-700 hover:bg-green-100 border border-green-200 transition-colors font-medium">
                        Vorgestellt
                    </button>
                    {% endif %}

                    {% if m.status not in ['rejected', 'placed'] %}
                    <button hx-post="/api/match-center/status/{{ m.match_id }}?status=rejected"
                            hx-target="#grp-status-{{ m.match_id }}"
                            hx-swap="innerHTML"
                            class="text-xs px-2 py-1 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 border border-red-200 transition-colors font-medium">
                        Abgelehnt
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
function matchGroupSelection() {
    return {
        selectedIds: [],
        deepMatchRunning: false,
        deepMatchResult: null,

        toggleMatch(matchId) {
            const idx = this.selectedIds.indexOf(matchId);
            if (idx >= 0) {
                this.selectedIds.splice(idx, 1);
            } else {
                this.selectedIds.push(matchId);
            }
        },

        toggleJobMatches(jobId) {
            const rows = document.querySelectorAll('[data-job-id="' + jobId + '"]');
            const matchIds = [];
            rows.forEach(row => {
                const cb = row.querySelector('input[type="checkbox"]');
                if (cb) matchIds.push(cb.value);
            });

            // Wenn alle bereits ausgewaehlt: abwaehlen, sonst alle auswaehlen
            const allSelected = matchIds.every(id => this.selectedIds.includes(id));
            if (allSelected) {
                this.selectedIds = this.selectedIds.filter(id => !matchIds.includes(id));
            } else {
                matchIds.forEach(id => {
                    if (!this.selectedIds.includes(id)) {
                        this.selectedIds.push(id);
                    }
                });
            }
        },

        async triggerDeepMatch() {
            if (this.selectedIds.length === 0 || this.deepMatchRunning) return;

            this.deepMatchRunning = true;
            this.deepMatchResult = null;

            try {
                const response = await fetch('/api/deepmatch/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_ids: this.selectedIds })
                });

                const data = await response.json();

                if (data.evaluated !== undefined) {
                    this.deepMatchResult = data.evaluated + ' Matches bewertet (Ø ' +
                        (data.avg_ai_score ? Math.round(data.avg_ai_score * 100) + '%' : 'n/a') +
                        ', Kosten: $' + (data.total_cost_usd || 0).toFixed(3) + ')';
                    showToast('DeepMatch: ' + data.evaluated + ' Matches bewertet', 'success');
                    this.selectedIds = [];

                    // Seite nach 2 Sekunden neu laden um Ergebnisse zu zeigen
                    setTimeout(() => location.reload(), 2000);
                } else if (data.detail) {
                    showToast('Fehler: ' + data.detail, 'error');
                }
            } catch (err) {
                showToast('DeepMatch Fehler: ' + err.message, 'error');
            } finally {
                this.deepMatchRunning = false;
            }
        }
    };
}
</script>

{% else %}
<div class="py-6 text-center text-sm text-gray-400">
    Keine Jobs mit Matches in dieser Kombination gefunden.
</div>
{% endif %}
