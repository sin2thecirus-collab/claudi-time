{# Kandidaten-Liste Partial fuer HTMX #}

{% if candidates | length == 0 %}
<div class="p-8 text-center">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
    </svg>
    <h3 class="mt-2 text-sm font-semibold text-gray-900">Keine Kandidaten gefunden</h3>
    <p class="mt-1 text-sm text-gray-500">
        {% if search %}
        Keine Kandidaten fuer "{{ search }}" gefunden.
        {% else %}
        Starten Sie einen CRM-Sync um Kandidaten zu importieren.
        {% endif %}
    </p>
</div>
{% else %}
{# Batch-Aktionsleiste (erscheint wenn Kandidaten ausgewaehlt sind) #}
<div id="batch-actions" class="hidden bg-gray-50 border-b border-gray-200 px-5 py-4 sm:px-8">
    <div class="flex items-center justify-between">
        <span class="text-base font-medium text-gray-800">
            <span id="selected-count">0</span> Kandidat(en) ausgewaehlt
        </span>
        <div class="flex items-center space-x-3">
            {# CV neu parsen Button #}
            <button type="button"
                    id="btn-batch-parse"
                    onclick="batchParseSelected()"
                    class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-base font-semibold text-white shadow-sm hover:bg-primary-500 transition-colors">
                <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v16.5c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9zm3.75 11.625a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                </svg>
                CV neu parsen
            </button>
            {# Loeschen Button #}
            <button type="button"
                    onclick="batchDeleteSelected()"
                    class="inline-flex items-center rounded-md bg-red-600 px-4 py-2 text-base font-semibold text-white shadow-sm hover:bg-red-500 transition-colors">
                <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                </svg>
                Ausgewaehlte loeschen
            </button>
        </div>
    </div>
</div>

<table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
        <tr>
            <th scope="col" class="selection-col hidden py-5 pl-5 pr-2 w-12">
                <input type="checkbox"
                       id="select-all-candidates"
                       onchange="toggleAllCandidates(this)"
                       class="h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-600 cursor-pointer">
            </th>
            <th scope="col" class="py-5 pl-4 pr-4 text-left text-xl font-semibold text-gray-900">Name</th>
            <th scope="col" class="px-4 py-5 text-left text-xl font-semibold text-gray-900">Position</th>
            <th scope="col" class="px-4 py-5 text-left text-xl font-semibold text-gray-900">Unternehmen</th>
            <th scope="col" class="px-4 py-5 text-left text-xl font-semibold text-gray-900">Adresse</th>
            <th scope="col" class="px-4 py-5 text-left text-xl font-semibold text-gray-900">Status</th>
            <th scope="col" class="relative py-5 pl-4 pr-5 sm:pr-8">
                <span class="sr-only">Aktionen</span>
            </th>
        </tr>
    </thead>
    <tbody class="divide-y divide-gray-200 bg-white">
        {% for candidate in candidates %}
        <tr id="row-{{ candidate.id }}" class="hover:bg-gray-50 cursor-pointer transition-colors"
            onclick="window.location='/kandidaten/{{ candidate.id }}'">
            {# Checkbox (nur sichtbar im Auswahl-Modus) #}
            <td class="selection-col hidden whitespace-nowrap py-5 pl-5 pr-2 w-12" onclick="event.stopPropagation()">
                <input type="checkbox"
                       class="candidate-checkbox h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-600 cursor-pointer"
                       value="{{ candidate.id }}"
                       onchange="updateBatchActions()">
            </td>
            {# Name #}
            <td class="whitespace-nowrap py-5 pl-4 pr-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-14 w-14">
                        <span class="inline-flex h-14 w-14 items-center justify-center rounded-full bg-primary-100">
                            <span class="text-lg font-medium text-primary-700">
                                {{ (candidate.first_name or 'X')[0] | upper }}{{ (candidate.last_name or 'X')[0] | upper }}
                            </span>
                        </span>
                    </div>
                    <div class="ml-5">
                        <div class="text-lg font-medium text-gray-900">
                            {{ candidate.first_name or '' }} {{ candidate.last_name or '' }}
                            {% if candidate.age %}<span class="text-gray-400 font-normal">({{ candidate.age }})</span>{% endif %}
                        </div>
                        {% if candidate.email %}
                        <div class="text-base text-gray-500">{{ candidate.email }}</div>
                        {% endif %}
                    </div>
                </div>
            </td>

            {# Position (editierbar) #}
            <td class="px-4 py-5 text-lg text-gray-900" onclick="event.stopPropagation()">
                <div class="inline-edit-wrapper group" data-candidate-id="{{ candidate.id }}" data-field="current_position">
                    <span class="inline-edit-display cursor-pointer hover:bg-yellow-50 hover:ring-1 hover:ring-yellow-300 rounded px-1.5 py-1 transition-all {% if not candidate.current_position %}text-gray-400 italic{% else %}font-medium{% endif %}"
                          onclick="startInlineEdit(this)"
                          title="Klicken zum Bearbeiten">{{ candidate.current_position or 'Keine Position' }}</span>
                    <input type="text"
                           class="inline-edit-input hidden w-full rounded-md border-0 py-1.5 px-2.5 text-base text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600"
                           value="{{ candidate.current_position or '' }}"
                           onblur="saveInlineEdit(this)"
                           onkeydown="handleInlineEditKey(event, this)">
                </div>
            </td>

            {# Unternehmen (editierbar) #}
            <td class="px-4 py-5 text-lg text-gray-500" onclick="event.stopPropagation()">
                <div class="inline-edit-wrapper group" data-candidate-id="{{ candidate.id }}" data-field="current_company">
                    <span class="inline-edit-display cursor-pointer hover:bg-yellow-50 hover:ring-1 hover:ring-yellow-300 rounded px-1.5 py-1 transition-all {% if not candidate.current_company %}text-gray-400 italic{% endif %}"
                          onclick="startInlineEdit(this)"
                          title="Klicken zum Bearbeiten">{{ candidate.current_company or 'Kein Unternehmen' }}</span>
                    <input type="text"
                           class="inline-edit-input hidden w-full rounded-md border-0 py-1.5 px-2.5 text-base text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600"
                           value="{{ candidate.current_company or '' }}"
                           onblur="saveInlineEdit(this)"
                           onkeydown="handleInlineEditKey(event, this)">
                </div>
            </td>

            {# Adresse #}
            <td class="px-4 py-5 text-lg text-gray-500">
                {% if candidate.street_address or candidate.postal_code or candidate.city %}
                <div>
                    {% if candidate.street_address %}
                    {{ candidate.street_address }}<br>
                    {% endif %}
                    {% if candidate.postal_code or candidate.city %}
                    {{ candidate.postal_code or '' }} {{ candidate.city or '' }}
                    {% endif %}
                </div>
                {% else %}
                <span class="text-gray-400">Keine Adresse</span>
                {% endif %}
            </td>

            {# Status #}
            <td class="whitespace-nowrap px-4 py-5 text-base">
                <div class="flex flex-col space-y-2">
                    {% if candidate.hidden %}
                    <span class="inline-flex items-center rounded-full bg-gray-100 px-4 py-1.5 text-base font-medium text-gray-600">
                        Ausgeblendet
                    </span>
                    {% elif candidate.is_active %}
                    <span class="inline-flex items-center rounded-full bg-green-100 px-4 py-1.5 text-base font-medium text-green-700">
                        Aktiv
                    </span>
                    {% else %}
                    <span class="inline-flex items-center rounded-full bg-yellow-100 px-4 py-1.5 text-base font-medium text-yellow-700">
                        Inaktiv
                    </span>
                    {% endif %}

                    {% if candidate.work_history and candidate.work_history | length > 0 %}
                    <span class="inline-flex items-center rounded-full bg-blue-100 px-4 py-1.5 text-base font-medium text-blue-700">
                        {{ candidate.work_history | length }} Stationen
                    </span>
                    {% endif %}
                </div>
            </td>

            {# Aktionen #}
            <td class="relative whitespace-nowrap py-5 pl-4 pr-5 text-right text-lg font-medium sm:pr-8">
                <div class="flex items-center justify-end space-x-4">
                    {% if candidate.work_history and candidate.work_history | length > 0 %}
                    <button type="button"
                            data-candidate-id="{{ candidate.id }}"
                            data-name="{{ candidate.first_name or '' }} {{ candidate.last_name or '' }}"
                            onclick="event.stopPropagation(); copyWerdegangFromApi(this)"
                            class="text-gray-400 hover:text-primary-600 transition-colors"
                            title="Werdegang kopieren">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                        </svg>
                        <span class="sr-only">Werdegang kopieren</span>
                    </button>
                    {% endif %}
                    <a href="/kandidaten/{{ candidate.id }}"
                       class="text-primary-600 hover:text-primary-900"
                       onclick="event.stopPropagation()">
                        Details
                        <span class="sr-only">, {{ candidate.first_name }} {{ candidate.last_name }}</span>
                    </a>
                    <button hx-delete="/api/candidates/{{ candidate.id }}"
                            hx-confirm="Kandidat {{ candidate.first_name }} {{ candidate.last_name }} wirklich loeschen? Der Kandidat wird beim naechsten CRM-Sync ignoriert."
                            hx-swap="none"
                            hx-on::after-request="if(event.detail.successful) htmx.ajax('GET', '/partials/candidates-list?page={{ page }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}', {target:'#candidates-list', swap:'innerHTML'})"
                            class="text-red-500 hover:text-red-700 transition-colors"
                            onclick="event.stopPropagation()"
                            title="Kandidat loeschen">
                        <svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                        </svg>
                        <span class="sr-only">Loeschen, {{ candidate.first_name }} {{ candidate.last_name }}</span>
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{# Pagination #}
{% if total_pages > 1 %}
<div class="bg-white px-5 py-4 border-t border-gray-200 sm:px-8">
    <div class="flex items-center justify-between">
        <div class="flex-1 flex justify-between sm:hidden">
            {% if page > 1 %}
            <button hx-get="/partials/candidates-list?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                    hx-target="#candidates-list"
                    hx-swap="innerHTML"
                    class="relative inline-flex items-center px-5 py-2.5 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Zurueck
            </button>
            {% endif %}
            {% if page < total_pages %}
            <button hx-get="/partials/candidates-list?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                    hx-target="#candidates-list"
                    hx-swap="innerHTML"
                    class="ml-3 relative inline-flex items-center px-5 py-2.5 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Weiter
            </button>
            {% endif %}
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-base text-gray-700">
                    Zeige
                    <span class="font-medium">{{ ((page - 1) * per_page) + 1 }}</span>
                    bis
                    <span class="font-medium">{{ [page * per_page, total] | min }}</span>
                    von
                    <span class="font-medium">{{ total }}</span>
                    Kandidaten
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    {# Zurueck #}
                    {% if page > 1 %}
                    <button hx-get="/partials/candidates-list?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                            hx-target="#candidates-list"
                            hx-swap="innerHTML"
                            class="relative inline-flex items-center px-3 py-2.5 rounded-l-md border border-gray-300 bg-white text-base font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Zurueck</span>
                        <svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    {% endif %}

                    {# Seitenzahlen #}
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                        <span class="relative z-10 inline-flex items-center px-5 py-2.5 border border-primary-500 bg-primary-50 text-base font-medium text-primary-600">
                            {{ p }}
                        </span>
                        {% elif p == 1 or p == total_pages or (p >= page - 1 and p <= page + 1) %}
                        <button hx-get="/partials/candidates-list?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                                hx-target="#candidates-list"
                                hx-swap="innerHTML"
                                class="relative inline-flex items-center px-5 py-2.5 border border-gray-300 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">
                            {{ p }}
                        </button>
                        {% elif p == 2 or p == total_pages - 1 %}
                        <span class="relative inline-flex items-center px-5 py-2.5 border border-gray-300 bg-white text-base font-medium text-gray-700">
                            ...
                        </span>
                        {% endif %}
                    {% endfor %}

                    {# Weiter #}
                    {% if page < total_pages %}
                    <button hx-get="/partials/candidates-list?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                            hx-target="#candidates-list"
                            hx-swap="innerHTML"
                            class="relative inline-flex items-center px-3 py-2.5 rounded-r-md border border-gray-300 bg-white text-base font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Weiter</span>
                        <svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5-4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

{# JavaScript fuer Multi-Select und Batch-Delete #}
<script>
function toggleSelectionMode() {
    var cols = document.querySelectorAll('.selection-col');
    var btn = document.getElementById('btn-selection-toggle');
    var isActive = !cols[0].classList.contains('hidden');

    if (isActive) {
        exitSelectionMode();
    } else {
        cols.forEach(function(el) { el.classList.remove('hidden'); });
        if (btn) {
            btn.textContent = 'Abbrechen';
            btn.classList.remove('bg-white', 'text-gray-700', 'ring-gray-300', 'hover:bg-gray-50');
            btn.classList.add('bg-gray-200', 'text-gray-900', 'ring-gray-400', 'hover:bg-gray-300');
        }
    }
}

function exitSelectionMode() {
    var cols = document.querySelectorAll('.selection-col');
    cols.forEach(function(el) { el.classList.add('hidden'); });

    // Alle Checkboxen deselektieren
    var checkboxes = document.querySelectorAll('.candidate-checkbox');
    checkboxes.forEach(function(cb) { cb.checked = false; });
    var selectAll = document.getElementById('select-all-candidates');
    if (selectAll) { selectAll.checked = false; selectAll.indeterminate = false; }

    // Batch-Leiste ausblenden
    var batchActions = document.getElementById('batch-actions');
    if (batchActions) { batchActions.classList.add('hidden'); }

    // Button zuruecksetzen
    var btn = document.getElementById('btn-selection-toggle');
    if (btn) {
        btn.textContent = 'Auswaehlen';
        btn.classList.add('bg-white', 'text-gray-700', 'ring-gray-300', 'hover:bg-gray-50');
        btn.classList.remove('bg-gray-200', 'text-gray-900', 'ring-gray-400', 'hover:bg-gray-300');
    }
}

function toggleAllCandidates(selectAllCheckbox) {
    var checkboxes = document.querySelectorAll('.candidate-checkbox');
    checkboxes.forEach(function(cb) {
        cb.checked = selectAllCheckbox.checked;
    });
    updateBatchActions();
}

function updateBatchActions() {
    var checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
    var batchActions = document.getElementById('batch-actions');
    var countSpan = document.getElementById('selected-count');
    var selectAll = document.getElementById('select-all-candidates');

    if (batchActions) {
        if (checkboxes.length > 0) {
            batchActions.classList.remove('hidden');
            countSpan.textContent = checkboxes.length;
        } else {
            batchActions.classList.add('hidden');
        }
    }

    // Update "Select All" checkbox state
    if (selectAll) {
        var allCheckboxes = document.querySelectorAll('.candidate-checkbox');
        selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
    }
}

async function batchParseSelected() {
    var checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
    if (checkboxes.length === 0) return;

    var count = checkboxes.length;
    if (!confirm(count + ' Kandidat(en) CVs neu parsen?\nKostet ca. $0.001 pro CV (OpenAI).')) {
        return;
    }

    var ids = [];
    checkboxes.forEach(function(cb) { ids.push(cb.value); });

    // Button deaktivieren
    var btn = document.getElementById('btn-batch-parse');
    if (btn) { btn.disabled = true; btn.textContent = 'Parsing laeuft...'; }

    var parsed = 0, errors = 0, namesFixed = 0;

    for (var i = 0; i < ids.length; i++) {
        var cid = ids[i];
        var row = document.getElementById('row-' + cid);
        if (!row) continue;

        // Zeile hervorheben: "wird geparst..."
        row.style.transition = 'background-color 0.3s';
        row.style.backgroundColor = '#EFF6FF'; // blue-50
        var nameCell = row.querySelector('td:nth-child(2) .ml-5 .text-lg');
        var origName = nameCell ? nameCell.textContent.trim() : '';
        if (nameCell) {
            nameCell.innerHTML = '<span class="text-primary-600"><svg class="inline w-4 h-4 mr-1 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>CV wird geparst... (' + (i+1) + '/' + ids.length + ')</span>';
        }

        // Zum aktuellen Kandidaten scrollen
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });

        try {
            var response = await fetch('/api/candidates/' + cid + '/reparse-cv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            var data = await response.json();

            if (data.status === 'ok') {
                parsed++;
                if (data.name_changed) {
                    namesFixed++;
                    // Zeile gruen: Name geaendert
                    row.style.backgroundColor = '#F0FDF4'; // green-50
                    if (nameCell) {
                        nameCell.innerHTML = '<span class="text-green-700 font-bold">' + data.new_name + '</span>' +
                            ' <span class="text-xs text-gray-400 line-through ml-2">' + data.old_name + '</span>';
                    }
                    // Avatar-Initialen aktualisieren
                    var avatar = row.querySelector('td:nth-child(2) .text-primary-700');
                    if (avatar && data.new_name.length >= 2) {
                        var parts = data.new_name.split(' ');
                        avatar.textContent = (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
                    }
                } else {
                    // Zeile zuruecksetzen: Name war schon ok
                    row.style.backgroundColor = '#FEFCE8'; // yellow-50
                    if (nameCell) {
                        nameCell.innerHTML = '<span class="text-gray-700">' + data.new_name + '</span>' +
                            ' <span class="text-xs text-yellow-600 ml-2">Name unveraendert</span>';
                    }
                }
            } else if (data.status === 'skipped') {
                row.style.backgroundColor = '#FEF9C3'; // yellow-100
                if (nameCell) {
                    nameCell.innerHTML = origName + ' <span class="text-xs text-yellow-600 ml-2">Kein CV</span>';
                }
            } else {
                errors++;
                row.style.backgroundColor = '#FEF2F2'; // red-50
                if (nameCell) {
                    nameCell.innerHTML = origName + ' <span class="text-xs text-red-600 ml-2">Fehler</span>';
                }
            }
        } catch (e) {
            errors++;
            row.style.backgroundColor = '#FEF2F2';
            if (nameCell) {
                nameCell.innerHTML = origName + ' <span class="text-xs text-red-600 ml-2">Netzwerk-Fehler</span>';
            }
        }
    }

    // Fertig - Button aktualisieren
    if (btn) {
        btn.disabled = false;
        btn.textContent = 'Fertig! ' + parsed + ' geparst, ' + namesFixed + ' Namen korrigiert';
        btn.classList.remove('bg-primary-600', 'hover:bg-primary-500');
        btn.classList.add('bg-green-600', 'hover:bg-green-500');
    }
}

function batchDeleteSelected() {
    var checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
    if (checkboxes.length === 0) return;

    var count = checkboxes.length;
    if (!confirm(count + ' Kandidat(en) wirklich loeschen? Die Kandidaten werden beim naechsten CRM-Sync ignoriert.')) {
        return;
    }

    var ids = [];
    checkboxes.forEach(function(cb) {
        ids.push(cb.value);
    });

    fetch('/api/candidates/batch/delete', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.deleted_count !== undefined) {
            // Auswahl-Modus beenden und Liste neu laden
            exitSelectionMode();
            var perPage = document.getElementById('per-page-select');
            var perPageVal = perPage ? perPage.value : '{{ per_page }}';
            htmx.ajax('GET', '/partials/candidates-list?page={{ page }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page=' + perPageVal, {target:'#candidates-list', swap:'innerHTML'});
        }
    });
}

// ==================== Werdegang Copy ====================

function copyWerdegangFromApi(btn) {
    var candidateId = btn.dataset.candidateId;
    var name = (btn.dataset.name || 'Unbekannt').trim();

    fetch('/api/candidates/' + candidateId)
        .then(function(r) { return r.json(); })
        .then(function(candidate) {
            var data = candidate.work_history || [];
            if (data.length === 0) {
                if (typeof showToast === 'function') showToast('Kein Werdegang vorhanden', 'warning');
                return;
            }

            var lines = ['WERDEGANG - ' + name, ''];

            for (var i = 0; i < data.length; i++) {
                var job = data[i];
                if (!job || typeof job !== 'object') continue;

                var dateRange = '';
                if (job.start_date) {
                    dateRange = job.start_date;
                    dateRange += job.end_date ? ' - ' + job.end_date : ' - heute';
                }
                if (dateRange) lines.push(dateRange);

                lines.push(job.position || job.title || 'Unbekannte Position');
                lines.push(job.company || 'Unbekanntes Unternehmen');
                if (job.description) lines.push(job.description);
                lines.push('');
            }

            var text = lines.join('\n').trim();

            navigator.clipboard.writeText(text).then(function() {
                if (typeof showToast === 'function') showToast('Werdegang kopiert!', 'success');
            }).catch(function() {
                var textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                if (typeof showToast === 'function') showToast('Werdegang kopiert!', 'success');
            });
        })
        .catch(function() {
            if (typeof showToast === 'function') showToast('Fehler beim Laden', 'error');
        });
}

// ==================== Inline Edit ====================

function startInlineEdit(displayEl) {
    var wrapper = displayEl.closest('.inline-edit-wrapper');
    var input = wrapper.querySelector('.inline-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus();
    input.select();
}

function handleInlineEditKey(event, input) {
    if (event.key === 'Enter') {
        input.blur();
    } else if (event.key === 'Escape') {
        // Abbrechen: Originalwert wiederherstellen
        var wrapper = input.closest('.inline-edit-wrapper');
        var display = wrapper.querySelector('.inline-edit-display');
        input.classList.add('hidden');
        display.classList.remove('hidden');
    }
}

function saveInlineEdit(input) {
    var wrapper = input.closest('.inline-edit-wrapper');
    var display = wrapper.querySelector('.inline-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldValue = display.textContent.trim();

    // Platzhalter-Text pruefen
    if (oldValue === 'Keine Position' || oldValue === 'Kein Unternehmen') {
        oldValue = '';
    }

    // Nichts geaendert
    if (newValue === oldValue) {
        input.classList.add('hidden');
        display.classList.remove('hidden');
        return;
    }

    // Speichern via API
    var body = {};
    body[field] = newValue || null;

    fetch('/api/candidates/' + candidateId, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.id) {
            // Erfolgreich gespeichert - Anzeige aktualisieren
            display.textContent = newValue || (field === 'current_position' ? 'Keine Position' : 'Kein Unternehmen');
            if (newValue) {
                display.classList.remove('text-gray-400', 'italic');
                if (field === 'current_position') {
                    display.classList.add('font-medium');
                }
            } else {
                display.classList.add('text-gray-400', 'italic');
                display.classList.remove('font-medium');
            }
        }
    })
    .catch(function() {
        // Bei Fehler: Originalwert wiederherstellen
        input.value = oldValue;
    })
    .finally(function() {
        input.classList.add('hidden');
        display.classList.remove('hidden');
    });
}
</script>
