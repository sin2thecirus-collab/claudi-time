{# Kandidaten-Liste Partial fuer HTMX — Pulspoint Design #}

{# Hidden stats data element for the shell page to read #}
<div id="kl-stats-data" class="hidden"
     data-total="{{ total }}"
     data-page="{{ page }}"
     data-per-page="{{ per_page }}"
     data-total-pages="{{ total_pages }}"></div>

{% if candidates | length == 0 %}
{# ── Empty State ── #}
<div style="padding: 60px 20px; text-align: center;">
    <div style="width: 56px; height: 56px; border-radius: 16px; background: linear-gradient(135deg, #eef2ff, #e0e7ff); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
        <svg style="width: 28px; height: 28px; color: #818cf8;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
        </svg>
    </div>
    <p style="font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">Keine Kandidaten gefunden</p>
    <p style="font-size: 13px; color: #94a3b8; max-width: 320px; margin: 0 auto;">
        {% if search %}
        Keine Kandidaten für "{{ search }}" gefunden. Versuche andere Suchbegriffe.
        {% else %}
        Keine Kandidaten vorhanden. Erstellen Sie einen neuen Kandidaten ueber Quick-Add.
        {% endif %}
    </p>
</div>
{% else %}

{# ── Batch Actions Bar (hidden by default, shown when candidates selected) ── #}
<div id="batch-actions" class="hidden" style="padding: 0 16px;">
    <div class="kl-batch-bar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 13px; font-weight: 700; color: #fff;">
                <span id="selected-count">0</span> ausgewählt
            </span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <button type="button" id="btn-batch-parse" onclick="batchParseSelected()" class="kl-batch-bar-btn kl-batch-bar-btn-primary">
                <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v16.5c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9zm3.75 11.625a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                </svg>
                CV neu parsen
            </button>
            <button type="button" onclick="batchDeleteSelected()" class="kl-batch-bar-btn kl-batch-bar-btn-danger">
                <svg style="width: 14px; height: 14px;" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                </svg>
                Löschen
            </button>
        </div>
    </div>
</div>

{# ── Table ── #}
<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
    <colgroup>
        <col class="selection-col hidden" style="width: 44px;">
        <col style="width: 28%;">  {# Name #}
        <col style="width: 18%;">  {# Position #}
        <col style="width: 15%;">  {# Unternehmen #}
        <col style="width: 12%;">  {# Stadt #}
        <col style="width: 10%;">  {# Status #}
        <col style="width: 5%;">   {# CV #}
        <col style="width: 12%;">  {# Aktionen #}
    </colgroup>
    <thead>
        <tr>
            <th class="kl-th selection-col hidden" style="width: 44px; padding-left: 18px;">
                <input type="checkbox"
                       id="select-all-candidates"
                       onchange="toggleAllCandidates(this)"
                       style="width: 16px; height: 16px; border-radius: 4px; cursor: pointer; accent-color: #6366f1;">
            </th>
            <th class="kl-th" style="padding-left: 18px;">Name</th>
            <th class="kl-th">Position</th>
            <th class="kl-th">Unternehmen</th>
            <th class="kl-th">Stadt</th>
            <th class="kl-th">Status</th>
            <th class="kl-th" style="text-align: center;">CV</th>
            <th class="kl-th" style="text-align: right; padding-right: 18px;">Aktionen</th>
        </tr>
    </thead>
    <tbody>
        {% set avatar_colors = ['#818cf8', '#f472b6', '#34d399', '#fbbf24', '#60a5fa', '#a78bfa', '#f87171', '#2dd4bf'] %}
        {% for candidate in candidates %}
        {% set color_idx = loop.index0 % avatar_colors | length %}

        {# ── Data Quality: Name normalisieren ── #}
        {% set raw_first = candidate.first_name or '' %}
        {% set raw_last = candidate.last_name or '' %}
        {# "Not Available", "N/A", etc. als ungültig behandeln #}
        {% set invalid_names = ['not available', 'n/a', 'na', 'none', 'null', '-', '—'] %}
        {% set first_valid = raw_first if raw_first | lower | trim not in invalid_names else '' %}
        {% set last_valid = raw_last if raw_last | lower | trim not in invalid_names else '' %}
        {# ALL CAPS → Title Case (inline statt if/else wg. Jinja2 Scoping) #}
        {% set first_display = (first_valid | title) if (first_valid == first_valid | upper and first_valid | length > 1) else first_valid %}
        {% set last_display = (last_valid | title) if (last_valid == last_valid | upper and last_valid | length > 1) else last_valid %}
        {% set has_valid_name = first_display or last_display %}
        {% set display_name = ((first_display ~ ' ' ~ last_display) | trim) if has_valid_name else 'Unbekannt' %}

        {# ── Data Quality: Position kürzen wenn zu lang (Beschreibung statt Titel) ── #}
        {% set raw_position = candidate.current_position or '' %}
        {% set position_display = raw_position[:45] ~ '…' if raw_position | length > 48 else raw_position %}

        <tr id="row-{{ candidate.id }}"
            class="kl-row {% if candidate.hidden %}kl-row-hidden{% endif %}"
            style="animation-delay: {{ loop.index0 * 0.03 }}s; {% if candidate.hidden %}opacity: 0.5;{% endif %}"
            onclick="window.location='/kandidaten/{{ candidate.id }}'">

            {# Checkbox #}
            <td class="selection-col hidden" style="padding-left: 18px; width: 44px;" onclick="event.stopPropagation()">
                <input type="checkbox"
                       class="candidate-checkbox"
                       value="{{ candidate.id }}"
                       onchange="updateBatchActions()"
                       style="width: 16px; height: 16px; border-radius: 4px; cursor: pointer; accent-color: #6366f1;">
            </td>

            {# Name + Avatar + Skills #}
            <td style="padding-left: 18px; overflow: hidden;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="kl-avatar" style="background: {{ avatar_colors[color_idx] }}; color: #fff;">
                        {{ (first_display or 'X')[0] | upper }}{{ (last_display or 'X')[0] | upper }}
                    </div>
                    <div style="min-width: 0; overflow: hidden;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span class="kl-name-text" style="font-size: 13.5px; font-weight: 700; color: {% if has_valid_name %}#0f172a{% else %}#94a3b8{% endif %}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; {% if not has_valid_name %}font-style: italic;{% endif %}">
                                {{ display_name }}
                            </span>
                            {% if candidate.age %}
                            <span style="font-size: 11px; color: #94a3b8; font-weight: 500;">({{ candidate.age }})</span>
                            {% endif %}
                        </div>
                        {# Skill Tags (max 3) #}
                        {% if candidate.it_skills %}
                        <div style="display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap;">
                            {% for skill in candidate.it_skills[:3] %}
                            {% set sk_low = skill | lower %}
                            {% set is_tech = 'python' in sk_low or 'java' in sk_low or 'react' in sk_low or 'node' in sk_low or 'docker' in sk_low or 'aws' in sk_low or 'azure' in sk_low or 'sql' in sk_low or 'linux' in sk_low or 'git' in sk_low or 'html' in sk_low or 'css' in sk_low or 'typescript' in sk_low or 'c++' in sk_low or 'c#' in sk_low or '.net' in sk_low or 'angular' in sk_low or 'vue' in sk_low or 'kubernetes' in sk_low or 'terraform' in sk_low %}
                            {% set is_fach = 'sap' in sk_low or 'datev' in sk_low or 'ifrs' in sk_low or 'hgb' in sk_low or 'gaap' in sk_low or 'controlling' in sk_low or 'buchhaltung' in sk_low or 'tagetik' in sk_low or 'lucanet' in sk_low or 'konsolidierung' in sk_low or 'hyperion' in sk_low or 'cognos' in sk_low or 'excel' in sk_low or 'power bi' in sk_low or 'tableau' in sk_low %}
                            <span class="kl-skill-tag {% if is_tech %}kl-skill-tag-tech{% elif is_fach %}kl-skill-tag-fach{% endif %}">{{ skill }}</span>
                            {% endfor %}
                            {% if candidate.it_skills | length > 3 %}
                            <span style="font-size: 11px; color: #94a3b8; font-weight: 500;">+{{ candidate.it_skills | length - 3 }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </td>

            {# Position (editable) — truncated with tooltip if long #}
            <td onclick="event.stopPropagation()" style="overflow: hidden;">
                <div class="inline-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_position">
                    <span class="inline-edit-display kl-inline-display"
                          onclick="startInlineEdit(this)"
                          title="{{ raw_position if raw_position else 'Klicken zum Bearbeiten' }}"
                          style="font-size: 13px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; {% if position_display %}color: #334155; font-weight: 600;{% else %}color: #cbd5e1; font-style: italic;{% endif %}">{{ position_display or '—' }}</span>
                    <input type="text"
                           class="inline-edit-input kl-inline-input hidden"
                           value="{{ raw_position }}"
                           onblur="saveInlineEdit(this)"
                           onkeydown="handleInlineEditKey(event, this)">
                </div>
            </td>

            {# Company (editable) #}
            {% set raw_company = candidate.current_company or '' %}
            {% set company_invalid = raw_company | lower | trim in ['not available', 'n/a', 'na', 'none', 'null', '-', '—', 'kein unternehmen'] %}
            {% set company_display = '' if company_invalid else raw_company %}
            <td onclick="event.stopPropagation()" style="overflow: hidden;">
                <div class="inline-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_company">
                    <span class="inline-edit-display kl-inline-display"
                          onclick="startInlineEdit(this)"
                          title="{{ raw_company if raw_company else 'Klicken zum Bearbeiten' }}"
                          style="font-size: 13px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; {% if company_display %}color: #64748b;{% else %}color: #cbd5e1; font-style: italic;{% endif %}">{{ company_display or '—' }}</span>
                    <input type="text"
                           class="inline-edit-input kl-inline-input hidden"
                           value="{{ company_display }}"
                           onblur="saveInlineEdit(this)"
                           onkeydown="handleInlineEditKey(event, this)">
                </div>
            </td>

            {# City — nur Stadt anzeigen, "Keine Adresse" → "—" #}
            {% set raw_city = candidate.city or '' %}
            {% set city_invalid = raw_city | lower | trim in ['not available', 'n/a', 'na', 'none', 'null', '-', '—', 'keine adresse'] %}
            {% set city_display = '' if city_invalid else raw_city %}
            <td style="overflow: hidden;">
                {% if city_display %}
                <div style="display: flex; align-items: center; gap: 4px; overflow: hidden;">
                    <svg style="width: 12px; height: 12px; color: #cbd5e1; flex-shrink: 0;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                    </svg>
                    <span style="font-size: 13px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ city_display }}</span>
                </div>
                {% else %}
                <span style="font-size: 13px; color: #cbd5e1;">—</span>
                {% endif %}
            </td>

            {# Status #}
            <td>
                {% if candidate.hidden %}
                <span class="kl-status kl-status-hidden">
                    <span class="kl-status-dot"></span>
                    Ausgeblendet
                </span>
                {% elif candidate.is_active %}
                <span class="kl-status kl-status-active">
                    <span class="kl-status-dot"></span>
                    Aktiv
                </span>
                {% else %}
                <span class="kl-status kl-status-inactive">
                    <span class="kl-status-dot"></span>
                    Inaktiv
                </span>
                {% endif %}
            </td>

            {# CV Indicator #}
            <td style="text-align: center;">
                {% if candidate.cv_url or candidate.cv_stored_path %}
                <svg class="kl-cv-yes" style="width: 18px; height: 18px; margin: 0 auto;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                {% else %}
                <svg class="kl-cv-no" style="width: 18px; height: 18px; margin: 0 auto;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                {% endif %}
            </td>

            {# Actions #}
            <td style="text-align: right; padding-right: 18px;">
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 2px;">
                    {% if candidate.work_history and candidate.work_history | length > 0 %}
                    <button type="button"
                            data-candidate-id="{{ candidate.id }}"
                            data-name="{{ candidate.first_name or '' }} {{ candidate.last_name or '' }}"
                            onclick="event.stopPropagation(); copyWerdegangFromApi(this)"
                            class="kl-action-btn kl-action-btn-primary"
                            title="Profil kopieren">
                        <svg style="width: 15px; height: 15px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                        </svg>
                    </button>
                    {% endif %}
                    <a href="/kandidaten/{{ candidate.id }}"
                       onclick="event.stopPropagation()"
                       class="kl-action-btn"
                       title="Details anzeigen">
                        <svg style="width: 15px; height: 15px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                    </a>
                    <button hx-delete="/api/candidates/{{ candidate.id }}"
                            hx-confirm="Kandidat {{ candidate.first_name }} {{ candidate.last_name }} wirklich l&ouml;schen?"
                            hx-swap="none"
                            hx-on::after-request="if(event.detail.successful) htmx.ajax('GET', '/partials/candidates-list?page={{ page }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}', {target:'#candidates-list', swap:'innerHTML'})"
                            class="kl-action-btn kl-action-btn-danger"
                            onclick="event.stopPropagation()"
                            title="Kandidat löschen">
                        <svg style="width: 15px; height: 15px;" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{# ── Pagination ── #}
{% if total_pages > 1 %}
<div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 22px; border-top: 1px solid #f0f2f5;">
    {# Info Text #}
    <span style="font-size: 12.5px; color: #94a3b8; font-weight: 500;">
        Zeige <span style="font-weight: 700; color: #64748b;">{{ ((page - 1) * per_page) + 1 }}</span>–<span style="font-weight: 700; color: #64748b;">{{ [page * per_page, total] | min }}</span> von <span style="font-weight: 700; color: #64748b;">{{ total }}</span>
    </span>

    {# Page Buttons #}
    <div style="display: flex; align-items: center; gap: 6px;">
        {# Previous #}
        {% if page > 1 %}
        <button hx-get="/partials/candidates-list?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                hx-target="#candidates-list"
                hx-swap="innerHTML"
                class="kl-page-btn" style="padding: 0 10px;">
            <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
        </button>
        {% else %}
        <span class="kl-page-btn kl-page-btn-disabled" style="padding: 0 10px;">
            <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
        </span>
        {% endif %}

        {# Page Numbers #}
        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="kl-page-btn kl-page-btn-active">{{ p }}</span>
            {% elif p == 1 or p == total_pages or (p >= page - 1 and p <= page + 1) %}
            <button hx-get="/partials/candidates-list?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                    hx-target="#candidates-list"
                    hx-swap="innerHTML"
                    class="kl-page-btn">{{ p }}</button>
            {% elif p == 2 or p == total_pages - 1 %}
            <span style="font-size: 13px; color: #cbd5e1; padding: 0 4px;">…</span>
            {% endif %}
        {% endfor %}

        {# Next #}
        {% if page < total_pages %}
        <button hx-get="/partials/candidates-list?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page={{ per_page }}"
                hx-target="#candidates-list"
                hx-swap="innerHTML"
                class="kl-page-btn" style="padding: 0 10px;">
            <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
        </button>
        {% else %}
        <span class="kl-page-btn kl-page-btn-disabled" style="padding: 0 10px;">
            <svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
        </span>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}

{# ════════════════════════════════════════════════════
   JAVASCRIPT - Selection, Batch, Copy, Inline Edit
════════════════════════════════════════════════════ #}
<script>
// ==================== Selection Mode ====================
function toggleSelectionMode() {
    var cols = document.querySelectorAll('.selection-col');
    var btn = document.getElementById('btn-selection-toggle');
    var isActive = cols.length > 0 && !cols[0].classList.contains('hidden');

    if (isActive) {
        exitSelectionMode();
    } else {
        cols.forEach(function(el) { el.classList.remove('hidden'); });
        if (btn) {
            btn.innerHTML = '<svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> Abbrechen';
            btn.classList.add('kl-select-btn-active');
        }
    }
}

function exitSelectionMode() {
    var cols = document.querySelectorAll('.selection-col');
    cols.forEach(function(el) { el.classList.add('hidden'); });

    var checkboxes = document.querySelectorAll('.candidate-checkbox');
    checkboxes.forEach(function(cb) { cb.checked = false; });
    var selectAll = document.getElementById('select-all-candidates');
    if (selectAll) { selectAll.checked = false; selectAll.indeterminate = false; }

    var batchActions = document.getElementById('batch-actions');
    if (batchActions) { batchActions.classList.add('hidden'); }

    // Remove selected row highlighting
    document.querySelectorAll('.kl-row.kl-selected').forEach(function(row) {
        row.classList.remove('kl-selected');
    });

    var btn = document.getElementById('btn-selection-toggle');
    if (btn) {
        btn.innerHTML = '<svg style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Auswählen';
        btn.classList.remove('kl-select-btn-active');
    }
}

function toggleAllCandidates(selectAllCheckbox) {
    var checkboxes = document.querySelectorAll('.candidate-checkbox');
    checkboxes.forEach(function(cb) {
        cb.checked = selectAllCheckbox.checked;
        var row = cb.closest('.kl-row');
        if (row) {
            if (cb.checked) row.classList.add('kl-selected');
            else row.classList.remove('kl-selected');
        }
    });
    updateBatchActions();
}

function updateBatchActions() {
    var checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
    var batchActions = document.getElementById('batch-actions');
    var countSpan = document.getElementById('selected-count');
    var selectAll = document.getElementById('select-all-candidates');

    // Update row highlighting
    document.querySelectorAll('.candidate-checkbox').forEach(function(cb) {
        var row = cb.closest('.kl-row');
        if (row) {
            if (cb.checked) row.classList.add('kl-selected');
            else row.classList.remove('kl-selected');
        }
    });

    if (batchActions) {
        if (checkboxes.length > 0) {
            batchActions.classList.remove('hidden');
            countSpan.textContent = checkboxes.length;
        } else {
            batchActions.classList.add('hidden');
        }
    }

    if (selectAll) {
        var allCheckboxes = document.querySelectorAll('.candidate-checkbox');
        selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
    }
}

// ==================== Batch Parse ====================
async function batchParseSelected() {
    var checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
    if (checkboxes.length === 0) return;

    var count = checkboxes.length;
    if (!confirm(count + ' Kandidat(en) CVs neu parsen?\nKostet ca. $0.001 pro CV (OpenAI).')) {
        return;
    }

    var ids = [];
    checkboxes.forEach(function(cb) { ids.push(cb.value); });

    var btn = document.getElementById('btn-batch-parse');
    if (btn) { btn.disabled = true; btn.textContent = 'Parsing läuft...'; }

    var parsed = 0, errors = 0, namesFixed = 0;

    for (var i = 0; i < ids.length; i++) {
        var cid = ids[i];
        var row = document.getElementById('row-' + cid);
        if (!row) continue;

        row.style.transition = 'background-color 0.3s';
        row.style.backgroundColor = '#eef2ff';
        var nameCell = row.querySelector('.kl-name-text');
        var origName = nameCell ? nameCell.textContent.trim() : '';
        if (nameCell) {
            nameCell.innerHTML = '<span style="color: #6366f1;"><svg style="display: inline; width: 14px; height: 14px; margin-right: 4px; animation: spin 1s linear infinite;" fill="none" viewBox="0 0 24 24"><circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>CV wird geparst... (' + (i+1) + '/' + ids.length + ')</span>';
        }

        row.scrollIntoView({ behavior: 'smooth', block: 'center' });

        try {
            var response = await fetch('/api/candidates/' + cid + '/reparse-cv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            var data = await response.json();

            if (data.status === 'ok') {
                parsed++;
                if (data.name_changed) {
                    namesFixed++;
                    row.style.backgroundColor = '#ecfdf5';
                    if (nameCell) {
                        nameCell.innerHTML = '<span style="color: #059669; font-weight: 700;">' + data.new_name + '</span>' +
                            ' <span style="font-size: 11px; color: #94a3b8; text-decoration: line-through; margin-left: 6px;">' + data.old_name + '</span>';
                    }
                    var avatar = row.querySelector('.kl-avatar');
                    if (avatar && data.new_name.length >= 2) {
                        var parts = data.new_name.split(' ');
                        avatar.textContent = (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
                    }
                } else {
                    row.style.backgroundColor = '#fefce8';
                    if (nameCell) {
                        nameCell.innerHTML = '<span style="color: #334155;">' + data.new_name + '</span>' +
                            ' <span style="font-size: 11px; color: #a16207; margin-left: 6px;">Name unverändert</span>';
                    }
                }
            } else if (data.status === 'skipped') {
                row.style.backgroundColor = '#fefce8';
                if (nameCell) {
                    nameCell.innerHTML = origName + ' <span style="font-size: 11px; color: #a16207; margin-left: 6px;">Kein CV</span>';
                }
            } else {
                errors++;
                row.style.backgroundColor = '#fef2f2';
                if (nameCell) {
                    nameCell.innerHTML = origName + ' <span style="font-size: 11px; color: #dc2626; margin-left: 6px;">Fehler</span>';
                }
            }
        } catch (e) {
            errors++;
            row.style.backgroundColor = '#fef2f2';
            if (nameCell) {
                nameCell.innerHTML = origName + ' <span style="font-size: 11px; color: #dc2626; margin-left: 6px;">Netzwerk-Fehler</span>';
            }
        }
    }

    if (btn) {
        btn.disabled = false;
        btn.innerHTML = '✓ ' + parsed + ' geparst, ' + namesFixed + ' korrigiert';
    }
}

// ==================== Batch Delete ====================
function batchDeleteSelected() {
    var checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
    if (checkboxes.length === 0) return;

    var count = checkboxes.length;
    if (!confirm(count + ' Kandidat(en) wirklich l\u00f6schen?')) {
        return;
    }

    var ids = [];
    checkboxes.forEach(function(cb) { ids.push(cb.value); });

    fetch('/api/candidates/batch/delete', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.deleted_count !== undefined) {
            exitSelectionMode();
            var perPage = document.getElementById('per-page-select');
            var perPageVal = perPage ? perPage.value : '{{ per_page }}';
            htmx.ajax('GET', '/partials/candidates-list?page={{ page }}{% if search %}&search={{ search }}{% endif %}{% if position %}&position={{ position }}{% endif %}{% if skills %}&skills={{ skills }}{% endif %}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}&per_page=' + perPageVal, {target:'#candidates-list', swap:'innerHTML'});
        }
    });
}

// ==================== Werdegang Copy ====================
function buildFullProfileText(name, workHistory, itSkills, languages, furtherEdu, education, skills) {
    var lines = [];
    var hasContent = false;

    if (workHistory && workHistory.length > 0) {
        hasContent = true;
        lines.push('--- BERUFSERFAHRUNG ---');
        lines.push('');
        for (var i = 0; i < workHistory.length; i++) {
            var job = workHistory[i];
            if (!job || typeof job !== 'object') continue;
            var dateRange = '';
            if (job.start_date) {
                dateRange = job.start_date;
                dateRange += job.end_date ? ' - ' + job.end_date : ' - heute';
            }
            if (dateRange) lines.push(dateRange);
            lines.push(job.position || job.title || 'Unbekannte Position');
            lines.push(job.company || 'Unbekanntes Unternehmen');
            if (job.description) lines.push(job.description);
            lines.push('');
        }
    }

    if (itSkills && itSkills.length > 0) {
        hasContent = true;
        lines.push('--- IT-KENNTNISSE ---');
        lines.push(itSkills.join(', '));
        lines.push('');
    }

    if (languages && languages.length > 0) {
        hasContent = true;
        lines.push('--- SPRACHEN ---');
        for (var i = 0; i < languages.length; i++) {
            var lang = languages[i];
            if (!lang || typeof lang !== 'object') continue;
            var langLine = lang.language || 'Unbekannt';
            if (lang.level) langLine += ' (' + lang.level + ')';
            lines.push(langLine);
        }
        lines.push('');
    }

    if (furtherEdu && furtherEdu.length > 0) {
        hasContent = true;
        lines.push('--- ZERTIFIKATE & WEITERBILDUNGEN ---');
        for (var i = 0; i < furtherEdu.length; i++) {
            var wb = furtherEdu[i];
            if (!wb || typeof wb !== 'object') continue;
            var wbTitle = wb.degree || wb.qualification || 'Weiterbildung';
            var wbInst = wb.institution || '';
            var wbDate = wb.year || wb.end_date || '';
            var wbLine = wbTitle;
            if (wbInst) wbLine += ' | ' + wbInst;
            if (wbDate) wbLine += ' | ' + wbDate;
            lines.push(wbLine);
        }
        lines.push('');
    }

    if (education && education.length > 0) {
        hasContent = true;
        lines.push('--- AUSBILDUNG ---');
        for (var i = 0; i < education.length; i++) {
            var edu = education[i];
            if (!edu || typeof edu !== 'object') continue;
            var eduTitle = edu.degree || edu.qualification || 'Ausbildung';
            var eduInst = edu.institution || edu.school || '';
            var eduDate = edu.year || edu.end_date || '';
            var eduLine = eduTitle;
            if (eduInst) eduLine += ' | ' + eduInst;
            if (eduDate) eduLine += ' | ' + eduDate;
            lines.push(eduLine);
        }
        lines.push('');
    }

    if (skills && skills.length > 0) {
        hasContent = true;
        lines.push('--- SKILLS & KENNTNISSE ---');
        lines.push(skills.join(', '));
        lines.push('');
    }

    if (!hasContent) return null;
    return lines.join('\n').trim();
}

function copyWerdegangFromApi(btn) {
    var candidateId = btn.dataset.candidateId;
    var name = (btn.dataset.name || 'Unbekannt').trim();

    fetch('/api/candidates/' + candidateId)
        .then(function(r) { return r.json(); })
        .then(function(candidate) {
            var text = buildFullProfileText(
                name,
                candidate.work_history || [],
                candidate.it_skills || [],
                candidate.languages || [],
                candidate.further_education || [],
                candidate.education || [],
                candidate.skills || []
            );

            if (!text) {
                if (typeof showToast === 'function') showToast('Kein Profil vorhanden', 'warning');
                return;
            }

            navigator.clipboard.writeText(text).then(function() {
                if (typeof showToast === 'function') showToast('Profil kopiert!', 'success');
            }).catch(function() {
                var textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                if (typeof showToast === 'function') showToast('Profil kopiert!', 'success');
            });
        })
        .catch(function() {
            if (typeof showToast === 'function') showToast('Fehler beim Laden', 'error');
        });
}

// ==================== Inline Edit ====================
function startInlineEdit(displayEl) {
    var wrapper = displayEl.closest('.inline-edit-wrapper');
    var input = wrapper.querySelector('.inline-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus();
    input.select();
}

function handleInlineEditKey(event, input) {
    if (event.key === 'Enter') {
        input.blur();
    } else if (event.key === 'Escape') {
        var wrapper = input.closest('.inline-edit-wrapper');
        var display = wrapper.querySelector('.inline-edit-display');
        input.classList.add('hidden');
        display.classList.remove('hidden');
    }
}

function saveInlineEdit(input) {
    var wrapper = input.closest('.inline-edit-wrapper');
    var display = wrapper.querySelector('.inline-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldValue = display.textContent.trim();

    if (oldValue === '—') oldValue = '';

    if (newValue === oldValue) {
        input.classList.add('hidden');
        display.classList.remove('hidden');
        return;
    }

    var body = {};
    body[field] = newValue || null;

    fetch('/api/candidates/' + candidateId, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.id) {
            display.textContent = newValue || '—';
            if (newValue) {
                display.style.color = field === 'current_position' ? '#334155' : '#64748b';
                display.style.fontWeight = field === 'current_position' ? '600' : '';
                display.style.fontStyle = 'normal';
            } else {
                display.style.color = '#cbd5e1';
                display.style.fontStyle = 'italic';
                display.style.fontWeight = '';
            }
        }
    })
    .catch(function() {
        input.value = oldValue;
    })
    .finally(function() {
        input.classList.add('hidden');
        display.classList.remove('hidden');
    });
}
</script>
