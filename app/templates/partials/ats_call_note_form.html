{# Partial: ATS Call Note Form - Anruf-Notiz erstellen (fuer Modal) #}
{# Context: standalone form, no specific context needed #}

<form hx-post="/api/ats/calls"
      hx-target="#call-notes-list"
      hx-swap="innerHTML"
      hx-indicator="#call-form-spinner"
      x-data="{
          callType: '',
          summary: '',
          rawNotes: '',
          durationMinutes: '',
          actionItems: '',
          companyId: '',
          companySearch: '',
          companyResults: [],
          searching: false,
          isValid() { return this.callType !== '' && this.summary.trim() !== ''; },
          async searchCompanies() {
              if (this.companySearch.length < 2) { this.companyResults = []; return; }
              this.searching = true;
              try {
                  const res = await fetch('/api/companies/search?q=' + encodeURIComponent(this.companySearch) + '&limit=5');
                  if (res.ok) { this.companyResults = await res.json(); }
              } catch(e) { console.error(e); }
              this.searching = false;
          },
          selectCompany(company) {
              this.companyId = company.id;
              this.companySearch = company.name;
              this.companyResults = [];
          }
      }"
      class="space-y-4">

    {# Call Type #}
    <div>
        <label for="call_type" class="block text-sm font-medium text-gray-700 mb-1">
            Art des Anrufs <span class="text-red-500">*</span>
        </label>
        <select id="call_type"
                name="call_type"
                x-model="callType"
                required
                class="w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-primary-500 focus:ring-primary-500">
            <option value="">-- Bitte waehlen --</option>
            <option value="acquisition">Akquise</option>
            <option value="qualification">Qualifizierung</option>
            <option value="followup">Nachfassen</option>
            <option value="candidate_call">Kandidatengespraech</option>
        </select>
    </div>

    {# Company Search #}
    <div class="relative">
        <label for="company_search" class="block text-sm font-medium text-gray-700 mb-1">
            Unternehmen
        </label>
        <input type="hidden" name="company_id" :value="companyId">
        <input type="text"
               id="company_search"
               x-model="companySearch"
               @input.debounce.300ms="searchCompanies()"
               @focus="if (companySearch.length >= 2) searchCompanies()"
               placeholder="Unternehmen suchen..."
               autocomplete="off"
               class="w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-primary-500 focus:ring-primary-500">

        {# Search Results Dropdown #}
        <div x-show="companyResults.length > 0"
             x-cloak
             @click.outside="companyResults = []"
             class="absolute z-20 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 max-h-40 overflow-y-auto">
            <template x-for="company in companyResults" :key="company.id">
                <button @click="selectCompany(company)"
                        type="button"
                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 border-b border-gray-100 last:border-0">
                    <span x-text="company.name" class="font-medium"></span>
                    <span x-show="company.city" x-text="' - ' + company.city" class="text-gray-400"></span>
                </button>
            </template>
        </div>

        {# Searching indicator #}
        <div x-show="searching" x-cloak class="absolute right-3 top-8">
            <svg class="animate-spin w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
        </div>
    </div>

    {# Summary #}
    <div>
        <label for="call_summary" class="block text-sm font-medium text-gray-700 mb-1">
            Zusammenfassung <span class="text-red-500">*</span>
        </label>
        <textarea id="call_summary"
                  name="summary"
                  x-model="summary"
                  required
                  rows="3"
                  placeholder="Wichtigste Punkte des Gespraeches..."
                  class="w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
    </div>

    {# Raw Notes #}
    <div>
        <label for="raw_notes" class="block text-sm font-medium text-gray-700 mb-1">
            Rohe Notizen
        </label>
        <textarea id="raw_notes"
                  name="raw_notes"
                  x-model="rawNotes"
                  rows="4"
                  placeholder="Detaillierte Notizen, Stichpunkte..."
                  class="w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
    </div>

    {# Duration #}
    <div>
        <label for="duration_minutes" class="block text-sm font-medium text-gray-700 mb-1">
            Dauer (Minuten)
        </label>
        <input type="number"
               id="duration_minutes"
               name="duration_minutes"
               x-model="durationMinutes"
               min="1"
               max="480"
               placeholder="z.B. 15"
               class="w-32 rounded-lg border-gray-300 shadow-sm text-sm focus:border-primary-500 focus:ring-primary-500">
    </div>

    {# Action Items #}
    <div>
        <label for="action_items" class="block text-sm font-medium text-gray-700 mb-1">
            Naechste Schritte
        </label>
        <textarea id="action_items"
                  name="action_items"
                  x-model="actionItems"
                  rows="3"
                  placeholder="Ein Punkt pro Zeile:&#10;Angebot senden&#10;Termin vereinbaren&#10;CV anfordern"
                  class="w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
        <p class="mt-1 text-xs text-gray-400">Ein Punkt pro Zeile</p>
    </div>

    {# Submit #}
    <div class="flex items-center justify-end gap-3 pt-2 border-t border-gray-100">
        {# Loading spinner #}
        <div id="call-form-spinner" class="htmx-indicator">
            <svg class="animate-spin w-5 h-5 text-primary-500" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
        </div>

        <button type="submit"
                :disabled="!isValid()"
                :class="isValid() ? 'bg-primary-600 hover:bg-primary-700 cursor-pointer' : 'bg-gray-300 cursor-not-allowed'"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-white transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
            </svg>
            Anruf speichern
        </button>
    </div>
</form>
