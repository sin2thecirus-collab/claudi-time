{# Partial: Aufgaben eines Kontakts — interaktiv #}

{% if todos and todos | length > 0 %}
<div style="display:flex;flex-direction:column;gap:12px;">
    {% for todo in todos %}
    <div x-data="{ open: false, editing: false, saving: false,
                   editTitle: '{{ todo.title | replace("'", "\\'") }}',
                   editDesc: '{{ (todo.description or '') | replace("'", "\\'") | replace('\n', '\\n') }}',
                   editPriority: '{{ todo.priority.value }}',
                   editStatus: '{{ todo.status.value }}',
                   editDueDate: '{{ todo.due_date.isoformat() if todo.due_date else '' }}',
                   editDueTime: '{{ todo.due_time or '' }}' }"
         style="border-radius:12px;border:1px solid {% if todo.status.value == 'done' %}rgba(52,211,153,0.25){% elif todo.is_overdue %}rgba(239,68,68,0.25){% else %}var(--pp-border){% endif %};background:{% if todo.status.value == 'done' %}rgba(52,211,153,0.08){% elif todo.is_overdue %}rgba(239,68,68,0.08){% else %}var(--pp-surface){% endif %};overflow:hidden;transition:all .2s;">

        {# ── Aufgaben-Kopfzeile (immer sichtbar, klickbar) ── #}
        <div @click="open = !open" style="padding:18px 20px;cursor:pointer;display:flex;align-items:flex-start;gap:14px;">
            {# Checkbox/Status-Icon #}
            <button @click.stop="
                var newStatus = editStatus === 'done' ? 'open' : 'done';
                fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:newStatus})})
                .then(function(r){if(r.ok){showToast(newStatus==='done'?'Erledigt':'Wieder geöffnet','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});
            " type="button" style="margin-top:4px;flex-shrink:0;width:40px;height:40px;border-radius:50%;border:3px solid {% if todo.status.value == 'done' %}var(--pp-green){% elif todo.is_overdue %}var(--pp-red){% else %}var(--pp-textDim){% endif %};background:{% if todo.status.value == 'done' %}var(--pp-green){% else %}transparent{% endif %};display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;" title="{% if todo.status.value == 'done' %}Wieder öffnen{% else %}Als erledigt markieren{% endif %}">
                {% if todo.status.value == 'done' %}
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>
                {% endif %}
            </button>

            {# Inhalt #}
            <div style="flex:1;min-width:0;">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <span style="font-size:28px;font-weight:600;color:{% if todo.status.value == 'done' %}var(--pp-textDim){% else %}var(--pp-text){% endif %};{% if todo.status.value == 'done' %}text-decoration:line-through;{% endif %}font-family:var(--pp-ff);line-height:1.2;">{{ todo.title }}</span>
                    {# Priority Badge #}
                    {% set prio_map = {'unwichtig': ('Unwichtig','var(--pp-textMuted)','var(--pp-surfaceHover)'), 'mittelmaessig': ('Mittelmäßig','var(--pp-accent)','var(--pp-accentSoft)'), 'wichtig': ('Wichtig','var(--pp-orange)','var(--pp-orangeSoft)'), 'dringend': ('Dringend','#f97316','rgba(249,115,22,0.12)'), 'sehr_dringend': ('Sehr dringend','var(--pp-red)','var(--pp-redSoft)')} %}
                    {% set pl, pc, pbg = prio_map.get(todo.priority.value, ('','var(--pp-textMuted)','var(--pp-surfaceHover)')) %}
                    <span style="font-size:22px;font-weight:600;color:{{ pc }};background:{{ pbg }};padding:4px 14px;border-radius:99px;font-family:var(--pp-ff);">{{ pl }}</span>
                </div>
                {# Meta-Zeile: Datum + Links #}
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:6px;">
                    {% if todo.due_date %}
                    <span style="font-size:22px;white-space:nowrap;color:{% if todo.is_overdue %}var(--pp-red);font-weight:600{% else %}var(--pp-textDim){% endif %};display:inline-flex;align-items:center;gap:5px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>
                        {% if todo.is_overdue %}Überfällig{% endif %} {{ todo.due_date.strftime('%d.%m.%Y') }}{% if todo.due_time %} {{ todo.due_time }} Uhr{% endif %}
                    </span>
                    {% endif %}
                    {% if todo.company %}
                    <span style="color:var(--pp-textDim);font-size:22px;">·</span>
                    <a href="/unternehmen/{{ todo.company_id }}" @click.stop style="font-size:22px;white-space:nowrap;color:var(--pp-green);text-decoration:none;font-weight:500;">{{ todo.company.name }}</a>
                    {% endif %}
                    {% if todo.candidate %}
                    <span style="color:var(--pp-textDim);font-size:22px;">·</span>
                    <a href="/kandidaten/{{ todo.candidate_id }}" @click.stop style="font-size:22px;white-space:nowrap;color:var(--pp-accent);text-decoration:none;font-weight:500;">{{ todo.candidate.first_name }} {{ todo.candidate.last_name }}</a>
                    {% endif %}
                    {% if todo.ats_job %}
                    <span style="color:var(--pp-textDim);font-size:22px;">·</span>
                    <a href="/ats/jobs/{{ todo.ats_job_id }}" @click.stop style="font-size:22px;white-space:nowrap;color:var(--pp-purple);text-decoration:none;font-weight:500;">{{ todo.ats_job.title }}</a>
                    {% endif %}
                </div>
                {% if todo.description %}
                <p style="font-size:24px;color:var(--pp-textMuted);margin-top:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ todo.description }}</p>
                {% endif %}
            </div>

            {# Aufklapp-Pfeil #}
            <svg :style="open ? 'transform:rotate(180deg)' : ''" width="20" height="20" style="width:20px;height:20px;min-width:20px;min-height:20px;color:var(--pp-textDim);flex-shrink:0;margin-top:8px;transition:transform .2s;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
        </div>

        {# ── Aufklapp-Bereich (Edit) ── #}
        <div x-show="open" x-transition style="border-top:1px solid var(--pp-border);padding:24px;background:var(--pp-surface);">
            {# Titel bearbeiten #}
            <div style="margin-bottom:18px;">
                <label style="font-size:21px;font-weight:600;color:var(--pp-text);display:block;margin-bottom:8px;font-family:var(--pp-ff);">Titel</label>
                <input type="text" x-model="editTitle" style="width:100%;padding:16px 18px;font-size:22px;border:1px solid var(--pp-border);border-radius:10px;font-family:var(--pp-ff);background:var(--pp-bg);color:var(--pp-text);height:58px;">
            </div>
            {# Beschreibung #}
            <div style="margin-bottom:18px;">
                <label style="font-size:21px;font-weight:600;color:var(--pp-text);display:block;margin-bottom:8px;font-family:var(--pp-ff);">Notizen</label>
                <textarea x-model="editDesc" rows="3" style="width:100%;padding:16px 18px;font-size:22px;border:1px solid var(--pp-border);border-radius:10px;font-family:var(--pp-ff);background:var(--pp-bg);color:var(--pp-text);resize:vertical;"></textarea>
            </div>
            {# Datum + Uhrzeit + Priorität + Status in einer Zeile #}
            <div style="display:grid;grid-template-columns:1fr 0.7fr 1fr 1fr;gap:14px;margin-bottom:22px;">
                <div>
                    <label style="font-size:21px;font-weight:600;color:var(--pp-text);display:block;margin-bottom:8px;font-family:var(--pp-ff);">Fällig am</label>
                    <input type="date" x-model="editDueDate" style="width:100%;padding:16px 18px;font-size:22px;border:1px solid var(--pp-border);border-radius:10px;font-family:var(--pp-ff);background:var(--pp-bg);color:var(--pp-text);height:58px;">
                </div>
                <div>
                    <label style="font-size:21px;font-weight:600;color:var(--pp-text);display:block;margin-bottom:8px;font-family:var(--pp-ff);">Uhrzeit</label>
                    <input type="time" x-model="editDueTime" style="width:100%;padding:16px 18px;font-size:22px;border:1px solid var(--pp-border);border-radius:10px;font-family:var(--pp-ff);background:var(--pp-bg);color:var(--pp-text);height:58px;">
                </div>
                <div>
                    <label style="font-size:21px;font-weight:600;color:var(--pp-text);display:block;margin-bottom:8px;font-family:var(--pp-ff);">Priorität</label>
                    <select x-model="editPriority" style="width:100%;padding:16px 18px;font-size:22px;border:1px solid var(--pp-border);border-radius:10px;font-family:var(--pp-ff);background:var(--pp-bg);color:var(--pp-text);height:58px;">
                        <option value="unwichtig">Unwichtig</option>
                        <option value="mittelmaessig">Mittelmäßig</option>
                        <option value="wichtig">Wichtig</option>
                        <option value="dringend">Dringend</option>
                        <option value="sehr_dringend">Sehr dringend</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:21px;font-weight:600;color:var(--pp-text);display:block;margin-bottom:8px;font-family:var(--pp-ff);">Status</label>
                    <select x-model="editStatus" style="width:100%;padding:16px 18px;font-size:22px;border:1px solid var(--pp-border);border-radius:10px;font-family:var(--pp-ff);background:var(--pp-bg);color:var(--pp-text);height:58px;">
                        <option value="open">Offen</option>
                        <option value="in_progress">In Bearbeitung</option>
                        <option value="done">Erledigt</option>
                        <option value="cancelled">Abgebrochen</option>
                    </select>
                </div>
            </div>
            {# Action-Buttons #}
            <div style="display:flex;gap:12px;align-items:center;">
                <button @click="
                    saving = true;
                    var payload = {title: editTitle.trim(), description: editDesc.trim() || null, priority: editPriority, status: editStatus, due_date: editDueDate || null, due_time: editDueTime || null};
                    fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
                    .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
                    .then(function(){ showToast('Aufgabe gespeichert','success'); document.body.dispatchEvent(new CustomEvent('refreshTodos')); })
                    .catch(function(e){ showToast('Fehler: '+e.message,'error'); saving=false; });
                " type="button" :disabled="saving"
                   style="padding:16px 30px;font-size:22px;font-weight:600;border-radius:10px;border:none;cursor:pointer;background:var(--pp-blue);color:#fff;font-family:var(--pp-ff);display:flex;align-items:center;gap:8px;"
                   :style="saving ? 'opacity:0.6;cursor:not-allowed;' : ''">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>
                    Speichern
                </button>
                <button @click="open = false" type="button"
                   style="padding:16px 30px;font-size:22px;font-weight:500;border-radius:10px;border:1px solid var(--pp-border);cursor:pointer;background:var(--pp-surfaceHover);color:var(--pp-text);font-family:var(--pp-ff);">
                    Abbrechen
                </button>
                <div style="flex:1;"></div>
                <button @click="if(confirm('Aufgabe löschen?')){fetch('/api/ats/todos/{{ todo.id }}',{method:'DELETE'}).then(function(r){if(r.ok){showToast('Gelöscht','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});}" type="button"
                   style="padding:16px 24px;font-size:21px;font-weight:500;border-radius:10px;border:1px solid rgba(239,68,68,0.25);cursor:pointer;background:var(--pp-redSoft);color:var(--pp-red);font-family:var(--pp-ff);display:flex;align-items:center;gap:6px;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/></svg>
                    Löschen
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p style="font-size:18px;color:var(--pp-textDim);font-family:var(--pp-ff);">Keine Aufgaben vorhanden</p>
{% endif %}
