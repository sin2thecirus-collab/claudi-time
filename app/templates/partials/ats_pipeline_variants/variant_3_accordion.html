{# VARIANTE 3: Akkordeon - Stages als aufklappbare Abschnitte #}

<div id="pipeline-board"
     hx-get="/ats/stellen/{{ job_id }}/pipeline"
     hx-trigger="pipeline-updated from:body"
     hx-swap="outerHTML">

    {# ── Summary Cards ─────────────────────────────────────── #}
    <div class="grid grid-cols-4 lg:grid-cols-8 gap-3 mb-6">
        {% for stage in stages %}
        {% set stage_key = stage.value %}
        {% set stage_data = pipeline.get(stage_key, {'label': stage_labels[stage], 'entries': []}) %}
        {% set count = stage_data.entries | length %}

        {% set stage_bg = {
            'matched': 'bg-blue-50 border-blue-200',
            'sent': 'bg-indigo-50 border-indigo-200',
            'feedback': 'bg-amber-50 border-amber-200',
            'interview_1': 'bg-purple-50 border-purple-200',
            'interview_2': 'bg-purple-50 border-purple-200',
            'interview_3': 'bg-purple-50 border-purple-200',
            'offer': 'bg-emerald-50 border-emerald-200',
            'placed': 'bg-green-50 border-green-200'
        } %}
        {% set stage_text = {
            'matched': 'text-blue-700',
            'sent': 'text-indigo-700',
            'feedback': 'text-amber-700',
            'interview_1': 'text-purple-700',
            'interview_2': 'text-purple-700',
            'interview_3': 'text-purple-700',
            'offer': 'text-emerald-700',
            'placed': 'text-green-700'
        } %}

        <div class="rounded-xl border p-3 {{ stage_bg.get(stage_key, 'bg-gray-50 border-gray-200') }}">
            <p class="text-2xl font-bold {{ stage_text.get(stage_key, 'text-gray-700') }}">{{ count }}</p>
            <p class="text-xs {{ stage_text.get(stage_key, 'text-gray-500') }} truncate">{{ stage_data.label }}</p>
        </div>
        {% endfor %}
    </div>

    {# ── Akkordeon Sections ────────────────────────────────── #}
    <div class="space-y-2" x-data="{ openSection: 'matched' }">
        {% for stage in stages %}
        {% set stage_key = stage.value %}
        {% set stage_data = pipeline.get(stage_key, {'label': stage_labels[stage], 'entries': []}) %}
        {% set entries = stage_data.entries %}

        {% set stage_colors = {
            'matched': 'border-l-blue-500 hover:bg-blue-50',
            'sent': 'border-l-indigo-500 hover:bg-indigo-50',
            'feedback': 'border-l-amber-500 hover:bg-amber-50',
            'interview_1': 'border-l-purple-500 hover:bg-purple-50',
            'interview_2': 'border-l-purple-500 hover:bg-purple-50',
            'interview_3': 'border-l-purple-500 hover:bg-purple-50',
            'offer': 'border-l-emerald-500 hover:bg-emerald-50',
            'placed': 'border-l-green-500 hover:bg-green-50'
        } %}
        {% set stage_dot = {
            'matched': 'bg-blue-500',
            'sent': 'bg-indigo-500',
            'feedback': 'bg-amber-500',
            'interview_1': 'bg-purple-500',
            'interview_2': 'bg-purple-500',
            'interview_3': 'bg-purple-500',
            'offer': 'bg-emerald-500',
            'placed': 'bg-green-500'
        } %}

        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden border-l-4 {{ stage_colors.get(stage_key, 'border-l-gray-400') }}">
            {# Section Header #}
            <button @click="openSection = openSection === '{{ stage_key }}' ? null : '{{ stage_key }}'"
                    class="w-full flex items-center justify-between px-4 py-3 transition-colors {{ stage_colors.get(stage_key, 'hover:bg-gray-50') }}">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full {{ stage_dot.get(stage_key, 'bg-gray-400') }}"></div>
                    <span class="font-semibold text-gray-800">{{ stage_data.label }}</span>
                    <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600">
                        {{ entries | length }} Kandidat{{ 'en' if entries | length != 1 else '' }}
                    </span>
                </div>
                <svg :class="{ 'rotate-180': openSection === '{{ stage_key }}' }"
                     class="w-5 h-5 text-gray-400 transition-transform duration-200"
                     fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>

            {# Section Content #}
            <div x-show="openSection === '{{ stage_key }}'"
                 x-collapse
                 x-cloak
                 class="pipeline-column border-t border-gray-100"
                 data-stage="{{ stage_key }}"
                 id="column-{{ stage_key }}">

                {% if entries | length > 0 %}
                <div class="divide-y divide-gray-50">
                    {% for entry in entries %}
                    {% set candidate = entry.candidate %}

                    <div class="pipeline-card flex items-center justify-between px-4 py-3 hover:bg-gray-50 transition-colors"
                         data-entry-id="{{ entry.id }}">
                        {% if candidate %}
                        <div class="flex items-center gap-4">
                            {# Avatar #}
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-semibold">
                                {{ (candidate.first_name or 'U')[0] }}{{ (candidate.last_name or '')[0] }}
                            </div>

                            {# Info #}
                            <div>
                                <a href="/kandidaten/{{ candidate.id }}" class="text-sm font-medium text-gray-900 hover:text-primary-600">
                                    {{ candidate.full_name or ((candidate.first_name or '') ~ ' ' ~ (candidate.last_name or '')) | trim or 'Unbekannt' }}
                                </a>
                                <div class="flex items-center gap-3 text-xs text-gray-500 mt-0.5">
                                    {% if candidate.current_position %}
                                    <span>{{ candidate.current_position }}</span>
                                    {% endif %}
                                    {% if candidate.city %}
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                                        </svg>
                                        {{ candidate.city }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {# Actions #}
                        <div class="flex items-center gap-2">
                            {# Stage Dropdown #}
                            <div x-data="{ open: false }" class="relative">
                                <button @click="open = !open" @click.outside="open = false"
                                        class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                    Phase ändern
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </button>
                                <div x-show="open" x-cloak x-transition
                                     class="absolute right-0 top-full mt-1 w-44 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                                    {% for s in stages %}
                                    {% set s_key = s.value %}
                                    {% set s_data = pipeline.get(s_key, {'label': stage_labels[s]}) %}
                                    <button @click="
                                        fetch('/api/ats/pipeline/entries/{{ entry.id }}/stage', {
                                            method: 'PATCH',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ stage: '{{ s_key }}' })
                                        }).then(() => document.body.dispatchEvent(new CustomEvent('pipeline-updated')));
                                        open = false;
                                    "
                                            class="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 {{ 'font-medium text-primary-600 bg-primary-50' if s_key == stage_key else 'text-gray-700' }}">
                                        {{ s_data.label }}
                                    </button>
                                    {% endfor %}
                                    <div class="border-t border-gray-100 mt-1 pt-1">
                                        <button @click="
                                            if(confirm('Kandidat wirklich ablehnen?')) {
                                                fetch('/api/ats/pipeline/entries/{{ entry.id }}/stage', {
                                                    method: 'PATCH',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ stage: 'rejected' })
                                                }).then(() => document.body.dispatchEvent(new CustomEvent('pipeline-updated')));
                                            }
                                            open = false;
                                        "
                                                class="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50">
                                            Ablehnen
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {# View Profile #}
                            <a href="/kandidaten/{{ candidate.id }}"
                               class="p-2 text-gray-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                                </svg>
                            </a>
                        </div>
                        {% else %}
                        <span class="text-sm text-gray-400 italic">Kandidat entfernt</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="px-4 py-8 text-center text-gray-400">
                    <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                    </svg>
                    <p class="text-sm">Keine Kandidaten in dieser Phase</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        {# ── Rejected Section ──────────────────────────────── #}
        {% set rejected_data = pipeline.get('rejected', {'label': 'Abgelehnt', 'entries': []}) %}
        {% set rejected_entries = rejected_data.entries %}

        {% if rejected_entries | length > 0 %}
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden border-l-4 border-l-red-500">
            <button @click="openSection = openSection === 'rejected' ? null : 'rejected'"
                    class="w-full flex items-center justify-between px-4 py-3 hover:bg-red-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span class="font-semibold text-gray-800">Abgelehnt</span>
                    <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-600">
                        {{ rejected_entries | length }}
                    </span>
                </div>
                <svg :class="{ 'rotate-180': openSection === 'rejected' }"
                     class="w-5 h-5 text-gray-400 transition-transform duration-200"
                     fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>

            <div x-show="openSection === 'rejected'" x-collapse x-cloak class="border-t border-gray-100">
                <div class="divide-y divide-gray-50">
                    {% for entry in rejected_entries %}
                    {% set candidate = entry.candidate %}
                    <div class="flex items-center justify-between px-4 py-3 bg-red-50/50">
                        {% if candidate %}
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 font-semibold">
                                {{ (candidate.first_name or 'U')[0] }}{{ (candidate.last_name or '')[0] }}
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">
                                    {{ candidate.full_name or ((candidate.first_name or '') ~ ' ' ~ (candidate.last_name or '')) | trim }}
                                </p>
                                {% if entry.rejection_reason %}
                                <p class="text-xs text-red-600 mt-0.5">{{ entry.rejection_reason }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <span class="text-xs text-gray-400">{{ entry.stage_changed_at.strftime('%d.%m.%Y') if entry.stage_changed_at else '' }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
