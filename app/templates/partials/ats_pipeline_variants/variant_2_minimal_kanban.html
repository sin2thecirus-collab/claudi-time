{# VARIANTE 2: Minimales Kanban - Kompakt, weniger Höhe, moderne Cards #}

<div id="pipeline-board"
     x-data="{ dragging: false, dragEntryId: null }"
     hx-get="/ats/stellen/{{ job_id }}/pipeline"
     hx-trigger="pipeline-updated from:body"
     hx-swap="outerHTML">

    {# ── Pipeline Stats Header ─────────────────────────────── #}
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-6">
            {% set total = namespace(count=0) %}
            {% for stage in stages %}
                {% set stage_data = pipeline.get(stage.value, {'entries': []}) %}
                {% set total.count = total.count + (stage_data.entries | length) %}
            {% endfor %}
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-xl bg-primary-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ total.count }}</p>
                    <p class="text-xs text-gray-500">Kandidaten gesamt</p>
                </div>
            </div>
        </div>
    </div>

    {# ── Minimal Kanban Board ──────────────────────────────── #}
    <div class="grid grid-cols-4 lg:grid-cols-8 gap-3">
        {% for stage in stages %}
        {% set stage_key = stage.value %}
        {% set stage_data = pipeline.get(stage_key, {'label': stage_labels[stage], 'entries': []}) %}
        {% set entries = stage_data.entries %}

        {% set stage_colors = {
            'matched': 'from-blue-500 to-blue-600',
            'sent': 'from-indigo-500 to-indigo-600',
            'feedback': 'from-amber-500 to-amber-600',
            'interview_1': 'from-purple-500 to-purple-600',
            'interview_2': 'from-purple-500 to-purple-600',
            'interview_3': 'from-purple-500 to-purple-600',
            'offer': 'from-emerald-500 to-emerald-600',
            'placed': 'from-green-500 to-green-600'
        } %}

        <div class="pipeline-column" data-stage="{{ stage_key }}" id="column-{{ stage_key }}">
            {# Column Header - Compact #}
            <div class="flex items-center justify-between mb-2 px-1">
                <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 rounded-full bg-gradient-to-r {{ stage_colors.get(stage_key, 'from-gray-400 to-gray-500') }}"></div>
                    <span class="text-xs font-semibold text-gray-600 truncate">{{ stage_data.label }}</span>
                </div>
                <span class="text-xs font-bold text-gray-400">{{ entries | length }}</span>
            </div>

            {# Column Body - Minimal Cards #}
            <div class="space-y-1.5 min-h-[200px]">
                {% if entries | length > 0 %}
                    {% for entry in entries %}
                    {% set candidate = entry.candidate %}

                    <div class="pipeline-card group bg-white rounded-lg border border-gray-200 p-2 hover:border-gray-300 hover:shadow-sm transition-all cursor-grab active:cursor-grabbing"
                         data-entry-id="{{ entry.id }}">

                        {% if candidate %}
                        <div class="flex items-center gap-2">
                            {# Mini Avatar #}
                            <div class="w-7 h-7 rounded-full bg-gradient-to-br {{ stage_colors.get(stage_key, 'from-gray-400 to-gray-500') }} flex items-center justify-center text-white text-xs font-medium flex-shrink-0">
                                {{ (candidate.first_name or 'U')[0] }}
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="text-xs font-medium text-gray-900 truncate">
                                    {{ candidate.first_name or '' }} {{ (candidate.last_name or '')[0] ~ '.' if candidate.last_name else '' }}
                                </p>
                                {% if candidate.city %}
                                <p class="text-[10px] text-gray-400 truncate">{{ candidate.city }}</p>
                                {% endif %}
                            </div>
                        </div>

                        {# Hover Actions #}
                        <div class="hidden group-hover:flex items-center justify-end gap-1 mt-1.5 pt-1.5 border-t border-gray-100">
                            <a href="/kandidaten/{{ candidate.id }}"
                               class="p-1 text-gray-400 hover:text-primary-600 rounded transition-colors">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </a>
                        </div>
                        {% else %}
                        <p class="text-xs text-gray-400 italic">Entfernt</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                <div class="flex items-center justify-center h-20 text-gray-300">
                    <div class="w-6 h-6 rounded-full border-2 border-dashed border-gray-200"></div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {# ── Rejected (Mini Bar) ───────────────────────────────── #}
    {% set rejected_data = pipeline.get('rejected', {'label': 'Abgelehnt', 'entries': []}) %}
    {% set rejected_entries = rejected_data.entries %}

    {% if rejected_entries | length > 0 %}
    <div x-data="{ open: false }" class="mt-6">
        <button @click="open = !open"
                class="flex items-center gap-2 text-xs text-red-500 hover:text-red-600 transition-colors">
            <svg :class="{ 'rotate-180': open }" class="w-3 h-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
            {{ rejected_entries | length }} abgelehnt
        </button>

        <div x-show="open" x-collapse x-cloak class="mt-2">
            <div class="flex flex-wrap gap-1.5">
                {% for entry in rejected_entries %}
                {% set candidate = entry.candidate %}
                {% if candidate %}
                <div class="flex items-center gap-1.5 px-2 py-1 bg-red-50 rounded-full border border-red-200">
                    <span class="text-xs text-red-700">{{ candidate.first_name or '' }} {{ (candidate.last_name or '')[0] ~ '.' if candidate.last_name else '' }}</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

{# ── SortableJS Integration ──────────────────────────────── #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
(function() {
    function initPipelineSortable() {
        const columns = document.querySelectorAll('.pipeline-column');
        const jobId = '{{ job_id }}';

        columns.forEach(function(column) {
            const container = column.querySelector('.space-y-1\\.5') || column;
            if (!container) return;

            new Sortable(container, {
                group: 'pipeline',
                animation: 150,
                ghostClass: 'opacity-30',
                chosenClass: 'ring-2 ring-primary-400',
                dragClass: 'shadow-lg',
                draggable: '.pipeline-card',

                onEnd: function(evt) {
                    const entryId = evt.item.dataset.entryId;
                    const newStage = evt.to.closest('.pipeline-column').dataset.stage;

                    if (!entryId || !newStage) return;

                    fetch('/api/ats/pipeline/entries/' + entryId + '/stage', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ stage: newStage }),
                    })
                    .then(function(response) {
                        if (!response.ok) throw new Error('Stage update failed');
                        return response.json();
                    })
                    .then(function() {
                        document.body.dispatchEvent(new CustomEvent('pipeline-updated'));
                    })
                    .catch(function(error) {
                        console.error('Pipeline update error:', error);
                        document.body.dispatchEvent(new CustomEvent('pipeline-updated'));
                    });
                }
            });
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPipelineSortable);
    } else {
        initPipelineSortable();
    }

    document.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'pipeline-board') {
            setTimeout(initPipelineSortable, 50);
        }
    });
})();
</script>
