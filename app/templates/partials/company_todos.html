{# Partial: Aufgaben ‚Äî Kompakte Tabellen-Ansicht f√ºr Vertrieb #}

{% if todos and todos | length > 0 %}
<div x-data="{ openId: null }" style="display:flex; flex-direction:column; gap:0;">

    {# Tabellen-Header #}
    <div style="display:grid; grid-template-columns:28px 1fr 100px 100px 100px 28px; gap:8px; align-items:center; padding:6px 14px; border-bottom:1px solid var(--pp-border);">
        <div></div>
        <span style="font-size:10px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.06em;">Aufgabe</span>
        <span style="font-size:10px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.06em;">Priorit√§t</span>
        <span style="font-size:10px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.06em;">F√§llig</span>
        <span style="font-size:10px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.06em;">Status</span>
        <div></div>
    </div>

    {% for todo in todos %}
    {% set prio_map = {'unwichtig': ('Unwichtig','var(--pp-textDim)','var(--pp-surfaceHover)'), 'mittelmaessig': ('Mittel','var(--pp-accent)','var(--pp-accentSoft)'), 'wichtig': ('Wichtig','var(--pp-orange)','var(--pp-orangeSoft)'), 'dringend': ('Dringend','var(--pp-red)','var(--pp-redSoft)'), 'sehr_dringend': ('Dringend!','var(--pp-red)','var(--pp-redSoft)')} %}
    {% set pl, pc, pbg = prio_map.get(todo.priority.value, ('','var(--pp-textDim)','var(--pp-surfaceHover)')) %}
    {% set status_map = {'open': ('Offen','var(--pp-accent)','var(--pp-accentSoft)'), 'in_progress': ('Laufend','var(--pp-orange)','var(--pp-orangeSoft)'), 'done': ('Erledigt','var(--pp-green)','var(--pp-greenSoft)'), 'cancelled': ('Abgebr.','var(--pp-textDim)','var(--pp-surfaceHover)')} %}
    {% set sl, sc, sbg = status_map.get(todo.status.value, ('Offen','var(--pp-accent)','var(--pp-accentSoft)')) %}

    <div x-data="{ saving: false, statusDrop: false,
                   editTitle: '{{ todo.title | replace("'", "\\'") }}',
                   editDesc: '{{ (todo.description or '') | replace("'", "\\'") | replace('\n', '\\n') }}',
                   editPriority: '{{ todo.priority.value }}',
                   editStatus: '{{ todo.status.value }}',
                   editDueDate: '{{ todo.due_date.isoformat() if todo.due_date else '' }}' }"
         style="border-bottom:1px solid var(--pp-border);"
         :style="openId === '{{ todo.id }}' ? 'background:var(--pp-surfaceHover);' : ''">

        {# ‚îÄ‚îÄ Tabellenzeile ‚îÄ‚îÄ #}
        <div @click="openId = openId === '{{ todo.id }}' ? null : '{{ todo.id }}'"
             style="display:grid; grid-template-columns:28px 1fr 100px 100px 100px 28px; gap:8px; align-items:center; padding:10px 14px; cursor:pointer; transition:background 0.1s;"
             onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background=''">

            {# Checkbox #}
            <div @click.stop="
                var newStatus = editStatus === 'done' ? 'open' : 'done';
                fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:newStatus})})
                .then(function(r){if(r.ok){showToast(newStatus==='done'?'Erledigt':'Wieder ge√∂ffnet','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});"
                 style="width:18px; height:18px; border-radius:5px; cursor:pointer;
                        border:{% if todo.status.value == 'done' %}none{% else %}1.5px solid var(--pp-borderLight){% endif %};
                        background:{% if todo.status.value == 'done' %}var(--pp-green){% else %}transparent{% endif %};
                        display:flex; align-items:center; justify-content:center;">
                {% if todo.status.value == 'done' %}
                <span style="color:#fff; font-size:11px; font-weight:700;">‚úì</span>
                {% endif %}
            </div>

            {# Aufgabe: Titel + Chips #}
            <div style="min-width:0;">
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:13px; font-weight:600;
                                 color:{% if todo.status.value == 'done' %}var(--pp-textDim){% else %}var(--pp-text){% endif %};
                                 {% if todo.status.value == 'done' %}text-decoration:line-through;{% endif %}
                                 overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ todo.title }}</span>
                    {% if todo.description %}
                    <span style="font-size:10px; color:var(--pp-textDim);" title="{{ todo.description }}">üí¨</span>
                    {% endif %}
                </div>
                {% if todo.contact or todo.candidate or todo.ats_job %}
                <div style="display:flex; gap:4px; margin-top:2px; flex-wrap:wrap;">
                    {% if todo.contact %}
                    <a href="/kontakte/{{ todo.contact_id }}" @click.stop style="font-size:10px; color:var(--pp-accent); text-decoration:none; display:inline-flex; align-items:center; gap:2px;">üë§ {{ todo.contact.full_name }}</a>
                    {% endif %}
                    {% if todo.candidate %}
                    <a href="/kandidaten/{{ todo.candidate_id }}" @click.stop style="font-size:10px; color:var(--pp-purple); text-decoration:none; display:inline-flex; align-items:center; gap:2px;">üßë‚Äçüíº {{ todo.candidate.first_name }} {{ todo.candidate.last_name }}</a>
                    {% endif %}
                    {% if todo.ats_job %}
                    <a href="/ats/jobs/{{ todo.ats_job_id }}" @click.stop style="font-size:10px; color:var(--pp-orange); text-decoration:none; display:inline-flex; align-items:center; gap:2px;">üíº {{ todo.ats_job.title }}</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {# Priorit√§t #}
            <span style="font-size:11px; font-weight:600; color:{{ pc }}; background:{{ pbg }}; padding:2px 8px; border-radius:5px; text-align:center; white-space:nowrap;">{{ pl }}</span>

            {# F√§llig #}
            <span style="font-size:12px; color:{% if todo.is_overdue %}var(--pp-red){% else %}var(--pp-textDim){% endif %}; white-space:nowrap;">
                {% if todo.due_date %}{{ todo.due_date.strftime('%d.%m.%Y') }}{% else %}‚Äî{% endif %}
            </span>

            {# Status Dropdown #}
            <div style="position:relative;" @click.stop>
                <button @click="statusDrop = !statusDrop"
                        style="font-size:11px; font-weight:600; padding:3px 8px; border-radius:6px; cursor:pointer; width:100%;
                               border:1px solid {{ sc }}33; background:{{ sbg }}; color:{{ sc }};
                               display:flex; align-items:center; justify-content:center; gap:3px; font-family:var(--pp-ff); white-space:nowrap;">
                    {{ sl }} <span style="font-size:8px; opacity:0.5;">‚ñæ</span>
                </button>
                <div x-show="statusDrop" @click.away="statusDrop = false" x-transition
                     style="position:absolute; right:0; top:100%; margin-top:4px; z-index:50;
                            width:160px; background:var(--pp-surface); border:1px solid var(--pp-border);
                            border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.4); padding:4px; display:none;">
                    {% for sv, sdata in [('open', ('Offen','var(--pp-accent)','‚óè')), ('in_progress', ('In Bearbeitung','var(--pp-orange)','‚óè')), ('done', ('Erledigt','var(--pp-green)','‚óè')), ('cancelled', ('Abgebrochen','var(--pp-textDim)','‚óè'))] %}
                    <button @click="
                        statusDrop = false;
                        fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'{{ sv }}'})})
                        .then(function(r){if(r.ok){showToast('Status ge√§ndert','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});"
                        style="width:100%; text-align:left; padding:6px 10px; border-radius:6px; border:none; cursor:pointer;
                               background:{% if todo.status.value == sv %}var(--pp-surfaceHover){% else %}transparent{% endif %};
                               color:var(--pp-text); font-size:12px; font-family:var(--pp-ff); display:flex; align-items:center; gap:6px;"
                        onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='{% if todo.status.value == sv %}var(--pp-surfaceHover){% else %}transparent{% endif %}'">
                        <span style="color:{{ sdata[1] }}; font-size:8px;">{{ sdata[2] }}</span>
                        {{ sdata[0] }}
                        {% if todo.status.value == sv %}<span style="margin-left:auto; font-size:10px; color:var(--pp-accent);">‚úì</span>{% endif %}
                    </button>
                    {% endfor %}
                </div>
            </div>

            {# Expand #}
            <span style="font-size:14px; color:var(--pp-textDim); transition:transform 0.2s; line-height:1; text-align:center;"
                  :style="openId === '{{ todo.id }}' ? 'transform:rotate(180deg)' : ''">‚åÑ</span>
        </div>

        {# ‚îÄ‚îÄ Inline Edit (kompakt) ‚îÄ‚îÄ #}
        <template x-if="openId === '{{ todo.id }}' && !saving">
            <div style="padding:10px 14px 14px; padding-left:50px; background:var(--pp-bg); border-top:1px solid var(--pp-border);">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-bottom:10px;">
                    <div>
                        <label style="font-size:9px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:3px;">Titel</label>
                        <input type="text" x-model="editTitle" style="width:100%; padding:6px 10px; font-size:12px; border:1px solid var(--pp-border); border-radius:7px; background:var(--pp-surface); color:var(--pp-text); outline:none; font-family:var(--pp-ff);" onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                    </div>
                    <div>
                        <label style="font-size:9px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:3px;">F√§llig am</label>
                        <input type="date" x-model="editDueDate" style="width:100%; padding:6px 10px; font-size:12px; border:1px solid var(--pp-border); border-radius:7px; background:var(--pp-surface); color:var(--pp-text); outline:none; font-family:var(--pp-ff);" onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                    </div>
                    <div>
                        <label style="font-size:9px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:3px;">Priorit√§t</label>
                        <select x-model="editPriority" style="width:100%; padding:6px 10px; font-size:12px; border:1px solid var(--pp-border); border-radius:7px; background:var(--pp-surface); color:var(--pp-text); outline:none; cursor:pointer; font-family:var(--pp-ff);" onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                            <option value="unwichtig">Unwichtig</option><option value="mittelmaessig">Mittelm√§√üig</option><option value="wichtig">Wichtig</option><option value="dringend">Dringend</option><option value="sehr_dringend">Sehr dringend</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:9px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:3px;">Status</label>
                        <select x-model="editStatus" style="width:100%; padding:6px 10px; font-size:12px; border:1px solid var(--pp-border); border-radius:7px; background:var(--pp-surface); color:var(--pp-text); outline:none; cursor:pointer; font-family:var(--pp-ff);" onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                            <option value="open">Offen</option><option value="in_progress">In Bearbeitung</option><option value="done">Erledigt</option><option value="cancelled">Abgebrochen</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:9px; font-weight:600; color:var(--pp-textDim); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:3px;">Notizen</label>
                    <textarea x-model="editDesc" rows="2" placeholder="Notizen..."
                              style="width:100%; padding:6px 10px; font-size:12px; border:1px solid var(--pp-border); border-radius:7px; background:var(--pp-surface); color:var(--pp-text); outline:none; resize:vertical; font-family:var(--pp-ff); line-height:1.4;"
                              onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'"></textarea>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <button @click="
                        saving = true;
                        var payload = {title: editTitle.trim(), description: editDesc.trim() || null, priority: editPriority, status: editStatus, due_date: editDueDate || null};
                        fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
                        .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
                        .then(function(){ showToast('Gespeichert','success'); document.body.dispatchEvent(new CustomEvent('refreshTodos')); })
                        .catch(function(e){ showToast('Fehler: '+e.message,'error'); saving=false; });"
                        type="button" :disabled="saving"
                        style="padding:5px 14px; font-size:11px; font-weight:600; border-radius:7px; border:none; cursor:pointer; background:var(--pp-accent); color:#fff; font-family:var(--pp-ff);"
                        :style="saving ? 'opacity:0.5;cursor:not-allowed;' : ''">
                        ‚úì Speichern
                    </button>
                    <button @click="openId = null" type="button"
                        style="padding:5px 14px; font-size:11px; font-weight:500; border-radius:7px; border:1px solid var(--pp-border); cursor:pointer; background:transparent; color:var(--pp-textMuted); font-family:var(--pp-ff);">
                        Schlie√üen
                    </button>
                    <div style="flex:1;"></div>
                    <button @click="if(confirm('Aufgabe l√∂schen?')){fetch('/api/ats/todos/{{ todo.id }}',{method:'DELETE'}).then(function(r){if(r.ok){showToast('Gel√∂scht','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});}"
                        type="button"
                        style="padding:5px 10px; font-size:10px; border-radius:7px; border:none; cursor:pointer; background:transparent; color:var(--pp-red); font-family:var(--pp-ff); opacity:0.5;"
                        onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">
                        üóë L√∂schen
                    </button>
                </div>
            </div>
        </template>
    </div>
    {% endfor %}
</div>
{% else %}
<p style="font-size:13px; color:var(--pp-textDim);">Keine Aufgaben vorhanden</p>
{% endif %}
