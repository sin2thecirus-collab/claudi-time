{# Partial: Aufgaben ‚Äî Dark Theme, Card Layout #}

{% if todos and todos | length > 0 %}
<div x-data="{ openId: null }" style="display:flex; flex-direction:column; gap:8px;">
    {% for todo in todos %}
    {% set prio_map = {'unwichtig': ('Unwichtig','var(--pp-textDim)','var(--pp-surfaceHover)'), 'mittelmaessig': ('Mittelm√§√üig','var(--pp-accent)','var(--pp-accentSoft)'), 'wichtig': ('Wichtig','var(--pp-orange)','var(--pp-orangeSoft)'), 'dringend': ('Dringend','var(--pp-red)','var(--pp-redSoft)'), 'sehr_dringend': ('Sehr dringend','var(--pp-red)','var(--pp-redSoft)')} %}
    {% set pl, pc, pbg = prio_map.get(todo.priority.value, ('','var(--pp-textDim)','var(--pp-surfaceHover)')) %}
    {% set status_map = {'open': ('Offen','var(--pp-accent)','var(--pp-accentSoft)'), 'in_progress': ('In Bearbeitung','var(--pp-orange)','var(--pp-orangeSoft)'), 'done': ('Erledigt','var(--pp-green)','var(--pp-greenSoft)'), 'cancelled': ('Abgebrochen','var(--pp-textDim)','var(--pp-surfaceHover)')} %}
    {% set sl, sc, sbg = status_map.get(todo.status.value, ('Offen','var(--pp-accent)','var(--pp-accentSoft)')) %}

    <div x-data="{ saving: false, statusDrop: false,
                   editTitle: '{{ todo.title | replace("'", "\\'") }}',
                   editDesc: '{{ (todo.description or '') | replace("'", "\\'") | replace('\n', '\\n') }}',
                   editPriority: '{{ todo.priority.value }}',
                   editStatus: '{{ todo.status.value }}',
                   editDueDate: '{{ todo.due_date.isoformat() if todo.due_date else '' }}' }"
         style="border-radius:12px; background:var(--pp-surface); border:1px solid var(--pp-border); transition:all 0.2s; overflow:hidden;"
         :style="openId === '{{ todo.id }}' ? 'border-color:var(--pp-accent);' : ''">

        {# ‚îÄ‚îÄ Collapsed Card ‚îÄ‚îÄ clickable header #}
        <div @click="openId = openId === '{{ todo.id }}' ? null : '{{ todo.id }}'"
             style="padding:12px 16px; cursor:pointer; transition:background 0.15s;"
             onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='transparent'">

            {# Row 1: Checkbox + Title + Badges #}
            <div style="display:flex; align-items:center; gap:10px;">
                {# Checkbox #}
                <div @click.stop="
                    var newStatus = editStatus === 'done' ? 'open' : 'done';
                    fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:newStatus})})
                    .then(function(r){if(r.ok){showToast(newStatus==='done'?'Erledigt':'Wieder ge√∂ffnet','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});"
                     style="width:20px; height:20px; border-radius:6px; flex-shrink:0; cursor:pointer;
                            border:{% if todo.status.value == 'done' %}none{% else %}1.5px solid var(--pp-borderLight){% endif %};
                            background:{% if todo.status.value == 'done' %}var(--pp-green){% else %}transparent{% endif %};
                            display:flex; align-items:center; justify-content:center; transition:all 0.15s;">
                    {% if todo.status.value == 'done' %}
                    <span style="color:#fff; font-size:12px; font-weight:700;">‚úì</span>
                    {% endif %}
                </div>

                {# Title #}
                <span style="font-size:14px; font-weight:600; flex:1; min-width:0;
                             color:{% if todo.status.value == 'done' %}var(--pp-textDim){% else %}var(--pp-text){% endif %};
                             {% if todo.status.value == 'done' %}text-decoration:line-through;{% endif %}
                             overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ todo.title }}</span>

                {# Priority Badge #}
                <span style="font-size:11px; font-weight:600; color:{{ pc }}; background:{{ pbg }}; padding:2px 8px; border-radius:6px; white-space:nowrap; flex-shrink:0;">{{ pl }}</span>

                {# Due Date #}
                {% if todo.due_date %}
                <span style="font-size:12px; color:{% if todo.is_overdue %}var(--pp-red){% else %}var(--pp-textDim){% endif %}; white-space:nowrap; flex-shrink:0;">
                    üìÖ {{ todo.due_date.strftime('%d.%m.%Y') }}
                </span>
                {% endif %}

                {# Status Dropdown #}
                <div style="position:relative; flex-shrink:0;" @click.stop>
                    <button @click="statusDrop = !statusDrop"
                            style="font-size:11px; font-weight:600; padding:3px 10px; border-radius:7px; cursor:pointer;
                                   border:1px solid {{ sc }}33; background:{{ sbg }}; color:{{ sc }};
                                   display:flex; align-items:center; gap:4px; font-family:var(--pp-ff); white-space:nowrap;">
                        {{ sl }} <span style="font-size:9px; opacity:0.6;">‚ñæ</span>
                    </button>
                    <div x-show="statusDrop" @click.away="statusDrop = false" x-transition
                         style="position:absolute; right:0; top:100%; margin-top:6px; z-index:50;
                                width:170px; background:var(--pp-surface); border:1px solid var(--pp-border);
                                border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.4); padding:4px; display:none;">
                        {% for sv, sdata in [('open', ('Offen','var(--pp-accent)','‚óè')), ('in_progress', ('In Bearbeitung','var(--pp-orange)','‚óè')), ('done', ('Erledigt','var(--pp-green)','‚óè')), ('cancelled', ('Abgebrochen','var(--pp-textDim)','‚óè'))] %}
                        <button @click="
                            statusDrop = false;
                            fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'{{ sv }}'})})
                            .then(function(r){if(r.ok){showToast('Status ge√§ndert','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});"
                            style="width:100%; text-align:left; padding:7px 10px; border-radius:7px; border:none; cursor:pointer;
                                   background:{% if todo.status.value == sv %}var(--pp-surfaceHover){% else %}transparent{% endif %};
                                   color:var(--pp-text); font-size:12px; font-family:var(--pp-ff); display:flex; align-items:center; gap:7px;"
                            onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='{% if todo.status.value == sv %}var(--pp-surfaceHover){% else %}transparent{% endif %}'">
                            <span style="color:{{ sdata[1] }}; font-size:8px;">{{ sdata[2] }}</span>
                            {{ sdata[0] }}
                            {% if todo.status.value == sv %}<span style="margin-left:auto; font-size:11px; color:var(--pp-accent);">‚úì</span>{% endif %}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                {# Expand Arrow #}
                <span style="font-size:16px; color:var(--pp-textDim); flex-shrink:0; transition:transform 0.2s; line-height:1;"
                      :style="openId === '{{ todo.id }}' ? 'transform:rotate(180deg)' : ''">‚åÑ</span>
            </div>

            {# Row 2: Zuordnungen (Kontakt, Kandidat, Stelle) ‚Äî nur wenn vorhanden #}
            {% if todo.contact or todo.candidate or todo.ats_job %}
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px; padding-left:30px;">
                {% if todo.contact %}
                <a href="/kontakte/{{ todo.contact_id }}" @click.stop style="font-size:11px; color:var(--pp-accent); background:var(--pp-accentSoft); padding:2px 7px; border-radius:5px; text-decoration:none; display:inline-flex; align-items:center; gap:3px;">üë§ {{ todo.contact.full_name }}</a>
                {% endif %}
                {% if todo.candidate %}
                <a href="/kandidaten/{{ todo.candidate_id }}" @click.stop style="font-size:11px; color:var(--pp-purple); background:var(--pp-purpleSoft); padding:2px 7px; border-radius:5px; text-decoration:none; display:inline-flex; align-items:center; gap:3px;">üßë‚Äçüíº {{ todo.candidate.first_name }} {{ todo.candidate.last_name }}</a>
                {% endif %}
                {% if todo.ats_job %}
                <a href="/ats/jobs/{{ todo.ats_job_id }}" @click.stop style="font-size:11px; color:var(--pp-orange); background:var(--pp-orangeSoft); padding:2px 7px; border-radius:5px; text-decoration:none; display:inline-flex; align-items:center; gap:3px;">üíº {{ todo.ats_job.title }}</a>
                {% endif %}
                {% if todo.description %}
                <span style="font-size:11px; color:var(--pp-textDim); margin-left:4px;">üí¨ Notiz</span>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {# ‚îÄ‚îÄ Expanded Edit Panel ‚îÄ‚îÄ #}
        <template x-if="openId === '{{ todo.id }}' && !saving">
            <div style="padding:0 16px 16px; border-top:1px solid var(--pp-border); background:var(--pp-bg);">

                {# Notizen Preview (read-only, wenn vorhanden) #}
                {% if todo.description %}
                <div style="padding:12px 0; border-bottom:1px solid var(--pp-border); margin-bottom:14px;">
                    <p style="font-size:13px; color:var(--pp-textMuted); line-height:1.5; margin:0;">{{ todo.description }}</p>
                </div>
                {% else %}
                <div style="height:14px;"></div>
                {% endif %}

                {# Edit Grid: 2 columns #}
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px;">
                    <div>
                        <label style="font-size:10px; font-weight:600; color:var(--pp-textDim); display:block; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.05em;">Titel</label>
                        <input type="text" x-model="editTitle"
                               style="width:100%; padding:8px 12px; font-size:13px; border:1px solid var(--pp-border); border-radius:8px; background:var(--pp-surface); color:var(--pp-text); outline:none; font-family:var(--pp-ff);"
                               onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                    </div>
                    <div>
                        <label style="font-size:10px; font-weight:600; color:var(--pp-textDim); display:block; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.05em;">F√§llig am</label>
                        <input type="date" x-model="editDueDate"
                               style="width:100%; padding:8px 12px; font-size:13px; border:1px solid var(--pp-border); border-radius:8px; background:var(--pp-surface); color:var(--pp-text); outline:none; font-family:var(--pp-ff);"
                               onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                    </div>
                    <div>
                        <label style="font-size:10px; font-weight:600; color:var(--pp-textDim); display:block; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.05em;">Priorit√§t</label>
                        <select x-model="editPriority"
                                style="width:100%; padding:8px 12px; font-size:13px; border:1px solid var(--pp-border); border-radius:8px; background:var(--pp-surface); color:var(--pp-text); outline:none; cursor:pointer; font-family:var(--pp-ff);"
                                onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                            <option value="unwichtig">Unwichtig</option>
                            <option value="mittelmaessig">Mittelm√§√üig</option>
                            <option value="wichtig">Wichtig</option>
                            <option value="dringend">Dringend</option>
                            <option value="sehr_dringend">Sehr dringend</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:10px; font-weight:600; color:var(--pp-textDim); display:block; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.05em;">Status</label>
                        <select x-model="editStatus"
                                style="width:100%; padding:8px 12px; font-size:13px; border:1px solid var(--pp-border); border-radius:8px; background:var(--pp-surface); color:var(--pp-text); outline:none; cursor:pointer; font-family:var(--pp-ff);"
                                onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'">
                            <option value="open">Offen</option>
                            <option value="in_progress">In Bearbeitung</option>
                            <option value="done">Erledigt</option>
                            <option value="cancelled">Abgebrochen</option>
                        </select>
                    </div>
                </div>

                {# Notizen Textarea #}
                <div style="margin-bottom:14px;">
                    <label style="font-size:10px; font-weight:600; color:var(--pp-textDim); display:block; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.05em;">Notizen bearbeiten</label>
                    <textarea x-model="editDesc" rows="2" placeholder="Notizen..."
                              style="width:100%; padding:8px 12px; font-size:13px; border:1px solid var(--pp-border); border-radius:8px; background:var(--pp-surface); color:var(--pp-text); outline:none; resize:vertical; font-family:var(--pp-ff); line-height:1.5;"
                              onfocus="this.style.borderColor='var(--pp-accent)'" onblur="this.style.borderColor='var(--pp-border)'"></textarea>
                </div>

                {# Action Bar #}
                <div style="display:flex; align-items:center; gap:8px;">
                    <button @click="
                        saving = true;
                        var payload = {title: editTitle.trim(), description: editDesc.trim() || null, priority: editPriority, status: editStatus, due_date: editDueDate || null};
                        fetch('/api/ats/todos/{{ todo.id }}', {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
                        .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
                        .then(function(){ showToast('Gespeichert','success'); document.body.dispatchEvent(new CustomEvent('refreshTodos')); })
                        .catch(function(e){ showToast('Fehler: '+e.message,'error'); saving=false; });"
                        type="button" :disabled="saving"
                        style="padding:7px 16px; font-size:12px; font-weight:600; border-radius:8px; border:none; cursor:pointer;
                               background:var(--pp-accent); color:#fff; font-family:var(--pp-ff);
                               display:inline-flex; align-items:center; gap:5px;"
                        :style="saving ? 'opacity:0.5;cursor:not-allowed;' : ''">
                        ‚úì Speichern
                    </button>
                    <button @click="openId = null" type="button"
                        style="padding:7px 16px; font-size:12px; font-weight:500; border-radius:8px;
                               border:1px solid var(--pp-border); cursor:pointer; background:transparent;
                               color:var(--pp-textMuted); font-family:var(--pp-ff);">
                        Abbrechen
                    </button>
                    <div style="flex:1;"></div>
                    <button @click="if(confirm('Aufgabe l√∂schen?')){fetch('/api/ats/todos/{{ todo.id }}',{method:'DELETE'}).then(function(r){if(r.ok){showToast('Gel√∂scht','success');document.body.dispatchEvent(new CustomEvent('refreshTodos'));}});}"
                        type="button"
                        style="padding:6px 12px; font-size:11px; font-weight:500; border-radius:8px;
                               border:none; cursor:pointer; background:transparent;
                               color:var(--pp-red); font-family:var(--pp-ff); opacity:0.6;"
                        onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                        üóë L√∂schen
                    </button>
                </div>
            </div>
        </template>
    </div>
    {% endfor %}
</div>
{% else %}
<p style="font-size:13px; color:var(--pp-textDim);">Keine Aufgaben vorhanden</p>
{% endif %}
