{% extends "base.html" %}

{% block title %}DeepMatch {{ category_label }} ‚Äî Pulspoint{% endblock %}

{% block content %}
<div class="space-y-6" x-data="deepmatchApp()">
    {# Breadcrumb + Header #}
    <div>
        <nav class="flex mb-2" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm text-gray-500">
                <li><a href="/hotlisten" class="hover:text-primary-600 transition-colors">Hotlisten</a></li>
                <li><span class="mx-1">/</span></li>
                <li><a href="/match-bereiche?category={{ category }}" class="hover:text-primary-600 transition-colors">Match-Bereiche</a></li>
                <li><span class="mx-1">/</span></li>
                <li class="font-medium text-gray-900">DeepMatch</li>
            </ol>
        </nav>
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/match-bereiche?category={{ category }}" class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                    </svg>
                    Zurueck
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        DeepMatch: {{ category_label }}
                    </h1>
                    <p class="text-sm text-gray-500">
                        {% if city %}üìç {{ city }}{% endif %}
                        {% if job_title %}‚Äî {{ job_title }}{% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    {# Pre-Filter Info-Box #}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
            </svg>
            <div class="text-sm text-blue-800">
                <p class="font-semibold mb-1">Filter angewendet:</p>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-blue-700">
                    <span>Kategorie: <strong>{{ category_label }}</strong></span>
                    {% if city %}<span>Stadt: <strong>{{ city }}</strong></span>{% endif %}
                    {% if job_title %}<span>Beruf: <strong>{{ job_title }}</strong></span>{% endif %}
                    <span>Ergebnis: <strong>{{ total_matches }} Matches</strong></span>
                </div>
            </div>
        </div>
    </div>

    {# Auswahl-Leiste #}
    <div class="flex items-center justify-between bg-white rounded-lg border border-gray-200 px-4 py-3 sticky top-0 z-10 shadow-sm">
        <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" @change="toggleAll($event)" class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="text-sm font-medium text-gray-700">Alle auswaehlen</span>
            </label>
            <span class="text-sm text-gray-500" x-show="selectedIds.length > 0">
                <span class="font-semibold text-primary-600" x-text="selectedIds.length"></span>
                <span>von {{ total_matches }} ausgewaehlt</span>
            </span>
        </div>
        <div class="flex items-center gap-4">
            {# Kosten-Anzeige #}
            <span class="text-xs text-gray-400" x-show="selectedIds.length > 0">
                Kosten: ~$<span x-text="(selectedIds.length * 0.01).toFixed(2)"></span>
            </span>
            {# Pre-Score berechnen #}
            <button hx-post="/api/hotlisten/pre-score?category={{ category }}{% if city %}&city={{ city }}{% endif %}&force=false"
                    hx-swap="none"
                    hx-on::after-request="showToast('Pre-Scoring berechnet', 'success'); setTimeout(() => location.reload(), 1500)"
                    class="inline-flex items-center gap-1.5 rounded-lg bg-gray-100 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-200 transition-colors">
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                </svg>
                Pre-Score
            </button>
            {# DeepMatch Button #}
            <button @click="startDeepMatch()"
                    :disabled="selectedIds.length === 0 || loading"
                    class="inline-flex items-center gap-1.5 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700 disabled:bg-gray-300 disabled:cursor-not-allowed shadow-sm hover:shadow transition-all">
                <svg x-show="!loading" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                </svg>
                <svg x-show="loading" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <span x-text="loading ? 'Wird bewertet...' : `DeepMatch starten (${selectedIds.length})`"></span>
            </button>
        </div>
    </div>

    {# Matches-Liste als Karten #}
    {% if matches %}
    <div class="space-y-3">
        {% for m in matches %}
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors" x-data="{ expanded: false }">
            {# Haupt-Zeile #}
            <div class="flex items-center gap-4 px-5 py-4">
                {# Checkbox #}
                <input type="checkbox"
                       value="{{ m.match_id }}"
                       @change="toggleSelect('{{ m.match_id }}')"
                       :checked="selectedIds.includes('{{ m.match_id }}')"
                       class="h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500 flex-shrink-0 cursor-pointer">

                {# Kandidat-Info #}
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-semibold text-gray-900">{{ m.candidate_name }}</span>
                        {% if m.distance_km is not none %}
                        <span class="text-xs {% if m.distance_km <= 5 %}text-green-600{% elif m.distance_km <= 15 %}text-yellow-600{% else %}text-gray-400{% endif %}">
                            üìç {{ m.distance_km }} km
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5">
                        {{ m.candidate_position }} &middot; {{ m.candidate_city }}
                    </div>
                    {% if m.candidate_job_titles %}
                    <div class="flex flex-wrap gap-1 mt-1">
                        {% for title in m.candidate_job_titles %}
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium
                            {% if title == job_title %}bg-primary-100 text-primary-700 ring-1 ring-primary-300{% else %}bg-gray-100 text-gray-600{% endif %}">
                            {{ title }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                {# Job-Info #}
                <div class="hidden sm:block text-right min-w-0 flex-shrink-0">
                    <div class="text-xs font-medium text-gray-700 truncate max-w-48">{{ m.job_position }}</div>
                    <div class="text-xs text-gray-400 truncate max-w-48">{{ m.job_company }} &middot; {{ m.job_city }}</div>
                    {% if m.job_job_titles %}
                    <div class="flex flex-wrap justify-end gap-1 mt-1">
                        {% for title in m.job_job_titles %}
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-green-50 text-green-700">
                            {{ title }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                {# Pre-Score #}
                <div class="flex-shrink-0 text-center w-16">
                    {% if m.pre_score is not none %}
                    <div class="text-lg font-bold {% if m.pre_score >= 70 %}text-green-600{% elif m.pre_score >= 40 %}text-yellow-600{% else %}text-gray-400{% endif %}">
                        {{ m.pre_score|int }}
                    </div>
                    <div class="text-xs text-gray-400">Pre-Score</div>
                    {% else %}
                    <span class="text-sm text-gray-300">‚Äî</span>
                    {% endif %}
                </div>

                {# AI-Score #}
                <div class="flex-shrink-0 text-center w-16">
                    {% if m.ai_score is not none %}
                    <button @click="expanded = !expanded" class="cursor-pointer group">
                        <div class="text-lg font-bold {% if m.ai_score >= 70 %}text-green-600{% elif m.ai_score >= 40 %}text-yellow-600{% else %}text-red-500{% endif %} group-hover:underline">
                            {{ m.ai_score|int }}%
                        </div>
                        <div class="text-xs text-gray-400">KI-Score</div>
                    </button>
                    {% else %}
                    <span class="text-sm text-gray-300">‚Äî</span>
                    {% endif %}
                </div>

                {# Feedback #}
                <div class="flex-shrink-0 flex gap-1">
                    {% if m.ai_score is not none %}
                    <button @click="sendFeedback('{{ m.match_id }}', 'good')"
                            class="p-1.5 rounded-lg {% if m.user_feedback == 'good' %}bg-green-100 ring-1 ring-green-300{% else %}hover:bg-green-50{% endif %} transition-all"
                            title="Guter Match">
                        üëç
                    </button>
                    <button @click="sendFeedback('{{ m.match_id }}', 'bad')"
                            class="p-1.5 rounded-lg {% if m.user_feedback == 'bad' %}bg-red-100 ring-1 ring-red-300{% else %}hover:bg-red-50{% endif %} transition-all"
                            title="Schlechter Match">
                        üëé
                    </button>
                    {% endif %}
                </div>
            </div>

            {# Expandierte KI-Details #}
            {% if m.ai_explanation %}
            <div x-show="expanded" x-transition x-cloak class="border-t border-gray-100 bg-gray-50 px-5 py-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {# Erklaerung #}
                    <div class="md:col-span-3">
                        <p class="text-sm text-gray-700">{{ m.ai_explanation }}</p>
                    </div>

                    {# Staerken #}
                    {% if m.ai_strengths %}
                    <div>
                        <h4 class="text-xs font-semibold text-green-700 uppercase mb-2">Staerken</h4>
                        <ul class="space-y-1">
                            {% for s in m.ai_strengths %}
                            <li class="flex items-start gap-1.5 text-sm text-gray-700">
                                <span class="text-green-500 flex-shrink-0">‚úì</span>
                                <span>{{ s }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {# Schwaechen #}
                    {% if m.ai_weaknesses %}
                    <div>
                        <h4 class="text-xs font-semibold text-red-700 uppercase mb-2">Luecken</h4>
                        <ul class="space-y-1">
                            {% for w in m.ai_weaknesses %}
                            <li class="flex items-start gap-1.5 text-sm text-gray-700">
                                <span class="text-red-400 flex-shrink-0">‚úó</span>
                                <span>{{ w }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    {# Keine Matches #}
    <div class="bg-white rounded-xl border border-gray-200 px-6 py-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
        </svg>
        <p class="mt-2 text-sm text-gray-500">Keine Matches gefunden.</p>
        <p class="text-xs text-gray-400 mt-1">Bitte zuerst Kategorisierung und Pre-Scoring ausfuehren.</p>
    </div>
    {% endif %}

    {# Navigation unten #}
    <div class="flex justify-between">
        <a href="/match-bereiche?category={{ category }}"
           class="inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Zurueck zu Match-Bereichen
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deepmatchApp() {
    return {
        selectedIds: [],
        loading: false,

        toggleSelect(matchId) {
            const idx = this.selectedIds.indexOf(matchId);
            if (idx > -1) {
                this.selectedIds.splice(idx, 1);
            } else {
                if (this.selectedIds.length >= 20) {
                    showToast('Maximal 20 Matches pro Batch', 'warning');
                    return;
                }
                this.selectedIds.push(matchId);
            }
        },

        toggleAll(event) {
            if (event.target.checked) {
                const checkboxes = document.querySelectorAll('.space-y-3 input[type="checkbox"]');
                this.selectedIds = [];
                checkboxes.forEach((cb, i) => {
                    if (i < 20) {
                        this.selectedIds.push(cb.value);
                        cb.checked = true;
                    }
                });
            } else {
                this.selectedIds = [];
                document.querySelectorAll('.space-y-3 input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        },

        async startDeepMatch() {
            if (this.selectedIds.length === 0) return;
            this.loading = true;

            try {
                const response = await fetch('/api/deepmatch/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_ids: this.selectedIds }),
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(
                        `DeepMatch abgeschlossen: ${data.evaluated} bewertet, √ò Score ${Math.round(data.avg_ai_score * 100)}%`,
                        'success'
                    );
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.detail || 'Fehler bei DeepMatch', 'error');
                }
            } catch (e) {
                showToast('Netzwerkfehler: ' + e.message, 'error');
            } finally {
                this.loading = false;
            }
        },

        async sendFeedback(matchId, feedback) {
            try {
                const response = await fetch('/api/deepmatch/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_id: matchId, feedback: feedback }),
                });

                if (response.ok) {
                    showToast('Feedback gespeichert', 'success');
                    setTimeout(() => location.reload(), 800);
                }
            } catch (e) {
                showToast('Feedback-Fehler', 'error');
            }
        }
    };
}
</script>
{% endblock %}
