{% extends "base.html" %}

{% block title %}DeepMatch {{ category_label }} ‚Äî Pulspoint{% endblock %}

{% block content %}
<div class="space-y-6" x-data="deepmatchApp()">
    {# Breadcrumb + Header #}
    <div>
        <nav class="flex mb-2" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm text-gray-500">
                <li><a href="/hotlisten" class="hover:text-gray-700">Hotlisten</a></li>
                <li><span class="mx-1">/</span></li>
                <li><a href="/match-bereiche?category={{ category }}" class="hover:text-gray-700">Match-Bereiche</a></li>
                <li><span class="mx-1">/</span></li>
                <li class="font-medium text-gray-900">DeepMatch</li>
            </ol>
        </nav>
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    DeepMatch: {{ category_label }}
                    {% if city %}<span class="text-gray-400">/ {{ city }}</span>{% endif %}
                    {% if job_title %}<span class="text-gray-400">/ {{ job_title }}</span>{% endif %}
                </h1>
                <p class="mt-1 text-sm text-gray-500">{{ total_matches }} Matches gefunden. Kandidaten auswaehlen und KI-Bewertung starten.</p>
            </div>
            <div class="flex gap-3">
                {# Pre-Score berechnen #}
                <button hx-post="/api/hotlisten/pre-score?category={{ category }}{% if city %}&city={{ city }}{% endif %}&force=false"
                        hx-swap="none"
                        hx-on::after-request="showToast('Pre-Scoring berechnet', 'success'); setTimeout(() => location.reload(), 1500)"
                        class="inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                    </svg>
                    Pre-Score berechnen
                </button>
                {# DeepMatch starten #}
                <button @click="startDeepMatch()"
                        :disabled="selectedIds.length === 0 || loading"
                        class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                    <svg x-show="!loading" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                    </svg>
                    <svg x-show="loading" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <span x-text="loading ? 'Wird bewertet...' : `DeepMatch (${selectedIds.length})`"></span>
                </button>
            </div>
        </div>
    </div>

    {# Alle auswaehlen #}
    <div class="flex items-center gap-4 bg-white rounded-lg border border-gray-200 px-4 py-3">
        <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" @change="toggleAll($event)" class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
            <span class="text-sm font-medium text-gray-700">Alle auswaehlen</span>
        </label>
        <span class="text-sm text-gray-500" x-show="selectedIds.length > 0" x-text="`${selectedIds.length} ausgewaehlt`"></span>
        <span class="text-sm text-gray-400 ml-auto">Max. 20 pro Batch | Kosten: ~$0.01 pro Bewertung</span>
    </div>

    {# Matches-Tabelle #}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-3 w-10"></th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kandidat</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Distanz</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pre-Score</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">KI-Score</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Feedback</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for m in matches %}
                    <tr class="hover:bg-gray-50 transition-colors" x-data="{ expanded: false }">
                        <td class="px-4 py-3">
                            <input type="checkbox"
                                   value="{{ m.match_id }}"
                                   @change="toggleSelect('{{ m.match_id }}')"
                                   :checked="selectedIds.includes('{{ m.match_id }}')"
                                   class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900">{{ m.candidate_name }}</div>
                            <div class="text-xs text-gray-500">{{ m.candidate_position }} &middot; {{ m.candidate_city }}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900">{{ m.job_position }}</div>
                            <div class="text-xs text-gray-500">{{ m.job_company }} &middot; {{ m.job_city }}</div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if m.distance_km is not none %}
                            <span class="text-sm {% if m.distance_km <= 5 %}text-green-600 font-medium{% elif m.distance_km <= 15 %}text-yellow-600{% else %}text-gray-500{% endif %}">
                                {{ m.distance_km }} km
                            </span>
                            {% else %}
                            <span class="text-sm text-gray-400">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if m.pre_score is not none %}
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium
                                {% if m.pre_score >= 70 %}bg-green-100 text-green-800
                                {% elif m.pre_score >= 40 %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-600{% endif %}">
                                {{ m.pre_score|int }}
                            </span>
                            {% else %}
                            <span class="text-sm text-gray-400">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if m.ai_score is not none %}
                            <button @click="expanded = !expanded" class="cursor-pointer">
                                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-bold
                                    {% if m.ai_score >= 70 %}bg-green-100 text-green-800
                                    {% elif m.ai_score >= 40 %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ m.ai_score|int }}%
                                </span>
                            </button>
                            {% else %}
                            <span class="text-sm text-gray-400">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if m.ai_score is not none %}
                            <div class="flex justify-center gap-1">
                                <button @click="sendFeedback('{{ m.match_id }}', 'good')"
                                        class="p-1 rounded {% if m.user_feedback == 'good' %}bg-green-100{% else %}hover:bg-green-50{% endif %} transition-colors"
                                        title="Gut">
                                    <span class="text-sm">üëç</span>
                                </button>
                                <button @click="sendFeedback('{{ m.match_id }}', 'bad')"
                                        class="p-1 rounded {% if m.user_feedback == 'bad' %}bg-red-100{% else %}hover:bg-red-50{% endif %} transition-colors"
                                        title="Schlecht">
                                    <span class="text-sm">üëé</span>
                                </button>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {# Expandierte KI-Details #}
                    {% if m.ai_explanation %}
                    <tr x-show="expanded" x-transition class="bg-gray-50">
                        <td></td>
                        <td colspan="6" class="px-4 py-3">
                            <div class="text-sm text-gray-700 space-y-2">
                                <p>{{ m.ai_explanation }}</p>
                                {% if m.ai_strengths %}
                                <div class="flex flex-wrap gap-1">
                                    {% for s in m.ai_strengths %}
                                    <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs text-green-700">+ {{ s }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if m.ai_weaknesses %}
                                <div class="flex flex-wrap gap-1">
                                    {% for w in m.ai_weaknesses %}
                                    <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-0.5 text-xs text-red-700">- {{ w }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}

                    {% if not matches %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                            <p class="mt-2 text-sm text-gray-500">Keine Matches gefunden.</p>
                            <p class="text-xs text-gray-400 mt-1">Bitte zuerst Kategorisierung und Pre-Scoring ausfuehren.</p>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deepmatchApp() {
    return {
        selectedIds: [],
        loading: false,

        toggleSelect(matchId) {
            const idx = this.selectedIds.indexOf(matchId);
            if (idx > -1) {
                this.selectedIds.splice(idx, 1);
            } else {
                if (this.selectedIds.length >= 20) {
                    showToast('Maximal 20 Matches pro Batch', 'warning');
                    return;
                }
                this.selectedIds.push(matchId);
            }
        },

        toggleAll(event) {
            if (event.target.checked) {
                const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                this.selectedIds = [];
                checkboxes.forEach((cb, i) => {
                    if (i < 20) {
                        this.selectedIds.push(cb.value);
                        cb.checked = true;
                    }
                });
            } else {
                this.selectedIds = [];
                document.querySelectorAll('tbody input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        },

        async startDeepMatch() {
            if (this.selectedIds.length === 0) return;
            this.loading = true;

            try {
                const response = await fetch('/api/deepmatch/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_ids: this.selectedIds }),
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(
                        `DeepMatch abgeschlossen: ${data.evaluated} bewertet, √ò Score ${Math.round(data.avg_ai_score * 100)}%`,
                        'success'
                    );
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.detail || 'Fehler bei DeepMatch', 'error');
                }
            } catch (e) {
                showToast('Netzwerkfehler: ' + e.message, 'error');
            } finally {
                this.loading = false;
            }
        },

        async sendFeedback(matchId, feedback) {
            try {
                const response = await fetch('/api/deepmatch/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_id: matchId, feedback: feedback }),
                });

                if (response.ok) {
                    showToast('Feedback gespeichert', 'success');
                }
            } catch (e) {
                showToast('Feedback-Fehler', 'error');
            }
        }
    };
}
</script>
{% endblock %}
