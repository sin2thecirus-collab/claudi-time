{% extends "base.html" %}

{% block title %}DeepMatch ‚Äî Pulspoint{% endblock %}

{% block content %}
<div class="space-y-6" x-data="deepMatchHub()">
    {# Header #}
    <div>
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">DeepMatch</h1>
                <p class="text-sm text-gray-500 mt-1">Alle KI-bewerteten Matches auf einen Blick</p>
            </div>
        </div>
    </div>

    {# Statistik-Karten #}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-2xl font-bold text-gray-900">{{ total_matches }}</div>
            <div class="text-xs text-gray-500 mt-1">KI-bewertete Matches</div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-2xl font-bold {% if avg_ai_score >= 70 %}text-green-600{% elif avg_ai_score >= 40 %}text-yellow-600{% else %}text-gray-400{% endif %}">{{ avg_ai_score|int }}%</div>
            <div class="text-xs text-gray-500 mt-1">Durchschnitt KI-Score</div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-2xl font-bold text-green-600">{{ good_count }}</div>
            <div class="text-xs text-gray-500 mt-1">Positives Feedback</div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-2xl font-bold text-red-500">{{ bad_count }}</div>
            <div class="text-xs text-gray-500 mt-1">Negatives Feedback</div>
        </div>
    </div>

    {# Filter-Leiste #}
    <div class="flex flex-wrap items-center gap-3 bg-white rounded-lg border border-gray-200 px-4 py-3">
        {# Kategorie-Filter #}
        <div class="flex items-center gap-2">
            <span class="text-xs font-medium text-gray-500 uppercase">Kategorie:</span>
            <a href="/deep-match?sort={{ sort }}"
               class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium transition-colors
                   {% if not category %}bg-primary-100 text-primary-700 ring-1 ring-primary-300{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Alle
            </a>
            <a href="/deep-match?category=FINANCE&sort={{ sort }}"
               class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium transition-colors
                   {% if category == 'FINANCE' %}bg-primary-100 text-primary-700 ring-1 ring-primary-300{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Finance
            </a>
            <a href="/deep-match?category=ENGINEERING&sort={{ sort }}"
               class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium transition-colors
                   {% if category == 'ENGINEERING' %}bg-primary-100 text-primary-700 ring-1 ring-primary-300{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Engineering
            </a>
        </div>

        <div class="hidden sm:block w-px h-6 bg-gray-200"></div>

        {# Sortierung #}
        <div class="flex items-center gap-2">
            <span class="text-xs font-medium text-gray-500 uppercase">Sortierung:</span>
            <a href="/deep-match?{% if category %}category={{ category }}&{% endif %}sort=recent"
               class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium transition-colors
                   {% if sort == 'recent' %}bg-primary-100 text-primary-700 ring-1 ring-primary-300{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Neueste
            </a>
            <a href="/deep-match?{% if category %}category={{ category }}&{% endif %}sort=score"
               class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium transition-colors
                   {% if sort == 'score' %}bg-primary-100 text-primary-700 ring-1 ring-primary-300{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Bester Score
            </a>
            <a href="/deep-match?{% if category %}category={{ category }}&{% endif %}sort=distance"
               class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium transition-colors
                   {% if sort == 'distance' %}bg-primary-100 text-primary-700 ring-1 ring-primary-300{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                Naechste Entfernung
            </a>
        </div>
    </div>

    {# Matches-Liste #}
    {% if matches %}
    <div class="space-y-3">
        {% for m in matches %}
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors" x-data="{ expanded: false }">
            {# Haupt-Zeile #}
            <div class="flex items-center gap-4 px-5 py-4">
                {# Kandidat-Info #}
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <a href="/kandidaten/{{ m.candidate_id }}" class="text-sm font-semibold text-gray-900 hover:text-primary-600 transition-colors">
                            {{ m.candidate_name }}
                        </a>
                        {% if m.distance_km is not none %}
                        <span class="text-xs {% if m.distance_km <= 5 %}text-green-600{% elif m.distance_km <= 15 %}text-yellow-600{% else %}text-gray-400{% endif %}">
                            {{ m.distance_km }} km
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5">
                        {{ m.candidate_position }} &middot; {{ m.candidate_city }}
                    </div>
                    {% if m.candidate_job_titles %}
                    <div class="flex flex-wrap gap-1 mt-1">
                        {% for title in m.candidate_job_titles %}
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600">
                            {{ title }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                {# Job-Info #}
                <div class="hidden sm:block text-right min-w-0 flex-shrink-0">
                    <div class="text-xs font-medium text-gray-700 truncate max-w-48">
                        {% if m.job_url %}
                        <a href="{{ m.job_url }}" target="_blank" class="hover:text-primary-600 transition-colors">{{ m.job_position }}</a>
                        {% else %}
                        {{ m.job_position }}
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-400 truncate max-w-48">{{ m.job_company }} &middot; {{ m.job_city }}</div>
                    {% if m.job_job_titles %}
                    <div class="flex flex-wrap justify-end gap-1 mt-1">
                        {% for title in m.job_job_titles %}
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-green-50 text-green-700">
                            {{ title }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                {# Herkunft-Badge #}
                <div class="hidden lg:flex flex-shrink-0 flex-col items-center">
                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-50 text-blue-700">
                        {{ m.match_job_title }}
                    </span>
                    <span class="text-xs text-gray-400 mt-0.5">{{ m.match_city }}</span>
                </div>

                {# Pre-Score #}
                <div class="flex-shrink-0 text-center w-14">
                    {% if m.pre_score is not none %}
                    <div class="text-base font-bold {% if m.pre_score >= 70 %}text-green-600{% elif m.pre_score >= 40 %}text-yellow-600{% else %}text-gray-400{% endif %}">
                        {{ m.pre_score|int }}
                    </div>
                    <div class="text-xs text-gray-400">Pre</div>
                    {% else %}
                    <span class="text-sm text-gray-300">&mdash;</span>
                    {% endif %}
                </div>

                {# AI-Score #}
                <div class="flex-shrink-0 text-center w-14">
                    {% if m.ai_score is not none %}
                    <button @click="expanded = !expanded" class="cursor-pointer group">
                        <div class="text-base font-bold {% if m.ai_score >= 70 %}text-green-600{% elif m.ai_score >= 40 %}text-yellow-600{% else %}text-red-500{% endif %} group-hover:underline">
                            {{ m.ai_score|int }}%
                        </div>
                        <div class="text-xs text-gray-400">KI</div>
                    </button>
                    {% else %}
                    <span class="text-sm text-gray-300">&mdash;</span>
                    {% endif %}
                </div>

                {# Feedback + Notiz #}
                <div class="flex-shrink-0 flex gap-1">
                    <button @click="sendFeedback('{{ m.match_id }}', 'good')"
                            class="p-1.5 rounded-lg {% if m.user_feedback == 'good' %}bg-green-100 ring-1 ring-green-300{% else %}hover:bg-green-50{% endif %} transition-all"
                            title="Guter Match">
                        üëç
                    </button>
                    <button @click="sendFeedback('{{ m.match_id }}', 'bad')"
                            class="p-1.5 rounded-lg {% if m.user_feedback == 'bad' %}bg-red-100 ring-1 ring-red-300{% else %}hover:bg-red-50{% endif %} transition-all"
                            title="Schlechter Match">
                        üëé
                    </button>
                    <button @click="promptNote('{{ m.match_id }}')"
                            class="p-1.5 rounded-lg {% if m.feedback_note %}bg-blue-100 ring-1 ring-blue-300{% else %}hover:bg-blue-50{% endif %} transition-all"
                            title="{% if m.feedback_note %}Notiz: {{ m.feedback_note }}{% else %}Notiz hinzufuegen{% endif %}">
                        üìù
                    </button>
                </div>
            </div>

            {# Expandierte KI-Details #}
            {% if m.ai_explanation %}
            <div x-show="expanded" x-transition x-cloak class="border-t border-gray-100 bg-gray-50 px-5 py-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {# Erklaerung #}
                    <div class="md:col-span-3">
                        <p class="text-sm text-gray-700">{{ m.ai_explanation }}</p>
                        {% if m.ai_checked_at %}
                        <p class="text-xs text-gray-400 mt-2">Bewertet am {{ m.ai_checked_at }}</p>
                        {% endif %}
                    </div>

                    {# Staerken #}
                    {% if m.ai_strengths %}
                    <div>
                        <h4 class="text-xs font-semibold text-green-700 uppercase mb-2">Staerken</h4>
                        <ul class="space-y-1">
                            {% for s in m.ai_strengths %}
                            <li class="flex items-start gap-1.5 text-sm text-gray-700">
                                <span class="text-green-500 flex-shrink-0">&#10003;</span>
                                <span>{{ s }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {# Schwaechen #}
                    {% if m.ai_weaknesses %}
                    <div>
                        <h4 class="text-xs font-semibold text-red-700 uppercase mb-2">Luecken</h4>
                        <ul class="space-y-1">
                            {% for w in m.ai_weaknesses %}
                            <li class="flex items-start gap-1.5 text-sm text-gray-700">
                                <span class="text-red-400 flex-shrink-0">&#10007;</span>
                                <span>{{ w }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                {# Vergleich-Button unter KI-Details #}
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <button @click.stop="openSplitView('{{ m.match_id }}')"
                            class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                        </svg>
                        Vergleich: Job vs. Kandidat
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    {# Empty State #}
    <div class="bg-white rounded-xl border border-gray-200 px-6 py-16 text-center">
        <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
        </svg>
        <h3 class="mt-4 text-lg font-semibold text-gray-900">Noch keine DeepMatch-Ergebnisse</h3>
        <p class="mt-2 text-sm text-gray-500 max-w-md mx-auto">
            Gehe zum <a href="/pre-match" class="text-primary-600 hover:text-primary-700 font-medium">Pre-Match Bereich</a>,
            waehle Kandidaten aus und starte den Deep Match um KI-bewertete Ergebnisse hier zu sehen.
        </p>
    </div>
    {% endif %}

    {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Split-View Modal ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
    <div x-show="splitViewOpen" x-cloak
         class="fixed inset-0 z-50 flex"
         @keydown.escape.window="closeSplitView()">
        {# Backdrop #}
        <div class="absolute inset-0 bg-black/50" @click="closeSplitView()"></div>

        {# Modal-Container #}
        <div class="relative mx-auto my-4 w-full max-w-7xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             style="max-height: calc(100vh - 2rem);">

            {# Header #}
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50 flex-shrink-0">
                <h2 class="text-lg font-bold text-gray-900">Vergleich: Jobbeschreibung vs. Kandidat</h2>
                <button @click="closeSplitView()" class="p-2 rounded-lg hover:bg-gray-200 transition-colors">
                    <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            {# Split-Content #}
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 divide-x divide-gray-200 overflow-hidden">
                {# Linke Seite: Jobbeschreibung #}
                <div class="overflow-y-auto p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100">
                            <svg class="w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                        </span>
                        <h3 class="text-base font-bold text-gray-900">Jobbeschreibung</h3>
                    </div>
                    <div id="sv-job-content" class="prose prose-sm max-w-none text-gray-700"></div>
                </div>

                {# Rechte Seite: Kandidat-Lebenslauf #}
                <div class="overflow-y-auto p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-green-100">
                            <svg class="w-4 h-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                            </svg>
                        </span>
                        <h3 class="text-base font-bold text-gray-900">Kandidat-Lebenslauf</h3>
                    </div>
                    <div id="sv-candidate-content" class="text-gray-700"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
{# Match-Daten fuer Split-View #}
const MATCH_DATA = {
    {% for m in matches %}
    '{{ m.match_id }}': {
        job_position: {{ m.job_position | tojson }},
        job_company: {{ m.job_company | tojson }},
        job_city: {{ m.job_city | tojson }},
        job_text: {{ m.job_text | tojson }},
        candidate_name: {{ m.candidate_name | tojson }},
        candidate_position: {{ m.candidate_position | tojson }},
        candidate_city: {{ m.candidate_city | tojson }},
        candidate_work_history: {{ m.candidate_work_history | tojson }},
        candidate_education: {{ m.candidate_education | tojson }},
        candidate_further_education: {{ m.candidate_further_education | tojson }},
        candidate_it_skills: {{ m.candidate_it_skills | tojson }},
        candidate_languages: {{ m.candidate_languages | tojson }},
        candidate_current_position: {{ m.candidate_current_position | tojson }},
        candidate_skills: {{ m.candidate_skills | tojson }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatDateRange(start, end) {
    var parts = [];
    if (start) parts.push(escapeHtml(start));
    if (end) parts.push(escapeHtml(end));
    else if (start) parts.push('heute');
    return parts.join(' - ');
}

function formatBullets(text) {
    if (!text) return '';
    return escapeHtml(text).replace(/\n/g, '<br>');
}

function populateSplitView(matchId) {
    var data = MATCH_DATA[matchId];
    if (!data) return;

    // --- Jobbeschreibung ---
    var jobHtml = '<div class="mb-3">';
    jobHtml += '<h4 class="text-lg font-bold text-gray-900">' + escapeHtml(data.job_position) + '</h4>';
    jobHtml += '<p class="text-sm text-gray-500">' + escapeHtml(data.job_company) + ' &middot; ' + escapeHtml(data.job_city) + '</p>';
    jobHtml += '</div>';

    if (data.job_text) {
        var lines = data.job_text.split('\n');
        var formatted = '';
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (!line) { formatted += '<br>'; continue; }
            // Section headers
            if (/^(Ueber uns|Ihre Aufgaben|Ihr Profil|Wir bieten|Was wir bieten|Benefits|Kontakt|Anforderungen|Qualifikationen|Das erwartet|Das bringen Sie mit|Wir erwarten|Aufgaben|Profil|Stellenbeschreibung|Unternehmensbeschreibung|Deine Aufgaben|Dein Profil|Was dich erwartet|Was du mitbringst)/i.test(line)) {
                formatted += '<h5 class="text-sm font-bold text-gray-800 mt-4 mb-2">' + escapeHtml(line) + '</h5>';
            } else if (/^[-\u2022\u25CF\u25AA\u25E6\u2013\u2014]/.test(line)) {
                formatted += '<div class="flex items-start gap-2 ml-2 mb-1"><span class="text-primary-500 mt-0.5 flex-shrink-0">&bull;</span><span class="text-sm">' + escapeHtml(line.replace(/^[-\u2022\u25CF\u25AA\u25E6\u2013\u2014]\s*/, '')) + '</span></div>';
            } else {
                formatted += '<p class="text-sm mb-1">' + escapeHtml(line) + '</p>';
            }
        }
        jobHtml += formatted;
    } else {
        jobHtml += '<p class="text-sm text-gray-400 italic">Keine Jobbeschreibung vorhanden</p>';
    }

    document.getElementById('sv-job-content').innerHTML = jobHtml;

    // --- Kandidat-Lebenslauf ---
    document.getElementById('sv-candidate-content').innerHTML = buildCandidateCV(data);
}

function buildCandidateCV(data) {
    var html = '';

    // Header
    html += '<div class="mb-4 pb-3 border-b border-gray-200">';
    html += '<h4 class="text-lg font-bold text-gray-900">' + escapeHtml(data.candidate_name) + '</h4>';
    if (data.candidate_current_position) {
        html += '<p class="text-sm text-primary-600 font-medium">' + escapeHtml(data.candidate_current_position) + '</p>';
    }
    html += '<p class="text-sm text-gray-500">' + escapeHtml(data.candidate_city) + '</p>';
    html += '</div>';

    // Berufserfahrung
    if (data.candidate_work_history && data.candidate_work_history.length > 0) {
        html += '<div class="mb-5">';
        html += '<h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>Berufserfahrung</h5>';
        for (var i = 0; i < data.candidate_work_history.length; i++) {
            var wh = data.candidate_work_history[i];
            html += '<div class="ml-6 mb-3 pb-3 border-b border-gray-100 last:border-0">';
            html += '<div class="font-semibold text-sm text-gray-900">' + escapeHtml(wh.position || wh.title || '') + '</div>';
            html += '<div class="text-xs text-gray-500">' + escapeHtml(wh.company || '') + '</div>';
            var dr = formatDateRange(wh.start_date, wh.end_date);
            if (dr) html += '<div class="text-xs text-gray-400">' + dr + '</div>';
            if (wh.description) html += '<div class="text-xs text-gray-600 mt-1">' + formatBullets(wh.description) + '</div>';
            html += '</div>';
        }
        html += '</div>';
    }

    // Ausbildung
    if (data.candidate_education && data.candidate_education.length > 0) {
        html += '<div class="mb-5">';
        html += '<h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342" /></svg>Ausbildung</h5>';
        for (var i = 0; i < data.candidate_education.length; i++) {
            var edu = data.candidate_education[i];
            html += '<div class="ml-6 mb-3 pb-3 border-b border-gray-100 last:border-0">';
            html += '<div class="font-semibold text-sm text-gray-900">' + escapeHtml(edu.degree || edu.field_of_study || '') + '</div>';
            html += '<div class="text-xs text-gray-500">' + escapeHtml(edu.institution || '') + '</div>';
            var dr = formatDateRange(edu.start_date, edu.end_date);
            if (dr) html += '<div class="text-xs text-gray-400">' + dr + '</div>';
            html += '</div>';
        }
        html += '</div>';
    }

    // Weiterbildung
    if (data.candidate_further_education && data.candidate_further_education.length > 0) {
        html += '<div class="mb-5">';
        html += '<h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>Weiterbildung</h5>';
        for (var i = 0; i < data.candidate_further_education.length; i++) {
            var fe = data.candidate_further_education[i];
            html += '<div class="ml-6 mb-2">';
            html += '<div class="font-semibold text-sm text-gray-900">' + escapeHtml(fe.degree || fe.field_of_study || fe.title || '') + '</div>';
            if (fe.institution) html += '<div class="text-xs text-gray-500">' + escapeHtml(fe.institution) + '</div>';
            html += '</div>';
        }
        html += '</div>';
    }

    // IT-Skills
    if (data.candidate_it_skills && data.candidate_it_skills.length > 0) {
        html += '<div class="mb-5">';
        html += '<h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">IT-Kenntnisse</h5>';
        html += '<div class="flex flex-wrap gap-1.5 ml-6">';
        for (var i = 0; i < data.candidate_it_skills.length; i++) {
            html += '<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-blue-50 text-blue-700">' + escapeHtml(data.candidate_it_skills[i]) + '</span>';
        }
        html += '</div></div>';
    }

    // Skills
    if (data.candidate_skills && data.candidate_skills.length > 0) {
        html += '<div class="mb-5">';
        html += '<h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Weitere Kenntnisse</h5>';
        html += '<div class="flex flex-wrap gap-1.5 ml-6">';
        for (var i = 0; i < data.candidate_skills.length; i++) {
            html += '<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-purple-50 text-purple-700">' + escapeHtml(data.candidate_skills[i]) + '</span>';
        }
        html += '</div></div>';
    }

    // Sprachen
    if (data.candidate_languages && data.candidate_languages.length > 0) {
        html += '<div class="mb-5">';
        html += '<h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Sprachen</h5>';
        html += '<div class="space-y-1 ml-6">';
        for (var i = 0; i < data.candidate_languages.length; i++) {
            var lang = data.candidate_languages[i];
            var name = lang.language || lang.name || '';
            var level = lang.level || lang.proficiency || '';
            html += '<div class="flex items-center justify-between text-sm"><span class="text-gray-700">' + escapeHtml(name) + '</span>';
            if (level) html += '<span class="text-xs text-gray-400">' + escapeHtml(level) + '</span>';
            html += '</div>';
        }
        html += '</div></div>';
    }

    if (!html || html === '') {
        html = '<p class="text-sm text-gray-400 italic">Keine Lebenslauf-Daten vorhanden</p>';
    }

    return html;
}

function deepMatchHub() {
    return {
        splitViewOpen: false,
        splitViewMatchId: null,

        openSplitView(matchId) {
            this.splitViewMatchId = matchId;
            this.splitViewOpen = true;
            document.body.style.overflow = 'hidden';
            this.$nextTick(function() { populateSplitView(matchId); });
        },

        closeSplitView() {
            this.splitViewOpen = false;
            this.splitViewMatchId = null;
            document.body.style.overflow = '';
        },

        async sendFeedback(matchId, feedback) {
            try {
                const resp = await fetch('/api/deepmatch/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_id: matchId, feedback: feedback }),
                });
                if (resp.ok) {
                    showToast('Feedback gespeichert', 'success', 2000);
                    setTimeout(function() { window.location.reload(); }, 800);
                } else {
                    showToast('Fehler beim Speichern', 'error');
                }
            } catch (e) {
                showToast('Netzwerkfehler: ' + e.message, 'error');
            }
        },

        async promptNote(matchId) {
            var note = prompt('Feedback-Notiz:');
            if (note === null) return;

            try {
                const resp = await fetch('/api/deepmatch/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_id: matchId, feedback: 'note', note: note }),
                });
                if (resp.ok) {
                    showToast('Notiz gespeichert', 'success', 2000);
                    setTimeout(function() { window.location.reload(); }, 800);
                } else {
                    showToast('Fehler beim Speichern', 'error');
                }
            } catch (e) {
                showToast('Netzwerkfehler: ' + e.message, 'error');
            }
        }
    };
}
</script>
{% endblock %}
