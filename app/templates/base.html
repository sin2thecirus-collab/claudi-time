<!DOCTYPE html>
<html lang="de" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Pulspoint{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
                            400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb',
                            700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- DM Sans Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --pp-bg: #0F1117;
            --pp-surface: #181A23;
            --pp-surfaceHover: #1E2130;
            --pp-border: #2A2D3A;
            --pp-borderLight: #353848;
            --pp-text: #E8E9ED;
            --pp-textMuted: #8B8FA3;
            --pp-textDim: #5C6078;
            --pp-accent: #4F8CFF;
            --pp-accentSoft: rgba(79,140,255,0.12);
            --pp-accentGlow: rgba(79,140,255,0.25);
            --pp-green: #34D399;
            --pp-greenSoft: rgba(52,211,153,0.12);
            --pp-orange: #F59E0B;
            --pp-orangeSoft: rgba(245,158,11,0.12);
            --pp-red: #EF4444;
            --pp-redSoft: rgba(239,68,68,0.12);
            --pp-purple: #A78BFA;
            --pp-purpleSoft: rgba(167,139,250,0.12);
            --pp-ff: 'DM Sans', 'SF Pro Display', -apple-system, sans-serif;
        }

        * { box-sizing: border-box; }
        [x-cloak] { display: none !important; }

        html {
            overflow-x: hidden;
        }

        body {
            background: var(--pp-bg);
            color: var(--pp-text);
            font-family: var(--pp-ff);
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            zoom: 1.15;
            overflow-x: hidden;
        }

        /* Responsive Zoom: kleinere Screens bekommen weniger Zoom */
        @media (max-width: 1440px) {
            body { zoom: 1.1; }
        }
        @media (max-width: 1366px) {
            body { zoom: 1.05; }
        }
        @media (max-width: 1024px) {
            body { zoom: 1; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--pp-border); border-radius: 3px; }
        ::selection { background: var(--pp-accentGlow); }

        /* HTMX Loading */
        .htmx-request .htmx-indicator { display: inline-block; }
        .htmx-indicator { display: none; }

        /* Animations */
        @keyframes skeleton-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-skeleton { animation: skeleton-pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }

        @keyframes toast-in { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
        .toast-enter { animation: toast-in 0.3s ease-out; }
        .toast-leave { animation: toast-out 0.3s ease-in forwards; }

        @keyframes modal-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-enter { animation: modal-in 0.2s ease-out; }

        @keyframes slideOverIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOverOut { from { transform: translateX(0); } to { transform: translateX(100%); } }
        .quickadd-panel-enter { animation: slideOverIn 0.3s cubic-bezier(0.4,0,0.2,1) forwards; }
        .quickadd-panel-leave { animation: slideOverOut 0.25s cubic-bezier(0.4,0,0.2,1) forwards; }

        /* Dark Inputs */
        select option { background: var(--pp-surface); color: var(--pp-text); }

        /* Nav link active */
        .pp-nav-item { padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; color: var(--pp-textMuted); background: transparent; text-decoration: none; display: inline-flex; align-items: center; transition: all 0.15s; border: none; white-space: nowrap; font-family: var(--pp-ff); }
        .pp-nav-item:hover { color: var(--pp-text); background: var(--pp-surfaceHover); }
        .pp-nav-item.active { color: var(--pp-accent); background: var(--pp-accentSoft); }
    </style>

    {% block head %}{% endblock %}
</head>
<body x-data="{ sidebarOpen: false }">
    <!-- ‚ïê‚ïê‚ïê TOP NAVIGATION BAR ‚ïê‚ïê‚ïê -->
    <nav style="display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:60px;border-bottom:1px solid var(--pp-border);background:rgba(24,26,35,0.8);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100;">
        <!-- Left: Logo + Nav Items -->
        <div style="display:flex;align-items:center;gap:28px;">
            <!-- Logo -->
            <a href="/" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                <div style="width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,#4F8CFF,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff;">P</div>
                <span style="font-size:18px;font-weight:700;color:var(--pp-text);letter-spacing:-0.02em;">Pulspoint</span>
            </a>
            <!-- Desktop Nav Items -->
            <div class="hidden sm:flex" style="gap:4px;">
                <a href="/" class="pp-nav-item {% if request.url.path == '/' %}active{% endif %}">Dashboard</a>
                <a href="/jobs" class="pp-nav-item {% if request.url.path == '/jobs' %}active{% endif %}">Jobs</a>
                <a href="/kandidaten" class="pp-nav-item {% if request.url.path.startswith('/kandidaten') %}active{% endif %}">Kandidaten</a>
                <a href="/unternehmen" class="pp-nav-item {% if request.url.path.startswith('/unternehmen') %}active{% endif %}">Unternehmen</a>
                <div class="relative" x-data="{ atsOpen: false }">
                    <button @click="atsOpen = !atsOpen" class="pp-nav-item {% if request.url.path.startswith('/ats') %}active{% endif %}" style="gap:4px;">
                        ATS
                        <svg style="width:12px;height:12px;transition:transform .15s;" :style="atsOpen ? 'transform:rotate(180deg)' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                    </button>
                    <div x-show="atsOpen" @click.away="atsOpen = false" x-transition style="display:none;position:absolute;left:0;top:100%;margin-top:6px;width:200px;background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:12px;padding:5px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,0.4);">
                        <a href="/ats" style="display:block;padding:10px 14px;border-radius:8px;color:var(--pp-text);text-decoration:none;font-size:14px;font-weight:500;transition:background .15s;" onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='transparent'">Pipeline</a>
                    </div>
                </div>
                <a href="/hotlisten" class="pp-nav-item {% if request.url.path.startswith('/hotlisten') or request.url.path.startswith('/match-bereiche') or request.url.path.startswith('/deepmatch') %}active{% endif %}">Hotlisten</a>
                <a href="/match-center" class="pp-nav-item {% if request.url.path.startswith('/match-center') %}active{% endif %}">Match Center</a>
                <a href="/titel-zuweisung" class="pp-nav-item {% if request.url.path.startswith('/titel-zuweisung') %}active{% endif %}">Titel</a>
                <a href="/statistiken" class="pp-nav-item {% if request.url.path == '/statistiken' %}active{% endif %}">Statistiken</a>
            </div>
        </div>

        <!-- Right: Quick-Add + System Status -->
        <div class="hidden sm:flex" style="align-items:center;gap:14px;">
            <!-- Quick-Add Button -->
            <div class="relative" x-data="{ quickAdd: false }">
                <button @click="quickAdd = !quickAdd" style="width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#4F8CFF,#6C63FF);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:700;transition:all .15s;" title="Neu erstellen">
                    <svg style="width:17px;height:17px;transition:transform .2s;" :style="quickAdd ? 'transform:rotate(45deg)' : ''" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/></svg>
                </button>
                <div x-show="quickAdd" @click.away="quickAdd = false" x-transition style="display:none;position:absolute;right:0;top:100%;margin-top:8px;width:240px;background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:14px;padding:6px;z-index:50;box-shadow:0 12px 40px rgba(0,0,0,0.5);">
                    <div style="padding:8px 12px;font-size:11px;font-weight:600;color:var(--pp-textDim);text-transform:uppercase;letter-spacing:0.05em;">Neu erstellen</div>
                    <button @click="quickAdd=false;openQuickAdd('kandidat')" style="width:100%;display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:none;background:transparent;color:var(--pp-text);font-size:14px;font-weight:500;cursor:pointer;font-family:var(--pp-ff);transition:background .15s;text-align:left;" onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='transparent'">
                        <span style="width:32px;height:32px;border-radius:9px;background:var(--pp-accentSoft);display:flex;align-items:center;justify-content:center;font-size:14px;">üë§</span>
                        Kandidat
                    </button>
                    <button @click="quickAdd=false;openQuickAdd('unternehmen')" style="width:100%;display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:none;background:transparent;color:var(--pp-text);font-size:14px;font-weight:500;cursor:pointer;font-family:var(--pp-ff);transition:background .15s;text-align:left;" onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='transparent'">
                        <span style="width:32px;height:32px;border-radius:9px;background:var(--pp-greenSoft);display:flex;align-items:center;justify-content:center;font-size:14px;">üè¢</span>
                        Unternehmen
                    </button>
                    <div style="height:1px;background:var(--pp-border);margin:4px 6px;"></div>
                    <button @click="quickAdd=false;openQuickAdd('job')" style="width:100%;display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:none;background:transparent;color:var(--pp-text);font-size:14px;font-weight:500;cursor:pointer;font-family:var(--pp-ff);transition:background .15s;text-align:left;" onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='transparent'">
                        <span style="width:32px;height:32px;border-radius:9px;background:var(--pp-purpleSoft);display:flex;align-items:center;justify-content:center;font-size:14px;">üíº</span>
                        Job
                    </button>
                    <button @click="quickAdd=false;openQuickAdd('stelle')" style="width:100%;display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:none;background:transparent;color:var(--pp-text);font-size:14px;font-weight:500;cursor:pointer;font-family:var(--pp-ff);transition:background .15s;text-align:left;" onmouseover="this.style.background='var(--pp-surfaceHover)'" onmouseout="this.style.background='transparent'">
                        <span style="width:32px;height:32px;border-radius:9px;background:var(--pp-redSoft);display:flex;align-items:center;justify-content:center;font-size:14px;">üéØ</span>
                        Stelle
                    </button>
                </div>
            </div>

            <!-- System Status Badge -->
            <div id="health-indicator"
                 hx-get="/api/health"
                 hx-trigger="load, every 30s"
                 hx-swap="innerHTML"
                 style="display:flex;align-items:center;gap:7px;padding:6px 12px;border-radius:22px;background:var(--pp-greenSoft);font-size:13px;font-weight:600;color:var(--pp-green);">
                <div style="width:8px;height:8px;border-radius:50%;background:var(--pp-green);"></div>
                <span>Laden...</span>
            </div>
        </div>

        <!-- Mobile Menu Button -->
        <div class="flex items-center sm:hidden">
            <button @click="sidebarOpen = !sidebarOpen" type="button" style="padding:10px;border-radius:10px;border:1px solid var(--pp-border);background:transparent;color:var(--pp-textMuted);cursor:pointer;">
                <svg x-show="!sidebarOpen" style="width:22px;height:22px;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
                <svg x-show="sidebarOpen" style="width:22px;height:22px;display:none;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <div x-show="sidebarOpen" x-transition class="sm:hidden" style="display:none;background:var(--pp-surface);border-bottom:1px solid var(--pp-border);padding:8px;">
        <a href="/" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Dashboard</a>
        <a href="/jobs" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Jobs</a>
        <a href="/kandidaten" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Kandidaten</a>
        <a href="/unternehmen" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Unternehmen</a>
        <a href="/ats" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">ATS</a>
        <a href="/hotlisten" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Hotlisten</a>
        <a href="/match-center" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Match Center</a>
        <a href="/titel-zuweisung" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Titel</a>
        <a href="/statistiken" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Statistiken</a>
        <a href="/einstellungen" style="display:block;padding:12px 16px;border-radius:10px;color:var(--pp-text);text-decoration:none;font-size:15px;font-weight:500;">Einstellungen</a>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" style="position:fixed;top:68px;right:18px;z-index:200;display:flex;flex-direction:column;gap:10px;pointer-events:none;"></div>

    <!-- Alert Banner Container -->
    <div id="alert-banner-container" hx-get="/api/alerts/active" hx-trigger="load, alertsChanged from:body" hx-swap="innerHTML"></div>

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Modal Container -->
    <div id="modal-container"
         x-data="{ open: false }"
         @open-modal.window="open = true"
         @close-modal.window="open = false"
         @keydown.escape.window="open = false"
         x-show="open" x-cloak
         style="position:relative;z-index:150;">
        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);"></div>
        <div style="position:fixed;inset:0;z-index:10;overflow-y:auto;" @click.self="open = false">
            <div style="display:flex;min-height:100%;align-items:center;justify-content:center;padding:20px;" @click.self="open = false">
                <div id="modal-content" @click.stop style="position:relative;background:var(--pp-surface);border:1px solid var(--pp-border);border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,0.5);width:100%;max-width:540px;overflow:hidden;">
                </div>
            </div>
        </div>
    </div>

    <!-- Quick-Add Slide-Over -->
    <div id="quickadd-overlay" style="position:fixed;inset:0;z-index:150;display:none;">
        <div id="quickadd-backdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);transition:opacity .3s;opacity:0;" onclick="closeQuickAdd()"></div>
        <div id="quickadd-panel" style="position:absolute;inset-block:0;right:0;width:100%;max-width:580px;background:var(--pp-surface);box-shadow:0 0 60px rgba(0,0,0,0.5);display:flex;flex-direction:column;overflow:hidden;" class="quickadd-panel-enter">
            <div id="quickadd-header" style="display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid var(--pp-border);flex-shrink:0;">
                <h2 id="quickadd-title" style="font-size:18px;font-weight:700;color:var(--pp-text);margin:0;"></h2>
                <button onclick="closeQuickAdd()" style="padding:8px;border-radius:8px;border:none;background:transparent;color:var(--pp-textDim);cursor:pointer;font-size:20px;transition:all .15s;" onmouseover="this.style.background='var(--pp-surfaceHover)';this.style.color='var(--pp-text)'" onmouseout="this.style.background='transparent';this.style.color='var(--pp-textDim)'">&times;</button>
            </div>
            <div id="quickadd-content" style="flex:1;overflow-y:auto;background:var(--pp-bg);">
                <div style="display:flex;align-items:center;justify-content:center;height:200px;">
                    <div style="width:28px;height:28px;border:2px solid var(--pp-accent);border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;"></div>
                </div>
            </div>
        </div>
    </div>

    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <!-- Global Scripts -->
    <script>
        // HTMX Konfiguration
        document.body.addEventListener('htmx:configRequest', function(evt) {
            evt.detail.headers['X-Request-ID'] = crypto.randomUUID();
        });

        document.body.addEventListener('htmx:responseError', function(evt) {
            var status = evt.detail.xhr.status;
            var message = 'Ein Fehler ist aufgetreten';
            if (status === 404) message = 'Ressource nicht gefunden';
            else if (status === 422) message = 'Validierungsfehler';
            else if (status === 429) message = 'Zu viele Anfragen - bitte warten';
            else if (status >= 500) message = 'Serverfehler - bitte spaeter erneut versuchen';
            showToast(message, 'error');
        });

        // Toast System (Dark Theme)
        function showToast(message, type, duration) {
            type = type || 'success';
            duration = duration || 5000;
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');

            var colors = {
                success: { bg: 'rgba(52,211,153,0.12)', text: '#34D399', border: 'rgba(52,211,153,0.27)', icon: '‚úì' },
                error:   { bg: 'rgba(239,68,68,0.12)', text: '#EF4444', border: 'rgba(239,68,68,0.27)', icon: '‚úï' },
                warning: { bg: 'rgba(245,158,11,0.12)', text: '#F59E0B', border: 'rgba(245,158,11,0.27)', icon: '‚ö†' },
                info:    { bg: 'rgba(79,140,255,0.12)', text: '#4F8CFF', border: 'rgba(79,140,255,0.27)', icon: '‚Ñπ' }
            };
            var c = colors[type] || colors.info;

            toast.className = 'toast-enter';
            toast.style.cssText = 'pointer-events:auto;display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:12px;border:1px solid ' + c.border + ';background:' + c.bg + ';color:' + c.text + ';font-size:14px;font-weight:500;font-family:var(--pp-ff);box-shadow:0 4px 16px rgba(0,0,0,0.3);backdrop-filter:blur(8px);';
            toast.innerHTML = '<span style="font-size:16px;flex-shrink:0;">' + c.icon + '</span><span style="flex:1;">' + message + '</span><button onclick="this.parentElement.remove()" style="background:none;border:none;color:' + c.text + ';cursor:pointer;font-size:16px;opacity:0.6;padding:0 2px;">&times;</button>';

            container.appendChild(toast);
            setTimeout(function() {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-leave');
                setTimeout(function() { toast.remove(); }, 300);
            }, duration);
        }

        // Modal
        function openModal(url) {
            htmx.ajax('GET', url, {target: '#modal-content', swap: 'innerHTML'}).then(function() {
                window.dispatchEvent(new CustomEvent('open-modal'));
            });
        }
        function closeModal() { window.dispatchEvent(new CustomEvent('close-modal')); }

        // Copy to clipboard
        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(function() {
                showToast((label || 'Text') + ' kopiert', 'success');
            }).catch(function() {
                var ta = document.createElement('textarea');
                ta.value = text; ta.style.cssText = 'position:fixed;opacity:0;';
                document.body.appendChild(ta); ta.select(); document.execCommand('copy');
                document.body.removeChild(ta);
                showToast((label || 'Text') + ' kopiert', 'success');
            });
        }

        // Quick-Add Slide-Over
        var _quickAddTitles = {
            kandidat: 'Neuer Kandidat', unternehmen: 'Neues Unternehmen', kontakt: 'Neuer Kontakt',
            job: 'Neuer Job', stelle: 'Neue Stelle', aufgabe: 'Neue Aufgabe',
        };

        function openQuickAdd(type, params) {
            var overlay = document.getElementById('quickadd-overlay');
            var backdrop = document.getElementById('quickadd-backdrop');
            var panel = document.getElementById('quickadd-panel');
            var title = document.getElementById('quickadd-title');
            var content = document.getElementById('quickadd-content');

            title.textContent = _quickAddTitles[type] || 'Neu erstellen';
            content.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:200px;"><div style="width:28px;height:28px;border:2px solid var(--pp-accent);border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;"></div></div>';

            overlay.style.display = '';
            requestAnimationFrame(function() { backdrop.style.opacity = '1'; });
            panel.classList.remove('quickadd-panel-leave');
            panel.classList.add('quickadd-panel-enter');
            document.body.style.overflow = 'hidden';

            var fetchUrl = '/partials/quickadd-' + type;
            if (params) {
                var qs = new URLSearchParams(params).toString();
                if (qs) fetchUrl += '?' + qs;
            }
            fetch(fetchUrl)
                .then(function(res) { if (!res.ok) throw new Error('HTTP ' + res.status); return res.text(); })
                .then(function(html) {
                    content.innerHTML = html;
                    var scripts = content.querySelectorAll('script');
                    scripts.forEach(function(oldScript) {
                        var newScript = document.createElement('script');
                        newScript.textContent = oldScript.textContent;
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                    if (window.Alpine) Alpine.initTree(content);
                })
                .catch(function(err) {
                    content.innerHTML = '<div style="padding:40px;text-align:center;color:var(--pp-red);"><p style="font-weight:600;">Fehler beim Laden</p><p style="font-size:13px;margin-top:4px;color:var(--pp-textDim);">' + err.message + '</p></div>';
                });

            document.addEventListener('keydown', _quickAddEscHandler);
        }

        function closeQuickAdd() {
            var overlay = document.getElementById('quickadd-overlay');
            var backdrop = document.getElementById('quickadd-backdrop');
            var panel = document.getElementById('quickadd-panel');
            backdrop.style.opacity = '0';
            panel.classList.remove('quickadd-panel-enter');
            panel.classList.add('quickadd-panel-leave');
            document.body.style.overflow = '';
            setTimeout(function() {
                overlay.style.display = 'none';
                document.getElementById('quickadd-content').innerHTML = '';
            }, 300);
            document.removeEventListener('keydown', _quickAddEscHandler);
        }

        function _quickAddEscHandler(e) { if (e.key === 'Escape') closeQuickAdd(); }

        // HTMX Events
        document.body.addEventListener('showToast', function(evt) {
            showToast(evt.detail.message, evt.detail.type || 'success');
        });
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'health-indicator') { /* handled by partial */ }
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
