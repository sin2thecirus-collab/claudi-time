{% extends "base.html" %}

{% block title %}{{ job_title }} {{ city }} - Pre-Match - Pulspoint{% endblock %}

{% block content %}
<div x-data="{
    selectedIds: [],
    selectAll: false,
    showAiDetails: {},
    toggleAll() {
        if (this.selectAll) {
            this.selectedIds = [{% for m in matches %}'{{ m.match_id }}'{% if not loop.last %},{% endif %}{% endfor %}];
        } else {
            this.selectedIds = [];
        }
    },
    toggleOne(id) {
        const idx = this.selectedIds.indexOf(String(id));
        if (idx >= 0) this.selectedIds.splice(idx, 1);
        else this.selectedIds.push(String(id));
        this.selectAll = this.selectedIds.length === {{ matches | length }};
    }
}">

    {# ── Header ── #}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div class="flex items-center gap-4">
            <a href="/pre-match?category={{ category }}"
               class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-gray-100 text-gray-500 hover:bg-gray-200 hover:text-gray-700 transition-colors">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ job_title }}</h1>
                <p class="text-sm text-gray-500 mt-0.5">{{ city }} &middot; {{ category }}</p>
            </div>
        </div>

        {# Stats Badges #}
        <div class="flex items-center gap-3 flex-wrap">
            <span class="inline-flex items-center rounded-lg bg-gray-100 px-3 py-1.5 text-sm font-medium text-gray-700">
                {{ total }} Matches
            </span>
            {% if close_count > 0 %}
            <span class="inline-flex items-center rounded-lg bg-green-50 px-3 py-1.5 text-sm font-medium text-green-700">
                {{ close_count }}&times; &lt;5km
            </span>
            {% endif %}
            <span class="inline-flex items-center rounded-lg bg-blue-50 px-3 py-1.5 text-sm font-medium text-blue-700">
                &#8960; {{ avg_distance }} km
            </span>
            {% if ai_checked > 0 %}
            <span class="inline-flex items-center rounded-lg bg-purple-50 px-3 py-1.5 text-sm font-medium text-purple-700">
                {{ ai_checked }} KI-bewertet
            </span>
            {% endif %}
        </div>
    </div>

    {# ── Toolbar ── #}
    <div class="bg-white rounded-xl border border-gray-200 px-4 py-3 mb-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            {# Select All #}
            <label class="flex items-center gap-2 cursor-pointer select-none">
                <input type="checkbox"
                       x-model="selectAll"
                       @change="toggleAll()"
                       class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                <span class="text-sm text-gray-600">Alle</span>
            </label>

            {# Deep Match Button #}
            <button @click="deepMatchSelected()"
                    :disabled="selectedIds.length === 0"
                    class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-700 transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                </svg>
                Deep Match (<span x-text="selectedIds.length">0</span>)
            </button>
        </div>

        {# Sortierung #}
        <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Sortierung:</span>
            <a href="/pre-match/detail?job_title={{ job_title | urlencode }}&city={{ city | urlencode }}&category={{ category }}&sort=distance"
               class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors {% if sort == 'distance' %}bg-primary-100 text-primary-700{% else %}bg-gray-100 text-gray-500 hover:bg-gray-200{% endif %}">
                Entfernung
            </a>
            <a href="/pre-match/detail?job_title={{ job_title | urlencode }}&city={{ city | urlencode }}&category={{ category }}&sort=score"
               class="px-3 py-1.5 text-xs font-medium rounded-md transition-colors {% if sort == 'score' %}bg-primary-100 text-primary-700{% else %}bg-gray-100 text-gray-500 hover:bg-gray-200{% endif %}">
                Score
            </a>
        </div>
    </div>

    {# ── Tabelle ── #}
    {% if matches %}
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">

        {# Tabellen-Header #}
        <div class="grid grid-cols-24 gap-1 px-4 py-2.5 bg-gray-50 text-[10px] font-semibold text-gray-400 uppercase tracking-wider border-b border-gray-200">
            <div class="col-span-1"></div>
            <div class="col-span-1 text-center">Score</div>
            <div class="col-span-3">Kandidat</div>
            <div class="col-span-2">Titel</div>
            <div class="col-span-3">Telefon</div>
            <div class="col-span-3">Email</div>
            <div class="col-span-3">Unternehmen</div>
            <div class="col-span-2">Job</div>
            <div class="col-span-1 text-center">km</div>
            <div class="col-span-1 text-center">CV</div>
            <div class="col-span-1 text-center">KI</div>
            <div class="col-span-3 text-center">Feedback</div>
        </div>

        {# Match-Zeilen #}
        {% for m in matches %}
        <div class="border-b border-gray-50 last:border-b-0" id="match-row-{{ m.match_id }}">
            <div class="grid grid-cols-24 gap-1 items-center px-4 py-3 hover:bg-gray-50/80 transition-colors">

                {# Checkbox #}
                <div class="col-span-1">
                    <input type="checkbox"
                           :checked="selectedIds.includes('{{ m.match_id }}')"
                           @change="toggleOne('{{ m.match_id }}')"
                           class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                </div>

                {# Score Badge #}
                <div class="col-span-1 text-center">
                    {% set score = m.ai_score if m.ai_score is not none else m.pre_score %}
                    {% set score_val = (score | default(0, true) * (1 if m.ai_score is not none else 1)) | round | int %}
                    {% if m.ai_score is not none %}
                        {% set score_val = (m.ai_score * 100) | round | int %}
                    {% elif m.pre_score is not none %}
                        {% set score_val = m.pre_score | round | int %}
                    {% else %}
                        {% set score_val = 0 %}
                    {% endif %}
                    <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg text-xs font-bold
                        {% if score_val >= 70 %}bg-green-100 text-green-700
                        {% elif score_val >= 40 %}bg-amber-100 text-amber-700
                        {% else %}bg-gray-100 text-gray-500{% endif %}">
                        {{ score_val }}
                    </span>
                </div>

                {# Kandidat #}
                <div class="col-span-3 min-w-0">
                    <a href="/candidates/{{ m.candidate_id }}"
                       class="text-sm font-semibold text-gray-900 hover:text-primary-600 transition-colors truncate block">
                        {{ m.candidate_name }}
                    </a>
                    <p class="text-xs text-gray-400 truncate">{{ m.candidate_city or '' }}</p>
                </div>

                {# Titel #}
                <div class="col-span-2 min-w-0">
                    {% if m.candidate_titles %}
                    <div class="flex flex-wrap gap-0.5">
                        {% for t in m.candidate_titles[:2] %}
                        <span class="inline-flex items-center rounded-md bg-blue-50 px-1.5 py-0.5 text-[10px] font-medium text-blue-700 truncate max-w-full">
                            {{ t }}
                        </span>
                        {% endfor %}
                        {% if m.candidate_titles | length > 2 %}
                        <span class="text-[10px] text-gray-400">+{{ m.candidate_titles | length - 2 }}</span>
                        {% endif %}
                    </div>
                    {% elif m.candidate_title %}
                    <span class="text-xs text-gray-600 truncate block">{{ m.candidate_title }}</span>
                    {% else %}
                    <span class="text-xs text-gray-300">-</span>
                    {% endif %}
                </div>

                {# Telefon + Copy #}
                <div class="col-span-3 min-w-0">
                    {% if m.candidate_phone %}
                    <div class="flex items-center gap-1 group/phone">
                        <span class="text-xs text-gray-700 truncate">{{ m.candidate_phone }}</span>
                        <button onclick="copyToClipboard('{{ m.candidate_phone }}', this)"
                                class="opacity-0 group-hover/phone:opacity-100 p-0.5 rounded hover:bg-gray-200 transition-all"
                                title="Kopieren">
                            <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                            </svg>
                        </button>
                    </div>
                    {% else %}
                    <span class="text-xs text-gray-300">-</span>
                    {% endif %}
                </div>

                {# Email + Copy #}
                <div class="col-span-3 min-w-0">
                    {% if m.candidate_email %}
                    <div class="flex items-center gap-1 group/email">
                        <span class="text-xs text-gray-700 truncate">{{ m.candidate_email }}</span>
                        <button onclick="copyToClipboard('{{ m.candidate_email }}', this)"
                                class="opacity-0 group-hover/email:opacity-100 p-0.5 rounded hover:bg-gray-200 transition-all"
                                title="Kopieren">
                            <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                            </svg>
                        </button>
                    </div>
                    {% else %}
                    <span class="text-xs text-gray-300">-</span>
                    {% endif %}
                </div>

                {# Unternehmen #}
                <div class="col-span-3 min-w-0">
                    <span class="text-xs font-medium text-gray-700 truncate block">{{ m.job_company }}</span>
                </div>

                {# Job-Name + Link #}
                <div class="col-span-2 min-w-0">
                    {% if m.job_url %}
                    <a href="{{ m.job_url }}" target="_blank"
                       class="text-xs text-primary-600 hover:text-primary-800 truncate block font-medium"
                       title="{{ m.job_position }}">
                        {{ m.job_position }}
                    </a>
                    {% else %}
                    <span class="text-xs text-gray-600 truncate block">{{ m.job_position }}</span>
                    {% endif %}
                </div>

                {# Entfernung #}
                <div class="col-span-1 text-center">
                    {% if m.distance_km is not none %}
                    <span class="text-xs font-semibold {% if m.distance_km <= 5 %}text-green-600{% elif m.distance_km <= 15 %}text-amber-600{% else %}text-gray-500{% endif %}">
                        {{ m.distance_km | round(1) }}
                    </span>
                    {% else %}
                    <span class="text-xs text-gray-300">-</span>
                    {% endif %}
                </div>

                {# CV Button #}
                <div class="col-span-1 text-center">
                    {% if m.has_cv %}
                    {% if m.cv_stored_path %}
                    <a href="/api/candidates/{{ m.candidate_id }}/cv" target="_blank"
                       class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-blue-50 text-blue-500 hover:bg-blue-100 transition-colors"
                       title="CV ansehen">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </a>
                    {% else %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-gray-50 text-gray-400" title="CV nur als Text">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </span>
                    {% endif %}
                    {% else %}
                    <span class="text-xs text-gray-300">-</span>
                    {% endif %}
                </div>

                {# KI Button/Score #}
                <div class="col-span-1 text-center">
                    {% if m.ai_score is not none %}
                    <button @click="showAiDetails['{{ m.match_id }}'] = !showAiDetails['{{ m.match_id }}']"
                            class="inline-flex items-center justify-center w-7 h-7 rounded-md transition-colors
                            {% if m.ai_score >= 0.7 %}bg-green-100 text-green-600 hover:bg-green-200
                            {% elif m.ai_score >= 0.4 %}bg-amber-100 text-amber-600 hover:bg-amber-200
                            {% else %}bg-gray-100 text-gray-500 hover:bg-gray-200{% endif %}"
                            title="KI-Score: {{ (m.ai_score * 100) | round | int }}">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                        </svg>
                    </button>
                    {% else %}
                    <button onclick="triggerSingleDeepMatch('{{ m.match_id }}')"
                            class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-primary-50 text-primary-500 hover:bg-primary-100 transition-colors"
                            title="KI-Bewertung starten"
                            id="dm-btn-{{ m.match_id }}">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                        </svg>
                    </button>
                    {% endif %}
                </div>

                {# Feedback #}
                <div class="col-span-3 text-center">
                    {% if m.ai_score is not none %}
                    <div class="flex items-center justify-center gap-1">
                        <button onclick="saveFeedback('{{ m.match_id }}', 'good')"
                                class="p-1 rounded hover:bg-green-50 transition-colors {% if m.user_feedback == 'good' %}bg-green-100{% endif %}"
                                title="Gut">
                            <svg class="w-4 h-4 {% if m.user_feedback == 'good' %}text-green-500{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />
                            </svg>
                        </button>
                        <button onclick="saveFeedback('{{ m.match_id }}', 'bad')"
                                class="p-1 rounded hover:bg-red-50 transition-colors {% if m.user_feedback == 'bad' %}bg-red-100{% endif %}"
                                title="Schlecht">
                            <svg class="w-4 h-4 {% if m.user_feedback == 'bad' %}text-red-500{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667v-5.43a2 2 0 00-1.106-1.79l-.05-.025A4 4 0 0011.057 2H5.64a2 2 0 00-1.962 1.608l-1.2 6A2 2 0 004.44 12H8v4a2 2 0 002 2 1 1 0 001-1v-.667a4 4 0 01.8-2.4l1.4-1.866a4 4 0 00.8-2.4z" />
                            </svg>
                        </button>
                        <button onclick="promptFeedbackNote('{{ m.match_id }}')"
                                class="p-1 rounded hover:bg-blue-50 transition-colors {% if m.feedback_note %}bg-blue-100{% endif %}"
                                title="{{ m.feedback_note or 'Notiz hinzufuegen' }}">
                            <svg class="w-4 h-4 {% if m.feedback_note %}text-blue-500{% else %}text-gray-300{% endif %}" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                            </svg>
                        </button>
                    </div>
                    {% else %}
                    <span class="text-[10px] text-gray-300">erst nach KI</span>
                    {% endif %}
                </div>
            </div>

            {# ── KI-Details (aufklappbar) ── #}
            {% if m.ai_score is not none %}
            <div x-show="showAiDetails['{{ m.match_id }}']"
                 x-transition
                 class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-2">
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <p class="text-[10px] text-gray-400 uppercase">Pre</p>
                                <p class="text-lg font-bold text-gray-400">{{ m.pre_score | default(0) | round | int }}</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                            </svg>
                            <div class="text-center">
                                <p class="text-[10px] text-primary-500 uppercase font-semibold">KI</p>
                                <p class="text-lg font-bold {% if m.ai_score >= 0.7 %}text-green-600{% elif m.ai_score >= 0.4 %}text-amber-600{% else %}text-gray-500{% endif %}">
                                    {{ (m.ai_score * 100) | round | int }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-6">
                        {% if m.ai_explanation %}
                        <p class="text-xs text-gray-600 leading-relaxed">{{ m.ai_explanation }}</p>
                        {% endif %}
                    </div>
                    <div class="col-span-4">
                        {% for s in m.ai_strengths[:3] %}
                        <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-[10px] font-medium text-green-700 mr-1 mb-1">
                            + {{ s }}
                        </span>
                        {% endfor %}
                        {% for w in m.ai_weaknesses[:3] %}
                        <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-0.5 text-[10px] font-medium text-red-700 mr-1 mb-1">
                            - {{ w }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
        <h3 class="text-lg font-semibold text-gray-900">Keine Matches</h3>
        <p class="text-sm text-gray-500 mt-2">Fuer diese Kombination gibt es noch keine Pre-Matches.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Copy to Clipboard
function copyToClipboard(text, btnEl) {
    navigator.clipboard.writeText(text).then(() => {
        // Visuelles Feedback
        const origHTML = btnEl.innerHTML;
        btnEl.innerHTML = '<svg class="w-3.5 h-3.5 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>';
        btnEl.style.opacity = '1';
        setTimeout(() => {
            btnEl.innerHTML = origHTML;
            btnEl.style.opacity = '';
        }, 1500);
    }).catch(() => {
        showToast('Kopieren fehlgeschlagen', 'error');
    });
}

// Deep Match fuer ausgewaehlte
async function deepMatchSelected() {
    const alpine = document.querySelector('[x-data]').__x.$data;
    const ids = alpine.selectedIds;
    if (ids.length === 0) return;

    if (!confirm(`KI-Bewertung fuer ${ids.length} Matches starten? (Kosten: ~$${(ids.length * 0.001).toFixed(3)})`)) return;

    showToast(`Deep Match gestartet fuer ${ids.length} Matches...`, 'info');

    for (const matchId of ids) {
        await triggerSingleDeepMatch(matchId);
    }

    showToast('Deep Match abgeschlossen! Seite wird neu geladen...', 'success');
    setTimeout(() => window.location.reload(), 2000);
}

// Einzelnes Deep Match
async function triggerSingleDeepMatch(matchId) {
    const btn = document.getElementById('dm-btn-' + matchId);
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin w-3.5 h-3.5 text-primary-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>';
    }

    try {
        const resp = await fetch('/partials/deepmatch-single/' + matchId, { method: 'POST' });
        if (resp.ok) {
            const row = document.getElementById('match-row-' + matchId);
            if (row) row.innerHTML = await resp.text();
        } else {
            if (btn) btn.innerHTML = '<svg class="w-3.5 h-3.5 text-red-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>';
        }
    } catch (e) {
        if (btn) btn.title = 'Fehler: ' + e.message;
    }
}

// Feedback speichern
async function saveFeedback(matchId, feedback) {
    try {
        const resp = await fetch('/api/hotlisten/deepmatch/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ match_id: matchId, feedback: feedback }),
        });
        if (resp.ok) {
            showToast('Feedback gespeichert', 'success', 2000);
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

// Feedback-Notiz
async function promptFeedbackNote(matchId) {
    const note = prompt('Feedback-Notiz:');
    if (note === null) return;

    try {
        const resp = await fetch('/api/hotlisten/deepmatch/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ match_id: matchId, feedback: 'note', note: note }),
        });
        if (resp.ok) {
            showToast('Notiz gespeichert', 'success', 2000);
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}
</script>
{% endblock %}
