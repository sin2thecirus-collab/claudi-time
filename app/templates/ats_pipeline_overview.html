{% extends "base.html" %}

{% block title %}Interview Pipeline - Pulspoint{% endblock %}

{% block content %}
<div x-data="pipelineOverview()" class="min-h-screen bg-gray-50">

    {# -- Cleaner Header -- #}
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-full mx-auto px-6 py-5">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Pipeline</h1>
                    <p class="text-sm text-gray-500 mt-1">{{ total_jobs }} aktive Stelle{{ 'n' if total_jobs != 1 else '' }}</p>
                </div>
                <div class="flex items-center gap-3">
                    {# Company Filter mit Autocomplete #}
                    <div class="relative" x-data="companyFilter()">
                        <div class="flex items-center">
                            <div class="relative">
                                <input type="text"
                                       x-model="searchTerm"
                                       @input.debounce.200ms="searchCompanies()"
                                       @focus="showDropdown = true"
                                       @click.away="showDropdown = false"
                                       :placeholder="selectedCompanyName || 'Unternehmen suchen...'"
                                       class="w-64 px-4 py-2 pl-10 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400">
                                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                </svg>
                            </div>
                            <template x-if="selectedCompanyId">
                                <button @click="clearFilter()"
                                        class="ml-2 p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                                        title="Filter entfernen">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </template>
                        </div>

                        {# Dropdown mit Suchergebnissen #}
                        <div x-show="showDropdown && (filteredCompanies.length > 0 || searchTerm.length >= 1)"
                             x-cloak
                             class="absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                            <button type="button"
                                    @click="selectCompany(null, 'Alle Unternehmen')"
                                    class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 border-b border-gray-100"
                                    :class="{ 'bg-blue-50 text-blue-700 font-medium': !selectedCompanyId }">
                                Alle Unternehmen
                            </button>
                            <template x-for="company in filteredCompanies" :key="company.id">
                                <button type="button"
                                        @click="selectCompany(company.id, company.name)"
                                        class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 border-b border-gray-100 last:border-b-0"
                                        :class="{ 'bg-blue-50 text-blue-700 font-medium': selectedCompanyId === company.id }">
                                    <span x-text="company.name"></span>
                                </button>
                            </template>
                            <div x-show="searchTerm.length >= 1 && filteredCompanies.length === 0"
                                 class="px-4 py-3 text-sm text-gray-500 text-center">
                                Keine Unternehmen gefunden
                            </div>
                        </div>
                    </div>
                    <a href="/ats/stellen"
                       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                        Alle Stellen
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# -- Pipeline Content -- #}
    <div class="max-w-full mx-auto px-6 py-6">

        {# -- Stage Labels Row -- #}
        {% set visible_stages = ['sent', 'interview_1', 'interview_2', 'interview_3', 'offer', 'placed', 'rejected'] %}
        {% set stage_colors = {
            'sent': 'bg-blue-100 text-blue-700',
            'interview_1': 'bg-violet-100 text-violet-700',
            'interview_2': 'bg-violet-100 text-violet-700',
            'interview_3': 'bg-violet-100 text-violet-700',
            'offer': 'bg-amber-100 text-amber-700',
            'placed': 'bg-emerald-100 text-emerald-700',
            'rejected': 'bg-red-100 text-red-700'
        } %}
        {% set stage_dot_colors = {
            'sent': 'bg-blue-500',
            'interview_1': 'bg-violet-500',
            'interview_2': 'bg-violet-500',
            'interview_3': 'bg-violet-500',
            'offer': 'bg-amber-500',
            'placed': 'bg-emerald-500',
            'rejected': 'bg-red-500'
        } %}

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            {# Header Row mit Pfeil-Tabs #}
            <div class="border-b border-gray-200">
                <div class="grid grid-cols-12">
                    <div class="col-span-3 px-5 py-3 bg-gray-50">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Position</span>
                    </div>
                    <div class="col-span-7">
                        <div class="flex h-full">
                            {% set arrow_colors = {
                                'sent': '#f8d7da',
                                'interview_1': '#f5c6cb',
                                'interview_2': '#f1aeb5',
                                'interview_3': '#ea868f',
                                'offer': '#d1e7dd',
                                'placed': '#a3cfbb',
                                'rejected': '#badbcc'
                            } %}
                            {% set arrow_text_colors = {
                                'sent': '#842029',
                                'interview_1': '#842029',
                                'interview_2': '#842029',
                                'interview_3': '#ffffff',
                                'offer': '#0f5132',
                                'placed': '#0f5132',
                                'rejected': '#0f5132'
                            } %}
                            {% for stage in visible_stages %}
                            {% set bg_color = arrow_colors.get(stage, '#f3f4f6') %}
                            {% set text_color = arrow_text_colors.get(stage, '#374151') %}
                            {% set next_stage = visible_stages[loop.index] if loop.index < visible_stages|length else none %}
                            {% set next_bg = arrow_colors.get(next_stage, '#ffffff') if next_stage else '#ffffff' %}
                            <div class="relative flex-1 h-9 flex items-center justify-center text-xs font-medium" style="background-color: {{ bg_color }}; color: {{ text_color }};">
                                <span class="relative z-10 px-1">
                                    {% if stage == 'sent' %}Vorgestellt
                                    {% elif stage == 'interview_1' %}IV 1
                                    {% elif stage == 'interview_2' %}IV 2
                                    {% elif stage == 'interview_3' %}IV 3
                                    {% elif stage == 'offer' %}Angebot
                                    {% elif stage == 'placed' %}Platziert
                                    {% elif stage == 'rejected' %}Abgesagt
                                    {% endif %}
                                </span>
                                {% if not loop.last %}
                                <svg class="absolute right-0 top-0 h-full w-3" style="transform: translateX(50%);" viewBox="0 0 12 36" preserveAspectRatio="none">
                                    <path d="M0,0 L12,18 L0,36" fill="{{ bg_color }}"/>
                                </svg>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-span-2 px-5 py-3 bg-gray-50 text-right">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Aktionen</span>
                    </div>
                </div>
            </div>

            {# -- Job Rows -- #}
            {% if jobs_by_company %}
                {% for company_key, company_data in jobs_by_company.items() %}
                    {% for job_item in company_data.jobs %}
                    {% set job = job_item.job %}
                    {% set entries_by_stage = job_item.entries_by_stage %}

                    <div class="grid grid-cols-12 border-b border-gray-100 last:border-b-0 hover:bg-gray-50/50 transition-colors pipeline-row"
                         data-job-id="{{ job.id }}">

                        {# Job Info #}
                        <div class="col-span-3 px-5 py-4">
                            <a href="/ats/stellen/{{ job.id }}" class="block group">
                                <p class="text-sm font-semibold text-gray-900 group-hover:text-blue-600 transition-colors">{{ job.title }}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-gray-500">{% if company_data.company %}{{ company_data.company_name }}{% endif %}</span>
                                    {% if job.location_city %}
                                    <span class="text-gray-300">•</span>
                                    <span class="text-xs text-gray-500">{{ job.location_city }}</span>
                                    {% endif %}
                                </div>
                            </a>
                        </div>

                        {# Pipeline Stages #}
                        {% for stage in visible_stages %}
                        {% set stage_entries = entries_by_stage.get(stage, []) %}
                        {% set avatar_colors = {
                            'sent': 'bg-blue-500',
                            'interview_1': 'bg-violet-500',
                            'interview_2': 'bg-violet-600',
                            'interview_3': 'bg-violet-700',
                            'offer': 'bg-amber-500',
                            'placed': 'bg-emerald-500',
                            'rejected': 'bg-red-400'
                        } %}

                        <div class="col-span-1 px-2 py-3 pipeline-dropzone flex items-center justify-center min-h-[60px]"
                             data-stage="{{ stage }}"
                             data-job-id="{{ job.id }}"
                             @dragover.prevent="$el.classList.add('bg-blue-50', 'ring-2', 'ring-inset', 'ring-blue-300')"
                             @dragleave="$el.classList.remove('bg-blue-50', 'ring-2', 'ring-inset', 'ring-blue-300')"
                             @drop="handleDrop($event, '{{ stage }}', '{{ job.id }}')">
                            {% if stage_entries %}
                            <div class="flex flex-col gap-1.5 w-full">
                                {% for entry in stage_entries %}
                                {% set candidate = entry.candidate %}
                                {% if candidate %}
                                <div class="pipeline-avatar"
                                     draggable="true"
                                     data-entry-id="{{ entry.id }}"
                                     data-candidate-id="{{ candidate.id }}"
                                     data-candidate-name="{{ candidate.first_name }} {{ candidate.last_name }}"
                                     @dragstart="handleDragStart($event, '{{ entry.id }}', '{{ candidate.id }}', '{{ candidate.first_name }} {{ candidate.last_name }}')"
                                     @dragend="handleDragEnd($event)">
                                    <a href="/kandidaten/{{ candidate.id }}"
                                       class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-white hover:shadow-sm cursor-grab active:cursor-grabbing transition-all border border-transparent hover:border-gray-200"
                                       title="{{ candidate.first_name }} {{ candidate.last_name }}"
                                       @click.stop>
                                        <div class="w-7 h-7 rounded-full {{ avatar_colors.get(stage, 'bg-gray-400') }} flex items-center justify-center text-white text-xs font-semibold flex-shrink-0 shadow-sm">
                                            {{ (candidate.first_name or 'U')[0] | upper }}{{ (candidate.last_name or '')[0] | upper }}
                                        </div>
                                        <span class="text-xs font-medium text-gray-700 truncate">{{ candidate.first_name }} {{ candidate.last_name }}</span>
                                    </a>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="text-gray-200">—</span>
                            {% endif %}
                        </div>
                        {% endfor %}

                        {# Actions #}
                        <div class="col-span-2 px-4 py-3 flex items-center justify-end gap-2">
                            <button @click="openAddCandidateModal('{{ job.id }}', '{{ job.title | e }}')"
                                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                                    title="Kandidat hinzufuegen">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                                Hinzufügen
                            </button>
                            <a href="/ats/stellen/{{ job.id }}"
                               class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                                </svg>
                                Details
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
            {% else %}
            <div class="px-6 py-16 text-center">
                <div class="w-14 h-14 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-7 h-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0M12 12.75h.008v.008H12v-.008z" />
                    </svg>
                </div>
                <p class="text-base font-medium text-gray-900">Keine Jobs in der Pipeline</p>
                <p class="mt-1 text-sm text-gray-500">Füge Stellen zur Pipeline hinzu, um Kandidaten zu tracken</p>
                <a href="/ats/stellen"
                   class="mt-5 inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Stellen verwalten
                </a>
            </div>
            {% endif %}
        </div>
    </div>


    {# -- Kandidat hinzufuegen Modal -- #}
    <div x-show="addCandidateOpen"
         x-cloak
         class="fixed inset-0 z-50"
         @keydown.escape.window="addCandidateOpen = false">
        <div class="fixed inset-0 bg-black/40 backdrop-blur-sm" @click="addCandidateOpen = false"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div @click.stop
                     x-show="addCandidateOpen"
                     x-transition
                     class="relative w-full max-w-md bg-white rounded-xl shadow-2xl">

                    <div class="px-5 py-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-base font-semibold text-gray-900">Kandidat hinzufügen</h3>
                                <p class="text-xs text-gray-500 mt-0.5" x-text="selectedJobTitle"></p>
                            </div>
                            <button @click="addCandidateOpen = false" class="text-gray-400 hover:text-gray-500 p-1 rounded-lg hover:bg-gray-100">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="px-5 py-4 space-y-4">
                        {# Kandidaten-Suche #}
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1.5">Kandidat suchen</label>
                            <input type="text"
                                   x-model="candidateSearch"
                                   @input.debounce.300ms="searchCandidates()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Name eingeben..."
                                   autocomplete="off">

                            {# Suchergebnisse #}
                            <div x-show="searchResults.length > 0"
                                 class="mt-2 border border-gray-200 rounded-lg divide-y divide-gray-100 max-h-48 overflow-y-auto">
                                <template x-for="candidate in searchResults" :key="candidate.id">
                                    <button type="button"
                                            @click="selectCandidate(candidate)"
                                            class="w-full text-left px-3 py-2 hover:bg-gray-50 flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-semibold"
                                             x-text="candidate.name.charAt(0).toUpperCase()"></div>
                                        <div class="min-w-0 flex-1">
                                            <p class="text-sm font-medium text-gray-900 truncate" x-text="candidate.name"></p>
                                            <p class="text-xs text-gray-500 truncate" x-text="candidate.position || candidate.city || '-'"></p>
                                        </div>
                                    </button>
                                </template>
                            </div>

                            {# Ausgewaehlter Kandidat #}
                            <div x-show="selectedCandidate"
                                 class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-semibold"
                                         x-text="selectedCandidate?.name?.charAt(0).toUpperCase() || ''"></div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900" x-text="selectedCandidate?.name"></p>
                                        <p class="text-xs text-gray-500" x-text="selectedCandidate?.position || '-'"></p>
                                    </div>
                                </div>
                                <button type="button" @click="selectedCandidate = null" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            {# Keine Ergebnisse #}
                            <p x-show="candidateSearch.length >= 2 && searchResults.length === 0 && !searching"
                               class="mt-2 text-sm text-gray-500 text-center py-2">
                                Keine Kandidaten gefunden
                            </p>
                        </div>

                        {# Stage Auswahl #}
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1.5">Start-Phase</label>
                            <select x-model="selectedStage"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500">
                                <option value="matched">Gematcht</option>
                                <option value="sent">Vorgestellt</option>
                                <option value="feedback">Feedback</option>
                                <option value="interview_1">Interview 1</option>
                                <option value="interview_2">Interview 2</option>
                                <option value="interview_3">Interview 3</option>
                                <option value="offer">Angebot</option>
                            </select>
                        </div>

                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" @click="addCandidateOpen = false"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                                Abbrechen
                            </button>
                            <button type="button"
                                    @click="addCandidateToPipeline()"
                                    :disabled="!selectedCandidate"
                                    :class="selectedCandidate ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'"
                                    class="px-4 py-2 text-sm font-semibold text-white rounded-lg">
                                Hinzufügen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function pipelineOverview() {
    return {
        // Drag & Drop
        draggedEntry: null,
        draggedCandidateId: null,
        draggedCandidateName: null,

        // Add Candidate Modal
        addCandidateOpen: false,
        selectedJobId: null,
        selectedJobTitle: '',
        candidateSearch: '',
        searchResults: [],
        selectedCandidate: null,
        selectedStage: 'sent',
        searching: false,

        init() {
            console.log('Pipeline Overview initialized');
        },

        openAddCandidateModal(jobId, jobTitle) {
            this.selectedJobId = jobId;
            this.selectedJobTitle = jobTitle;
            this.candidateSearch = '';
            this.searchResults = [];
            this.selectedCandidate = null;
            this.selectedStage = 'sent';
            this.addCandidateOpen = true;
        },

        async searchCandidates() {
            if (this.candidateSearch.length < 2) {
                this.searchResults = [];
                return;
            }

            this.searching = true;
            try {
                const response = await fetch(`/api/candidates/search?q=${encodeURIComponent(this.candidateSearch)}&limit=10`);
                if (response.ok) {
                    this.searchResults = await response.json();
                }
            } catch (err) {
                console.error('Kandidaten-Suche fehlgeschlagen:', err);
            }
            this.searching = false;
        },

        selectCandidate(candidate) {
            this.selectedCandidate = candidate;
            this.searchResults = [];
            this.candidateSearch = '';
        },

        async addCandidateToPipeline() {
            if (!this.selectedCandidate || !this.selectedJobId) return;

            try {
                const response = await fetch(`/api/ats/pipeline/${this.selectedJobId}/candidates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        candidate_id: this.selectedCandidate.id,
                        stage: this.selectedStage,
                    })
                });

                if (response.ok) {
                    if (typeof showToast === 'function') {
                        showToast(`${this.selectedCandidate.name} hinzugefügt`, 'success');
                    }
                    this.addCandidateOpen = false;
                    setTimeout(() => location.reload(), 500);
                } else {
                    const error = await response.json();
                    if (typeof showToast === 'function') {
                        showToast(error.detail || 'Fehler beim Hinzufügen', 'error');
                    }
                }
            } catch (err) {
                console.error('Kandidat hinzufügen fehlgeschlagen:', err);
                if (typeof showToast === 'function') {
                    showToast('Netzwerkfehler', 'error');
                }
            }
        },

        handleDragStart(event, entryId, candidateId, candidateName) {
            this.draggedEntry = entryId;
            this.draggedCandidateId = candidateId;
            this.draggedCandidateName = candidateName;
            event.dataTransfer.setData('text/plain', entryId);
            event.dataTransfer.effectAllowed = 'move';
            event.target.closest('.pipeline-avatar').classList.add('opacity-50', 'scale-95');
        },

        handleDragEnd(event) {
            event.target.closest('.pipeline-avatar').classList.remove('opacity-50', 'scale-95');
            document.querySelectorAll('.pipeline-dropzone').forEach(el => {
                el.classList.remove('bg-blue-50', 'ring-2', 'ring-blue-300');
            });
            this.draggedEntry = null;
            this.draggedCandidateId = null;
            this.draggedCandidateName = null;
        },

        async handleDrop(event, newStage, jobId) {
            event.preventDefault();
            const dropzone = event.currentTarget;
            dropzone.classList.remove('bg-blue-50', 'ring-2', 'ring-blue-300');

            if (!this.draggedEntry) return;

            const entryId = this.draggedEntry;
            const candidateName = this.draggedCandidateName;

            try {
                const response = await fetch(`/api/ats/pipeline/entries/${entryId}/stage`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage: newStage })
                });

                if (response.ok) {
                    if (typeof showToast === 'function') {
                        showToast(`${candidateName} verschoben`, 'success');
                    }
                    this.moveCandidateInDOM(entryId, newStage, jobId);
                } else {
                    const error = await response.json();
                    if (typeof showToast === 'function') {
                        showToast(error.detail || 'Fehler', 'error');
                    }
                }
            } catch (err) {
                console.error('Drag & Drop error:', err);
                if (typeof showToast === 'function') {
                    showToast('Netzwerkfehler', 'error');
                }
            }
        },

        moveCandidateInDOM(entryId, newStage, jobId) {
            const avatarEl = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (!avatarEl) return;

            const jobRow = document.querySelector(`.pipeline-row[data-job-id="${jobId}"]`);
            const targetDropzone = jobRow.querySelector(`.pipeline-dropzone[data-stage="${newStage}"]`);

            let targetContainer = targetDropzone.querySelector('.flex.flex-col');
            if (!targetContainer) {
                const dash = targetDropzone.querySelector('span');
                if (dash) dash.remove();
                targetContainer = document.createElement('div');
                targetContainer.className = 'flex flex-col gap-1.5 w-full';
                targetDropzone.appendChild(targetContainer);
            }

            const oldContainer = avatarEl.parentElement;
            targetContainer.appendChild(avatarEl);
            this.updateAvatarColor(avatarEl, newStage);

            if (oldContainer && oldContainer.children.length === 0) {
                const oldDropzone = oldContainer.parentElement;
                oldContainer.remove();
                const dash = document.createElement('span');
                dash.className = 'text-gray-200';
                dash.textContent = '—';
                oldDropzone.appendChild(dash);
            }
        },

        updateAvatarColor(avatarEl, newStage) {
            const colorMap = {
                'sent': 'bg-blue-500',
                'interview_1': 'bg-violet-500',
                'interview_2': 'bg-violet-600',
                'interview_3': 'bg-violet-700',
                'offer': 'bg-amber-500',
                'placed': 'bg-emerald-500',
                'rejected': 'bg-red-400'
            };
            const avatar = avatarEl.querySelector('.rounded-full');
            if (!avatar) return;
            Object.values(colorMap).forEach(c => avatar.classList.remove(c));
            avatar.classList.add(colorMap[newStage] || 'bg-gray-400');
        }
    }
}

function companyFilter() {
    return {
        searchTerm: '',
        showDropdown: false,
        filteredCompanies: [],
        allCompanies: {{ all_companies | tojson | safe }},
        selectedCompanyId: {{ selected_company_id | tojson | safe if selected_company_id else 'null' }},
        selectedCompanyName: '{{ selected_company_name | default("", true) }}',

        init() {
            this.filteredCompanies = this.allCompanies.slice(0, 20);
        },

        searchCompanies() {
            if (this.searchTerm.length === 0) {
                this.filteredCompanies = this.allCompanies.slice(0, 20);
            } else {
                const term = this.searchTerm.toLowerCase();
                this.filteredCompanies = this.allCompanies
                    .filter(c => c.name.toLowerCase().includes(term))
                    .slice(0, 20);
            }
            this.showDropdown = true;
        },

        selectCompany(id, name) {
            this.showDropdown = false;
            this.searchTerm = '';
            if (id) {
                window.location.href = '/ats?company_id=' + id;
            } else {
                window.location.href = '/ats';
            }
        },

        clearFilter() {
            window.location.href = '/ats';
        }
    }
}
</script>
{% endblock %}
