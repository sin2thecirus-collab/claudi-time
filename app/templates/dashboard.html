{% extends "base.html" %}

{% block title %}Dashboard - Matching-Tool{% endblock %}

{% block content %}
<div class="space-y-6">
    {# Header #}
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                Jobs
            </h1>
            <p class="mt-1 text-sm text-gray-500">
                Finde passende Kandidaten fuer offene Stellen
            </p>
        </div>
        <div class="mt-4 flex md:ml-4 md:mt-0 space-x-3">
            {# CRM-Sync Button #}
            <button type="button"
                    hx-post="/api/candidates/sync"
                    hx-swap="none"
                    hx-on::after-request="showToast('CRM-Sync gestartet', 'info')"
                    class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="h-4 w-4 mr-1.5 htmx-indicator animate-spin" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                CRM-Sync
            </button>

            {# Import Button #}
            <button type="button"
                    onclick="openModal('/partials/import-dialog')"
                    class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                    <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                </svg>
                Jobs importieren
            </button>
        </div>
    </div>

    {# Filter Panel #}
    <div id="filter-panel"
         hx-get="/partials/filter-panel"
         hx-trigger="load"
         hx-swap="innerHTML">
        {% include 'components/loading_spinner.html' %}
    </div>

    {# Statistik-Karten #}
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div class="bg-white overflow-hidden rounded-lg shadow-sm border border-gray-200">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0M12 12.75h.008v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Aktive Jobs</dt>
                            <dd class="text-lg font-semibold text-gray-900"
                                hx-get="/api/statistics/jobs-count"
                                hx-trigger="load, jobsUpdated from:body"
                                hx-swap="innerHTML">
                                -
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden rounded-lg shadow-sm border border-gray-200">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Aktive Kandidaten</dt>
                            <dd class="text-lg font-semibold text-gray-900"
                                hx-get="/api/statistics/candidates-active-count"
                                hx-trigger="load"
                                hx-swap="innerHTML">
                                -
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden rounded-lg shadow-sm border border-gray-200">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">KI-Checks (30 Tage)</dt>
                            <dd class="text-lg font-semibold text-gray-900"
                                hx-get="/api/statistics/ai-checks-count"
                                hx-trigger="load"
                                hx-swap="innerHTML">
                                -
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden rounded-lg shadow-sm border border-gray-200">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Vermittelt (30 Tage)</dt>
                            <dd class="text-lg font-semibold text-gray-900"
                                hx-get="/api/statistics/placed-count"
                                hx-trigger="load"
                                hx-swap="innerHTML">
                                -
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Jobs Liste #}
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
        {# Batch-Aktionen Header #}
        <div id="batch-actions"
             x-data="{ selectedCount: 0 }"
             @change.window="if ($event.target.name === 'selected_jobs') { selectedCount = document.querySelectorAll('input[name=selected_jobs]:checked').length }"
             class="border-b border-gray-200 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label class="inline-flex items-center">
                    <input type="checkbox"
                           id="select-all-jobs"
                           class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                           onclick="document.querySelectorAll('input[name=selected_jobs]').forEach(cb => cb.checked = this.checked); this.dispatchEvent(new Event('change', {bubbles: true}))">
                    <span class="ml-2 text-sm text-gray-700">Alle auswaehlen</span>
                </label>
                <span x-show="selectedCount > 0"
                      x-text="selectedCount + ' ausgewaehlt'"
                      class="text-sm text-primary-600 font-medium"
                      style="display: none;"></span>
            </div>
            <div x-show="selectedCount > 0" style="display: none;">
                <button type="button"
                        hx-delete="/api/jobs/batch"
                        hx-include="input[name=selected_jobs]:checked"
                        hx-target="#job-list"
                        hx-swap="innerHTML"
                        hx-confirm="Ausgewaehlte Jobs wirklich loeschen?"
                        class="inline-flex items-center rounded-md bg-red-50 px-3 py-1.5 text-sm font-semibold text-red-700 hover:bg-red-100">
                    <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                    Loeschen
                </button>
            </div>
        </div>

        {# Job-Liste Container #}
        <div id="job-list"
             hx-get="/partials/job-list"
             hx-trigger="load, jobsUpdated from:body"
             hx-swap="innerHTML"
             class="divide-y divide-gray-200">
            {# Skeleton waehrend des Ladens #}
            <div class="p-4">
                {% set count = 5 %}
                {% set type = 'card' %}
                {% include 'components/skeleton_list.html' %}
            </div>
        </div>

        {# Pagination Container #}
        <div id="job-pagination"
             hx-get="/partials/job-pagination"
             hx-trigger="load, jobsUpdated from:body"
             hx-swap="innerHTML">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Refresh bei erfolgreicher Aktion
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful) {
            const path = evt.detail.pathInfo?.requestPath || '';
            // Bei Loeschen/Restore Jobs neu laden
            if (path.includes('/jobs/') && (evt.detail.requestConfig?.verb === 'DELETE' || path.includes('/restore'))) {
                htmx.trigger(document.body, 'jobsUpdated');
            }
        }
    });
</script>
{% endblock %}
