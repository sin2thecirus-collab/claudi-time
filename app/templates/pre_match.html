{% extends "base.html" %}

{% block title %}Pre-Match - Pulspoint{% endblock %}

{% block content %}
<div x-data="{ searchTerm: '', category: '{{ category }}' }">

    {# ── Header ── #}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Pre-Match</h1>
            <p class="text-sm text-gray-500 mt-1">Automatisch generierte Kandidat-Job-Matches nach Beruf und Stadt</p>
        </div>
        <div class="flex items-center gap-3">
            {# Kategorie-Toggle #}
            <div class="flex bg-gray-100 rounded-lg p-0.5">
                <a href="/pre-match?category=FINANCE"
                   class="px-4 py-2 text-sm font-medium rounded-md transition-colors {% if category == 'FINANCE' %}bg-white text-primary-700 shadow-sm{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                    Finance
                </a>
                <a href="/pre-match?category=ENGINEERING"
                   class="px-4 py-2 text-sm font-medium rounded-md transition-colors {% if category == 'ENGINEERING' %}bg-white text-primary-700 shadow-sm{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                    Engineering
                </a>
            </div>

            {# Generieren Button #}
            <button onclick="triggerGenerate()"
                    id="generate-btn"
                    class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-700 transition-colors disabled:opacity-50"
                    {% if generate_status.running %}disabled{% endif %}>
                <svg class="w-4 h-4 {% if generate_status.running %}animate-spin{% endif %}" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    {% if generate_status.running %}
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    {% else %}
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182" />
                    {% endif %}
                </svg>
                {% if generate_status.running %}Generiert...{% else %}Pre-Matches generieren{% endif %}
            </button>
        </div>
    </div>

    {# ── Status-Banner (wenn Generierung laeuft/fertig) ── #}
    <div id="generate-status" class="mb-4" style="{% if not generate_status.running and not generate_status.result %}display:none{% endif %}">
        {% if generate_status.running %}
        <div class="rounded-lg bg-blue-50 border border-blue-200 p-4">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <div>
                    <p class="text-sm font-semibold text-blue-800">Generierung laeuft...</p>
                    <p class="text-xs text-blue-600" id="generate-progress">{{ generate_status.progress or '' }}</p>
                </div>
            </div>
        </div>
        {% elif generate_status.result %}
        <div class="rounded-lg bg-green-50 border border-green-200 p-4">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <p class="text-sm font-semibold text-green-800">
                        Generierung abgeschlossen: {{ generate_status.result.matches_created }} neue Matches erstellt
                    </p>
                    <p class="text-xs text-green-600">
                        {{ generate_status.result.combos_processed }} Jobs verarbeitet
                        {% if generate_status.result.errors_count > 0 %}, {{ generate_status.result.errors_count }} Fehler{% endif %}
                    </p>
                </div>
            </div>
        </div>
        {% elif generate_status.error %}
        <div class="rounded-lg bg-red-50 border border-red-200 p-4">
            <p class="text-sm font-semibold text-red-800">Fehler: {{ generate_status.error }}</p>
        </div>
        {% endif %}
    </div>

    {# ── Stats Cards ── #}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Gesamt-Matches</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.total_matches | default(0) }}</p>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Berufe</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.berufe_count | default(0) }}</p>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">&lt;5km Matches</p>
            <p class="text-2xl font-bold text-green-600 mt-1">{{ stats.close_matches | default(0) }}</p>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">&#8960; Distanz</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.avg_distance_km | default(0) }} km</p>
        </div>
    </div>

    {# ── Suchleiste ── #}
    <div class="mb-6">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <input type="text"
                   x-model="searchTerm"
                   placeholder="Beruf oder Stadt suchen..."
                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
        </div>
    </div>

    {# ── Beruf-Gruppen ── #}
    {% if by_profession %}
    <div class="space-y-4">
        {% for profession, cities in by_profession.items() %}
        <div x-data="{ open: true, cityNames: [{% for g in cities %}'{{ g.city | replace("'", "\\'") }}'{% if not loop.last %},{% endif %}{% endfor %}] }"
             x-show="!searchTerm || '{{ profession | lower }}'.includes(searchTerm.toLowerCase()) || cityNames.some(c => c.toLowerCase().includes(searchTerm.toLowerCase()))"
             class="bg-white rounded-xl border border-gray-200 overflow-hidden">

            {# Beruf-Header #}
            <button @click="open = !open"
                    class="w-full flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-primary-100 flex items-center justify-center">
                        <svg class="w-5 h-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0" />
                        </svg>
                    </div>
                    <div class="text-left">
                        <h3 class="text-base font-semibold text-gray-900">{{ profession }}</h3>
                        <p class="text-xs text-gray-500">{{ cities | length }} Stadt{{ 'e' if cities | length != 1 }} &middot; {{ cities | sum(attribute='match_count') }} Matches</p>
                    </div>
                </div>
                <svg class="w-5 h-5 text-gray-400 transition-transform" :class="{ 'rotate-180': open }" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>

            {# Staedte-Liste #}
            <div x-show="open" x-transition class="border-t border-gray-100">
                {% for group in cities %}
                <a href="/pre-match/detail?job_title={{ group.job_title | urlencode }}&city={{ group.city | urlencode }}&category={{ category }}"
                   x-show="!searchTerm || '{{ group.city | lower }}'.includes(searchTerm.toLowerCase()) || '{{ profession | lower }}'.includes(searchTerm.toLowerCase())"
                   class="flex items-center justify-between px-6 py-3 hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-b-0 group">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full {% if group.close_matches > 0 %}bg-green-400{% else %}bg-gray-300{% endif %}"></div>
                        <div>
                            <span class="text-sm font-medium text-gray-900 group-hover:text-primary-600">{{ group.city }}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6 text-xs">
                        <div class="text-center">
                            <span class="font-semibold text-gray-900">{{ group.match_count }}</span>
                            <span class="text-gray-400 ml-1">Matches</span>
                        </div>
                        <div class="text-center">
                            <span class="font-medium {% if group.avg_distance_km <= 10 %}text-green-600{% elif group.avg_distance_km <= 20 %}text-amber-600{% else %}text-gray-500{% endif %}">
                                &#8960; {{ group.avg_distance_km }} km
                            </span>
                        </div>
                        {% if group.close_matches > 0 %}
                        <div class="text-center">
                            <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700">
                                {{ group.close_matches }}&times; &lt;5km
                            </span>
                        </div>
                        {% endif %}
                        <div class="text-center">
                            <span class="font-medium text-gray-500">&#8960; {{ group.avg_pre_score }}</span>
                            <span class="text-gray-400 ml-0.5">Score</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-300 group-hover:text-primary-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
        <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-900">Noch keine Pre-Matches</h3>
        <p class="text-sm text-gray-500 mt-2">
            Klicke auf "Pre-Matches generieren" um automatisch passende Kandidat-Job-Paare zu finden.
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
async function triggerGenerate() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Generiert...';

    const statusEl = document.getElementById('generate-status');
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<div class="rounded-lg bg-blue-50 border border-blue-200 p-4"><div class="flex items-center gap-3"><svg class="w-5 h-5 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><div><p class="text-sm font-semibold text-blue-800">Generierung gestartet...</p><p class="text-xs text-blue-600" id="generate-progress"></p></div></div></div>';

    try {
        const resp = await fetch('/api/pre-match/generate?category={{ category }}&force=true', { method: 'POST' });
        if (!resp.ok) {
            const data = await resp.json();
            showToast(data.message || 'Fehler beim Starten', 'error');
            return;
        }

        // Polling fuer Status
        const poll = setInterval(async () => {
            try {
                const statusResp = await fetch('/api/pre-match/generate/status');
                const status = await statusResp.json();

                const progressEl = document.getElementById('generate-progress');
                if (progressEl) progressEl.textContent = status.progress || '';

                if (!status.running) {
                    clearInterval(poll);
                    if (status.error) {
                        showToast('Fehler: ' + status.error, 'error');
                    } else {
                        showToast('Pre-Matches generiert! Seite wird neu geladen...', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    }
                }
            } catch (e) {
                // Polling-Fehler ignorieren
            }
        }, 2000);

    } catch (e) {
        showToast('Netzwerkfehler: ' + e.message, 'error');
        btn.disabled = false;
    }
}
</script>
{% endblock %}
