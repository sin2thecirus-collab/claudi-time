{% extends "base.html" %}

{% block title %}Pre-Match - Pulspoint{% endblock %}

{% block content %}
<div x-data="preMatchPage()">

    {# ── Header ── #}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Pre-Match</h1>
            <p class="text-sm text-gray-500 mt-1">Automatisch generierte Kandidat-Job-Matches nach Beruf und Stadt</p>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
            {# Kategorie-Toggle #}
            <div class="flex bg-gray-100 rounded-lg p-0.5">
                <a href="/pre-match?category=FINANCE"
                   class="px-4 py-2 text-sm font-medium rounded-md transition-colors {% if category == 'FINANCE' %}bg-white text-primary-700 shadow-sm{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                    Finance
                </a>
                <a href="/pre-match?category=ENGINEERING"
                   class="px-4 py-2 text-sm font-medium rounded-md transition-colors {% if category == 'ENGINEERING' %}bg-white text-primary-700 shadow-sm{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                    Engineering
                </a>
            </div>

            {# Kalibrierungs-Dashboard Link #}
            <a href="/pre-match/calibration?category={{ category }}"
               class="inline-flex items-center gap-2 rounded-lg bg-purple-100 px-4 py-2.5 text-sm font-semibold text-purple-700 hover:bg-purple-200 transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5" />
                </svg>
                KI-Kalibrierung
            </a>

            {# Generieren Button #}
            <button onclick="triggerGenerate()"
                    id="generate-btn"
                    class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-700 transition-colors disabled:opacity-50"
                    {% if generate_status.running %}disabled{% endif %}>
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182" />
                </svg>
                Pre-Matches generieren
            </button>
        </div>
    </div>

    {# ── Status-Banner (Generierung) ── #}
    <div id="generate-status" class="mb-4" style="{% if not generate_status.running and not generate_status.result %}display:none{% endif %}">
        {% if generate_status.running %}
        <div class="rounded-lg bg-blue-50 border border-blue-200 p-4">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <div>
                    <p class="text-sm font-semibold text-blue-800">Generierung laeuft...</p>
                    <p class="text-xs text-blue-600" id="generate-progress">{{ generate_status.progress or '' }}</p>
                </div>
            </div>
        </div>
        {% elif generate_status.result %}
        <div class="rounded-lg bg-green-50 border border-green-200 p-4">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <p class="text-sm font-semibold text-green-800">
                        Generierung abgeschlossen: {{ generate_status.result.matches_created }} Matches erstellt
                        {% if generate_status.result.matches_filtered_out %}
                        <span class="font-normal text-green-600">
                            ({{ generate_status.result.matches_filtered_out }} durch KI-Filterung aussortiert)
                        </span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {# ── Quick-AI Status-Banner ── #}
    <div id="quick-ai-status" class="mb-4" style="display:none"></div>

    {# ── Bulk-Evaluate Status-Banner ── #}
    <div id="bulk-evaluate-status" class="mb-4" style="display:none"></div>

    {# ── Auswahl-Aktionsleiste (erscheint wenn Checkboxen aktiv) ── #}
    <div x-show="selectedCount > 0" x-transition x-cloak
         class="mb-4 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 p-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-semibold text-amber-900">
                        <span x-text="selectedCount"></span> Kombination<span x-show="selectedCount !== 1">en</span> ausgewaehlt
                        (<span x-text="selectedMatchCount"></span> Matches)
                    </p>
                    <p class="text-xs text-amber-600" x-text="selectedLabels.join(' • ')"></p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button @click="clearSelection()"
                        class="px-3 py-2 text-sm font-medium text-amber-700 hover:text-amber-900 transition-colors">
                    Auswahl aufheben
                </button>

                {# Quick-AI Button — guenstige Schnellbewertung #}
                <button @click="triggerQuickAIScoped()"
                        id="quick-ai-btn"
                        :disabled="quickAIRunning"
                        class="inline-flex items-center gap-2 rounded-lg bg-cyan-500 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-cyan-600 transition-colors disabled:opacity-50">
                    <template x-if="!quickAIRunning">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12.378 1.602a.75.75 0 00-.756 0L3 6.632l9 5.25 9-5.25-8.622-5.03zM21.75 7.93l-9 5.25v9l8.628-5.032a.75.75 0 00.372-.648V7.93zM11.25 22.18v-9l-9-5.25v8.57a.75.75 0 00.372.648l8.628 5.033z" />
                        </svg>
                    </template>
                    <template x-if="quickAIRunning">
                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </template>
                    <span x-text="quickAIRunning ? quickAIProgress : 'Quick-AI Check'"></span>
                </button>

                {# Deep Match Button — ausfuehrliche KI-Bewertung #}
                <button @click="startBulkDeepMatch()"
                        :disabled="bulkRunning"
                        class="inline-flex items-center gap-2 rounded-lg bg-amber-500 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-amber-600 transition-colors disabled:opacity-50">
                    <template x-if="!bulkRunning">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                        </svg>
                    </template>
                    <template x-if="bulkRunning">
                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </template>
                    <span x-text="bulkRunning ? bulkProgress : 'Deep Match starten'"></span>
                </button>
            </div>
        </div>
    </div>

    {# ── Stats Cards ── #}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Gesamt-Matches</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.total_matches | default(0) }}</p>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Berufe</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.berufe_count | default(0) }}</p>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">&lt;5km Matches</p>
            <p class="text-2xl font-bold text-green-600 mt-1">{{ stats.close_matches | default(0) }}</p>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">&#8960; Distanz</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.avg_distance_km | default(0) }} km</p>
        </div>
    </div>

    {# ── Quick-AI Filter Info ── #}
    {% if stats.quick_ai_filtered and stats.quick_ai_filtered > 0 %}
    <div class="mb-6 rounded-lg bg-cyan-50 border border-cyan-200 p-3">
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-cyan-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12.378 1.602a.75.75 0 00-.756 0L3 6.632l9 5.25 9-5.25-8.622-5.03zM21.75 7.93l-9 5.25v9l8.628-5.032a.75.75 0 00.372-.648V7.93zM11.25 22.18v-9l-9-5.25v8.57a.75.75 0 00.372.648l8.628 5.033z" />
            </svg>
            <p class="text-xs text-cyan-700">
                <strong>Quick-AI Filter aktiv:</strong>
                {{ stats.quick_ai_filtered }} Kandidat{{ 'en' if stats.quick_ai_filtered != 1 }} mit Quick-AI Score &lt;30 wurden aus den Listen ausgeblendet.
            </p>
        </div>
    </div>
    {% endif %}

    {# ── Suchleiste ── #}
    <div class="mb-6">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <input type="text"
                   x-model="searchTerm"
                   placeholder="Beruf oder Stadt suchen..."
                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
        </div>
    </div>

    {# ── Beruf-Gruppen mit Checkboxen ── #}
    {% if by_profession %}
    <div class="space-y-4">
        {% for profession, cities in by_profession.items() %}
        <div x-data="{ open: true, citiesData: {{ cities_json_map[profession] }} }"
             x-show="!searchTerm || '{{ profession | lower }}'.includes(searchTerm.toLowerCase()) || citiesData.some(c => c.city.toLowerCase().includes(searchTerm.toLowerCase()))"
             class="bg-white rounded-xl border border-gray-200 overflow-hidden">

            {# Beruf-Header #}
            <div class="flex items-center px-6 py-4 hover:bg-gray-50 transition-colors">
                {# Checkbox: Alle Staedte dieser Berufsgruppe #}
                <input type="checkbox"
                       @click.stop="toggleProfession('{{ profession | replace("'", "\\'") }}', citiesData)"
                       :checked="isProfessionFullySelected('{{ profession | replace("'", "\\'") }}', citiesData)"
                       :indeterminate="isProfessionPartiallySelected('{{ profession | replace("'", "\\'") }}', citiesData)"
                       class="w-4 h-4 rounded border-gray-300 text-amber-500 focus:ring-amber-500 mr-4 cursor-pointer">

                <button @click="open = !open" class="flex-1 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-primary-100 flex items-center justify-center">
                            <svg class="w-5 h-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <h3 class="text-base font-semibold text-gray-900">{{ profession }}</h3>
                            <p class="text-xs text-gray-500">{{ cities | length }} Stadt{{ 'e' if cities | length != 1 }} &middot; {{ cities | sum(attribute='match_count') }} Matches</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 transition-transform" :class="{ 'rotate-180': open }" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
            </div>

            {# Staedte-Liste mit Checkboxen #}
            <div x-show="open" x-transition class="border-t border-gray-100">
                {% for group in cities %}
                <div x-show="!searchTerm || '{{ group.city | lower }}'.includes(searchTerm.toLowerCase()) || '{{ profession | lower }}'.includes(searchTerm.toLowerCase())"
                     class="flex items-center justify-between px-6 py-3 hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-b-0">

                    {# Checkbox + Link #}
                    <div class="flex items-center gap-3">
                        <input type="checkbox"
                               @click.stop="toggleCombo('{{ group.job_title | replace("'", "\\'") }}', '{{ group.city | replace("'", "\\'") }}', {{ group.match_count }})"
                               :checked="isSelected('{{ group.job_title | replace("'", "\\'") }}', '{{ group.city | replace("'", "\\'") }}')"
                               class="w-4 h-4 rounded border-gray-300 text-amber-500 focus:ring-amber-500 cursor-pointer">
                        <div class="w-2 h-2 rounded-full {% if group.close_matches > 0 %}bg-green-400{% else %}bg-gray-300{% endif %}"></div>
                        <a href="/pre-match/detail?job_title={{ group.job_title | urlencode }}&city={{ group.city | urlencode }}&category={{ category }}"
                           class="text-sm font-medium text-gray-900 hover:text-primary-600 transition-colors">
                            {{ group.city }}
                        </a>
                    </div>

                    {# Stats #}
                    <div class="flex items-center gap-6 text-xs">
                        <div class="text-center">
                            <span class="font-semibold text-gray-900">{{ group.match_count }}</span>
                            <span class="text-gray-400 ml-1">Matches</span>
                        </div>
                        <div class="text-center">
                            <span class="font-medium {% if group.avg_distance_km <= 10 %}text-green-600{% elif group.avg_distance_km <= 20 %}text-amber-600{% else %}text-gray-500{% endif %}">
                                &#8960; {{ group.avg_distance_km }} km
                            </span>
                        </div>
                        {% if group.close_matches > 0 %}
                        <div class="text-center">
                            <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700">
                                {{ group.close_matches }}&times; &lt;5km
                            </span>
                        </div>
                        {% endif %}
                        <div class="text-center">
                            <span class="font-medium text-gray-500">&#8960; {{ group.avg_pre_score }}</span>
                            <span class="text-gray-400 ml-0.5">Score</span>
                        </div>
                        <a href="/pre-match/detail?job_title={{ group.job_title | urlencode }}&city={{ group.city | urlencode }}&category={{ category }}"
                           class="text-gray-300 hover:text-primary-500">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                            </svg>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
        <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-900">Noch keine Pre-Matches</h3>
        <p class="text-sm text-gray-500 mt-2">
            Klicke auf "Pre-Matches generieren" um automatisch passende Kandidat-Job-Paare zu finden.
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function preMatchPage() {
    return {
        searchTerm: '',
        category: '{{ category }}',
        // Auswahl: Set von "job_title|||city" Keys
        selected: {},  // key -> { job_title, city, match_count }
        bulkRunning: false,
        bulkProgress: '',
        quickAIRunning: false,
        quickAIProgress: '',

        // ── Computed Properties ──

        get selectedCount() {
            return Object.keys(this.selected).length;
        },

        get selectedMatchCount() {
            return Object.values(this.selected).reduce((sum, s) => sum + (s.match_count || 0), 0);
        },

        get selectedLabels() {
            return Object.values(this.selected).map(s => s.job_title + ' / ' + s.city);
        },

        // ── Auswahl-Methoden ──

        _key(jobTitle, city) {
            return jobTitle + '|||' + city;
        },

        isSelected(jobTitle, city) {
            return this._key(jobTitle, city) in this.selected;
        },

        toggleCombo(jobTitle, city, matchCount) {
            const key = this._key(jobTitle, city);
            if (key in this.selected) {
                delete this.selected[key];
            } else {
                this.selected[key] = { job_title: jobTitle, city: city, match_count: matchCount };
            }
            // Force reactivity
            this.selected = { ...this.selected };
        },

        isProfessionFullySelected(profession, cities) {
            return cities.length > 0 && cities.every(c => this.isSelected(c.job_title, c.city));
        },

        isProfessionPartiallySelected(profession, cities) {
            const some = cities.some(c => this.isSelected(c.job_title, c.city));
            const all = cities.every(c => this.isSelected(c.job_title, c.city));
            return some && !all;
        },

        toggleProfession(profession, cities) {
            const allSelected = this.isProfessionFullySelected(profession, cities);
            for (const c of cities) {
                const key = this._key(c.job_title, c.city);
                if (allSelected) {
                    delete this.selected[key];
                } else {
                    this.selected[key] = { job_title: c.job_title, city: c.city, match_count: c.match_count };
                }
            }
            this.selected = { ...this.selected };
        },

        clearSelection() {
            this.selected = {};
        },

        // ── Quick-AI (nur fuer ausgewaehlte Kombinationen) ──

        async triggerQuickAIScoped() {
            const combos = Object.values(this.selected);
            if (combos.length === 0) {
                alert('Bitte zuerst eine oder mehrere Kombinationen per Checkbox auswaehlen.\n\nQuick-AI bewertet dann NUR die ausgewaehlten Matches.');
                return;
            }

            const totalMatches = this.selectedMatchCount;
            const labels = combos.map(c => c.job_title + ' / ' + c.city).join('\n  • ');
            if (!confirm(
                `Quick-AI Scoring starten fuer:\n  • ${labels}\n\n` +
                `${totalMatches} Matches werden durch KI bewertet.\n` +
                `Geschaetzte Kosten: ~$${(totalMatches * 0.00004).toFixed(3)}\n\n` +
                `Fortfahren?`
            )) return;

            this.quickAIRunning = true;
            this.quickAIProgress = 'Starte...';

            const statusEl = document.getElementById('quick-ai-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `
                <div class="rounded-lg bg-cyan-50 border border-cyan-200 p-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-cyan-500 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-cyan-800">Quick-AI gestartet fuer ${combos.length} Kombination(en)...</p>
                            <p class="text-xs text-cyan-600" id="quick-ai-progress"></p>
                        </div>
                    </div>
                </div>`;

            // Sequenziell jede Kombination bewerten
            let totalScored = 0;
            let totalCost = 0;
            let combosDone = 0;

            for (const combo of combos) {
                combosDone++;
                this.quickAIProgress = `${combosDone}/${combos.length}: ${combo.job_title} / ${combo.city}`;
                const progressEl = document.getElementById('quick-ai-progress');
                if (progressEl) {
                    progressEl.textContent = `Kombination ${combosDone}/${combos.length}: ${combo.job_title} / ${combo.city}...`;
                }

                try {
                    const params = new URLSearchParams({
                        category: this.category,
                        max_matches: String(combo.match_count + 50),
                        job_title: combo.job_title,
                        city: combo.city,
                    });
                    const resp = await fetch(`/api/quick-score/run?${params}`, { method: 'POST' });
                    if (!resp.ok) {
                        const data = await resp.json();
                        if (data.error === 'already_running') {
                            // Warten bis fertig, dann weiter
                            await this._waitForQuickAI(progressEl, combo);
                        }
                        continue;
                    }

                    // Warten bis dieser Durchlauf fertig ist
                    const result = await this._waitForQuickAI(progressEl, combo);
                    if (result) {
                        totalScored += result.scored || 0;
                        totalCost += result.total_cost_usd || 0;
                    }
                } catch (e) {
                    console.error('Quick-AI Fehler:', e);
                }
            }

            // Fertig!
            this.quickAIRunning = false;
            this.quickAIProgress = '';
            statusEl.innerHTML = `
                <div class="rounded-lg bg-green-50 border border-green-200 p-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-green-800">Quick-AI abgeschlossen!</p>
                            <p class="text-xs text-green-600 mt-1">
                                <strong>${totalScored}</strong> Matches bewertet &middot;
                                ${combos.length} Kombination(en) &middot;
                                Kosten: $${totalCost.toFixed(3)}
                            </p>
                            <p class="text-xs text-green-500 mt-1">Seite wird aktualisiert — unpassende Kandidaten werden ausgeblendet...</p>
                        </div>
                    </div>
                </div>`;
            if (typeof showToast === 'function') showToast(`Quick-AI: ${totalScored} Matches bewertet! Seite wird aktualisiert...`, 'success');

            // Seite neu laden damit gefilterte Matches verschwinden und Counts aktualisiert werden
            setTimeout(() => window.location.reload(), 2000);
        },

        async _waitForQuickAI(progressEl, combo) {
            // Pollt den Quick-AI-Status bis fertig
            return new Promise((resolve) => {
                const poll = setInterval(async () => {
                    try {
                        const sr = await fetch('/api/quick-score/status');
                        const status = await sr.json();
                        if (progressEl && status.progress) {
                            progressEl.textContent = `${combo.job_title} / ${combo.city}: ${status.progress}`;
                        }
                        if (!status.running) {
                            clearInterval(poll);
                            resolve(status.result || null);
                        }
                    } catch (e) {
                        clearInterval(poll);
                        resolve(null);
                    }
                }, 2000);
            });
        },

        // ── Bulk Deep Match ──

        async startBulkDeepMatch() {
            const combos = Object.values(this.selected);
            if (combos.length === 0) return;

            const totalMatches = this.selectedMatchCount;
            if (!confirm(
                `Deep Match fuer ${combos.length} Kombination(en) starten?\n\n` +
                `${totalMatches} Matches werden durch OpenAI bewertet.\n` +
                `Geschaetzte Dauer: ${Math.ceil(totalMatches * 2 / 60)} Minuten\n` +
                `Geschaetzte Kosten: ~$${(totalMatches * 0.0005).toFixed(2)}\n\n` +
                `Fortfahren?`
            )) return;

            this.bulkRunning = true;
            this.bulkProgress = 'Wird gestartet...';

            const statusEl = document.getElementById('bulk-evaluate-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `
                <div class="rounded-lg bg-amber-50 border border-amber-200 p-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-amber-500 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-amber-800">Bulk KI-Bewertung laeuft...</p>
                            <p class="text-xs text-amber-600" id="bulk-progress-text">Starte...</p>
                        </div>
                    </div>
                </div>`;

            try {
                const resp = await fetch('/api/deepmatch/bulk-evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category: this.category,
                        combos: combos.map(c => ({ job_title: c.job_title, city: c.city })),
                        max_matches: totalMatches,
                    }),
                });
                const data = await resp.json();

                if (data.status === 'already_running') {
                    showToast('Bulk-Bewertung laeuft bereits!', 'warning');
                }

                // Polling
                const poll = setInterval(async () => {
                    try {
                        const sr = await fetch('/api/deepmatch/bulk-evaluate/status');
                        const status = await sr.json();

                        const pEl = document.getElementById('bulk-progress-text');
                        if (pEl && status.progress) {
                            pEl.textContent = status.progress.detail || '';
                            this.bulkProgress = status.progress.detail || 'Laeuft...';
                        }

                        if (!status.running) {
                            clearInterval(poll);
                            this.bulkRunning = false;
                            this.bulkProgress = '';

                            if (status.error) {
                                statusEl.innerHTML = `<div class="rounded-lg bg-red-50 border border-red-200 p-4"><p class="text-sm font-semibold text-red-800">Fehler: ${status.error}</p></div>`;
                                showToast('Bulk-Bewertung fehlgeschlagen!', 'error');
                            } else if (status.result) {
                                const r = status.result;
                                statusEl.innerHTML = `
                                    <div class="rounded-lg bg-green-50 border border-green-200 p-4">
                                        <div class="flex items-center gap-3">
                                            <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <div>
                                                <p class="text-sm font-semibold text-green-800">Bulk KI-Bewertung abgeschlossen!</p>
                                                <p class="text-xs text-green-600 mt-1">
                                                    <strong>${r.evaluated}</strong> von ${r.total_matches} bewertet &middot;
                                                    &Oslash; AI-Score: <strong>${r.avg_ai_score?.toFixed(2) || '?'}</strong> &middot;
                                                    Kosten: $${r.total_cost_usd?.toFixed(3) || '?'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>`;
                                showToast(`${r.evaluated} Matches KI-bewertet!`, 'success');
                            }
                        }
                    } catch (e) { /* ignore */ }
                }, 3000);

            } catch (e) {
                showToast('Netzwerkfehler: ' + e.message, 'error');
                this.bulkRunning = false;
                this.bulkProgress = '';
            }
        },
    };
}

// ═══════════════════════════════════════════════════════════
// PRE-MATCH GENERIERUNG (unveraendert)
// ═══════════════════════════════════════════════════════════

async function triggerGenerate() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Generiert...';

    const statusEl = document.getElementById('generate-status');
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<div class="rounded-lg bg-blue-50 border border-blue-200 p-4"><div class="flex items-center gap-3"><svg class="w-5 h-5 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><div><p class="text-sm font-semibold text-blue-800">Generierung gestartet...</p><p class="text-xs text-blue-600" id="generate-progress"></p></div></div></div>';

    try {
        const resp = await fetch('/api/pre-match/generate?category={{ category }}&force=true', { method: 'POST' });
        if (!resp.ok) {
            const data = await resp.json();
            showToast(data.message || 'Fehler beim Starten', 'error');
            return;
        }

        const poll = setInterval(async () => {
            try {
                const statusResp = await fetch('/api/pre-match/generate/status');
                const status = await statusResp.json();
                const progressEl = document.getElementById('generate-progress');
                if (progressEl) progressEl.textContent = status.progress || '';
                if (!status.running) {
                    clearInterval(poll);
                    if (status.error) {
                        showToast('Fehler: ' + status.error, 'error');
                    } else {
                        showToast('Pre-Matches generiert! Seite wird neu geladen...', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    }
                }
            } catch (e) { /* ignore */ }
        }, 2000);

    } catch (e) {
        showToast('Netzwerkfehler: ' + e.message, 'error');
        btn.disabled = false;
    }
}

// Quick-AI ist jetzt im Alpine preMatchPage() Kontext (triggerQuickAIScoped)
// und unterstuetzt Auswahl-basiertes Scoring.
</script>
{% endblock %}
