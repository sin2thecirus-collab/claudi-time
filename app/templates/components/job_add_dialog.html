{# Job hinzufügen Dialog - Modal für manuelle Job-Erstellung #}

<style>[x-cloak] { display: none !important; }</style>

<div class="bg-white px-4 pb-4 pt-5 sm:p-6">
    <div class="sm:flex sm:items-start">
        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </div>
        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left flex-1 min-w-0 overflow-hidden">
            <h3 class="text-base font-semibold leading-6 text-gray-900">Job hinzufuegen</h3>
            <p class="mt-1 text-sm text-gray-500">Waehlen Sie ein Unternehmen oder erstellen Sie ein neues.</p>

            <div class="mt-4 space-y-4">

                {# Unternehmen - Searchable Dropdown #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Unternehmen <span class="text-red-500">*</span>
                    </label>

                    <div class="flex gap-2 w-full">
                        {# Search Input with Dropdown #}
                        <div class="flex-1 min-w-0 relative">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </span>
                                <input type="text" id="company-search"
                                       placeholder="Unternehmen suchen..."
                                       autocomplete="off"
                                       class="w-full rounded-lg border border-gray-300 bg-white py-2 pl-10 pr-3 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                            </div>

                            {# Dropdown Results #}
                            <div id="company-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                <div id="company-dropdown-content">
                                    {# Filled dynamically #}
                                </div>
                            </div>
                        </div>

                        {# New Company Button #}
                        <button type="button" id="new-company-btn"
                                class="px-3 py-2 rounded-lg bg-green-600 hover:bg-green-500 text-white transition-colors"
                                title="Neues Unternehmen erstellen">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                    </div>

                    {# Selected Company Display #}
                    <div id="selected-company" class="hidden mt-2 text-sm text-green-700 font-medium flex items-center gap-2">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span id="selected-company-text"></span>
                        <button type="button" id="clear-company-btn" class="ml-auto text-gray-400 hover:text-gray-600">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    {# New Company Form (hidden) #}
                    <div id="new-company-form" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg space-y-2">
                        <p class="text-sm font-medium text-green-800">Neues Unternehmen:</p>
                        <input type="text" id="new-company-name" placeholder="Firmenname *"
                               class="w-full rounded border border-gray-300 py-1.5 px-2 text-sm">
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" id="new-company-plz" placeholder="PLZ" maxlength="5"
                                   class="rounded border border-gray-300 py-1.5 px-2 text-sm">
                            <input type="text" id="new-company-city" placeholder="Stadt"
                                   class="col-span-2 rounded border border-gray-300 py-1.5 px-2 text-sm">
                        </div>
                        <input type="text" id="new-company-street" placeholder="Strasse"
                               class="w-full rounded border border-gray-300 py-1.5 px-2 text-sm">
                        <button type="button" id="create-company-btn"
                                class="w-full py-2 rounded bg-green-600 hover:bg-green-500 text-white text-sm font-medium transition-colors">
                            Unternehmen erstellen
                        </button>
                    </div>
                </div>

                {# Position #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Position / Titel <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="job-position" placeholder="z.B. Senior Softwareentwickler"
                           class="w-full rounded-lg border border-gray-300 py-2 px-3 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                </div>

                {# PLZ + Stadt #}
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">PLZ</label>
                        <input type="text" id="job-plz" placeholder="12345" maxlength="5"
                               class="w-full rounded-lg border border-gray-300 py-2 px-3 text-sm bg-gray-50">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stadt</label>
                        <input type="text" id="job-city" placeholder="Hamburg"
                               class="w-full rounded-lg border border-gray-300 py-2 px-3 text-sm bg-gray-50">
                    </div>
                </div>

                {# Strasse #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Strasse</label>
                    <input type="text" id="job-street" placeholder="Musterstrasse 123"
                           class="w-full rounded-lg border border-gray-300 py-2 px-3 text-sm bg-gray-50">
                </div>

                {# Beschaeftigungsart + Branche #}
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Beschaeftigungsart</label>
                        <select id="job-employment-type" class="w-full rounded-lg border border-gray-300 bg-white py-2 px-3 text-sm">
                            <option value="">-- Auswaehlen --</option>
                            <option value="Vollzeit">Vollzeit</option>
                            <option value="Teilzeit">Teilzeit</option>
                            <option value="Festanstellung">Festanstellung</option>
                            <option value="Freelance">Freelance</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Branche</label>
                        <input type="text" id="job-industry" placeholder="z.B. IT"
                               class="w-full rounded-lg border border-gray-300 py-2 px-3 text-sm">
                    </div>
                </div>

                {# PDF Upload Zone - Mit Alpine.js (wie bei Unternehmen hinzufuegen) #}
                <div x-data="{
                    pdfUploading: false,
                    pdfSuccess: false,
                    dragging: false,

                    handleDrop(event) {
                        this.dragging = false;
                        const file = event.dataTransfer.files[0];
                        if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
                            if (typeof showToast === 'function') showToast('Bitte nur PDF-Dateien', 'error');
                            return;
                        }
                        this.uploadPdf(file);
                    },

                    handleFileSelect(event) {
                        const file = event.target.files[0];
                        if (file) this.uploadPdf(file);
                    },

                    formatText(text) {
                        if (!text) return '';

                        // Normalize line endings
                        let formatted = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                        // Remove excessive whitespace within lines
                        formatted = formatted.replace(/[ \t]+/g, ' ');

                        // Fix common PDF extraction issues (split words)
                        formatted = formatted.replace(/(\w)‐\n(\w)/g, '$1$2');
                        formatted = formatted.replace(/(\w)-\n(\w)/g, '$1$2');

                        // Remove multiple consecutive empty lines (keep max 2)
                        formatted = formatted.replace(/\n{3,}/g, '\n\n');

                        // Trim each line
                        formatted = formatted.split('\n').map(line => line.trim()).join('\n');

                        // Add extra line break before common section headers
                        const headers = ['Aufgaben', 'Profil', 'Anforderungen', 'Wir bieten', 'Kontakt', 'Benefits', 'Qualifikationen', 'Ihre Aufgaben', 'Ihr Profil', 'Was wir bieten', 'Ueber uns', 'Über uns'];
                        headers.forEach(h => {
                            const regex = new RegExp('\\n(' + h + '[:\\s]?)', 'gi');
                            formatted = formatted.replace(regex, '\n\n$1');
                        });

                        // Clean up start and end
                        formatted = formatted.trim();

                        return formatted;
                    },

                    async uploadPdf(file) {
                        if (file.size > 10 * 1024 * 1024) {
                            if (typeof showToast === 'function') showToast('Datei zu gross (max. 10MB)', 'error');
                            return;
                        }
                        this.pdfUploading = true;
                        this.pdfSuccess = false;
                        try {
                            const formData = new FormData();
                            formData.append('file', file);
                            const resp = await fetch('/api/companies/extract-job-pdf', {
                                method: 'POST',
                                body: formData
                            });
                            if (!resp.ok) {
                                const err = await resp.json();
                                throw new Error(err.detail || 'PDF-Extraktion fehlgeschlagen');
                            }
                            const data = await resp.json();
                            const extractedText = data.description || data.text || '';
                            if (extractedText) {
                                const cleanText = this.formatText(extractedText);
                                document.getElementById('job-text').value = cleanText;
                                this.pdfSuccess = true;
                                if (typeof showToast === 'function') showToast('PDF erfolgreich importiert', 'success');
                            } else {
                                if (typeof showToast === 'function') showToast('Kein Text in PDF gefunden', 'error');
                            }
                        } catch(e) {
                            if (typeof showToast === 'function') showToast(e.message, 'error');
                        } finally {
                            this.pdfUploading = false;
                        }
                    },

                    reset() {
                        this.pdfSuccess = false;
                        document.getElementById('job-pdf-input').value = '';
                    }
                }">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jobbeschreibung aus PDF importieren</label>
                    <div class="border-2 border-dashed rounded-lg p-4 text-center transition-colors cursor-pointer"
                         :class="pdfUploading ? 'opacity-50 pointer-events-none border-gray-300' : dragging ? 'border-primary-500 bg-primary-50' : pdfSuccess ? 'border-green-400 bg-green-50' : 'border-gray-300 hover:border-primary-400'"
                         @dragover.prevent="dragging = true"
                         @dragenter.prevent="dragging = true"
                         @dragleave.prevent="dragging = false"
                         @drop.prevent="handleDrop($event)"
                         @click="if (!pdfSuccess) $refs.fileInput.click()">
                        <input type="file" id="job-pdf-input" x-ref="fileInput" accept=".pdf" class="hidden" @change="handleFileSelect($event)">

                        {# Default State #}
                        <template x-if="!pdfUploading && !pdfSuccess && !dragging">
                            <div>
                                <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">PDF hierher ziehen oder <span class="text-primary-600 font-medium">klicken</span></p>
                                <p class="mt-1 text-xs text-gray-400">Max. 10MB</p>
                            </div>
                        </template>

                        {# Dragging State #}
                        <template x-if="dragging && !pdfUploading">
                            <div>
                                <svg class="mx-auto h-10 w-10 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                </svg>
                                <p class="mt-2 text-sm text-primary-600 font-medium">PDF hier ablegen</p>
                            </div>
                        </template>

                        {# Loading State #}
                        <template x-if="pdfUploading">
                            <div>
                                <svg class="mx-auto h-8 w-8 animate-spin text-primary-600" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">Text wird extrahiert...</p>
                            </div>
                        </template>

                        {# Success State #}
                        <template x-if="pdfSuccess && !pdfUploading">
                            <div>
                                <svg class="mx-auto h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p class="mt-2 text-sm text-green-600 font-medium">PDF erfolgreich importiert!</p>
                                <button type="button" @click.stop="reset()" class="mt-1 text-xs text-gray-500 hover:text-gray-700 underline">Andere Datei hochladen</button>
                            </div>
                        </template>
                    </div>
                </div>

                {# Stellenbeschreibung Textarea #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stellenbeschreibung</label>
                    <textarea id="job-text" rows="5" placeholder="Text aus PDF wird hier eingefuegt oder manuell eingeben..."
                              class="w-full rounded-lg border border-gray-300 py-2 px-3 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500"></textarea>
                </div>

            </div>
        </div>
    </div>
</div>

{# Footer Buttons #}
<div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
    <button type="button" id="submit-job-btn"
            class="w-full sm:w-auto sm:ml-3 px-4 py-2 rounded-md text-sm font-semibold text-white bg-gray-300 cursor-not-allowed transition-colors">
        Job erstellen
    </button>
    <button type="button" onclick="closeModal()"
            class="mt-3 sm:mt-0 w-full sm:w-auto px-4 py-2 rounded-md bg-white text-sm font-semibold text-gray-900 ring-1 ring-gray-300 hover:bg-gray-50">
        Abbrechen
    </button>
</div>

<script>
(function() {
    // State
    var selectedCompanyId = null;
    var selectedCompanyName = '';
    var selectedCompanyData = null;
    var showNewForm = false;
    var searchTimeout = null;
    var isDropdownOpen = false;

    // Elements
    var searchInput = document.getElementById('company-search');
    var dropdown = document.getElementById('company-dropdown');
    var dropdownContent = document.getElementById('company-dropdown-content');
    var selectedDisplay = document.getElementById('selected-company');
    var selectedText = document.getElementById('selected-company-text');
    var clearBtn = document.getElementById('clear-company-btn');
    var newCompanyBtn = document.getElementById('new-company-btn');
    var newCompanyForm = document.getElementById('new-company-form');
    var createCompanyBtn = document.getElementById('create-company-btn');
    var submitBtn = document.getElementById('submit-job-btn');

    // ========== Searchable Company Dropdown ==========

    // Search companies with debounce
    searchInput.addEventListener('input', function() {
        var query = this.value.trim();

        if (searchTimeout) clearTimeout(searchTimeout);

        if (query.length < 1) {
            hideDropdown();
            return;
        }

        searchTimeout = setTimeout(function() {
            searchCompanies(query);
        }, 300);
    });

    // Focus shows dropdown if there's text
    searchInput.addEventListener('focus', function() {
        if (this.value.trim().length >= 1) {
            searchCompanies(this.value.trim());
        }
    });

    // Search API call
    function searchCompanies(query) {
        dropdownContent.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">Suche...</div>';
        showDropdown();

        fetch('/api/companies?search=' + encodeURIComponent(query) + '&per_page=20')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var items = data.items || [];

                if (items.length === 0) {
                    dropdownContent.innerHTML = '<div class="px-3 py-3 text-sm text-gray-500 text-center">Kein Unternehmen gefunden</div>';
                    return;
                }

                var html = '';
                items.forEach(function(c) {
                    html += '<div class="company-option px-3 py-2 hover:bg-primary-50 cursor-pointer text-sm border-b border-gray-100 last:border-0" ' +
                            'data-id="' + c.id + '" ' +
                            'data-name="' + escapeHtml(c.name) + '" ' +
                            'data-city="' + escapeHtml(c.city || '') + '" ' +
                            'data-address="' + escapeHtml(c.address || c.display_address || '') + '">' +
                            '<div class="font-medium text-gray-900">' + escapeHtml(c.name) + '</div>' +
                            (c.city ? '<div class="text-xs text-gray-500">' + escapeHtml(c.city) + '</div>' : '') +
                            '</div>';
                });
                dropdownContent.innerHTML = html;

                // Add click handlers
                dropdownContent.querySelectorAll('.company-option').forEach(function(opt) {
                    opt.addEventListener('click', function() {
                        selectCompany({
                            id: this.dataset.id,
                            name: this.dataset.name,
                            city: this.dataset.city,
                            address: this.dataset.address
                        });
                    });
                });
            })
            .catch(function(e) {
                dropdownContent.innerHTML = '<div class="px-3 py-2 text-sm text-red-500">Fehler beim Laden</div>';
            });
    }

    function selectCompany(company) {
        selectedCompanyId = company.id;
        selectedCompanyName = company.name;
        selectedCompanyData = company;

        // Fill fields from company
        document.getElementById('job-city').value = company.city || '';
        document.getElementById('job-street').value = company.address || '';
        document.getElementById('job-plz').value = '';

        // Update display
        selectedText.textContent = company.name + (company.city ? ' - ' + company.city : '');
        selectedDisplay.classList.remove('hidden');
        searchInput.value = '';
        searchInput.classList.add('hidden');

        hideDropdown();
        updateSubmitButton();
    }

    // Clear company selection
    clearBtn.addEventListener('click', function() {
        selectedCompanyId = null;
        selectedCompanyName = '';
        selectedCompanyData = null;
        selectedDisplay.classList.add('hidden');
        searchInput.classList.remove('hidden');
        searchInput.value = '';
        searchInput.focus();
        updateSubmitButton();
    });

    function showDropdown() {
        dropdown.classList.remove('hidden');
        isDropdownOpen = true;
    }

    function hideDropdown() {
        dropdown.classList.add('hidden');
        isDropdownOpen = false;
    }

    // Close dropdown on click outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideDropdown();
        }
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (!isDropdownOpen) return;

        var options = dropdownContent.querySelectorAll('.company-option');
        var focused = dropdownContent.querySelector('.company-option.bg-primary-100');
        var index = Array.prototype.indexOf.call(options, focused);

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (focused) focused.classList.remove('bg-primary-100');
            var next = options[Math.min(index + 1, options.length - 1)];
            if (next) {
                next.classList.add('bg-primary-100');
                next.scrollIntoView({ block: 'nearest' });
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (focused) focused.classList.remove('bg-primary-100');
            var prev = options[Math.max(index - 1, 0)];
            if (prev) {
                prev.classList.add('bg-primary-100');
                prev.scrollIntoView({ block: 'nearest' });
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (focused) focused.click();
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    });

    // ========== New Company ==========

    newCompanyBtn.addEventListener('click', function() {
        showNewForm = !showNewForm;
        if (showNewForm) {
            newCompanyForm.classList.remove('hidden');
            newCompanyBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
            newCompanyBtn.classList.add('bg-gray-400');
        } else {
            newCompanyForm.classList.add('hidden');
            newCompanyBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            newCompanyBtn.classList.remove('bg-gray-400');
        }
    });

    createCompanyBtn.addEventListener('click', function() {
        var name = document.getElementById('new-company-name').value.trim();
        if (!name) {
            showToast('Bitte Firmennamen eingeben', 'error');
            return;
        }

        createCompanyBtn.textContent = 'Erstelle...';
        createCompanyBtn.disabled = true;

        fetch('/api/companies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                city: document.getElementById('new-company-city').value || null,
                postal_code: document.getElementById('new-company-plz').value || null,
                street: document.getElementById('new-company-street').value || null
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.id) {
                showToast('Unternehmen erstellt', 'success');

                // Select the new company
                selectCompany({
                    id: data.id,
                    name: name,
                    city: document.getElementById('new-company-city').value || '',
                    street: document.getElementById('new-company-street').value || '',
                    postal_code: document.getElementById('new-company-plz').value || ''
                });

                // Hide form
                newCompanyForm.classList.add('hidden');
                showNewForm = false;
                newCompanyBtn.classList.add('bg-green-600', 'hover:bg-green-500');
                newCompanyBtn.classList.remove('bg-gray-400');

                // Clear form
                document.getElementById('new-company-name').value = '';
                document.getElementById('new-company-city').value = '';
                document.getElementById('new-company-plz').value = '';
                document.getElementById('new-company-street').value = '';
            } else {
                showToast('Fehler: ' + (data.detail || 'Unbekannt'), 'error');
            }
            createCompanyBtn.textContent = 'Unternehmen erstellen';
            createCompanyBtn.disabled = false;
        })
        .catch(function(e) {
            showToast('Netzwerkfehler', 'error');
            createCompanyBtn.textContent = 'Unternehmen erstellen';
            createCompanyBtn.disabled = false;
        });
    });

    // ========== Submit ==========

    function updateSubmitButton() {
        var position = document.getElementById('job-position').value.trim();
        if (selectedCompanyName && position) {
            submitBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
            submitBtn.classList.add('bg-primary-600', 'hover:bg-primary-500');
            submitBtn.disabled = false;
        } else {
            submitBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
            submitBtn.classList.remove('bg-primary-600', 'hover:bg-primary-500');
            submitBtn.disabled = true;
        }
    }

    document.getElementById('job-position').addEventListener('input', updateSubmitButton);

    submitBtn.addEventListener('click', function() {
        var position = document.getElementById('job-position').value.trim();
        if (!selectedCompanyName || !position) {
            showToast('Bitte Unternehmen und Position ausfuellen', 'error');
            return;
        }

        submitBtn.textContent = 'Erstelle...';
        submitBtn.disabled = true;

        var payload = {
            company_name: selectedCompanyName,
            position: position,
            city: document.getElementById('job-city').value || null,
            street_address: document.getElementById('job-street').value || null,
            postal_code: document.getElementById('job-plz').value || null,
            job_text: document.getElementById('job-text').value || null,
            industry: document.getElementById('job-industry').value || null,
            employment_type: document.getElementById('job-employment-type').value || null
        };

        if (selectedCompanyId) {
            payload.company_id = selectedCompanyId;
        }

        fetch('/api/jobs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.id) {
                showToast('Job erstellt', 'success');
                closeModal();
                if (typeof htmx !== 'undefined') {
                    htmx.ajax('GET', '/partials/jobs-list?per_page=20', {target: '#jobs-content', swap: 'innerHTML'});
                }
            } else {
                showToast('Fehler: ' + (data.detail || 'Unbekannt'), 'error');
                submitBtn.textContent = 'Job erstellen';
                submitBtn.disabled = false;
            }
        })
        .catch(function(e) {
            showToast('Netzwerkfehler', 'error');
            submitBtn.textContent = 'Job erstellen';
            submitBtn.disabled = false;
        });
    });

    // ========== Helpers ==========

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;');
    }
})();
</script>
