<!-- Quick-Add Aufgabe (Slide-Over) -->
<div x-data="aufgabeForm()" x-init="init()" class="p-6 space-y-5">

    <!-- Datum -->
    <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Fälligkeitsdatum</label>
        <input type="date" x-model="form.due_date"
               style="padding:10px 14px;font-size:15px;height:44px;font-family:var(--pp-ff);"
               class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
    </div>

    <!-- Titel -->
    <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Titel *</label>
        <input type="text" x-model="form.title" placeholder="Was ist zu tun?"
               style="padding:10px 14px;font-size:15px;height:44px;font-family:var(--pp-ff);"
               class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
    </div>

    <!-- Beschreibung -->
    <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Beschreibung</label>
        <textarea x-model="form.description" rows="3" placeholder="Weitere Details zur Aufgabe..."
                  style="padding:10px 14px;font-size:14px;font-family:var(--pp-ff);"
                  class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"></textarea>
    </div>

    <!-- Prioritaet -->
    <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Priorität</label>
        <select x-model="form.priority"
                style="padding:10px 14px;font-size:15px;height:44px;font-family:var(--pp-ff);"
                class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
            <option value="unwichtig">Unwichtig</option>
            <option value="mittelmaessig">Mittelmäßig</option>
            <option value="wichtig">Wichtig</option>
            <option value="dringend">Dringend</option>
            <option value="sehr_dringend">Sehr dringend</option>
        </select>
    </div>

    <!-- Verknuepfungen -->
    <fieldset class="space-y-4 pt-2">
        <legend class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m9.868-1.242a4.5 4.5 0 00-1.242-7.244l-4.5-4.5a4.5 4.5 0 00-6.364 6.364L4.25 8.497" /></svg>
            Verknüpfungen
        </legend>

        <!-- Unternehmen -->
        <div class="relative">
            <label class="block text-xs font-medium text-gray-600 mb-1">Unternehmen</label>
            <template x-if="!form.company_id">
                <div>
                    <input type="text" x-model="companySearch" @input="debounceSearch('company')"
                           @focus="if (companyResults.length) showCompanyDD = true"
                           placeholder="Unternehmen suchen..."
                           style="padding:10px 14px;font-size:14px;height:42px;font-family:var(--pp-ff);"
                           class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    <div x-show="showCompanyDD" @click.away="showCompanyDD = false"
                         class="absolute z-10 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 max-h-48 overflow-y-auto">
                        <template x-for="c in companyResults" :key="c.id">
                            <button @click="selectItem('company', c)" type="button"
                                    class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 flex items-center gap-2">
                                <span class="font-medium" x-text="c.name"></span>
                                <span class="text-xs text-gray-400" x-text="c.city || ''"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </template>
            <template x-if="form.company_id">
                <div class="inline-flex items-center gap-1.5 bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg text-sm font-medium">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5M3.75 3v18h16.5V3H3.75z" /></svg>
                    <span x-text="selectedCompanyName"></span>
                    <button @click="clearItem('company')" type="button" class="ml-1 text-emerald-400 hover:text-emerald-600">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </template>
        </div>

        <!-- Kontakt -->
        <div class="relative">
            <label class="block text-xs font-medium text-gray-600 mb-1">Kontakt</label>
            <template x-if="!form.contact_id">
                <div>
                    <input type="text" x-model="contactSearch" @input="debounceSearch('contact')"
                           @focus="if (contactResults.length) showContactDD = true"
                           placeholder="Kontakt suchen..."
                           style="padding:10px 14px;font-size:14px;height:42px;font-family:var(--pp-ff);"
                           class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    <div x-show="showContactDD" @click.away="showContactDD = false"
                         class="absolute z-10 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 max-h-48 overflow-y-auto">
                        <template x-for="c in contactResults" :key="c.id">
                            <button @click="selectItem('contact', c); if (c.company_id && !form.company_id) { form.company_id = c.company_id; selectedCompanyName = c.company_name || ''; }" type="button"
                                    class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">
                                <div class="font-medium" x-text="c.name"></div>
                                <div class="text-xs text-gray-400" x-text="(c.position || '') + (c.company_name ? ' — ' + c.company_name : '')"></div>
                            </button>
                        </template>
                    </div>
                </div>
            </template>
            <template x-if="form.contact_id">
                <div class="inline-flex items-center gap-1.5 bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg text-sm font-medium">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0" /></svg>
                    <span x-text="selectedContactName"></span>
                    <button @click="clearItem('contact')" type="button" class="ml-1 text-blue-400 hover:text-blue-600">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </template>
        </div>

        <!-- Kandidat -->
        <div class="relative">
            <label class="block text-xs font-medium text-gray-600 mb-1">Kandidat</label>
            <template x-if="!form.candidate_id">
                <div>
                    <input type="text" x-model="candidateSearch" @input="debounceSearch('candidate')"
                           @focus="if (candidateResults.length) showCandidateDD = true"
                           placeholder="Kandidat suchen..."
                           style="padding:10px 14px;font-size:14px;height:42px;font-family:var(--pp-ff);"
                           class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    <div x-show="showCandidateDD" @click.away="showCandidateDD = false"
                         class="absolute z-10 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 max-h-48 overflow-y-auto">
                        <template x-for="c in candidateResults" :key="c.id">
                            <button @click="selectItem('candidate', c)" type="button"
                                    class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">
                                <div class="font-medium" x-text="c.name"></div>
                                <div class="text-xs text-gray-400" x-text="(c.position || '') + (c.city ? ' — ' + c.city : '')"></div>
                            </button>
                        </template>
                    </div>
                </div>
            </template>
            <template x-if="form.candidate_id">
                <div class="inline-flex items-center gap-1.5 bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg text-sm font-medium">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0" /></svg>
                    <span x-text="selectedCandidateName"></span>
                    <button @click="clearItem('candidate')" type="button" class="ml-1 text-indigo-400 hover:text-indigo-600">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </template>
        </div>

        <!-- Stelle -->
        <div class="relative">
            <label class="block text-xs font-medium text-gray-600 mb-1">Stelle</label>
            <template x-if="!form.ats_job_id">
                <div>
                    <input type="text" x-model="jobSearch" @input="debounceSearch('job')"
                           @focus="if (jobResults.length) showJobDD = true"
                           placeholder="Stelle suchen..."
                           style="padding:10px 14px;font-size:14px;height:42px;font-family:var(--pp-ff);"
                           class="w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    <div x-show="showJobDD" @click.away="showJobDD = false"
                         class="absolute z-10 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 max-h-48 overflow-y-auto">
                        <template x-for="j in jobResults" :key="j.id">
                            <button @click="selectItem('job', j)" type="button"
                                    class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">
                                <div class="font-medium" x-text="j.title"></div>
                                <div class="text-xs text-gray-400" x-text="(j.company_name || '') + (j.location_city ? ' — ' + j.location_city : '')"></div>
                            </button>
                        </template>
                    </div>
                </div>
            </template>
            <template x-if="form.ats_job_id">
                <div class="inline-flex items-center gap-1.5 bg-purple-50 text-purple-700 px-3 py-1.5 rounded-lg text-sm font-medium">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    <span x-text="selectedJobName"></span>
                    <button @click="clearItem('job')" type="button" class="ml-1 text-purple-400 hover:text-purple-600">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </template>
        </div>
    </fieldset>

    <!-- Buttons -->
    <div class="pt-4 border-t border-gray-200 flex gap-3">
        <button @click="save()" type="button"
                :disabled="saving"
                style="padding:12px 20px;font-size:15px;font-weight:600;font-family:var(--pp-ff);border-radius:12px;border:none;cursor:pointer;background:var(--pp-blue);color:#fff;flex:1;display:flex;align-items:center;justify-content:center;gap:8px;"
                :style="saving ? 'opacity:0.6;cursor:not-allowed;' : ''"
                onmouseover="if(!this.disabled) this.style.opacity='0.9'" onmouseout="if(!this.disabled) this.style.opacity='1'">
            <span x-show="!saving" class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                Aufgabe erstellen
            </span>
            <span x-show="saving" class="flex items-center gap-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                Wird erstellt...
            </span>
        </button>
        <button @click="closeQuickAdd()" type="button"
                style="padding:12px 20px;font-size:15px;font-weight:500;font-family:var(--pp-ff);border-radius:12px;border:1px solid #d1d5db;cursor:pointer;background:#fff;color:#374151;"
                onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#fff'">
            Abbrechen
        </button>
    </div>
</div>

<script>
document.addEventListener('alpine:init', function() {
    if (Alpine.data && !Alpine._aufgabeFormRegistered) {
        Alpine._aufgabeFormRegistered = true;
    }
});

// Alpine component als globale Funktion registrieren
window.aufgabeForm = function() {
    return {
        saving: false,
        form: {
            title: '',
            description: '',
            priority: 'wichtig',
            due_date: '',
            company_id: null,
            contact_id: null,
            candidate_id: null,
            ats_job_id: null,
        },

        selectedCompanyName: '',
        selectedContactName: '',
        selectedCandidateName: '',
        selectedJobName: '',

        companySearch: '', companyResults: [], showCompanyDD: false,
        contactSearch: '', contactResults: [], showContactDD: false,
        candidateSearch: '', candidateResults: [], showCandidateDD: false,
        jobSearch: '', jobResults: [], showJobDD: false,
        _t: null,

        init() {
            // Prefill-Werte aus data-Attributen lesen
            var el = this.$el;
            var prefillCompanyId = '{{ prefill_company.id if prefill_company else "" }}';
            var prefillCompanyName = '{{ prefill_company.name if prefill_company else "" }}';
            var prefillContactId = '{{ prefill_contact.id if prefill_contact else "" }}';
            var prefillContactName = '{{ prefill_contact.full_name if prefill_contact else "" }}';
            var prefillCandidateId = '{{ prefill_candidate.id if prefill_candidate else "" }}';
            var prefillCandidateName = '{{ ((prefill_candidate.first_name or "") + " " + (prefill_candidate.last_name or "")) if prefill_candidate else "" }}'.trim();
            var prefillJobId = '{{ prefill_job.id if prefill_job else "" }}';
            var prefillJobName = '{{ prefill_job.title if prefill_job else "" }}';

            if (prefillCompanyId) { this.form.company_id = prefillCompanyId; this.selectedCompanyName = prefillCompanyName; }
            if (prefillContactId) { this.form.contact_id = prefillContactId; this.selectedContactName = prefillContactName; }
            if (prefillCandidateId) { this.form.candidate_id = prefillCandidateId; this.selectedCandidateName = prefillCandidateName; }
            if (prefillJobId) { this.form.ats_job_id = prefillJobId; this.selectedJobName = prefillJobName; }
        },

        async doSearch(type, query) {
            if (query.length < 2) return [];
            var urls = {
                company: '/api/companies/search/json?q=',
                contact: '/api/companies/contacts/search/json?q=',
                candidate: '/api/candidates/search?q=',
                job: '/api/ats/jobs/search/json?q=',
            };
            try {
                var res = await fetch(urls[type] + encodeURIComponent(query) + '&limit=8');
                if (res.ok) return await res.json();
            } catch (e) { /* silent */ }
            return [];
        },

        debounceSearch(type) {
            clearTimeout(this._t);
            var q = this[type + 'Search'];
            if (q.length < 2) {
                this[type + 'Results'] = [];
                this['show' + type.charAt(0).toUpperCase() + type.slice(1) + 'DD'] = false;
                return;
            }
            var self = this;
            this._t = setTimeout(async function() {
                var ddKey = 'show' + type.charAt(0).toUpperCase() + type.slice(1) + 'DD';
                self[type + 'Results'] = await self.doSearch(type, q);
                self[ddKey] = self[type + 'Results'].length > 0;
            }, 300);
        },

        selectItem(type, item) {
            var idKey = type === 'job' ? 'ats_job_id' : type + '_id';
            this.form[idKey] = item.id;
            var nameKey = 'selected' + type.charAt(0).toUpperCase() + type.slice(1) + 'Name';
            this[nameKey] = item.name || item.title || '';
            this[type + 'Search'] = '';
            this[type + 'Results'] = [];
            var ddKey = 'show' + type.charAt(0).toUpperCase() + type.slice(1) + 'DD';
            this[ddKey] = false;
        },

        clearItem(type) {
            var idKey = type === 'job' ? 'ats_job_id' : type + '_id';
            this.form[idKey] = null;
            var nameKey = 'selected' + type.charAt(0).toUpperCase() + type.slice(1) + 'Name';
            this[nameKey] = '';
        },

        async save() {
            if (!this.form.title || !this.form.title.trim()) {
                if (window.showToast) showToast('Bitte Titel eingeben', 'warning');
                return;
            }
            this.saving = true;

            var payload = {
                title: this.form.title.trim(),
                description: (this.form.description && this.form.description.trim()) || null,
                priority: this.form.priority || 'wichtig',
                due_date: this.form.due_date || null,
                company_id: this.form.company_id || null,
                contact_id: this.form.contact_id || null,
                candidate_id: this.form.candidate_id || null,
                ats_job_id: this.form.ats_job_id || null,
            };

            try {
                var res = await fetch('/api/ats/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    var err = null;
                    try { err = await res.json(); } catch(e) {}
                    throw new Error((err && err.detail) ? err.detail : 'HTTP ' + res.status);
                }
                if (window.showToast) showToast('Aufgabe erstellt', 'success');
                closeQuickAdd();
                // Todos-Container auf der aktuellen Seite neu laden
                var todosEl = document.getElementById('todos-container');
                if (todosEl && window.htmx) {
                    htmx.trigger(todosEl, 'load');
                }
            } catch (err) {
                if (window.showToast) showToast('Fehler: ' + err.message, 'error');
                this.saving = false;
            }
        }
    };
};
</script>
