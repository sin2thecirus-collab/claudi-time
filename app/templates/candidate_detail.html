{%- extends "base.html" -%}
{%- block title -%}
{% set _t_first = candidate.first_name or '' %}{% set _t_last = candidate.last_name or '' %}{% set _t_inv = ['not available','n/a','na','none','null','-','\u2014',''] %}{% set _t_f = _t_first if _t_first|lower|trim not in _t_inv else '' %}{% set _t_l = _t_last if _t_last|lower|trim not in _t_inv else '' %}{% set _t_name = ((_t_f ~ ' ' ~ _t_l)|trim) if (_t_f or _t_l) else 'Unbekannt' %}{{ _t_name }} - Pulspoint
{%- endblock -%}

{% block head %}
<style>
    .kd-wrap { background: var(--pp-bg); color: var(--pp-text); font-size: 15px; overflow-x: hidden; max-width: 100vw; }
    .kd-wrap ::-webkit-scrollbar { width: 5px; }
    .kd-wrap ::-webkit-scrollbar-track { background: transparent; }
    .kd-wrap ::-webkit-scrollbar-thumb { background: var(--pp-border); border-radius: 3px; }

    @keyframes kdFadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    @keyframes kdSlideIn { from { opacity:0; transform:translateX(12px); } to { opacity:1; transform:translateX(0); } }
    .kd-anim { opacity:0; animation: kdFadeUp 0.5s cubic-bezier(0.16,1,0.3,1) forwards; }
    .kd-anim-side { opacity:0; animation: kdSlideIn 0.5s cubic-bezier(0.16,1,0.3,1) forwards; }

    .kd-section {
        background: var(--pp-surface); border-radius: 12px;
        border: 1px solid var(--pp-border); overflow: hidden;
        transition: border-color 0.3s, box-shadow 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .kd-section:hover { border-color: var(--pp-accentGlow); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .kd-section-header {
        display:flex; align-items:center; justify-content:space-between;
        padding: 16px 24px 12px; border-bottom: 1px solid var(--pp-borderLight);
    }
    .kd-section-title { display:flex; align-items:center; gap:10px; font-size:15px; font-weight:700; color:var(--pp-text); }
    .kd-section-title span { font-size:17px; }
    .kd-section-body { padding: 16px 24px; }

    .kd-sidebar-card {
        background: var(--pp-surface); border-radius: 12px;
        border: 1px solid var(--pp-border); overflow: hidden;
        transition: border-color 0.3s;
    }
    .kd-sidebar-card:hover { border-color: var(--pp-accentSoft); }
    .kd-sidebar-header {
        padding: 12px 16px; border-bottom: 1px solid var(--pp-borderLight);
        display:flex; align-items:center; justify-content:space-between;
        font-size:14px; font-weight:700; color:var(--pp-text);
    }
    .kd-sidebar-body { padding: 14px 16px; }

    .kd-sticky-header {
        background: var(--pp-surface);
        border-bottom: 1px solid var(--pp-border);
        padding: 0 32px; position: sticky; top: 0; z-index: 100;
        overflow-x: auto; overflow-y: hidden; max-width: 100vw;
    }

    .kd-tab-btn {
        padding: 8px 14px; background:none; border:none;
        font-size:13px; font-weight:500; cursor:pointer;
        display:flex; align-items:center; gap:8px;
        border-bottom: 2px solid transparent;
        transition: all 0.1s ease; color: var(--pp-textDim); font-family: var(--pp-ff);
    }
    .kd-tab-btn:hover { color: var(--pp-textMuted); background: var(--pp-surfaceHover); border-radius: 6px 6px 0 0; }
    .kd-tab-btn.active { color: var(--pp-text); font-weight:600; border-bottom-color: var(--pp-accent); }

    .kd-quickbtn {
        display:inline-flex; align-items:center; gap:5px;
        padding: 7px 16px; border-radius:8px; font-size:12.5px; font-weight:600;
        cursor:pointer; font-family:inherit; transition: all 0.2s ease;
        border: 1px solid var(--pp-border); background: var(--pp-surfaceHover); color:var(--pp-textMuted);
    }
    .kd-quickbtn:hover { background:var(--pp-surface3); transform:translateY(-1px); }
    .kd-quickbtn-primary { background:var(--pp-green); color:#fff; border:none; font-weight:700; }
    .kd-quickbtn-primary:hover { opacity:0.9; }
    .kd-quickbtn-accent { background:var(--pp-accentSoft); color:var(--pp-accent); border:1px solid var(--pp-accentGlow); }
    .kd-quickbtn-accent:hover { background:rgba(59,130,246,0.15); }
    .kd-quickbtn-danger { background:var(--pp-redSoft); color:var(--pp-red); border:1px solid rgba(239,68,68,0.2); }
    .kd-quickbtn-danger:hover { background:rgba(239,68,68,0.12); }

    .kd-quickglance {
        background: var(--pp-surface);
        border-radius:12px; padding:6px; border:1px solid var(--pp-border);
        display:grid; grid-template-columns:1fr 1fr; gap:6px;
    }
    .kd-quickglance-item { display:flex; align-items:center; gap:14px; padding:16px 20px; border-radius:10px; background:var(--pp-bg); }
    .kd-quickglance-icon { font-size:26px; flex-shrink:0; }
    .kd-quickglance-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--pp-textMuted); margin-bottom:3px; }
    .kd-quickglance-value { font-size:16px; font-weight:700; white-space:nowrap; }

    .kd-exp-dot-current { width:12px; height:12px; border-radius:50%; flex-shrink:0; background:var(--pp-accent); border:2px solid var(--pp-accentGlow); }
    .kd-exp-dot-past { width:12px; height:12px; border-radius:50%; flex-shrink:0; background:var(--pp-border); border:2px solid var(--pp-text4); }
    .kd-exp-line { width:2px; flex:1; margin-top:6px; background:linear-gradient(to bottom, var(--pp-accentGlow), var(--pp-border), transparent); }
    .kd-lang-bar { height:8px; border-radius:4px; overflow:hidden; background:var(--pp-surfaceHover); }
    .kd-lang-fill { height:100%; border-radius:4px; transition: width 0.6s ease; }

    .skill-fach { background:var(--pp-purpleSoft); color:var(--pp-purple); border:1px solid rgba(167,139,250,0.3); }
    .skill-tech { background:var(--pp-greenSoft); color:var(--pp-green); border:1px solid rgba(34,197,94,0.3); }
    .skill-soft { background:var(--pp-orangeSoft); color:var(--pp-orange); border:1px solid rgba(234,179,8,0.3); }

    .kd-meta-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 8px; border-radius:6px; font-size:13px; font-weight:500; color:var(--pp-textMuted); }
    .kd-field-label { font-size:11px !important; font-weight:700 !important; text-transform:uppercase; letter-spacing:1.2px; color:var(--pp-textMuted) !important; margin-bottom:8px; display:flex; align-items:center; gap:6px; }

    .kd-badge { display:inline-flex; align-items:center; padding:4px 12px; border-radius:12px; font-size:13px; font-weight:600; letter-spacing:0.2px; white-space:nowrap; }
    .kd-badge-green { background:var(--pp-greenSoft); border:1px solid rgba(34,197,94,0.3); color:var(--pp-green); }
    .kd-badge-cyan { background:var(--pp-accentSoft); border:1px solid var(--pp-accentGlow); color:var(--pp-accent); }
    .kd-badge-orange { background:var(--pp-orangeSoft); border:1px solid rgba(234,179,8,0.25); color:var(--pp-orange); }
    .kd-badge-purple { background:var(--pp-purpleSoft); border:1px solid rgba(167,139,250,0.3); color:var(--pp-purple); }
    .kd-badge-blue { background:var(--pp-accentSoft); border:1px solid var(--pp-accentGlow); color:var(--pp-accent); }
    .kd-badge-gray { background:rgba(113,113,122,0.10); border:1px solid rgba(113,113,122,0.25); color:var(--pp-textMuted); }

    .kd-wrap .detail-edit-display { cursor:pointer; border-radius:6px; padding:2px 6px; transition:all 0.2s; }
    .kd-wrap .detail-edit-display:hover { background:var(--pp-accentSoft); }
    .kd-wrap .detail-edit-input { font-family:inherit; border-radius:8px; }
    .kd-wrap input:focus, .kd-wrap textarea:focus, .kd-wrap select:focus {
        border-color:var(--pp-accent) !important; box-shadow:0 0 0 3px var(--pp-accentSoft) !important; outline:none !important;
    }
    .kd-wrap { animation: kdFadeUp 0.4s cubic-bezier(0.16,1,0.3,1) forwards; }

    .kd-copy-btn {
        display: inline-flex; align-items: center; justify-content: center;
        width: 26px; height: 26px; flex-shrink: 0; border-radius: 6px;
        border: 1px solid var(--pp-border); background: var(--pp-surfaceHover);
        cursor: pointer; transition: all 0.2s ease; padding: 0; color: var(--pp-textMuted);
    }
    .kd-copy-btn svg { width: 14px; height: 14px; }
    .kd-copy-btn:hover { background: var(--pp-accentSoft); border-color: var(--pp-accentGlow); color: var(--pp-accent); }
    .kd-copy-btn.copied { background: var(--pp-greenSoft); border-color: rgba(34,197,94,0.3); color: var(--pp-green); }
</style>
{% endblock %}

{% block content %}
{# ── Data Quality: Invalid-Name-Filterung + Normalisierung ── #}
{% set invalid_names = ['not available', 'n/a', 'na', 'none', 'null', '-', '—', ''] %}
{% set raw_first = candidate.first_name or '' %}
{% set raw_last = candidate.last_name or '' %}
{% set first_valid = raw_first if raw_first | lower | trim not in invalid_names else '' %}
{% set last_valid = raw_last if raw_last | lower | trim not in invalid_names else '' %}
{# ALL CAPS → Title Case (ohne if/else wg. Jinja2 Scoping) #}
{% set first_display = (first_valid | title) if (first_valid == first_valid | upper and first_valid | length > 1) else first_valid %}
{% set last_display = (last_valid | title) if (last_valid == last_valid | upper and last_valid | length > 1) else last_valid %}
{% set has_valid_name = first_display or last_display %}
{% set display_name = ((first_display ~ ' ' ~ last_display) | trim) if has_valid_name else 'Unbekannt' %}
{% set raw_position = candidate.current_position or '' %}
{% set position_invalid = raw_position | lower | trim in (invalid_names + ['keine position angegeben']) %}
{% set position_display = '' if position_invalid else raw_position %}
{% set raw_company = candidate.current_company or '' %}
{% set company_invalid = raw_company | lower | trim in (invalid_names + ['kein unternehmen']) %}
{% set company_display = '' if company_invalid else raw_company %}
{% set raw_city = candidate.city or '' %}
{% set city_invalid = raw_city | lower | trim in (invalid_names + ['keine adresse']) %}
{% set city_display = '' if city_invalid else raw_city %}
{# ── End Data Quality ── #}

<div class="kd-wrap min-h-screen" x-data="{ activeTab: 'uebersicht', showPipelineModal: false, pipelineStatus: '{{ candidate.pipeline_status or 'new' }}' }">

    {# ── Sticky Header ── #}
    <div class="kd-sticky-header">
        {# Row 1: Action buttons #}
        <div style="display:flex; align-items:center; justify-content:space-between; padding:16px 0 8px; flex-wrap:wrap; gap:8px;">
            <a href="/kandidaten" class="kd-quickbtn" style="text-decoration:none;">&#x2190; Zur&uuml;ck</a>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                {% if candidate.cv_url or candidate.cv_stored_path %}
                <button type="button" onclick="openCvPreview()" class="kd-quickbtn kd-quickbtn-accent">&#x1F4C4; CV ansehen</button>
                {% endif %}
                <a href="/api/candidates/{{ candidate.id }}/profile-pdf" target="_blank" class="kd-quickbtn kd-quickbtn-accent" style="text-decoration:none;" title="{% if candidate.profile_pdf_generated_at %}Zuletzt: {{ candidate.profile_pdf_generated_at.strftime('%d.%m.%Y %H:%M') }}{% else %}Wird beim Klick generiert{% endif %}">&#x1F4CA; Profil-PDF{% if candidate.profile_pdf_r2_key %} &#x2713;{% endif %}</a>
                <button type="button" onclick="regenerateProfilePdf('{{ candidate.id }}')" class="kd-quickbtn" style="background:linear-gradient(135deg, rgba(11,137,189,0.15), rgba(16,181,240,0.15)); color:#0b89bd; border:1px solid rgba(11,137,189,0.3); font-weight:600;" title="Profil-PDF mit aktuellen Daten neu generieren" id="btn-regenerate-pdf">&#x1F504; Profil neu generieren</button>
                <button type="button" onclick="triggerNichtErreicht('{{ candidate.id }}')" class="kd-quickbtn" style="background:var(--pp-orangeSoft); color:var(--pp-orange); border:1px solid rgba(234,179,8,0.25);" id="btn-nicht-erreicht" title="E-Mail-Sequenz starten (3 Emails &uuml;ber 5 Tage)">&#x1F4E7; Nicht erreicht</button>
                <button type="button" @click="showPipelineModal = true" class="kd-quickbtn kd-quickbtn-primary">&#x1F680; Pipeline</button>
                <button type="button" onclick="findJobsForCandidate('{{ candidate.id }}')" class="kd-quickbtn" style="background:var(--pp-accentSoft); color:var(--pp-accent); border:1px solid rgba(99,102,241,0.25);" id="btn-jobs-finden" title="Claude Matching: Passende Jobs fuer diesen Kandidaten finden">&#x1F50D; Jobs finden</button>
                <button type="button" onclick="deleteCandidate('{{ candidate.id }}', '{{ display_name }}')" class="kd-quickbtn kd-quickbtn-danger">&#x1F5D1;</button>
            </div>
        </div>

        {# Row 2: Name + Badges #}
        <div style="display:flex; align-items:center; gap:16px; padding-bottom:8px;">
            {# Avatar #}
            <div style="width:56px; height:56px; border-radius:50%; background:var(--pp-accent); display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; color:#fff; flex-shrink:0;">
                {{ display_name[0]|upper if display_name else '?' }}
            </div>
            <div style="flex:1; min-width:0;">
                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <h1 style="font-size:24px; font-weight:800; color:var(--pp-text); margin:0; letter-spacing:-0.02em;">{{ display_name }}</h1>
                    {% if candidate.willingness_to_change == 'ja' %}
                    <span class="kd-badge kd-badge-green">&#x2705; Wechselbereit</span>
                    {% elif candidate.willingness_to_change == 'nein' %}
                    <span class="kd-badge kd-badge-gray">Nicht wechselbereit</span>
                    {% endif %}
                    {% if candidate.employment_type %}
                    <span class="kd-badge kd-badge-cyan">{{ candidate.employment_type }}</span>
                    {% endif %}
                    {% if candidate.rating %}
                    <span class="kd-badge kd-badge-orange">&#x2B50; {{ candidate.rating }}/5</span>
                    {% endif %}
                </div>
                <div style="display:flex; align-items:center; gap:12px; margin-top:4px; flex-wrap:wrap;">
                    {% if candidate.current_position and candidate.current_position not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}
                    <span class="kd-meta-badge">&#x1F4BC; {{ candidate.current_position }}</span>
                    {% endif %}
                    {% if candidate.current_company and candidate.current_company not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}
                    <span class="kd-meta-badge">&#x1F3E2; {{ candidate.current_company }}</span>
                    {% endif %}
                    {% set _addr_parts = [] %}
                    {% if candidate.street_address and candidate.street_address not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}{% set _ = _addr_parts.append(candidate.street_address) %}{% endif %}
                    {% if candidate.postal_code and candidate.postal_code not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}{% set _ = _addr_parts.append(candidate.postal_code) %}{% endif %}
                    {% if candidate.city and candidate.city not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}{% set _ = _addr_parts.append(candidate.city) %}{% endif %}
                    {% if _addr_parts %}
                    <span class="kd-meta-badge" style="cursor:pointer;" onclick="navigator.clipboard.writeText(this.querySelector('.addr-text').textContent.trim()).then(function(){showToast('Adresse kopiert','success')})">&#x1F4CD; <span class="addr-text">{{ _addr_parts | join(', ') }}</span> <svg style="display:inline; vertical-align:middle; opacity:0.4; margin-left:2px;" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></span>
                    {% endif %}
                    <span class="kd-meta-badge">&#x1F382; {% if candidate.birth_date %}{{ candidate.birth_date.strftime('%d.%m.%Y') }} ({{ candidate.age }} J.){% else %}/{% endif %}</span>
                </div>
            </div>
        </div>

        {# Row 3: Tabs #}
        
    {# ── Tab Navigation ── #}
    <div style="display:flex; gap:0; border-top:1px solid var(--pp-borderLight); margin-top:4px; overflow-x:auto; -webkit-overflow-scrolling:touch;">
        <button type="button" @click="activeTab = 'uebersicht'" class="kd-tab-btn" :class="activeTab === 'uebersicht' ? 'active' : ''" style="white-space:nowrap;">
            <span>&#x1F4CB;</span> &Uuml;bersicht
        </button>
        <button type="button" @click="activeTab = 'qualifizierung'" class="kd-tab-btn" :class="activeTab === 'qualifizierung' ? 'active' : ''">
            <span>&#x1F4DE;</span> Qualifizierung
        </button>
        <button type="button" @click="activeTab = 'profil'" class="kd-tab-btn" :class="activeTab === 'profil' ? 'active' : ''">
            <span>&#x1F4BC;</span> Profil &amp; CV
        </button>
        <button type="button" @click="activeTab = 'gespraeche'" class="kd-tab-btn" :class="activeTab === 'gespraeche' ? 'active' : ''">
            <span>&#x1F3A4;</span> Gespr&auml;che
        </button>
        <button type="button" @click="activeTab = 'aufgaben'" class="kd-tab-btn" :class="activeTab === 'aufgaben' ? 'active' : ''">
            <span>&#x2705;</span> Aufgaben
            {% if todos and todos | length > 0 %}
            <span style="font-size:11px;font-weight:700;background:var(--pp-green);color:#000;padding:1px 7px;border-radius:99px;margin-left:4px;">{{ todos | length }}</span>
            {% endif %}
            {% set pending_drafts = (email_drafts_json or []) | selectattr('status', 'equalto', 'draft') | list %}
            {% if pending_drafts | length > 0 %}
            <span style="font-size:11px;font-weight:700;background:var(--pp-orange);color:#000;padding:1px 7px;border-radius:99px;margin-left:2px;" title="Offene Email-Entw&uuml;rfe">&#x2709; {{ pending_drafts | length }}</span>
            {% endif %}
        </button>
        <button type="button" @click="activeTab = 'emails'" class="kd-tab-btn" :class="activeTab === 'emails' ? 'active' : ''">
            <span>&#x1F4E8;</span> E-Mails
            {% if seq_emails_json and seq_emails_json | length > 0 %}
            <span style="font-size:11px;font-weight:700;background:var(--pp-accentSoft);color:var(--pp-accent);padding:1px 7px;border-radius:99px;margin-left:4px;">{{ seq_emails_json | length }}</span>
            {% endif %}
        </button>
    </div>
    </div>

    {# ── Pipeline Modal ── #}
    <template x-if="showPipelineModal">
        <div style="position:fixed; inset:0; z-index:200; display:flex; align-items:center; justify-content:center;" @click.self="showPipelineModal = false">
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.7);"></div>
            <div style="position:relative; z-index:10; background:var(--pp-surface); border-radius:12px; border:1px solid var(--pp-border); padding:28px; width:420px; max-width:90vw; box-shadow:0 24px 48px rgba(0,0,0,0.4);">
                <h3 style="font-size:17px; font-weight:700; color:var(--pp-text); margin:0 0 20px;">Pipeline-Status &auml;ndern</h3>
                {% set pipeline_options = [
                    {"value": "new", "label": "Neu", "color": "#6366f1"},
                    {"value": "contacted", "label": "Kontaktiert", "color": "#3b82f6"},
                    {"value": "qualified", "label": "Qualifiziert", "color": "#10b981"},
                    {"value": "presented", "label": "Vorgestellt", "color": "#f59e0b"},
                    {"value": "interview", "label": "Interview", "color": "#8b5cf6"},
                    {"value": "offer", "label": "Angebot", "color": "#ef4444"},
                    {"value": "placed", "label": "Platziert", "color": "#22c55e"},
                    {"value": "rejected", "label": "Abgelehnt", "color": "#64748b"}
                ] %}
                <div style="display:flex; flex-direction:column; gap:6px;">
                    {% for opt in pipeline_options %}
                    <button type="button"
                        @click="pipelineStatus = '{{ opt.value }}'; fetch('/api/candidates/{{ candidate.id }}', {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({pipeline_status:'{{ opt.value }}'}) }).then(r => { if(r.ok) { showToast('Pipeline-Status aktualisiert','success'); showPipelineModal=false; } })"
                        class="w-full text-left py-3 px-4 rounded-xl text-sm font-semibold cursor-pointer transition-all duration-150"
                        :style="pipelineStatus === '{{ opt.value }}' ? 'background: {{ opt.color }}22; border: 2px solid {{ opt.color }}; color: {{ opt.color }};' : 'background: var(--pp-surfaceHover); border: 2px solid transparent; color: var(--pp-text);'"
                        style="font-family:inherit;"
                        onmouseenter="if(!this.style.borderColor || this.style.borderColor==='transparent') this.style.background='var(--pp-surfaceHover)'"
                        onmouseleave="if(!this.style.borderColor || this.style.borderColor==='transparent') this.style.background='var(--pp-surfaceHover)'">
                        <span style="display:inline-block; width:10px; height:10px; border-radius:50%; background:{{ opt.color }}; margin-right:10px;"></span>
                        {{ opt.label }}
                    </button>
                    {% endfor %}
                </div>
                <button type="button" @click="showPipelineModal = false" class="w-full mt-4 py-2.5 rounded-xl text-sm font-bold cursor-pointer" style="background:var(--pp-surfaceHover); border:1px solid var(--pp-border); color:var(--pp-textMuted); font-family:inherit;">Abbrechen</button>
            </div>
        </div>
    </template>

    {# ══════════════ CONTENT + SIDEBAR ══════════════ #}
    <div style="display:flex; gap:24px; padding:24px 32px 32px; max-width:1600px; margin:0 auto; overflow:hidden;">

        {# ── LEFT: Tab Content ── #}
        <div style="flex:1; min-width:0; overflow:hidden;">

            {# ═══ TAB: Übersicht ═══ #}
            <div x-show="activeTab === 'uebersicht'" x-cloak style="display:flex; flex-direction:column; gap:40px;">
                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 100ms;" id="contact">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4C7;</span> Kontaktdaten</div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 10px;">
                        {# Anrede #}
                        <div>
                            <div class="kd-field-label">Anrede</div>
                            <select onchange="saveGenderField(this, '{{ candidate.id }}')"
                                    style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-border); background: var(--pp-bg); color: var(--pp-text); font-family: inherit; cursor: pointer; width: 100%; min-height: 28px;">
                                <option value="" {% if not candidate.gender %}selected{% endif %}>—</option>
                                <option value="Herr" {% if candidate.gender == 'Herr' %}selected{% endif %}>Herr</option>
                                <option value="Frau" {% if candidate.gender == 'Frau' %}selected{% endif %}>Frau</option>
                            </select>
                        </div>
                        {# Vorname #}
                        <div>
                            <div class="kd-field-label">Vorname</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="first_name">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Vorname bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if first_display %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not first_display %}font-style: italic;{% endif %} cursor: pointer;">{{ first_display or 'Vorname' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.first_name or '' }}" placeholder="Vorname" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Nachname #}
                        <div>
                            <div class="kd-field-label">Nachname</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="last_name">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Nachname bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if last_display %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not last_display %}font-style: italic;{% endif %} cursor: pointer;">{{ last_display or 'Nachname' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.last_name or '' }}" placeholder="Nachname" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        {# Email #}
                        <div>
                            <div class="kd-field-label">E-Mail</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="email" style="flex:1; min-width:0;">
                                    <span class="detail-edit-display" onclick="startDetailEdit(this)" title="E-Mail bearbeiten" style="font-size: 13px; font-weight: 600; color: {% if candidate.email %}var(--pp-accent){% else %}var(--pp-textDim){% endif %}; {% if not candidate.email %}font-style: italic;{% endif %} cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display:block;">{{ candidate.email or 'Nicht angegeben' }}</span>
                                    <input type="email" class="detail-edit-input hidden" value="{{ candidate.email or '' }}" placeholder="email@beispiel.de" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                                </div>
                                {% if candidate.email %}
                                <button type="button" onclick="copyToClipboard('{{ candidate.email }}', 'E-Mail')" class="kd-copy-btn" title="E-Mail kopieren"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
                                {% endif %}
                            </div>
                        </div>
                        {# Phone #}
                        <div>
                            <div class="kd-field-label">Telefon</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="phone" style="flex:1; min-width:0;">
                                    <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Telefon bearbeiten" style="font-size: 13px; font-weight: 600; color: {% if candidate.phone %}var(--pp-accent){% else %}var(--pp-textDim){% endif %}; {% if not candidate.phone %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.phone or 'Nicht angegeben' }}</span>
                                    <input type="tel" class="detail-edit-input hidden" value="{{ candidate.phone or '' }}" placeholder="+49 170 1234567" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                                </div>
                                {% if candidate.phone %}
                                <a href="tel:{{ candidate.phone }}" class="kd-copy-btn" title="Anrufen" style="color: var(--pp-green);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></a>
                                <button type="button" onclick="copyToClipboard('{{ candidate.phone }}', 'Telefonnummer')" class="kd-copy-btn" title="Telefonnummer kopieren"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
                                {% endif %}
                            </div>
                        </div>
                        {# Position #}
                        <div>
                            <div class="kd-field-label">Position</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_position">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Position bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if position_display %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not position_display %}font-style: italic;{% endif %} cursor: pointer;">{{ position_display or 'Keine Position angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.current_position or '' }}" placeholder="z.B. Finanzbuchhalter" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        {# Strasse #}
                        <div>
                            <div class="kd-field-label">Strasse</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="street_address">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Strasse bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.street_address %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.street_address %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.street_address or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.street_address or '' }}" placeholder="z.B. Musterstr. 12" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# PLZ #}
                        <div>
                            <div class="kd-field-label">PLZ</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="postal_code">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="PLZ bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.postal_code %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.postal_code %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.postal_code or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.postal_code or '' }}" placeholder="z.B. 60311" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Stadt #}
                        <div>
                            <div class="kd-field-label">Stadt</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="city">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Stadt bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.city %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.city %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.city or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.city or '' }}" placeholder="z.B. Frankfurt am Main" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;">
                        {# Geburtsdatum #}
                        <div>
                            <div class="kd-field-label">Geburtsdatum</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="birth_date">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Geburtsdatum bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.birth_date %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.birth_date %}font-style: italic;{% endif %} cursor: pointer;">{% if candidate.birth_date %}{{ candidate.birth_date.strftime('%d.%m.%Y') }}{% else %}Nicht angegeben{% endif %}</span>
                                <input type="date" class="detail-edit-input hidden" value="{{ candidate.birth_date.isoformat() if candidate.birth_date else '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit; color-scheme: dark;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 150ms; overflow: visible;" id="recruiting-data"
                 x-data="recruitingFields()">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F50D;</span> Recruiting-Daten</div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        {# Quelle #}
                        <div>
                            <div class="kd-field-label">Quelle</div>
                            <div class="relative" @click.away="showSourceDropdown = false">
                                <button type="button" @click="showSourceDropdown = !showSourceDropdown"
                                    class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                    style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: {% if candidate.source %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.source %}font-style: italic;{% endif %}">
                                    <span class="block truncate" x-text="currentSource || 'Nicht angegeben'"></span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                        <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                    </span>
                                </button>
                                <div x-show="showSourceDropdown" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 220px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="src in sourceOptions" :key="src">
                                        <button type="button" @click="setSource(src)"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; border: none;"
                                            :style="currentSource === src ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                            @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                            @mouseleave="if (currentSource !== src) $el.style.background = 'none'"
                                            x-text="src"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        {# Wechselbereitschaft #}
                        <div>
                            <div class="kd-field-label">Wechselbereitschaft</div>
                            <div class="flex gap-2">
                                <button type="button" @click="setWillingness('ja')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="currentWillingness === 'ja' ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="currentWillingness !== 'ja' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="setWillingness('nein')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="currentWillingness === 'nein' ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="currentWillingness !== 'nein' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                                <button type="button" @click="setWillingness('unbekannt')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="currentWillingness === 'unbekannt' ? 'border-2 ring-1 ring-gray-400/30' : 'border-2 hover:border-gray-400/40 hover:text-gray-300'"
                                    :style="currentWillingness === 'unbekannt' ? 'background: var(--pp-surfaceHover); color: var(--pp-textMuted); border-color: var(--pp-textMuted);' : 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);'"
                                    style="font-family: inherit;">?</button>
                            </div>
                        </div>
                        {# Letzter Kontakt #}
                        <div>
                            <div class="kd-field-label">Letzter Kontakt</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <input type="date" x-model="lastContactDate" @change="setLastContact()"
                                    style="padding: 5px 8px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 12.5px; font-weight: 600; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; cursor: pointer; outline: none; color-scheme: dark;">
                                <button type="button" @click="setLastContactNow()" title="Auf heute setzen"
                                    style="padding: 5px 8px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 11px; font-weight: 650; cursor: pointer; font-family: inherit; white-space: nowrap;">Heute</button>
                            </div>
                        </div>
                    </div>
                    {# Notizen (einzelne Eintraege mit Datum) #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--pp-borderLight);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-size: 10px; color: var(--pp-textDim); font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em;">Notizen</div>
                            <button type="button" @click="showNewNote = !showNewNote"
                                class="py-1 px-3 rounded-lg cursor-pointer text-xs font-semibold"
                                style="background: var(--pp-accentSoft); color: var(--pp-accent); border: 1px solid var(--pp-accentGlow);">
                                <span x-text="showNewNote ? 'Abbrechen' : '+ Neue Notiz'"></span>
                            </button>
                        </div>

                        {# Neue Notiz Formular #}
                        <div x-show="showNewNote" x-collapse style="margin-bottom: 10px;">
                            <div style="background: var(--pp-surface); border: 1.5px solid var(--pp-border); border-radius: 10px; padding: 12px;">
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <input type="text" x-model="newNoteTitle" placeholder="Titel (optional)"
                                        class="w-full py-2 px-3 rounded-lg text-sm"
                                        style="background: var(--pp-bg); border: 1px solid var(--pp-border); color: var(--pp-text); font-family: inherit; outline: none; flex: 1;"
                                        @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                                    <input type="date" x-model="newNoteDate"
                                        class="py-2 px-3 rounded-lg text-sm"
                                        style="background: var(--pp-bg); border: 1px solid var(--pp-border); color: var(--pp-text); font-family: inherit; outline: none; color-scheme: dark; min-width: 140px;">
                                </div>
                                <textarea x-model="newNoteContent" placeholder="Notiz eingeben..."
                                    class="w-full py-2 px-3 rounded-lg text-sm"
                                    style="background: var(--pp-bg); border: 1px solid var(--pp-border); color: var(--pp-text); font-family: inherit; outline: none; resize: vertical; min-height: 80px; line-height: 1.6;"
                                    @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                                <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                                    <button type="button" @click="createNote()"
                                        class="py-2 px-4 rounded-lg cursor-pointer text-sm font-semibold"
                                        style="background: var(--pp-accent); color: #fff; border: none;"
                                        :style="newNoteContent.trim() ? '' : 'opacity: 0.4; cursor: not-allowed;'"
                                        :disabled="!newNoteContent.trim()">
                                        Notiz speichern
                                    </button>
                                </div>
                            </div>
                        </div>

                        {# Notizen-Liste (via HTMX Partial) #}
                        <div id="candidate-notes-list"
                             hx-get="/partials/candidate/{{ candidate.id }}/notes"
                             hx-trigger="load"
                             hx-target="#candidate-notes-list"
                             style="max-height: 400px; overflow-y: auto; border: 1px solid var(--pp-border); border-radius: 10px; background: var(--pp-surface);">
                            <p style="font-size:13px;color:var(--pp-textDim);padding:12px 14px;">Lade Notizen...</p>
                        </div>
                    </div>
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 250ms;" id="pipeline-data"
                 x-data="pipelineFields()">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F3AF;</span> Pipeline-Daten</div>
                    <span style="font-size: 10.5px; font-weight: 650; padding: 4px 10px; border-radius: 6px; background: var(--pp-surfaceHover); color: var(--pp-accent); border: 1px solid var(--pp-border);">F&uuml;r Pipeline</span>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        {# Gehalt #}
                        <div>
                            <div class="kd-field-label">Gehaltswunsch</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="salary">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Gehalt bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.salary %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.salary %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.salary or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.salary or '' }}" placeholder="z.B. 55.000 &euro;" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Kuendigungsfrist #}
                        <div>
                            <div class="kd-field-label">K&uuml;ndigungsfrist</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="notice_period">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="K&uuml;ndigungsfrist bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.notice_period %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.notice_period %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.notice_period or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.notice_period or '' }}" placeholder="z.B. 3 Monate" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Rating #}
                        <div>
                            <div class="kd-field-label">Bewertung</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="display: flex; gap: 3px;">
                                    {% for i in range(1, 6) %}
                                    <button type="button" @click="setRating({{ i }})" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; transition: transform 0.15s;" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'">
                                        <span id="star-{{ i }}" style="color: {% if candidate.rating and i <= candidate.rating %}var(--pp-orange){% else %}var(--pp-border){% endif %};">&#9733;</span>
                                    </button>
                                    {% endfor %}
                                </div>
                                <span style="font-size: 11.5px; color: var(--pp-textMuted); font-weight: 500;" x-text="currentRating ? currentRating + '/5' : 'Nicht bewertet'"></span>
                                <button type="button" x-show="currentRating > 0" @click="clearRating()" style="font-size: 11px; color: var(--pp-textDim); background: none; border: none; cursor: pointer; font-family: inherit; padding: 2px 6px; border-radius: 4px;">&#x2715;</button>
                            </div>
                        </div>
                    </div>
                    {# ERP #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--pp-borderLight);">
                        <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.06em;">ERP-Kenntnisse</div>
                        {% if candidate.erp and candidate.erp | length > 0 %}
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                            {% for erp_item in candidate.erp %}
                            <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px; background: var(--pp-surfaceHover); color: var(--pp-accent); border: 1px solid var(--pp-border);">
                                {{ erp_item }}
                                <button type="button" onclick="removeErp('{{ erp_item }}')" style="background: none; border: none; cursor: pointer; color: var(--pp-purple); font-size: 14px; padding: 0; margin-left: 2px; line-height: 1;" onmouseenter="this.style.color='var(--pp-red)'" onmouseleave="this.style.color='var(--pp-purple)'">&times;</button>
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="font-size: 12px; color: var(--pp-textDim); font-style: italic; margin-bottom: 10px;">Keine ERP-Kenntnisse angegeben</div>
                        {% endif %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" x-model="newErp" @keydown.enter.prevent="addErp()" placeholder="z.B. SAP, DATEV..." style="padding: 8px 12px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 12.5px; font-weight: 500; color: var(--pp-text); outline: none; width: 180px; font-family: inherit; background: var(--pp-surface);">
                            <button type="button" @click="addErp()" style="padding: 8px 14px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 12px; font-weight: 650; cursor: pointer; font-family: inherit;">+ Hinzuf&uuml;gen</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            {# ═══ TAB: Qualifizierung ═══ #}
            <div x-show="activeTab === 'qualifizierung'"
                 x-data="qualificationFields()" style="overflow:visible;">

                {# Qualifizierung content #}
                <div style="display:flex; flex-direction:column; gap:40px;">
                    
            {# ── Quick-Glance Bar ── #}
            <div class="kd-quickglance kd-anim" style="animation-delay:50ms;">
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x1F4B0;</div>
                    <div>
                        <div class="kd-quickglance-label">Gehalt</div>
                        <div class="kd-quickglance-value" style="color:var(--pp-green);">{{ candidate.salary or '–' }}</div>
                    </div>
                </div>
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x23F3;</div>
                    <div>
                        <div class="kd-quickglance-label">K&uuml;ndigungsfrist</div>
                        <div class="kd-quickglance-value" style="color:var(--pp-orange);">{{ candidate.notice_period or '–' }}</div>
                    </div>
                </div>
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x1F3E0;</div>
                    <div>
                        <div class="kd-quickglance-label">Home-Office</div>
                        <div class="kd-quickglance-value" style="color:var(--pp-accent);">{{ candidate.home_office_days or '–' }}</div>
                    </div>
                </div>
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x1F6E3;</div>
                    <div>
                        <div class="kd-quickglance-label">Pendelweg</div>
                        <div class="kd-quickglance-value" style="color:var(--pp-purple);">{{ candidate.commute_max or '–' }}</div>
                    </div>
                </div>
            </div>

                    <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 260ms; overflow: visible;" id="qualification-call"
                 >
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4DE;</span> Qualifizierungsgespr&auml;ch</div>
                    <span x-show="qfSaving" x-cloak style="font-size: 11px; font-weight: 600; color: var(--pp-accent);">Speichert...</span>
                </div>
                <div class="kd-section-body" style="overflow: visible;">
                    {# Row 1: Gewünschte Positionen + Tätigkeiten #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div class="kd-field-label">Gew&uuml;nschte Positionen</div>
                            <textarea x-model="qf.desired_positions" @blur="saveQField('desired_positions')" placeholder="z.B. Bilanzbuchhalterin, Finanzbuchhalterin..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 140px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.75;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                        <div>
                            <div class="kd-field-label">T&auml;tigkeiten (Kernkompetenzen)</div>
                            <textarea x-model="qf.key_activities" @blur="saveQField('key_activities')" placeholder="T&auml;tigkeiten die voll umf&auml;nglich beherrscht werden..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 140px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.75;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                    </div>

                    {# Row 2: Home-Office + Pendel + Verkehrsmittel + ERP-Steckenpferd #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 8px;">
                        <div>
                            <div class="kd-field-label">Home-Office Tage</div>
                            <input type="text" x-model="qf.home_office_days" @blur="saveQField('home_office_days')" placeholder="z.B. 2 bis 3 Tage"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                        </div>
                        <div>
                            <div class="kd-field-label">Pendelbereitschaft</div>
                            <input type="text" x-model="qf.commute_max" @blur="saveQField('commute_max')" placeholder="z.B. 30 min"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                        </div>
                        <div>
                            <div class="kd-field-label">Verkehrsmittel</div>
                            <div class="relative" @click.away="showTransportDd = false">
                                <button type="button" @click="showTransportDd = !showTransportDd"
                                    class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                    style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: var(--pp-text);">
                                    <span class="block truncate" x-text="qf.commute_transport || 'Ausw&auml;hlen'"></span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                        <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                    </span>
                                </button>
                                <div x-show="showTransportDd" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 180px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="opt in ['Auto', '&Ouml;PNV', 'Beides']" :key="opt">
                                        <button type="button" @click="qf.commute_transport = opt; showTransportDd = false; saveQField('commute_transport')"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; border: none;"
                                            :style="qf.commute_transport === opt ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                            @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                            @mouseleave="if (qf.commute_transport !== opt) $el.style.background = 'none'"
                                            x-text="opt"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">ERP-Steckenpferd</div>
                            <input type="text" x-model="qf.erp_main" @blur="saveQField('erp_main')" placeholder="z.B. DATEV"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                        </div>
                    </div>

                    {# Row 3: Anstellung + Teilzeit-Stunden + Großraumbüro #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 6px;">
                        <div>
                            <div class="kd-field-label">Anstellungsart</div>
                            <div class="relative" @click.away="showEmpTypeDd = false">
                                <button type="button" @click="showEmpTypeDd = !showEmpTypeDd"
                                    class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                    style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: var(--pp-text);">
                                    <span class="block truncate" x-text="qf.employment_type || 'Ausw&auml;hlen'"></span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                        <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                    </span>
                                </button>
                                <div x-show="showEmpTypeDd" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 180px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="opt in ['Vollzeit', 'Teilzeit', 'Beides']" :key="opt">
                                        <button type="button" @click="qf.employment_type = opt; showEmpTypeDd = false; saveQField('employment_type')"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; border: none;"
                                            :style="qf.employment_type === opt ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                            @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                            @mouseleave="if (qf.employment_type !== opt) $el.style.background = 'none'"
                                            x-text="opt"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">Teilzeit-Stunden</div>
                            <input type="text" x-model="qf.part_time_hours" @blur="saveQField('part_time_hours')" placeholder="z.B. 30 Stunden"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"
                                :style="!qf.employment_type || qf.employment_type === 'Vollzeit' ? 'opacity: 0.4;' : ''">
                        </div>
                        <div>
                            <div class="kd-field-label">Grossraumb&uuml;ro OK?</div>
                            <div class="flex gap-2">
                                <button type="button" @click="setQfChoice('open_office_ok', 'ja')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.open_office_ok === 'ja' ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="qf.open_office_ok !== 'ja' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="setQfChoice('open_office_ok', 'nein')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.open_office_ok === 'nein' ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="qf.open_office_ok !== 'nein' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                                <button type="button" @click="setQfChoice('open_office_ok', 'egal')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.open_office_ok === 'egal' ? 'border-2 ring-1 ring-gray-400/30' : 'border-2 hover:border-gray-400/40 hover:text-gray-300'"
                                    :style="qf.open_office_ok === 'egal' ? 'background: var(--pp-surfaceHover); color: var(--pp-textMuted); border-color: var(--pp-textMuted);' : 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);'"
                                    style="font-family: inherit;">Egal</button>
                            </div>
                        </div>
                    </div>

                    {# Row 4: Branchen #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--pp-borderLight);">
                        <div>
                            <div class="kd-field-label">Bevorzugte Branchen</div>
                            <textarea x-model="qf.preferred_industries" @blur="saveQField('preferred_industries')" placeholder="Freitext: Bevorzugte Branchen..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 38px; padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                        <div>
                            <div class="kd-field-label">Branchen vermeiden</div>
                            <textarea x-model="qf.avoided_industries" @blur="saveQField('avoided_industries')" placeholder="Freitext: Branchen die vermieden werden sollen..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 38px; padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                    </div>

                    {# Row 5: WhatsApp + Exklusivität + Andere Recruiter #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--pp-borderLight);">
                        <div>
                            <div class="kd-field-label">WhatsApp OK?</div>
                            <div class="flex gap-2">
                                <button type="button" @click="toggleQfBool('whatsapp_ok', true)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.whatsapp_ok === true ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="qf.whatsapp_ok !== true ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="toggleQfBool('whatsapp_ok', false)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.whatsapp_ok === false ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="qf.whatsapp_ok !== false ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">Exklusivit&auml;t vereinbart?</div>
                            <div class="flex gap-2">
                                <button type="button" @click="toggleQfBool('exclusivity_agreed', true)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.exclusivity_agreed === true ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="qf.exclusivity_agreed !== true ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="toggleQfBool('exclusivity_agreed', false)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.exclusivity_agreed === false ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="qf.exclusivity_agreed !== false ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">Andere Recruiter aktiv?</div>
                            <textarea x-model="qf.other_recruiters" @blur="saveQField('other_recruiters')" placeholder="Details zu anderen Recruitern..."
                                class="w-full rounded-lg text-sm font-semibold resize-vertical"
                                style="min-height: 80px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.75;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                    </div>

                    {# Row 6: Bereits beworben bei (Freitext) #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--pp-borderLight);">
                        <div class="kd-field-label">Bereits beworben bei (aus Gespr&auml;ch)</div>
                        <textarea x-model="qf.applied_at_companies_text" @blur="saveQField('applied_at_companies_text')" placeholder="Freitext aus Transkription: Wo hat sich der Kandidat bereits beworben?"
                            class="w-full rounded-lg text-sm font-medium resize-vertical"
                            style="min-height: 100px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.75;"
                            @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                    </div>

                    {# Row 7: Call-Daten #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--pp-borderLight);">
                        <div style="font-size: 12px; font-weight: 700; color: var(--pp-textMuted); margin-bottom: 8px;">Gespr&auml;chsdaten</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div class="kd-field-label">Gespr&auml;chsdatum</div>
                                <input type="date" x-model="qfCallDate" @change="saveCallDate()"
                                    class="rounded-lg text-sm font-semibold cursor-pointer"
                                    style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; color-scheme: dark;">
                            </div>
                            <div>
                                <div class="kd-field-label">Gespr&auml;chstyp</div>
                                <div class="relative" @click.away="showCallTypeDd = false">
                                    <button type="button" @click="showCallTypeDd = !showCallTypeDd"
                                        class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                        style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: var(--pp-text);">
                                        <span class="block truncate" x-text="callTypeLabels[qf.call_type] || 'Ausw&auml;hlen'"></span>
                                        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                            <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                        </span>
                                    </button>
                                    <div x-show="showCallTypeDd" x-cloak
                                         class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                         style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 220px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                        <template x-for="ct in callTypeOptions" :key="ct.value">
                                            <button type="button" @click="qf.call_type = ct.value; showCallTypeDd = false; saveQField('call_type')"
                                                class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                                style="font-family: inherit; white-space: nowrap; border: none;"
                                                :style="qf.call_type === ct.value ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                                @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                                @mouseleave="if (qf.call_type !== ct.value) $el.style.background = 'none'"
                                                x-text="ct.label"></button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {# KI-Zusammenfassung #}
                        <div style="margin-top: 8px;">
                            <div class="kd-field-label">KI-Zusammenfassung</div>
                            <textarea x-model="qf.call_summary" @blur="saveQField('call_summary')" placeholder="KI-generierte Zusammenfassung des Gespr&auml;chs..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 100px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.75;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                        {# Transkript (aufklappbar) #}
                        <div style="margin-top: 8px;" x-data="{ showTranscript: false }">
                            <button type="button" @click="showTranscript = !showTranscript"
                                class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                style="background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-textMuted); font-family: inherit;">
                                <svg :class="showTranscript ? 'rotate-90' : ''" class="w-3 h-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M9 5l7 7-7 7"/></svg>
                                <span x-text="showTranscript ? 'Transkript ausblenden' : 'Transkript anzeigen'"></span>
                                <span x-show="qf.call_transcript" x-cloak style="font-size: 10px; color: var(--pp-accent); font-weight: 600;">(vorhanden)</span>
                            </button>
                            <div x-show="showTranscript" x-cloak style="margin-top: 8px;">
                                <textarea x-model="qf.call_transcript" @blur="saveQField('call_transcript')" placeholder="Volle Transkription des Gespr&auml;chs..."
                                    class="w-full rounded-lg text-sm font-medium resize-vertical"
                                    style="min-height: 200px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.6; font-size: 12px;"
                                    @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                    <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 275ms; overflow: visible; position: relative; z-index: 10;" id="presented-at"
                 x-data="{
                    entries: {{ (candidate.presented_at_companies or []) | tojson | safe }},
                    showAddForm: false,
                    newCompany: '',
                    newType: 'presented',
                    newDate: new Date().toISOString().split('T')[0],
                    filteredCompanies: [],
                    showCompanyDropdown: false,
                    _searchTimeout: null,
                    async loadCompanies() { /* no-op, search is now server-side */ },
                    filterCompanies() {
                        var self = this;
                        if (self._searchTimeout) clearTimeout(self._searchTimeout);
                        if (!self.newCompany || self.newCompany.length < 2) { self.filteredCompanies = []; self.showCompanyDropdown = false; return; }
                        self._searchTimeout = setTimeout(function() {
                            fetch('/api/companies?per_page=15&sort_by=name&search=' + encodeURIComponent(self.newCompany))
                                .then(function(r) { return r.json(); })
                                .then(function(data) {
                                    self.filteredCompanies = (data.items || []).map(function(c) { return c.name; });
                                    self.showCompanyDropdown = self.filteredCompanies.length > 0;
                                })
                                .catch(function(err) { console.error(err); });
                        }, 250);
                    },
                    selectCompany(name) {
                        this.newCompany = name;
                        this.filteredCompanies = [];
                        this.showCompanyDropdown = false;
                    },
                    async addEntry() {
                        if (!this.newCompany.trim()) return;
                        var entry = { company: this.newCompany.trim(), date: this.newDate, type: this.newType };
                        this.entries.push(entry);
                        var candidateId = '{{ candidate.id }}';
                        try {
                            await fetch('/api/candidates/' + candidateId, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ presented_at_companies: this.entries })
                            });
                            if (typeof showToast === 'function') showToast('Eintrag hinzugefuegt', 'success');
                        } catch (err) { console.error(err); }
                        this.newCompany = ''; this.showAddForm = false;
                    },
                    async removeEntry(idx) {
                        this.entries.splice(idx, 1);
                        var candidateId = '{{ candidate.id }}';
                        try {
                            await fetch('/api/candidates/' + candidateId, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ presented_at_companies: this.entries })
                            });
                            if (typeof showToast === 'function') showToast('Eintrag entfernt', 'success');
                        } catch (err) { console.error(err); }
                    }
                 }">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F3E2;</span> Vorgestellt / Beworben bei</div>
                    <button type="button" @click="showAddForm = !showAddForm; if(showAddForm) loadCompanies()" style="display: flex; align-items: center; gap: 6px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); border-radius: 8px; padding: 5px 12px; font-size: 11.5px; font-weight: 650; color: var(--pp-accent); cursor: pointer; font-family: inherit;">
                        <span x-text="showAddForm ? 'Abbrechen' : '+ Hinzuf&uuml;gen'"></span>
                    </button>
                </div>
                <div class="kd-section-body" style="overflow: visible;">
                    {# Add form #}
                    <div x-show="showAddForm" x-cloak class="mb-3.5" style="padding: 14px; border-radius: 10px; background: var(--pp-bg); border: 1px solid var(--pp-border); overflow: visible;">
                        <div class="flex flex-wrap items-end gap-2.5" style="overflow: visible;">
                            <div class="relative flex-[2] min-w-[220px]" x-ref="companyInputWrap" @click.away="showCompanyDropdown = false">
                                <div class="kd-field-label">Unternehmen</div>
                                <input type="text" x-model="newCompany" @input="filterCompanies()" @focus="filterCompanies()" @keydown.enter.prevent="showCompanyDropdown = false; addEntry()" placeholder="z.B. Allianz, Siemens..."
                                    class="w-full rounded-lg text-sm outline-none"
                                    x-ref="companyInput"
                                    style="padding: 7px 10px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit;">
                                <div x-show="showCompanyDropdown" x-cloak
                                     @click.away="showCompanyDropdown = false"
                                     class="absolute z-[9999] mt-1 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 300px; width: max-content; max-width: 500px; max-height: 320px; box-shadow: 0 12px 32px rgba(0,0,0,0.6);">
                                    <template x-for="name in filteredCompanies" :key="name">
                                        <button type="button" @click="selectCompany(name)"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; color: var(--pp-text); font-weight: 500; background: none; border: none;"
                                            @mouseenter="$el.style.background='var(--pp-surfaceHover)'"
                                            @mouseleave="$el.style.background='none'"
                                            x-text="name"></button>
                                    </template>
                                </div>
                            </div>
                            <div>
                                <div class="kd-field-label">Typ</div>
                                <select x-model="newType" style="padding: 7px 10px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 13px; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; cursor: pointer;">
                                    <option value="presented">Vorgestellt</option>
                                    <option value="applied">Beworben</option>
                                    <option value="pdl">PDL</option>
                                </select>
                            </div>
                            <div>
                                <div class="kd-field-label">Datum</div>
                                <input type="date" x-model="newDate" style="padding: 7px 10px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 13px; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; color-scheme: dark;">
                            </div>
                            <button type="button" @click="addEntry()" style="padding: 8px 16px; border-radius: 8px; background: var(--pp-accent); color: #fff; font-size: 13px; font-weight: 650; cursor: pointer; font-family: inherit; border: none;">Speichern</button>
                        </div>
                    </div>
                    {# Entries list #}
                    <template x-if="entries.length > 0">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <template x-for="(entry, idx) in entries" :key="idx">
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span :style="entry.type === 'applied' ? 'background: var(--pp-orangeSoft); color: var(--pp-orange);' : entry.type === 'pdl' ? 'background: var(--pp-greenSoft); color: var(--pp-green);' : 'background: var(--pp-purpleSoft); color: var(--pp-purple);'" style="font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;" x-text="entry.type === 'applied' ? 'Beworben' : entry.type === 'pdl' ? 'PDL' : 'Vorgestellt'"></span>
                                        <span style="font-size: 13.5px; font-weight: 650; color: var(--pp-text);" x-text="entry.company"></span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: var(--pp-textDim); font-weight: 500;" x-text="entry.date ? new Date(entry.date).toLocaleDateString('de-DE') : ''"></span>
                                        <button type="button" @click="removeEntry(idx)" style="background: none; border: none; cursor: pointer; color: var(--pp-textDim); font-size: 16px; padding: 0 4px; line-height: 1;" onmouseenter="this.style.color='var(--pp-red)'" onmouseleave="this.style.color='var(--pp-textDim)'">&times;</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="entries.length === 0 && !showAddForm">
                        <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                            <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F3E2;</div>
                            <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Noch bei keinem Unternehmen vorgestellt</div>
                        </div>
                    </template>
                </div>
            </div>
                </div>

            </div>

            {# ═══ TAB: Aufgaben ═══ #}
            <div x-show="activeTab === 'aufgaben'" x-cloak x-data="aufgabenManager()" style="display:flex; flex-direction:column; gap:20px;">
                <div class="kd-section kd-anim" style="animation-delay:100ms;">
                    <div class="kd-section-header">
                        <div class="kd-section-title"><span>&#x2705;</span> Aufgaben</div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:12px; font-weight:600; color:var(--pp-textDim);" x-text="todos.length + ' Aufgaben'"></span>
                            <button type="button" @click="showAddForm = !showAddForm"
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer"
                                style="background:var(--pp-surfaceHover); border:1.5px solid var(--pp-border); color:var(--pp-accent); font-family:inherit;">
                                <span x-text="showAddForm ? 'Abbrechen' : '+ Aufgabe'"></span>
                            </button>
                        </div>
                    </div>
                    <div class="kd-section-body" style="padding:12px 24px 16px;">

                        {# ── Neue Aufgabe inline ── #}
                        <div x-show="showAddForm" x-cloak style="margin-bottom:12px; padding:12px 14px; border-radius:12px; background:var(--pp-accentSoft); border:1.5px solid var(--pp-accentGlow);">
                            <input type="text" x-model="newTodo.title" placeholder="Was muss erledigt werden?" @keydown.enter="addTodo()"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding:7px 10px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; margin-bottom:8px;">
                            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                <input type="date" x-model="newTodo.due_date"
                                    style="padding:5px 8px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:12px; color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; color-scheme:dark;">
                                <input type="time" x-model="newTodo.due_time" placeholder="HH:MM"
                                    style="padding:5px 8px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:12px; color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; color-scheme:dark; width:90px;">
                                <select x-model="newTodo.priority"
                                    style="padding:5px 8px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:12px; color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; cursor:pointer;">
                                    <option value="unwichtig">Unwichtig</option>
                                    <option value="mittelmaessig">Mittel</option>
                                    <option value="wichtig" selected>Wichtig</option>
                                    <option value="dringend">Dringend</option>
                                    <option value="sehr_dringend">Sehr dringend</option>
                                </select>
                                <div style="flex:1;"></div>
                                <button type="button" @click="addTodo()"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer"
                                    style="background:var(--pp-green); color:#fff; border:none; font-family:inherit;">
                                    Erstellen
                                </button>
                            </div>
                        </div>

                        {# ── Filter-Leiste ── #}
                        <div x-show="todos.length > 0" style="display:flex; gap:6px; margin-bottom:10px;">
                            <button type="button" @click="filter = 'all'" class="px-3 py-1 rounded-lg text-xs font-bold cursor-pointer"
                                :style="filter === 'all' ? 'background:var(--pp-accentSoft);color:var(--pp-accent);border:1px solid var(--pp-accentGlow);' : 'background:transparent;color:var(--pp-textDim);border:1px solid transparent;'"
                                style="font-family:inherit;">Alle</button>
                            <button type="button" @click="filter = 'open'" class="px-3 py-1 rounded-lg text-xs font-bold cursor-pointer"
                                :style="filter === 'open' ? 'background:var(--pp-accentSoft);color:var(--pp-accent);border:1px solid var(--pp-accentGlow);' : 'background:transparent;color:var(--pp-textDim);border:1px solid transparent;'"
                                style="font-family:inherit;">Offen</button>
                            <button type="button" @click="filter = 'done'" class="px-3 py-1 rounded-lg text-xs font-bold cursor-pointer"
                                :style="filter === 'done' ? 'background:var(--pp-greenSoft);color:var(--pp-green);border:1px solid rgba(34,197,94,0.3);' : 'background:transparent;color:var(--pp-textDim);border:1px solid transparent;'"
                                style="font-family:inherit;">Erledigt</button>
                        </div>

                        {# ── Todo-Liste (kompakt wie Anrufprotokoll) ── #}
                        <div style="display:flex; flex-direction:column; gap:6px;">
                            <template x-for="todo in filteredTodos" :key="todo.id">
                                <div style="border-radius:12px; border:1px solid var(--pp-border); transition:all .2s; background:var(--pp-surface);"
                                     :style="todo.status === 'done' ? 'border-color:rgba(34,197,94,0.2); opacity:0.6;' : todo.is_overdue ? 'border-color:rgba(239,68,68,0.3); background:rgba(239,68,68,0.04);' : ''">

                                    {# ── Hauptzeile ── #}
                                    <div style="padding:12px 16px; display:flex; align-items:center; gap:10px;">
                                        {# Checkbox #}
                                        <button type="button" @click="toggleStatus(todo)"
                                            style="flex-shrink:0; width:20px; height:20px; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .15s; padding:0;"
                                            :style="todo.status === 'done' ? 'border:2px solid var(--pp-green); background:var(--pp-green);' : 'border:2px solid var(--pp-text4); background:transparent;'">
                                            <svg x-show="todo.status === 'done'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>
                                        </button>

                                        {# Titel + Priority #}
                                        <div style="flex:1; min-width:0; cursor:pointer;" @click="todo._open = !todo._open">
                                            <div style="display:flex; align-items:center; gap:8px;">
                                                <span style="font-size:13.5px; font-weight:600; line-height:1.3; font-family:inherit;"
                                                      :style="todo.status === 'done' ? 'color:var(--pp-textDim); text-decoration:line-through;' : 'color:var(--pp-text);'"
                                                      x-text="todo.title"></span>
                                                <span style="font-size:10px; font-weight:700; padding:2px 7px; border-radius:6px; white-space:nowrap; font-family:inherit;"
                                                      :style="'color:' + todo.priority_color + '; background:' + todo.priority_color + '18;'"
                                                      x-text="todo.priority_label"></span>
                                            </div>
                                        </div>

                                        {# Datum + Uhrzeit rechts #}
                                        <template x-if="todo.due_date || todo.due_time">
                                            <span style="font-size:12px; font-weight:600; white-space:nowrap; font-family:inherit; display:inline-flex; align-items:center; gap:4px;"
                                                  :style="todo.is_overdue ? 'color:var(--pp-red);' : 'color:var(--pp-textDim);'">
                                                <span x-show="todo.due_date" x-text="todo.due_date_formatted"></span>
                                                <span x-show="todo.due_time" x-text="todo.due_time" style="font-size:11px;"></span>
                                            </span>
                                        </template>

                                        {# Loeschen #}
                                        <button type="button" @click="if(confirm('Aufgabe l\u00f6schen?')) deleteTodo(todo.id)"
                                            style="flex-shrink:0; width:20px; height:20px; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0; border:none; background:transparent; color:var(--pp-text4); transition:all .15s;"
                                            onmouseenter="this.style.color='var(--pp-red)';this.style.background='var(--pp-redSoft)'" onmouseleave="this.style.color='var(--pp-text4)';this.style.background='transparent'"
                                            title="L&ouml;schen">
                                            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                                        </button>
                                        {# Pfeil #}
                                        <svg @click="todo._open = !todo._open" :style="todo._open ? 'transform:rotate(180deg)' : ''" width="14" height="14" style="color:var(--pp-textDim); flex-shrink:0; cursor:pointer; transition:transform .2s;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                                    </div>

                                    {# ── Aufklapp-Detail ── #}
                                    <div x-show="todo._open" x-transition.duration.150ms style="border-top:1px solid var(--pp-borderLight); padding:12px 16px; background:var(--pp-surfaceHover);">
                                        <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-bottom:8px;">
                                            <div style="flex:1; min-width:120px;">
                                                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--pp-textDim); margin-bottom:4px;">F&auml;llig</div>
                                                <input type="date" :value="todo.due_date || ''" @change="updateTodo(todo.id, {due_date: $event.target.value || null})"
                                                    style="width:100%; padding:5px 8px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:12px; color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; color-scheme:dark;">
                                            </div>
                                            <div style="min-width:85px;">
                                                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--pp-textDim); margin-bottom:4px;">Uhrzeit</div>
                                                <input type="time" :value="todo.due_time || ''" @change="updateTodo(todo.id, {due_time: $event.target.value || null})"
                                                    style="width:100%; padding:5px 8px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:12px; color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; color-scheme:dark;">
                                            </div>
                                            <div style="min-width:100px;">
                                                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--pp-textDim); margin-bottom:4px;">Priorit&auml;t</div>
                                                <select :value="todo.priority" @change="updateTodo(todo.id, {priority: $event.target.value})"
                                                    style="width:100%; padding:5px 8px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:12px; color:var(--pp-text); background:var(--pp-bg); font-family:inherit; outline:none; cursor:pointer;">
                                                    <option value="unwichtig">Unwichtig</option>
                                                    <option value="mittelmaessig">Mittel</option>
                                                    <option value="wichtig">Wichtig</option>
                                                    <option value="dringend">Dringend</option>
                                                    <option value="sehr_dringend">Sehr dringend</option>
                                                </select>
                                            </div>
                                            <div style="min-width:110px;">
                                                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--pp-textDim); margin-bottom:4px;">Status</div>
                                                <select :value="todo.status" @change="updateTodo(todo.id, {status: $event.target.value})"
                                                    style="width:100%; padding:5px 8px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:12px; color:var(--pp-text); background:var(--pp-bg); font-family:inherit; outline:none; cursor:pointer;">
                                                    <option value="open">Offen</option>
                                                    <option value="in_progress">In Bearbeitung</option>
                                                    <option value="done">Erledigt</option>
                                                    <option value="cancelled">Abgebrochen</option>
                                                </select>
                                            </div>
                                            <button type="button" @click="if(confirm('L\u00f6schen?')) deleteTodo(todo.id)"
                                                style="padding:5px 10px; border-radius:8px; border:1px solid rgba(239,68,68,0.2); background:var(--pp-redSoft); color:var(--pp-red); font-size:11px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap;">&#x1F5D1;</button>
                                        </div>
                                        <template x-if="todo.description">
                                            <div style="font-size:12px; color:var(--pp-textMuted); line-height:1.5; padding:6px 0;" x-text="todo.description"></div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>

                        {# Empty State #}
                        <template x-if="todos.length === 0 && !showAddForm">
                            <div style="display:flex; flex-direction:column; align-items:center; padding:28px 0;">
                                <div style="font-size:28px; margin-bottom:6px; opacity:0.25;">&#x1F4CB;</div>
                                <div style="font-size:13px; font-weight:600; color:var(--pp-textDim);">Keine Aufgaben</div>
                                <div style="font-size:11px; color:var(--pp-text4); margin-top:3px;">Werden automatisch aus Anrufen erstellt</div>
                            </div>
                        </template>
                    </div>
                </div>

                {# ═══ Email-Entwürfe Sektion (im Aufgaben-Tab) ═══ #}
                <div class="kd-section kd-anim" style="animation-delay:200ms;" x-data="emailDraftsManager()">
                    <div class="kd-section-header">
                        <div class="kd-section-title"><span>&#x2709;</span> Email-Entw&uuml;rfe</div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:12px; font-weight:600; color:var(--pp-textDim);" x-text="drafts.length + ' Entw\u00fcrfe'"></span>
                            <template x-if="pendingCount > 0">
                                <span style="font-size:11px;font-weight:700;background:var(--pp-orange);color:#000;padding:1px 7px;border-radius:99px;" x-text="pendingCount + ' offen'"></span>
                            </template>
                        </div>
                    </div>
                    <div class="kd-section-body" style="padding:12px 24px 16px;">

                        {# ── Draft-Liste ── #}
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <template x-for="draft in drafts" :key="draft.id">
                                <div style="border-radius:12px; border:1px solid var(--pp-border); transition:all .2s; background:var(--pp-surface);"
                                     :style="draft.status === 'sent' ? 'border-color:rgba(34,197,94,0.2); opacity:0.65;' : draft.status === 'failed' ? 'border-color:rgba(239,68,68,0.3); background:rgba(239,68,68,0.04);' : ''">

                                    {# ── Hauptzeile ── #}
                                    <div style="padding:12px 16px; display:flex; align-items:center; gap:10px;">
                                        {# Status-Icon #}
                                        <div style="flex-shrink:0; width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:14px;"
                                             :style="draft.status === 'sent' ? 'background:var(--pp-greenSoft);' : draft.status === 'failed' ? 'background:var(--pp-redSoft);' : 'background:var(--pp-accentSoft);'">
                                            <span x-show="draft.status === 'draft'">&#x1F4E7;</span>
                                            <span x-show="draft.status === 'sent'">&#x2705;</span>
                                            <span x-show="draft.status === 'failed'">&#x26A0;</span>
                                            <span x-show="draft.status === 'cancelled'">&#x274C;</span>
                                        </div>

                                        {# Typ + Subject #}
                                        <div style="flex:1; min-width:0; cursor:pointer;" @click="draft._open = !draft._open">
                                            <div style="display:flex; align-items:center; gap:8px;">
                                                <span style="font-size:13.5px; font-weight:600; line-height:1.3; font-family:inherit; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"
                                                      :style="draft.status === 'sent' ? 'color:var(--pp-textDim);' : draft.status === 'failed' ? 'color:var(--pp-red);' : 'color:var(--pp-text);'"
                                                      x-text="draft.subject"></span>
                                                <span style="font-size:10px; font-weight:700; padding:2px 7px; border-radius:6px; white-space:nowrap; font-family:inherit;"
                                                      :style="draft.type_color"
                                                      x-text="draft.type_label"></span>
                                            </div>
                                            <div style="font-size:11px; color:var(--pp-textDim); margin-top:2px; font-family:inherit;">
                                                <span x-text="'An: ' + draft.to_email"></span>
                                                <span x-show="draft.created_formatted" x-text="' \u2022 ' + draft.created_formatted"></span>
                                            </div>
                                        </div>

                                        {# Status-Badge #}
                                        <span style="font-size:10px; font-weight:700; padding:2px 7px; border-radius:6px; white-space:nowrap; font-family:inherit;"
                                              :style="draft.status_style"
                                              x-text="draft.status_label"></span>

                                        {# Pfeil #}
                                        <svg @click="draft._open = !draft._open" :style="draft._open ? 'transform:rotate(180deg)' : ''" width="14" height="14" style="color:var(--pp-textDim); flex-shrink:0; cursor:pointer; transition:transform .2s;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                                    </div>

                                    {# ── Aufklapp-Detail (Email-Vorschau + Aktionen) ── #}
                                    <div x-show="draft._open" x-transition.duration.150ms style="border-top:1px solid var(--pp-borderLight); padding:14px 16px; background:var(--pp-surfaceHover);">
                                        {# Betreff editierbar bei draft-Status #}
                                        <template x-if="draft.status === 'draft'">
                                            <div style="margin-bottom:10px;">
                                                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--pp-textDim); margin-bottom:4px;">Betreff</div>
                                                <input type="text" :value="draft.subject" @change="updateDraft(draft.id, {subject: $event.target.value})"
                                                    style="width:100%; padding:6px 10px; border-radius:8px; border:1.5px solid var(--pp-border); font-size:13px; color:var(--pp-text); background:var(--pp-bg); font-family:inherit; outline:none;">
                                            </div>
                                        </template>

                                        {# Email-Body Vorschau #}
                                        <div style="margin-bottom:12px; padding:14px; border-radius:12px; background:var(--pp-bg); border:1px solid var(--pp-border); max-height:300px; overflow-y:auto;">
                                            <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--pp-textDim); margin-bottom:8px;">Vorschau</div>
                                            <div x-html="draft.body_html" style="font-size:13px; line-height:1.6; color:var(--pp-textMuted);"></div>
                                        </div>

                                        {# Fehler anzeigen #}
                                        <template x-if="draft.send_error">
                                            <div style="margin-bottom:10px; padding:8px 12px; border-radius:8px; background:var(--pp-redSoft); border:1px solid rgba(239,68,68,0.2); font-size:12px; color:var(--pp-red);">
                                                <strong>Fehler:</strong> <span x-text="draft.send_error"></span>
                                            </div>
                                        </template>

                                        {# Aktions-Buttons #}
                                        <div style="display:flex; gap:8px; align-items:center;">
                                            <template x-if="draft.status === 'draft'">
                                                <button type="button" @click="sendDraft(draft.id)"
                                                    class="px-4 py-1.5 rounded-lg text-xs font-bold cursor-pointer"
                                                    style="background:var(--pp-green); color:#fff; border:none; font-family:inherit;"
                                                    :disabled="draft._sending">
                                                    <span x-show="!draft._sending">&#x2709; Jetzt senden</span>
                                                    <span x-show="draft._sending">Wird gesendet...</span>
                                                </button>
                                            </template>
                                            <template x-if="draft.status === 'draft'">
                                                <button type="button" @click="if(confirm('Entwurf verwerfen?')) cancelDraft(draft.id)"
                                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer"
                                                    style="background:transparent; border:1px solid rgba(239,68,68,0.2); color:var(--pp-red); font-family:inherit;">
                                                    Verwerfen
                                                </button>
                                            </template>
                                            <template x-if="draft.status === 'failed'">
                                                <button type="button" @click="sendDraft(draft.id)"
                                                    class="px-4 py-1.5 rounded-lg text-xs font-bold cursor-pointer"
                                                    style="background:var(--pp-accentSoft); color:var(--pp-accent); border:1px solid var(--pp-accentGlow); font-family:inherit;">
                                                    &#x1F504; Erneut versuchen
                                                </button>
                                            </template>
                                            <template x-if="draft.status === 'sent' && draft.sent_at">
                                                <span style="font-size:11px; color:var(--pp-green); font-weight:600;">
                                                    Gesendet <span x-text="draft.sent_formatted"></span>
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        {# Empty State #}
                        <template x-if="drafts.length === 0">
                            <div style="display:flex; flex-direction:column; align-items:center; padding:28px 0;">
                                <div style="font-size:28px; margin-bottom:6px; opacity:0.25;">&#x2709;</div>
                                <div style="font-size:13px; font-weight:600; color:var(--pp-textDim);">Keine Email-Entw&uuml;rfe</div>
                                <div style="font-size:11px; color:var(--pp-text4); margin-top:3px;">Werden automatisch nach Gespr&auml;chen erstellt</div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            {# ═══ TAB: Gespräche (Anrufprotokoll) ═══ #}
            <div x-show="activeTab === 'gespraeche'" x-cloak x-data="callLogTimeline()" style="display:flex; flex-direction:column; gap:20px;">
                {# Header mit Hinzufügen-Button #}
                <div class="kd-section kd-anim" style="animation-delay:100ms;">
                    <div class="kd-section-header">
                        <div class="kd-section-title"><span>&#x1F4DE;</span> Anrufprotokoll</div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:12px; font-weight:600; color:var(--pp-textDim);" x-text="calls.length + ' Gespr&auml;che'"></span>
                            <button type="button" @click="showAddCall = !showAddCall"
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer"
                                style="background:var(--pp-surfaceHover); border:1.5px solid var(--pp-border); color:var(--pp-accent); font-family:inherit;">
                                <span x-text="showAddCall ? 'Abbrechen' : '+ Anruf'"></span>
                            </button>
                        </div>
                    </div>
                    <div class="kd-section-body">
                        {# Neuen Anruf hinzufügen #}
                        <div x-show="showAddCall" x-cloak style="margin-bottom:16px; padding:16px; border-radius:12px; background:var(--pp-bg); border:1px solid var(--pp-border);">
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div>
                                    <div class="kd-field-label">Datum</div>
                                    <input type="datetime-local" x-model="newCall.called_at"
                                        class="w-full rounded-lg text-sm font-semibold"
                                        style="padding:8px 12px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; color-scheme:dark;">
                                </div>
                                <div>
                                    <div class="kd-field-label">Typ</div>
                                    <select x-model="newCall.call_type"
                                        class="w-full rounded-lg text-sm font-semibold cursor-pointer"
                                        style="padding:8px 12px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none;">
                                        <option value="candidate_call">Kandidatengespr&auml;ch</option>
                                        <option value="qualification">Qualifizierung</option>
                                        <option value="followup">Nachfassen</option>
                                        <option value="acquisition">Akquise</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="kd-field-label">Richtung</div>
                                    <select x-model="newCall.direction"
                                        class="w-full rounded-lg text-sm font-semibold cursor-pointer"
                                        style="padding:8px 12px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none;">
                                        <option value="outbound">Ausgehend</option>
                                        <option value="inbound">Eingehend</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom:10px;">
                                <div class="kd-field-label">Zusammenfassung / Notiz</div>
                                <textarea x-model="newCall.summary" placeholder="Worum ging es im Gespr&auml;ch?"
                                    class="w-full rounded-lg text-sm font-medium resize-vertical"
                                    style="min-height:80px; padding:10px 14px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; line-height:1.75;"
                                    @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                            </div>
                            <div style="display:flex; justify-content:flex-end;">
                                <button type="button" @click="saveNewCall()" :disabled="!newCall.summary.trim() || saving"
                                    class="px-4 py-2 rounded-lg text-sm font-bold cursor-pointer"
                                    style="background:var(--pp-accent); color:#fff; border:none; font-family:inherit;"
                                    :style="(!newCall.summary.trim() || saving) ? 'opacity:0.5; cursor:not-allowed;' : ''">
                                    <span x-text="saving ? 'Speichert...' : 'Anruf speichern'"></span>
                                </button>
                            </div>
                        </div>

                        {# Timeline #}
                        <template x-if="calls.length > 0">
                            <div style="display:flex; flex-direction:column; gap:0; position:relative;">
                                {# Timeline-Linie #}
                                <div style="position:absolute; left:15px; top:8px; bottom:8px; width:2px; background:var(--pp-border); border-radius:1px;"></div>
                                <template x-for="(call, idx) in calls" :key="call.id">
                                    <div style="display:flex; gap:16px; position:relative; padding:12px 0;">
                                        {# Timeline-Dot #}
                                        <div style="flex-shrink:0; width:32px; display:flex; justify-content:center; z-index:1;">
                                            <div :style="call.call_type === 'qualification' ? 'background:var(--pp-purpleSoft); border-color:var(--pp-purple);' : call.call_type === 'acquisition' ? 'background:var(--pp-orangeSoft); border-color:var(--pp-orange);' : call.call_type === 'followup' ? 'background:var(--pp-greenSoft); border-color:var(--pp-green);' : 'background:var(--pp-surfaceHover); border-color:var(--pp-textMuted);'"
                                                style="width:12px; height:12px; border-radius:50%; border:2px solid; margin-top:4px;"></div>
                                        </div>
                                        {# Call Card #}
                                        <div style="flex:1; padding:12px 16px; border-radius:12px; background:var(--pp-surfaceHover); border:1px solid var(--pp-border); transition:border-color 0.2s;"
                                             @mouseenter="$el.style.borderColor='var(--pp-accentGlow)'" @mouseleave="$el.style.borderColor='var(--pp-border)'">
                                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <span :style="call.call_type === 'qualification' ? 'background:var(--pp-purpleSoft); color:var(--pp-purple);' : call.call_type === 'acquisition' ? 'background:var(--pp-orangeSoft); color:var(--pp-orange);' : call.call_type === 'followup' ? 'background:var(--pp-greenSoft); color:var(--pp-green);' : 'background:var(--pp-surfaceHover); color:var(--pp-textMuted);'"
                                                        style="font-size:10px; font-weight:700; padding:3px 8px; border-radius:6px; text-transform:uppercase; letter-spacing:0.05em;"
                                                        x-text="call.call_type_label"></span>
                                                    <span x-show="call.direction" style="font-size:10px; font-weight:600; color:var(--pp-textDim);"
                                                        x-text="call.direction === 'inbound' ? 'Eingehend' : 'Ausgehend'"></span>
                                                    <span x-show="call.duration_minutes" style="font-size:10px; font-weight:600; color:var(--pp-textDim);"
                                                        x-text="call.duration_minutes + ' Min.'"></span>
                                                </div>
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <span style="font-size:11px; font-weight:600; color:var(--pp-textDim);"
                                                        x-text="formatDate(call.called_at)"></span>
                                                    <button type="button" @click="deleteCall(call.id, idx)"
                                                        class="px-1 py-0.5 rounded text-xs cursor-pointer"
                                                        style="background:none; border:none; color:var(--pp-textDim); font-size:14px; line-height:1;"
                                                        @mouseenter="$el.style.color='var(--pp-red)'" @mouseleave="$el.style.color='var(--pp-textDim)'">&times;</button>
                                                </div>
                                            </div>
                                            <div style="font-size:13px; font-weight:500; color:var(--pp-text); line-height:1.6; white-space:pre-wrap;" x-text="call.summary"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="calls.length === 0 && !showAddCall">
                            <div style="display:flex; flex-direction:column; align-items:center; padding:30px 0;">
                                <div style="font-size:28px; margin-bottom:8px; opacity:0.3;">&#x1F4DE;</div>
                                <div style="font-size:13px; font-weight:600; color:var(--pp-textDim);">Noch keine Anrufe protokolliert</div>
                                <div style="font-size:11px; color:var(--pp-textDim); margin-top:4px;">Anrufe werden automatisch von n8n erfasst oder k&ouml;nnen manuell hinzugef&uuml;gt werden.</div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            {# ═══ TAB: Profil & CV ═══ #}
            <div x-show="activeTab === 'profil'" x-cloak style="display:flex; flex-direction:column; gap:40px;">
                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 300ms; position: relative; z-index: 1;" id="experience">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BC;</span> Berufserfahrung</div>
                    <button type="button" onclick="copyWerdegang()" style="display: flex; align-items: center; gap: 5px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border); border-radius: 6px; padding: 4px 10px; font-size: 10.5px; font-weight: 650; color: var(--pp-text); cursor: pointer; font-family: inherit;">&#x1F4CB; Profil kopieren</button>
                </div>
                <div class="kd-section-body">
                    {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
                        {% set work_list = candidate.work_history %}
                        {% for job in work_list %}{% if job is mapping %}
                        {% set is_first = loop.first %}
                        {% set is_last = loop.last %}
                        {# ── Dauer berechnen ── #}
                        {% set dur_text = job.duration | default('') %}
                        {% if not dur_text and job.start_date %}
                            {% set sd = job.start_date | string %}
                            {% set ed = job.end_date | default('') | string %}
                            {% set s_parts = sd.split('/') %}
                            {% if s_parts | length == 2 %}
                                {% set s_month = s_parts[0] | int %}
                                {% set s_year = s_parts[1] | int %}
                                {% if ed and ed != 'None' and ed != 'null' and ed != 'heute' and ed != 'today' %}
                                    {% set e_parts = ed.split('/') %}
                                    {% if e_parts | length == 2 %}
                                        {% set e_month = e_parts[0] | int %}
                                        {% set e_year = e_parts[1] | int %}
                                    {% else %}
                                        {% set e_month = now().month %}
                                        {% set e_year = now().year %}
                                    {% endif %}
                                {% else %}
                                    {% set e_month = now().month %}
                                    {% set e_year = now().year %}
                                {% endif %}
                                {% set total_months = (e_year - s_year) * 12 + (e_month - s_month) %}
                                {% if total_months > 0 %}
                                    {% set d_years = total_months // 12 %}
                                    {% set d_months = total_months % 12 %}
                                    {% if d_years > 0 and d_months > 0 %}
                                        {% set dur_text = d_years ~ ' J. ' ~ d_months ~ ' Mon.' %}
                                    {% elif d_years > 0 %}
                                        {% set dur_text = d_years ~ ' Jahr' ~ ('e' if d_years != 1 else '') %}
                                    {% else %}
                                        {% set dur_text = d_months ~ ' Mon.' %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        <div style="display: flex; gap: 10px; padding: 12px 0; {% if not is_last %}border-bottom: 1px solid var(--pp-surfaceHover);{% endif %}">
                            {# Timeline dot + line #}
                            <div style="display: flex; flex-direction: column; align-items: center; padding-top: 4px; flex-shrink: 0; width: 20px;">
                                <div class="{% if is_first %}kd-exp-dot-current{% else %}kd-exp-dot-past{% endif %}"></div>
                                {% if not is_last %}
                                <div class="kd-exp-line"></div>
                                {% endif %}
                            </div>
                            {# Content #}
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 6px; flex-wrap: wrap;">
                                    <div>
                                        <div style="font-size: 14.5px; font-weight: 720; color: var(--pp-text); letter-spacing: -0.01em; line-height: 1.3;">
                                            {{ job.position | default(job.title | default('Unbekannte Position')) }}
                                        </div>
                                        <div style="font-size: 13px; color: var(--pp-textMuted); margin-top: 3px; font-weight: 500;">
                                            {{ job.company | default('Unbekanntes Unternehmen') }}
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                        {% if job.start_date %}
                                        <span style="font-size: 12px; color: var(--pp-textDim); font-weight: 500; white-space: nowrap;">
                                            {{ job.start_date }}{% if job.end_date and job.end_date != 'None' %} &ndash; {{ job.end_date }}{% else %} &ndash; heute{% endif %}
                                        </span>
                                        {% endif %}
                                        {% if dur_text %}
                                        <span style="font-size: 11px; font-weight: 650; padding: 3px 10px; border-radius: 8px; background: var(--pp-surfaceHover); color: {% if is_first %}var(--pp-accent){% else %}var(--pp-textMuted){% endif %}; white-space: nowrap;">
                                            {{ dur_text }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {# Tasks/Description #}
                                {% if job.description and job.description != 'null' and job.description != 'None' %}
                                <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 6px;">
                                    {% for line in job.description.split('\n') %}
                                    {% set clean_line = line.strip().lstrip('•').lstrip('-').lstrip('–').strip() %}
                                    {% if clean_line and clean_line != 'None' and clean_line != 'null' %}
                                    <div style="display: flex; gap: 8px; font-size: 13px; color: var(--pp-text); line-height: 1.55;">
                                        <span style="color: var(--pp-border); margin-top: 2px; flex-shrink: 0; font-size: 6px; line-height: 22px;">&#x25CF;</span>
                                        <span>{{ clean_line }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F4BC;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Berufserfahrung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 400ms;" id="it-skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BB;</span> IT-Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.it_skills and candidate.it_skills | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        {% for skill in candidate.it_skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {% set sk_low = skill.lower() %}
                        {% set is_core = sk_low in ['sap', 'sap s/4hana', 'sap-sem-bcs', 'sap fi', 'sap co', 'sap mm', 'sap bcs', 'cch tagetik', 'datev', 'addison', 'oracle', 'navision', 'dynamics', 'lucanet', 'sigma', 'hyperion', 'cognos', 'jedox', 'board', 'anaplan'] or 'sap' in sk_low or 'erp' in sk_low or 'datev' in sk_low or 'tagetik' in sk_low or 'lucanet' in sk_low or 'konsolidierung' in sk_low or 'hyperion' in sk_low or 'cognos' in sk_low %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid {% if is_core %}var(--pp-accent){% else %}var(--pp-border){% endif %};">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% if is_core %}
                                <span style="font-size: 9px; font-weight: 700; padding: 2px 7px; border-radius: 5px; background: var(--pp-accent); color: #fff; text-transform: uppercase; letter-spacing: 0.05em;">CORE</span>
                                {% endif %}
                                <span style="font-size: 13.5px; font-weight: 680; color: var(--pp-text);">{{ skill }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F4BB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine IT-Kenntnisse hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 500ms;" id="languages">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F310;</span> Sprachen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.languages and candidate.languages is iterable and candidate.languages is not string and candidate.languages | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        {% for lang in candidate.languages %}{% if lang is mapping %}
                        {% set lang_name = lang.language | default('Unbekannt') %}
                        {% set lang_level = lang.level | default('') %}
                        {% set is_native = 'mutter' in lang_level.lower() if lang_level else false %}
                        {% set pct = 100 if is_native else (95 if 'flie' in lang_level.lower() else (85 if 'verhandlung' in lang_level.lower() else (70 if 'gut' in lang_level.lower() else (50 if 'grund' in lang_level.lower() else 60)))) if lang_level else 50 %}
                        <div style="display: flex; align-items: center; gap: 12px; padding: 5px 0;">
                            <div style="width: 80px; font-size: 13px; font-weight: 650; color: var(--pp-text);">{{ lang_name }}</div>
                            <div style="flex: 1;">
                                <div class="kd-lang-bar">
                                    <div class="kd-lang-fill" style="width: {{ pct }}%; background: {% if is_native %}var(--pp-green){% else %}var(--pp-accent){% endif %};"></div>
                                </div>
                            </div>
                            {% if lang_level and lang_level != 'None' and lang_level != 'null' %}
                            <div style="font-size: 11.5px; color: var(--pp-textMuted); font-weight: 500; min-width: 180px; text-align: right;">{{ lang_level }}</div>
                            {% endif %}
                        </div>
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F310;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Sprachen hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 600ms;" id="skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F9E9;</span> Skills &amp; Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.skills and candidate.skills | length > 0 %}
                    {# Legend #}
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: var(--pp-purple);"></span> Fachlich
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: var(--pp-green);"></span> Technisch
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: var(--pp-orange);"></span> Sonstige
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        {% for skill in candidate.skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {# Heuristic: tech keywords → green, fach (finance/accounting) → indigo, soft skills → amber #}
                        {% set sk_low = skill.lower() %}
                        {% set is_tech = sk_low in ['sap', 'excel', 'word', 'powerpoint', 'outlook', 'teams', 'python', 'sql', 'javascript', 'html', 'css', 'r', 'tableau', 'power bi', 'datev', 'addison'] or 'microsoft' in sk_low or 'sap' in sk_low or 'office' in sk_low or 'software' in sk_low or 'erp' in sk_low or 'it' == sk_low or 'edv' in sk_low %}
                        {% set is_soft = 'kommunikation' in sk_low or 'führung' in sk_low or 'team' in sk_low or 'management' in sk_low or 'organisation' in sk_low or 'präsentation' in sk_low or 'verhandlung' in sk_low or 'coaching' in sk_low or 'moderation' in sk_low or 'motivation' in sk_low or 'analytisch' in sk_low %}
                        <span class="{% if is_tech %}skill-tech{% elif is_soft %}skill-soft{% else %}skill-fach{% endif %}" style="font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px;">{{ skill }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F9E9;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Skills hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 700ms;" id="certifications">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F393;</span> Zertifikate &amp; Weiterbildungen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.further_education and candidate.further_education is iterable and candidate.further_education is not string and candidate.further_education | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        {% for wb in candidate.further_education %}{% if wb is mapping %}
                        {% set wb_name = wb.degree if (wb.degree and wb.degree != 'None' and wb.degree != 'null') else (wb.qualification if (wb.qualification and wb.qualification != 'None' and wb.qualification != 'null') else '') %}
                        {% set wb_inst = wb.institution | default('') %}
                        {% if wb_inst == 'None' or wb_inst == 'null' %}{% set wb_inst = '' %}{% endif %}
                        {% set wb_start = wb.start_date | default('') %}
                        {% if wb_start == 'None' or wb_start == 'null' %}{% set wb_start = '' %}{% endif %}
                        {% set wb_end = wb.end_date | default('') %}
                        {% if wb_end == 'None' or wb_end == 'null' %}{% set wb_end = '' %}{% endif %}
                        {% set wb_year = wb.year | default('') %}
                        {% if wb_year == 'None' or wb_year == 'null' %}{% set wb_year = '' %}{% endif %}
                        {% if wb_start and wb_end %}
                            {% set wb_timerange = wb_start ~ ' – ' ~ wb_end %}
                        {% elif wb_start %}
                            {% set wb_timerange = 'ab ' ~ wb_start %}
                        {% elif wb_end %}
                            {% set wb_timerange = wb_end %}
                        {% elif wb_year %}
                            {% set wb_timerange = wb_year %}
                        {% else %}
                            {% set wb_timerange = '' %}
                        {% endif %}
                        {# Generische Einträge ohne Details dezenter darstellen #}
                        {% set is_generic = wb_name.lower() in ['seminar', 'e-learning', 'kurs', 'workshop', 'webinar', 'schulung', 'weiterbildung', ''] and not wb_inst %}
                        {% if wb_name %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border); {% if is_generic %}opacity: 0.7;{% endif %}">
                            <div>
                                <div style="font-size: 13.5px; font-weight: {% if is_generic %}550{% else %}650{% endif %}; color: {% if is_generic %}var(--pp-textMuted){% else %}var(--pp-text){% endif %};">
                                    {{ wb_name }}{% if is_generic and not wb_inst %} <span style="font-size: 11px; color: var(--pp-textDim); font-weight: 400; font-style: italic;">(ohne Details)</span>{% endif %}
                                </div>
                                {% if wb_inst %}
                                <div style="font-size: 12px; color: var(--pp-textDim); margin-top: 2px; font-weight: 500;">{{ wb_inst }}</div>
                                {% endif %}
                            </div>
                            {% if wb_timerange %}
                            <span style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600; background: var(--pp-surfaceHover); padding: 3px 10px; border-radius: 6px; white-space: nowrap;">{{ wb_timerange }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F393;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Zertifikate hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 800ms;" id="education">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4DA;</span> Ausbildung</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.education and candidate.education is iterable and candidate.education is not string and candidate.education | length > 0 %}
                    {% for edu in candidate.education %}{% if edu is mapping %}
                    {% set edu_name = edu.degree if (edu.degree and edu.degree != 'None' and edu.degree != 'null') else (edu.qualification if (edu.qualification and edu.qualification != 'None' and edu.qualification != 'null') else 'Ausbildung') %}
                    {% set edu_inst = edu.institution | default(edu.school | default('')) %}
                    {% set edu_start = edu.start_date | default('') %}
                    {% if edu_start == 'None' or edu_start == 'null' %}{% set edu_start = '' %}{% endif %}
                    {% set edu_end = edu.end_date | default('') %}
                    {% if edu_end == 'None' or edu_end == 'null' %}{% set edu_end = '' %}{% endif %}
                    {% set edu_year = edu.year | default('') %}
                    {% if edu_year == 'None' or edu_year == 'null' %}{% set edu_year = '' %}{% endif %}
                    {% if edu_start and edu_end %}
                        {% set edu_timerange = edu_start ~ ' – ' ~ edu_end %}
                    {% elif edu_start %}
                        {% set edu_timerange = 'ab ' ~ edu_start %}
                    {% elif edu_end %}
                        {% set edu_timerange = edu_end %}
                    {% elif edu_year %}
                        {% set edu_timerange = edu_year %}
                    {% else %}
                        {% set edu_timerange = '' %}
                    {% endif %}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border);">
                        <div>
                            <div style="font-size: 14px; font-weight: 680; color: var(--pp-text);">{{ edu_name }}</div>
                            {% if edu_inst and edu_inst != 'None' and edu_inst != 'null' %}
                            <div style="font-size: 12.5px; color: var(--pp-textMuted); margin-top: 2px; font-weight: 500;">{{ edu_inst }}</div>
                            {% endif %}
                        </div>
                        {% if edu_timerange %}
                        <span style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600; background: var(--pp-surfaceHover); padding: 3px 10px; border-radius: 6px; white-space: nowrap;">{{ edu_timerange }}</span>
                        {% endif %}
                    </div>
                    {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F4DA;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Ausbildung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>

            {# ═══ TAB: E-Mails (Automatisierung) ═══ #}
            <div x-show="activeTab === 'emails'" x-cloak x-data="emailAutomationManager()" style="display:flex; flex-direction:column; gap:20px;">

                {# ── Status-Banner ── #}
                <div class="kd-section kd-anim" style="animation-delay:50ms;">
                    <div style="padding:16px 24px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px;"
                                 :style="contactStatus === 'email_sequenz_aktiv' ? 'background:var(--pp-orangeSoft);' : contactStatus === 'sequenz_abgeschlossen' ? 'background:var(--pp-greenSoft);' : contactStatus === 'kein_interesse' ? 'background:var(--pp-redSoft);' : 'background:var(--pp-accentSoft);'">
                                <span x-show="contactStatus === 'email_sequenz_aktiv'">&#x23F3;</span>
                                <span x-show="contactStatus === 'sequenz_abgeschlossen'">&#x2705;</span>
                                <span x-show="contactStatus === 'kein_interesse'">&#x1F6AB;</span>
                                <span x-show="!contactStatus || (contactStatus !== 'email_sequenz_aktiv' && contactStatus !== 'sequenz_abgeschlossen' && contactStatus !== 'kein_interesse')">&#x1F4E7;</span>
                            </div>
                            <div>
                                <div style="font-size:14px; font-weight:700; color:var(--pp-text);" x-text="statusLabel"></div>
                                <div style="font-size:12px; color:var(--pp-textMuted); margin-top:2px;" x-text="statusDescription"></div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <template x-if="!contactStatus || contactStatus === 'neu' || contactStatus === 'sequenz_abgeschlossen'">
                                <button type="button" @click="startSequenz()" class="kd-quickbtn" style="background:var(--pp-orangeSoft); color:var(--pp-orange); border:1px solid rgba(234,179,8,0.25); font-size:12px;">
                                    &#x1F4E7; Sequenz starten
                                </button>
                            </template>
                            <template x-if="contactStatus === 'email_sequenz_aktiv'">
                                <span style="font-size:11px; font-weight:700; padding:5px 12px; border-radius:8px; background:var(--pp-orangeSoft); color:var(--pp-orange);">Sequenz l&auml;uft...</span>
                            </template>
                        </div>
                    </div>
                </div>

                {# ── E-Mail-Verlauf ── #}
                <div class="kd-section kd-anim" style="animation-delay:100ms;">
                    <div class="kd-section-header">
                        <div class="kd-section-title"><span>&#x1F4E8;</span> E-Mail-Verlauf</div>
                        <span style="font-size:12px; font-weight:600; color:var(--pp-textDim);" x-text="emails.length + ' E-Mails'"></span>
                    </div>
                    <div class="kd-section-body" style="padding:12px 24px 16px;">

                        {# ── E-Mail-Liste ── #}
                        <div style="display:flex; flex-direction:column; gap:8px; width:100%; overflow:hidden;">
                            <template x-for="email in emails" :key="email.id">
                                <div style="border-radius:12px; border:1px solid var(--pp-border); transition:all .2s; background:var(--pp-surface); overflow:hidden;"
                                     :style="email.direction === 'inbound' ? 'border-color:rgba(34,197,94,0.2);' : email.send_error ? 'border-color:rgba(239,68,68,0.3); background:rgba(239,68,68,0.04);' : ''">

                                    {# ── Hauptzeile ── #}
                                    <div style="padding:12px 16px; display:flex; align-items:center; gap:10px; cursor:pointer;" @click="email._open = !email._open">
                                        {# Richtungs-Icon #}
                                        <div style="flex-shrink:0; width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:13px;"
                                             :style="email.direction === 'inbound' ? 'background:var(--pp-greenSoft);' : email.send_error ? 'background:var(--pp-redSoft);' : 'background:var(--pp-accentSoft);'">
                                            <span x-show="email.direction === 'outbound' && !email.send_error">&#x2197;</span>
                                            <span x-show="email.direction === 'inbound'">&#x2199;</span>
                                            <span x-show="email.send_error">&#x26A0;</span>
                                        </div>

                                        {# Betreff + Meta #}
                                        <div style="flex:1; min-width:0;">
                                            <div style="display:flex; align-items:center; gap:8px;">
                                                <span style="font-size:13.5px; font-weight:600; color:var(--pp-text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" x-text="email.subject || '(Kein Betreff)'"></span>
                                                <template x-if="email.sequence_step">
                                                    <span style="font-size:10px; font-weight:700; padding:2px 7px; border-radius:6px; background:var(--pp-accentSoft); color:var(--pp-accent); white-space:nowrap;" x-text="'Schritt ' + email.sequence_step"></span>
                                                </template>
                                                <template x-if="email.channel">
                                                    <span style="font-size:10px; font-weight:600; padding:2px 6px; border-radius:5px; background:var(--pp-surfaceHover); color:var(--pp-textDim); text-transform:uppercase;" x-text="email.channel"></span>
                                                </template>
                                            </div>
                                            <div style="font-size:11px; color:var(--pp-textDim); margin-top:2px; display:flex; gap:8px;">
                                                <span x-text="email.direction === 'outbound' ? 'An: ' + (email.to_address || '–') : 'Von: ' + (email.from_address || '–')"></span>
                                            </div>
                                        </div>

                                        {# Datum #}
                                        <span style="font-size:11px; font-weight:600; color:var(--pp-textDim); white-space:nowrap;" x-text="email.created_formatted"></span>

                                        {# Pfeil #}
                                        <svg :style="email._open ? 'transform:rotate(180deg)' : ''" width="14" height="14" style="color:var(--pp-textDim); flex-shrink:0; transition:transform .2s;" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                                    </div>

                                    {# ── Aufklapp-Detail (E-Mail-Body) ── #}
                                    <div x-show="email._open" x-transition.duration.150ms style="border-top:1px solid var(--pp-borderLight); padding:16px; background:var(--pp-surfaceHover);">
                                        <template x-if="email.send_error">
                                            <div style="margin-bottom:10px; padding:8px 12px; border-radius:8px; background:var(--pp-redSoft); border:1px solid rgba(239,68,68,0.2); font-size:12px; color:var(--pp-red);">
                                                <strong>Fehler:</strong> <span x-text="email.send_error"></span>
                                            </div>
                                        </template>
                                        <div style="font-size:13px; color:var(--pp-textMuted); line-height:1.65; max-height:400px; overflow-y:auto;" x-html="email.body_html || email.body_text || '<em style=\'color:var(--pp-textDim);\'>Kein Inhalt</em>'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        {# Empty State #}
                        <template x-if="emails.length === 0">
                            <div style="display:flex; flex-direction:column; align-items:center; padding:28px 0;">
                                <div style="font-size:28px; margin-bottom:6px; opacity:0.25;">&#x1F4E8;</div>
                                <div style="font-size:13px; font-weight:600; color:var(--pp-textDim);">Noch keine E-Mails</div>
                                <div style="font-size:11px; color:var(--pp-text4); margin-top:3px;">Klicke &quot;Nicht erreicht&quot; um die E-Mail-Sequenz zu starten</div>
                            </div>
                        </template>
                    </div>
                </div>

                {# ── Automatisierungs-Aufgaben ── #}
                <template x-if="tasks.length > 0">
                    <div class="kd-section kd-anim" style="animation-delay:200ms;">
                        <div class="kd-section-header">
                            <div class="kd-section-title"><span>&#x1F4CB;</span> Automatisierungs-Aufgaben</div>
                            <span style="font-size:12px; font-weight:600; color:var(--pp-textDim);" x-text="tasks.filter(t => t.status === 'open').length + ' offen'"></span>
                        </div>
                        <div class="kd-section-body" style="padding:12px 24px 16px;">
                            <div style="display:flex; flex-direction:column; gap:6px;">
                                <template x-for="task in tasks" :key="task.id">
                                    <div style="padding:10px 14px; border-radius:12px; border:1px solid var(--pp-border); background:var(--pp-bg); display:flex; align-items:center; gap:10px;"
                                         :style="task.status === 'done' ? 'opacity:0.5;' : ''">
                                        {# Status-Icon #}
                                        <button type="button" @click="toggleTask(task)"
                                            style="flex-shrink:0; width:20px; height:20px; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0;"
                                            :style="task.status === 'done' ? 'border:2px solid var(--pp-green); background:var(--pp-green);' : 'border:2px solid var(--pp-text4); background:transparent;'">
                                            <svg x-show="task.status === 'done'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>
                                        </button>
                                        <div style="flex:1; min-width:0;">
                                            <div style="font-size:13px; font-weight:600;"
                                                 :style="task.status === 'done' ? 'color:var(--pp-textDim); text-decoration:line-through;' : 'color:var(--pp-text);'"
                                                 x-text="task.title"></div>
                                            <template x-if="task.description">
                                                <div style="font-size:11px; color:var(--pp-textDim); margin-top:2px; line-height:1.4;" x-text="task.description"></div>
                                            </template>
                                        </div>
                                        <template x-if="task.due_date">
                                            <span style="font-size:11px; font-weight:600; color:var(--pp-textDim); white-space:nowrap;" x-text="task.due_date_formatted"></span>
                                        </template>
                                        <span style="font-size:9px; font-weight:700; padding:2px 6px; border-radius:5px; text-transform:uppercase; letter-spacing:0.5px;"
                                              :style="task.source === 'gpt' ? 'background:var(--pp-purpleSoft); color:var(--pp-purple);' : task.source === 'system' ? 'background:var(--pp-accentSoft); color:var(--pp-accent);' : 'background:var(--pp-surfaceHover); color:var(--pp-textDim);'"
                                              x-text="task.source"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

        </div>

        {# ── RIGHT SIDEBAR ── #}
        <div style="width: 300px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px; position: sticky; top: 80px; align-self: flex-start;">

            {# E-Mail-Sequenz-Status #}
            {% if candidate.contact_status %}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 150ms;">
                <div class="kd-sidebar-header">
                    E-Mail-Status
                    <span style="font-size:10px; font-weight:700; padding:2px 8px; border-radius:6px;
                        {% if candidate.contact_status == 'email_sequenz_aktiv' %}background:var(--pp-orangeSoft); color:var(--pp-orange);
                        {% elif candidate.contact_status == 'sequenz_abgeschlossen' %}background:var(--pp-greenSoft); color:var(--pp-green);
                        {% elif candidate.contact_status == 'kein_interesse' %}background:var(--pp-redSoft); color:var(--pp-red);
                        {% else %}background:var(--pp-accentSoft); color:var(--pp-accent);{% endif %}">
                        {% if candidate.contact_status == 'email_sequenz_aktiv' %}Aktiv
                        {% elif candidate.contact_status == 'sequenz_abgeschlossen' %}Fertig
                        {% elif candidate.contact_status == 'kein_interesse' %}Kein Int.
                        {% else %}{{ candidate.contact_status }}{% endif %}
                    </span>
                </div>
                <div class="kd-sidebar-body" style="padding:10px 16px;">
                    <div style="font-size:12px; color:var(--pp-textMuted); line-height:1.5;">
                        {% if candidate.contact_status == 'email_sequenz_aktiv' %}
                        3-stufige E-Mail-Sequenz l&auml;uft automatisch.
                        {% elif candidate.contact_status == 'sequenz_abgeschlossen' %}
                        Alle E-Mails wurden versendet.
                        {% elif candidate.contact_status == 'kein_interesse' %}
                        Kandidat hat kein Interesse.
                        {% else %}
                        Status: {{ candidate.contact_status }}
                        {% endif %}
                    </div>
                    {% if seq_emails_json and seq_emails_json | length > 0 %}
                    <div style="font-size:11px; color:var(--pp-textDim); margin-top:6px;">
                        {{ seq_emails_json | length }} E-Mail(s) gesendet
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Pipeline-Status #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 250ms;">
                <div class="kd-sidebar-header">
                    Pipeline-Status
                    <a href="/ats/pipeline" style="font-size: 11px; font-weight: 600; color: var(--pp-accent); text-decoration: none;">Pipeline &rarr;</a>
                </div>
                <div id="candidate-pipeline" hx-get="/partials/candidate-pipeline/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 12px 0;">
                        <div style="font-size: 20px; margin-bottom: 4px; opacity: 0.4;">&#x1F4CB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim); text-align: center;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# Passende Jobs #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 350ms;">
                <div class="kd-sidebar-header">Passende Jobs</div>
                <div id="matching-jobs" hx-get="/partials/candidate-jobs/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 8px 0;">
                        <div style="font-size: 12px; color: var(--pp-textDim); text-align: center; font-weight: 500;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# CV-Status + Upload #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 450ms;"
                 x-data="{ cvUploading: false, cvDragging: false }">
                <div class="kd-sidebar-body" style="padding: 12px 14px;">
                    {# Header Row: Icon + Title + Badge #}
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="flex items-center justify-center rounded-lg" style="width: 32px; height: 32px; background: var(--pp-accentSoft);">
                                <svg class="w-4 h-4" style="color: var(--pp-accent);" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                            </div>
                            <span style="font-size: 13px; font-weight: 700; color: var(--pp-text);">Lebenslauf</span>
                        </div>
                        {% if candidate.cv_url or candidate.cv_stored_path %}
                        <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[10px] font-bold uppercase tracking-wide" style="background: var(--pp-greenSoft); color: var(--pp-green);">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            Vorhanden
                        </span>
                        {% else %}
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] font-bold uppercase tracking-wide" style="background: var(--pp-redSoft); color: var(--pp-red);">Fehlt</span>
                        {% endif %}
                    </div>

                    {% if candidate.cv_parsed_at %}
                    {# Parsed info - compact inline #}
                    <div class="flex items-center gap-1.5 mb-3" style="font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                        <svg class="w-3.5 h-3.5 flex-shrink-0" style="color: var(--pp-textDim);" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Zuletzt geparst: <span style="color: var(--pp-text); font-weight: 600;">{{ candidate.cv_parsed_at.strftime('%d.%m.%Y %H:%M') }}</span></span>
                    </div>
                    {% endif %}

                    {# Upload Zone - kompakt #}
                    <div class="rounded-lg transition-all duration-200 cursor-pointer"
                         style="border: 1.5px dashed var(--pp-border); padding: 14px; text-align: center; background: var(--pp-bg);"
                         :style="cvUploading ? 'opacity: 0.5; pointer-events: none;' : cvDragging ? 'border-color: var(--pp-accent); background: var(--pp-accentSoft);' : ''"
                         @dragover.prevent="cvDragging = true"
                         @dragenter.prevent="cvDragging = true"
                         @dragleave.prevent="cvDragging = false"
                         @drop.prevent="cvDragging = false; if ($event.dataTransfer.files.length) { let f = $event.dataTransfer.files[0]; if (f.name.toLowerCase().endsWith('.pdf')) { cvUploading = true; let fd = new FormData(); fd.append('file', f); fetch('/api/candidates/{{ candidate.id }}/upload-cv', { method: 'POST', body: fd }).then(r => r.json()).then(d => { cvUploading = false; if (d.success) { showToast('CV hochgeladen — wird verarbeitet...', 'success'); setTimeout(() => location.reload(), 3000); } else { showToast(d.message || 'Upload fehlgeschlagen', 'error'); } }).catch(() => { cvUploading = false; showToast('Upload fehlgeschlagen', 'error'); }); } else { showToast('Nur PDF-Dateien erlaubt', 'warning'); } }"
                         @click="$refs.cvFileInput.click()">
                        <input type="file" accept=".pdf" class="hidden" x-ref="cvFileInput"
                               @change="if ($event.target.files.length) { let f = $event.target.files[0]; if (!f.name.toLowerCase().endsWith('.pdf')) { showToast('Nur PDF-Dateien erlaubt', 'warning'); return; } cvUploading = true; let fd = new FormData(); fd.append('file', f); fetch('/api/candidates/{{ candidate.id }}/upload-cv', { method: 'POST', body: fd }).then(r => r.json()).then(d => { cvUploading = false; if (d.success) { showToast('CV hochgeladen — wird verarbeitet...', 'success'); setTimeout(() => location.reload(), 3000); } else { showToast(d.message || 'Upload fehlgeschlagen', 'error'); } }).catch(() => { cvUploading = false; showToast('Upload fehlgeschlagen', 'error'); }); $event.target.value = ''; }">
                        <div class="flex items-center justify-center gap-2">
                            <svg x-show="!cvUploading" class="w-4 h-4" style="color: var(--pp-textDim);" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                            <span x-show="!cvUploading && !cvDragging" style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600;">PDF hochladen oder hierhin ziehen</span>
                            <span x-show="cvDragging" x-cloak style="font-size: 12px; color: var(--pp-accent); font-weight: 600;">Hier ablegen</span>
                            <span x-show="cvUploading" x-cloak style="font-size: 12px; color: var(--pp-accent); font-weight: 600;">Wird hochgeladen...</span>
                        </div>
                    </div>

                    {% if candidate.cv_url or candidate.cv_stored_path %}
                    <button type="button" hx-post="/api/candidates/{{ candidate.id }}/reparse-cv" hx-swap="none"
                            hx-on::after-request="showToast('CV wird neu geparst...', 'info'); setTimeout(() => location.reload(), 3000)"
                            class="w-full mt-2.5 py-2 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                            style="background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-text); font-family: inherit;"
                            onmouseenter="this.style.borderColor='var(--pp-accent)';this.style.color='var(--pp-accent)'"
                            onmouseleave="this.style.borderColor='var(--pp-border)';this.style.color='var(--pp-text)'">
                        <span class="flex items-center justify-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182M4.031 9.865l-.001-.001" /></svg>
                            CV neu parsen
                        </span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

{# CV-Vorschau Slide-Over Panel #}
{% if candidate.cv_url or candidate.cv_stored_path %}
<div id="cv-preview-overlay" class="hidden" style="z-index: 9999; position: fixed; top: 0; left: 0; right: 0; bottom: 0; zoom: calc(1 / 1.15);">
    <div class="cv-overlay-bg transition-opacity duration-300 ease-in-out opacity-0" style="position: absolute; inset: 0; background: rgba(0,0,0,0.7); cursor: pointer;" onclick="closeCvPreview()"></div>
    <div style="position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 42rem; pointer-events: none;">
        <div id="cv-preview-panel" style="pointer-events: auto; height: 100%; transform: translateX(100%); transition: transform 300ms ease-in-out;">
            <div style="display: flex; flex-direction: column; height: 100%; box-shadow: -4px 0 24px rgba(0,0,0,0.4); font-family: 'Outfit', sans-serif; background: var(--pp-surface);">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--pp-surfaceHover); border-bottom: 1px solid var(--pp-border);">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 700; margin: 0; color: var(--pp-text);">CV-Vorschau</h2>
                        <p style="font-size: 13px; margin: 2px 0 0; color: var(--pp-textDim);">{{ display_name }}</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <a href="/api/candidates/{{ candidate.id }}/cv-preview" target="_blank" class="kd-quickbtn" style="font-size: 11.5px; padding: 7px 12px;">&#x2197; Neuer Tab</a>
                        <button type="button" onclick="closeCvPreview()" style="background: var(--pp-surface); border: 1px solid var(--pp-border); border-radius: 8px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--pp-textMuted); font-size: 18px; font-weight: bold; z-index: 10;">&#x2715;</button>
                    </div>
                </div>
                <div style="flex: 1; overflow: hidden; position: relative;">
                    <iframe id="cv-preview-iframe" src="" style="width: 100%; height: 100%; border: 0;" title="CV-Vorschau"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// ==================== Recruiting-Daten (Phase 2) ====================
function recruitingFields() {
    return {
        currentSource: {{ (candidate.source or '') | tojson | safe }} || '',
        currentWillingness: {{ (candidate.willingness_to_change or '') | tojson | safe }} || '',
        lastContactDate: {{ (candidate.last_contact.strftime('%Y-%m-%d') if candidate.last_contact else '') | tojson | safe }},
        showNewNote: false,
        newNoteTitle: '',
        newNoteContent: '',
        newNoteDate: new Date().toISOString().split('T')[0],
        showSourceDropdown: false,
        sourceOptions: ['StepStone', 'Xing', 'LinkedIn', 'Indeed', 'Empfehlung', 'CRM', 'Direktansprache', 'Jobboerse', 'Sonstiges'],

        async setSource(src) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: src })
                });
                if (response.ok) {
                    this.currentSource = src;
                    this.showSourceDropdown = false;
                    if (typeof showToast === 'function') showToast('Quelle gespeichert', 'success');
                }
            } catch (err) { console.error('Quelle speichern fehlgeschlagen:', err); }
        },

        async setWillingness(val) {
            var candidateId = '{{ candidate.id }}';
            var newVal = this.currentWillingness === val ? null : val;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ willingness_to_change: newVal })
                });
                if (response.ok) {
                    this.currentWillingness = newVal || '';
                    if (typeof showToast === 'function') showToast('Wechselbereitschaft gespeichert', 'success');
                }
            } catch (err) { console.error('Wechselbereitschaft speichern fehlgeschlagen:', err); }
        },

        async setLastContact() {
            var candidateId = '{{ candidate.id }}';
            var dateVal = this.lastContactDate ? new Date(this.lastContactDate).toISOString() : null;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ last_contact: dateVal })
                });
                if (response.ok) {
                    if (typeof showToast === 'function') showToast('Letzter Kontakt gespeichert', 'success');
                }
            } catch (err) { console.error('Letzter Kontakt speichern fehlgeschlagen:', err); }
        },

        async setLastContactNow() {
            var today = new Date();
            this.lastContactDate = today.toISOString().split('T')[0];
            await this.setLastContact();
        },

        async createNote() {
            var content = this.newNoteContent.trim();
            if (!content) return;
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId + '/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        title: this.newNoteTitle.trim() || null,
                        note_date: this.newNoteDate || null,
                    })
                });
                if (response.ok) {
                    this.newNoteTitle = '';
                    this.newNoteContent = '';
                    this.newNoteDate = new Date().toISOString().split('T')[0];
                    this.showNewNote = false;
                    htmx.ajax('GET', '/partials/candidate/' + candidateId + '/notes', { target: '#candidate-notes-list', swap: 'innerHTML' });
                    if (typeof showToast === 'function') showToast('Notiz gespeichert', 'success');
                } else {
                    if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
                }
            } catch (err) {
                console.error('Notiz erstellen fehlgeschlagen:', err);
                if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
            }
        }
    };
}

// ==================== Kandidaten-Notizen: Loeschen ====================
async function deleteCandidateNote(noteId, candidateId) {
    if (!confirm('Notiz wirklich loeschen?')) return;
    try {
        var response = await fetch('/api/candidates/notes/' + noteId, { method: 'DELETE' });
        if (response.ok) {
            htmx.ajax('GET', '/partials/candidate/' + candidateId + '/notes', { target: '#candidate-notes-list', swap: 'innerHTML' });
            if (typeof showToast === 'function') showToast('Notiz geloescht', 'success');
        } else {
            if (typeof showToast === 'function') showToast('Fehler beim Loeschen', 'error');
        }
    } catch (err) {
        console.error('Notiz loeschen fehlgeschlagen:', err);
        if (typeof showToast === 'function') showToast('Fehler beim Loeschen', 'error');
    }
}

// ==================== Pipeline-Daten (ERP + Rating) ====================
function pipelineFields() {
    return {
        newErp: '',
        currentRating: {{ candidate.rating or 0 }},
        currentErp: {{ (candidate.erp or []) | tojson | safe }},

        async addErp() {
            var val = this.newErp.trim();
            if (!val) return;
            var items = val.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
            var merged = this.currentErp.concat(items);
            merged = merged.filter(function(v, i, a) { return a.indexOf(v) === i; });
            await this.saveErp(merged);
            this.newErp = '';
        },

        async removeErp(item) {
            var filtered = this.currentErp.filter(function(e) { return e !== item; });
            await this.saveErp(filtered);
        },

        async saveErp(erpList) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ erp: erpList })
                });
                if (response.ok) {
                    this.currentErp = erpList;
                    if (typeof showToast === 'function') showToast('ERP gespeichert', 'success');
                    setTimeout(function() { location.reload(); }, 500);
                }
            } catch (err) { console.error('ERP speichern fehlgeschlagen:', err); }
        },

        async setRating(value) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: value })
                });
                if (response.ok) {
                    this.currentRating = value;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = i <= value ? 'var(--pp-orange)' : 'var(--pp-border)'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung gespeichert', 'success');
                }
            } catch (err) { console.error('Rating speichern fehlgeschlagen:', err); }
        },

        async clearRating() {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: null })
                });
                if (response.ok) {
                    this.currentRating = 0;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = 'var(--pp-border)'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung entfernt', 'success');
                }
            } catch (err) { console.error('Rating entfernen fehlgeschlagen:', err); }
        }
    };
}

// ==================== Anrufprotokoll (Gespräche-Tab) ====================
function callLogTimeline() {
    var candidateId = '{{ candidate.id }}';
    var typeLabels = { 'acquisition': 'Akquise', 'qualification': 'Qualifizierung', 'followup': 'Nachfassen', 'candidate_call': 'Kandidatengespr\u00e4ch' };
    return {
        calls: [
            {% for note in call_notes %}
            {
                id: '{{ note.id }}',
                call_type: '{{ note.call_type.value }}',
                call_type_label: '{{ note.call_type_label }}',
                summary: {{ (note.summary or '') | tojson | safe }},
                direction: {{ (note.direction.value if note.direction else None) | tojson | safe }},
                duration_minutes: {{ note.duration_minutes | tojson | safe }},
                called_at: {{ (note.called_at.isoformat() if note.called_at else None) | tojson | safe }}
            }{{ ',' if not loop.last }}
            {% endfor %}
        ],
        showAddCall: false,
        saving: false,
        newCall: {
            called_at: new Date().toISOString().slice(0, 16),
            call_type: 'candidate_call',
            direction: 'outbound',
            summary: ''
        },
        formatDate(isoStr) {
            if (!isoStr) return '';
            var d = new Date(isoStr);
            return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ', ' + d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        },
        async saveNewCall() {
            if (!this.newCall.summary.trim()) return;
            this.saving = true;
            try {
                var payload = {
                    candidate_id: candidateId,
                    call_type: this.newCall.call_type,
                    direction: this.newCall.direction,
                    summary: this.newCall.summary.trim(),
                    called_at: this.newCall.called_at ? new Date(this.newCall.called_at).toISOString() : null
                };
                var response = await fetch('/api/ats/calls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    var result = await response.json();
                    this.calls.unshift({
                        id: result.id,
                        call_type: this.newCall.call_type,
                        call_type_label: typeLabels[this.newCall.call_type] || this.newCall.call_type,
                        summary: this.newCall.summary.trim(),
                        direction: this.newCall.direction,
                        duration_minutes: null,
                        called_at: this.newCall.called_at ? new Date(this.newCall.called_at).toISOString() : new Date().toISOString()
                    });
                    this.newCall = { called_at: new Date().toISOString().slice(0, 16), call_type: 'candidate_call', direction: 'outbound', summary: '' };
                    this.showAddCall = false;
                    if (typeof showToast === 'function') showToast('Anruf protokolliert', 'success');
                } else {
                    if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
                }
            } catch (err) {
                console.error('CallNote erstellen fehlgeschlagen:', err);
                if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
            }
            this.saving = false;
        },
        async deleteCall(callId, idx) {
            if (!confirm('Anruf wirklich l\u00f6schen?')) return;
            try {
                var response = await fetch('/api/ats/calls/' + callId, { method: 'DELETE' });
                if (response.ok) {
                    this.calls.splice(idx, 1);
                    if (typeof showToast === 'function') showToast('Anruf gel\u00f6scht', 'success');
                }
            } catch (err) { console.error('CallNote l\u00f6schen fehlgeschlagen:', err); }
        }
    };
}

// ==================== Qualifizierungsgespräch ====================
function qualificationFields() {
    return {
        qfSaving: false,
        showTransportDd: false,
        showEmpTypeDd: false,
        showCallTypeDd: false,
        qfCallDate: {{ (candidate.call_date.strftime('%Y-%m-%d') if candidate.call_date else '') | tojson | safe }},
        callTypeOptions: [
            { value: 'qualifizierung', label: 'Qualifizierungsgespräch' },
            { value: 'kurz', label: 'Kurzer Call' },
            { value: 'kunde', label: 'Kundengespräch' },
            { value: 'sonstig', label: 'Sonstiges' }
        ],
        callTypeLabels: { 'qualifizierung': 'Qualifizierungsgespräch', 'kurz': 'Kurzer Call', 'kunde': 'Kundengespräch', 'sonstig': 'Sonstiges' },
        qf: {
            desired_positions: {{ (candidate.desired_positions or '') | tojson | safe }},
            key_activities: {{ (candidate.key_activities or '') | tojson | safe }},
            home_office_days: {{ (candidate.home_office_days or '') | tojson | safe }},
            commute_max: {{ (candidate.commute_max or '') | tojson | safe }},
            commute_transport: {{ (candidate.commute_transport or '') | tojson | safe }},
            erp_main: {{ (candidate.erp_main or '') | tojson | safe }},
            employment_type: {{ (candidate.employment_type or '') | tojson | safe }},
            part_time_hours: {{ (candidate.part_time_hours or '') | tojson | safe }},
            preferred_industries: {{ (candidate.preferred_industries or '') | tojson | safe }},
            avoided_industries: {{ (candidate.avoided_industries or '') | tojson | safe }},
            open_office_ok: {{ (candidate.open_office_ok or '') | tojson | safe }},
            whatsapp_ok: {{ 'true' if candidate.whatsapp_ok == true else ('false' if candidate.whatsapp_ok == false else 'null') }},
            other_recruiters: {{ (candidate.other_recruiters or '') | tojson | safe }},
            exclusivity_agreed: {{ 'true' if candidate.exclusivity_agreed == true else ('false' if candidate.exclusivity_agreed == false else 'null') }},
            applied_at_companies_text: {{ (candidate.applied_at_companies_text or '') | tojson | safe }},
            call_transcript: {{ (candidate.call_transcript or '') | tojson | safe }},
            call_summary: {{ (candidate.call_summary or '') | tojson | safe }},
            call_type: {{ (candidate.call_type or '') | tojson | safe }}
        },
        _qfOriginal: {},
        init() {
            this._qfOriginal = JSON.parse(JSON.stringify(this.qf));
        },

        async saveQField(fieldName) {
            var val = this.qf[fieldName];
            var origVal = this._qfOriginal[fieldName];
            if (val === origVal) return;
            if (typeof val === 'string' && val.trim() === '' && (origVal === '' || origVal === null || origVal === undefined)) return;
            var candidateId = '{{ candidate.id }}';
            var payload = {};
            if (typeof val === 'string' && val.trim() === '') val = null;
            payload[fieldName] = val;
            this.qfSaving = true;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    this._qfOriginal[fieldName] = this.qf[fieldName];
                    if (typeof showToast === 'function') showToast('Gespeichert', 'success');
                } else {
                    if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
                }
            } catch (err) {
                console.error('QF speichern fehlgeschlagen:', err);
                if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
            }
            this.qfSaving = false;
        },

        async setQfChoice(fieldName, value) {
            var current = this.qf[fieldName];
            this.qf[fieldName] = current === value ? '' : value;
            await this.saveQField(fieldName);
        },

        async toggleQfBool(fieldName, value) {
            var current = this.qf[fieldName];
            this.qf[fieldName] = current === value ? null : value;
            await this.saveQField(fieldName);
        },

        async saveCallDate() {
            var candidateId = '{{ candidate.id }}';
            var dateVal = this.qfCallDate ? new Date(this.qfCallDate).toISOString() : null;
            this.qfSaving = true;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ call_date: dateVal })
                });
                if (response.ok) {
                    if (typeof showToast === 'function') showToast('Gesprächsdatum gespeichert', 'success');
                }
            } catch (err) { console.error('Call-Datum speichern fehlgeschlagen:', err); }
            this.qfSaving = false;
        }
    };
}

// Global removeErp for Jinja-rendered buttons
function removeErp(item) {
    var comp = document.querySelector('[x-data="pipelineFields()"]');
    if (comp) {
        var data = Alpine.$data(comp);
        if (data) data.removeErp(item);
    }
}

function deleteCandidate(candidateId, candidateName) {
    if (!confirm('Kandidat ' + candidateName + ' wirklich l\u00f6schen?')) return;
    fetch('/api/candidates/' + candidateId, { method: 'DELETE' })
    .then(function(r) { return r.json(); })
    .then(function(d) { if (d.success) window.location.href = '/kandidaten'; });
}

// ==================== Kopieren ====================
function copyToClipboard(text, label) {
    var btn = event && event.currentTarget;
    function onCopied() {
        if (typeof showToast === 'function') showToast(label + ' kopiert', 'success');
        if (btn) {
            btn.classList.add('copied');
            var origHTML = btn.innerHTML;
            btn.innerHTML = '<svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width:14px;height:14px;"><path d="M5 13l4 4L19 7"/></svg>';
            setTimeout(function() { btn.innerHTML = origHTML; btn.classList.remove('copied'); }, 1500);
        }
    }
    navigator.clipboard.writeText(text).then(onCopied).catch(function() {
        var ta = document.createElement('textarea');
        ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        onCopied();
    });
}

// ==================== Profil kopieren ====================
var _werdegangData = {{ (candidate.work_history or []) | tojson | safe }};
var _itSkillsData = {{ (candidate.it_skills or []) | tojson | safe }};
var _languagesData = {{ (candidate.languages or []) | tojson | safe }};
var _furtherEducationData = {{ (candidate.further_education or []) | tojson | safe }};
var _educationData = {{ (candidate.education or []) | tojson | safe }};
var _skillsData = {{ (candidate.skills or []) | tojson | safe }};
{% set _sn_inv = ['not available','n/a','na','none','null','-','—',''] %}
{% set _sn_f = candidate.first_name or '' %}
{% set _sn_l = candidate.last_name or '' %}
{% set _sn_fv = _sn_f if _sn_f|lower|trim not in _sn_inv else '' %}
{% set _sn_lv = _sn_l if _sn_l|lower|trim not in _sn_inv else '' %}
{% set _sn_fd = (_sn_fv|title) if (_sn_fv == _sn_fv|upper and _sn_fv|length > 1) else _sn_fv %}
{% set _sn_ld = (_sn_lv|title) if (_sn_lv == _sn_lv|upper and _sn_lv|length > 1) else _sn_lv %}
{% set _sn_name = ((_sn_fd ~ ' ' ~ _sn_ld)|trim) if (_sn_fd or _sn_ld) else 'Unbekannt' %}
var _candidateName = {{ _sn_name | tojson | safe }};

function buildFullProfileText(name, workHistory, itSkills, languages, furtherEdu, education, skills) {
    var lines = []; var hasContent = false;
    if (workHistory && workHistory.length > 0) {
        hasContent = true; lines.push('--- BERUFSERFAHRUNG ---'); lines.push('');
        for (var i = 0; i < workHistory.length; i++) {
            var job = workHistory[i];
            if (!job || typeof job !== 'object') continue;
            var dateRange = '';
            if (job.start_date) { dateRange = job.start_date; dateRange += job.end_date ? ' - ' + job.end_date : ' - heute'; }
            if (dateRange) lines.push(dateRange);
            lines.push(job.position || job.title || 'Unbekannte Position');
            lines.push(job.company || 'Unbekanntes Unternehmen');
            if (job.description) lines.push(job.description);
            lines.push('');
        }
    }
    if (itSkills && itSkills.length > 0) { hasContent = true; lines.push('--- IT-KENNTNISSE ---'); lines.push(itSkills.join(', ')); lines.push(''); }
    if (languages && languages.length > 0) {
        hasContent = true; lines.push('--- SPRACHEN ---');
        for (var i = 0; i < languages.length; i++) {
            var lang = languages[i];
            if (!lang || typeof lang !== 'object') continue;
            var langLine = lang.language || 'Unbekannt';
            if (lang.level) langLine += ' (' + lang.level + ')';
            lines.push(langLine);
        }
        lines.push('');
    }
    if (furtherEdu && furtherEdu.length > 0) {
        hasContent = true; lines.push('--- ZERTIFIKATE & WEITERBILDUNGEN ---');
        for (var i = 0; i < furtherEdu.length; i++) {
            var wb = furtherEdu[i]; if (!wb || typeof wb !== 'object') continue;
            var wbLine = wb.degree || wb.qualification || 'Weiterbildung';
            if (wb.institution) wbLine += ' | ' + wb.institution;
            if (wb.year || wb.end_date) wbLine += ' | ' + (wb.year || wb.end_date);
            lines.push(wbLine);
        }
        lines.push('');
    }
    if (education && education.length > 0) {
        hasContent = true; lines.push('--- AUSBILDUNG ---');
        for (var i = 0; i < education.length; i++) {
            var edu = education[i]; if (!edu || typeof edu !== 'object') continue;
            var eduLine = edu.degree || edu.qualification || 'Ausbildung';
            if (edu.institution || edu.school) eduLine += ' | ' + (edu.institution || edu.school);
            if (edu.year || edu.end_date) eduLine += ' | ' + (edu.year || edu.end_date);
            lines.push(eduLine);
        }
        lines.push('');
    }
    if (skills && skills.length > 0) { hasContent = true; lines.push('--- SKILLS & KENNTNISSE ---'); lines.push(skills.join(', ')); lines.push(''); }
    if (!hasContent) return null;
    return lines.join('\n').trim();
}

function copyWerdegang() {
    var text = buildFullProfileText(_candidateName, _werdegangData, _itSkillsData, _languagesData, _furtherEducationData, _educationData, _skillsData);
    if (!text) { if (typeof showToast === 'function') showToast('Kein Profil vorhanden', 'warning'); return; }
    copyToClipboard(text, 'Profil');
}

// ==================== Inline Edit ====================
function startDetailEdit(displayEl) {
    var wrapper = displayEl.closest('.detail-edit-wrapper');
    var input = wrapper.querySelector('.detail-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus(); input.select();
}

function handleDetailEditKey(event, input) {
    if (event.key === 'Enter') { input.blur(); }
    else if (event.key === 'Escape') {
        var wrapper = input.closest('.detail-edit-wrapper');
        var display = wrapper.querySelector('.detail-edit-display');
        input.classList.add('hidden'); display.classList.remove('hidden');
    }
}

function saveDetailEdit(input) {
    var wrapper = input.closest('.detail-edit-wrapper');
    var display = wrapper.querySelector('.detail-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldText = display.textContent.trim();
    var placeholders = ['Keine Position angegeben', 'Kein Unternehmen', 'Vorname', 'Nachname', 'Nicht angegeben'];
    if (placeholders.indexOf(oldText) !== -1) oldText = '';
    if (newValue === oldText) { input.classList.add('hidden'); display.classList.remove('hidden'); return; }
    var body = {}; body[field] = newValue || null;
    fetch('/api/candidates/' + candidateId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.id) {
            var fallbackTexts = { 'current_position': 'Keine Position angegeben', 'current_company': 'Kein Unternehmen', 'first_name': 'Vorname', 'last_name': 'Nachname', 'street_address': 'Nicht angegeben', 'postal_code': 'Nicht angegeben', 'city': 'Nicht angegeben', 'salary': 'Nicht angegeben', 'notice_period': 'Nicht angegeben', 'source': 'Nicht angegeben', 'candidate_notes': '' };
            display.textContent = newValue || fallbackTexts[field] || '\u2014';
            if (typeof showToast === 'function') showToast('Gespeichert', 'success');
        }
    })
    .catch(function() { input.value = oldText; })
    .finally(function() { input.classList.add('hidden'); display.classList.remove('hidden'); });
}

function saveGenderField(select, candidateId) {
    var val = select.value || null;
    fetch('/api/candidates/' + candidateId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ gender: val }) })
    .then(function(r) { return r.json(); })
    .then(function(data) { if (data.id && typeof showToast === 'function') showToast('Anrede gespeichert', 'success'); })
    .catch(function() { if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error'); });
}

// ==================== "Profil neu generieren" Button ====================
function regenerateProfilePdf(candidateId) {
    var btn = document.getElementById('btn-regenerate-pdf');
    btn.disabled = true;
    btn.innerHTML = '&#x23F3; Wird generiert...';
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';

    fetch('/api/candidates/' + candidateId + '/profile-pdf?regenerate=true')
    .then(function(r) {
        if (!r.ok) throw new Error('Generierung fehlgeschlagen (' + r.status + ')');
        return r.blob();
    })
    .then(function(blob) {
        // PDF in neuem Tab oeffnen
        var url = URL.createObjectURL(blob);
        window.open(url, '_blank');

        btn.innerHTML = '&#x2705; PDF erstellt!';
        btn.style.background = 'rgba(34,197,94,0.15)';
        btn.style.color = '#22c55e';
        btn.style.borderColor = 'rgba(34,197,94,0.3)';
        if (typeof showToast === 'function') showToast('Profil-PDF neu generiert mit aktuellen Daten!', 'success');

        // Profil-PDF Button aktualisieren (Haekchen setzen)
        var pdfLink = document.querySelector('a[href*="profile-pdf"]');
        if (pdfLink && !pdfLink.innerHTML.includes('\u2713')) {
            pdfLink.innerHTML = '&#x1F4CA; Profil-PDF &#x2713;';
        }

        // Button nach 4 Sekunden zuruecksetzen
        setTimeout(function() {
            btn.disabled = false;
            btn.innerHTML = '&#x1F504; Profil neu generieren';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.style.background = 'linear-gradient(135deg, rgba(11,137,189,0.15), rgba(16,181,240,0.15))';
            btn.style.color = '#0b89bd';
            btn.style.borderColor = 'rgba(11,137,189,0.3)';
        }, 4000);
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.innerHTML = '&#x1F504; Profil neu generieren';
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        if (typeof showToast === 'function') showToast('Fehler: ' + err.message, 'error');
    });
}

// ==================== "Jobs finden" Button (Claude Matching v4) ====================
function findJobsForCandidate(candidateId) {
    var btn = document.getElementById('btn-jobs-finden');
    btn.disabled = true;
    btn.innerHTML = '&#x23F3; Suche l&auml;uft...';
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';

    fetch('/api/v4/claude-match/candidate/' + candidateId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { throw new Error(data.error); }
        btn.innerHTML = '&#x2705; Matching gestartet';
        btn.style.background = 'var(--pp-greenSoft)';
        btn.style.color = 'var(--pp-green)';
        btn.style.borderColor = 'rgba(34,197,94,0.25)';
        if (typeof showToast === 'function') showToast('Matching gestartet! Ergebnisse auf dem Action Board.', 'success');
        // Nach 3 Sekunden Button zuruecksetzen
        setTimeout(function() {
            btn.disabled = false;
            btn.innerHTML = '&#x1F50D; Jobs finden';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.style.background = 'var(--pp-accentSoft)';
            btn.style.color = 'var(--pp-accent)';
            btn.style.borderColor = 'rgba(99,102,241,0.25)';
        }, 3000);
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.innerHTML = '&#x1F50D; Jobs finden';
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        if (typeof showToast === 'function') showToast('Fehler: ' + err.message, 'error');
    });
}

// ==================== "Nicht erreicht" Button ====================
function triggerNichtErreicht(candidateId) {
    var btn = document.getElementById('btn-nicht-erreicht');
    if (!confirm('E-Mail-Sequenz starten?\n\n3 E-Mails werden automatisch versendet:\n• E-Mail 1: Sofort\n• E-Mail 2: Nach 2 Tagen\n• E-Mail 3: Nach 5 Tagen\n\nFortfahren?')) return;

    btn.disabled = true;
    btn.innerHTML = '&#x23F3; Wird gestartet...';
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';

    // Status setzen + n8n Webhook wird serverseitig getriggert
    fetch('/api/email-automation/candidates/' + candidateId + '/not-reached', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { throw new Error(data.error); }
        btn.innerHTML = '&#x2705; Sequenz gestartet';
        btn.style.background = 'var(--pp-greenSoft)';
        btn.style.color = 'var(--pp-green)';
        btn.style.borderColor = 'rgba(34,197,94,0.25)';
        if (typeof showToast === 'function') showToast('E-Mail-Sequenz gestartet! Erste E-Mail wird jetzt versendet.', 'success');

        // Tab wechseln zu E-Mails nach 1.5 Sekunden
        setTimeout(function() {
            var alpineEl = document.querySelector('[x-data]');
            if (alpineEl && Alpine) {
                Alpine.$data(alpineEl).activeTab = 'emails';
            }
        }, 1500);
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.innerHTML = '&#x1F4E7; Nicht erreicht';
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.style.background = 'var(--pp-orangeSoft)';
        btn.style.color = 'var(--pp-orange)';
        btn.style.borderColor = 'rgba(234,179,8,0.25)';
        if (typeof showToast === 'function') showToast('Fehler: ' + err.message, 'error');
        console.error('Nicht-erreicht Fehler:', err);
    });
}

// ==================== E-Mail-Automatisierung Manager ====================
function emailAutomationManager() {
    var candidateId = '{{ candidate.id }}';
    var currentContactStatus = {{ (candidate.contact_status or '') | tojson | safe }} || '';

    var statusLabels = {
        'email_sequenz_aktiv': 'E-Mail-Sequenz aktiv',
        'sequenz_abgeschlossen': 'Sequenz abgeschlossen',
        'kein_interesse': 'Kein Interesse',
        'wiedervorlage': 'Wiedervorlage',
        '': 'Kein Status'
    };
    var statusDescriptions = {
        'email_sequenz_aktiv': '3-stufige E-Mail-Sequenz l\u00e4uft \u2013 n\u00e4chste E-Mail wird automatisch versendet',
        'sequenz_abgeschlossen': 'Alle 3 E-Mails wurden versendet, keine Antwort erhalten',
        'kein_interesse': 'Kandidat hat kein Interesse signalisiert',
        'wiedervorlage': 'Kandidat m\u00f6chte sp\u00e4ter kontaktiert werden',
        '': 'Noch keine E-Mail-Sequenz gestartet'
    };

    function enrichEmail(e) {
        e._open = false;
        if (e.created_at) {
            var dt = new Date(e.created_at);
            e.created_formatted = dt.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'}) + ' ' + dt.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
        } else { e.created_formatted = ''; }
        return e;
    }

    function enrichTask(t) {
        if (t.due_date) {
            var parts = t.due_date.split('-');
            t.due_date_formatted = parts[2] + '.' + parts[1] + '.' + parts[0];
        } else { t.due_date_formatted = ''; }
        return t;
    }

    var rawEmails = {{ (seq_emails_json or []) | tojson | safe }};
    rawEmails = rawEmails.map(function(e) { return enrichEmail(e); });

    var rawTasks = {{ (seq_tasks_json or []) | tojson | safe }};
    rawTasks = rawTasks.map(function(t) { return enrichTask(t); });

    return {
        contactStatus: currentContactStatus,
        emails: rawEmails,
        tasks: rawTasks,

        get statusLabel() {
            // Wiedervorlage-Status beginnt mit "wiedervorlage_"
            if (this.contactStatus && this.contactStatus.indexOf('wiedervorlage') === 0) return 'Wiedervorlage';
            return statusLabels[this.contactStatus] || this.contactStatus || 'Kein Status';
        },

        get statusDescription() {
            if (this.contactStatus && this.contactStatus.indexOf('wiedervorlage') === 0) return 'Kandidat m\u00f6chte sp\u00e4ter kontaktiert werden';
            return statusDescriptions[this.contactStatus] || '';
        },

        startSequenz: function() {
            triggerNichtErreicht(candidateId);
        },

        toggleTask: function(task) {
            var self = this;
            var newStatus = task.status === 'done' ? 'open' : 'done';
            fetch('/api/email-automation/tasks/' + task.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(function(data) {
                var idx = self.tasks.findIndex(function(t){ return t.id === task.id; });
                if (idx !== -1) {
                    self.tasks[idx].status = data.status || newStatus;
                }
                showToast('Aufgabe aktualisiert', 'success');
            })
            .catch(function(e) { showToast('Fehler: '+e.message, 'error'); });
        },

        refreshEmails: function() {
            var self = this;
            fetch('/api/email-automation/candidates/' + candidateId + '/emails?limit=50')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.items) {
                    self.emails = data.items.map(function(e) { return enrichEmail(e); });
                }
            })
            .catch(function(e) { console.error('E-Mails laden fehlgeschlagen:', e); });
        }
    };
}

// ==================== Aufgaben-Manager ====================
function aufgabenManager() {
    var candidateId = '{{ candidate.id }}';
    var priorityLabels = {unwichtig:'Unwichtig',mittelmaessig:'Mittelmäßig',wichtig:'Wichtig',dringend:'Dringend',sehr_dringend:'Sehr dringend'};
    var priorityColors = {unwichtig:'#6b7280',mittelmaessig:'#3b82f6',wichtig:'#f59e0b',dringend:'#f97316',sehr_dringend:'#ef4444'};

    function enrichTodo(t) {
        t._open = false;
        t.priority_label = priorityLabels[t.priority] || t.priority;
        t.priority_color = priorityColors[t.priority] || '#6b7280';
        if (t.due_date) {
            var parts = t.due_date.split('-');
            t.due_date_formatted = parts[2] + '.' + parts[1] + '.' + parts[0];
            var today = new Date(); today.setHours(0,0,0,0);
            var due = new Date(t.due_date + 'T00:00:00');
            t.is_overdue = due < today && (t.status === 'open' || t.status === 'in_progress');
        } else {
            t.due_date_formatted = '';
            t.is_overdue = false;
        }
        return t;
    }

    var rawTodos = {{ (todos_json or []) | tojson | safe }};
    rawTodos = rawTodos.map(function(t) {
        return enrichTodo(t);
    });

    return {
        todos: rawTodos,
        filter: 'all',
        showAddForm: false,
        newTodo: { title: '', description: '', priority: 'wichtig', status: 'open', due_date: '', due_time: '' },

        get filteredTodos() {
            var self = this;
            var list = self.todos;
            if (self.filter === 'open') list = list.filter(function(t){ return t.status === 'open' || t.status === 'in_progress'; });
            if (self.filter === 'done') list = list.filter(function(t){ return t.status === 'done'; });
            // Sortierung: offene zuerst (nach Prioritaet), dann erledigte
            var prioOrder = {sehr_dringend:0,dringend:1,wichtig:2,mittelmaessig:3,unwichtig:4};
            return list.sort(function(a,b) {
                if (a.status === 'done' && b.status !== 'done') return 1;
                if (a.status !== 'done' && b.status === 'done') return -1;
                return (prioOrder[a.priority]||5) - (prioOrder[b.priority]||5);
            });
        },

        addTodo: function() {
            var self = this;
            if (!self.newTodo.title.trim()) { showToast('Bitte Titel eingeben','error'); return; }
            var payload = {
                title: self.newTodo.title.trim(),
                candidate_id: candidateId,
                priority: self.newTodo.priority,
                status: self.newTodo.status,
            };
            if (self.newTodo.description.trim()) payload.description = self.newTodo.description.trim();
            if (self.newTodo.due_date) payload.due_date = self.newTodo.due_date;
            if (self.newTodo.due_time) payload.due_time = self.newTodo.due_time;
            fetch('/api/ats/todos', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
            .then(function(r) { if (!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(function(data) {
                self.todos.push(enrichTodo(data));
                self.newTodo = {title:'', description:'', priority:'wichtig', status:'open', due_date:'', due_time:''};
                self.showAddForm = false;
                showToast('Aufgabe erstellt','success');
            })
            .catch(function(e) { showToast('Fehler: '+e.message,'error'); });
        },

        toggleStatus: function(todo) {
            var newStatus = todo.status === 'done' ? 'open' : 'done';
            this.updateTodo(todo.id, {status: newStatus});
        },

        updateTodo: function(todoId, fields) {
            var self = this;
            fetch('/api/ats/todos/'+todoId, {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(fields)})
            .then(function(r) { if (!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(function(data) {
                var idx = self.todos.findIndex(function(t){return t.id === todoId;});
                if (idx !== -1) {
                    var wasOpen = self.todos[idx]._open;
                    self.todos[idx] = enrichTodo(data);
                    self.todos[idx]._open = wasOpen;
                }
                showToast('Aufgabe aktualisiert','success');
            })
            .catch(function(e) { showToast('Fehler: '+e.message,'error'); });
        },

        deleteTodo: function(todoId) {
            var self = this;
            fetch('/api/ats/todos/'+todoId, {method:'DELETE'})
            .then(function(r) { if (!r.ok) throw new Error('HTTP '+r.status); })
            .then(function() {
                self.todos = self.todos.filter(function(t){return t.id !== todoId;});
                showToast('Aufgabe gelöscht','success');
            })
            .catch(function(e) { showToast('Fehler: '+e.message,'error'); });
        }
    };
}

// ==================== Email-Drafts Manager ====================
function emailDraftsManager() {
    var typeLabels = {kontaktdaten:'Kontaktdaten',stellenausschreibung:'Stellenausschreibung',individuell:'Individuell'};
    var typeColors = {
        kontaktdaten:'color:var(--pp-green); background:var(--pp-greenSoft);',
        stellenausschreibung:'color:var(--pp-accent); background:var(--pp-accentSoft);',
        individuell:'color:var(--pp-orange); background:var(--pp-orangeSoft);'
    };
    var statusLabels = {draft:'Entwurf',sent:'Gesendet',failed:'Fehler',cancelled:'Verworfen',approved:'Genehmigt'};
    var statusStyles = {
        draft:'color:var(--pp-orange); background:var(--pp-orangeSoft);',
        sent:'color:var(--pp-green); background:var(--pp-greenSoft);',
        failed:'color:var(--pp-red); background:var(--pp-redSoft);',
        cancelled:'color:var(--pp-textDim); background:var(--pp-surfaceHover);',
        approved:'color:var(--pp-accent); background:var(--pp-accentSoft);'
    };

    function enrichDraft(d) {
        d._open = false;
        d._sending = false;
        d.type_label = typeLabels[d.email_type] || d.email_type;
        d.type_color = typeColors[d.email_type] || 'color:var(--pp-textDim); background:var(--pp-surfaceHover);';
        d.status_label = statusLabels[d.status] || d.status;
        d.status_style = statusStyles[d.status] || '';
        if (d.created_at) {
            var dt = new Date(d.created_at);
            d.created_formatted = dt.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'}) + ' ' + dt.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
        } else { d.created_formatted = ''; }
        if (d.sent_at) {
            var st = new Date(d.sent_at);
            d.sent_formatted = st.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit'}) + ' ' + st.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
        } else { d.sent_formatted = ''; }
        return d;
    }

    var rawDrafts = {{ (email_drafts_json or []) | tojson | safe }};
    rawDrafts = rawDrafts.map(function(d) { return enrichDraft(d); });

    return {
        drafts: rawDrafts,

        get pendingCount() {
            return this.drafts.filter(function(d){ return d.status === 'draft'; }).length;
        },

        sendDraft: function(draftId) {
            var self = this;
            var idx = self.drafts.findIndex(function(d){return d.id === draftId;});
            if (idx === -1) return;
            self.drafts[idx]._sending = true;

            fetch('/api/email/drafts/' + draftId + '/send', {method:'POST', headers:{'Content-Type':'application/json'}})
            .then(function(r) { return r.json().then(function(data){return {ok:r.ok, data:data};}); })
            .then(function(res) {
                if (res.ok && !res.data.error) {
                    self.drafts[idx].status = 'sent';
                    self.drafts[idx].sent_at = new Date().toISOString();
                    self.drafts[idx] = enrichDraft(self.drafts[idx]);
                    self.drafts[idx]._open = true;
                    showToast('Email gesendet!','success');
                } else {
                    self.drafts[idx].status = 'failed';
                    self.drafts[idx].send_error = res.data.error || 'Unbekannter Fehler';
                    self.drafts[idx] = enrichDraft(self.drafts[idx]);
                    self.drafts[idx]._open = true;
                    showToast('Email-Versand fehlgeschlagen','error');
                }
            })
            .catch(function(e) {
                self.drafts[idx]._sending = false;
                showToast('Fehler: ' + e.message,'error');
            });
        },

        updateDraft: function(draftId, fields) {
            var self = this;
            fetch('/api/email/drafts/' + draftId, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(fields)})
            .then(function(r) { if (!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(function(data) {
                var idx = self.drafts.findIndex(function(d){return d.id === draftId;});
                if (idx !== -1) {
                    var wasOpen = self.drafts[idx]._open;
                    self.drafts[idx].subject = data.subject || self.drafts[idx].subject;
                    self.drafts[idx].body_html = data.body_html || self.drafts[idx].body_html;
                    self.drafts[idx]._open = wasOpen;
                }
                showToast('Entwurf aktualisiert','success');
            })
            .catch(function(e) { showToast('Fehler: '+e.message,'error'); });
        },

        cancelDraft: function(draftId) {
            var self = this;
            fetch('/api/email/drafts/' + draftId, {method:'DELETE'})
            .then(function(r) { if (!r.ok) throw new Error('HTTP '+r.status); })
            .then(function() {
                var idx = self.drafts.findIndex(function(d){return d.id === draftId;});
                if (idx !== -1) {
                    self.drafts[idx].status = 'cancelled';
                    self.drafts[idx] = enrichDraft(self.drafts[idx]);
                }
                showToast('Entwurf verworfen','success');
            })
            .catch(function(e) { showToast('Fehler: '+e.message,'error'); });
        }
    };
}

// ==================== CV-Vorschau ====================
var _cvBlobUrl = null;

function openCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');

    // Alte Blob-URL aufräumen
    if (_cvBlobUrl) { URL.revokeObjectURL(_cvBlobUrl); _cvBlobUrl = null; }

    // PDF per fetch laden (sendet Cookies mit!) → Blob-URL für iframe
    iframe.src = 'about:blank';
    overlay.classList.remove('hidden');
    requestAnimationFrame(function() {
        overlay.querySelector('.cv-overlay-bg').style.opacity = '1';
        panel.style.transform = 'translateX(0)';
    });
    document.body.style.overflow = 'hidden';

    fetch('/api/candidates/{{ candidate.id }}/cv-preview', { credentials: 'same-origin' })
        .then(function(resp) {
            if (!resp.ok) throw new Error('CV laden fehlgeschlagen: ' + resp.status);
            return resp.blob();
        })
        .then(function(blob) {
            _cvBlobUrl = URL.createObjectURL(blob);
            iframe.src = _cvBlobUrl;
        })
        .catch(function(err) {
            console.error('CV-Vorschau Fehler:', err);
            iframe.srcdoc = '<html><body style="display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#181A23;color:#E8E9ED;font-family:sans-serif;"><div style="text-align:center;"><p style="font-size:18px;">CV konnte nicht geladen werden</p><p style="font-size:13px;color:#9CA3AF;margin-top:8px;">Bitte versuche es über "Neuer Tab"</p></div></body></html>';
        });
}

function closeCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');
    panel.style.transform = 'translateX(100%)';
    overlay.querySelector('.cv-overlay-bg').style.opacity = '0';
    setTimeout(function() {
        overlay.classList.add('hidden');
        iframe.src = 'about:blank';
        if (_cvBlobUrl) { URL.revokeObjectURL(_cvBlobUrl); _cvBlobUrl = null; }
    }, 300);
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var overlay = document.getElementById('cv-preview-overlay');
        if (overlay && !overlay.classList.contains('hidden')) closeCvPreview();
    }
});
</script>
{% endblock %}
