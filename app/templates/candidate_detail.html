{% extends "base.html" %}
{% block title %}{% set _t_first = candidate.first_name or '' %}{% set _t_last = candidate.last_name or '' %}{% set _t_inv = ['not available','n/a','na','none','null','-','—',''] %}{% set _t_f = _t_first if _t_first|lower|trim not in _t_inv else '' %}{% set _t_l = _t_last if _t_last|lower|trim not in _t_inv else '' %}{% set _t_name = ((_t_f ~ ' ' ~ _t_l)|trim) if (_t_f or _t_l) else 'Unbekannt' %}{{ _t_name }} - Pulspoint{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    .kd-wrap, .kd-wrap * { font-family: 'Outfit', 'DM Sans', -apple-system, sans-serif; }
    .kd-wrap { background: #f4f5f8; color: #1e293b; }
    .kd-wrap ::-webkit-scrollbar { width: 5px; }
    .kd-wrap ::-webkit-scrollbar-track { background: transparent; }
    .kd-wrap ::-webkit-scrollbar-thumb { background: #d4d9e3; border-radius: 3px; }

    @keyframes kdFadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes kdSlideIn {
        from { opacity: 0; transform: translateX(12px); }
        to   { opacity: 1; transform: translateX(0); }
    }
    .kd-anim { opacity: 0; animation: kdFadeUp 0.5s cubic-bezier(0.4,0,0.2,1) forwards; }
    .kd-anim-side { opacity: 0; animation: kdSlideIn 0.5s cubic-bezier(0.4,0,0.2,1) forwards; }

    .kd-section {
        background: #fff; border-radius: 16px; border: 1px solid #e6e9ef; overflow: hidden;
    }
    .kd-section-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 16px 22px; border-bottom: 1px solid #f0f2f5;
        background: linear-gradient(135deg, #fafbfd 0%, #f7f8fb 100%);
    }
    .kd-section-title {
        display: flex; align-items: center; gap: 10px;
        font-size: 15px; font-weight: 750; color: #0f172a; letter-spacing: -0.02em;
    }
    .kd-section-body { padding: 18px 22px; }

    .kd-sidebar-card {
        background: #fff; border-radius: 14px; border: 1px solid #e6e9ef; overflow: hidden;
    }
    .kd-sidebar-header {
        padding: 14px 18px; border-bottom: 1px solid #f0f2f5;
        display: flex; align-items: center; justify-content: space-between;
        background: linear-gradient(135deg, #fafbfd, #f7f8fb);
        font-size: 13px; font-weight: 700; color: #334155;
    }
    .kd-sidebar-body { padding: 14px 18px; }

    .kd-exp-dot-current {
        width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
        background: linear-gradient(135deg, #6366f1, #818cf8);
        border: 3px solid #e0e7ff;
    }
    .kd-exp-dot-past {
        width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
        background: #d4d9e3; border: 3px solid #f0f2f5;
    }
    .kd-exp-line {
        width: 2px; flex: 1; margin-top: 6px;
        background: linear-gradient(to bottom, #e2e5ec, transparent);
    }

    .kd-lang-bar {
        height: 8px; border-radius: 4px; overflow: hidden; background: #f0f2f5;
    }
    .kd-lang-fill {
        height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    }

    .kd-quickbtn {
        display: inline-flex; align-items: center; gap: 7px;
        padding: 9px 16px; border-radius: 10px;
        font-size: 12.5px; font-weight: 630; cursor: pointer;
        font-family: inherit; transition: all 0.2s; border: 1.5px solid #e2e5ec;
        background: #fff; color: #475569;
    }
    .kd-quickbtn:hover { background: #f8fafc; }
    .kd-quickbtn-primary {
        background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; border: none;
        box-shadow: 0 2px 8px rgba(99,102,241,0.25);
    }
    .kd-quickbtn-primary:hover { background: linear-gradient(135deg, #4f46e5, #7c3aed); }
    .kd-quickbtn-accent {
        background: #fff; color: #4f46e5; border: 1.5px solid #c7d2fe;
    }
    .kd-quickbtn-accent:hover { background: #eef2ff; }
    .kd-quickbtn-danger {
        background: #fff; color: #dc2626; border: 1.5px solid #fecaca;
    }
    .kd-quickbtn-danger:hover { background: #fef2f2; }

    /* Nav item */
    .kd-nav-btn {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 12px; border-radius: 8px;
        background: transparent; border: none; cursor: pointer; width: 100%; text-align: left;
        font-family: inherit; transition: all 0.15s; font-size: 12px; font-weight: 500; color: #64748b;
    }
    .kd-nav-btn:hover { background: #f8fafc; }
    .kd-nav-btn.active { background: #eef2ff; font-weight: 650; color: #4f46e5; }

    /* Inline edit overrides for new design */
    .kd-wrap .detail-edit-display {
        cursor: pointer; border-radius: 4px; padding: 1px 4px;
        transition: all 0.15s;
    }
    .kd-wrap .detail-edit-display:hover {
        background: rgba(99,102,241,0.06);
    }
    .kd-wrap .detail-edit-input {
        font-family: inherit; border-radius: 8px;
    }

    /* Skill category colors */
    .skill-fach { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; }
    .skill-tech { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .skill-soft { background: #fefce8; color: #a16207; border: 1px solid #fde68a; }

    /* Copy button */
    .kd-copy-btn {
        background: #f4f6f8; border: none; border-radius: 6px; padding: 3px 8px;
        font-size: 11px; cursor: pointer; color: #94a3b8; font-weight: 600;
        transition: all 0.2s; font-family: inherit;
    }
    .kd-copy-btn:hover { background: #e8ecf1; color: #64748b; }
</style>
{% endblock %}

{% block content %}
{# ── Data Quality: Invalid-Name-Filterung + Normalisierung ── #}
{% set invalid_names = ['not available', 'n/a', 'na', 'none', 'null', '-', '—', ''] %}
{% set raw_first = candidate.first_name or '' %}
{% set raw_last = candidate.last_name or '' %}
{% set first_valid = raw_first if raw_first | lower | trim not in invalid_names else '' %}
{% set last_valid = raw_last if raw_last | lower | trim not in invalid_names else '' %}
{# ALL CAPS → Title Case (ohne if/else wg. Jinja2 Scoping) #}
{% set first_display = (first_valid | title) if (first_valid == first_valid | upper and first_valid | length > 1) else first_valid %}
{% set last_display = (last_valid | title) if (last_valid == last_valid | upper and last_valid | length > 1) else last_valid %}
{% set has_valid_name = first_display or last_display %}
{% set display_name = ((first_display ~ ' ' ~ last_display) | trim) if has_valid_name else 'Unbekannt' %}
{% set raw_position = candidate.current_position or '' %}
{% set position_invalid = raw_position | lower | trim in (invalid_names + ['keine position angegeben']) %}
{% set position_display = '' if position_invalid else raw_position %}
{% set raw_company = candidate.current_company or '' %}
{% set company_invalid = raw_company | lower | trim in (invalid_names + ['kein unternehmen']) %}
{% set company_display = '' if company_invalid else raw_company %}
{% set raw_city = candidate.city or '' %}
{% set city_invalid = raw_city | lower | trim in (invalid_names + ['keine adresse']) %}
{% set city_display = '' if city_invalid else raw_city %}
{# ── End Data Quality ── #}
<div class="kd-wrap min-h-screen" x-data="{ activeSection: 'experience' }">

    {# ════════════════════════════════════════════════════
       VIOLET HERO HEADER
    ════════════════════════════════════════════════════ #}
    <div style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 40%, #4338ca 100%); padding: 28px 40px 0; position: relative; overflow: hidden;">
        {# Decorative circle #}
        <div style="position: absolute; top: -60px; right: -60px; width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, rgba(129,140,248,0.15) 0%, transparent 70%);"></div>

        {# Breadcrumb #}
        <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 20px; font-weight: 500;">
            <a href="/" style="cursor: pointer; color: rgba(255,255,255,0.6); text-decoration: none;">&#x1F3E0;</a>
            <span>&#x203A;</span>
            <a href="/kandidaten" style="cursor: pointer; color: rgba(255,255,255,0.6); text-decoration: none;">Kandidaten</a>
            <span>&#x203A;</span>
            <span style="color: rgba(255,255,255,0.85);">{{ display_name }}</span>
        </div>

        {# Avatar + Name + Meta #}
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 22px;">
            <div style="width: 68px; height: 68px; border-radius: 18px; background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px; font-weight: 800; border: 3px solid rgba(255,255,255,0.2); box-shadow: 0 4px 20px rgba(0,0,0,0.2); flex-shrink: 0;">
                {{ (first_display or 'X')[0] | upper }}{{ (last_display or 'X')[0] | upper }}
            </div>
            <div style="flex: 1; min-width: 0;">
                {# Name - editable #}
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="first_name">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Vorname bearbeiten" style="font-size: 26px; font-weight: 800; color: #fff; letter-spacing: -0.03em; cursor: pointer;">{{ first_display or 'Vorname' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ first_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 22px; font-weight: 800; color: #1e293b; padding: 2px 8px; border-radius: 8px; border: 2px solid #818cf8; width: 200px;">
                    </div>
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="last_name">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Nachname bearbeiten" style="font-size: 26px; font-weight: 800; color: #fff; letter-spacing: -0.03em; cursor: pointer;">{{ last_display or 'Nachname' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ last_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 22px; font-weight: 800; color: #1e293b; padding: 2px 8px; border-radius: 8px; border: 2px solid #818cf8; width: 200px;">
                    </div>
                </div>

                {# Position + Company - editable #}
                <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px; flex-wrap: wrap;">
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_position">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Position bearbeiten" style="font-size: 14px; color: rgba(255,255,255,0.7); font-weight: 500; cursor: pointer;">{{ position_display or 'Keine Position angegeben' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ position_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 14px; color: #1e293b; padding: 2px 8px; border-radius: 8px; border: 2px solid #818cf8;">
                    </div>
                    {% if company_display %}
                    <span style="color: rgba(255,255,255,0.4);">&middot;</span>
                    {% endif %}
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_company">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Unternehmen bearbeiten" style="font-size: 14px; color: rgba(255,255,255,0.5); font-weight: 500; cursor: pointer;">{{ company_display or 'Kein Unternehmen' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ company_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 14px; color: #1e293b; padding: 2px 8px; border-radius: 8px; border: 2px solid #818cf8;">
                    </div>
                </div>

                {# Meta badges #}
                <div style="display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap;">
                    {% if candidate.birth_date or candidate.age %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4C5;</span>
                        {% if candidate.birth_date %}{{ candidate.birth_date.strftime('%d.%m.%Y') }}{% endif %}{% if candidate.age %} ({{ candidate.age }} Jahre){% endif %}
                    </span>
                    {% endif %}
                    {% if city_display %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4CD;</span>
                        {{ city_display }}{% if candidate.postal_code %}, {{ candidate.postal_code }}{% endif %}
                    </span>
                    {% endif %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F554;</span>
                        Seit {{ candidate.created_at.strftime('%d.%m.%Y') if candidate.created_at else 'Unbekannt' }}
                    </span>
                    {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4CA;</span>
                        {{ candidate.work_history | length }} Position{{ 'en' if candidate.work_history | length != 1 else '' }}
                    </span>
                    {% endif %}
                </div>

                {# Job title tags + Rating #}
                {% if candidate.manual_job_titles and candidate.manual_job_titles | length > 0 %}
                <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; align-items: center;">
                    {% for title in candidate.manual_job_titles %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 8px; background: rgba(16,185,129,0.15); color: #6ee7b7;">
                        &#x1F3F7; {{ title }}
                    </span>
                    {% endfor %}
                    {% if candidate.rating %}
                    <span style="display: inline-flex; align-items: center; gap: 2px; font-size: 13px; padding: 2px 8px; border-radius: 8px; background: rgba(245,158,11,0.15);">
                        {% for i in range(1, 6) %}
                        <span style="color: {% if i <= candidate.rating %}#f59e0b{% else %}rgba(255,255,255,0.2){% endif %};">&#9733;</span>
                        {% endfor %}
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        {# Quick Action Buttons #}
        <div x-data="{
            showPipelineModal: false,
            jobs: [],
            selectedJob: '',
            selectedStage: 'sent',
            loading: false,
            showNewJobForm: false,
            newJobTitle: '',
            newJobCompanyId: '',
            newJobCompanyName: '',
            newJobCity: '',
            companies: [],
            filteredCompanies: [],
            creatingJob: false,
            showJobDropdown: false,
            selectedJobName: '',
            async loadJobs() {
                try {
                    const response = await fetch('/api/ats/jobs');
                    const data = await response.json();
                    this.jobs = data.items || [];
                } catch (err) {
                    console.error('Error loading jobs:', err);
                }
            },
            selectJob(job) {
                this.selectedJob = job.id;
                this.selectedJobName = job.company_name ? job.company_name + ' - ' + job.title : job.title;
                this.showJobDropdown = false;
            },
            async loadCompanies() {
                const response = await fetch('/api/companies?limit=500');
                const data = await response.json();
                this.companies = data.items || [];
            },
            filterCompanies() {
                if (!this.newJobCompanyName) { this.filteredCompanies = []; return; }
                const term = this.newJobCompanyName.toLowerCase();
                this.filteredCompanies = this.companies.filter(c => c.name.toLowerCase().includes(term)).slice(0, 10);
            },
            selectCompany(company) {
                this.newJobCompanyId = company.id;
                this.newJobCompanyName = company.name;
                this.filteredCompanies = [];
            },
            async createJob() {
                if (!this.newJobTitle || !this.newJobCompanyId) return;
                this.creatingJob = true;
                const response = await fetch('/api/ats/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: this.newJobTitle, company_id: this.newJobCompanyId, location_city: this.newJobCity || null })
                });
                if (response.ok) {
                    const job = await response.json();
                    this.jobs.push(job);
                    this.selectedJob = job.id;
                    this.showNewJobForm = false;
                    this.newJobTitle = ''; this.newJobCompanyId = ''; this.newJobCompanyName = ''; this.newJobCity = '';
                    showToast('Stelle erstellt', 'success');
                } else { showToast('Fehler beim Erstellen', 'error'); }
                this.creatingJob = false;
            },
            async addToPipeline() {
                if (!this.selectedJob) return;
                this.loading = true;
                const response = await fetch('/api/ats/pipeline/' + this.selectedJob + '/candidates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidate_id: '{{ candidate.id }}', stage: this.selectedStage })
                });
                if (response.ok) {
                    showToast('Kandidat zur Pipeline hinzugefuegt', 'success');
                    this.showPipelineModal = false; this.selectedJob = ''; this.selectedStage = 'sent';
                    htmx.trigger('#candidate-pipeline', 'load');
                } else if (response.status === 409) { showToast('Kandidat ist bereits in dieser Pipeline', 'warning'); }
                else { showToast('Fehler beim Hinzufuegen', 'error'); }
                this.loading = false;
            }
        }" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                {% if candidate.crm_id %}
                <a href="https://app.recruitcrm.io/candidate/{{ candidate.crm_id }}" target="_blank" class="kd-quickbtn" style="color: rgba(255,255,255,0.7); border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); text-decoration: none;">
                    <span style="font-size: 14px;">&#x2197;</span> Im CRM &ouml;ffnen
                </a>
                {% endif %}
                {% if candidate.cv_url %}
                <a href="{{ candidate.cv_url }}" target="_blank" class="kd-quickbtn" style="color: rgba(255,255,255,0.7); border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); text-decoration: none;">
                    <span style="font-size: 14px;">&#x1F4C4;</span> CV herunterladen
                </a>
                <button type="button" onclick="openCvPreview()" class="kd-quickbtn kd-quickbtn-accent">
                    <span style="font-size: 14px;">&#x1F441;</span> CV ansehen
                </button>
                {% endif %}
                <button type="button" @click="showPipelineModal = true; loadJobs()" class="kd-quickbtn kd-quickbtn-primary">
                    <span style="font-size: 14px;">+</span> Zur Pipeline
                </button>
            </div>
            <div style="display: flex; gap: 8px;">
                {% if not candidate.hidden %}
                <button type="button" hx-put="/api/candidates/{{ candidate.id }}/hide" hx-swap="none" hx-on::after-request="showToast('Kandidat ausgeblendet', 'success')" class="kd-quickbtn" style="color: rgba(255,255,255,0.5); border-color: rgba(255,255,255,0.1); background: transparent;">
                    <span style="font-size: 14px;">&#x1F441;</span> Ausblenden
                </button>
                {% else %}
                <button type="button" hx-put="/api/candidates/{{ candidate.id }}/unhide" hx-swap="none" hx-on::after-request="showToast('Kandidat wieder eingeblendet', 'success')" class="kd-quickbtn" style="color: #6ee7b7; border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.1);">
                    <span style="font-size: 14px;">&#x1F441;</span> Einblenden
                </button>
                {% endif %}
                <button type="button" onclick="deleteCandidate('{{ candidate.id }}', '{{ display_name }}')" class="kd-quickbtn kd-quickbtn-danger">
                    <span style="font-size: 14px;">&#x1F5D1;</span> L&ouml;schen
                </button>
            </div>

            {# ── Pipeline Modal (same logic, restyled) ── #}
            <div x-show="showPipelineModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div x-show="showPipelineModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" @click="showPipelineModal = false"></div>
                    <div x-show="showPipelineModal" x-transition class="relative bg-white rounded-2xl p-8 max-w-xl w-full shadow-2xl z-10" style="font-family: inherit;">
                        <div class="text-center mb-6">
                            <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-2xl bg-indigo-100 mb-4">
                                <svg class="h-7 w-7 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">Zur Pipeline hinzuf&uuml;gen</h3>
                            <p class="mt-1 text-sm text-gray-500">Stelle und Phase w&auml;hlen</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Stelle</label>
                                <div class="relative" @click.away="showJobDropdown = false">
                                    <button type="button" @click="showJobDropdown = !showJobDropdown" class="relative w-full cursor-pointer rounded-xl bg-white py-3 pl-4 pr-10 text-left text-sm shadow-sm ring-1 ring-inset ring-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" style="font-family: inherit;">
                                        <span class="block truncate" x-text="selectedJobName || 'Stelle ausw\u00e4hlen...'"></span>
                                        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z" clip-rule="evenodd" /></svg></span>
                                    </button>
                                    <div x-show="showJobDropdown" x-cloak class="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-xl bg-white py-1 text-sm shadow-lg ring-1 ring-black/5">
                                        <template x-if="jobs.length === 0"><div class="px-4 py-3 text-gray-500">Keine Stellen vorhanden</div></template>
                                        <template x-for="job in jobs" :key="job.id">
                                            <button type="button" @click="selectJob(job)" class="relative w-full cursor-pointer select-none py-3 pl-4 pr-9 text-left hover:bg-indigo-50" :class="selectedJob === job.id ? 'bg-indigo-100 text-indigo-900' : 'text-gray-900'" style="font-family: inherit;">
                                                <span class="block truncate" x-text="job.company_name ? job.company_name + ' - ' + job.title : job.title"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" @click="showNewJobForm = !showNewJobForm; if(showNewJobForm && companies.length === 0) loadCompanies()" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1 font-semibold" style="font-family: inherit;">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                        <span x-text="showNewJobForm ? 'Abbrechen' : 'Neue Stelle erstellen'"></span>
                                    </button>
                                </div>
                                <div x-show="showNewJobForm" x-cloak class="mt-3 p-4 bg-gray-50 rounded-xl border border-gray-200 space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Stellentitel *</label>
                                        <input type="text" x-model="newJobTitle" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-2" placeholder="z.B. Senior Accountant" style="font-family: inherit;">
                                    </div>
                                    <div class="relative" @click.away="filteredCompanies = []">
                                        <label class="block text-sm font-medium text-gray-700">Unternehmen *</label>
                                        <input type="text" x-model="newJobCompanyName" @input="filterCompanies()" @focus="filterCompanies()" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-2" placeholder="Unternehmen suchen..." style="font-family: inherit;">
                                        <div x-show="filteredCompanies.length > 0" class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                            <template x-for="company in filteredCompanies" :key="company.id">
                                                <button type="button" @click="selectCompany(company)" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100" x-text="company.name" style="font-family: inherit;"></button>
                                            </template>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Ort (optional)</label>
                                        <input type="text" x-model="newJobCity" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-2" placeholder="z.B. Berlin" style="font-family: inherit;">
                                    </div>
                                    <div class="flex gap-2 pt-1">
                                        <button type="button" @click="createJob()" :disabled="!newJobTitle || !newJobCompanyId || creatingJob" class="inline-flex items-center px-4 py-2 text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg disabled:opacity-50" style="font-family: inherit;">Stelle erstellen</button>
                                        <button type="button" @click="showNewJobForm = false" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" style="font-family: inherit;">Abbrechen</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Phase</label>
                                <select x-model="selectedStage" class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-3" style="font-family: inherit;">
                                    <option value="sent">Vorgestellt</option>
                                    <option value="interview_1">Interview 1</option>
                                    <option value="interview_2">Interview 2</option>
                                    <option value="interview_3">Interview 3</option>
                                    <option value="offer">Angebot</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-2 gap-3">
                            <button type="button" @click="showPipelineModal = false" class="py-3 rounded-xl bg-gray-100 text-gray-700 text-sm font-semibold hover:bg-gray-200" style="font-family: inherit;">Abbrechen</button>
                            <button type="button" @click="addToPipeline()" :disabled="!selectedJob || loading" class="py-3 rounded-xl text-white text-sm font-semibold disabled:opacity-50" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); font-family: inherit;">
                                <svg x-show="loading" class="animate-spin inline -ml-1 mr-1.5 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                                Hinzuf&uuml;gen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ════════════════════════════════════════════════════
       MAIN CONTENT: 2-Column Layout
    ════════════════════════════════════════════════════ #}
    <div style="display: flex; gap: 24px; padding: 24px 40px; max-width: 1400px; margin: 0 auto;">

        {# ── LEFT COLUMN (main content) ── #}
        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 18px;">

            {# ── Kontaktdaten ── #}
            <div class="kd-section kd-anim" style="animation-delay: 100ms;" id="contact">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4C7;</span> Kontaktdaten</div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        {# Email #}
                        <div>
                            <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">E-Mail</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if candidate.email %}
                                <span style="font-size: 13.5px; font-weight: 600; color: #4f46e5;">{{ candidate.email }}</span>
                                <button type="button" onclick="copyToClipboard('{{ candidate.email }}', 'E-Mail')" class="kd-copy-btn">&#x1F4CB;</button>
                                {% else %}
                                <span style="font-size: 13.5px; font-weight: 600; color: #c4c9d4; font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                        {# Phone #}
                        <div>
                            <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">Telefon</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if candidate.phone %}
                                <span style="font-size: 13.5px; font-weight: 600; color: #4f46e5;">{{ candidate.phone }}</span>
                                <button type="button" onclick="copyToClipboard('{{ candidate.phone }}', 'Telefonnummer')" class="kd-copy-btn">&#x1F4CB;</button>
                                {% else %}
                                <span style="font-size: 13.5px; font-weight: 600; color: #c4c9d4; font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                        {# Address #}
                        <div style="grid-column: 1 / -1;">
                            <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">Adresse</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if candidate.street_address or candidate.postal_code or city_display %}
                                <span style="font-size: 13.5px; font-weight: 600; color: #1e293b;" id="address-text">{% if candidate.street_address %}{{ candidate.street_address }}{% endif %}{% if candidate.postal_code or city_display %}{% if candidate.street_address %}, {% endif %}{{ candidate.postal_code }} {{ city_display }}{% endif %}</span>
                                <button type="button" onclick="copyToClipboard(document.getElementById('address-text').textContent.trim(), 'Adresse')" class="kd-copy-btn">&#x1F4CB;</button>
                                {% else %}
                                <span style="font-size: 13.5px; font-weight: 600; color: #c4c9d4; font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Pipeline-Daten ── #}
            <div class="kd-section kd-anim" style="animation-delay: 200ms;" id="pipeline-data"
                 x-data="pipelineFields()">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F3AF;</span> Pipeline-Daten</div>
                    <span style="font-size: 11.5px; font-weight: 650; padding: 5px 12px; border-radius: 8px; background: #eef2ff; color: #4f46e5; border: 1.5px solid #c7d2fe;">F&uuml;r Pipeline</span>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        {# Gehalt #}
                        <div>
                            <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">Gehaltswunsch</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="salary">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Gehalt bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.salary %}#1e293b{% else %}#c4c9d4{% endif %}; {% if not candidate.salary %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.salary or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.salary or '' }}" placeholder="z.B. 55.000 &euro;" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid #c7d2fe; width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Kuendigungsfrist #}
                        <div>
                            <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">K&uuml;ndigungsfrist</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="notice_period">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="K&uuml;ndigungsfrist bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.notice_period %}#1e293b{% else %}#c4c9d4{% endif %}; {% if not candidate.notice_period %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.notice_period or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.notice_period or '' }}" placeholder="z.B. 3 Monate" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid #c7d2fe; width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Rating #}
                        <div>
                            <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">Bewertung</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="display: flex; gap: 3px;">
                                    {% for i in range(1, 6) %}
                                    <button type="button" @click="setRating({{ i }})" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; transition: transform 0.15s;" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'">
                                        <span id="star-{{ i }}" style="color: {% if candidate.rating and i <= candidate.rating %}#f59e0b{% else %}#e2e5ec{% endif %};">&#9733;</span>
                                    </button>
                                    {% endfor %}
                                </div>
                                <span style="font-size: 11.5px; color: #64748b; font-weight: 500;" x-text="currentRating ? currentRating + '/5' : 'Nicht bewertet'"></span>
                                <button type="button" x-show="currentRating > 0" @click="clearRating()" style="font-size: 11px; color: #94a3b8; background: none; border: none; cursor: pointer; font-family: inherit; padding: 2px 6px; border-radius: 4px;" onmouseenter="this.style.color='#ef4444'" onmouseleave="this.style.color='#94a3b8'">&#x2715;</button>
                            </div>
                        </div>
                    </div>
                    {# ERP #}
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f2f5;">
                        <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.06em;">ERP-Kenntnisse</div>
                        {% if candidate.erp and candidate.erp | length > 0 %}
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                            {% for erp_item in candidate.erp %}
                            <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px; background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe;">
                                {{ erp_item }}
                                <button type="button" onclick="removeErp('{{ erp_item }}')" style="background: none; border: none; cursor: pointer; color: #a5b4fc; font-size: 14px; padding: 0; margin-left: 2px; line-height: 1;" onmouseenter="this.style.color='#ef4444'" onmouseleave="this.style.color='#a5b4fc'">&times;</button>
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="font-size: 12px; color: #c4c9d4; font-style: italic; margin-bottom: 10px;">Keine ERP-Kenntnisse angegeben</div>
                        {% endif %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" x-model="newErp" @keydown.enter.prevent="addErp()" placeholder="z.B. SAP, DATEV..." style="padding: 8px 12px; border-radius: 8px; border: 1.5px solid #e2e5ec; font-size: 12.5px; font-weight: 500; color: #1e293b; outline: none; width: 180px; font-family: inherit;">
                            <button type="button" @click="addErp()" style="padding: 8px 14px; border-radius: 8px; background: #eef2ff; border: 1.5px solid #c7d2fe; color: #4f46e5; font-size: 12px; font-weight: 650; cursor: pointer; font-family: inherit;">+ Hinzuf&uuml;gen</button>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Berufserfahrung (Timeline) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 300ms;" id="experience">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BC;</span> Berufserfahrung</div>
                    <button type="button" onclick="copyWerdegang()" style="display: flex; align-items: center; gap: 6px; background: #f4f6f8; border: 1.5px solid #e2e5ec; border-radius: 8px; padding: 5px 12px; font-size: 11.5px; font-weight: 650; color: #475569; cursor: pointer; font-family: inherit;">&#x1F4CB; Profil kopieren</button>
                </div>
                <div class="kd-section-body">
                    {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
                        {% set work_list = candidate.work_history %}
                        {% for job in work_list %}{% if job is mapping %}
                        {% set is_first = loop.first %}
                        {% set is_last = loop.last %}
                        {# ── Dauer berechnen ── #}
                        {% set dur_text = job.duration | default('') %}
                        {% if not dur_text and job.start_date %}
                            {% set sd = job.start_date | string %}
                            {% set ed = job.end_date | default('') | string %}
                            {% set s_parts = sd.split('/') %}
                            {% if s_parts | length == 2 %}
                                {% set s_month = s_parts[0] | int %}
                                {% set s_year = s_parts[1] | int %}
                                {% if ed and ed != 'None' and ed != 'null' and ed != 'heute' and ed != 'today' %}
                                    {% set e_parts = ed.split('/') %}
                                    {% if e_parts | length == 2 %}
                                        {% set e_month = e_parts[0] | int %}
                                        {% set e_year = e_parts[1] | int %}
                                    {% else %}
                                        {% set e_month = now().month %}
                                        {% set e_year = now().year %}
                                    {% endif %}
                                {% else %}
                                    {% set e_month = now().month %}
                                    {% set e_year = now().year %}
                                {% endif %}
                                {% set total_months = (e_year - s_year) * 12 + (e_month - s_month) %}
                                {% if total_months > 0 %}
                                    {% set d_years = total_months // 12 %}
                                    {% set d_months = total_months % 12 %}
                                    {% if d_years > 0 and d_months > 0 %}
                                        {% set dur_text = d_years ~ ' J. ' ~ d_months ~ ' Mon.' %}
                                    {% elif d_years > 0 %}
                                        {% set dur_text = d_years ~ ' Jahr' ~ ('e' if d_years != 1 else '') %}
                                    {% else %}
                                        {% set dur_text = d_months ~ ' Mon.' %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        <div style="display: flex; gap: 16px; padding: 18px 0; {% if not is_last %}border-bottom: 1px solid #f0f2f5;{% endif %}">
                            {# Timeline dot + line #}
                            <div style="display: flex; flex-direction: column; align-items: center; padding-top: 4px; flex-shrink: 0; width: 20px;">
                                <div class="{% if is_first %}kd-exp-dot-current{% else %}kd-exp-dot-past{% endif %}"></div>
                                {% if not is_last %}
                                <div class="kd-exp-line"></div>
                                {% endif %}
                            </div>
                            {# Content #}
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 6px; flex-wrap: wrap;">
                                    <div>
                                        <div style="font-size: 14.5px; font-weight: 720; color: #0f172a; letter-spacing: -0.01em; line-height: 1.3;">
                                            {{ job.position | default(job.title | default('Unbekannte Position')) }}
                                        </div>
                                        <div style="font-size: 13px; color: #64748b; margin-top: 3px; font-weight: 500;">
                                            {{ job.company | default('Unbekanntes Unternehmen') }}
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                        {% if job.start_date %}
                                        <span style="font-size: 12px; color: #94a3b8; font-weight: 500; white-space: nowrap;">
                                            {{ job.start_date }}{% if job.end_date and job.end_date != 'None' %} &ndash; {{ job.end_date }}{% else %} &ndash; heute{% endif %}
                                        </span>
                                        {% endif %}
                                        {% if dur_text %}
                                        <span style="font-size: 11px; font-weight: 650; padding: 3px 10px; border-radius: 8px; background: {% if is_first %}#eef2ff{% else %}#f4f6f8{% endif %}; color: {% if is_first %}#4f46e5{% else %}#64748b{% endif %}; white-space: nowrap;">
                                            {{ dur_text }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {# Tasks/Description #}
                                {% if job.description and job.description != 'null' and job.description != 'None' %}
                                <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
                                    {% for line in job.description.split('\n') %}
                                    {% set clean_line = line.strip().lstrip('•').lstrip('-').lstrip('–').strip() %}
                                    {% if clean_line and clean_line != 'None' and clean_line != 'null' %}
                                    <div style="display: flex; gap: 8px; font-size: 13px; color: #475569; line-height: 1.55;">
                                        <span style="color: #c7ccd6; margin-top: 2px; flex-shrink: 0; font-size: 6px; line-height: 22px;">&#x25CF;</span>
                                        <span>{{ clean_line }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F4BC;</div>
                        <div style="font-size: 12px; font-weight: 600; color: #94a3b8;">Keine Berufserfahrung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── IT-Kenntnisse (Core/Standard Tiering) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 400ms;" id="it-skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BB;</span> IT-Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.it_skills and candidate.it_skills | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        {% for skill in candidate.it_skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {% set sk_low = skill.lower() %}
                        {% set is_core = sk_low in ['sap', 'sap s/4hana', 'sap-sem-bcs', 'sap fi', 'sap co', 'sap mm', 'sap bcs', 'cch tagetik', 'datev', 'addison', 'oracle', 'navision', 'dynamics', 'lucanet', 'sigma', 'hyperion', 'cognos', 'jedox', 'board', 'anaplan'] or 'sap' in sk_low or 'erp' in sk_low or 'datev' in sk_low or 'tagetik' in sk_low or 'lucanet' in sk_low or 'konsolidierung' in sk_low or 'hyperion' in sk_low or 'cognos' in sk_low %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; background: {% if is_core %}#eef2ff{% else %}#f8fafc{% endif %}; border: 1px solid {% if is_core %}#ddd6fe{% else %}#eef0f4{% endif %};">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% if is_core %}
                                <span style="font-size: 9px; font-weight: 700; padding: 2px 7px; border-radius: 5px; background: #6366f1; color: #fff; text-transform: uppercase; letter-spacing: 0.05em;">CORE</span>
                                {% endif %}
                                <span style="font-size: 13.5px; font-weight: 680; color: #1e293b;">{{ skill }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F4BB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: #94a3b8;">Keine IT-Kenntnisse hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Sprachen (Progress Bars) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 500ms;" id="languages">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F310;</span> Sprachen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.languages and candidate.languages is iterable and candidate.languages is not string and candidate.languages | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        {% for lang in candidate.languages %}{% if lang is mapping %}
                        {% set lang_name = lang.language | default('Unbekannt') %}
                        {% set lang_level = lang.level | default('') %}
                        {% set is_native = 'mutter' in lang_level.lower() if lang_level else false %}
                        {% set pct = 100 if is_native else (95 if 'flie' in lang_level.lower() else (85 if 'verhandlung' in lang_level.lower() else (70 if 'gut' in lang_level.lower() else (50 if 'grund' in lang_level.lower() else 60)))) if lang_level else 50 %}
                        <div style="display: flex; align-items: center; gap: 14px; padding: 8px 0;">
                            <div style="width: 80px; font-size: 13px; font-weight: 650; color: #1e293b;">{{ lang_name }}</div>
                            <div style="flex: 1;">
                                <div class="kd-lang-bar">
                                    <div class="kd-lang-fill" style="width: {{ pct }}%; background: linear-gradient(90deg, {% if is_native %}#10b981, #34d399{% else %}#6366f1, #a78bfa{% endif %});"></div>
                                </div>
                            </div>
                            {% if lang_level and lang_level != 'None' and lang_level != 'null' %}
                            <div style="font-size: 11.5px; color: #64748b; font-weight: 500; min-width: 180px; text-align: right;">{{ lang_level }}</div>
                            {% endif %}
                        </div>
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F310;</div>
                        <div style="font-size: 12px; font-weight: 600; color: #94a3b8;">Keine Sprachen hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Skills & Kenntnisse (Color Categories) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 600ms;" id="skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F9E9;</span> Skills &amp; Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.skills and candidate.skills | length > 0 %}
                    {# Legend #}
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: #94a3b8; font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #4f46e5;"></span> Fachlich
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: #94a3b8; font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #059669;"></span> Technisch
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: #94a3b8; font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #a16207;"></span> Sonstige
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 7px;">
                        {% for skill in candidate.skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {# Heuristic: tech keywords → green, fach (finance/accounting) → indigo, soft skills → amber #}
                        {% set sk_low = skill.lower() %}
                        {% set is_tech = sk_low in ['sap', 'excel', 'word', 'powerpoint', 'outlook', 'teams', 'python', 'sql', 'javascript', 'html', 'css', 'r', 'tableau', 'power bi', 'datev', 'addison'] or 'microsoft' in sk_low or 'sap' in sk_low or 'office' in sk_low or 'software' in sk_low or 'erp' in sk_low or 'it' == sk_low or 'edv' in sk_low %}
                        {% set is_soft = 'kommunikation' in sk_low or 'führung' in sk_low or 'team' in sk_low or 'management' in sk_low or 'organisation' in sk_low or 'präsentation' in sk_low or 'verhandlung' in sk_low or 'coaching' in sk_low or 'moderation' in sk_low or 'motivation' in sk_low or 'analytisch' in sk_low %}
                        <span class="{% if is_tech %}skill-tech{% elif is_soft %}skill-soft{% else %}skill-fach{% endif %}" style="font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px;">{{ skill }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F9E9;</div>
                        <div style="font-size: 12px; font-weight: 600; color: #94a3b8;">Keine Skills hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Zertifikate & Weiterbildungen ── #}
            <div class="kd-section kd-anim" style="animation-delay: 700ms;" id="certifications">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F393;</span> Zertifikate &amp; Weiterbildungen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.further_education and candidate.further_education is iterable and candidate.further_education is not string and candidate.further_education | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        {% for wb in candidate.further_education %}{% if wb is mapping %}
                        {% set wb_name = wb.degree if (wb.degree and wb.degree != 'None' and wb.degree != 'null') else (wb.qualification if (wb.qualification and wb.qualification != 'None' and wb.qualification != 'null') else '') %}
                        {% set wb_inst = wb.institution | default('') %}
                        {% if wb_inst == 'None' or wb_inst == 'null' %}{% set wb_inst = '' %}{% endif %}
                        {% set wb_year = wb.year | default(wb.end_date | default('')) %}
                        {% if wb_year == 'None' or wb_year == 'null' %}{% set wb_year = '' %}{% endif %}
                        {# Generische Einträge ohne Details dezenter darstellen #}
                        {% set is_generic = wb_name.lower() in ['seminar', 'e-learning', 'kurs', 'workshop', 'webinar', 'schulung', 'weiterbildung', ''] and not wb_inst %}
                        {% if wb_name %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; background: {% if is_generic %}#fcfcfd{% else %}#f8fafc{% endif %}; border: 1px solid {% if is_generic %}#f0f2f5{% else %}#eef0f4{% endif %}; {% if is_generic %}opacity: 0.7;{% endif %}">
                            <div>
                                <div style="font-size: 13.5px; font-weight: {% if is_generic %}550{% else %}650{% endif %}; color: {% if is_generic %}#64748b{% else %}#1e293b{% endif %};">
                                    {{ wb_name }}{% if is_generic and not wb_inst %} <span style="font-size: 11px; color: #94a3b8; font-weight: 400; font-style: italic;">(ohne Details)</span>{% endif %}
                                </div>
                                {% if wb_inst %}
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 2px; font-weight: 500;">{{ wb_inst }}</div>
                                {% endif %}
                            </div>
                            {% if wb_year %}
                            <span style="font-size: 12px; color: #64748b; font-weight: 600; background: #eef0f4; padding: 3px 10px; border-radius: 6px;">{{ wb_year }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F393;</div>
                        <div style="font-size: 12px; font-weight: 600; color: #94a3b8;">Keine Zertifikate hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Ausbildung ── #}
            <div class="kd-section kd-anim" style="animation-delay: 800ms;" id="education">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4DA;</span> Ausbildung</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.education and candidate.education is iterable and candidate.education is not string and candidate.education | length > 0 %}
                    {% for edu in candidate.education %}{% if edu is mapping %}
                    {% set edu_name = edu.degree if (edu.degree and edu.degree != 'None' and edu.degree != 'null') else (edu.qualification if (edu.qualification and edu.qualification != 'None' and edu.qualification != 'null') else 'Ausbildung') %}
                    {% set edu_inst = edu.institution | default(edu.school | default('')) %}
                    {% set edu_year = edu.year | default(edu.end_date | default('')) %}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; background: #f8fafc; border: 1px solid #eef0f4;">
                        <div>
                            <div style="font-size: 14px; font-weight: 680; color: #1e293b;">{{ edu_name }}</div>
                            {% if edu_inst and edu_inst != 'None' and edu_inst != 'null' %}
                            <div style="font-size: 12.5px; color: #64748b; margin-top: 2px; font-weight: 500;">{{ edu_inst }}</div>
                            {% endif %}
                        </div>
                        {% if edu_year and edu_year != 'None' and edu_year != 'null' %}
                        <span style="font-size: 12px; color: #64748b; font-weight: 600; background: #eef0f4; padding: 3px 10px; border-radius: 6px;">{{ edu_year }}</span>
                        {% endif %}
                    </div>
                    {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F4DA;</div>
                        <div style="font-size: 12px; font-weight: 600; color: #94a3b8;">Keine Ausbildung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

        {# ── RIGHT SIDEBAR (sticky) ── #}
        <div style="width: 280px; flex-shrink: 0; display: flex; flex-direction: column; gap: 16px; position: sticky; top: 20px; align-self: flex-start;">

            {# Navigation #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 150ms;">
                <div class="kd-sidebar-header">Navigation</div>
                <div class="kd-sidebar-body" style="display: flex; flex-direction: column; gap: 2px;">
                    {% set nav_items = [
                        {"id": "experience", "icon": "&#x1F4BC;", "label": "Berufserfahrung"},
                        {"id": "it-skills", "icon": "&#x1F4BB;", "label": "IT-Kenntnisse"},
                        {"id": "languages", "icon": "&#x1F310;", "label": "Sprachen"},
                        {"id": "skills", "icon": "&#x1F9E9;", "label": "Skills"},
                        {"id": "certifications", "icon": "&#x1F393;", "label": "Zertifikate"},
                        {"id": "education", "icon": "&#x1F4DA;", "label": "Ausbildung"}
                    ] %}
                    {% for nav in nav_items %}
                    <button type="button"
                            @click="activeSection = '{{ nav.id }}'; document.getElementById('{{ nav.id }}')?.scrollIntoView({behavior: 'smooth', block: 'start'})"
                            class="kd-nav-btn" :class="activeSection === '{{ nav.id }}' ? 'active' : ''">
                        <span style="font-size: 13px;">{{ nav.icon | safe }}</span>
                        {{ nav.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            {# Pipeline-Status #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 250ms;">
                <div class="kd-sidebar-header">
                    Pipeline-Status
                    <a href="/ats/pipeline" style="font-size: 11px; font-weight: 600; color: #4f46e5; text-decoration: none;">Pipeline &rarr;</a>
                </div>
                <div id="candidate-pipeline" hx-get="/partials/candidate-pipeline/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 12px 0;">
                        <div style="font-size: 28px; margin-bottom: 6px; opacity: 0.5;">&#x1F4CB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: #94a3b8; text-align: center;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# Passende Jobs #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 350ms;">
                <div class="kd-sidebar-header">Passende Jobs</div>
                <div id="matching-jobs" hx-get="/partials/candidate-jobs/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 8px 0;">
                        <div style="font-size: 12px; color: #94a3b8; text-align: center; font-weight: 500;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# CV-Status #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 450ms;">
                <div class="kd-sidebar-header">CV-Status</div>
                <div class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #94a3b8; font-weight: 500;">CV vorhanden</span>
                            <span style="font-size: 12px; font-weight: 660; color: {% if candidate.cv_url %}#059669{% else %}#94a3b8{% endif %};">{% if candidate.cv_url %}Ja{% else %}Nein{% endif %}</span>
                        </div>
                        {% if candidate.cv_parsed_at %}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #94a3b8; font-weight: 500;">Zuletzt geparst</span>
                            <span style="font-size: 12px; font-weight: 660; color: #1e293b;">{{ candidate.cv_parsed_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                        {% if candidate.crm_synced_at %}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #94a3b8; font-weight: 500;">Letzter CRM-Sync</span>
                            <span style="font-size: 12px; font-weight: 660; color: #1e293b;">{{ candidate.crm_synced_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% if candidate.cv_url %}
                    <button type="button" hx-post="/api/candidates/{{ candidate.id }}/parse-cv" hx-swap="none" hx-on::after-request="showToast('CV wird neu geparst...', 'info'); setTimeout(() => location.reload(), 3000)" style="width: 100%; margin-top: 12px; padding: 9px 0; border-radius: 8px; background: #f4f6f8; border: 1.5px solid #e2e5ec; color: #475569; font-size: 12px; font-weight: 650; cursor: pointer; font-family: inherit;">CV neu parsen</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# CV-Vorschau Slide-Over Panel #}
{% if candidate.cv_url %}
<div id="cv-preview-overlay" class="hidden relative z-50">
    <div class="cv-overlay-bg fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity duration-300 ease-in-out opacity-0" onclick="closeCvPreview()"></div>
    <div class="fixed inset-0 overflow-hidden">
        <div class="absolute inset-0 overflow-hidden">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
                <div id="cv-preview-panel" class="pointer-events-auto w-screen max-w-2xl transform transition-transform duration-300 ease-in-out translate-x-full">
                    <div class="flex h-full flex-col bg-white shadow-xl" style="font-family: 'Outfit', sans-serif;">
                        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200" style="background: linear-gradient(135deg, #fafbfd, #f7f8fb);">
                            <div>
                                <h2 class="text-lg font-bold text-gray-900">CV-Vorschau</h2>
                                <p class="text-sm text-gray-500">{{ display_name }}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <a href="{{ candidate.cv_url }}" target="_blank" class="kd-quickbtn" style="font-size: 11.5px; padding: 7px 12px;">&#x2197; Neuer Tab</a>
                                <button type="button" onclick="closeCvPreview()" style="background: #f1f5f9; border: none; border-radius: 8px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 16px;">&#x2715;</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-hidden relative">
                            <iframe id="cv-preview-iframe" src="" class="w-full h-full border-0" title="CV-Vorschau"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// ==================== Pipeline-Daten (ERP + Rating) ====================
function pipelineFields() {
    return {
        newErp: '',
        currentRating: {{ candidate.rating or 0 }},
        currentErp: {{ (candidate.erp or []) | tojson | safe }},

        async addErp() {
            var val = this.newErp.trim();
            if (!val) return;
            var items = val.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
            var merged = this.currentErp.concat(items);
            merged = merged.filter(function(v, i, a) { return a.indexOf(v) === i; });
            await this.saveErp(merged);
            this.newErp = '';
        },

        async removeErp(item) {
            var filtered = this.currentErp.filter(function(e) { return e !== item; });
            await this.saveErp(filtered);
        },

        async saveErp(erpList) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ erp: erpList })
                });
                if (response.ok) {
                    this.currentErp = erpList;
                    if (typeof showToast === 'function') showToast('ERP gespeichert', 'success');
                    setTimeout(function() { location.reload(); }, 500);
                }
            } catch (err) { console.error('ERP speichern fehlgeschlagen:', err); }
        },

        async setRating(value) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: value })
                });
                if (response.ok) {
                    this.currentRating = value;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = i <= value ? '#f59e0b' : '#e2e5ec'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung gespeichert', 'success');
                }
            } catch (err) { console.error('Rating speichern fehlgeschlagen:', err); }
        },

        async clearRating() {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: null })
                });
                if (response.ok) {
                    this.currentRating = 0;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = '#e2e5ec'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung entfernt', 'success');
                }
            } catch (err) { console.error('Rating entfernen fehlgeschlagen:', err); }
        }
    };
}

// Global removeErp for Jinja-rendered buttons
function removeErp(item) {
    var comp = document.querySelector('[x-data="pipelineFields()"]');
    if (comp && comp.__x) {
        comp.__x.$data.removeErp(item);
    }
}

function deleteCandidate(candidateId, candidateName) {
    if (!confirm('Kandidat ' + candidateName + ' wirklich l\u00f6schen?')) return;
    fetch('/api/candidates/' + candidateId, { method: 'DELETE' })
    .then(function(r) { return r.json(); })
    .then(function(d) { if (d.success) window.location.href = '/kandidaten'; });
}

// ==================== Kopieren ====================
function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(function() {
        if (typeof showToast === 'function') showToast(label + ' kopiert', 'success');
    }).catch(function() {
        var ta = document.createElement('textarea');
        ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        if (typeof showToast === 'function') showToast(label + ' kopiert', 'success');
    });
}

// ==================== Profil kopieren ====================
var _werdegangData = {{ (candidate.work_history or []) | tojson | safe }};
var _itSkillsData = {{ (candidate.it_skills or []) | tojson | safe }};
var _languagesData = {{ (candidate.languages or []) | tojson | safe }};
var _furtherEducationData = {{ (candidate.further_education or []) | tojson | safe }};
var _educationData = {{ (candidate.education or []) | tojson | safe }};
var _skillsData = {{ (candidate.skills or []) | tojson | safe }};
var _candidateName = {{ display_name | tojson | safe }};

function buildFullProfileText(name, workHistory, itSkills, languages, furtherEdu, education, skills) {
    var lines = []; var hasContent = false;
    if (workHistory && workHistory.length > 0) {
        hasContent = true; lines.push('--- BERUFSERFAHRUNG ---'); lines.push('');
        for (var i = 0; i < workHistory.length; i++) {
            var job = workHistory[i];
            if (!job || typeof job !== 'object') continue;
            var dateRange = '';
            if (job.start_date) { dateRange = job.start_date; dateRange += job.end_date ? ' - ' + job.end_date : ' - heute'; }
            if (dateRange) lines.push(dateRange);
            lines.push(job.position || job.title || 'Unbekannte Position');
            lines.push(job.company || 'Unbekanntes Unternehmen');
            if (job.description) lines.push(job.description);
            lines.push('');
        }
    }
    if (itSkills && itSkills.length > 0) { hasContent = true; lines.push('--- IT-KENNTNISSE ---'); lines.push(itSkills.join(', ')); lines.push(''); }
    if (languages && languages.length > 0) {
        hasContent = true; lines.push('--- SPRACHEN ---');
        for (var i = 0; i < languages.length; i++) {
            var lang = languages[i];
            if (!lang || typeof lang !== 'object') continue;
            var langLine = lang.language || 'Unbekannt';
            if (lang.level) langLine += ' (' + lang.level + ')';
            lines.push(langLine);
        }
        lines.push('');
    }
    if (furtherEdu && furtherEdu.length > 0) {
        hasContent = true; lines.push('--- ZERTIFIKATE & WEITERBILDUNGEN ---');
        for (var i = 0; i < furtherEdu.length; i++) {
            var wb = furtherEdu[i]; if (!wb || typeof wb !== 'object') continue;
            var wbLine = wb.degree || wb.qualification || 'Weiterbildung';
            if (wb.institution) wbLine += ' | ' + wb.institution;
            if (wb.year || wb.end_date) wbLine += ' | ' + (wb.year || wb.end_date);
            lines.push(wbLine);
        }
        lines.push('');
    }
    if (education && education.length > 0) {
        hasContent = true; lines.push('--- AUSBILDUNG ---');
        for (var i = 0; i < education.length; i++) {
            var edu = education[i]; if (!edu || typeof edu !== 'object') continue;
            var eduLine = edu.degree || edu.qualification || 'Ausbildung';
            if (edu.institution || edu.school) eduLine += ' | ' + (edu.institution || edu.school);
            if (edu.year || edu.end_date) eduLine += ' | ' + (edu.year || edu.end_date);
            lines.push(eduLine);
        }
        lines.push('');
    }
    if (skills && skills.length > 0) { hasContent = true; lines.push('--- SKILLS & KENNTNISSE ---'); lines.push(skills.join(', ')); lines.push(''); }
    if (!hasContent) return null;
    return lines.join('\n').trim();
}

function copyWerdegang() {
    var text = buildFullProfileText(_candidateName, _werdegangData, _itSkillsData, _languagesData, _furtherEducationData, _educationData, _skillsData);
    if (!text) { if (typeof showToast === 'function') showToast('Kein Profil vorhanden', 'warning'); return; }
    copyToClipboard(text, 'Profil');
}

// ==================== Inline Edit ====================
function startDetailEdit(displayEl) {
    var wrapper = displayEl.closest('.detail-edit-wrapper');
    var input = wrapper.querySelector('.detail-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus(); input.select();
}

function handleDetailEditKey(event, input) {
    if (event.key === 'Enter') { input.blur(); }
    else if (event.key === 'Escape') {
        var wrapper = input.closest('.detail-edit-wrapper');
        var display = wrapper.querySelector('.detail-edit-display');
        input.classList.add('hidden'); display.classList.remove('hidden');
    }
}

function saveDetailEdit(input) {
    var wrapper = input.closest('.detail-edit-wrapper');
    var display = wrapper.querySelector('.detail-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldText = display.textContent.trim();
    var placeholders = ['Keine Position angegeben', 'Kein Unternehmen', 'Vorname', 'Nachname', 'Nicht angegeben'];
    if (placeholders.indexOf(oldText) !== -1) oldText = '';
    if (newValue === oldText) { input.classList.add('hidden'); display.classList.remove('hidden'); return; }
    var body = {}; body[field] = newValue || null;
    fetch('/api/candidates/' + candidateId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.id) {
            var fallbackTexts = { 'current_position': 'Keine Position angegeben', 'current_company': 'Kein Unternehmen', 'first_name': 'Vorname', 'last_name': 'Nachname', 'salary': 'Nicht angegeben', 'notice_period': 'Nicht angegeben' };
            display.textContent = newValue || fallbackTexts[field] || '\u2014';
            if (typeof showToast === 'function') showToast('Gespeichert', 'success');
        }
    })
    .catch(function() { input.value = oldText; })
    .finally(function() { input.classList.add('hidden'); display.classList.remove('hidden'); });
}

// ==================== CV-Vorschau ====================
function openCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');
    iframe.src = '/api/candidates/{{ candidate.id }}/cv-preview';
    overlay.classList.remove('hidden');
    requestAnimationFrame(function() {
        overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-0');
        overlay.querySelector('.cv-overlay-bg').classList.add('opacity-100');
        panel.classList.remove('translate-x-full'); panel.classList.add('translate-x-0');
    });
    document.body.style.overflow = 'hidden';
}

function closeCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');
    panel.classList.remove('translate-x-0'); panel.classList.add('translate-x-full');
    overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-100');
    overlay.querySelector('.cv-overlay-bg').classList.add('opacity-0');
    setTimeout(function() { overlay.classList.add('hidden'); iframe.src = ''; }, 300);
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var overlay = document.getElementById('cv-preview-overlay');
        if (overlay && !overlay.classList.contains('hidden')) closeCvPreview();
    }
});
</script>
{% endblock %}
