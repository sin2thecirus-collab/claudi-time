{% extends "base.html" %}
{% block title %}{{ candidate.full_name or (candidate.first_name ~ ' ' ~ candidate.last_name) }} - Matching-Tool{% endblock %}
{% block content %}
<div class="space-y-4">
    <nav class="flex" aria-label="Breadcrumb"><ol class="flex items-center space-x-2"><li><a href="/" class="text-gray-400 hover:text-gray-500"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" /></svg></a></li><li><div class="flex items-center"><svg class="h-5 w-5 flex-shrink-0 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg><a href="/kandidaten" class="ml-2 text-sm font-medium text-gray-500 hover:text-gray-700">Kandidaten</a></div></li><li><div class="flex items-center"><svg class="h-5 w-5 flex-shrink-0 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg><span class="ml-2 text-sm font-medium text-gray-500">{{ candidate.full_name or 'Details' }}</span></div></li></ol></nav>

    {# ===== Hero-Banner Header ===== #}
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg overflow-hidden">
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 px-8 py-6">
            <div class="flex items-center space-x-6">
                <span class="inline-flex h-20 w-20 items-center justify-center rounded-full bg-primary-100 ring-4 ring-white flex-shrink-0 shadow-sm">
                    <span class="text-2xl font-bold text-primary-700">{{ (candidate.first_name or 'X')[0] | upper }}{{ (candidate.last_name or 'X')[0] | upper }}</span>
                </span>
                <div class="flex-1 min-w-0">
                    {# Name - editierbar (Vorname + Nachname) #}
                    <div class="flex items-center gap-2">
                        <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="first_name">
                            <span class="detail-edit-display text-3xl font-bold text-gray-900 cursor-pointer hover:bg-yellow-50 hover:ring-1 hover:ring-yellow-300 rounded px-1 py-0.5 transition-all" onclick="startDetailEdit(this)" title="Vorname bearbeiten">{{ candidate.first_name or 'Vorname' }}</span>
                            <input type="text" class="detail-edit-input hidden rounded-md border-0 py-1 px-2 text-2xl font-bold text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600 w-48" value="{{ candidate.first_name or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)">
                        </div>
                        <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="last_name">
                            <span class="detail-edit-display text-3xl font-bold text-gray-900 cursor-pointer hover:bg-yellow-50 hover:ring-1 hover:ring-yellow-300 rounded px-1 py-0.5 transition-all" onclick="startDetailEdit(this)" title="Nachname bearbeiten">{{ candidate.last_name or 'Nachname' }}</span>
                            <input type="text" class="detail-edit-input hidden rounded-md border-0 py-1 px-2 text-2xl font-bold text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600 w-48" value="{{ candidate.last_name or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)">
                        </div>
                    </div>
                    {# Position + Firma - editierbar #}
                    <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1">
                        <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_position">
                            <span class="detail-edit-display text-lg text-gray-500 cursor-pointer hover:bg-yellow-50 hover:ring-1 hover:ring-yellow-300 rounded px-1 py-0.5 transition-all" onclick="startDetailEdit(this)" title="Position bearbeiten">{{ candidate.current_position or 'Keine Position angegeben' }}</span>
                            <input type="text" class="detail-edit-input hidden rounded-md border-0 py-1 px-2 text-base text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600" value="{{ candidate.current_position or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)">
                        </div>
                        <span class="text-gray-300 mx-1">&bull;</span>
                        <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_company">
                            <span class="detail-edit-display text-lg text-gray-400 cursor-pointer hover:bg-yellow-50 hover:ring-1 hover:ring-yellow-300 rounded px-1 py-0.5 transition-all" onclick="startDetailEdit(this)" title="Unternehmen bearbeiten">{{ candidate.current_company or 'Kein Unternehmen' }}</span>
                            <input type="text" class="detail-edit-input hidden rounded-md border-0 py-1 px-2 text-base text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600" value="{{ candidate.current_company or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)">
                        </div>
                    </div>
                    {# Jobtitel + Rating #}
                    {% if candidate.manual_job_titles and candidate.manual_job_titles | length > 0 %}
                    <div class="mt-2 flex flex-wrap items-center gap-2">
                        {% for title in candidate.manual_job_titles %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-green-50 px-3 py-1 text-sm font-medium text-green-700 ring-1 ring-inset ring-green-200">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
                            {{ title }}
                        </span>
                        {% endfor %}
                        {% if candidate.rating %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 px-3 py-1 text-sm font-medium text-amber-700 ring-1 ring-inset ring-amber-200">
                            {% for i in range(1, 11) %}
                            <svg class="w-3 h-3 {% if i <= candidate.rating %}text-amber-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            {% endfor %}
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}

                    {# Meta-Badges #}
                    <div class="mt-2 flex flex-wrap items-center gap-2">
                        {% if candidate.birth_date or candidate.age %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-white px-3 py-1 text-sm text-gray-500 ring-1 ring-inset ring-gray-200">
                            <svg class="h-3.5 w-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
                            {% if candidate.birth_date %}{{ candidate.birth_date.strftime('%d.%m.%Y') }}{% endif %}{% if candidate.age %} ({{ candidate.age }} Jahre){% endif %}
                        </span>
                        {% endif %}
                        {% if candidate.city %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-white px-3 py-1 text-sm text-gray-500 ring-1 ring-inset ring-gray-200">
                            <svg class="h-3.5 w-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
                            {{ candidate.city }}{% if candidate.postal_code %}, {{ candidate.postal_code }}{% endif %}
                        </span>
                        {% endif %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-white px-3 py-1 text-sm text-gray-400 ring-1 ring-inset ring-gray-200">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Seit {{ candidate.created_at.strftime('%d.%m.%Y') if candidate.created_at else 'Unbekannt' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {# Button-Leiste mit Alpine.js fuer Pipeline-Modal #}
        <div x-data="{
            showPipelineModal: false,
            jobs: [],
            selectedJob: '',
            selectedStage: 'sent',
            loading: false,
            // Neue Stelle erstellen
            showNewJobForm: false,
            newJobTitle: '',
            newJobCompanyId: '',
            newJobCompanyName: '',
            newJobCity: '',
            companies: [],
            filteredCompanies: [],
            creatingJob: false,
            async loadJobs() {
                try {
                    const response = await fetch('/api/ats/jobs');
                    const data = await response.json();
                    console.log('Jobs API response:', data);
                    this.jobs = (data.items || data || []).map(item => item.job || item);
                    console.log('Loaded jobs:', this.jobs);
                } catch (err) {
                    console.error('Error loading jobs:', err);
                }
            },
            async loadCompanies() {
                const response = await fetch('/api/companies?limit=500');
                const data = await response.json();
                this.companies = data.items || [];
            },
            filterCompanies() {
                if (!this.newJobCompanyName) {
                    this.filteredCompanies = [];
                    return;
                }
                const term = this.newJobCompanyName.toLowerCase();
                this.filteredCompanies = this.companies
                    .filter(c => c.name.toLowerCase().includes(term))
                    .slice(0, 10);
            },
            selectCompany(company) {
                this.newJobCompanyId = company.id;
                this.newJobCompanyName = company.name;
                this.filteredCompanies = [];
            },
            async createJob() {
                if (!this.newJobTitle || !this.newJobCompanyId) return;
                this.creatingJob = true;
                const response = await fetch('/api/ats/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.newJobTitle,
                        company_id: this.newJobCompanyId,
                        location_city: this.newJobCity || null
                    })
                });
                if (response.ok) {
                    const job = await response.json();
                    this.jobs.push(job);
                    this.selectedJob = job.id;
                    this.showNewJobForm = false;
                    this.newJobTitle = '';
                    this.newJobCompanyId = '';
                    this.newJobCompanyName = '';
                    this.newJobCity = '';
                    showToast('Stelle erstellt', 'success');
                } else {
                    showToast('Fehler beim Erstellen', 'error');
                }
                this.creatingJob = false;
            },
            async addToPipeline() {
                if (!this.selectedJob) return;
                this.loading = true;
                const response = await fetch('/api/ats/pipeline/' + this.selectedJob + '/candidates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        candidate_id: '{{ candidate.id }}',
                        stage: this.selectedStage
                    })
                });
                if (response.ok) {
                    showToast('Kandidat zur Pipeline hinzugefuegt', 'success');
                    this.showPipelineModal = false;
                    this.selectedJob = '';
                    this.selectedStage = 'sent';
                    htmx.trigger('#candidate-pipeline', 'load');
                } else if (response.status === 409) {
                    showToast('Kandidat ist bereits in dieser Pipeline', 'warning');
                } else {
                    showToast('Fehler beim Hinzufuegen', 'error');
                }
                this.loading = false;
            }
        }" class="bg-gray-50 border-t border-gray-200 px-6 py-2.5 flex items-center gap-3">
            {% if candidate.crm_id %}
            <a href="https://app.recruitcrm.io/candidate/{{ candidate.crm_id }}" target="_blank" class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                Im CRM oeffnen
            </a>
            {% endif %}
            {% if candidate.cv_url %}
            <a href="{{ candidate.cv_url }}" target="_blank" class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                CV herunterladen
            </a>
            <button type="button" onclick="openCvPreview()" class="inline-flex items-center rounded-md bg-primary-50 px-4 py-2 text-sm font-semibold text-primary-700 shadow-sm ring-1 ring-inset ring-primary-300 hover:bg-primary-100">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                CV ansehen
            </button>
            {% endif %}
            {# Zur Pipeline Button #}
            <button type="button" @click="showPipelineModal = true; loadJobs()"
                    class="inline-flex items-center rounded-md bg-green-50 px-4 py-2 text-sm font-semibold text-green-700 shadow-sm ring-1 ring-inset ring-green-300 hover:bg-green-100">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Zur Pipeline
            </button>
            <div class="flex-1"></div>
            {% if not candidate.hidden %}
            <button type="button" hx-put="/api/candidates/{{ candidate.id }}/hide" hx-swap="none" hx-on::after-request="showToast('Kandidat ausgeblendet', 'success')" class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-200">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                Ausblenden
            </button>
            {% else %}
            <button type="button" hx-put="/api/candidates/{{ candidate.id }}/unhide" hx-swap="none" hx-on::after-request="showToast('Kandidat wieder eingeblendet', 'success')" class="inline-flex items-center rounded-md bg-green-50 px-3 py-2 text-sm font-semibold text-green-700 hover:bg-green-100">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Wieder einblenden
            </button>
            {% endif %}
            <button type="button" onclick="deleteCandidate('{{ candidate.id }}', '{{ candidate.first_name }} {{ candidate.last_name }}')" class="inline-flex items-center rounded-md bg-red-50 px-3 py-2 text-sm font-semibold text-red-700 hover:bg-red-100 ring-1 ring-inset ring-red-200">
                <svg class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                Loeschen
            </button>

            {# Pipeline Modal #}
            <div x-show="showPipelineModal" x-cloak
                 class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div x-show="showPipelineModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                         x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                         class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showPipelineModal = false"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
                    <div x-show="showPipelineModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200"
                         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                         class="inline-block align-bottom bg-white rounded-lg px-6 pt-7 pb-6 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-8">
                        <div>
                            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100">
                                <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                            </div>
                            <div class="mt-4 text-center sm:mt-6">
                                <h3 class="text-2xl leading-7 font-medium text-gray-900" id="modal-title">Zur Pipeline hinzufuegen</h3>
                                <p class="mt-3 text-base text-gray-500">Waehlen Sie eine Stelle und die Pipeline-Phase aus.</p>
                            </div>
                        </div>
                        <div class="mt-6 space-y-5">
                            <div>
                                <label for="pipeline-job" class="block text-base font-medium text-gray-700">Stelle</label>
                                <select id="pipeline-job" x-model="selectedJob" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base py-3">
                                    <option value="">Stelle auswaehlen...</option>
                                    <template x-for="job in jobs" :key="job.id">
                                        <option :value="job.id" x-text="job.company_name ? job.company_name + ' - ' + job.title : job.title"></option>
                                    </template>
                                </select>
                                {# Link zum Neue Stelle Formular #}
                                <div class="mt-3">
                                    <button type="button" @click="showNewJobForm = !showNewJobForm; if(showNewJobForm && companies.length === 0) loadCompanies()"
                                            class="text-base text-primary-600 hover:text-primary-800 flex items-center gap-1.5 font-medium">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                        </svg>
                                        <span x-text="showNewJobForm ? 'Abbrechen' : 'Neue Stelle erstellen'"></span>
                                    </button>
                                </div>
                                {# Inline Formular fuer neue Stelle #}
                                <div x-show="showNewJobForm" x-cloak class="mt-4 p-5 bg-gray-50 rounded-lg border border-gray-200 space-y-4">
                                    <div>
                                        <label class="block text-base font-medium text-gray-700">Stellentitel *</label>
                                        <input type="text" x-model="newJobTitle" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base py-2.5" placeholder="z.B. Senior Accountant">
                                    </div>
                                    <div class="relative" @click.away="filteredCompanies = []">
                                        <label class="block text-base font-medium text-gray-700">Unternehmen *</label>
                                        <input type="text" x-model="newJobCompanyName" @input="filterCompanies()" @focus="filterCompanies()"
                                               class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base py-2.5" placeholder="Unternehmen suchen...">
                                        <div x-show="filteredCompanies.length > 0" class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                            <template x-for="company in filteredCompanies" :key="company.id">
                                                <button type="button" @click="selectCompany(company)" class="w-full text-left px-4 py-3 text-base hover:bg-gray-100" x-text="company.name"></button>
                                            </template>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-base font-medium text-gray-700">Ort (optional)</label>
                                        <input type="text" x-model="newJobCity" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-base py-2.5" placeholder="z.B. Berlin">
                                    </div>
                                    <div class="flex gap-3 pt-2">
                                        <button type="button" @click="createJob()" :disabled="!newJobTitle || !newJobCompanyId || creatingJob"
                                                class="inline-flex items-center px-5 py-2.5 text-base font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                            <svg x-show="creatingJob" class="animate-spin -ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                            </svg>
                                            Stelle erstellen
                                        </button>
                                        <button type="button" @click="showNewJobForm = false"
                                                class="px-5 py-2.5 text-base font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                            Abbrechen
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="pipeline-stage" class="block text-base font-medium text-gray-700">Phase</label>
                                <select id="pipeline-stage" x-model="selectedStage" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                    <option value="sent">Vorgestellt</option>
                                    <option value="interview_1">Interview 1</option>
                                    <option value="interview_2">Interview 2</option>
                                    <option value="interview_3">Interview 3</option>
                                    <option value="offer">Angebot</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-7 sm:mt-8 sm:grid sm:grid-cols-2 sm:gap-4 sm:grid-flow-row-dense">
                            <button type="button" @click="addToPipeline()" :disabled="!selectedJob || loading"
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-5 py-3 bg-green-600 text-lg font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:col-start-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg x-show="loading" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Hinzufuegen
                            </button>
                            <button type="button" @click="showPipelineModal = false"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-5 py-3 bg-white text-lg font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:col-start-1">
                                Abbrechen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ===== Hauptbereich: 2 Spalten ===== #}
    <div class="lg:grid lg:grid-cols-3 lg:gap-4">
        {# === Linke Spalte (2/3) === #}
        <div class="lg:col-span-2 space-y-3">

            {# Kontaktdaten - mit Kopier-Buttons, groessere Schrift #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-5 py-3"><h3 class="text-xl font-semibold leading-6 text-gray-900">Kontaktdaten</h3></div>
                <div class="border-t border-gray-200 px-5 py-3">
                    <dl class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">E-Mail</dt>
                            <dd class="mt-1 flex items-center gap-2">
                                {% if candidate.email %}
                                <a href="mailto:{{ candidate.email }}" class="text-lg text-primary-600 hover:text-primary-500">{{ candidate.email }}</a>
                                <button type="button" onclick="copyToClipboard('{{ candidate.email }}', 'E-Mail')" class="flex-shrink-0 p-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 transition-colors" title="E-Mail kopieren">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                </button>
                                {% else %}<span class="text-lg text-gray-400">Keine Angabe</span>{% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Telefon</dt>
                            <dd class="mt-1 flex items-center gap-2">
                                {% if candidate.phone %}
                                <a href="tel:{{ candidate.phone }}" class="text-lg text-primary-600 hover:text-primary-500">{{ candidate.phone }}</a>
                                <button type="button" onclick="copyToClipboard('{{ candidate.phone }}', 'Telefonnummer')" class="flex-shrink-0 p-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 transition-colors" title="Telefonnummer kopieren">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                </button>
                                {% else %}<span class="text-lg text-gray-400">Keine Angabe</span>{% endif %}
                            </dd>
                        </div>
                        <div class="sm:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">Adresse</dt>
                            <dd class="mt-1 flex items-center gap-2">
                                {% if candidate.street_address or candidate.postal_code or candidate.city %}
                                <span class="text-lg text-gray-900" id="address-text">{% if candidate.street_address %}{{ candidate.street_address }}{% endif %}{% if candidate.postal_code or candidate.city %}{% if candidate.street_address %}, {% endif %}{{ candidate.postal_code }} {{ candidate.city }}{% endif %}</span>
                                <button type="button" onclick="copyToClipboard(document.getElementById('address-text').textContent.trim(), 'Adresse')" class="flex-shrink-0 p-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 transition-colors" title="Adresse kopieren">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                                </button>
                                {% else %}<span class="text-lg text-gray-400">Keine Angabe</span>{% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>

            {# Berufserfahrung #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-5 py-3 flex items-center justify-between">
                    <h3 class="text-xl font-semibold leading-6 text-gray-900">Berufserfahrung</h3>
                    <button type="button"
                            onclick="copyWerdegang()"
                            class="inline-flex items-center rounded-md bg-gray-100 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors"
                            title="Komplettes Profil in Zwischenablage kopieren">
                        <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                        </svg>
                        Profil kopieren
                    </button>
                </div>
                <div class="border-t border-gray-200">
                    {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
                    <ul class="divide-y divide-gray-200">
                        {% for job in candidate.work_history %}{% if job is mapping %}
                        <li class="px-5 py-3">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-lg font-semibold text-gray-900">{{ job.position | default(job.title | default('Unbekannte Position')) }}</p>
                                    <p class="text-base text-gray-500">{{ job.company | default('Unbekanntes Unternehmen') }}</p>
                                </div>
                                <div class="text-sm text-gray-400 text-right whitespace-nowrap ml-4">{% if job.start_date %}{{ job.start_date }}{% endif %}{% if job.end_date %} - {{ job.end_date }}{% elif job.start_date %} - heute{% endif %}</div>
                            </div>
                            {% if job.description and job.description != 'null' %}
                            <ul class="mt-2 text-base text-gray-600 list-none space-y-1">{% for line in job.description.split('\n') %}{% if line.strip() %}<li class="flex"><span class="flex-shrink-0 mr-2 text-gray-400">&bull;</span><span>{{ line.strip().lstrip('â€¢').strip() }}</span></li>{% endif %}{% endfor %}</ul>
                            {% endif %}
                        </li>
                        {% endif %}{% endfor %}
                    </ul>
                    {% else %}
                    <div class="px-5 py-4"><p class="text-base text-gray-400">Keine Angaben</p></div>
                    {% endif %}
                </div>
            </div>

            {# IT-Kenntnisse #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-5 py-3"><h3 class="text-xl font-semibold leading-6 text-gray-900">IT-Kenntnisse</h3></div>
                <div class="border-t border-gray-200 px-5 py-3">
                    {% if candidate.it_skills and candidate.it_skills | length > 0 %}
                    <div class="flex flex-wrap gap-2">{% for skill in candidate.it_skills %}<span class="inline-flex items-center rounded-full bg-blue-50 px-3.5 py-1.5 text-base font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">{{ skill }}</span>{% endfor %}</div>
                    {% else %}<p class="text-base text-gray-400">Keine Angaben</p>{% endif %}
                </div>
            </div>

            {# Sprachen #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-5 py-3"><h3 class="text-xl font-semibold leading-6 text-gray-900">Sprachen</h3></div>
                <div class="border-t border-gray-200 px-5 py-3">
                    {% if candidate.languages and candidate.languages is iterable and candidate.languages is not string and candidate.languages | length > 0 %}
                    <div class="space-y-2">{% for lang in candidate.languages %}{% if lang is mapping %}<div class="flex items-center justify-between"><span class="text-lg font-medium text-gray-900">{{ lang.language | default('Unbekannt') }}</span>{% if lang.level %}<span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-0.5 text-sm font-medium text-green-700 ring-1 ring-inset ring-green-700/10">{{ lang.level }}</span>{% endif %}</div>{% endif %}{% endfor %}</div>
                    {% else %}<p class="text-base text-gray-400">Keine Angaben</p>{% endif %}
                </div>
            </div>

            {# Skills #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-5 py-3"><h3 class="text-xl font-semibold leading-6 text-gray-900">Skills & Kenntnisse</h3></div>
                <div class="border-t border-gray-200 px-5 py-3">
                    {% if candidate.skills and candidate.skills | length > 0 %}
                    <div class="flex flex-wrap gap-2">{% for skill in candidate.skills %}<span class="inline-flex items-center rounded-full bg-primary-50 px-3.5 py-1.5 text-base font-medium text-primary-700 ring-1 ring-inset ring-primary-700/10">{{ skill }}</span>{% endfor %}</div>
                    {% else %}<p class="text-base text-gray-400">Keine Angaben</p>{% endif %}
                </div>
            </div>

            {# Zertifikate & Weiterbildungen #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-5 py-3"><h3 class="text-xl font-semibold leading-6 text-gray-900">Zertifikate & Weiterbildungen</h3></div>
                <div class="border-t border-gray-200">
                    {% if candidate.further_education and candidate.further_education is iterable and candidate.further_education is not string and candidate.further_education | length > 0 %}
                    <ul class="divide-y divide-gray-200">{% for wb in candidate.further_education %}{% if wb is mapping %}<li class="px-5 py-3"><div class="flex items-start justify-between"><div><p class="text-lg font-medium text-gray-900">{% if wb.degree and wb.degree != 'None' and wb.degree != 'null' %}{{ wb.degree }}{% elif wb.qualification and wb.qualification != 'None' and wb.qualification != 'null' %}{{ wb.qualification }}{% else %}Weiterbildung{% endif %}</p><p class="text-sm text-gray-500">{{ wb.institution | default('Unbekannter Anbieter') }}</p></div><div class="text-sm text-gray-400 text-right whitespace-nowrap ml-4">{% if wb.year %}{{ wb.year }}{% elif wb.end_date %}{{ wb.end_date }}{% endif %}</div></div></li>{% endif %}{% endfor %}</ul>
                    {% else %}<div class="px-5 py-4"><p class="text-base text-gray-400">Keine Angaben</p></div>{% endif %}
                </div>
            </div>

            {# Ausbildung #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-5 py-3"><h3 class="text-xl font-semibold leading-6 text-gray-900">Ausbildung</h3></div>
                <div class="border-t border-gray-200">
                    {% if candidate.education and candidate.education is iterable and candidate.education is not string and candidate.education | length > 0 %}
                    <ul class="divide-y divide-gray-200">{% for edu in candidate.education %}{% if edu is mapping %}<li class="px-5 py-3"><div class="flex items-start justify-between"><div><p class="text-lg font-medium text-gray-900">{% if edu.degree and edu.degree != 'None' and edu.degree != 'null' %}{{ edu.degree }}{% elif edu.qualification and edu.qualification != 'None' and edu.qualification != 'null' %}{{ edu.qualification }}{% else %}Ausbildung{% endif %}</p><p class="text-sm text-gray-500">{{ edu.institution | default(edu.school | default('Unbekannte Institution')) }}</p></div><div class="text-sm text-gray-400 text-right whitespace-nowrap ml-4">{% if edu.year %}{{ edu.year }}{% elif edu.end_date %}{{ edu.end_date }}{% endif %}</div></div></li>{% endif %}{% endfor %}</ul>
                    {% else %}<div class="px-5 py-4"><p class="text-base text-gray-400">Keine Angaben</p></div>{% endif %}
                </div>
            </div>
        </div>

        {# === Rechte Spalte (1/3) - kompakter === #}
        <div class="mt-3 lg:mt-0 space-y-3">
            {# Pipeline-Status bei Jobs #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-2.5 flex items-center justify-between">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900">Pipeline-Status</h3>
                    <a href="/ats/pipeline" class="text-xs text-primary-600 hover:text-primary-500 font-medium">Pipeline</a>
                </div>
                <div id="candidate-pipeline" hx-get="/partials/candidate-pipeline/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="border-t border-gray-200">
                    <div class="p-2">{% include 'components/loading_spinner.html' %}</div>
                </div>
            </div>

            {# Passende Jobs #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-2.5"><h3 class="text-lg font-semibold leading-6 text-gray-900">Passende Jobs</h3></div>
                <div id="matching-jobs" hx-get="/partials/candidate-jobs/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="border-t border-gray-200">
                    <div class="p-2">{% include 'components/loading_spinner.html' %}</div>
                </div>
            </div>

            {# CV-Status - kompakter #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-2.5"><h3 class="text-lg font-semibold leading-6 text-gray-900">CV-Status</h3></div>
                <div class="border-t border-gray-200 px-4 py-2.5">
                    <dl class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">CV vorhanden:</dt>
                            <dd class="font-medium {% if candidate.cv_url %}text-green-600{% else %}text-gray-400{% endif %}">{% if candidate.cv_url %}Ja{% else %}Nein{% endif %}</dd>
                        </div>
                        {% if candidate.cv_parsed_at %}
                        <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Zuletzt geparst:</dt>
                            <dd class="font-medium text-gray-900">{{ candidate.cv_parsed_at.strftime('%d.%m.%Y %H:%M') }}</dd>
                        </div>
                        {% endif %}
                        {% if candidate.crm_synced_at %}
                        <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Letzter CRM-Sync:</dt>
                            <dd class="font-medium text-gray-900">{{ candidate.crm_synced_at.strftime('%d.%m.%Y %H:%M') }}</dd>
                        </div>
                        {% endif %}
                    </dl>
                    {% if candidate.cv_url %}
                    <div class="mt-3">
                        <button type="button" hx-post="/api/candidates/{{ candidate.id }}/parse-cv" hx-swap="none" hx-on::after-request="showToast('CV wird neu geparst...', 'info'); setTimeout(() => location.reload(), 3000)" class="w-full inline-flex justify-center items-center rounded-md bg-gray-50 px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100">
                            <svg class="h-4 w-4 mr-1.5 htmx-indicator animate-spin" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            CV neu parsen
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function deleteCandidate(candidateId, candidateName) {
    if (!confirm('Kandidat ' + candidateName + ' wirklich loeschen? Der Kandidat wird beim naechsten CRM-Sync ignoriert.')) {
        return;
    }
    fetch('/api/candidates/' + candidateId, {
        method: 'DELETE'
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            window.location.href = '/kandidaten';
        }
    });
}

// ==================== Kopieren ====================

function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(function() {
        if (typeof showToast === 'function') {
            showToast(label + ' kopiert', 'success');
        }
    }).catch(function() {
        // Fallback fuer aeltere Browser
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        if (typeof showToast === 'function') {
            showToast(label + ' kopiert', 'success');
        }
    });
}

// ==================== Werdegang kopieren ====================

var _werdegangData = {{ (candidate.work_history or []) | tojson | safe }};
var _itSkillsData = {{ (candidate.it_skills or []) | tojson | safe }};
var _languagesData = {{ (candidate.languages or []) | tojson | safe }};
var _furtherEducationData = {{ (candidate.further_education or []) | tojson | safe }};
var _educationData = {{ (candidate.education or []) | tojson | safe }};
var _skillsData = {{ (candidate.skills or []) | tojson | safe }};
var _candidateName = {{ (candidate.full_name or ((candidate.first_name or '') ~ ' ' ~ (candidate.last_name or ''))) | tojson | safe }};

function buildFullProfileText(name, workHistory, itSkills, languages, furtherEdu, education, skills) {
    var lines = [];
    var hasContent = false;

    // 1. Berufserfahrung
    if (workHistory && workHistory.length > 0) {
        hasContent = true;
        lines.push('--- BERUFSERFAHRUNG ---');
        lines.push('');
        for (var i = 0; i < workHistory.length; i++) {
            var job = workHistory[i];
            if (!job || typeof job !== 'object') continue;
            var dateRange = '';
            if (job.start_date) {
                dateRange = job.start_date;
                dateRange += job.end_date ? ' - ' + job.end_date : ' - heute';
            }
            if (dateRange) lines.push(dateRange);
            lines.push(job.position || job.title || 'Unbekannte Position');
            lines.push(job.company || 'Unbekanntes Unternehmen');
            if (job.description) lines.push(job.description);
            lines.push('');
        }
    }

    // 2. IT-Kenntnisse
    if (itSkills && itSkills.length > 0) {
        hasContent = true;
        lines.push('--- IT-KENNTNISSE ---');
        lines.push(itSkills.join(', '));
        lines.push('');
    }

    // 3. Sprachen
    if (languages && languages.length > 0) {
        hasContent = true;
        lines.push('--- SPRACHEN ---');
        for (var i = 0; i < languages.length; i++) {
            var lang = languages[i];
            if (!lang || typeof lang !== 'object') continue;
            var langLine = lang.language || 'Unbekannt';
            if (lang.level) langLine += ' (' + lang.level + ')';
            lines.push(langLine);
        }
        lines.push('');
    }

    // 4. Zertifikate & Weiterbildungen
    if (furtherEdu && furtherEdu.length > 0) {
        hasContent = true;
        lines.push('--- ZERTIFIKATE & WEITERBILDUNGEN ---');
        for (var i = 0; i < furtherEdu.length; i++) {
            var wb = furtherEdu[i];
            if (!wb || typeof wb !== 'object') continue;
            var wbTitle = wb.degree || wb.qualification || 'Weiterbildung';
            var wbInst = wb.institution || '';
            var wbDate = wb.year || wb.end_date || '';
            var wbLine = wbTitle;
            if (wbInst) wbLine += ' | ' + wbInst;
            if (wbDate) wbLine += ' | ' + wbDate;
            lines.push(wbLine);
        }
        lines.push('');
    }

    // 5. Ausbildung
    if (education && education.length > 0) {
        hasContent = true;
        lines.push('--- AUSBILDUNG ---');
        for (var i = 0; i < education.length; i++) {
            var edu = education[i];
            if (!edu || typeof edu !== 'object') continue;
            var eduTitle = edu.degree || edu.qualification || 'Ausbildung';
            var eduInst = edu.institution || edu.school || '';
            var eduDate = edu.year || edu.end_date || '';
            var eduLine = eduTitle;
            if (eduInst) eduLine += ' | ' + eduInst;
            if (eduDate) eduLine += ' | ' + eduDate;
            lines.push(eduLine);
        }
        lines.push('');
    }

    // 6. Skills & Kenntnisse
    if (skills && skills.length > 0) {
        hasContent = true;
        lines.push('--- SKILLS & KENNTNISSE ---');
        lines.push(skills.join(', '));
        lines.push('');
    }

    if (!hasContent) return null;
    return lines.join('\n').trim();
}

function copyWerdegang() {
    var text = buildFullProfileText(_candidateName, _werdegangData, _itSkillsData, _languagesData, _furtherEducationData, _educationData, _skillsData);
    if (!text) {
        if (typeof showToast === 'function') showToast('Kein Profil vorhanden', 'warning');
        return;
    }
    copyToClipboard(text, 'Profil');
}

// ==================== Inline Edit (Detailseite) ====================

function startDetailEdit(displayEl) {
    var wrapper = displayEl.closest('.detail-edit-wrapper');
    var input = wrapper.querySelector('.detail-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus();
    input.select();
}

function handleDetailEditKey(event, input) {
    if (event.key === 'Enter') {
        input.blur();
    } else if (event.key === 'Escape') {
        var wrapper = input.closest('.detail-edit-wrapper');
        var display = wrapper.querySelector('.detail-edit-display');
        input.classList.add('hidden');
        display.classList.remove('hidden');
    }
}

function saveDetailEdit(input) {
    var wrapper = input.closest('.detail-edit-wrapper');
    var display = wrapper.querySelector('.detail-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldText = display.textContent.trim();

    // Placeholder-Texte als leer behandeln
    var placeholders = ['Keine Position angegeben', 'Kein Unternehmen', 'Vorname', 'Nachname'];
    if (placeholders.indexOf(oldText) !== -1) {
        oldText = '';
    }

    if (newValue === oldText) {
        input.classList.add('hidden');
        display.classList.remove('hidden');
        return;
    }

    var body = {};
    body[field] = newValue || null;

    fetch('/api/candidates/' + candidateId, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.id) {
            var fallbackTexts = {
                'current_position': 'Keine Position angegeben',
                'current_company': 'Kein Unternehmen',
                'first_name': 'Vorname',
                'last_name': 'Nachname'
            };
            display.textContent = newValue || fallbackTexts[field] || 'â€”';
            if (typeof showToast === 'function') {
                showToast('Gespeichert', 'success');
            }
        }
    })
    .catch(function() {
        input.value = oldText;
    })
    .finally(function() {
        input.classList.add('hidden');
        display.classList.remove('hidden');
    });
}

// ==================== CV-Vorschau Slide-Over ====================

function openCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');

    iframe.src = '/api/candidates/{{ candidate.id }}/cv-preview';

    overlay.classList.remove('hidden');
    requestAnimationFrame(function() {
        overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-0');
        overlay.querySelector('.cv-overlay-bg').classList.add('opacity-100');
        panel.classList.remove('translate-x-full');
        panel.classList.add('translate-x-0');
    });

    document.body.style.overflow = 'hidden';
}

function closeCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');

    panel.classList.remove('translate-x-0');
    panel.classList.add('translate-x-full');
    overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-100');
    overlay.querySelector('.cv-overlay-bg').classList.add('opacity-0');

    setTimeout(function() {
        overlay.classList.add('hidden');
        iframe.src = '';
    }, 300);

    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var overlay = document.getElementById('cv-preview-overlay');
        if (overlay && !overlay.classList.contains('hidden')) {
            closeCvPreview();
        }
    }
});
</script>

{# CV-Vorschau Slide-Over Panel #}
{% if candidate.cv_url %}
<div id="cv-preview-overlay" class="hidden relative z-50" aria-labelledby="cv-preview-title" role="dialog" aria-modal="true">
    <div class="cv-overlay-bg fixed inset-0 bg-gray-500/75 transition-opacity duration-300 ease-in-out opacity-0" onclick="closeCvPreview()"></div>
    <div class="fixed inset-0 overflow-hidden">
        <div class="absolute inset-0 overflow-hidden">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
                <div id="cv-preview-panel" class="pointer-events-auto w-screen max-w-2xl transform transition-transform duration-300 ease-in-out translate-x-full">
                    <div class="flex h-full flex-col bg-white shadow-xl">
                        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
                            <div>
                                <h2 id="cv-preview-title" class="text-lg font-semibold text-gray-900">CV-Vorschau</h2>
                                <p class="text-sm text-gray-500">{{ candidate.full_name or (candidate.first_name ~ ' ' ~ candidate.last_name) }}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <a href="{{ candidate.cv_url }}" target="_blank" class="inline-flex items-center rounded-md bg-white px-3.5 py-1.5 text-base font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" title="In neuem Tab oeffnen">
                                    <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                                    Neuer Tab
                                </a>
                                <button type="button" onclick="closeCvPreview()" class="rounded-md bg-white p-2 text-gray-400 hover:text-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" title="Schliessen (ESC)">
                                    <span class="sr-only">Schliessen</span>
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-hidden relative">
                            <iframe id="cv-preview-iframe" src="" class="w-full h-full border-0" title="CV-Vorschau"></iframe>
                            <div id="cv-preview-fallback" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-50 p-8">
                                <svg class="h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                                <p class="mt-4 text-sm text-gray-500">CV konnte nicht geladen werden.</p>
                                <a href="{{ candidate.cv_url }}" target="_blank" class="mt-3 text-sm font-medium text-primary-600 hover:text-primary-500">Direkt herunterladen</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
