{% extends "base.html" %}
{% block title %}{{ candidate.full_name or (candidate.first_name ~ ' ' ~ candidate.last_name) }} - Matching-Tool{% endblock %}
{% block content %}
<div class="space-y-6">
    <nav class="flex" aria-label="Breadcrumb"><ol class="flex items-center space-x-2"><li><a href="/" class="text-gray-400 hover:text-gray-500"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" /></svg></a></li><li><div class="flex items-center"><svg class="h-5 w-5 flex-shrink-0 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg><span class="ml-2 text-sm font-medium text-gray-500">Kandidaten-Details</span></div></li></ol></nav>
    {# Hero-Banner Header #}
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg overflow-hidden">
        {# Farbiger Banner-Bereich #}
        <div class="bg-gradient-to-r from-primary-600 to-primary-800 px-8 py-8">
            <div class="flex items-center space-x-6">
                <span class="inline-flex h-24 w-24 items-center justify-center rounded-full bg-white/20 ring-4 ring-white/30 flex-shrink-0">
                    <span class="text-3xl font-bold text-white">{{ (candidate.first_name or 'X')[0] | upper }}{{ (candidate.last_name or 'X')[0] | upper }}</span>
                </span>
                <div>
                    <h1 class="text-3xl font-bold text-white">{{ candidate.full_name or (candidate.first_name ~ ' ' ~ candidate.last_name) | default('Unbekannt') }}</h1>
                    <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1">
                        <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_position">
                            <span class="detail-edit-display text-xl text-primary-100 cursor-pointer hover:bg-white/10 rounded px-1 py-0.5 transition-all" onclick="startDetailEdit(this)" title="Klicken zum Bearbeiten">{{ candidate.current_position or 'Keine Position angegeben' }}</span>
                            <input type="text" class="detail-edit-input hidden rounded-md border-0 py-1 px-2 text-lg text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600" value="{{ candidate.current_position or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)">
                        </div>
                        <span class="text-primary-300/60 mx-1">&bull;</span>
                        <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_company">
                            <span class="detail-edit-display text-xl text-primary-200 cursor-pointer hover:bg-white/10 rounded px-1 py-0.5 transition-all" onclick="startDetailEdit(this)" title="Klicken zum Bearbeiten">{{ candidate.current_company or 'Kein Unternehmen' }}</span>
                            <input type="text" class="detail-edit-input hidden rounded-md border-0 py-1 px-2 text-lg text-gray-900 ring-1 ring-inset ring-primary-400 focus:ring-2 focus:ring-primary-600" value="{{ candidate.current_company or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)">
                        </div>
                    </div>
                    <div class="mt-3 flex flex-wrap items-center gap-3">
                        {% if candidate.birth_date or candidate.age %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-white/10 px-3 py-1 text-sm text-primary-100">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
                            {% if candidate.birth_date %}{{ candidate.birth_date.strftime('%d.%m.%Y') }}{% endif %}{% if candidate.age %} ({{ candidate.age }} Jahre){% endif %}
                        </span>
                        {% endif %}
                        {% if candidate.city %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-white/10 px-3 py-1 text-sm text-primary-100">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
                            {{ candidate.city }}{% if candidate.postal_code %}, {{ candidate.postal_code }}{% endif %}
                        </span>
                        {% endif %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-white/10 px-3 py-1 text-sm text-primary-100">
                            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Seit {{ candidate.created_at.strftime('%d.%m.%Y') if candidate.created_at else 'Unbekannt' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {# Button-Leiste unter dem Banner #}
        <div class="bg-gray-50 border-t border-gray-200 px-6 py-3 flex items-center gap-3">
            {% if candidate.crm_id %}
            <a href="https://app.recruitcrm.io/candidate/{{ candidate.crm_id }}" target="_blank" class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                Im CRM oeffnen
            </a>
            {% endif %}
            {% if candidate.cv_url %}
            <a href="{{ candidate.cv_url }}" target="_blank" class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                CV herunterladen
            </a>
            {% endif %}
            <div class="flex-1"></div>
            {% if not candidate.hidden %}
            <button type="button" hx-put="/api/candidates/{{ candidate.id }}/hide" hx-swap="none" hx-on::after-request="showToast('Kandidat ausgeblendet', 'success')" class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-200">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                Ausblenden
            </button>
            {% else %}
            <button type="button" hx-put="/api/candidates/{{ candidate.id }}/unhide" hx-swap="none" hx-on::after-request="showToast('Kandidat wieder eingeblendet', 'success')" class="inline-flex items-center rounded-md bg-green-50 px-3 py-2 text-sm font-semibold text-green-700 hover:bg-green-100">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Wieder einblenden
            </button>
            {% endif %}
            <button type="button" onclick="deleteCandidate('{{ candidate.id }}', '{{ candidate.first_name }} {{ candidate.last_name }}')" class="inline-flex items-center rounded-md bg-red-50 px-3 py-2 text-sm font-semibold text-red-700 hover:bg-red-100 ring-1 ring-inset ring-red-200">
                <svg class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                Loeschen
            </button>
        </div>
    </div>
    <div class="lg:grid lg:grid-cols-3 lg:gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">Kontaktdaten</h3></div><div class="border-t border-gray-200 px-4 py-5 sm:px-6"><dl class="grid grid-cols-1 gap-4 sm:grid-cols-2"><div><dt class="text-sm font-medium text-gray-500">E-Mail</dt><dd class="mt-1 text-sm text-gray-900">{% if candidate.email %}<a href="mailto:{{ candidate.email }}" class="text-primary-600 hover:text-primary-500">{{ candidate.email }}</a>{% else %}<span class="text-gray-400">Keine Angabe</span>{% endif %}</dd></div><div><dt class="text-sm font-medium text-gray-500">Telefon</dt><dd class="mt-1 text-sm text-gray-900">{% if candidate.phone %}<a href="tel:{{ candidate.phone }}" class="text-primary-600 hover:text-primary-500">{{ candidate.phone }}</a>{% else %}<span class="text-gray-400">Keine Angabe</span>{% endif %}</dd></div><div class="sm:col-span-2"><dt class="text-sm font-medium text-gray-500">Adresse</dt><dd class="mt-1 text-sm text-gray-900">{% if candidate.street_address or candidate.postal_code or candidate.city %}{% if candidate.street_address %}{{ candidate.street_address }}{% endif %}{% if candidate.postal_code or candidate.city %}{% if candidate.street_address %}, {% endif %}{{ candidate.postal_code }} {{ candidate.city }}{% endif %}{% else %}<span class="text-gray-400">Keine Angabe</span>{% endif %}</dd></div></dl></div></div>
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">Berufserfahrung</h3></div><div class="border-t border-gray-200">{% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}<ul class="divide-y divide-gray-200">{% for job in candidate.work_history %}{% if job is mapping %}<li class="px-4 py-4 sm:px-6"><div class="flex items-start justify-between"><div><p class="text-sm font-medium text-gray-900">{{ job.position | default(job.title | default('Unbekannte Position')) }}</p><p class="text-sm text-gray-500">{{ job.company | default('Unbekanntes Unternehmen') }}</p></div><div class="text-sm text-gray-400 text-right">{% if job.start_date %}{{ job.start_date }}{% endif %}{% if job.end_date %} - {{ job.end_date }}{% elif job.start_date %} - heute{% endif %}</div></div>{% if job.description and job.description != 'null' %}<ul class="mt-2 text-sm text-gray-600 list-none space-y-1">{% for line in job.description.split('\n') %}{% if line.strip() %}<li class="flex"><span class="flex-shrink-0 mr-2">•</span><span>{{ line.strip().lstrip('•').strip() }}</span></li>{% endif %}{% endfor %}</ul>{% endif %}</li>{% endif %}{% endfor %}</ul>{% else %}<div class="px-4 py-5 sm:px-6"><p class="text-sm text-gray-400">Keine Angaben</p></div>{% endif %}</div></div>
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">IT-Kenntnisse</h3></div><div class="border-t border-gray-200 px-4 py-5 sm:px-6">{% if candidate.it_skills and candidate.it_skills | length > 0 %}<div class="flex flex-wrap gap-2">{% for skill in candidate.it_skills %}<span class="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-sm font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">{{ skill }}</span>{% endfor %}</div>{% else %}<p class="text-sm text-gray-400">Keine Angaben</p>{% endif %}</div></div>
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">Sprachen</h3></div><div class="border-t border-gray-200 px-4 py-5 sm:px-6">{% if candidate.languages and candidate.languages is iterable and candidate.languages is not string and candidate.languages | length > 0 %}<div class="space-y-2">{% for lang in candidate.languages %}{% if lang is mapping %}<div class="flex items-center justify-between text-sm"><span class="font-medium text-gray-900">{{ lang.language | default('Unbekannt') }}</span>{% if lang.level %}<span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-0.5 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-700/10">{{ lang.level }}</span>{% endif %}</div>{% endif %}{% endfor %}</div>{% else %}<p class="text-sm text-gray-400">Keine Angaben</p>{% endif %}</div></div>
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">Skills & Kenntnisse</h3></div><div class="border-t border-gray-200 px-4 py-5 sm:px-6">{% if candidate.skills and candidate.skills | length > 0 %}<div class="flex flex-wrap gap-2">{% for skill in candidate.skills %}<span class="inline-flex items-center rounded-full bg-primary-50 px-3 py-1 text-sm font-medium text-primary-700 ring-1 ring-inset ring-primary-700/10">{{ skill }}</span>{% endfor %}</div>{% else %}<p class="text-sm text-gray-400">Keine Angaben</p>{% endif %}</div></div>
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">Zertifikate & Weiterbildungen</h3></div><div class="border-t border-gray-200">{% if candidate.further_education and candidate.further_education is iterable and candidate.further_education is not string and candidate.further_education | length > 0 %}<ul class="divide-y divide-gray-200">{% for wb in candidate.further_education %}{% if wb is mapping %}<li class="px-4 py-4 sm:px-6"><div class="flex items-start justify-between"><div><p class="text-sm font-medium text-gray-900">{% if wb.degree and wb.degree != 'None' and wb.degree != 'null' %}{{ wb.degree }}{% elif wb.qualification and wb.qualification != 'None' and wb.qualification != 'null' %}{{ wb.qualification }}{% else %}Weiterbildung{% endif %}</p><p class="text-sm text-gray-500">{{ wb.institution | default('Unbekannter Anbieter') }}</p></div><div class="text-sm text-gray-400 text-right">{% if wb.year %}{{ wb.year }}{% elif wb.end_date %}{{ wb.end_date }}{% endif %}</div></div></li>{% endif %}{% endfor %}</ul>{% else %}<div class="px-4 py-5 sm:px-6"><p class="text-sm text-gray-400">Keine Angaben</p></div>{% endif %}</div></div>
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">Ausbildung</h3></div><div class="border-t border-gray-200">{% if candidate.education and candidate.education is iterable and candidate.education is not string and candidate.education | length > 0 %}<ul class="divide-y divide-gray-200">{% for edu in candidate.education %}{% if edu is mapping %}<li class="px-4 py-4 sm:px-6"><div class="flex items-start justify-between"><div><p class="text-sm font-medium text-gray-900">{% if edu.degree and edu.degree != 'None' and edu.degree != 'null' %}{{ edu.degree }}{% elif edu.qualification and edu.qualification != 'None' and edu.qualification != 'null' %}{{ edu.qualification }}{% else %}Ausbildung{% endif %}</p><p class="text-sm text-gray-500">{{ edu.institution | default(edu.school | default('Unbekannte Institution')) }}</p></div><div class="text-sm text-gray-400 text-right">{% if edu.year %}{{ edu.year }}{% elif edu.end_date %}{{ edu.end_date }}{% endif %}</div></div></li>{% endif %}{% endfor %}</ul>{% else %}<div class="px-4 py-5 sm:px-6"><p class="text-sm text-gray-400">Keine Angaben</p></div>{% endif %}</div></div>
        </div>
        <div class="mt-6 lg:mt-0 space-y-6">
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">Passende Jobs</h3></div><div id="matching-jobs" hx-get="/partials/candidate-jobs/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="border-t border-gray-200"><div class="p-4">{% include 'components/loading_spinner.html' %}</div></div></div>
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg"><div class="px-4 py-5 sm:px-6"><h3 class="text-base font-semibold leading-6 text-gray-900">CV-Status</h3></div><div class="border-t border-gray-200 px-4 py-5 sm:px-6"><dl class="space-y-3"><div class="flex justify-between text-sm"><dt class="text-gray-500">CV vorhanden:</dt><dd class="font-medium {% if candidate.cv_url %}text-green-600{% else %}text-gray-400{% endif %}">{% if candidate.cv_url %}Ja{% else %}Nein{% endif %}</dd></div>{% if candidate.cv_parsed_at %}<div class="flex justify-between text-sm"><dt class="text-gray-500">Zuletzt geparst:</dt><dd class="font-medium text-gray-900">{{ candidate.cv_parsed_at.strftime('%d.%m.%Y %H:%M') }}</dd></div>{% endif %}{% if candidate.crm_synced_at %}<div class="flex justify-between text-sm"><dt class="text-gray-500">Letzter CRM-Sync:</dt><dd class="font-medium text-gray-900">{{ candidate.crm_synced_at.strftime('%d.%m.%Y %H:%M') }}</dd></div>{% endif %}</dl>{% if candidate.cv_url %}<div class="mt-4"><button type="button" hx-post="/api/candidates/{{ candidate.id }}/parse-cv" hx-swap="none" hx-on::after-request="showToast('CV wird neu geparst...', 'info'); setTimeout(() => location.reload(), 3000)" class="w-full inline-flex justify-center items-center rounded-md bg-gray-50 px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100"><svg class="h-4 w-4 mr-1.5 htmx-indicator animate-spin" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>CV neu parsen</button></div>{% endif %}</div></div>
        </div>
    </div>
</div>

<script>
function deleteCandidate(candidateId, candidateName) {
    if (!confirm('Kandidat ' + candidateName + ' wirklich loeschen? Der Kandidat wird beim naechsten CRM-Sync ignoriert.')) {
        return;
    }
    fetch('/api/candidates/' + candidateId, {
        method: 'DELETE'
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            window.location.href = '/kandidaten';
        }
    });
}

// ==================== Inline Edit (Detailseite) ====================

function startDetailEdit(displayEl) {
    var wrapper = displayEl.closest('.detail-edit-wrapper');
    var input = wrapper.querySelector('.detail-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus();
    input.select();
}

function handleDetailEditKey(event, input) {
    if (event.key === 'Enter') {
        input.blur();
    } else if (event.key === 'Escape') {
        var wrapper = input.closest('.detail-edit-wrapper');
        var display = wrapper.querySelector('.detail-edit-display');
        input.classList.add('hidden');
        display.classList.remove('hidden');
    }
}

function saveDetailEdit(input) {
    var wrapper = input.closest('.detail-edit-wrapper');
    var display = wrapper.querySelector('.detail-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldText = display.textContent.trim();

    if (oldText === 'Keine Position angegeben' || oldText === 'Kein Unternehmen') {
        oldText = '';
    }

    if (newValue === oldText) {
        input.classList.add('hidden');
        display.classList.remove('hidden');
        return;
    }

    var body = {};
    body[field] = newValue || null;

    fetch('/api/candidates/' + candidateId, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.id) {
            display.textContent = newValue || (field === 'current_position' ? 'Keine Position angegeben' : 'Kein Unternehmen');
            if (typeof showToast === 'function') {
                showToast('Gespeichert', 'success');
            }
        }
    })
    .catch(function() {
        input.value = oldText;
    })
    .finally(function() {
        input.classList.add('hidden');
        display.classList.remove('hidden');
    });
}
</script>
{% endblock %}