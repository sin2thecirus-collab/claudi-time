{%- extends "base.html" -%}
{%- block title -%}
{% set _t_first = candidate.first_name or '' %}{% set _t_last = candidate.last_name or '' %}{% set _t_inv = ['not available','n/a','na','none','null','-','\u2014',''] %}{% set _t_f = _t_first if _t_first|lower|trim not in _t_inv else '' %}{% set _t_l = _t_last if _t_last|lower|trim not in _t_inv else '' %}{% set _t_name = ((_t_f ~ ' ' ~ _t_l)|trim) if (_t_f or _t_l) else 'Unbekannt' %}{{ _t_name }} - Pulspoint
{%- endblock -%}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    .kd-wrap, .kd-wrap * { font-family: 'DM Sans', -apple-system, sans-serif; }
    .kd-wrap { background: #0c1021; color: #e8ecf4; font-size: 15px; }
    .kd-wrap ::-webkit-scrollbar { width: 5px; }
    .kd-wrap ::-webkit-scrollbar-track { background: transparent; }
    .kd-wrap ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

    @keyframes kdFadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    @keyframes kdSlideIn { from { opacity:0; transform:translateX(12px); } to { opacity:1; transform:translateX(0); } }
    .kd-anim { opacity:0; animation: kdFadeUp 0.5s cubic-bezier(0.16,1,0.3,1) forwards; }
    .kd-anim-side { opacity:0; animation: kdSlideIn 0.5s cubic-bezier(0.16,1,0.3,1) forwards; }

    .kd-section {
        background: rgba(22,28,45,0.85); border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.06); overflow: hidden;
        backdrop-filter: blur(12px); transition: border-color 0.3s, box-shadow 0.3s;
    }
    .kd-section:hover { border-color: rgba(54,154,255,0.15); box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .kd-section-header {
        display:flex; align-items:center; justify-content:space-between;
        padding: 16px 24px 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .kd-section-title { display:flex; align-items:center; gap:10px; font-size:15px; font-weight:700; color:#e8ecf4; }
    .kd-section-title span { font-size:17px; }
    .kd-section-body { padding: 16px 24px; }

    .kd-sidebar-card {
        background: rgba(22,28,45,0.85); border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.06); overflow: hidden;
        transition: border-color 0.3s;
    }
    .kd-sidebar-card:hover { border-color: rgba(54,154,255,0.12); }
    .kd-sidebar-header {
        padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
        display:flex; align-items:center; justify-content:space-between;
        font-size:14px; font-weight:700; color:#e8ecf4;
    }
    .kd-sidebar-body { padding: 14px 16px; }

    .kd-sticky-header {
        background: linear-gradient(135deg, #0f1628, #141e36 50%, #1a1640);
        border-bottom: 1px solid rgba(255,255,255,0.06);
        padding: 0 32px; position: sticky; top: 0; z-index: 100;
    }

    .kd-tab-btn {
        padding: 14px 24px; background:none; border:none;
        font-size:14px; font-weight:500; cursor:pointer;
        display:flex; align-items:center; gap:8px;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease; color: #5a6a8a; font-family:inherit;
    }
    .kd-tab-btn:hover { color: #7c8db5; }
    .kd-tab-btn.active { color: #369aff; font-weight:700; border-bottom-color: #369aff; }

    .kd-quickbtn {
        display:inline-flex; align-items:center; gap:5px;
        padding: 7px 16px; border-radius:10px; font-size:12.5px; font-weight:600;
        cursor:pointer; font-family:inherit; transition: all 0.2s ease;
        border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); color:#c5cee0;
    }
    .kd-quickbtn:hover { background:rgba(255,255,255,0.1); transform:translateY(-1px); }
    .kd-quickbtn-primary { background:linear-gradient(135deg,#2ed573,#1fb85b); color:#fff; border:none; box-shadow:0 2px 12px rgba(46,213,115,0.25); font-weight:700; }
    .kd-quickbtn-primary:hover { box-shadow:0 4px 20px rgba(46,213,115,0.35); }
    .kd-quickbtn-accent { background:rgba(54,154,255,0.08); color:#369aff; border:1px solid rgba(54,154,255,0.2); }
    .kd-quickbtn-accent:hover { background:rgba(54,154,255,0.15); }
    .kd-quickbtn-danger { background:rgba(255,71,87,0.08); color:#ff4757; border:1px solid rgba(255,71,87,0.2); }
    .kd-quickbtn-danger:hover { background:rgba(255,71,87,0.12); }

    .kd-quickglance {
        background: linear-gradient(135deg, rgba(54,154,255,0.08), rgba(165,94,234,0.06));
        border-radius:18px; padding:6px; border:1px solid rgba(54,154,255,0.12);
        display:grid; grid-template-columns:1fr 1fr; gap:6px;
    }
    .kd-quickglance-item { display:flex; align-items:center; gap:14px; padding:16px 20px; border-radius:14px; background:rgba(15,20,35,0.5); }
    .kd-quickglance-icon { font-size:26px; flex-shrink:0; }
    .kd-quickglance-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:#7c8db5; margin-bottom:3px; }
    .kd-quickglance-value { font-size:16px; font-weight:700; white-space:nowrap; }

    .kd-exp-dot-current { width:12px; height:12px; border-radius:50%; flex-shrink:0; background:#369aff; border:2px solid rgba(54,154,255,0.4); }
    .kd-exp-dot-past { width:12px; height:12px; border-radius:50%; flex-shrink:0; background:#2d3654; border:2px solid #3d4a6e; }
    .kd-exp-line { width:2px; flex:1; margin-top:6px; background:linear-gradient(to bottom, rgba(54,154,255,0.3), #2d3654, transparent); }
    .kd-lang-bar { height:8px; border-radius:4px; overflow:hidden; background:rgba(255,255,255,0.06); }
    .kd-lang-fill { height:100%; border-radius:4px; transition: width 0.6s ease; }

    .skill-fach { background:rgba(165,94,234,0.12); color:#a55eea; border:1px solid rgba(165,94,234,0.3); }
    .skill-tech { background:rgba(46,213,115,0.12); color:#2ed573; border:1px solid rgba(46,213,115,0.3); }
    .skill-soft { background:rgba(255,165,2,0.12); color:#ffa502; border:1px solid rgba(255,165,2,0.3); }

    .kd-meta-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 8px; border-radius:6px; font-size:13px; font-weight:500; color:#7c8db5; }
    .kd-field-label { font-size:11px !important; font-weight:700 !important; text-transform:uppercase; letter-spacing:1.2px; color:#7c8db5 !important; margin-bottom:8px; display:flex; align-items:center; gap:6px; }

    .kd-badge { display:inline-flex; align-items:center; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:600; letter-spacing:0.2px; white-space:nowrap; }
    .kd-badge-green { background:rgba(46,213,115,0.12); border:1px solid rgba(46,213,115,0.3); color:#2ed573; }
    .kd-badge-cyan { background:rgba(0,210,211,0.12); border:1px solid rgba(0,210,211,0.3); color:#00d2d3; }
    .kd-badge-orange { background:rgba(255,165,2,0.12); border:1px solid rgba(255,165,2,0.3); color:#ffa502; }
    .kd-badge-purple { background:rgba(165,94,234,0.12); border:1px solid rgba(165,94,234,0.3); color:#a55eea; }
    .kd-badge-blue { background:rgba(54,154,255,0.12); border:1px solid rgba(54,154,255,0.3); color:#369aff; }
    .kd-badge-gray { background:rgba(160,174,192,0.10); border:1px solid rgba(160,174,192,0.25); color:#a0aec0; }

    .kd-wrap .detail-edit-display { cursor:pointer; border-radius:6px; padding:2px 6px; transition:all 0.2s; }
    .kd-wrap .detail-edit-display:hover { background:rgba(54,154,255,0.08); }
    .kd-wrap .detail-edit-input { font-family:inherit; border-radius:10px; }
    .kd-wrap input:focus, .kd-wrap textarea:focus, .kd-wrap select:focus {
        border-color:rgba(54,154,255,0.5) !important; box-shadow:0 0 0 3px rgba(54,154,255,0.08) !important; outline:none !important;
    }
    .kd-wrap { animation: kdFadeUp 0.4s cubic-bezier(0.16,1,0.3,1) forwards; }
</style>
{% endblock %}

{% block content %}
{# ── Data Quality: Invalid-Name-Filterung + Normalisierung ── #}
{% set invalid_names = ['not available', 'n/a', 'na', 'none', 'null', '-', '—', ''] %}
{% set raw_first = candidate.first_name or '' %}
{% set raw_last = candidate.last_name or '' %}
{% set first_valid = raw_first if raw_first | lower | trim not in invalid_names else '' %}
{% set last_valid = raw_last if raw_last | lower | trim not in invalid_names else '' %}
{# ALL CAPS → Title Case (ohne if/else wg. Jinja2 Scoping) #}
{% set first_display = (first_valid | title) if (first_valid == first_valid | upper and first_valid | length > 1) else first_valid %}
{% set last_display = (last_valid | title) if (last_valid == last_valid | upper and last_valid | length > 1) else last_valid %}
{% set has_valid_name = first_display or last_display %}
{% set display_name = ((first_display ~ ' ' ~ last_display) | trim) if has_valid_name else 'Unbekannt' %}
{% set raw_position = candidate.current_position or '' %}
{% set position_invalid = raw_position | lower | trim in (invalid_names + ['keine position angegeben']) %}
{% set position_display = '' if position_invalid else raw_position %}
{% set raw_company = candidate.current_company or '' %}
{% set company_invalid = raw_company | lower | trim in (invalid_names + ['kein unternehmen']) %}
{% set company_display = '' if company_invalid else raw_company %}
{% set raw_city = candidate.city or '' %}
{% set city_invalid = raw_city | lower | trim in (invalid_names + ['keine adresse']) %}
{% set city_display = '' if city_invalid else raw_city %}
{# ── End Data Quality ── #}

<div class="kd-wrap min-h-screen" x-data="{ activeTab: 'uebersicht', showPipelineModal: false, pipelineStatus: '{{ candidate.pipeline_status or 'new' }}' }">

    {# ── Sticky Header ── #}
    <div class="kd-sticky-header">
        {# Row 1: Action buttons #}
        <div style="display:flex; align-items:center; justify-content:space-between; padding:16px 0 8px;">
            <a href="/kandidaten" class="kd-quickbtn" style="text-decoration:none;">&#x2190; Zur&uuml;ck</a>
            <div style="display:flex; gap:8px;">
                {% if candidate.cv_url or candidate.cv_stored_path %}
                <button type="button" onclick="openCvPreview()" class="kd-quickbtn kd-quickbtn-accent">&#x1F4C4; CV ansehen</button>
                {% endif %}
                <button type="button" @click="showPipelineModal = true" class="kd-quickbtn kd-quickbtn-primary">&#x1F680; Pipeline</button>
                <button type="button" onclick="deleteCandidate('{{ candidate.id }}', '{{ display_name }}')" class="kd-quickbtn kd-quickbtn-danger">&#x1F5D1;</button>
            </div>
        </div>

        {# Row 2: Name + Badges #}
        <div style="display:flex; align-items:center; gap:16px; padding-bottom:8px;">
            {# Avatar #}
            <div style="width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg, #369aff, #a55eea); display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; color:#fff; flex-shrink:0;">
                {{ display_name[0]|upper if display_name else '?' }}
            </div>
            <div style="flex:1; min-width:0;">
                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <h1 style="font-size:24px; font-weight:800; color:#e8ecf4; margin:0; letter-spacing:-0.02em;">{{ display_name }}</h1>
                    {% if candidate.willingness_to_change == 'ja' %}
                    <span class="kd-badge kd-badge-green">&#x2705; Wechselbereit</span>
                    {% elif candidate.willingness_to_change == 'nein' %}
                    <span class="kd-badge kd-badge-gray">Nicht wechselbereit</span>
                    {% endif %}
                    {% if candidate.employment_type %}
                    <span class="kd-badge kd-badge-cyan">{{ candidate.employment_type }}</span>
                    {% endif %}
                    {% if candidate.rating %}
                    <span class="kd-badge kd-badge-orange">&#x2B50; {{ candidate.rating }}/5</span>
                    {% endif %}
                </div>
                <div style="display:flex; align-items:center; gap:12px; margin-top:4px; flex-wrap:wrap;">
                    {% if candidate.current_position and candidate.current_position not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}
                    <span class="kd-meta-badge">&#x1F4BC; {{ candidate.current_position }}</span>
                    {% endif %}
                    {% if candidate.current_company and candidate.current_company not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}
                    <span class="kd-meta-badge">&#x1F3E2; {{ candidate.current_company }}</span>
                    {% endif %}
                    {% if candidate.location and candidate.location not in ['Not Available', 'N/A', 'n/a', 'None', 'null', '', '-'] %}
                    <span class="kd-meta-badge">&#x1F4CD; {{ candidate.location }}</span>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Row 3: Tabs #}
        
    {# ── Tab Navigation ── #}
    <div style="display:flex; gap:0; border-top:1px solid rgba(255,255,255,0.04); margin-top:4px;">
        <button type="button" @click="activeTab = 'uebersicht'" class="kd-tab-btn" :class="activeTab === 'uebersicht' ? 'active' : ''">
            <span>&#x1F4CB;</span> &Uuml;bersicht
        </button>
        <button type="button" @click="activeTab = 'qualifizierung'" class="kd-tab-btn" :class="activeTab === 'qualifizierung' ? 'active' : ''">
            <span>&#x1F4DE;</span> Qualifizierung
        </button>
        <button type="button" @click="activeTab = 'profil'" class="kd-tab-btn" :class="activeTab === 'profil' ? 'active' : ''">
            <span>&#x1F4BC;</span> Profil &amp; CV
        </button>
        <button type="button" @click="activeTab = 'gespraeche'" class="kd-tab-btn" :class="activeTab === 'gespraeche' ? 'active' : ''">
            <span>&#x1F3A4;</span> Gespr&auml;che
        </button>
    </div>
    </div>

    {# ── Pipeline Modal ── #}
    <template x-if="showPipelineModal">
        <div style="position:fixed; inset:0; z-index:200; display:flex; align-items:center; justify-content:center;" @click.self="showPipelineModal = false">
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);"></div>
            <div style="position:relative; z-index:10; background:var(--pp-surface); border-radius:16px; border:1px solid var(--pp-border); padding:28px; width:420px; max-width:90vw; box-shadow:0 24px 48px rgba(0,0,0,0.4);">
                <h3 style="font-size:17px; font-weight:700; color:var(--pp-text); margin:0 0 20px;">Pipeline-Status &auml;ndern</h3>
                {% set pipeline_options = [
                    {"value": "new", "label": "Neu", "color": "#6366f1"},
                    {"value": "contacted", "label": "Kontaktiert", "color": "#3b82f6"},
                    {"value": "qualified", "label": "Qualifiziert", "color": "#10b981"},
                    {"value": "presented", "label": "Vorgestellt", "color": "#f59e0b"},
                    {"value": "interview", "label": "Interview", "color": "#8b5cf6"},
                    {"value": "offer", "label": "Angebot", "color": "#ef4444"},
                    {"value": "placed", "label": "Platziert", "color": "#22c55e"},
                    {"value": "rejected", "label": "Abgelehnt", "color": "#64748b"}
                ] %}
                <div style="display:flex; flex-direction:column; gap:6px;">
                    {% for opt in pipeline_options %}
                    <button type="button"
                        @click="pipelineStatus = '{{ opt.value }}'; fetch('/api/candidates/{{ candidate.id }}', {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({pipeline_status:'{{ opt.value }}'}) }).then(r => { if(r.ok) { showToast('Pipeline-Status aktualisiert','success'); showPipelineModal=false; } })"
                        class="w-full text-left py-3 px-4 rounded-xl text-sm font-semibold cursor-pointer transition-all duration-150"
                        :style="pipelineStatus === '{{ opt.value }}' ? 'background: {{ opt.color }}22; border: 2px solid {{ opt.color }}; color: {{ opt.color }};' : 'background: var(--pp-surfaceHover); border: 2px solid transparent; color: var(--pp-text);'"
                        style="font-family:inherit;"
                        onmouseenter="if(!this.style.borderColor || this.style.borderColor==='transparent') this.style.background='var(--pp-surfaceHover)'"
                        onmouseleave="if(!this.style.borderColor || this.style.borderColor==='transparent') this.style.background='var(--pp-surfaceHover)'">
                        <span style="display:inline-block; width:10px; height:10px; border-radius:50%; background:{{ opt.color }}; margin-right:10px;"></span>
                        {{ opt.label }}
                    </button>
                    {% endfor %}
                </div>
                <button type="button" @click="showPipelineModal = false" class="w-full mt-4 py-2.5 rounded-xl text-sm font-bold cursor-pointer" style="background:var(--pp-surfaceHover); border:1px solid var(--pp-border); color:var(--pp-textMuted); font-family:inherit;">Abbrechen</button>
            </div>
        </div>
    </template>

    {# ══════════════ CONTENT + SIDEBAR ══════════════ #}
    <div style="display:flex; gap:24px; padding:24px 32px 32px; max-width:1600px; margin:0 auto;">

        {# ── LEFT: Tab Content ── #}
        <div style="flex:1; min-width:0;">

            {# ═══ TAB: Übersicht ═══ #}
            <div x-show="activeTab === 'uebersicht'" x-cloak style="display:flex; flex-direction:column; gap:20px;">
                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 100ms;" id="contact">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4C7;</span> Kontaktdaten</div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        {# Email #}
                        <div>
                            <div class="kd-field-label">E-Mail</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                {% if candidate.email %}
                                <span style="font-size: 13px; font-weight: 600; color: var(--pp-accent); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ candidate.email }}</span>
                                <button type="button" onclick="copyToClipboard('{{ candidate.email }}', 'E-Mail')" class="kd-copy-btn" title="E-Mail kopieren"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
                                {% else %}
                                <span style="font-size: 13px; font-weight: 600; color: var(--pp-textDim); font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                        {# Phone #}
                        <div>
                            <div class="kd-field-label">Telefon</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                {% if candidate.phone %}
                                <span style="font-size: 13px; font-weight: 600; color: var(--pp-accent);">{{ candidate.phone }}</span>
                                <button type="button" onclick="copyToClipboard('{{ candidate.phone }}', 'Telefonnummer')" class="kd-copy-btn" title="Telefonnummer kopieren"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
                                {% else %}
                                <span style="font-size: 13px; font-weight: 600; color: var(--pp-textDim); font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                        {# Address #}
                        <div>
                            <div class="kd-field-label">Adresse</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                {% if candidate.street_address or candidate.postal_code or city_display %}
                                <span style="font-size: 13px; font-weight: 600; color: var(--pp-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="address-text">{% if candidate.street_address %}{{ candidate.street_address }}{% endif %}{% if candidate.postal_code or city_display %}{% if candidate.street_address %}, {% endif %}{{ candidate.postal_code }} {{ city_display }}{% endif %}</span>
                                <button type="button" onclick="copyToClipboard(document.getElementById('address-text').textContent.trim(), 'Adresse')" class="kd-copy-btn" title="Adresse kopieren"><svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
                                {% else %}
                                <span style="font-size: 13px; font-weight: 600; color: var(--pp-textDim); font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 150ms; overflow: visible;" id="recruiting-data"
                 x-data="recruitingFields()">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F50D;</span> Recruiting-Daten</div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        {# Quelle #}
                        <div>
                            <div class="kd-field-label">Quelle</div>
                            <div class="relative" @click.away="showSourceDropdown = false">
                                <button type="button" @click="showSourceDropdown = !showSourceDropdown"
                                    class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                    style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: {% if candidate.source %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.source %}font-style: italic;{% endif %}">
                                    <span class="block truncate" x-text="currentSource || 'Nicht angegeben'"></span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                        <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                    </span>
                                </button>
                                <div x-show="showSourceDropdown" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 220px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="src in sourceOptions" :key="src">
                                        <button type="button" @click="setSource(src)"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; border: none;"
                                            :style="currentSource === src ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                            @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                            @mouseleave="if (currentSource !== src) $el.style.background = 'none'"
                                            x-text="src"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        {# Wechselbereitschaft #}
                        <div>
                            <div class="kd-field-label">Wechselbereitschaft</div>
                            <div class="flex gap-2">
                                <button type="button" @click="setWillingness('ja')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="currentWillingness === 'ja' ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="currentWillingness !== 'ja' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="setWillingness('nein')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="currentWillingness === 'nein' ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="currentWillingness !== 'nein' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                                <button type="button" @click="setWillingness('unbekannt')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="currentWillingness === 'unbekannt' ? 'border-2 ring-1 ring-gray-400/30' : 'border-2 hover:border-gray-400/40 hover:text-gray-300'"
                                    :style="currentWillingness === 'unbekannt' ? 'background: var(--pp-surfaceHover); color: var(--pp-textMuted); border-color: var(--pp-textMuted);' : 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);'"
                                    style="font-family: inherit;">?</button>
                            </div>
                        </div>
                        {# Letzter Kontakt #}
                        <div>
                            <div class="kd-field-label">Letzter Kontakt</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <input type="date" x-model="lastContactDate" @change="setLastContact()"
                                    style="padding: 5px 8px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 12.5px; font-weight: 600; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; cursor: pointer; outline: none; color-scheme: dark;">
                                <button type="button" @click="setLastContactNow()" title="Auf heute setzen"
                                    style="padding: 5px 8px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 11px; font-weight: 650; cursor: pointer; font-family: inherit; white-space: nowrap;">Heute</button>
                            </div>
                        </div>
                    </div>
                    {# Notizen (Freitext) #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(99,102,241,0.08);">
                        <div style="font-size: 10px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.06em;">Notizen</div>
                        <textarea x-model="notesText" @blur="saveNotes()" placeholder="Gespr&auml;chsnotizen, Wechselmotivation, Gehaltsvorstellung, K&uuml;ndigungsfrist..."
                            style="width: 100%; min-height: 56px; padding: 8px 10px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 12.5px; font-weight: 500; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; resize: vertical; outline: none; line-height: 1.5;"
                            @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 10.5px; color: var(--pp-textDim); font-weight: 500;" x-text="notesSaved ? 'Gespeichert' : 'Wird beim Verlassen gespeichert'"></span>
                            <button type="button" @click="saveNotes()" style="padding: 5px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 11px; font-weight: 650; cursor: pointer; font-family: inherit;">Speichern</button>
                        </div>
                    </div>
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 250ms;" id="pipeline-data"
                 x-data="pipelineFields()">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F3AF;</span> Pipeline-Daten</div>
                    <span style="font-size: 10.5px; font-weight: 650; padding: 4px 10px; border-radius: 6px; background: var(--pp-surfaceHover); color: var(--pp-accent); border: 1px solid var(--pp-border);">F&uuml;r Pipeline</span>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        {# Gehalt #}
                        <div>
                            <div class="kd-field-label">Gehaltswunsch</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="salary">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Gehalt bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.salary %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.salary %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.salary or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.salary or '' }}" placeholder="z.B. 55.000 &euro;" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Kuendigungsfrist #}
                        <div>
                            <div class="kd-field-label">K&uuml;ndigungsfrist</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="notice_period">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="K&uuml;ndigungsfrist bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.notice_period %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.notice_period %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.notice_period or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.notice_period or '' }}" placeholder="z.B. 3 Monate" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Rating #}
                        <div>
                            <div class="kd-field-label">Bewertung</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="display: flex; gap: 3px;">
                                    {% for i in range(1, 6) %}
                                    <button type="button" @click="setRating({{ i }})" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; transition: transform 0.15s;" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'">
                                        <span id="star-{{ i }}" style="color: {% if candidate.rating and i <= candidate.rating %}#f59e0b{% else %}var(--pp-border){% endif %};">&#9733;</span>
                                    </button>
                                    {% endfor %}
                                </div>
                                <span style="font-size: 11.5px; color: var(--pp-textMuted); font-weight: 500;" x-text="currentRating ? currentRating + '/5' : 'Nicht bewertet'"></span>
                                <button type="button" x-show="currentRating > 0" @click="clearRating()" style="font-size: 11px; color: var(--pp-textDim); background: none; border: none; cursor: pointer; font-family: inherit; padding: 2px 6px; border-radius: 4px;">&#x2715;</button>
                            </div>
                        </div>
                    </div>
                    {# ERP #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(99,102,241,0.08);">
                        <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.06em;">ERP-Kenntnisse</div>
                        {% if candidate.erp and candidate.erp | length > 0 %}
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                            {% for erp_item in candidate.erp %}
                            <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px; background: var(--pp-surfaceHover); color: var(--pp-accent); border: 1px solid var(--pp-border);">
                                {{ erp_item }}
                                <button type="button" onclick="removeErp('{{ erp_item }}')" style="background: none; border: none; cursor: pointer; color: #a5b4fc; font-size: 14px; padding: 0; margin-left: 2px; line-height: 1;" onmouseenter="this.style.color='#ef4444'" onmouseleave="this.style.color='#a5b4fc'">&times;</button>
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="font-size: 12px; color: var(--pp-textDim); font-style: italic; margin-bottom: 10px;">Keine ERP-Kenntnisse angegeben</div>
                        {% endif %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" x-model="newErp" @keydown.enter.prevent="addErp()" placeholder="z.B. SAP, DATEV..." style="padding: 8px 12px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 12.5px; font-weight: 500; color: var(--pp-text); outline: none; width: 180px; font-family: inherit; background: var(--pp-surface);">
                            <button type="button" @click="addErp()" style="padding: 8px 14px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 12px; font-weight: 650; cursor: pointer; font-family: inherit;">+ Hinzuf&uuml;gen</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            {# ═══ TAB: Qualifizierung (shares qualificationFields scope with Gespräche) ═══ #}
            <div x-show="activeTab === 'qualifizierung' || activeTab === 'gespraeche'"
                 x-data="qualificationFields()" style="overflow:visible;">

                {# Qualifizierung content #}
                <div x-show="activeTab === 'qualifizierung'" style="display:flex; flex-direction:column; gap:20px;">
                    
            {# ── Quick-Glance Bar ── #}
            <div class="kd-quickglance kd-anim" style="animation-delay:50ms;">
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x1F4B0;</div>
                    <div>
                        <div class="kd-quickglance-label">Gehalt</div>
                        <div class="kd-quickglance-value" style="color:#10b981;">{{ candidate.salary or '–' }}</div>
                    </div>
                </div>
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x23F3;</div>
                    <div>
                        <div class="kd-quickglance-label">K&uuml;ndigungsfrist</div>
                        <div class="kd-quickglance-value" style="color:#f59e0b;">{{ candidate.notice_period or '–' }}</div>
                    </div>
                </div>
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x1F3E0;</div>
                    <div>
                        <div class="kd-quickglance-label">Home-Office</div>
                        <div class="kd-quickglance-value" style="color:#3b82f6;">{{ candidate.home_office_days or '–' }}</div>
                    </div>
                </div>
                <div class="kd-quickglance-item">
                    <div class="kd-quickglance-icon">&#x1F6E3;</div>
                    <div>
                        <div class="kd-quickglance-label">Pendelweg</div>
                        <div class="kd-quickglance-value" style="color:#8b5cf6;">{{ candidate.commute_max or '–' }}</div>
                    </div>
                </div>
            </div>

                    <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 260ms; overflow: visible;" id="qualification-call"
                 >
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4DE;</span> Qualifizierungsgespr&auml;ch</div>
                    <span x-show="qfSaving" x-cloak style="font-size: 11px; font-weight: 600; color: var(--pp-accent);">Speichert...</span>
                </div>
                <div class="kd-section-body" style="overflow: visible;">
                    {# Row 1: Gewünschte Positionen + Tätigkeiten #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div class="kd-field-label">Gew&uuml;nschte Positionen</div>
                            <textarea x-model="qf.desired_positions" @blur="saveQField('desired_positions')" placeholder="z.B. Bilanzbuchhalterin, Finanzbuchhalterin..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 60px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                        <div>
                            <div class="kd-field-label">T&auml;tigkeiten (Kernkompetenzen)</div>
                            <textarea x-model="qf.key_activities" @blur="saveQField('key_activities')" placeholder="T&auml;tigkeiten die voll umf&auml;nglich beherrscht werden..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 60px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                    </div>

                    {# Row 2: Home-Office + Pendel + Verkehrsmittel + ERP-Steckenpferd #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 8px;">
                        <div>
                            <div class="kd-field-label">Home-Office Tage</div>
                            <input type="text" x-model="qf.home_office_days" @blur="saveQField('home_office_days')" placeholder="z.B. 2 bis 3 Tage"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                        </div>
                        <div>
                            <div class="kd-field-label">Pendelbereitschaft</div>
                            <input type="text" x-model="qf.commute_max" @blur="saveQField('commute_max')" placeholder="z.B. 30 min"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                        </div>
                        <div>
                            <div class="kd-field-label">Verkehrsmittel</div>
                            <div class="relative" @click.away="showTransportDd = false">
                                <button type="button" @click="showTransportDd = !showTransportDd"
                                    class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                    style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: var(--pp-text);">
                                    <span class="block truncate" x-text="qf.commute_transport || 'Ausw&auml;hlen'"></span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                        <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                    </span>
                                </button>
                                <div x-show="showTransportDd" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 180px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="opt in ['Auto', '&Ouml;PNV', 'Beides']" :key="opt">
                                        <button type="button" @click="qf.commute_transport = opt; showTransportDd = false; saveQField('commute_transport')"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; border: none;"
                                            :style="qf.commute_transport === opt ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                            @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                            @mouseleave="if (qf.commute_transport !== opt) $el.style.background = 'none'"
                                            x-text="opt"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">ERP-Steckenpferd</div>
                            <input type="text" x-model="qf.erp_main" @blur="saveQField('erp_main')" placeholder="z.B. DATEV"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                        </div>
                    </div>

                    {# Row 3: Anstellung + Teilzeit-Stunden + Großraumbüro #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 6px;">
                        <div>
                            <div class="kd-field-label">Anstellungsart</div>
                            <div class="relative" @click.away="showEmpTypeDd = false">
                                <button type="button" @click="showEmpTypeDd = !showEmpTypeDd"
                                    class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                    style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: var(--pp-text);">
                                    <span class="block truncate" x-text="qf.employment_type || 'Ausw&auml;hlen'"></span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                        <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                    </span>
                                </button>
                                <div x-show="showEmpTypeDd" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 180px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="opt in ['Vollzeit', 'Teilzeit', 'Beides']" :key="opt">
                                        <button type="button" @click="qf.employment_type = opt; showEmpTypeDd = false; saveQField('employment_type')"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; border: none;"
                                            :style="qf.employment_type === opt ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                            @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                            @mouseleave="if (qf.employment_type !== opt) $el.style.background = 'none'"
                                            x-text="opt"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">Teilzeit-Stunden</div>
                            <input type="text" x-model="qf.part_time_hours" @blur="saveQField('part_time_hours')" placeholder="z.B. 30 Stunden"
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"
                                :style="!qf.employment_type || qf.employment_type === 'Vollzeit' ? 'opacity: 0.4;' : ''">
                        </div>
                        <div>
                            <div class="kd-field-label">Grossraumb&uuml;ro OK?</div>
                            <div class="flex gap-2">
                                <button type="button" @click="setQfChoice('open_office_ok', 'ja')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.open_office_ok === 'ja' ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="qf.open_office_ok !== 'ja' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="setQfChoice('open_office_ok', 'nein')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.open_office_ok === 'nein' ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="qf.open_office_ok !== 'nein' ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                                <button type="button" @click="setQfChoice('open_office_ok', 'egal')"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.open_office_ok === 'egal' ? 'border-2 ring-1 ring-gray-400/30' : 'border-2 hover:border-gray-400/40 hover:text-gray-300'"
                                    :style="qf.open_office_ok === 'egal' ? 'background: var(--pp-surfaceHover); color: var(--pp-textMuted); border-color: var(--pp-textMuted);' : 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);'"
                                    style="font-family: inherit;">Egal</button>
                            </div>
                        </div>
                    </div>

                    {# Row 4: Branchen #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(99,102,241,0.08);">
                        <div>
                            <div class="kd-field-label">Bevorzugte Branchen</div>
                            <textarea x-model="qf.preferred_industries" @blur="saveQField('preferred_industries')" placeholder="Freitext: Bevorzugte Branchen..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 38px; padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                        <div>
                            <div class="kd-field-label">Branchen vermeiden</div>
                            <textarea x-model="qf.avoided_industries" @blur="saveQField('avoided_industries')" placeholder="Freitext: Branchen die vermieden werden sollen..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 38px; padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                    </div>

                    {# Row 5: WhatsApp + Exklusivität + Andere Recruiter #}
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(99,102,241,0.08);">
                        <div>
                            <div class="kd-field-label">WhatsApp OK?</div>
                            <div class="flex gap-2">
                                <button type="button" @click="toggleQfBool('whatsapp_ok', true)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.whatsapp_ok === true ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="qf.whatsapp_ok !== true ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="toggleQfBool('whatsapp_ok', false)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.whatsapp_ok === false ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="qf.whatsapp_ok !== false ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">Exklusivit&auml;t vereinbart?</div>
                            <div class="flex gap-2">
                                <button type="button" @click="toggleQfBool('exclusivity_agreed', true)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.exclusivity_agreed === true ? 'bg-green-500/15 text-green-500 border-2 border-green-500 ring-1 ring-green-500/30' : 'border-2 hover:border-green-500/40 hover:text-green-400'"
                                    :style="qf.exclusivity_agreed !== true ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Ja</button>
                                <button type="button" @click="toggleQfBool('exclusivity_agreed', false)"
                                    class="px-3 py-1.5 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    :class="qf.exclusivity_agreed === false ? 'bg-red-500/15 text-red-500 border-2 border-red-500 ring-1 ring-red-500/30' : 'border-2 hover:border-red-500/40 hover:text-red-400'"
                                    :style="qf.exclusivity_agreed !== false ? 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);' : ''"
                                    style="font-family: inherit;">Nein</button>
                            </div>
                        </div>
                        <div>
                            <div class="kd-field-label">Andere Recruiter aktiv?</div>
                            <input type="text" x-model="qf.other_recruiters" @blur="saveQField('other_recruiters')" placeholder="Details..."
                                class="w-full rounded-lg text-sm font-semibold"
                                style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'">
                        </div>
                    </div>

                    {# Row 6: Bereits beworben bei (Freitext) #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(99,102,241,0.08);">
                        <div class="kd-field-label">Bereits beworben bei (aus Gespr&auml;ch)</div>
                        <textarea x-model="qf.applied_at_companies_text" @blur="saveQField('applied_at_companies_text')" placeholder="Freitext aus Transkription: Wo hat sich der Kandidat bereits beworben?"
                            class="w-full rounded-lg text-sm font-medium resize-vertical"
                            style="min-height: 38px; padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                            @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                    </div>

                    {# Row 7: Call-Daten #}
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(99,102,241,0.08);">
                        <div style="font-size: 12px; font-weight: 700; color: var(--pp-textMuted); margin-bottom: 8px;">Gespr&auml;chsdaten</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div class="kd-field-label">Gespr&auml;chsdatum</div>
                                <input type="date" x-model="qfCallDate" @change="saveCallDate()"
                                    class="rounded-lg text-sm font-semibold cursor-pointer"
                                    style="padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; color-scheme: dark;">
                            </div>
                            <div>
                                <div class="kd-field-label">Gespr&auml;chstyp</div>
                                <div class="relative" @click.away="showCallTypeDd = false">
                                    <button type="button" @click="showCallTypeDd = !showCallTypeDd"
                                        class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                        style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: var(--pp-text);">
                                        <span class="block truncate" x-text="callTypeLabels[qf.call_type] || 'Ausw&auml;hlen'"></span>
                                        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                            <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                        </span>
                                    </button>
                                    <div x-show="showCallTypeDd" x-cloak
                                         class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                         style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 220px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                        <template x-for="ct in callTypeOptions" :key="ct.value">
                                            <button type="button" @click="qf.call_type = ct.value; showCallTypeDd = false; saveQField('call_type')"
                                                class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                                style="font-family: inherit; white-space: nowrap; border: none;"
                                                :style="qf.call_type === ct.value ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                                @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                                @mouseleave="if (qf.call_type !== ct.value) $el.style.background = 'none'"
                                                x-text="ct.label"></button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {# KI-Zusammenfassung #}
                        <div style="margin-top: 8px;">
                            <div class="kd-field-label">KI-Zusammenfassung</div>
                            <textarea x-model="qf.call_summary" @blur="saveQField('call_summary')" placeholder="KI-generierte Zusammenfassung des Gespr&auml;chs..."
                                class="w-full rounded-lg text-sm font-medium resize-vertical"
                                style="min-height: 60px; padding: 8px 12px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.5;"
                                @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        </div>
                        {# Transkript (aufklappbar) #}
                        <div style="margin-top: 8px;" x-data="{ showTranscript: false }">
                            <button type="button" @click="showTranscript = !showTranscript"
                                class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                style="background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-textMuted); font-family: inherit;">
                                <svg :class="showTranscript ? 'rotate-90' : ''" class="w-3 h-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M9 5l7 7-7 7"/></svg>
                                <span x-text="showTranscript ? 'Transkript ausblenden' : 'Transkript anzeigen'"></span>
                                <span x-show="qf.call_transcript" x-cloak style="font-size: 10px; color: var(--pp-accent); font-weight: 600;">(vorhanden)</span>
                            </button>
                            <div x-show="showTranscript" x-cloak style="margin-top: 8px;">
                                <textarea x-model="qf.call_transcript" @blur="saveQField('call_transcript')" placeholder="Volle Transkription des Gespr&auml;chs..."
                                    class="w-full rounded-lg text-sm font-medium resize-vertical"
                                    style="min-height: 200px; padding: 10px 14px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; line-height: 1.6; font-size: 12px;"
                                    @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                    <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 275ms; overflow: visible; position: relative; z-index: 10;" id="presented-at"
                 x-data="{
                    entries: {{ (candidate.presented_at_companies or []) | tojson | safe }},
                    showAddForm: false,
                    newCompany: '',
                    newType: 'presented',
                    newDate: new Date().toISOString().split('T')[0],
                    filteredCompanies: [],
                    showCompanyDropdown: false,
                    _searchTimeout: null,
                    async loadCompanies() { /* no-op, search is now server-side */ },
                    filterCompanies() {
                        var self = this;
                        if (self._searchTimeout) clearTimeout(self._searchTimeout);
                        if (!self.newCompany || self.newCompany.length < 2) { self.filteredCompanies = []; self.showCompanyDropdown = false; return; }
                        self._searchTimeout = setTimeout(function() {
                            fetch('/api/companies?per_page=15&sort_by=name&search=' + encodeURIComponent(self.newCompany))
                                .then(function(r) { return r.json(); })
                                .then(function(data) {
                                    self.filteredCompanies = (data.items || []).map(function(c) { return c.name; });
                                    self.showCompanyDropdown = self.filteredCompanies.length > 0;
                                })
                                .catch(function(err) { console.error(err); });
                        }, 250);
                    },
                    selectCompany(name) {
                        this.newCompany = name;
                        this.filteredCompanies = [];
                        this.showCompanyDropdown = false;
                    },
                    async addEntry() {
                        if (!this.newCompany.trim()) return;
                        var entry = { company: this.newCompany.trim(), date: this.newDate, type: this.newType };
                        this.entries.push(entry);
                        var candidateId = '{{ candidate.id }}';
                        try {
                            await fetch('/api/candidates/' + candidateId, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ presented_at_companies: this.entries })
                            });
                            if (typeof showToast === 'function') showToast('Eintrag hinzugefuegt', 'success');
                        } catch (err) { console.error(err); }
                        this.newCompany = ''; this.showAddForm = false;
                    },
                    async removeEntry(idx) {
                        this.entries.splice(idx, 1);
                        var candidateId = '{{ candidate.id }}';
                        try {
                            await fetch('/api/candidates/' + candidateId, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ presented_at_companies: this.entries })
                            });
                            if (typeof showToast === 'function') showToast('Eintrag entfernt', 'success');
                        } catch (err) { console.error(err); }
                    }
                 }">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F3E2;</span> Vorgestellt / Beworben bei</div>
                    <button type="button" @click="showAddForm = !showAddForm; if(showAddForm) loadCompanies()" style="display: flex; align-items: center; gap: 6px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); border-radius: 8px; padding: 5px 12px; font-size: 11.5px; font-weight: 650; color: var(--pp-accent); cursor: pointer; font-family: inherit;">
                        <span x-text="showAddForm ? 'Abbrechen' : '+ Hinzuf&uuml;gen'"></span>
                    </button>
                </div>
                <div class="kd-section-body" style="overflow: visible;">
                    {# Add form #}
                    <div x-show="showAddForm" x-cloak class="mb-3.5" style="padding: 14px; border-radius: 10px; background: var(--pp-bg); border: 1px solid var(--pp-border); overflow: visible;">
                        <div class="flex flex-wrap items-end gap-2.5" style="overflow: visible;">
                            <div class="relative flex-[2] min-w-[220px]" x-ref="companyInputWrap" @click.away="showCompanyDropdown = false">
                                <div class="kd-field-label">Unternehmen</div>
                                <input type="text" x-model="newCompany" @input="filterCompanies()" @focus="filterCompanies()" @keydown.enter.prevent="showCompanyDropdown = false; addEntry()" placeholder="z.B. Allianz, Siemens..."
                                    class="w-full rounded-lg text-sm outline-none"
                                    x-ref="companyInput"
                                    style="padding: 7px 10px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit;">
                                <div x-show="showCompanyDropdown" x-cloak
                                     @click.away="showCompanyDropdown = false"
                                     class="absolute z-[9999] mt-1 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 300px; width: max-content; max-width: 500px; max-height: 320px; box-shadow: 0 12px 32px rgba(0,0,0,0.6);">
                                    <template x-for="name in filteredCompanies" :key="name">
                                        <button type="button" @click="selectCompany(name)"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; color: var(--pp-text); font-weight: 500; background: none; border: none;"
                                            @mouseenter="$el.style.background='var(--pp-surfaceHover)'"
                                            @mouseleave="$el.style.background='none'"
                                            x-text="name"></button>
                                    </template>
                                </div>
                            </div>
                            <div>
                                <div class="kd-field-label">Typ</div>
                                <select x-model="newType" style="padding: 7px 10px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 13px; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; cursor: pointer;">
                                    <option value="presented">Vorgestellt</option>
                                    <option value="applied">Beworben</option>
                                    <option value="pdl">PDL</option>
                                </select>
                            </div>
                            <div>
                                <div class="kd-field-label">Datum</div>
                                <input type="date" x-model="newDate" style="padding: 7px 10px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 13px; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; color-scheme: dark;">
                            </div>
                            <button type="button" @click="addEntry()" style="padding: 8px 16px; border-radius: 8px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; font-size: 13px; font-weight: 650; cursor: pointer; font-family: inherit; border: none;">Speichern</button>
                        </div>
                    </div>
                    {# Entries list #}
                    <template x-if="entries.length > 0">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <template x-for="(entry, idx) in entries" :key="idx">
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span :style="entry.type === 'applied' ? 'background: rgba(245,158,11,0.15); color: #fbbf24;' : entry.type === 'pdl' ? 'background: rgba(16,185,129,0.15); color: #34d399;' : 'background: rgba(99,102,241,0.15); color: #a5b4fc;'" style="font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;" x-text="entry.type === 'applied' ? 'Beworben' : entry.type === 'pdl' ? 'PDL' : 'Vorgestellt'"></span>
                                        <span style="font-size: 13.5px; font-weight: 650; color: var(--pp-text);" x-text="entry.company"></span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: var(--pp-textDim); font-weight: 500;" x-text="entry.date ? new Date(entry.date).toLocaleDateString('de-DE') : ''"></span>
                                        <button type="button" @click="removeEntry(idx)" style="background: none; border: none; cursor: pointer; color: var(--pp-textDim); font-size: 16px; padding: 0 4px; line-height: 1;" onmouseenter="this.style.color='#ef4444'" onmouseleave="this.style.color='var(--pp-textDim)'">&times;</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="entries.length === 0 && !showAddForm">
                        <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                            <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F3E2;</div>
                            <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Noch bei keinem Unternehmen vorgestellt</div>
                        </div>
                    </template>
                </div>
            </div>
                </div>

                {# Gespräche content #}
                <div x-show="activeTab === 'gespraeche'" style="display:flex; flex-direction:column; gap:20px;">
                    <div class="kd-section kd-anim" style="animation-delay:100ms; overflow:visible; position:relative; z-index:20;">
                        <div class="kd-section-header">
                            <div class="kd-section-title"><span>&#x1F3A4;</span> Gespr&auml;chsdaten</div>
                        </div>
                        <div class="kd-section-body" style="overflow:visible;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div>
                                    <div class="kd-field-label">Gespr&auml;chsdatum</div>
                                    <input type="date" x-model="qfCallDate" @change="saveCallDate()"
                                        class="rounded-lg text-sm font-semibold cursor-pointer"
                                        style="padding:8px 12px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; color-scheme:dark;">
                                </div>
                                <div>
                                    <div class="kd-field-label">Gespr&auml;chstyp</div>
                                    <div class="relative" @click.away="showCallTypeDd = false" style="overflow:visible;">
                                        <button type="button" @click="showCallTypeDd = !showCallTypeDd"
                                            class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                            style="font-family:inherit; background:var(--pp-surface); border:1.5px solid var(--pp-border); color:var(--pp-text);">
                                            <span class="block truncate" x-text="callTypeLabels[qf.call_type] || 'Ausw&auml;hlen'"></span>
                                            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                                <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                            </span>
                                        </button>
                                        <div x-show="showCallTypeDd" x-cloak
                                             class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                             style="background:var(--pp-surface); border:1px solid var(--pp-border); min-width:220px; width:max-content; box-shadow:0 8px 24px rgba(0,0,0,0.5);">
                                            <template x-for="ct in callTypeOptions" :key="ct.value">
                                                <button type="button" @click="qf.call_type = ct.value; showCallTypeDd = false; saveQField('call_type')"
                                                    class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                                    style="font-family:inherit; white-space:nowrap; border:none;"
                                                    :style="qf.call_type === ct.value ? 'background:var(--pp-surfaceHover); color:var(--pp-accent); font-weight:650;' : 'background:none; color:var(--pp-text); font-weight:500;'"
                                                    x-text="ct.label"></button>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {# KI-Zusammenfassung #}
                            <div style="margin-top:12px;">
                                <div class="kd-field-label">KI-Zusammenfassung</div>
                                <textarea x-model="qf.call_summary" @blur="saveQField('call_summary')" placeholder="KI-generierte Zusammenfassung des Gespr&auml;chs..."
                                    class="w-full rounded-lg text-sm font-medium resize-vertical"
                                    style="min-height:80px; padding:8px 12px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; line-height:1.5;"
                                    @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                            </div>
                            {# Transkript #}
                            <div style="margin-top:12px;" x-data="{ showTranscript: false }">
                                <button type="button" @click="showTranscript = !showTranscript"
                                    class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                                    style="background:var(--pp-surfaceHover); border:1.5px solid var(--pp-border); color:var(--pp-textMuted); font-family:inherit;">
                                    <svg :class="showTranscript ? 'rotate-90' : ''" class="w-3 h-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M9 5l7 7-7 7"/></svg>
                                    <span x-text="showTranscript ? 'Transkript ausblenden' : 'Transkript anzeigen'"></span>
                                    <span x-show="qf.call_transcript" x-cloak style="font-size:10px; color:var(--pp-accent); font-weight:600;">(vorhanden)</span>
                                </button>
                                <div x-show="showTranscript" x-cloak style="margin-top:8px;">
                                    <textarea x-model="qf.call_transcript" @blur="saveQField('call_transcript')" placeholder="Volle Transkription des Gespr&auml;chs..."
                                        class="w-full rounded-lg text-sm font-medium resize-vertical"
                                        style="min-height:250px; padding:10px 14px; border:1.5px solid var(--pp-border); color:var(--pp-text); background:var(--pp-surface); font-family:inherit; outline:none; line-height:1.6; font-size:12px;"
                                        @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ═══ TAB: Profil & CV ═══ #}
            <div x-show="activeTab === 'profil'" x-cloak style="display:flex; flex-direction:column; gap:20px;">
                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 300ms; position: relative; z-index: 1;" id="experience">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BC;</span> Berufserfahrung</div>
                    <button type="button" onclick="copyWerdegang()" style="display: flex; align-items: center; gap: 5px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border); border-radius: 6px; padding: 4px 10px; font-size: 10.5px; font-weight: 650; color: var(--pp-text); cursor: pointer; font-family: inherit;">&#x1F4CB; Profil kopieren</button>
                </div>
                <div class="kd-section-body">
                    {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
                        {% set work_list = candidate.work_history %}
                        {% for job in work_list %}{% if job is mapping %}
                        {% set is_first = loop.first %}
                        {% set is_last = loop.last %}
                        {# ── Dauer berechnen ── #}
                        {% set dur_text = job.duration | default('') %}
                        {% if not dur_text and job.start_date %}
                            {% set sd = job.start_date | string %}
                            {% set ed = job.end_date | default('') | string %}
                            {% set s_parts = sd.split('/') %}
                            {% if s_parts | length == 2 %}
                                {% set s_month = s_parts[0] | int %}
                                {% set s_year = s_parts[1] | int %}
                                {% if ed and ed != 'None' and ed != 'null' and ed != 'heute' and ed != 'today' %}
                                    {% set e_parts = ed.split('/') %}
                                    {% if e_parts | length == 2 %}
                                        {% set e_month = e_parts[0] | int %}
                                        {% set e_year = e_parts[1] | int %}
                                    {% else %}
                                        {% set e_month = now().month %}
                                        {% set e_year = now().year %}
                                    {% endif %}
                                {% else %}
                                    {% set e_month = now().month %}
                                    {% set e_year = now().year %}
                                {% endif %}
                                {% set total_months = (e_year - s_year) * 12 + (e_month - s_month) %}
                                {% if total_months > 0 %}
                                    {% set d_years = total_months // 12 %}
                                    {% set d_months = total_months % 12 %}
                                    {% if d_years > 0 and d_months > 0 %}
                                        {% set dur_text = d_years ~ ' J. ' ~ d_months ~ ' Mon.' %}
                                    {% elif d_years > 0 %}
                                        {% set dur_text = d_years ~ ' Jahr' ~ ('e' if d_years != 1 else '') %}
                                    {% else %}
                                        {% set dur_text = d_months ~ ' Mon.' %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        <div style="display: flex; gap: 10px; padding: 12px 0; {% if not is_last %}border-bottom: 1px solid var(--pp-surfaceHover);{% endif %}">
                            {# Timeline dot + line #}
                            <div style="display: flex; flex-direction: column; align-items: center; padding-top: 4px; flex-shrink: 0; width: 20px;">
                                <div class="{% if is_first %}kd-exp-dot-current{% else %}kd-exp-dot-past{% endif %}"></div>
                                {% if not is_last %}
                                <div class="kd-exp-line"></div>
                                {% endif %}
                            </div>
                            {# Content #}
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 6px; flex-wrap: wrap;">
                                    <div>
                                        <div style="font-size: 14.5px; font-weight: 720; color: var(--pp-text); letter-spacing: -0.01em; line-height: 1.3;">
                                            {{ job.position | default(job.title | default('Unbekannte Position')) }}
                                        </div>
                                        <div style="font-size: 13px; color: var(--pp-textMuted); margin-top: 3px; font-weight: 500;">
                                            {{ job.company | default('Unbekanntes Unternehmen') }}
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                        {% if job.start_date %}
                                        <span style="font-size: 12px; color: var(--pp-textDim); font-weight: 500; white-space: nowrap;">
                                            {{ job.start_date }}{% if job.end_date and job.end_date != 'None' %} &ndash; {{ job.end_date }}{% else %} &ndash; heute{% endif %}
                                        </span>
                                        {% endif %}
                                        {% if dur_text %}
                                        <span style="font-size: 11px; font-weight: 650; padding: 3px 10px; border-radius: 8px; background: var(--pp-surfaceHover); color: {% if is_first %}var(--pp-accent){% else %}var(--pp-textMuted){% endif %}; white-space: nowrap;">
                                            {{ dur_text }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {# Tasks/Description #}
                                {% if job.description and job.description != 'null' and job.description != 'None' %}
                                <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 6px;">
                                    {% for line in job.description.split('\n') %}
                                    {% set clean_line = line.strip().lstrip('•').lstrip('-').lstrip('–').strip() %}
                                    {% if clean_line and clean_line != 'None' and clean_line != 'null' %}
                                    <div style="display: flex; gap: 8px; font-size: 13px; color: var(--pp-text); line-height: 1.55;">
                                        <span style="color: var(--pp-border); margin-top: 2px; flex-shrink: 0; font-size: 6px; line-height: 22px;">&#x25CF;</span>
                                        <span>{{ clean_line }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F4BC;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Berufserfahrung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 400ms;" id="it-skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BB;</span> IT-Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.it_skills and candidate.it_skills | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        {% for skill in candidate.it_skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {% set sk_low = skill.lower() %}
                        {% set is_core = sk_low in ['sap', 'sap s/4hana', 'sap-sem-bcs', 'sap fi', 'sap co', 'sap mm', 'sap bcs', 'cch tagetik', 'datev', 'addison', 'oracle', 'navision', 'dynamics', 'lucanet', 'sigma', 'hyperion', 'cognos', 'jedox', 'board', 'anaplan'] or 'sap' in sk_low or 'erp' in sk_low or 'datev' in sk_low or 'tagetik' in sk_low or 'lucanet' in sk_low or 'konsolidierung' in sk_low or 'hyperion' in sk_low or 'cognos' in sk_low %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid {% if is_core %}var(--pp-accent){% else %}var(--pp-border){% endif %};">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% if is_core %}
                                <span style="font-size: 9px; font-weight: 700; padding: 2px 7px; border-radius: 5px; background: var(--pp-accent); color: #fff; text-transform: uppercase; letter-spacing: 0.05em;">CORE</span>
                                {% endif %}
                                <span style="font-size: 13.5px; font-weight: 680; color: var(--pp-text);">{{ skill }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F4BB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine IT-Kenntnisse hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 500ms;" id="languages">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F310;</span> Sprachen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.languages and candidate.languages is iterable and candidate.languages is not string and candidate.languages | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        {% for lang in candidate.languages %}{% if lang is mapping %}
                        {% set lang_name = lang.language | default('Unbekannt') %}
                        {% set lang_level = lang.level | default('') %}
                        {% set is_native = 'mutter' in lang_level.lower() if lang_level else false %}
                        {% set pct = 100 if is_native else (95 if 'flie' in lang_level.lower() else (85 if 'verhandlung' in lang_level.lower() else (70 if 'gut' in lang_level.lower() else (50 if 'grund' in lang_level.lower() else 60)))) if lang_level else 50 %}
                        <div style="display: flex; align-items: center; gap: 12px; padding: 5px 0;">
                            <div style="width: 80px; font-size: 13px; font-weight: 650; color: var(--pp-text);">{{ lang_name }}</div>
                            <div style="flex: 1;">
                                <div class="kd-lang-bar">
                                    <div class="kd-lang-fill" style="width: {{ pct }}%; background: linear-gradient(90deg, {% if is_native %}#10b981, #34d399{% else %}#6366f1, #a78bfa{% endif %});"></div>
                                </div>
                            </div>
                            {% if lang_level and lang_level != 'None' and lang_level != 'null' %}
                            <div style="font-size: 11.5px; color: var(--pp-textMuted); font-weight: 500; min-width: 180px; text-align: right;">{{ lang_level }}</div>
                            {% endif %}
                        </div>
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F310;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Sprachen hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 600ms;" id="skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F9E9;</span> Skills &amp; Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.skills and candidate.skills | length > 0 %}
                    {# Legend #}
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #4f46e5;"></span> Fachlich
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #059669;"></span> Technisch
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #a16207;"></span> Sonstige
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        {% for skill in candidate.skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {# Heuristic: tech keywords → green, fach (finance/accounting) → indigo, soft skills → amber #}
                        {% set sk_low = skill.lower() %}
                        {% set is_tech = sk_low in ['sap', 'excel', 'word', 'powerpoint', 'outlook', 'teams', 'python', 'sql', 'javascript', 'html', 'css', 'r', 'tableau', 'power bi', 'datev', 'addison'] or 'microsoft' in sk_low or 'sap' in sk_low or 'office' in sk_low or 'software' in sk_low or 'erp' in sk_low or 'it' == sk_low or 'edv' in sk_low %}
                        {% set is_soft = 'kommunikation' in sk_low or 'führung' in sk_low or 'team' in sk_low or 'management' in sk_low or 'organisation' in sk_low or 'präsentation' in sk_low or 'verhandlung' in sk_low or 'coaching' in sk_low or 'moderation' in sk_low or 'motivation' in sk_low or 'analytisch' in sk_low %}
                        <span class="{% if is_tech %}skill-tech{% elif is_soft %}skill-soft{% else %}skill-fach{% endif %}" style="font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px;">{{ skill }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F9E9;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Skills hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 700ms;" id="certifications">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F393;</span> Zertifikate &amp; Weiterbildungen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.further_education and candidate.further_education is iterable and candidate.further_education is not string and candidate.further_education | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        {% for wb in candidate.further_education %}{% if wb is mapping %}
                        {% set wb_name = wb.degree if (wb.degree and wb.degree != 'None' and wb.degree != 'null') else (wb.qualification if (wb.qualification and wb.qualification != 'None' and wb.qualification != 'null') else '') %}
                        {% set wb_inst = wb.institution | default('') %}
                        {% if wb_inst == 'None' or wb_inst == 'null' %}{% set wb_inst = '' %}{% endif %}
                        {% set wb_start = wb.start_date | default('') %}
                        {% if wb_start == 'None' or wb_start == 'null' %}{% set wb_start = '' %}{% endif %}
                        {% set wb_end = wb.end_date | default('') %}
                        {% if wb_end == 'None' or wb_end == 'null' %}{% set wb_end = '' %}{% endif %}
                        {% set wb_year = wb.year | default('') %}
                        {% if wb_year == 'None' or wb_year == 'null' %}{% set wb_year = '' %}{% endif %}
                        {% if wb_start and wb_end %}
                            {% set wb_timerange = wb_start ~ ' – ' ~ wb_end %}
                        {% elif wb_start %}
                            {% set wb_timerange = 'ab ' ~ wb_start %}
                        {% elif wb_end %}
                            {% set wb_timerange = wb_end %}
                        {% elif wb_year %}
                            {% set wb_timerange = wb_year %}
                        {% else %}
                            {% set wb_timerange = '' %}
                        {% endif %}
                        {# Generische Einträge ohne Details dezenter darstellen #}
                        {% set is_generic = wb_name.lower() in ['seminar', 'e-learning', 'kurs', 'workshop', 'webinar', 'schulung', 'weiterbildung', ''] and not wb_inst %}
                        {% if wb_name %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border); {% if is_generic %}opacity: 0.7;{% endif %}">
                            <div>
                                <div style="font-size: 13.5px; font-weight: {% if is_generic %}550{% else %}650{% endif %}; color: {% if is_generic %}var(--pp-textMuted){% else %}var(--pp-text){% endif %};">
                                    {{ wb_name }}{% if is_generic and not wb_inst %} <span style="font-size: 11px; color: var(--pp-textDim); font-weight: 400; font-style: italic;">(ohne Details)</span>{% endif %}
                                </div>
                                {% if wb_inst %}
                                <div style="font-size: 12px; color: var(--pp-textDim); margin-top: 2px; font-weight: 500;">{{ wb_inst }}</div>
                                {% endif %}
                            </div>
                            {% if wb_timerange %}
                            <span style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600; background: var(--pp-surfaceHover); padding: 3px 10px; border-radius: 6px; white-space: nowrap;">{{ wb_timerange }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F393;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Zertifikate hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

                <div class="kd-section kd-section-glow kd-anim" style="animation-delay: 800ms;" id="education">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4DA;</span> Ausbildung</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.education and candidate.education is iterable and candidate.education is not string and candidate.education | length > 0 %}
                    {% for edu in candidate.education %}{% if edu is mapping %}
                    {% set edu_name = edu.degree if (edu.degree and edu.degree != 'None' and edu.degree != 'null') else (edu.qualification if (edu.qualification and edu.qualification != 'None' and edu.qualification != 'null') else 'Ausbildung') %}
                    {% set edu_inst = edu.institution | default(edu.school | default('')) %}
                    {% set edu_start = edu.start_date | default('') %}
                    {% if edu_start == 'None' or edu_start == 'null' %}{% set edu_start = '' %}{% endif %}
                    {% set edu_end = edu.end_date | default('') %}
                    {% if edu_end == 'None' or edu_end == 'null' %}{% set edu_end = '' %}{% endif %}
                    {% set edu_year = edu.year | default('') %}
                    {% if edu_year == 'None' or edu_year == 'null' %}{% set edu_year = '' %}{% endif %}
                    {% if edu_start and edu_end %}
                        {% set edu_timerange = edu_start ~ ' – ' ~ edu_end %}
                    {% elif edu_start %}
                        {% set edu_timerange = 'ab ' ~ edu_start %}
                    {% elif edu_end %}
                        {% set edu_timerange = edu_end %}
                    {% elif edu_year %}
                        {% set edu_timerange = edu_year %}
                    {% else %}
                        {% set edu_timerange = '' %}
                    {% endif %}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 7px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border);">
                        <div>
                            <div style="font-size: 14px; font-weight: 680; color: var(--pp-text);">{{ edu_name }}</div>
                            {% if edu_inst and edu_inst != 'None' and edu_inst != 'null' %}
                            <div style="font-size: 12.5px; color: var(--pp-textMuted); margin-top: 2px; font-weight: 500;">{{ edu_inst }}</div>
                            {% endif %}
                        </div>
                        {% if edu_timerange %}
                        <span style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600; background: var(--pp-surfaceHover); padding: 3px 10px; border-radius: 6px; white-space: nowrap;">{{ edu_timerange }}</span>
                        {% endif %}
                    </div>
                    {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 10px 0;">
                        <div style="font-size: 18px; margin-bottom: 4px; opacity: 0.3;">&#x1F4DA;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Ausbildung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>

        </div>

        {# ── RIGHT SIDEBAR ── #}
        <div style="width: 300px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; position: sticky; top: 12px; align-self: flex-start;">

            

            {# Pipeline-Status #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 250ms;">
                <div class="kd-sidebar-header">
                    Pipeline-Status
                    <a href="/ats/pipeline" style="font-size: 11px; font-weight: 600; color: var(--pp-accent); text-decoration: none;">Pipeline &rarr;</a>
                </div>
                <div id="candidate-pipeline" hx-get="/partials/candidate-pipeline/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 12px 0;">
                        <div style="font-size: 20px; margin-bottom: 4px; opacity: 0.4;">&#x1F4CB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim); text-align: center;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# Passende Jobs #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 350ms;">
                <div class="kd-sidebar-header">Passende Jobs</div>
                <div id="matching-jobs" hx-get="/partials/candidate-jobs/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 8px 0;">
                        <div style="font-size: 12px; color: var(--pp-textDim); text-align: center; font-weight: 500;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# CV-Status + Upload #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 450ms;"
                 x-data="{ cvUploading: false, cvDragging: false }">
                <div class="kd-sidebar-body" style="padding: 12px 14px;">
                    {# Header Row: Icon + Title + Badge #}
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="flex items-center justify-center rounded-lg" style="width: 32px; height: 32px; background: rgba(99,102,241,0.12);">
                                <svg class="w-4 h-4" style="color: var(--pp-accent);" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                            </div>
                            <span style="font-size: 13px; font-weight: 700; color: var(--pp-text);">Lebenslauf</span>
                        </div>
                        {% if candidate.cv_url or candidate.cv_stored_path %}
                        <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[10px] font-bold uppercase tracking-wide" style="background: rgba(5,150,105,0.15); color: #34d399;">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            Vorhanden
                        </span>
                        {% else %}
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] font-bold uppercase tracking-wide" style="background: rgba(220,38,38,0.12); color: #fca5a5;">Fehlt</span>
                        {% endif %}
                    </div>

                    {% if candidate.cv_parsed_at %}
                    {# Parsed info - compact inline #}
                    <div class="flex items-center gap-1.5 mb-3" style="font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                        <svg class="w-3.5 h-3.5 flex-shrink-0" style="color: var(--pp-textDim);" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Zuletzt geparst: <span style="color: var(--pp-text); font-weight: 600;">{{ candidate.cv_parsed_at.strftime('%d.%m.%Y %H:%M') }}</span></span>
                    </div>
                    {% endif %}

                    {# Upload Zone - kompakt #}
                    <div class="rounded-lg transition-all duration-200 cursor-pointer"
                         style="border: 1.5px dashed var(--pp-border); padding: 14px; text-align: center; background: var(--pp-bg);"
                         :style="cvUploading ? 'opacity: 0.5; pointer-events: none;' : cvDragging ? 'border-color: var(--pp-accent); background: rgba(99,102,241,0.06);' : ''"
                         @dragover.prevent="cvDragging = true"
                         @dragenter.prevent="cvDragging = true"
                         @dragleave.prevent="cvDragging = false"
                         @drop.prevent="cvDragging = false; if ($event.dataTransfer.files.length) { let f = $event.dataTransfer.files[0]; if (f.name.toLowerCase().endsWith('.pdf')) { cvUploading = true; let fd = new FormData(); fd.append('file', f); fetch('/api/candidates/{{ candidate.id }}/upload-cv', { method: 'POST', body: fd }).then(r => r.json()).then(d => { cvUploading = false; if (d.success) { showToast('CV hochgeladen — wird verarbeitet...', 'success'); setTimeout(() => location.reload(), 3000); } else { showToast(d.message || 'Upload fehlgeschlagen', 'error'); } }).catch(() => { cvUploading = false; showToast('Upload fehlgeschlagen', 'error'); }); } else { showToast('Nur PDF-Dateien erlaubt', 'warning'); } }"
                         @click="$refs.cvFileInput.click()">
                        <input type="file" accept=".pdf" class="hidden" x-ref="cvFileInput"
                               @change="if ($event.target.files.length) { let f = $event.target.files[0]; if (!f.name.toLowerCase().endsWith('.pdf')) { showToast('Nur PDF-Dateien erlaubt', 'warning'); return; } cvUploading = true; let fd = new FormData(); fd.append('file', f); fetch('/api/candidates/{{ candidate.id }}/upload-cv', { method: 'POST', body: fd }).then(r => r.json()).then(d => { cvUploading = false; if (d.success) { showToast('CV hochgeladen — wird verarbeitet...', 'success'); setTimeout(() => location.reload(), 3000); } else { showToast(d.message || 'Upload fehlgeschlagen', 'error'); } }).catch(() => { cvUploading = false; showToast('Upload fehlgeschlagen', 'error'); }); $event.target.value = ''; }">
                        <div class="flex items-center justify-center gap-2">
                            <svg x-show="!cvUploading" class="w-4 h-4" style="color: var(--pp-textDim);" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                            <span x-show="!cvUploading && !cvDragging" style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600;">PDF hochladen oder hierhin ziehen</span>
                            <span x-show="cvDragging" x-cloak style="font-size: 12px; color: var(--pp-accent); font-weight: 600;">Hier ablegen</span>
                            <span x-show="cvUploading" x-cloak style="font-size: 12px; color: var(--pp-accent); font-weight: 600;">Wird hochgeladen...</span>
                        </div>
                    </div>

                    {% if candidate.cv_url or candidate.cv_stored_path %}
                    <button type="button" hx-post="/api/candidates/{{ candidate.id }}/reparse-cv" hx-swap="none"
                            hx-on::after-request="showToast('CV wird neu geparst...', 'info'); setTimeout(() => location.reload(), 3000)"
                            class="w-full mt-2.5 py-2 rounded-lg text-xs font-bold cursor-pointer transition-all duration-150"
                            style="background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-text); font-family: inherit;"
                            onmouseenter="this.style.borderColor='var(--pp-accent)';this.style.color='var(--pp-accent)'"
                            onmouseleave="this.style.borderColor='var(--pp-border)';this.style.color='var(--pp-text)'">
                        <span class="flex items-center justify-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182M4.031 9.865l-.001-.001" /></svg>
                            CV neu parsen
                        </span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

{# CV-Vorschau Slide-Over Panel #}
{% if candidate.cv_url or candidate.cv_stored_path %}
<div id="cv-preview-overlay" class="hidden relative" style="z-index: 9999;">
    <div class="cv-overlay-bg fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity duration-300 ease-in-out opacity-0" onclick="closeCvPreview()"></div>
    <div class="fixed inset-0 overflow-hidden">
        <div class="absolute inset-0 overflow-hidden">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
                <div id="cv-preview-panel" class="pointer-events-auto w-screen max-w-2xl transform transition-transform duration-300 ease-in-out translate-x-full">
                    <div class="flex h-full flex-col shadow-xl" style="font-family: 'Outfit', sans-serif; background: var(--pp-surface);">
                        <div class="flex items-center justify-between px-6 py-4" style="background: var(--pp-surfaceHover); border-bottom: 1px solid var(--pp-border);">
                            <div>
                                <h2 class="text-lg font-bold" style="color: var(--pp-text);">CV-Vorschau</h2>
                                <p class="text-sm" style="color: var(--pp-textDim);">{{ display_name }}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <a href="/api/candidates/{{ candidate.id }}/cv-preview" target="_blank" class="kd-quickbtn" style="font-size: 11.5px; padding: 7px 12px;">&#x2197; Neuer Tab</a>
                                <button type="button" onclick="closeCvPreview()" style="background: var(--pp-surfaceHover); border: none; border-radius: 8px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--pp-textMuted); font-size: 16px;">&#x2715;</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-hidden relative">
                            <iframe id="cv-preview-iframe" src="" class="w-full h-full border-0" title="CV-Vorschau"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// ==================== Recruiting-Daten (Phase 2) ====================
function recruitingFields() {
    return {
        currentSource: {{ (candidate.source or '') | tojson | safe }} || '',
        currentWillingness: {{ (candidate.willingness_to_change or '') | tojson | safe }} || '',
        lastContactDate: {{ (candidate.last_contact.strftime('%Y-%m-%d') if candidate.last_contact else '') | tojson | safe }},
        notesText: {{ (candidate.candidate_notes or '') | tojson | safe }},
        notesSaved: true,
        showSourceDropdown: false,
        sourceOptions: ['StepStone', 'Xing', 'LinkedIn', 'Indeed', 'Empfehlung', 'CRM', 'Direktansprache', 'Jobboerse', 'Sonstiges'],

        async setSource(src) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: src })
                });
                if (response.ok) {
                    this.currentSource = src;
                    this.showSourceDropdown = false;
                    if (typeof showToast === 'function') showToast('Quelle gespeichert', 'success');
                }
            } catch (err) { console.error('Quelle speichern fehlgeschlagen:', err); }
        },

        async setWillingness(val) {
            var candidateId = '{{ candidate.id }}';
            var newVal = this.currentWillingness === val ? null : val;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ willingness_to_change: newVal })
                });
                if (response.ok) {
                    this.currentWillingness = newVal || '';
                    if (typeof showToast === 'function') showToast('Wechselbereitschaft gespeichert', 'success');
                }
            } catch (err) { console.error('Wechselbereitschaft speichern fehlgeschlagen:', err); }
        },

        async setLastContact() {
            var candidateId = '{{ candidate.id }}';
            var dateVal = this.lastContactDate ? new Date(this.lastContactDate).toISOString() : null;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ last_contact: dateVal })
                });
                if (response.ok) {
                    if (typeof showToast === 'function') showToast('Letzter Kontakt gespeichert', 'success');
                }
            } catch (err) { console.error('Letzter Kontakt speichern fehlgeschlagen:', err); }
        },

        async setLastContactNow() {
            var today = new Date();
            this.lastContactDate = today.toISOString().split('T')[0];
            await this.setLastContact();
        },

        async saveNotes() {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidate_notes: this.notesText || null })
                });
                if (response.ok) {
                    this.notesSaved = true;
                    if (typeof showToast === 'function') showToast('Notizen gespeichert', 'success');
                }
            } catch (err) { console.error('Notizen speichern fehlgeschlagen:', err); }
        }
    };
}

// ==================== Pipeline-Daten (ERP + Rating) ====================
function pipelineFields() {
    return {
        newErp: '',
        currentRating: {{ candidate.rating or 0 }},
        currentErp: {{ (candidate.erp or []) | tojson | safe }},

        async addErp() {
            var val = this.newErp.trim();
            if (!val) return;
            var items = val.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
            var merged = this.currentErp.concat(items);
            merged = merged.filter(function(v, i, a) { return a.indexOf(v) === i; });
            await this.saveErp(merged);
            this.newErp = '';
        },

        async removeErp(item) {
            var filtered = this.currentErp.filter(function(e) { return e !== item; });
            await this.saveErp(filtered);
        },

        async saveErp(erpList) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ erp: erpList })
                });
                if (response.ok) {
                    this.currentErp = erpList;
                    if (typeof showToast === 'function') showToast('ERP gespeichert', 'success');
                    setTimeout(function() { location.reload(); }, 500);
                }
            } catch (err) { console.error('ERP speichern fehlgeschlagen:', err); }
        },

        async setRating(value) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: value })
                });
                if (response.ok) {
                    this.currentRating = value;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = i <= value ? '#f59e0b' : '#2A2D3A'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung gespeichert', 'success');
                }
            } catch (err) { console.error('Rating speichern fehlgeschlagen:', err); }
        },

        async clearRating() {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: null })
                });
                if (response.ok) {
                    this.currentRating = 0;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = '#2A2D3A'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung entfernt', 'success');
                }
            } catch (err) { console.error('Rating entfernen fehlgeschlagen:', err); }
        }
    };
}

// ==================== Qualifizierungsgespräch ====================
function qualificationFields() {
    return {
        qfSaving: false,
        showTransportDd: false,
        showEmpTypeDd: false,
        showCallTypeDd: false,
        qfCallDate: {{ (candidate.call_date.strftime('%Y-%m-%d') if candidate.call_date else '') | tojson | safe }},
        callTypeOptions: [
            { value: 'qualifizierung', label: 'Qualifizierungsgespräch' },
            { value: 'kurz', label: 'Kurzer Call' },
            { value: 'kunde', label: 'Kundengespräch' },
            { value: 'sonstig', label: 'Sonstiges' }
        ],
        callTypeLabels: { 'qualifizierung': 'Qualifizierungsgespräch', 'kurz': 'Kurzer Call', 'kunde': 'Kundengespräch', 'sonstig': 'Sonstiges' },
        qf: {
            desired_positions: {{ (candidate.desired_positions or '') | tojson | safe }},
            key_activities: {{ (candidate.key_activities or '') | tojson | safe }},
            home_office_days: {{ (candidate.home_office_days or '') | tojson | safe }},
            commute_max: {{ (candidate.commute_max or '') | tojson | safe }},
            commute_transport: {{ (candidate.commute_transport or '') | tojson | safe }},
            erp_main: {{ (candidate.erp_main or '') | tojson | safe }},
            employment_type: {{ (candidate.employment_type or '') | tojson | safe }},
            part_time_hours: {{ (candidate.part_time_hours or '') | tojson | safe }},
            preferred_industries: {{ (candidate.preferred_industries or '') | tojson | safe }},
            avoided_industries: {{ (candidate.avoided_industries or '') | tojson | safe }},
            open_office_ok: {{ (candidate.open_office_ok or '') | tojson | safe }},
            whatsapp_ok: {{ 'true' if candidate.whatsapp_ok == true else ('false' if candidate.whatsapp_ok == false else 'null') }},
            other_recruiters: {{ (candidate.other_recruiters or '') | tojson | safe }},
            exclusivity_agreed: {{ 'true' if candidate.exclusivity_agreed == true else ('false' if candidate.exclusivity_agreed == false else 'null') }},
            applied_at_companies_text: {{ (candidate.applied_at_companies_text or '') | tojson | safe }},
            call_transcript: {{ (candidate.call_transcript or '') | tojson | safe }},
            call_summary: {{ (candidate.call_summary or '') | tojson | safe }},
            call_type: {{ (candidate.call_type or '') | tojson | safe }}
        },
        _qfOriginal: {},
        init() {
            this._qfOriginal = JSON.parse(JSON.stringify(this.qf));
        },

        async saveQField(fieldName) {
            var val = this.qf[fieldName];
            var origVal = this._qfOriginal[fieldName];
            if (val === origVal) return;
            if (typeof val === 'string' && val.trim() === '' && (origVal === '' || origVal === null || origVal === undefined)) return;
            var candidateId = '{{ candidate.id }}';
            var payload = {};
            if (typeof val === 'string' && val.trim() === '') val = null;
            payload[fieldName] = val;
            this.qfSaving = true;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    this._qfOriginal[fieldName] = this.qf[fieldName];
                    if (typeof showToast === 'function') showToast('Gespeichert', 'success');
                } else {
                    if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
                }
            } catch (err) {
                console.error('QF speichern fehlgeschlagen:', err);
                if (typeof showToast === 'function') showToast('Fehler beim Speichern', 'error');
            }
            this.qfSaving = false;
        },

        async setQfChoice(fieldName, value) {
            var current = this.qf[fieldName];
            this.qf[fieldName] = current === value ? '' : value;
            await this.saveQField(fieldName);
        },

        async toggleQfBool(fieldName, value) {
            var current = this.qf[fieldName];
            this.qf[fieldName] = current === value ? null : value;
            await this.saveQField(fieldName);
        },

        async saveCallDate() {
            var candidateId = '{{ candidate.id }}';
            var dateVal = this.qfCallDate ? new Date(this.qfCallDate).toISOString() : null;
            this.qfSaving = true;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ call_date: dateVal })
                });
                if (response.ok) {
                    if (typeof showToast === 'function') showToast('Gesprächsdatum gespeichert', 'success');
                }
            } catch (err) { console.error('Call-Datum speichern fehlgeschlagen:', err); }
            this.qfSaving = false;
        }
    };
}

// Global removeErp for Jinja-rendered buttons
function removeErp(item) {
    var comp = document.querySelector('[x-data="pipelineFields()"]');
    if (comp) {
        var data = Alpine.$data(comp);
        if (data) data.removeErp(item);
    }
}

function deleteCandidate(candidateId, candidateName) {
    if (!confirm('Kandidat ' + candidateName + ' wirklich l\u00f6schen?')) return;
    fetch('/api/candidates/' + candidateId, { method: 'DELETE' })
    .then(function(r) { return r.json(); })
    .then(function(d) { if (d.success) window.location.href = '/kandidaten'; });
}

// ==================== Kopieren ====================
function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(function() {
        if (typeof showToast === 'function') showToast(label + ' kopiert', 'success');
    }).catch(function() {
        var ta = document.createElement('textarea');
        ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        if (typeof showToast === 'function') showToast(label + ' kopiert', 'success');
    });
}

// ==================== Profil kopieren ====================
var _werdegangData = {{ (candidate.work_history or []) | tojson | safe }};
var _itSkillsData = {{ (candidate.it_skills or []) | tojson | safe }};
var _languagesData = {{ (candidate.languages or []) | tojson | safe }};
var _furtherEducationData = {{ (candidate.further_education or []) | tojson | safe }};
var _educationData = {{ (candidate.education or []) | tojson | safe }};
var _skillsData = {{ (candidate.skills or []) | tojson | safe }};
{% set _sn_inv = ['not available','n/a','na','none','null','-','—',''] %}
{% set _sn_f = candidate.first_name or '' %}
{% set _sn_l = candidate.last_name or '' %}
{% set _sn_fv = _sn_f if _sn_f|lower|trim not in _sn_inv else '' %}
{% set _sn_lv = _sn_l if _sn_l|lower|trim not in _sn_inv else '' %}
{% set _sn_fd = (_sn_fv|title) if (_sn_fv == _sn_fv|upper and _sn_fv|length > 1) else _sn_fv %}
{% set _sn_ld = (_sn_lv|title) if (_sn_lv == _sn_lv|upper and _sn_lv|length > 1) else _sn_lv %}
{% set _sn_name = ((_sn_fd ~ ' ' ~ _sn_ld)|trim) if (_sn_fd or _sn_ld) else 'Unbekannt' %}
var _candidateName = {{ _sn_name | tojson | safe }};

function buildFullProfileText(name, workHistory, itSkills, languages, furtherEdu, education, skills) {
    var lines = []; var hasContent = false;
    if (workHistory && workHistory.length > 0) {
        hasContent = true; lines.push('--- BERUFSERFAHRUNG ---'); lines.push('');
        for (var i = 0; i < workHistory.length; i++) {
            var job = workHistory[i];
            if (!job || typeof job !== 'object') continue;
            var dateRange = '';
            if (job.start_date) { dateRange = job.start_date; dateRange += job.end_date ? ' - ' + job.end_date : ' - heute'; }
            if (dateRange) lines.push(dateRange);
            lines.push(job.position || job.title || 'Unbekannte Position');
            lines.push(job.company || 'Unbekanntes Unternehmen');
            if (job.description) lines.push(job.description);
            lines.push('');
        }
    }
    if (itSkills && itSkills.length > 0) { hasContent = true; lines.push('--- IT-KENNTNISSE ---'); lines.push(itSkills.join(', ')); lines.push(''); }
    if (languages && languages.length > 0) {
        hasContent = true; lines.push('--- SPRACHEN ---');
        for (var i = 0; i < languages.length; i++) {
            var lang = languages[i];
            if (!lang || typeof lang !== 'object') continue;
            var langLine = lang.language || 'Unbekannt';
            if (lang.level) langLine += ' (' + lang.level + ')';
            lines.push(langLine);
        }
        lines.push('');
    }
    if (furtherEdu && furtherEdu.length > 0) {
        hasContent = true; lines.push('--- ZERTIFIKATE & WEITERBILDUNGEN ---');
        for (var i = 0; i < furtherEdu.length; i++) {
            var wb = furtherEdu[i]; if (!wb || typeof wb !== 'object') continue;
            var wbLine = wb.degree || wb.qualification || 'Weiterbildung';
            if (wb.institution) wbLine += ' | ' + wb.institution;
            if (wb.year || wb.end_date) wbLine += ' | ' + (wb.year || wb.end_date);
            lines.push(wbLine);
        }
        lines.push('');
    }
    if (education && education.length > 0) {
        hasContent = true; lines.push('--- AUSBILDUNG ---');
        for (var i = 0; i < education.length; i++) {
            var edu = education[i]; if (!edu || typeof edu !== 'object') continue;
            var eduLine = edu.degree || edu.qualification || 'Ausbildung';
            if (edu.institution || edu.school) eduLine += ' | ' + (edu.institution || edu.school);
            if (edu.year || edu.end_date) eduLine += ' | ' + (edu.year || edu.end_date);
            lines.push(eduLine);
        }
        lines.push('');
    }
    if (skills && skills.length > 0) { hasContent = true; lines.push('--- SKILLS & KENNTNISSE ---'); lines.push(skills.join(', ')); lines.push(''); }
    if (!hasContent) return null;
    return lines.join('\n').trim();
}

function copyWerdegang() {
    var text = buildFullProfileText(_candidateName, _werdegangData, _itSkillsData, _languagesData, _furtherEducationData, _educationData, _skillsData);
    if (!text) { if (typeof showToast === 'function') showToast('Kein Profil vorhanden', 'warning'); return; }
    copyToClipboard(text, 'Profil');
}

// ==================== Inline Edit ====================
function startDetailEdit(displayEl) {
    var wrapper = displayEl.closest('.detail-edit-wrapper');
    var input = wrapper.querySelector('.detail-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus(); input.select();
}

function handleDetailEditKey(event, input) {
    if (event.key === 'Enter') { input.blur(); }
    else if (event.key === 'Escape') {
        var wrapper = input.closest('.detail-edit-wrapper');
        var display = wrapper.querySelector('.detail-edit-display');
        input.classList.add('hidden'); display.classList.remove('hidden');
    }
}

function saveDetailEdit(input) {
    var wrapper = input.closest('.detail-edit-wrapper');
    var display = wrapper.querySelector('.detail-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldText = display.textContent.trim();
    var placeholders = ['Keine Position angegeben', 'Kein Unternehmen', 'Vorname', 'Nachname', 'Nicht angegeben'];
    if (placeholders.indexOf(oldText) !== -1) oldText = '';
    if (newValue === oldText) { input.classList.add('hidden'); display.classList.remove('hidden'); return; }
    var body = {}; body[field] = newValue || null;
    fetch('/api/candidates/' + candidateId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.id) {
            var fallbackTexts = { 'current_position': 'Keine Position angegeben', 'current_company': 'Kein Unternehmen', 'first_name': 'Vorname', 'last_name': 'Nachname', 'salary': 'Nicht angegeben', 'notice_period': 'Nicht angegeben', 'source': 'Nicht angegeben', 'candidate_notes': '' };
            display.textContent = newValue || fallbackTexts[field] || '\u2014';
            if (typeof showToast === 'function') showToast('Gespeichert', 'success');
        }
    })
    .catch(function() { input.value = oldText; })
    .finally(function() { input.classList.add('hidden'); display.classList.remove('hidden'); });
}

// ==================== CV-Vorschau ====================
function openCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');
    iframe.src = '/api/candidates/{{ candidate.id }}/cv-preview';
    overlay.classList.remove('hidden');
    requestAnimationFrame(function() {
        overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-0');
        overlay.querySelector('.cv-overlay-bg').classList.add('opacity-100');
        panel.classList.remove('translate-x-full'); panel.classList.add('translate-x-0');
    });
    document.body.style.overflow = 'hidden';
}

function closeCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');
    panel.classList.remove('translate-x-0'); panel.classList.add('translate-x-full');
    overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-100');
    overlay.querySelector('.cv-overlay-bg').classList.add('opacity-0');
    setTimeout(function() { overlay.classList.add('hidden'); iframe.src = ''; }, 300);
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var overlay = document.getElementById('cv-preview-overlay');
        if (overlay && !overlay.classList.contains('hidden')) closeCvPreview();
    }
});
</script>
{% endblock %}
