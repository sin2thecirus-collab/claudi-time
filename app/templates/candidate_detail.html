{% extends "base.html" %}
{% block title %}{% set _t_first = candidate.first_name or '' %}{% set _t_last = candidate.last_name or '' %}{% set _t_inv = ['not available','n/a','na','none','null','-','—',''] %}{% set _t_f = _t_first if _t_first|lower|trim not in _t_inv else '' %}{% set _t_l = _t_last if _t_last|lower|trim not in _t_inv else '' %}{% set _t_name = ((_t_f ~ ' ' ~ _t_l)|trim) if (_t_f or _t_l) else 'Unbekannt' %}{{ _t_name }} - Pulspoint{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    .kd-wrap, .kd-wrap * { font-family: 'Outfit', 'DM Sans', -apple-system, sans-serif; }
    .kd-wrap { background: var(--pp-bg); color: var(--pp-text); font-size: 15px; }

    /* Globale Skalierung aller inline font-sizes innerhalb kd-wrap */
    .kd-wrap [style*="font-size: 9px"]   { font-size: 11px !important; }
    .kd-wrap [style*="font-size: 10px"]  { font-size: 12px !important; }
    .kd-wrap [style*="font-size: 11px"]  { font-size: 13px !important; }
    .kd-wrap [style*="font-size: 11.5px"]{ font-size: 13.5px !important; }
    .kd-wrap [style*="font-size: 12px"]  { font-size: 14px !important; }
    .kd-wrap [style*="font-size: 12.5px"]{ font-size: 14.5px !important; }
    .kd-wrap [style*="font-size: 13px"]  { font-size: 15px !important; }
    .kd-wrap [style*="font-size: 13.5px"]{ font-size: 15.5px !important; }
    .kd-wrap [style*="font-size: 14px"]  { font-size: 16px !important; }
    .kd-wrap [style*="font-size: 15px"]  { font-size: 17px !important; }
    .kd-wrap [style*="font-size: 22px"]  { font-size: 26px !important; }
    .kd-wrap [style*="font-size: 24px"]  { font-size: 28px !important; }
    .kd-wrap [style*="font-size: 26px"]  { font-size: 30px !important; }
    .kd-wrap ::-webkit-scrollbar { width: 5px; }
    .kd-wrap ::-webkit-scrollbar-track { background: transparent; }
    .kd-wrap ::-webkit-scrollbar-thumb { background: var(--pp-border); border-radius: 3px; }

    @keyframes kdFadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes kdSlideIn {
        from { opacity: 0; transform: translateX(12px); }
        to   { opacity: 1; transform: translateX(0); }
    }
    .kd-anim { opacity: 0; animation: kdFadeUp 0.5s cubic-bezier(0.4,0,0.2,1) forwards; }
    .kd-anim-side { opacity: 0; animation: kdSlideIn 0.5s cubic-bezier(0.4,0,0.2,1) forwards; }

    .kd-section {
        background: var(--pp-surface); border-radius: 16px; border: 1px solid var(--pp-border); overflow: hidden;
    }
    .kd-section-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 18px 26px; border-bottom: 1px solid var(--pp-surfaceHover);
        background: var(--pp-surfaceHover);
    }
    .kd-section-title {
        display: flex; align-items: center; gap: 12px;
        font-size: 17px; font-weight: 750; color: var(--pp-text); letter-spacing: -0.02em;
    }
    .kd-section-body { padding: 22px 26px; }

    .kd-sidebar-card {
        background: var(--pp-surface); border-radius: 14px; border: 1px solid var(--pp-border); overflow: hidden;
    }
    .kd-sidebar-header {
        padding: 16px 22px; border-bottom: 1px solid var(--pp-surfaceHover);
        display: flex; align-items: center; justify-content: space-between;
        background: var(--pp-surfaceHover);
        font-size: 15px; font-weight: 700; color: var(--pp-text);
    }
    .kd-sidebar-body { padding: 18px 22px; }

    .kd-exp-dot-current {
        width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
        background: var(--pp-accent);
        border: 3px solid var(--pp-border);
    }
    .kd-exp-dot-past {
        width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
        background: var(--pp-border); border: 3px solid var(--pp-surfaceHover);
    }
    .kd-exp-line {
        width: 2px; flex: 1; margin-top: 6px;
        background: linear-gradient(to bottom, var(--pp-border), transparent);
    }

    .kd-lang-bar {
        height: 8px; border-radius: 4px; overflow: hidden; background: var(--pp-surfaceHover);
    }
    .kd-lang-fill {
        height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    }

    .kd-quickbtn {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 11px 20px; border-radius: 10px;
        font-size: 14px; font-weight: 630; cursor: pointer;
        font-family: inherit; transition: all 0.2s; border: 1.5px solid var(--pp-border);
        background: var(--pp-surface); color: var(--pp-text);
    }
    .kd-quickbtn:hover { background: var(--pp-surfaceHover); }
    .kd-quickbtn-primary {
        background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; border: none;
        box-shadow: 0 2px 8px rgba(99,102,241,0.25);
    }
    .kd-quickbtn-primary:hover { background: linear-gradient(135deg, #4f46e5, #7c3aed); }
    .kd-quickbtn-accent {
        background: var(--pp-surface); color: var(--pp-accent); border: 1.5px solid var(--pp-border);
    }
    .kd-quickbtn-accent:hover { background: var(--pp-surfaceHover); }
    .kd-quickbtn-danger {
        background: var(--pp-surface); color: #dc2626; border: 1.5px solid #fecaca;
    }
    .kd-quickbtn-danger:hover { background: var(--pp-surfaceHover); }

    /* Nav item */
    .kd-nav-btn {
        display: flex; align-items: center; gap: 10px;
        padding: 10px 16px; border-radius: 9px;
        background: transparent; border: none; cursor: pointer; width: 100%; text-align: left;
        font-family: inherit; transition: all 0.15s; font-size: 14px; font-weight: 500; color: var(--pp-textMuted);
    }
    .kd-nav-btn:hover { background: var(--pp-surfaceHover); }
    .kd-nav-btn.active { background: var(--pp-surfaceHover); font-weight: 650; color: var(--pp-accent); }

    /* Inline edit overrides for new design */
    .kd-wrap .detail-edit-display {
        cursor: pointer; border-radius: 4px; padding: 2px 6px;
        transition: all 0.15s;
    }
    .kd-wrap .detail-edit-display:hover {
        background: rgba(99,102,241,0.06);
    }
    .kd-wrap .detail-edit-input {
        font-family: inherit; border-radius: 8px;
    }

    /* Skill category colors */
    .skill-fach { background: var(--pp-surfaceHover); color: var(--pp-accent); border: 1px solid var(--pp-border); }
    .skill-tech { background: var(--pp-surfaceHover); color: #34d399; border: 1px solid var(--pp-border); }
    .skill-soft { background: var(--pp-surfaceHover); color: #fbbf24; border: 1px solid var(--pp-border); }

    /* Copy button */
    .kd-copy-btn {
        background: var(--pp-surfaceHover); border: none; border-radius: 7px; padding: 5px 10px;
        font-size: 13px; cursor: pointer; color: var(--pp-textDim); font-weight: 600;
        transition: all 0.2s; font-family: inherit;
    }
    .kd-copy-btn:hover { background: var(--pp-border); color: var(--pp-textMuted); }
</style>
{% endblock %}

{% block content %}
{# ── Data Quality: Invalid-Name-Filterung + Normalisierung ── #}
{% set invalid_names = ['not available', 'n/a', 'na', 'none', 'null', '-', '—', ''] %}
{% set raw_first = candidate.first_name or '' %}
{% set raw_last = candidate.last_name or '' %}
{% set first_valid = raw_first if raw_first | lower | trim not in invalid_names else '' %}
{% set last_valid = raw_last if raw_last | lower | trim not in invalid_names else '' %}
{# ALL CAPS → Title Case (ohne if/else wg. Jinja2 Scoping) #}
{% set first_display = (first_valid | title) if (first_valid == first_valid | upper and first_valid | length > 1) else first_valid %}
{% set last_display = (last_valid | title) if (last_valid == last_valid | upper and last_valid | length > 1) else last_valid %}
{% set has_valid_name = first_display or last_display %}
{% set display_name = ((first_display ~ ' ' ~ last_display) | trim) if has_valid_name else 'Unbekannt' %}
{% set raw_position = candidate.current_position or '' %}
{% set position_invalid = raw_position | lower | trim in (invalid_names + ['keine position angegeben']) %}
{% set position_display = '' if position_invalid else raw_position %}
{% set raw_company = candidate.current_company or '' %}
{% set company_invalid = raw_company | lower | trim in (invalid_names + ['kein unternehmen']) %}
{% set company_display = '' if company_invalid else raw_company %}
{% set raw_city = candidate.city or '' %}
{% set city_invalid = raw_city | lower | trim in (invalid_names + ['keine adresse']) %}
{% set city_display = '' if city_invalid else raw_city %}
{# ── End Data Quality ── #}
<div class="kd-wrap min-h-screen" x-data="{ activeSection: 'experience' }">

    {# ════════════════════════════════════════════════════
       VIOLET HERO HEADER
    ════════════════════════════════════════════════════ #}
    <div style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 40%, #4338ca 100%); padding: 28px 40px 0; position: relative; overflow: hidden;">
        {# Decorative circle #}
        <div style="position: absolute; top: -60px; right: -60px; width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, rgba(129,140,248,0.15) 0%, transparent 70%);"></div>

        {# Breadcrumb #}
        <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 20px; font-weight: 500;">
            <a href="/" style="cursor: pointer; color: rgba(255,255,255,0.6); text-decoration: none;">&#x1F3E0;</a>
            <span>&#x203A;</span>
            <a href="/kandidaten" style="cursor: pointer; color: rgba(255,255,255,0.6); text-decoration: none;">Kandidaten</a>
            <span>&#x203A;</span>
            <span style="color: rgba(255,255,255,0.85);">{{ display_name }}</span>
        </div>

        {# Avatar + Name + Meta #}
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 22px;">
            <div style="width: 68px; height: 68px; border-radius: 18px; background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px; font-weight: 800; border: 3px solid rgba(255,255,255,0.2); box-shadow: 0 4px 20px rgba(0,0,0,0.2); flex-shrink: 0;">
                {{ (first_display or 'X')[0] | upper }}{{ (last_display or 'X')[0] | upper }}
            </div>
            <div style="flex: 1; min-width: 0;">
                {# Name - editable #}
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="first_name">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Vorname bearbeiten" style="font-size: 26px; font-weight: 800; color: #fff; letter-spacing: -0.03em; cursor: pointer;">{{ first_display or 'Vorname' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ first_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 22px; font-weight: 800; color: var(--pp-text); padding: 2px 8px; border-radius: 8px; border: 2px solid var(--pp-accent); width: 200px; background: var(--pp-surface);">
                    </div>
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="last_name">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Nachname bearbeiten" style="font-size: 26px; font-weight: 800; color: #fff; letter-spacing: -0.03em; cursor: pointer;">{{ last_display or 'Nachname' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ last_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 22px; font-weight: 800; color: var(--pp-text); padding: 2px 8px; border-radius: 8px; border: 2px solid var(--pp-accent); width: 200px; background: var(--pp-surface);">
                    </div>
                    {% if candidate.candidate_number %}
                    <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 8px; background: rgba(99,102,241,0.2); color: #a5b4fc; border: 1px solid rgba(99,102,241,0.3); margin-left: 6px;" title="Kandidaten-Nr.">
                        #{{ candidate.candidate_number }}
                    </span>
                    <button type="button" onclick="copyToClipboard('#{{ candidate.candidate_number }}', 'Kandidaten-Nr.')" style="display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 7px; background: rgba(255,255,255,0.08); border: none; cursor: pointer; color: rgba(255,255,255,0.5); transition: all 0.15s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)';this.style.color='#a5b4fc'" onmouseleave="this.style.background='rgba(255,255,255,0.08)';this.style.color='rgba(255,255,255,0.5)'" title="Kandidaten-Nr. kopieren">
                        <svg style="width: 13px; height: 13px;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>
                    </button>
                    {% endif %}
                </div>

                {# Position + Company - editable #}
                <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px; flex-wrap: wrap;">
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_position">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Position bearbeiten" style="font-size: 14px; color: rgba(255,255,255,0.7); font-weight: 500; cursor: pointer;">{{ position_display or 'Keine Position angegeben' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ position_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 14px; color: var(--pp-text); padding: 2px 8px; border-radius: 8px; border: 2px solid var(--pp-accent); background: var(--pp-surface);">
                    </div>
                    {% if company_display %}
                    <span style="color: rgba(255,255,255,0.4);">&middot;</span>
                    {% endif %}
                    <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="current_company">
                        <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Unternehmen bearbeiten" style="font-size: 14px; color: rgba(255,255,255,0.5); font-weight: 500; cursor: pointer;">{{ company_display or 'Kein Unternehmen' }}</span>
                        <input type="text" class="detail-edit-input hidden" value="{{ company_display or '' }}" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 14px; color: var(--pp-text); padding: 2px 8px; border-radius: 8px; border: 2px solid var(--pp-accent); background: var(--pp-surface);">
                    </div>
                </div>

                {# Meta badges #}
                <div style="display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap;">
                    {% if candidate.birth_date or candidate.age %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4C5;</span>
                        {% if candidate.birth_date %}{{ candidate.birth_date.strftime('%d.%m.%Y') }}{% endif %}{% if candidate.age %} ({{ candidate.age }} Jahre){% endif %}
                    </span>
                    {% endif %}
                    {% if city_display %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4CD;</span>
                        {{ city_display }}{% if candidate.postal_code %}, {{ candidate.postal_code }}{% endif %}
                    </span>
                    {% endif %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F554;</span>
                        Seit {{ candidate.created_at.strftime('%d.%m.%Y') if candidate.created_at else 'Unbekannt' }}
                    </span>
                    {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11.5px; color: rgba(255,255,255,0.6); font-weight: 500; background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px;">
                        <span style="font-size: 12px;">&#x1F4CA;</span>
                        {{ candidate.work_history | length }} Position{{ 'en' if candidate.work_history | length != 1 else '' }}
                    </span>
                    {% endif %}
                </div>

                {# Job title tags + Rating #}
                {% if candidate.manual_job_titles and candidate.manual_job_titles | length > 0 %}
                <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; align-items: center;">
                    {% for title in candidate.manual_job_titles %}
                    <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 8px; background: rgba(16,185,129,0.15); color: #6ee7b7;">
                        &#x1F3F7; {{ title }}
                    </span>
                    {% endfor %}
                    {% if candidate.rating %}
                    <span style="display: inline-flex; align-items: center; gap: 2px; font-size: 13px; padding: 2px 8px; border-radius: 8px; background: rgba(245,158,11,0.15);">
                        {% for i in range(1, 6) %}
                        <span style="color: {% if i <= candidate.rating %}#f59e0b{% else %}rgba(255,255,255,0.2){% endif %};">&#9733;</span>
                        {% endfor %}
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        {# Quick Action Buttons #}
        <div x-data="{
            showPipelineModal: false,
            jobs: [],
            selectedJob: '',
            selectedStage: 'sent',
            loading: false,
            showNewJobForm: false,
            newJobTitle: '',
            newJobCompanyId: '',
            newJobCompanyName: '',
            newJobCity: '',
            companies: [],
            filteredCompanies: [],
            creatingJob: false,
            showJobDropdown: false,
            selectedJobName: '',
            async loadJobs() {
                try {
                    const response = await fetch('/api/ats/jobs');
                    const data = await response.json();
                    this.jobs = data.items || [];
                } catch (err) {
                    console.error('Error loading jobs:', err);
                }
            },
            selectJob(job) {
                this.selectedJob = job.id;
                this.selectedJobName = job.company_name ? job.company_name + ' - ' + job.title : job.title;
                this.showJobDropdown = false;
            },
            async loadCompanies() {
                const response = await fetch('/api/companies?limit=500');
                const data = await response.json();
                this.companies = data.items || [];
            },
            filterCompanies() {
                if (!this.newJobCompanyName) { this.filteredCompanies = []; return; }
                const term = this.newJobCompanyName.toLowerCase();
                this.filteredCompanies = this.companies.filter(c => c.name.toLowerCase().includes(term)).slice(0, 10);
            },
            selectCompany(company) {
                this.newJobCompanyId = company.id;
                this.newJobCompanyName = company.name;
                this.filteredCompanies = [];
            },
            async createJob() {
                if (!this.newJobTitle || !this.newJobCompanyId) return;
                this.creatingJob = true;
                const response = await fetch('/api/ats/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: this.newJobTitle, company_id: this.newJobCompanyId, location_city: this.newJobCity || null })
                });
                if (response.ok) {
                    const job = await response.json();
                    this.jobs.push(job);
                    this.selectedJob = job.id;
                    this.showNewJobForm = false;
                    this.newJobTitle = ''; this.newJobCompanyId = ''; this.newJobCompanyName = ''; this.newJobCity = '';
                    showToast('Stelle erstellt', 'success');
                } else { showToast('Fehler beim Erstellen', 'error'); }
                this.creatingJob = false;
            },
            async addToPipeline() {
                if (!this.selectedJob) return;
                this.loading = true;
                const response = await fetch('/api/ats/pipeline/' + this.selectedJob + '/candidates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidate_id: '{{ candidate.id }}', stage: this.selectedStage })
                });
                if (response.ok) {
                    showToast('Kandidat zur Pipeline hinzugefuegt', 'success');
                    this.showPipelineModal = false; this.selectedJob = ''; this.selectedStage = 'sent';
                    htmx.trigger('#candidate-pipeline', 'load');
                } else if (response.status === 409) { showToast('Kandidat ist bereits in dieser Pipeline', 'warning'); }
                else { showToast('Fehler beim Hinzufuegen', 'error'); }
                this.loading = false;
            }
        }" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                {% if candidate.cv_url or candidate.cv_stored_path %}
                <a href="/api/candidates/{{ candidate.id }}/cv-preview" target="_blank" class="kd-quickbtn" style="color: rgba(255,255,255,0.7); border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); text-decoration: none;">
                    <span style="font-size: 14px;">&#x1F4C4;</span> CV herunterladen
                </a>
                <button type="button" onclick="openCvPreview()" class="kd-quickbtn kd-quickbtn-accent">
                    <span style="font-size: 14px;">&#x1F441;</span> CV ansehen
                </button>
                {% endif %}
                <button type="button" @click="showPipelineModal = true; loadJobs()" class="kd-quickbtn kd-quickbtn-primary">
                    <span style="font-size: 14px;">+</span> Zur Pipeline
                </button>
            </div>
            <div style="display: flex; gap: 8px;">
                {% if not candidate.hidden %}
                <button type="button" hx-put="/api/candidates/{{ candidate.id }}/hide" hx-swap="none" hx-on::after-request="showToast('Kandidat ausgeblendet', 'success')" class="kd-quickbtn" style="color: rgba(255,255,255,0.5); border-color: rgba(255,255,255,0.1); background: transparent;">
                    <span style="font-size: 14px;">&#x1F441;</span> Ausblenden
                </button>
                {% else %}
                <button type="button" hx-put="/api/candidates/{{ candidate.id }}/unhide" hx-swap="none" hx-on::after-request="showToast('Kandidat wieder eingeblendet', 'success')" class="kd-quickbtn" style="color: #6ee7b7; border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.1);">
                    <span style="font-size: 14px;">&#x1F441;</span> Einblenden
                </button>
                {% endif %}
                <button type="button" onclick="deleteCandidate('{{ candidate.id }}', '{{ display_name }}')" class="kd-quickbtn kd-quickbtn-danger">
                    <span style="font-size: 14px;">&#x1F5D1;</span> L&ouml;schen
                </button>
            </div>

            {# ── Pipeline Modal (same logic, restyled) ── #}
            <div x-show="showPipelineModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div x-show="showPipelineModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" @click="showPipelineModal = false"></div>
                    <div x-show="showPipelineModal" x-transition class="relative rounded-2xl p-8 max-w-xl w-full shadow-2xl z-10" style="font-family: inherit; background: var(--pp-surface);">
                        <div class="text-center mb-6">
                            <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-2xl mb-4" style="background: var(--pp-surfaceHover);"
                                <svg class="h-7 w-7 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            </div>
                            <h3 class="text-xl font-bold" style="color: var(--pp-text);">Zur Pipeline hinzuf&uuml;gen</h3>
                            <p class="mt-1 text-sm" style="color: var(--pp-textDim);">Stelle und Phase w&auml;hlen</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2" style="color: var(--pp-text);">Stelle</label>
                                <div class="relative" @click.away="showJobDropdown = false">
                                    <button type="button" @click="showJobDropdown = !showJobDropdown" class="relative w-full cursor-pointer rounded-xl py-3 pl-4 pr-10 text-left text-sm shadow-sm focus:outline-none" style="font-family: inherit; background: var(--pp-surface); color: var(--pp-text); border: 1px solid var(--pp-border);">
                                        <span class="block truncate" x-text="selectedJobName || 'Stelle ausw\u00e4hlen...'"></span>
                                        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z" clip-rule="evenodd" /></svg></span>
                                    </button>
                                    <div x-show="showJobDropdown" x-cloak class="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-xl py-1 text-sm shadow-lg ring-1 ring-black/5" style="background: var(--pp-surface);">
                                        <template x-if="jobs.length === 0"><div class="px-4 py-3" style="color: var(--pp-textDim);">Keine Stellen vorhanden</div></template>
                                        <template x-for="job in jobs" :key="job.id">
                                            <button type="button" @click="selectJob(job)" class="relative w-full cursor-pointer select-none py-3 pl-4 pr-9 text-left" :style="selectedJob === job.id ? 'background: var(--pp-surfaceHover); color: var(--pp-accent);' : 'color: var(--pp-text);'" style="font-family: inherit;">
                                                <span class="block truncate" x-text="job.company_name ? job.company_name + ' - ' + job.title : job.title"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" @click="showNewJobForm = !showNewJobForm; if(showNewJobForm && companies.length === 0) loadCompanies()" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1 font-semibold" style="font-family: inherit;">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                        <span x-text="showNewJobForm ? 'Abbrechen' : 'Neue Stelle erstellen'"></span>
                                    </button>
                                </div>
                                <div x-show="showNewJobForm" x-cloak class="mt-3 p-4 rounded-xl space-y-3" style="background: var(--pp-bg); border: 1px solid var(--pp-border);">
                                    <div>
                                        <label class="block text-sm font-medium" style="color: var(--pp-text);">Stellentitel *</label>
                                        <input type="text" x-model="newJobTitle" class="mt-1 block w-full rounded-lg shadow-sm text-sm py-2" placeholder="z.B. Senior Accountant" style="font-family: inherit; background: var(--pp-surface); color: var(--pp-text); border: 1px solid var(--pp-border);">
                                    </div>
                                    <div class="relative" @click.away="filteredCompanies = []">
                                        <label class="block text-sm font-medium" style="color: var(--pp-text);">Unternehmen *</label>
                                        <input type="text" x-model="newJobCompanyName" @input="filterCompanies()" @focus="filterCompanies()" class="mt-1 block w-full rounded-lg shadow-sm text-sm py-2" placeholder="Unternehmen suchen..." style="font-family: inherit; background: var(--pp-surface); color: var(--pp-text); border: 1px solid var(--pp-border);">
                                        <div x-show="filteredCompanies.length > 0" class="absolute z-10 mt-1 w-full rounded-lg shadow-lg max-h-48 overflow-y-auto" style="background: var(--pp-surface); border: 1px solid var(--pp-border);">
                                            <template x-for="company in filteredCompanies" :key="company.id">
                                                <button type="button" @click="selectCompany(company)" class="w-full text-left px-4 py-2 text-sm" x-text="company.name" style="font-family: inherit; color: var(--pp-text);" onmouseenter="this.style.background='var(--pp-surfaceHover)'" onmouseleave="this.style.background='transparent'"></button>
                                            </template>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium" style="color: var(--pp-text);">Ort (optional)</label>
                                        <input type="text" x-model="newJobCity" class="mt-1 block w-full rounded-lg shadow-sm text-sm py-2" placeholder="z.B. Berlin" style="font-family: inherit; background: var(--pp-surface); color: var(--pp-text); border: 1px solid var(--pp-border);">
                                    </div>
                                    <div class="flex gap-2 pt-1">
                                        <button type="button" @click="createJob()" :disabled="!newJobTitle || !newJobCompanyId || creatingJob" class="inline-flex items-center px-4 py-2 text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg disabled:opacity-50" style="font-family: inherit;">Stelle erstellen</button>
                                        <button type="button" @click="showNewJobForm = false" class="px-4 py-2 text-sm font-medium rounded-lg" style="font-family: inherit; background: var(--pp-surface); color: var(--pp-text); border: 1px solid var(--pp-border);">Abbrechen</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2" style="color: var(--pp-text);">Phase</label>
                                <select x-model="selectedStage" class="block w-full rounded-xl shadow-sm text-sm py-3" style="font-family: inherit; background: var(--pp-surface); color: var(--pp-text); border: 1px solid var(--pp-border);">
                                    <option value="sent">Vorgestellt</option>
                                    <option value="interview_1">Interview 1</option>
                                    <option value="interview_2">Interview 2</option>
                                    <option value="interview_3">Interview 3</option>
                                    <option value="offer">Angebot</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-2 gap-3">
                            <button type="button" @click="showPipelineModal = false" class="py-3 rounded-xl text-sm font-semibold" style="font-family: inherit; background: var(--pp-surfaceHover); color: var(--pp-text);">Abbrechen</button>
                            <button type="button" @click="addToPipeline()" :disabled="!selectedJob || loading" class="py-3 rounded-xl text-white text-sm font-semibold disabled:opacity-50" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); font-family: inherit;">
                                <svg x-show="loading" class="animate-spin inline -ml-1 mr-1.5 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                                Hinzuf&uuml;gen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ════════════════════════════════════════════════════
       MAIN CONTENT: 2-Column Layout
    ════════════════════════════════════════════════════ #}
    <div style="display: flex; gap: 24px; padding: 24px 40px; max-width: 1400px; margin: 0 auto;">

        {# ── LEFT COLUMN (main content) ── #}
        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 18px;">

            {# ── Kontaktdaten ── #}
            <div class="kd-section kd-anim" style="animation-delay: 100ms;" id="contact">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4C7;</span> Kontaktdaten</div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        {# Email #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">E-Mail</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if candidate.email %}
                                <span style="font-size: 13.5px; font-weight: 600; color: var(--pp-accent);">{{ candidate.email }}</span>
                                <button type="button" onclick="copyToClipboard('{{ candidate.email }}', 'E-Mail')" class="kd-copy-btn">&#x1F4CB;</button>
                                {% else %}
                                <span style="font-size: 13.5px; font-weight: 600; color: var(--pp-textDim); font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                        {# Phone #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">Telefon</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if candidate.phone %}
                                <span style="font-size: 13.5px; font-weight: 600; color: var(--pp-accent);">{{ candidate.phone }}</span>
                                <button type="button" onclick="copyToClipboard('{{ candidate.phone }}', 'Telefonnummer')" class="kd-copy-btn">&#x1F4CB;</button>
                                {% else %}
                                <span style="font-size: 13.5px; font-weight: 600; color: var(--pp-textDim); font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                        {# Address #}
                        <div style="grid-column: 1 / -1;">
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">Adresse</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if candidate.street_address or candidate.postal_code or city_display %}
                                <span style="font-size: 13.5px; font-weight: 600; color: var(--pp-text);" id="address-text">{% if candidate.street_address %}{{ candidate.street_address }}{% endif %}{% if candidate.postal_code or city_display %}{% if candidate.street_address %}, {% endif %}{{ candidate.postal_code }} {{ city_display }}{% endif %}</span>
                                <button type="button" onclick="copyToClipboard(document.getElementById('address-text').textContent.trim(), 'Adresse')" class="kd-copy-btn">&#x1F4CB;</button>
                                {% else %}
                                <span style="font-size: 13.5px; font-weight: 600; color: var(--pp-textDim); font-style: italic;">Nicht angegeben</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Recruiting-Daten (Phase 2) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 150ms;" id="recruiting-data"
                 x-data="recruitingFields()">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F50D;</span> Recruiting-Daten</div>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        {# Quelle #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">Quelle</div>
                            <div class="relative" @click.away="showSourceDropdown = false">
                                <button type="button" @click="showSourceDropdown = !showSourceDropdown"
                                    class="relative w-full cursor-pointer rounded-lg py-2 pl-3 pr-8 text-left text-sm font-semibold"
                                    style="font-family: inherit; background: var(--pp-surface); border: 1.5px solid var(--pp-border); color: {% if candidate.source %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.source %}font-style: italic;{% endif %}">
                                    <span class="block truncate" x-text="currentSource || 'Nicht angegeben'"></span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                        <svg class="h-4 w-4 opacity-50" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                    </span>
                                </button>
                                <div x-show="showSourceDropdown" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 220px; width: max-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="src in sourceOptions" :key="src">
                                        <button type="button" @click="setSource(src)"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; border: none;"
                                            :style="currentSource === src ? 'background: var(--pp-surfaceHover); color: var(--pp-accent); font-weight: 650;' : 'background: none; color: var(--pp-text); font-weight: 500;'"
                                            @mouseenter="$el.style.background = 'var(--pp-surfaceHover)'"
                                            @mouseleave="if (currentSource !== src) $el.style.background = 'none'"
                                            x-text="src"></button>
                                    </template>
                                </div>
                            </div>
                        </div>
                        {# Wechselbereitschaft #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">Wechselbereitschaft</div>
                            <div style="display: flex; gap: 6px;">
                                <template x-for="opt in [{val: 'ja', label: 'Ja', color: '#059669', bg: 'rgba(5,150,105,0.15)'}, {val: 'nein', label: 'Nein', color: '#dc2626', bg: 'rgba(220,38,38,0.15)'}, {val: 'unbekannt', label: '?', color: 'var(--pp-textMuted)', bg: 'var(--pp-surfaceHover)'}]" :key="opt.val">
                                    <button type="button" @click="setWillingness(opt.val)"
                                        style="padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: 650; cursor: pointer; font-family: inherit; transition: all 0.15s; border: 1.5px solid;"
                                        :style="currentWillingness === opt.val ? 'background: ' + opt.bg + '; color: ' + opt.color + '; border-color: ' + opt.color + ';' : 'background: var(--pp-surface); color: var(--pp-textDim); border-color: var(--pp-border);'"
                                        x-text="opt.label"></button>
                                </template>
                            </div>
                        </div>
                        {# Letzter Kontakt #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">Letzter Kontakt</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <input type="date" x-model="lastContactDate" @change="setLastContact()"
                                    style="padding: 5px 8px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 12.5px; font-weight: 600; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; cursor: pointer; outline: none; color-scheme: dark;">
                                <button type="button" @click="setLastContactNow()" title="Auf heute setzen"
                                    style="padding: 5px 8px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 11px; font-weight: 650; cursor: pointer; font-family: inherit; white-space: nowrap;">Heute</button>
                            </div>
                        </div>
                    </div>
                    {# Notizen (Freitext) #}
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--pp-surfaceHover);">
                        <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.06em;">Notizen</div>
                        <textarea x-model="notesText" @blur="saveNotes()" placeholder="Gespr&auml;chsnotizen, Wechselmotivation, Gehaltsvorstellung, K&uuml;ndigungsfrist..."
                            style="width: 100%; min-height: 100px; padding: 12px 14px; border-radius: 10px; border: 1.5px solid var(--pp-border); font-size: 13px; font-weight: 500; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; resize: vertical; outline: none; line-height: 1.5;"
                            @focus="$el.style.borderColor = 'var(--pp-accent)'" @focusout="$el.style.borderColor = 'var(--pp-border)'"></textarea>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 10.5px; color: var(--pp-textDim); font-weight: 500;" x-text="notesSaved ? 'Gespeichert' : 'Wird beim Verlassen gespeichert'"></span>
                            <button type="button" @click="saveNotes()" style="padding: 5px 12px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 11px; font-weight: 650; cursor: pointer; font-family: inherit;">Speichern</button>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Pipeline-Daten ── #}
            <div class="kd-section kd-anim" style="animation-delay: 250ms;" id="pipeline-data"
                 x-data="pipelineFields()">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F3AF;</span> Pipeline-Daten</div>
                    <span style="font-size: 11.5px; font-weight: 650; padding: 5px 12px; border-radius: 8px; background: var(--pp-surfaceHover); color: var(--pp-accent); border: 1.5px solid var(--pp-border);">F&uuml;r Pipeline</span>
                </div>
                <div class="kd-section-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        {# Gehalt #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">Gehaltswunsch</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="salary">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="Gehalt bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.salary %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.salary %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.salary or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.salary or '' }}" placeholder="z.B. 55.000 &euro;" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Kuendigungsfrist #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">K&uuml;ndigungsfrist</div>
                            <div class="detail-edit-wrapper" data-candidate-id="{{ candidate.id }}" data-field="notice_period">
                                <span class="detail-edit-display" onclick="startDetailEdit(this)" title="K&uuml;ndigungsfrist bearbeiten" style="font-size: 13.5px; font-weight: 600; color: {% if candidate.notice_period %}var(--pp-text){% else %}var(--pp-textDim){% endif %}; {% if not candidate.notice_period %}font-style: italic;{% endif %} cursor: pointer;">{{ candidate.notice_period or 'Nicht angegeben' }}</span>
                                <input type="text" class="detail-edit-input hidden" value="{{ candidate.notice_period or '' }}" placeholder="z.B. 3 Monate" onblur="saveDetailEdit(this)" onkeydown="handleDetailEditKey(event, this)" style="font-size: 13px; padding: 4px 8px; border-radius: 8px; border: 1.5px solid var(--pp-accent); width: 100%; font-family: inherit;">
                            </div>
                        </div>
                        {# Rating #}
                        <div>
                            <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em;">Bewertung</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="display: flex; gap: 3px;">
                                    {% for i in range(1, 6) %}
                                    <button type="button" @click="setRating({{ i }})" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; transition: transform 0.15s;" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'">
                                        <span id="star-{{ i }}" style="color: {% if candidate.rating and i <= candidate.rating %}#f59e0b{% else %}var(--pp-border){% endif %};">&#9733;</span>
                                    </button>
                                    {% endfor %}
                                </div>
                                <span style="font-size: 11.5px; color: var(--pp-textMuted); font-weight: 500;" x-text="currentRating ? currentRating + '/5' : 'Nicht bewertet'"></span>
                                <button type="button" x-show="currentRating > 0" @click="clearRating()" style="font-size: 11px; color: var(--pp-textDim); background: none; border: none; cursor: pointer; font-family: inherit; padding: 2px 6px; border-radius: 4px;">&#x2715;</button>
                            </div>
                        </div>
                    </div>
                    {# ERP #}
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--pp-surfaceHover);">
                        <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.06em;">ERP-Kenntnisse</div>
                        {% if candidate.erp and candidate.erp | length > 0 %}
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                            {% for erp_item in candidate.erp %}
                            <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px; background: var(--pp-surfaceHover); color: var(--pp-accent); border: 1px solid var(--pp-border);">
                                {{ erp_item }}
                                <button type="button" onclick="removeErp('{{ erp_item }}')" style="background: none; border: none; cursor: pointer; color: #a5b4fc; font-size: 14px; padding: 0; margin-left: 2px; line-height: 1;" onmouseenter="this.style.color='#ef4444'" onmouseleave="this.style.color='#a5b4fc'">&times;</button>
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="font-size: 12px; color: var(--pp-textDim); font-style: italic; margin-bottom: 10px;">Keine ERP-Kenntnisse angegeben</div>
                        {% endif %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" x-model="newErp" @keydown.enter.prevent="addErp()" placeholder="z.B. SAP, DATEV..." style="padding: 8px 12px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 12.5px; font-weight: 500; color: var(--pp-text); outline: none; width: 180px; font-family: inherit; background: var(--pp-surface);">
                            <button type="button" @click="addErp()" style="padding: 8px 14px; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-accent); font-size: 12px; font-weight: 650; cursor: pointer; font-family: inherit;">+ Hinzuf&uuml;gen</button>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Vorgestellt bei / Beworben bei ── #}
            <div class="kd-section kd-anim" style="animation-delay: 275ms;" id="presented-at"
                 x-data="{
                    entries: {{ (candidate.presented_at_companies or []) | tojson | safe }},
                    showAddForm: false,
                    newCompany: '',
                    newType: 'presented',
                    newDate: new Date().toISOString().split('T')[0],
                    allCompanies: [],
                    filteredCompanies: [],
                    showCompanyDropdown: false,
                    async loadCompanies() {
                        if (this.allCompanies.length > 0) return;
                        try {
                            var response = await fetch('/api/companies?limit=500');
                            var data = await response.json();
                            this.allCompanies = (data.items || []).map(function(c) { return c.name; });
                        } catch (err) { console.error(err); }
                    },
                    filterCompanies() {
                        if (!this.newCompany || this.newCompany.length < 1) { this.filteredCompanies = []; this.showCompanyDropdown = false; return; }
                        var term = this.newCompany.toLowerCase();
                        this.filteredCompanies = this.allCompanies.filter(function(n) { return n.toLowerCase().includes(term); }).slice(0, 8);
                        this.showCompanyDropdown = this.filteredCompanies.length > 0;
                    },
                    selectCompany(name) {
                        this.newCompany = name;
                        this.filteredCompanies = [];
                        this.showCompanyDropdown = false;
                    },
                    async addEntry() {
                        if (!this.newCompany.trim()) return;
                        var entry = { company: this.newCompany.trim(), date: this.newDate, type: this.newType };
                        this.entries.push(entry);
                        var candidateId = '{{ candidate.id }}';
                        try {
                            await fetch('/api/candidates/' + candidateId, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ presented_at_companies: this.entries })
                            });
                            if (typeof showToast === 'function') showToast('Eintrag hinzugefuegt', 'success');
                        } catch (err) { console.error(err); }
                        this.newCompany = ''; this.showAddForm = false;
                    },
                    async removeEntry(idx) {
                        this.entries.splice(idx, 1);
                        var candidateId = '{{ candidate.id }}';
                        try {
                            await fetch('/api/candidates/' + candidateId, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ presented_at_companies: this.entries })
                            });
                            if (typeof showToast === 'function') showToast('Eintrag entfernt', 'success');
                        } catch (err) { console.error(err); }
                    }
                 }">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F3E2;</span> Vorgestellt / Beworben bei</div>
                    <button type="button" @click="showAddForm = !showAddForm; if(showAddForm) loadCompanies()" style="display: flex; align-items: center; gap: 6px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); border-radius: 8px; padding: 5px 12px; font-size: 11.5px; font-weight: 650; color: var(--pp-accent); cursor: pointer; font-family: inherit;">
                        <span x-text="showAddForm ? 'Abbrechen' : '+ Hinzuf&uuml;gen'"></span>
                    </button>
                </div>
                <div class="kd-section-body">
                    {# Add form #}
                    <div x-show="showAddForm" x-cloak class="mb-3.5 overflow-visible" style="padding: 14px; border-radius: 10px; background: var(--pp-bg); border: 1px solid var(--pp-border);">
                        <div class="flex flex-wrap items-end gap-2.5 overflow-visible">
                            <div class="relative flex-[2] min-w-[220px]" @click.away="showCompanyDropdown = false">
                                <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">Unternehmen</div>
                                <input type="text" x-model="newCompany" @input="filterCompanies()" @focus="filterCompanies()" @keydown.enter.prevent="showCompanyDropdown = false; addEntry()" placeholder="z.B. Allianz, Siemens..."
                                    class="w-full rounded-lg text-sm outline-none"
                                    style="padding: 7px 10px; border: 1.5px solid var(--pp-border); color: var(--pp-text); background: var(--pp-surface); font-family: inherit;">
                                <div x-show="showCompanyDropdown" x-cloak
                                     class="absolute z-50 mt-1 max-h-60 overflow-auto rounded-xl py-1 text-sm shadow-lg"
                                     style="background: var(--pp-surface); border: 1px solid var(--pp-border); min-width: 300px; width: max-content; max-width: 450px; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                    <template x-for="name in filteredCompanies" :key="name">
                                        <button type="button" @click="selectCompany(name)"
                                            class="w-full cursor-pointer select-none py-2.5 pl-3 pr-4 text-left text-sm"
                                            style="font-family: inherit; white-space: nowrap; color: var(--pp-text); font-weight: 500; background: none; border: none;"
                                            @mouseenter="$el.style.background='var(--pp-surfaceHover)'"
                                            @mouseleave="$el.style.background='none'"
                                            x-text="name"></button>
                                    </template>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">Typ</div>
                                <select x-model="newType" style="padding: 7px 10px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 13px; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; cursor: pointer;">
                                    <option value="presented">Vorgestellt</option>
                                    <option value="applied">Beworben</option>
                                    <option value="pdl">PDL</option>
                                </select>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--pp-textDim); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;">Datum</div>
                                <input type="date" x-model="newDate" style="padding: 7px 10px; border-radius: 8px; border: 1.5px solid var(--pp-border); font-size: 13px; color: var(--pp-text); background: var(--pp-surface); font-family: inherit; outline: none; color-scheme: dark;">
                            </div>
                            <button type="button" @click="addEntry()" style="padding: 8px 16px; border-radius: 8px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; font-size: 13px; font-weight: 650; cursor: pointer; font-family: inherit; border: none;">Speichern</button>
                        </div>
                    </div>
                    {# Entries list #}
                    <template x-if="entries.length > 0">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <template x-for="(entry, idx) in entries" :key="idx">
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border);">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span :style="entry.type === 'applied' ? 'background: rgba(245,158,11,0.15); color: #fbbf24;' : entry.type === 'pdl' ? 'background: rgba(16,185,129,0.15); color: #34d399;' : 'background: rgba(99,102,241,0.15); color: #a5b4fc;'" style="font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;" x-text="entry.type === 'applied' ? 'Beworben' : entry.type === 'pdl' ? 'PDL' : 'Vorgestellt'"></span>
                                        <span style="font-size: 13.5px; font-weight: 650; color: var(--pp-text);" x-text="entry.company"></span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: var(--pp-textDim); font-weight: 500;" x-text="entry.date ? new Date(entry.date).toLocaleDateString('de-DE') : ''"></span>
                                        <button type="button" @click="removeEntry(idx)" style="background: none; border: none; cursor: pointer; color: var(--pp-textDim); font-size: 16px; padding: 0 4px; line-height: 1;" onmouseenter="this.style.color='#ef4444'" onmouseleave="this.style.color='var(--pp-textDim)'">&times;</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="entries.length === 0 && !showAddForm">
                        <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                            <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F3E2;</div>
                            <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Noch bei keinem Unternehmen vorgestellt</div>
                        </div>
                    </template>
                </div>
            </div>

            {# ── Berufserfahrung (Timeline) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 300ms;" id="experience">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BC;</span> Berufserfahrung</div>
                    <button type="button" onclick="copyWerdegang()" style="display: flex; align-items: center; gap: 6px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); border-radius: 8px; padding: 5px 12px; font-size: 11.5px; font-weight: 650; color: var(--pp-text); cursor: pointer; font-family: inherit;">&#x1F4CB; Profil kopieren</button>
                </div>
                <div class="kd-section-body">
                    {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
                        {% set work_list = candidate.work_history %}
                        {% for job in work_list %}{% if job is mapping %}
                        {% set is_first = loop.first %}
                        {% set is_last = loop.last %}
                        {# ── Dauer berechnen ── #}
                        {% set dur_text = job.duration | default('') %}
                        {% if not dur_text and job.start_date %}
                            {% set sd = job.start_date | string %}
                            {% set ed = job.end_date | default('') | string %}
                            {% set s_parts = sd.split('/') %}
                            {% if s_parts | length == 2 %}
                                {% set s_month = s_parts[0] | int %}
                                {% set s_year = s_parts[1] | int %}
                                {% if ed and ed != 'None' and ed != 'null' and ed != 'heute' and ed != 'today' %}
                                    {% set e_parts = ed.split('/') %}
                                    {% if e_parts | length == 2 %}
                                        {% set e_month = e_parts[0] | int %}
                                        {% set e_year = e_parts[1] | int %}
                                    {% else %}
                                        {% set e_month = now().month %}
                                        {% set e_year = now().year %}
                                    {% endif %}
                                {% else %}
                                    {% set e_month = now().month %}
                                    {% set e_year = now().year %}
                                {% endif %}
                                {% set total_months = (e_year - s_year) * 12 + (e_month - s_month) %}
                                {% if total_months > 0 %}
                                    {% set d_years = total_months // 12 %}
                                    {% set d_months = total_months % 12 %}
                                    {% if d_years > 0 and d_months > 0 %}
                                        {% set dur_text = d_years ~ ' J. ' ~ d_months ~ ' Mon.' %}
                                    {% elif d_years > 0 %}
                                        {% set dur_text = d_years ~ ' Jahr' ~ ('e' if d_years != 1 else '') %}
                                    {% else %}
                                        {% set dur_text = d_months ~ ' Mon.' %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        <div style="display: flex; gap: 16px; padding: 18px 0; {% if not is_last %}border-bottom: 1px solid var(--pp-surfaceHover);{% endif %}">
                            {# Timeline dot + line #}
                            <div style="display: flex; flex-direction: column; align-items: center; padding-top: 4px; flex-shrink: 0; width: 20px;">
                                <div class="{% if is_first %}kd-exp-dot-current{% else %}kd-exp-dot-past{% endif %}"></div>
                                {% if not is_last %}
                                <div class="kd-exp-line"></div>
                                {% endif %}
                            </div>
                            {# Content #}
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 6px; flex-wrap: wrap;">
                                    <div>
                                        <div style="font-size: 14.5px; font-weight: 720; color: var(--pp-text); letter-spacing: -0.01em; line-height: 1.3;">
                                            {{ job.position | default(job.title | default('Unbekannte Position')) }}
                                        </div>
                                        <div style="font-size: 13px; color: var(--pp-textMuted); margin-top: 3px; font-weight: 500;">
                                            {{ job.company | default('Unbekanntes Unternehmen') }}
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                        {% if job.start_date %}
                                        <span style="font-size: 12px; color: var(--pp-textDim); font-weight: 500; white-space: nowrap;">
                                            {{ job.start_date }}{% if job.end_date and job.end_date != 'None' %} &ndash; {{ job.end_date }}{% else %} &ndash; heute{% endif %}
                                        </span>
                                        {% endif %}
                                        {% if dur_text %}
                                        <span style="font-size: 11px; font-weight: 650; padding: 3px 10px; border-radius: 8px; background: var(--pp-surfaceHover); color: {% if is_first %}var(--pp-accent){% else %}var(--pp-textMuted){% endif %}; white-space: nowrap;">
                                            {{ dur_text }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {# Tasks/Description #}
                                {% if job.description and job.description != 'null' and job.description != 'None' %}
                                <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
                                    {% for line in job.description.split('\n') %}
                                    {% set clean_line = line.strip().lstrip('•').lstrip('-').lstrip('–').strip() %}
                                    {% if clean_line and clean_line != 'None' and clean_line != 'null' %}
                                    <div style="display: flex; gap: 8px; font-size: 13px; color: var(--pp-text); line-height: 1.55;">
                                        <span style="color: var(--pp-border); margin-top: 2px; flex-shrink: 0; font-size: 6px; line-height: 22px;">&#x25CF;</span>
                                        <span>{{ clean_line }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F4BC;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Berufserfahrung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── IT-Kenntnisse (Core/Standard Tiering) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 400ms;" id="it-skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4BB;</span> IT-Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.it_skills and candidate.it_skills | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        {% for skill in candidate.it_skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {% set sk_low = skill.lower() %}
                        {% set is_core = sk_low in ['sap', 'sap s/4hana', 'sap-sem-bcs', 'sap fi', 'sap co', 'sap mm', 'sap bcs', 'cch tagetik', 'datev', 'addison', 'oracle', 'navision', 'dynamics', 'lucanet', 'sigma', 'hyperion', 'cognos', 'jedox', 'board', 'anaplan'] or 'sap' in sk_low or 'erp' in sk_low or 'datev' in sk_low or 'tagetik' in sk_low or 'lucanet' in sk_low or 'konsolidierung' in sk_low or 'hyperion' in sk_low or 'cognos' in sk_low %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; background: var(--pp-surfaceHover); border: 1px solid {% if is_core %}var(--pp-accent){% else %}var(--pp-border){% endif %};">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% if is_core %}
                                <span style="font-size: 9px; font-weight: 700; padding: 2px 7px; border-radius: 5px; background: var(--pp-accent); color: #fff; text-transform: uppercase; letter-spacing: 0.05em;">CORE</span>
                                {% endif %}
                                <span style="font-size: 13.5px; font-weight: 680; color: var(--pp-text);">{{ skill }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F4BB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine IT-Kenntnisse hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Sprachen (Progress Bars) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 500ms;" id="languages">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F310;</span> Sprachen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.languages and candidate.languages is iterable and candidate.languages is not string and candidate.languages | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        {% for lang in candidate.languages %}{% if lang is mapping %}
                        {% set lang_name = lang.language | default('Unbekannt') %}
                        {% set lang_level = lang.level | default('') %}
                        {% set is_native = 'mutter' in lang_level.lower() if lang_level else false %}
                        {% set pct = 100 if is_native else (95 if 'flie' in lang_level.lower() else (85 if 'verhandlung' in lang_level.lower() else (70 if 'gut' in lang_level.lower() else (50 if 'grund' in lang_level.lower() else 60)))) if lang_level else 50 %}
                        <div style="display: flex; align-items: center; gap: 14px; padding: 8px 0;">
                            <div style="width: 80px; font-size: 13px; font-weight: 650; color: var(--pp-text);">{{ lang_name }}</div>
                            <div style="flex: 1;">
                                <div class="kd-lang-bar">
                                    <div class="kd-lang-fill" style="width: {{ pct }}%; background: linear-gradient(90deg, {% if is_native %}#10b981, #34d399{% else %}#6366f1, #a78bfa{% endif %});"></div>
                                </div>
                            </div>
                            {% if lang_level and lang_level != 'None' and lang_level != 'null' %}
                            <div style="font-size: 11.5px; color: var(--pp-textMuted); font-weight: 500; min-width: 180px; text-align: right;">{{ lang_level }}</div>
                            {% endif %}
                        </div>
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F310;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Sprachen hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Skills & Kenntnisse (Color Categories) ── #}
            <div class="kd-section kd-anim" style="animation-delay: 600ms;" id="skills">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F9E9;</span> Skills &amp; Kenntnisse</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.skills and candidate.skills | length > 0 %}
                    {# Legend #}
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #4f46e5;"></span> Fachlich
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #059669;"></span> Technisch
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--pp-textDim); font-weight: 500;">
                            <span style="width: 8px; height: 8px; border-radius: 3px; background: #a16207;"></span> Sonstige
                        </span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 7px;">
                        {% for skill in candidate.skills %}
                        {% if skill and skill != 'None' and skill != 'null' %}
                        {# Heuristic: tech keywords → green, fach (finance/accounting) → indigo, soft skills → amber #}
                        {% set sk_low = skill.lower() %}
                        {% set is_tech = sk_low in ['sap', 'excel', 'word', 'powerpoint', 'outlook', 'teams', 'python', 'sql', 'javascript', 'html', 'css', 'r', 'tableau', 'power bi', 'datev', 'addison'] or 'microsoft' in sk_low or 'sap' in sk_low or 'office' in sk_low or 'software' in sk_low or 'erp' in sk_low or 'it' == sk_low or 'edv' in sk_low %}
                        {% set is_soft = 'kommunikation' in sk_low or 'führung' in sk_low or 'team' in sk_low or 'management' in sk_low or 'organisation' in sk_low or 'präsentation' in sk_low or 'verhandlung' in sk_low or 'coaching' in sk_low or 'moderation' in sk_low or 'motivation' in sk_low or 'analytisch' in sk_low %}
                        <span class="{% if is_tech %}skill-tech{% elif is_soft %}skill-soft{% else %}skill-fach{% endif %}" style="font-size: 12px; font-weight: 600; padding: 5px 12px; border-radius: 8px;">{{ skill }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F9E9;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Skills hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Zertifikate & Weiterbildungen ── #}
            <div class="kd-section kd-anim" style="animation-delay: 700ms;" id="certifications">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F393;</span> Zertifikate &amp; Weiterbildungen</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.further_education and candidate.further_education is iterable and candidate.further_education is not string and candidate.further_education | length > 0 %}
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        {% for wb in candidate.further_education %}{% if wb is mapping %}
                        {% set wb_name = wb.degree if (wb.degree and wb.degree != 'None' and wb.degree != 'null') else (wb.qualification if (wb.qualification and wb.qualification != 'None' and wb.qualification != 'null') else '') %}
                        {% set wb_inst = wb.institution | default('') %}
                        {% if wb_inst == 'None' or wb_inst == 'null' %}{% set wb_inst = '' %}{% endif %}
                        {% set wb_start = wb.start_date | default('') %}
                        {% if wb_start == 'None' or wb_start == 'null' %}{% set wb_start = '' %}{% endif %}
                        {% set wb_end = wb.end_date | default('') %}
                        {% if wb_end == 'None' or wb_end == 'null' %}{% set wb_end = '' %}{% endif %}
                        {% set wb_year = wb.year | default('') %}
                        {% if wb_year == 'None' or wb_year == 'null' %}{% set wb_year = '' %}{% endif %}
                        {% if wb_start and wb_end %}
                            {% set wb_timerange = wb_start ~ ' – ' ~ wb_end %}
                        {% elif wb_start %}
                            {% set wb_timerange = 'ab ' ~ wb_start %}
                        {% elif wb_end %}
                            {% set wb_timerange = wb_end %}
                        {% elif wb_year %}
                            {% set wb_timerange = wb_year %}
                        {% else %}
                            {% set wb_timerange = '' %}
                        {% endif %}
                        {# Generische Einträge ohne Details dezenter darstellen #}
                        {% set is_generic = wb_name.lower() in ['seminar', 'e-learning', 'kurs', 'workshop', 'webinar', 'schulung', 'weiterbildung', ''] and not wb_inst %}
                        {% if wb_name %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border); {% if is_generic %}opacity: 0.7;{% endif %}">
                            <div>
                                <div style="font-size: 13.5px; font-weight: {% if is_generic %}550{% else %}650{% endif %}; color: {% if is_generic %}var(--pp-textMuted){% else %}var(--pp-text){% endif %};">
                                    {{ wb_name }}{% if is_generic and not wb_inst %} <span style="font-size: 11px; color: var(--pp-textDim); font-weight: 400; font-style: italic;">(ohne Details)</span>{% endif %}
                                </div>
                                {% if wb_inst %}
                                <div style="font-size: 12px; color: var(--pp-textDim); margin-top: 2px; font-weight: 500;">{{ wb_inst }}</div>
                                {% endif %}
                            </div>
                            {% if wb_timerange %}
                            <span style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600; background: var(--pp-surfaceHover); padding: 3px 10px; border-radius: 6px; white-space: nowrap;">{{ wb_timerange }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}{% endfor %}
                    </div>
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F393;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Zertifikate hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# ── Ausbildung ── #}
            <div class="kd-section kd-anim" style="animation-delay: 800ms;" id="education">
                <div class="kd-section-header">
                    <div class="kd-section-title"><span>&#x1F4DA;</span> Ausbildung</div>
                </div>
                <div class="kd-section-body">
                    {% if candidate.education and candidate.education is iterable and candidate.education is not string and candidate.education | length > 0 %}
                    {% for edu in candidate.education %}{% if edu is mapping %}
                    {% set edu_name = edu.degree if (edu.degree and edu.degree != 'None' and edu.degree != 'null') else (edu.qualification if (edu.qualification and edu.qualification != 'None' and edu.qualification != 'null') else 'Ausbildung') %}
                    {% set edu_inst = edu.institution | default(edu.school | default('')) %}
                    {% set edu_start = edu.start_date | default('') %}
                    {% if edu_start == 'None' or edu_start == 'null' %}{% set edu_start = '' %}{% endif %}
                    {% set edu_end = edu.end_date | default('') %}
                    {% if edu_end == 'None' or edu_end == 'null' %}{% set edu_end = '' %}{% endif %}
                    {% set edu_year = edu.year | default('') %}
                    {% if edu_year == 'None' or edu_year == 'null' %}{% set edu_year = '' %}{% endif %}
                    {% if edu_start and edu_end %}
                        {% set edu_timerange = edu_start ~ ' – ' ~ edu_end %}
                    {% elif edu_start %}
                        {% set edu_timerange = 'ab ' ~ edu_start %}
                    {% elif edu_end %}
                        {% set edu_timerange = edu_end %}
                    {% elif edu_year %}
                        {% set edu_timerange = edu_year %}
                    {% else %}
                        {% set edu_timerange = '' %}
                    {% endif %}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 10px; background: var(--pp-surfaceHover); border: 1px solid var(--pp-border);">
                        <div>
                            <div style="font-size: 14px; font-weight: 680; color: var(--pp-text);">{{ edu_name }}</div>
                            {% if edu_inst and edu_inst != 'None' and edu_inst != 'null' %}
                            <div style="font-size: 12.5px; color: var(--pp-textMuted); margin-top: 2px; font-weight: 500;">{{ edu_inst }}</div>
                            {% endif %}
                        </div>
                        {% if edu_timerange %}
                        <span style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600; background: var(--pp-surfaceHover); padding: 3px 10px; border-radius: 6px; white-space: nowrap;">{{ edu_timerange }}</span>
                        {% endif %}
                    </div>
                    {% endif %}{% endfor %}
                    {% else %}
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 0;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.4;">&#x1F4DA;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim);">Keine Ausbildung hinterlegt</div>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

        {# ── RIGHT SIDEBAR (sticky) ── #}
        <div style="width: 280px; flex-shrink: 0; display: flex; flex-direction: column; gap: 16px; position: sticky; top: 20px; align-self: flex-start;">

            {# Navigation #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 150ms;">
                <div class="kd-sidebar-header">Navigation</div>
                <div class="kd-sidebar-body" style="display: flex; flex-direction: column; gap: 2px;">
                    {% set nav_items = [
                        {"id": "recruiting-data", "icon": "&#x1F50D;", "label": "Recruiting-Daten"},
                        {"id": "experience", "icon": "&#x1F4BC;", "label": "Berufserfahrung"},
                        {"id": "it-skills", "icon": "&#x1F4BB;", "label": "IT-Kenntnisse"},
                        {"id": "languages", "icon": "&#x1F310;", "label": "Sprachen"},
                        {"id": "skills", "icon": "&#x1F9E9;", "label": "Skills"},
                        {"id": "certifications", "icon": "&#x1F393;", "label": "Zertifikate"},
                        {"id": "education", "icon": "&#x1F4DA;", "label": "Ausbildung"}
                    ] %}
                    {% for nav in nav_items %}
                    <button type="button"
                            @click="activeSection = '{{ nav.id }}'; document.getElementById('{{ nav.id }}')?.scrollIntoView({behavior: 'smooth', block: 'start'})"
                            class="kd-nav-btn" :class="activeSection === '{{ nav.id }}' ? 'active' : ''">
                        <span style="font-size: 13px;">{{ nav.icon | safe }}</span>
                        {{ nav.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            {# Pipeline-Status #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 250ms;">
                <div class="kd-sidebar-header">
                    Pipeline-Status
                    <a href="/ats/pipeline" style="font-size: 11px; font-weight: 600; color: var(--pp-accent); text-decoration: none;">Pipeline &rarr;</a>
                </div>
                <div id="candidate-pipeline" hx-get="/partials/candidate-pipeline/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 12px 0;">
                        <div style="font-size: 28px; margin-bottom: 6px; opacity: 0.5;">&#x1F4CB;</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--pp-textDim); text-align: center;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# Passende Jobs #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 350ms;">
                <div class="kd-sidebar-header">Passende Jobs</div>
                <div id="matching-jobs" hx-get="/partials/candidate-jobs/{{ candidate.id }}" hx-trigger="load" hx-swap="innerHTML" class="kd-sidebar-body">
                    <div style="display: flex; flex-direction: column; align-items: center; padding: 8px 0;">
                        <div style="font-size: 12px; color: var(--pp-textDim); text-align: center; font-weight: 500;">L&auml;dt...</div>
                    </div>
                </div>
            </div>

            {# CV-Status + Upload #}
            <div class="kd-sidebar-card kd-anim-side" style="animation-delay: 450ms;"
                 x-data="{ cvUploading: false, cvDragging: false }">
                <div class="kd-sidebar-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 15px; height: 15px; color: var(--pp-accent);" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        CV-Status
                    </div>
                    {% if candidate.cv_url or candidate.cv_stored_path %}
                    <span style="font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 6px; background: rgba(5,150,105,0.15); color: #34d399; text-transform: uppercase; letter-spacing: 0.05em;">Vorhanden</span>
                    {% else %}
                    <span style="font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 6px; background: rgba(220,38,38,0.15); color: #fca5a5; text-transform: uppercase; letter-spacing: 0.05em;">Fehlt</span>
                    {% endif %}
                </div>
                <div class="kd-sidebar-body" style="padding: 14px 18px;">
                    {% if candidate.cv_parsed_at %}
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding: 8px 12px; border-radius: 8px; background: var(--pp-bg); border: 1px solid var(--pp-border);">
                        <svg style="width: 14px; height: 14px; color: var(--pp-textDim); flex-shrink: 0;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span style="font-size: 11.5px; color: var(--pp-textDim); font-weight: 500;">Geparst:</span>
                        <span style="font-size: 11.5px; font-weight: 650; color: var(--pp-text);">{{ candidate.cv_parsed_at.strftime('%d.%m.%Y %H:%M') }}</span>
                    </div>
                    {% endif %}

                    {# Drag-Drop Upload Zone #}
                    <div style="border: 2px dashed; border-radius: 10px; padding: 18px 14px; text-align: center; transition: all 0.2s ease; cursor: pointer;"
                         :style="cvUploading ? 'opacity: 0.5; pointer-events: none; border-color: var(--pp-border);' : cvDragging ? 'border-color: var(--pp-accent); background: rgba(99,102,241,0.06);' : 'border-color: var(--pp-border); background: var(--pp-bg);'"
                         @dragover.prevent="cvDragging = true"
                         @dragenter.prevent="cvDragging = true"
                         @dragleave.prevent="cvDragging = false"
                         @drop.prevent="cvDragging = false; if ($event.dataTransfer.files.length) { let f = $event.dataTransfer.files[0]; if (f.name.toLowerCase().endsWith('.pdf')) { cvUploading = true; let fd = new FormData(); fd.append('file', f); fetch('/api/candidates/{{ candidate.id }}/upload-cv', { method: 'POST', body: fd }).then(r => r.json()).then(d => { cvUploading = false; if (d.success) { showToast('CV hochgeladen — wird verarbeitet...', 'success'); setTimeout(() => location.reload(), 3000); } else { showToast(d.message || 'Upload fehlgeschlagen', 'error'); } }).catch(() => { cvUploading = false; showToast('Upload fehlgeschlagen', 'error'); }); } else { showToast('Nur PDF-Dateien erlaubt', 'warning'); } }"
                         @click="$refs.cvFileInput.click()">
                        <input type="file" accept=".pdf" class="hidden" x-ref="cvFileInput"
                               @change="if ($event.target.files.length) { let f = $event.target.files[0]; if (!f.name.toLowerCase().endsWith('.pdf')) { showToast('Nur PDF-Dateien erlaubt', 'warning'); return; } cvUploading = true; let fd = new FormData(); fd.append('file', f); fetch('/api/candidates/{{ candidate.id }}/upload-cv', { method: 'POST', body: fd }).then(r => r.json()).then(d => { cvUploading = false; if (d.success) { showToast('CV hochgeladen — wird verarbeitet...', 'success'); setTimeout(() => location.reload(), 3000); } else { showToast(d.message || 'Upload fehlgeschlagen', 'error'); } }).catch(() => { cvUploading = false; showToast('Upload fehlgeschlagen', 'error'); }); $event.target.value = ''; }">
                        <svg x-show="!cvUploading" style="width: 28px; height: 28px; color: var(--pp-textDim); margin: 0 auto 6px;" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                        <p x-show="!cvUploading && !cvDragging" style="font-size: 12px; color: var(--pp-textMuted); font-weight: 600; margin: 0;">PDF hochladen</p>
                        <p x-show="cvDragging" x-cloak style="font-size: 12px; color: var(--pp-accent); font-weight: 600; margin: 0;">Hier ablegen</p>
                        <p x-show="cvUploading" x-cloak style="font-size: 12px; color: var(--pp-accent); font-weight: 600; margin: 0;">Wird hochgeladen...</p>
                        <p x-show="!cvUploading" style="font-size: 10px; color: var(--pp-textDim); margin: 4px 0 0 0; font-weight: 500;">Parsing + Geocoding + Kategorisierung</p>
                    </div>

                    {% if candidate.cv_url or candidate.cv_stored_path %}
                    <button type="button" hx-post="/api/candidates/{{ candidate.id }}/reparse-cv" hx-swap="none" hx-on::after-request="showToast('CV wird neu geparst...', 'info'); setTimeout(() => location.reload(), 3000)" style="width: 100%; margin-top: 10px; padding: 9px 0; border-radius: 8px; background: var(--pp-surfaceHover); border: 1.5px solid var(--pp-border); color: var(--pp-text); font-size: 12px; font-weight: 650; cursor: pointer; font-family: inherit; transition: all 0.15s;" onmouseenter="this.style.borderColor='var(--pp-accent)';this.style.color='var(--pp-accent)'" onmouseleave="this.style.borderColor='var(--pp-border)';this.style.color='var(--pp-text)'">CV neu parsen</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# CV-Vorschau Slide-Over Panel #}
{% if candidate.cv_url or candidate.cv_stored_path %}
<div id="cv-preview-overlay" class="hidden relative z-50">
    <div class="cv-overlay-bg fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity duration-300 ease-in-out opacity-0" onclick="closeCvPreview()"></div>
    <div class="fixed inset-0 overflow-hidden">
        <div class="absolute inset-0 overflow-hidden">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
                <div id="cv-preview-panel" class="pointer-events-auto w-screen max-w-2xl transform transition-transform duration-300 ease-in-out translate-x-full">
                    <div class="flex h-full flex-col shadow-xl" style="font-family: 'Outfit', sans-serif; background: var(--pp-surface);">
                        <div class="flex items-center justify-between px-6 py-4" style="background: var(--pp-surfaceHover); border-bottom: 1px solid var(--pp-border);">
                            <div>
                                <h2 class="text-lg font-bold" style="color: var(--pp-text);">CV-Vorschau</h2>
                                <p class="text-sm" style="color: var(--pp-textDim);">{{ display_name }}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <a href="/api/candidates/{{ candidate.id }}/cv-preview" target="_blank" class="kd-quickbtn" style="font-size: 11.5px; padding: 7px 12px;">&#x2197; Neuer Tab</a>
                                <button type="button" onclick="closeCvPreview()" style="background: var(--pp-surfaceHover); border: none; border-radius: 8px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--pp-textMuted); font-size: 16px;">&#x2715;</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-hidden relative">
                            <iframe id="cv-preview-iframe" src="" class="w-full h-full border-0" title="CV-Vorschau"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// ==================== Recruiting-Daten (Phase 2) ====================
function recruitingFields() {
    return {
        currentSource: {{ (candidate.source or '') | tojson | safe }} || '',
        currentWillingness: {{ (candidate.willingness_to_change or '') | tojson | safe }} || '',
        lastContactDate: {{ (candidate.last_contact.strftime('%Y-%m-%d') if candidate.last_contact else '') | tojson | safe }},
        notesText: {{ (candidate.candidate_notes or '') | tojson | safe }},
        notesSaved: true,
        showSourceDropdown: false,
        sourceOptions: ['StepStone', 'Xing', 'LinkedIn', 'Indeed', 'Empfehlung', 'CRM', 'Direktansprache', 'Jobboerse', 'Sonstiges'],

        async setSource(src) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: src })
                });
                if (response.ok) {
                    this.currentSource = src;
                    this.showSourceDropdown = false;
                    if (typeof showToast === 'function') showToast('Quelle gespeichert', 'success');
                }
            } catch (err) { console.error('Quelle speichern fehlgeschlagen:', err); }
        },

        async setWillingness(val) {
            var candidateId = '{{ candidate.id }}';
            var newVal = this.currentWillingness === val ? null : val;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ willingness_to_change: newVal })
                });
                if (response.ok) {
                    this.currentWillingness = newVal || '';
                    if (typeof showToast === 'function') showToast('Wechselbereitschaft gespeichert', 'success');
                }
            } catch (err) { console.error('Wechselbereitschaft speichern fehlgeschlagen:', err); }
        },

        async setLastContact() {
            var candidateId = '{{ candidate.id }}';
            var dateVal = this.lastContactDate ? new Date(this.lastContactDate).toISOString() : null;
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ last_contact: dateVal })
                });
                if (response.ok) {
                    if (typeof showToast === 'function') showToast('Letzter Kontakt gespeichert', 'success');
                }
            } catch (err) { console.error('Letzter Kontakt speichern fehlgeschlagen:', err); }
        },

        async setLastContactNow() {
            var today = new Date();
            this.lastContactDate = today.toISOString().split('T')[0];
            await this.setLastContact();
        },

        async saveNotes() {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidate_notes: this.notesText || null })
                });
                if (response.ok) {
                    this.notesSaved = true;
                    if (typeof showToast === 'function') showToast('Notizen gespeichert', 'success');
                }
            } catch (err) { console.error('Notizen speichern fehlgeschlagen:', err); }
        }
    };
}

// ==================== Pipeline-Daten (ERP + Rating) ====================
function pipelineFields() {
    return {
        newErp: '',
        currentRating: {{ candidate.rating or 0 }},
        currentErp: {{ (candidate.erp or []) | tojson | safe }},

        async addErp() {
            var val = this.newErp.trim();
            if (!val) return;
            var items = val.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
            var merged = this.currentErp.concat(items);
            merged = merged.filter(function(v, i, a) { return a.indexOf(v) === i; });
            await this.saveErp(merged);
            this.newErp = '';
        },

        async removeErp(item) {
            var filtered = this.currentErp.filter(function(e) { return e !== item; });
            await this.saveErp(filtered);
        },

        async saveErp(erpList) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ erp: erpList })
                });
                if (response.ok) {
                    this.currentErp = erpList;
                    if (typeof showToast === 'function') showToast('ERP gespeichert', 'success');
                    setTimeout(function() { location.reload(); }, 500);
                }
            } catch (err) { console.error('ERP speichern fehlgeschlagen:', err); }
        },

        async setRating(value) {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: value })
                });
                if (response.ok) {
                    this.currentRating = value;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = i <= value ? '#f59e0b' : '#2A2D3A'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung gespeichert', 'success');
                }
            } catch (err) { console.error('Rating speichern fehlgeschlagen:', err); }
        },

        async clearRating() {
            var candidateId = '{{ candidate.id }}';
            try {
                var response = await fetch('/api/candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: null })
                });
                if (response.ok) {
                    this.currentRating = 0;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.getElementById('star-' + i);
                        if (star) { star.style.color = '#2A2D3A'; }
                    }
                    if (typeof showToast === 'function') showToast('Bewertung entfernt', 'success');
                }
            } catch (err) { console.error('Rating entfernen fehlgeschlagen:', err); }
        }
    };
}

// Global removeErp for Jinja-rendered buttons
function removeErp(item) {
    var comp = document.querySelector('[x-data="pipelineFields()"]');
    if (comp) {
        var data = Alpine.$data(comp);
        if (data) data.removeErp(item);
    }
}

function deleteCandidate(candidateId, candidateName) {
    if (!confirm('Kandidat ' + candidateName + ' wirklich l\u00f6schen?')) return;
    fetch('/api/candidates/' + candidateId, { method: 'DELETE' })
    .then(function(r) { return r.json(); })
    .then(function(d) { if (d.success) window.location.href = '/kandidaten'; });
}

// ==================== Kopieren ====================
function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(function() {
        if (typeof showToast === 'function') showToast(label + ' kopiert', 'success');
    }).catch(function() {
        var ta = document.createElement('textarea');
        ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        if (typeof showToast === 'function') showToast(label + ' kopiert', 'success');
    });
}

// ==================== Profil kopieren ====================
var _werdegangData = {{ (candidate.work_history or []) | tojson | safe }};
var _itSkillsData = {{ (candidate.it_skills or []) | tojson | safe }};
var _languagesData = {{ (candidate.languages or []) | tojson | safe }};
var _furtherEducationData = {{ (candidate.further_education or []) | tojson | safe }};
var _educationData = {{ (candidate.education or []) | tojson | safe }};
var _skillsData = {{ (candidate.skills or []) | tojson | safe }};
{% set _sn_inv = ['not available','n/a','na','none','null','-','—',''] %}
{% set _sn_f = candidate.first_name or '' %}
{% set _sn_l = candidate.last_name or '' %}
{% set _sn_fv = _sn_f if _sn_f|lower|trim not in _sn_inv else '' %}
{% set _sn_lv = _sn_l if _sn_l|lower|trim not in _sn_inv else '' %}
{% set _sn_fd = (_sn_fv|title) if (_sn_fv == _sn_fv|upper and _sn_fv|length > 1) else _sn_fv %}
{% set _sn_ld = (_sn_lv|title) if (_sn_lv == _sn_lv|upper and _sn_lv|length > 1) else _sn_lv %}
{% set _sn_name = ((_sn_fd ~ ' ' ~ _sn_ld)|trim) if (_sn_fd or _sn_ld) else 'Unbekannt' %}
var _candidateName = {{ _sn_name | tojson | safe }};

function buildFullProfileText(name, workHistory, itSkills, languages, furtherEdu, education, skills) {
    var lines = []; var hasContent = false;
    if (workHistory && workHistory.length > 0) {
        hasContent = true; lines.push('--- BERUFSERFAHRUNG ---'); lines.push('');
        for (var i = 0; i < workHistory.length; i++) {
            var job = workHistory[i];
            if (!job || typeof job !== 'object') continue;
            var dateRange = '';
            if (job.start_date) { dateRange = job.start_date; dateRange += job.end_date ? ' - ' + job.end_date : ' - heute'; }
            if (dateRange) lines.push(dateRange);
            lines.push(job.position || job.title || 'Unbekannte Position');
            lines.push(job.company || 'Unbekanntes Unternehmen');
            if (job.description) lines.push(job.description);
            lines.push('');
        }
    }
    if (itSkills && itSkills.length > 0) { hasContent = true; lines.push('--- IT-KENNTNISSE ---'); lines.push(itSkills.join(', ')); lines.push(''); }
    if (languages && languages.length > 0) {
        hasContent = true; lines.push('--- SPRACHEN ---');
        for (var i = 0; i < languages.length; i++) {
            var lang = languages[i];
            if (!lang || typeof lang !== 'object') continue;
            var langLine = lang.language || 'Unbekannt';
            if (lang.level) langLine += ' (' + lang.level + ')';
            lines.push(langLine);
        }
        lines.push('');
    }
    if (furtherEdu && furtherEdu.length > 0) {
        hasContent = true; lines.push('--- ZERTIFIKATE & WEITERBILDUNGEN ---');
        for (var i = 0; i < furtherEdu.length; i++) {
            var wb = furtherEdu[i]; if (!wb || typeof wb !== 'object') continue;
            var wbLine = wb.degree || wb.qualification || 'Weiterbildung';
            if (wb.institution) wbLine += ' | ' + wb.institution;
            if (wb.year || wb.end_date) wbLine += ' | ' + (wb.year || wb.end_date);
            lines.push(wbLine);
        }
        lines.push('');
    }
    if (education && education.length > 0) {
        hasContent = true; lines.push('--- AUSBILDUNG ---');
        for (var i = 0; i < education.length; i++) {
            var edu = education[i]; if (!edu || typeof edu !== 'object') continue;
            var eduLine = edu.degree || edu.qualification || 'Ausbildung';
            if (edu.institution || edu.school) eduLine += ' | ' + (edu.institution || edu.school);
            if (edu.year || edu.end_date) eduLine += ' | ' + (edu.year || edu.end_date);
            lines.push(eduLine);
        }
        lines.push('');
    }
    if (skills && skills.length > 0) { hasContent = true; lines.push('--- SKILLS & KENNTNISSE ---'); lines.push(skills.join(', ')); lines.push(''); }
    if (!hasContent) return null;
    return lines.join('\n').trim();
}

function copyWerdegang() {
    var text = buildFullProfileText(_candidateName, _werdegangData, _itSkillsData, _languagesData, _furtherEducationData, _educationData, _skillsData);
    if (!text) { if (typeof showToast === 'function') showToast('Kein Profil vorhanden', 'warning'); return; }
    copyToClipboard(text, 'Profil');
}

// ==================== Inline Edit ====================
function startDetailEdit(displayEl) {
    var wrapper = displayEl.closest('.detail-edit-wrapper');
    var input = wrapper.querySelector('.detail-edit-input');
    displayEl.classList.add('hidden');
    input.classList.remove('hidden');
    input.focus(); input.select();
}

function handleDetailEditKey(event, input) {
    if (event.key === 'Enter') { input.blur(); }
    else if (event.key === 'Escape') {
        var wrapper = input.closest('.detail-edit-wrapper');
        var display = wrapper.querySelector('.detail-edit-display');
        input.classList.add('hidden'); display.classList.remove('hidden');
    }
}

function saveDetailEdit(input) {
    var wrapper = input.closest('.detail-edit-wrapper');
    var display = wrapper.querySelector('.detail-edit-display');
    var candidateId = wrapper.dataset.candidateId;
    var field = wrapper.dataset.field;
    var newValue = input.value.trim();
    var oldText = display.textContent.trim();
    var placeholders = ['Keine Position angegeben', 'Kein Unternehmen', 'Vorname', 'Nachname', 'Nicht angegeben'];
    if (placeholders.indexOf(oldText) !== -1) oldText = '';
    if (newValue === oldText) { input.classList.add('hidden'); display.classList.remove('hidden'); return; }
    var body = {}; body[field] = newValue || null;
    fetch('/api/candidates/' + candidateId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.id) {
            var fallbackTexts = { 'current_position': 'Keine Position angegeben', 'current_company': 'Kein Unternehmen', 'first_name': 'Vorname', 'last_name': 'Nachname', 'salary': 'Nicht angegeben', 'notice_period': 'Nicht angegeben', 'source': 'Nicht angegeben', 'candidate_notes': '' };
            display.textContent = newValue || fallbackTexts[field] || '\u2014';
            if (typeof showToast === 'function') showToast('Gespeichert', 'success');
        }
    })
    .catch(function() { input.value = oldText; })
    .finally(function() { input.classList.add('hidden'); display.classList.remove('hidden'); });
}

// ==================== CV-Vorschau ====================
function openCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');
    iframe.src = '/api/candidates/{{ candidate.id }}/cv-preview';
    overlay.classList.remove('hidden');
    requestAnimationFrame(function() {
        overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-0');
        overlay.querySelector('.cv-overlay-bg').classList.add('opacity-100');
        panel.classList.remove('translate-x-full'); panel.classList.add('translate-x-0');
    });
    document.body.style.overflow = 'hidden';
}

function closeCvPreview() {
    var overlay = document.getElementById('cv-preview-overlay');
    var panel = document.getElementById('cv-preview-panel');
    var iframe = document.getElementById('cv-preview-iframe');
    panel.classList.remove('translate-x-0'); panel.classList.add('translate-x-full');
    overlay.querySelector('.cv-overlay-bg').classList.remove('opacity-100');
    overlay.querySelector('.cv-overlay-bg').classList.add('opacity-0');
    setTimeout(function() { overlay.classList.add('hidden'); iframe.src = ''; }, 300);
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var overlay = document.getElementById('cv-preview-overlay');
        if (overlay && !overlay.classList.contains('hidden')) closeCvPreview();
    }
});
</script>
{% endblock %}
