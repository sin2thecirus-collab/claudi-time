{% extends "base.html" %}

{% block title %}{{ candidate.full_name or (candidate.first_name ~ ' ' ~ candidate.last_name) }} - Matching-Tool{% endblock %}

{% block content %}
<div class="space-y-6">
    {# Zurueck-Navigation #}
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li>
                <a href="/" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
                    </svg>
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="h-5 w-5 flex-shrink-0 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                    </svg>
                    <span class="ml-2 text-sm font-medium text-gray-500">Kandidaten-Details</span>
                </div>
            </li>
        </ol>
    </nav>

    {# Kandidaten Header #}
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-4">
                    {# Avatar #}
                    <div class="flex-shrink-0">
                        <span class="inline-flex h-14 w-14 items-center justify-center rounded-full bg-primary-100">
                            <span class="text-xl font-medium text-primary-700">
                                {{ (candidate.first_name or 'X')[0] | upper }}{{ (candidate.last_name or 'X')[0] | upper }}
                            </span>
                        </span>
                    </div>

                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">
                            {{ candidate.full_name or (candidate.first_name ~ ' ' ~ candidate.last_name) | default('Unbekannt') }}
                        </h1>
                        <p class="text-lg text-gray-500">
                            {{ candidate.current_position | default('Keine Position angegeben') }}
                        </p>
                        <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-500">
                            {% if candidate.city %}
                            <span class="flex items-center">
                                <svg class="h-4 w-4 mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                                </svg>
                                {{ candidate.city }}{% if candidate.postal_code %}, {{ candidate.postal_code }}{% endif %}
                            </span>
                            {% endif %}

                            <span class="flex items-center text-gray-400">
                                <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                </svg>
                                Im System seit {{ candidate.created_at.strftime('%d.%m.%Y') if candidate.created_at else 'Unbekannt' }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    {% if candidate.crm_id %}
                    <a href="https://app.recruitcrm.io/candidate/{{ candidate.crm_id }}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                        </svg>
                        Im CRM oeffnen
                    </a>
                    {% endif %}

                    {% if candidate.cv_url %}
                    <a href="{{ candidate.cv_url }}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        CV herunterladen
                    </a>
                    {% endif %}

                    {% if not candidate.hidden %}
                    <button type="button"
                            hx-put="/api/candidates/{{ candidate.id }}/hide"
                            hx-swap="none"
                            hx-on::after-request="showToast('Kandidat ausgeblendet', 'success')"
                            class="inline-flex items-center rounded-md bg-gray-50 px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100">
                        <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                        Ausblenden
                    </button>
                    {% else %}
                    <button type="button"
                            hx-put="/api/candidates/{{ candidate.id }}/unhide"
                            hx-swap="none"
                            hx-on::after-request="showToast('Kandidat wieder eingeblendet', 'success')"
                            class="inline-flex items-center rounded-md bg-green-50 px-3 py-2 text-sm font-semibold text-green-700 hover:bg-green-100">
                        <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Wieder einblenden
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="lg:grid lg:grid-cols-3 lg:gap-6">
        {# Hauptbereich (2/3) #}
        <div class="lg:col-span-2 space-y-6">
            {# Kontakt #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Kontaktdaten</h3>
                </div>
                <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
                    <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        {% if candidate.email %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">E-Mail</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="mailto:{{ candidate.email }}" class="text-primary-600 hover:text-primary-500">
                                    {{ candidate.email }}
                                </a>
                            </dd>
                        </div>
                        {% endif %}

                        {% if candidate.phone %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Telefon</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="tel:{{ candidate.phone }}" class="text-primary-600 hover:text-primary-500">
                                    {{ candidate.phone }}
                                </a>
                            </dd>
                        </div>
                        {% endif %}

                        {% if candidate.street_address or candidate.postal_code or candidate.city %}
                        <div class="sm:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">Adresse</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if candidate.street_address %}{{ candidate.street_address }}{% endif %}{% if candidate.postal_code or candidate.city %}{% if candidate.street_address %}, {% endif %}{{ candidate.postal_code }} {{ candidate.city }}{% endif %}
                            </dd>
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </div>

            {# IT-Kenntnisse #}
            {% if candidate.it_skills and candidate.it_skills | length > 0 %}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">IT-Kenntnisse</h3>
                </div>
                <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
                    <div class="flex flex-wrap gap-2">
                        {% for skill in candidate.it_skills %}
                        <span class="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-sm font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">
                            {{ skill }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {# Sprachkenntnisse #}
            {% if candidate.languages and candidate.languages is iterable and candidate.languages is not string and candidate.languages | length > 0 %}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Sprachen</h3>
                </div>
                <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
                    <div class="space-y-2">
                        {% for lang in candidate.languages %}
                        {% if lang is mapping %}
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-medium text-gray-900">{{ lang.language | default('Unbekannt') }}</span>
                            {% if lang.level %}
                            <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-0.5 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-700/10">
                                {{ lang.level }}
                            </span>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {# Skills & Kenntnisse (sonstige) #}
            {% if candidate.skills and candidate.skills | length > 0 %}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Skills & Kenntnisse</h3>
                </div>
                <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
                    <div class="flex flex-wrap gap-2">
                        {% for skill in candidate.skills %}
                        <span class="inline-flex items-center rounded-full bg-primary-50 px-3 py-1 text-sm font-medium text-primary-700 ring-1 ring-inset ring-primary-700/10">
                            {{ skill }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {# Berufserfahrung #}
            {% if candidate.work_history and candidate.work_history is iterable and candidate.work_history is not string and candidate.work_history | length > 0 %}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Berufserfahrung</h3>
                </div>
                <div class="border-t border-gray-200">
                    <ul class="divide-y divide-gray-200">
                        {% for job in candidate.work_history %}
                        {% if job is mapping %}
                        <li class="px-4 py-4 sm:px-6">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ job.position | default(job.title | default('Unbekannte Position')) }}</p>
                                    <p class="text-sm text-gray-500">{{ job.company | default('Unbekanntes Unternehmen') }}</p>
                                </div>
                                <div class="text-sm text-gray-400 text-right">
                                    {% if job.start_date %}{{ job.start_date }}{% endif %}
                                    {% if job.end_date %} - {{ job.end_date }}{% elif job.start_date %} - heute{% endif %}
                                </div>
                            </div>
                            {% if job.description and job.description != 'null' %}
                            <p class="mt-2 text-sm text-gray-600">{{ job.description }}</p>
                            {% endif %}
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {# Ausbildung #}
            {% if candidate.education and candidate.education is iterable and candidate.education is not string and candidate.education | length > 0 %}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Ausbildung</h3>
                </div>
                <div class="border-t border-gray-200">
                    <ul class="divide-y divide-gray-200">
                        {% for edu in candidate.education %}
                        {% if edu is mapping %}
                        <li class="px-4 py-4 sm:px-6">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ edu.degree | default(edu.qualification | default('Unbekannter Abschluss')) }}</p>
                                    <p class="text-sm text-gray-500">{{ edu.institution | default(edu.school | default('Unbekannte Institution')) }}</p>
                                </div>
                                <div class="text-sm text-gray-400 text-right">
                                    {% if edu.year %}{{ edu.year }}{% elif edu.end_date %}{{ edu.end_date }}{% endif %}
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {# Weiterbildungen #}
            {% if candidate.further_education and candidate.further_education is iterable and candidate.further_education is not string and candidate.further_education | length > 0 %}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Weiterbildungen</h3>
                </div>
                <div class="border-t border-gray-200">
                    <ul class="divide-y divide-gray-200">
                        {% for wb in candidate.further_education %}
                        {% if wb is mapping %}
                        <li class="px-4 py-4 sm:px-6">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ wb.degree | default(wb.qualification | default('Weiterbildung')) }}</p>
                                    <p class="text-sm text-gray-500">{{ wb.institution | default('Unbekannter Anbieter') }}</p>
                                </div>
                                <div class="text-sm text-gray-400 text-right">
                                    {% if wb.year %}{{ wb.year }}{% elif wb.end_date %}{{ wb.end_date }}{% endif %}
                                </div>
                            </div>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>

        {# Seitenleiste (1/3) #}
        <div class="mt-6 lg:mt-0 space-y-6">
            {# Passende Jobs #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Passende Jobs</h3>
                </div>
                <div id="matching-jobs"
                     hx-get="/partials/candidate-jobs/{{ candidate.id }}"
                     hx-trigger="load"
                     hx-swap="innerHTML"
                     class="border-t border-gray-200">
                    <div class="p-4">
                        {% include 'components/loading_spinner.html' %}
                    </div>
                </div>
            </div>

            {# CV-Status #}
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-base font-semibold leading-6 text-gray-900">CV-Status</h3>
                </div>
                <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
                    <dl class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">CV vorhanden:</dt>
                            <dd class="font-medium {% if candidate.cv_url %}text-green-600{% else %}text-gray-400{% endif %}">
                                {% if candidate.cv_url %}Ja{% else %}Nein{% endif %}
                            </dd>
                        </div>
                        {% if candidate.cv_parsed_at %}
                        <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Zuletzt geparst:</dt>
                            <dd class="font-medium text-gray-900">
                                {{ candidate.cv_parsed_at.strftime('%d.%m.%Y %H:%M') }}
                            </dd>
                        </div>
                        {% endif %}
                        {% if candidate.crm_synced_at %}
                        <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Letzter CRM-Sync:</dt>
                            <dd class="font-medium text-gray-900">
                                {{ candidate.crm_synced_at.strftime('%d.%m.%Y %H:%M') }}
                            </dd>
                        </div>
                        {% endif %}
                    </dl>

                    {% if candidate.cv_url %}
                    <div class="mt-4">
                        <button type="button"
                                hx-post="/api/candidates/{{ candidate.id }}/parse-cv"
                                hx-swap="none"
                                hx-on::after-request="showToast('CV wird neu geparst...', 'info'); setTimeout(() => location.reload(), 3000)"
                                class="w-full inline-flex justify-center items-center rounded-md bg-gray-50 px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100">
                            <svg class="h-4 w-4 mr-1.5 htmx-indicator animate-spin" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            CV neu parsen
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
