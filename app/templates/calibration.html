{% extends "base.html" %}

{% block title %}Kalibrierung - Pulspoint{% endblock %}

{% block content %}
<div x-data="calibrationPage()">

    {# ── Header ── #}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">KI-Kalibrierung</h1>
            <p class="text-sm text-gray-500 mt-1">Lernt aus DeepMatch-Ergebnissen und verbessert das Pre-Scoring automatisch</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="/pre-match?category={{ category }}"
               class="inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                </svg>
                Zurueck zu Pre-Match
            </a>
            <button @click="runCalibration()"
                    :disabled="calibrating"
                    class="inline-flex items-center gap-2 rounded-lg bg-purple-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-purple-700 transition-colors disabled:opacity-50">
                <svg x-show="!calibrating" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                </svg>
                <svg x-show="calibrating" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <span x-text="calibrating ? 'Kalibriere...' : 'Kalibrierung starten'"></span>
            </button>
        </div>
    </div>

    {# ── AI-Daten Status Karten ── #}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">KI-bewertete Matches</div>
            <div class="text-2xl font-bold text-gray-900">{{ ai_stats.total_ai_matches }}</div>
            <div class="text-xs text-gray-400 mt-1">
                {% if ai_stats.ready_for_calibration %}
                    <span class="text-green-600">Bereit fuer Kalibrierung</span>
                {% else %}
                    <span class="text-amber-600">Mehr Daten noetig (min. 3)</span>
                {% endif %}
            </div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Durchschnitt AI-Score</div>
            <div class="text-2xl font-bold text-gray-900">{{ "%.2f"|format(ai_stats.avg_ai_score) }}</div>
            <div class="text-xs text-gray-400 mt-1">von 0.00 bis 1.00</div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-xs font-medium text-green-600 uppercase tracking-wider mb-1">Gute Matches</div>
            <div class="text-2xl font-bold text-green-700">{{ ai_stats.good_matches }}</div>
            <div class="text-xs text-gray-400 mt-1">AI-Score &gt; 0.7</div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-xs font-medium text-amber-600 uppercase tracking-wider mb-1">Mittlere Matches</div>
            <div class="text-2xl font-bold text-amber-700">{{ ai_stats.medium_matches }}</div>
            <div class="text-xs text-gray-400 mt-1">AI-Score 0.3 – 0.7</div>
        </div>
        <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="text-xs font-medium text-red-600 uppercase tracking-wider mb-1">Schlechte Matches</div>
            <div class="text-2xl font-bold text-red-700">{{ ai_stats.bad_matches }}</div>
            <div class="text-xs text-gray-400 mt-1">AI-Score &lt; 0.3</div>
        </div>
    </div>

    {# ── Kalibrierungs-Status Banner ── #}
    <div x-show="statusMessage" x-transition class="mb-6" x-cloak>
        <div :class="statusError ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'"
             class="rounded-lg border p-4">
            <div class="flex items-center gap-3">
                <svg x-show="!statusError" class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg x-show="statusError" class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                </svg>
                <p :class="statusError ? 'text-red-800' : 'text-green-800'"
                   class="text-sm font-semibold" x-text="statusMessage"></p>
            </div>
        </div>
    </div>

    {# ── Ergebnis-Bereich (nach Kalibrierung) ── #}
    <template x-if="calibrationData">
    <div>

        {# Meta-Info #}
        <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center">
                    <svg class="w-5 h-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-semibold text-purple-800">
                        Letzte Kalibrierung: <span x-text="new Date(calibrationData.calibrated_at).toLocaleString('de-DE')"></span>
                    </p>
                    <p class="text-xs text-purple-600">
                        <span x-text="calibrationData.total_ai_matches"></span> AI-Matches analysiert,
                        <span x-text="calibrationData.total_with_roles"></span> mit Rollen-Info
                    </p>
                </div>
            </div>
            {# Warnings #}
            <template x-if="calibrationData.warnings && calibrationData.warnings.length > 0">
                <div class="mt-3 space-y-1">
                    <template x-for="w in calibrationData.warnings" :key="w">
                        <p class="text-xs text-amber-700 flex items-center gap-1">
                            <svg class="w-3 h-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                            <span x-text="w"></span>
                        </p>
                    </template>
                </div>
            </template>
        </div>

        {# ── Analyse 1: Rollen-Matrix Vorher/Nachher ── #}
        <div class="bg-white rounded-xl border border-gray-200 mb-6 overflow-hidden">
            <div class="bg-gray-50 border-b border-gray-200 px-5 py-3.5">
                <h2 class="text-base font-bold text-gray-900 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                    Analyse 1: Rollen-Kalibrierung
                </h2>
                <p class="text-xs text-gray-500 mt-0.5">
                    Vergleicht die aktuelle Rollen-Matrix mit den tatsaechlichen AI-Ergebnissen
                </p>
            </div>
            <div class="p-5">
                <template x-if="calibrationData.role_pair_stats && calibrationData.role_pair_stats.length > 0">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-100">
                                <th class="text-left py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Job-Rolle</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Kandidat-Rolle</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Samples</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Matrix AKTUELL</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">AI-Durchschnitt</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Vorschlag NEU</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Abweichung</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="rp in calibrationData.role_pair_stats" :key="rp.job_role + '|' + rp.candidate_role">
                                <tr class="border-b border-gray-50 hover:bg-gray-50">
                                    <td class="py-2 px-3 font-medium text-gray-900" x-text="rp.job_role"></td>
                                    <td class="py-2 px-3 text-gray-700" x-text="rp.candidate_role"></td>
                                    <td class="py-2 px-3 text-center text-gray-500" x-text="rp.sample_count"></td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="font-mono text-gray-600"
                                              x-text="rp.current_matrix_value !== null ? rp.current_matrix_value.toFixed(2) : '—'"></span>
                                    </td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="font-mono font-semibold"
                                              :class="rp.avg_ai_score >= 0.7 ? 'text-green-700' : rp.avg_ai_score <= 0.3 ? 'text-red-700' : 'text-amber-700'"
                                              x-text="rp.avg_ai_score.toFixed(3)"></span>
                                    </td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="font-mono font-bold text-purple-700"
                                              x-text="rp.suggested_value.toFixed(2)"></span>
                                    </td>
                                    <td class="py-2 px-3 text-center">
                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                                              :class="Math.abs(rp.deviation) > 0.1 ? (rp.deviation > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700') : 'bg-gray-100 text-gray-500'">
                                            <span x-text="(rp.deviation > 0 ? '+' : '') + rp.deviation.toFixed(3)"></span>
                                            <template x-if="Math.abs(rp.deviation) > 0.1">
                                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                                </svg>
                                            </template>
                                        </span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                </template>
                <template x-if="!calibrationData.role_pair_stats || calibrationData.role_pair_stats.length === 0">
                    <p class="text-sm text-gray-400">Keine Rollen-Paare mit genug Daten gefunden.</p>
                </template>

                {# Overrides die angewendet werden #}
                <template x-if="calibrationData.role_matrix_overrides && Object.keys(calibrationData.role_matrix_overrides).length > 0">
                    <div class="mt-4 p-3 bg-purple-50 border border-purple-100 rounded-lg">
                        <p class="text-xs font-semibold text-purple-800 mb-2">
                            Vorgeschlagene Aenderungen an der Rollen-Matrix (<span x-text="Object.keys(calibrationData.role_matrix_overrides).length"></span> Anpassungen):
                        </p>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="[key, val] in Object.entries(calibrationData.role_matrix_overrides)" :key="key">
                                <div class="text-xs bg-white border border-purple-200 rounded-lg px-3 py-1.5">
                                    <span class="text-gray-600" x-text="key.replace('|', ' → ')"></span>
                                    <span class="font-bold text-purple-700 ml-1" x-text="val.toFixed(2)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        {# ── Analyse 2: Power-Keywords ── #}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            {# Power-Keywords (gut) #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="bg-green-50 border-b border-green-100 px-5 py-3.5">
                    <h2 class="text-base font-bold text-green-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                        Power-Keywords
                    </h2>
                    <p class="text-xs text-green-700 mt-0.5">Keywords die stark mit guten AI-Matches korrelieren (zaehlen 2x)</p>
                </div>
                <div class="p-5">
                    <template x-if="calibrationData.power_keywords && calibrationData.power_keywords.length > 0">
                        <div class="flex flex-wrap gap-2">
                            <template x-for="kw in calibrationData.power_keywords" :key="kw">
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-green-100 text-green-800 text-xs font-semibold">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                                    </svg>
                                    <span x-text="kw"></span>
                                </span>
                            </template>
                        </div>
                    </template>
                    <template x-if="!calibrationData.power_keywords || calibrationData.power_keywords.length === 0">
                        <p class="text-sm text-gray-400">Noch keine Power-Keywords erkannt.</p>
                    </template>
                </div>
            </div>

            {# Penalty-Keywords (schlecht) #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="bg-red-50 border-b border-red-100 px-5 py-3.5">
                    <h2 class="text-base font-bold text-red-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Penalty-Keywords
                    </h2>
                    <p class="text-xs text-red-700 mt-0.5">Keywords die hauptsaechlich in schlechten Matches vorkommen (zaehlen 0.5x)</p>
                </div>
                <div class="p-5">
                    <template x-if="calibrationData.penalty_keywords && calibrationData.penalty_keywords.length > 0">
                        <div class="flex flex-wrap gap-2">
                            <template x-for="kw in calibrationData.penalty_keywords" :key="kw">
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-red-100 text-red-800 text-xs font-semibold">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6L9 12.75l4.286-4.286a11.948 11.948 0 014.306 6.43l.776 2.898m0 0l3.182-5.511m-3.182 5.51l-5.511-3.181" />
                                    </svg>
                                    <span x-text="kw"></span>
                                </span>
                            </template>
                        </div>
                    </template>
                    <template x-if="!calibrationData.penalty_keywords || calibrationData.penalty_keywords.length === 0">
                        <p class="text-sm text-gray-400">Noch keine Penalty-Keywords erkannt.</p>
                    </template>
                </div>
            </div>
        </div>

        {# ── Analyse 2b: Keyword Detail-Tabelle ── #}
        <template x-if="calibrationData.keyword_stats && calibrationData.keyword_stats.length > 0">
        <div class="bg-white rounded-xl border border-gray-200 mb-6 overflow-hidden">
            <div class="bg-gray-50 border-b border-gray-200 px-5 py-3.5">
                <h2 class="text-base font-bold text-gray-900 flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
                    </svg>
                    Keyword-Analyse Detail
                </h2>
            </div>
            <div class="p-5 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-100">
                            <th class="text-left py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Keyword</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Gesamt</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-green-600 uppercase">In guten Matches</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-red-600 uppercase">In schlechten Matches</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Power-Ratio</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Gewicht</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="kw in calibrationData.keyword_stats" :key="kw.keyword">
                            <tr class="border-b border-gray-50 hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium text-gray-900" x-text="kw.keyword"></td>
                                <td class="py-2 px-3 text-center text-gray-500" x-text="kw.total_count"></td>
                                <td class="py-2 px-3 text-center text-green-700 font-medium" x-text="kw.good_match_count"></td>
                                <td class="py-2 px-3 text-center text-red-700 font-medium" x-text="kw.bad_match_count"></td>
                                <td class="py-2 px-3 text-center">
                                    <div class="flex items-center justify-center gap-2">
                                        <div class="w-16 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full"
                                                 :class="kw.power_ratio >= 0.6 ? 'bg-green-500' : kw.power_ratio <= 0.25 ? 'bg-red-500' : 'bg-gray-300'"
                                                 :style="'width:' + (kw.power_ratio * 100) + '%'"></div>
                                        </div>
                                        <span class="font-mono text-xs text-gray-500" x-text="kw.power_ratio.toFixed(2)"></span>
                                    </div>
                                </td>
                                <td class="py-2 px-3 text-center">
                                    <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-bold"
                                          :class="kw.suggested_weight === 2.0 ? 'bg-green-100 text-green-700' : kw.suggested_weight === 0.5 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-500'"
                                          x-text="kw.suggested_weight + 'x'"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        </template>

        {# ── Analyse 4: Staerken/Schwaechen-Tiefenanalyse ── #}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            {# Must-Have Skills #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="bg-emerald-50 border-b border-emerald-100 px-5 py-3.5">
                    <h2 class="text-base font-bold text-emerald-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                        </svg>
                        Must-Have Skills
                    </h2>
                    <p class="text-xs text-emerald-700 mt-0.5">Skills die in guten Matches als Staerke UND in schlechten als fehlend vorkommen</p>
                </div>
                <div class="p-5">
                    <template x-if="calibrationData.must_have_skills && calibrationData.must_have_skills.length > 0">
                        <div class="flex flex-wrap gap-2">
                            <template x-for="skill in calibrationData.must_have_skills" :key="skill">
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-emerald-100 text-emerald-800 text-xs font-semibold">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" />
                                    </svg>
                                    <span x-text="skill"></span>
                                </span>
                            </template>
                        </div>
                    </template>
                    <template x-if="!calibrationData.must_have_skills || calibrationData.must_have_skills.length === 0">
                        <p class="text-sm text-gray-400">Noch keine Must-Have Skills erkannt — mehr Daten benoetigt.</p>
                    </template>
                </div>
            </div>

            {# Deal-Breaker Luecken #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="bg-rose-50 border-b border-rose-100 px-5 py-3.5">
                    <h2 class="text-base font-bold text-rose-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-rose-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                        Deal-Breaker
                    </h2>
                    <p class="text-xs text-rose-700 mt-0.5">Fehlende Skills die fast immer zu schlechten Matches fuehren</p>
                </div>
                <div class="p-5">
                    <template x-if="calibrationData.deal_breaker_gaps && calibrationData.deal_breaker_gaps.length > 0">
                        <div class="flex flex-wrap gap-2">
                            <template x-for="gap in calibrationData.deal_breaker_gaps" :key="gap">
                                <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-rose-100 text-rose-800 text-xs font-semibold">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                    </svg>
                                    <span x-text="gap"></span>
                                </span>
                            </template>
                        </div>
                    </template>
                    <template x-if="!calibrationData.deal_breaker_gaps || calibrationData.deal_breaker_gaps.length === 0">
                        <p class="text-sm text-gray-400">Noch keine Deal-Breaker erkannt — mehr Daten benoetigt.</p>
                    </template>
                </div>
            </div>
        </div>

        {# ── Analyse 4b: Top-Staerken und Top-Schwaechen (rohe KI-Texte) ── #}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            {# Top-Staerken guter Matches #}
            <template x-if="calibrationData.top_strengths_good_matches && calibrationData.top_strengths_good_matches.length > 0">
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 border-b border-gray-200 px-5 py-3.5">
                    <h2 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.633 10.5c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 012.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 00.322-1.672V3a.75.75 0 01.75-.75A2.25 2.25 0 0116.5 4.5c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 01-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 00-1.423-.23H5.904M14.25 9h2.25M5.904 18.75c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 01-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 10.203 4.167 9.75 5 9.75h1.053c.472 0 .745.556.5.96a8.958 8.958 0 00-1.302 4.665c0 1.194.232 2.333.654 3.375z" />
                        </svg>
                        Haeufigste Staerken in guten Matches (AI-Score &gt; 0.7)
                    </h2>
                </div>
                <div class="p-4">
                    <ol class="space-y-1.5">
                        <template x-for="(s, idx) in calibrationData.top_strengths_good_matches" :key="idx">
                            <li class="flex items-start gap-2 text-xs text-gray-700">
                                <span class="flex-shrink-0 w-5 h-5 rounded-full bg-green-100 text-green-700 flex items-center justify-center text-[10px] font-bold" x-text="idx + 1"></span>
                                <span x-text="s"></span>
                            </li>
                        </template>
                    </ol>
                </div>
            </div>
            </template>

            {# Top-Schwaechen schlechter Matches #}
            <template x-if="calibrationData.top_weaknesses_bad_matches && calibrationData.top_weaknesses_bad_matches.length > 0">
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 border-b border-gray-200 px-5 py-3.5">
                    <h2 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 15h2.25m8.024-9.75c.011.05.028.1.052.148.591 1.2.924 2.55.924 3.977a8.96 8.96 0 01-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398C20.613 14.547 19.833 15 19 15h-1.053c-.472 0-.745-.556-.5-.96a8.95 8.95 0 00.303-.54m.023-8.25H16.48a4.5 4.5 0 01-1.423-.23l-3.114-1.04a4.5 4.5 0 00-1.423-.23H6.504c-.618 0-1.217.247-1.605.729A11.95 11.95 0 002.25 12c0 .434.023.863.068 1.285C2.427 14.306 3.346 15 4.372 15h3.126c.618 0 .991.724.725 1.282A7.471 7.471 0 007.5 19.5a2.25 2.25 0 002.25 2.25.75.75 0 00.75-.75v-.633c0-.573.11-1.14.322-1.672.304-.76.93-1.33 1.653-1.715a9.04 9.04 0 002.86-2.4c.498-.634 1.226-1.08 2.032-1.08h.384" />
                        </svg>
                        Haeufigste Schwaechen in schlechten Matches (AI-Score &lt; 0.3)
                    </h2>
                </div>
                <div class="p-4">
                    <ol class="space-y-1.5">
                        <template x-for="(w, idx) in calibrationData.top_weaknesses_bad_matches" :key="idx">
                            <li class="flex items-start gap-2 text-xs text-gray-700">
                                <span class="flex-shrink-0 w-5 h-5 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-[10px] font-bold" x-text="idx + 1"></span>
                                <span x-text="w"></span>
                            </li>
                        </template>
                    </ol>
                </div>
            </div>
            </template>
        </div>

        {# ── Analyse 4c: Impact-Tabelle (alle erkannten Muster) ── #}
        <template x-if="calibrationData.strength_weakness_patterns && calibrationData.strength_weakness_patterns.length > 0">
        <div class="bg-white rounded-xl border border-gray-200 mb-6 overflow-hidden">
            <div class="bg-gray-50 border-b border-gray-200 px-5 py-3.5">
                <h2 class="text-base font-bold text-gray-900 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605" />
                    </svg>
                    Skill-Impact-Analyse (aus KI-Staerken/Schwaechen)
                </h2>
                <p class="text-xs text-gray-500 mt-0.5">Zeigt welche Skills den groessten Einfluss auf die Match-Qualitaet haben</p>
            </div>
            <div class="p-5 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-100">
                            <th class="text-left py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Skill/Begriff</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Kategorie</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-green-600 uppercase">Staerke ✓</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-red-600 uppercase">Schwaeche ✗</th>
                            <th class="text-center py-2 px-3 text-xs font-semibold text-gray-500 uppercase">Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="p in calibrationData.strength_weakness_patterns.slice(0, 25)" :key="p.pattern">
                            <tr class="border-b border-gray-50 hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium text-gray-900" x-text="p.pattern"></td>
                                <td class="py-2 px-3 text-center">
                                    <span class="inline-flex px-2 py-0.5 rounded-full text-[10px] font-bold uppercase"
                                          :class="{
                                              'bg-emerald-100 text-emerald-700': p.category === 'must_have',
                                              'bg-rose-100 text-rose-700': p.category === 'deal_breaker',
                                              'bg-blue-100 text-blue-700': p.category === 'nice_to_have',
                                              'bg-gray-100 text-gray-500': p.category === 'minor_issue'
                                          }"
                                          x-text="p.category === 'must_have' ? 'Must-Have' : p.category === 'deal_breaker' ? 'Deal-Breaker' : p.category === 'nice_to_have' ? 'Nice-to-Have' : 'Neutral'"></span>
                                </td>
                                <td class="py-2 px-3 text-center text-xs">
                                    <span class="text-green-700" x-text="'gut:' + p.in_strengths_good"></span>
                                    <span class="text-gray-300 mx-0.5">/</span>
                                    <span class="text-red-600" x-text="'schl:' + p.in_strengths_bad"></span>
                                </td>
                                <td class="py-2 px-3 text-center text-xs">
                                    <span class="text-green-700" x-text="'gut:' + p.in_weaknesses_good"></span>
                                    <span class="text-gray-300 mx-0.5">/</span>
                                    <span class="text-red-600" x-text="'schl:' + p.in_weaknesses_bad"></span>
                                </td>
                                <td class="py-2 px-3 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <div class="w-16 h-3 bg-gray-100 rounded-full overflow-hidden relative">
                                            <div class="absolute inset-y-0 left-1/2 w-px bg-gray-300"></div>
                                            <template x-if="p.impact_score >= 0">
                                                <div class="absolute inset-y-0 left-1/2 bg-green-500 rounded-r-full"
                                                     :style="'width:' + (p.impact_score * 50) + '%'"></div>
                                            </template>
                                            <template x-if="p.impact_score < 0">
                                                <div class="absolute inset-y-0 bg-red-500 rounded-l-full"
                                                     :style="'right:50%; width:' + (Math.abs(p.impact_score) * 50) + '%'"></div>
                                            </template>
                                        </div>
                                        <span class="font-mono text-[10px] w-10 text-right"
                                              :class="p.impact_score >= 0 ? 'text-green-700' : 'text-red-700'"
                                              x-text="(p.impact_score >= 0 ? '+' : '') + p.impact_score.toFixed(2)"></span>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        </template>

        {# ── Analyse 3: Ausschluss-Paare ── #}
        <div class="bg-white rounded-xl border border-gray-200 mb-6 overflow-hidden">
            <div class="bg-red-50 border-b border-red-100 px-5 py-3.5">
                <h2 class="text-base font-bold text-red-900 flex items-center gap-2">
                    <svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                    Analyse 3: Ausschluss-Paare
                </h2>
                <p class="text-xs text-red-700 mt-0.5">
                    Rollen-Kombinationen die IMMER schlecht abschneiden — werden kuenftig nicht mehr als Pre-Match generiert
                </p>
            </div>
            <div class="p-5">
                <template x-if="calibrationData.exclusion_pairs && calibrationData.exclusion_pairs.length > 0">
                    <div class="space-y-2">
                        <template x-for="pair in calibrationData.exclusion_pairs" :key="pair[0] + pair[1]">
                            <div class="flex items-center gap-3 p-3 bg-red-50 border border-red-100 rounded-lg">
                                <svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                </svg>
                                <span class="text-sm text-red-800">
                                    <span class="font-semibold" x-text="pair[0]"></span>
                                    <span class="text-red-400 mx-1">x</span>
                                    <span class="font-semibold" x-text="pair[1]"></span>
                                </span>
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="!calibrationData.exclusion_pairs || calibrationData.exclusion_pairs.length === 0">
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Keine Ausschluss-Paare erkannt — alle Rollen-Kombinationen haben mindestens 1 gutes Match.
                    </div>
                </template>
            </div>
        </div>

    </div>
    </template>

    {# ── Kein Ergebnis vorhanden ── #}
    <template x-if="!calibrationData">
    <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
        <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-500 mb-2">Noch keine Kalibrierung durchgefuehrt</h3>
        <p class="text-sm text-gray-400 mb-4 max-w-md mx-auto">
            Klicke oben auf "Kalibrierung starten" um die AI-Ergebnisse zu analysieren
            und das Pre-Scoring automatisch zu verbessern.
        </p>
        <p class="text-xs text-gray-300">
            Voraussetzung: Mindestens 3 AI-bewertete Matches (DeepMatch)
        </p>
    </div>
    </template>

</div>

<script>
function calibrationPage() {
    return {
        calibrating: false,
        statusMessage: '',
        statusError: false,
        calibrationData: {{ last_calibration_json | safe }},

        async runCalibration() {
            this.calibrating = true;
            this.statusMessage = '';
            this.statusError = false;

            try {
                const resp = await fetch('/api/calibration/run?category={{ category }}', { method: 'POST' });
                const data = await resp.json();

                if (resp.status === 409) {
                    this.statusMessage = 'Kalibrierung laeuft bereits...';
                    this.statusError = true;
                    this.calibrating = false;
                    return;
                }

                // Polling fuer Status
                const poll = setInterval(async () => {
                    try {
                        const statusResp = await fetch('/api/calibration/status');
                        const status = await statusResp.json();

                        if (!status.running) {
                            clearInterval(poll);
                            this.calibrating = false;

                            if (status.error) {
                                this.statusMessage = 'Fehler: ' + status.error;
                                this.statusError = true;
                            } else if (status.result) {
                                this.calibrationData = status.result;
                                const overrides = Object.keys(status.result.role_matrix_overrides || {}).length;
                                const powerKw = (status.result.power_keywords || []).length;
                                const exclusions = (status.result.exclusion_pairs || []).length;
                                this.statusMessage =
                                    `Kalibrierung abgeschlossen! ` +
                                    `${status.result.total_ai_matches} Matches analysiert, ` +
                                    `${overrides} Matrix-Anpassungen, ` +
                                    `${powerKw} Power-Keywords, ` +
                                    `${exclusions} Ausschluss-Paare`;
                                this.statusError = false;
                            }
                        }
                    } catch (e) {
                        console.error('Polling-Fehler:', e);
                    }
                }, 2000);

            } catch (e) {
                this.statusMessage = 'Netzwerkfehler: ' + e.message;
                this.statusError = true;
                this.calibrating = false;
            }
        }
    };
}
</script>
{% endblock %}
