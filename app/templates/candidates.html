{% extends "base.html" %}

{% block title %}Kandidaten - Matching-Tool{% endblock %}

{% block content %}
<div class="space-y-8">
    {# Header #}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-5">
        <div>
            <h1 class="text-4xl font-bold text-gray-900">Kandidaten</h1>
            <p class="mt-1.5 text-lg text-gray-500">Alle synchronisierten Kandidaten aus dem CRM</p>
        </div>

        {# Suche + Seitengroesse + Auswahl-Button #}
        <div class="flex items-center space-x-5">
            {# Auswahl-Modus Toggle #}
            <button id="btn-selection-toggle"
                    type="button"
                    onclick="toggleSelectionMode()"
                    class="inline-flex items-center rounded-md bg-white px-4 py-2.5 text-base font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-colors whitespace-nowrap">
                Auswaehlen
            </button>
            {# Seitengroesse #}
            <div class="flex items-center space-x-3">
                <label for="per-page-select" class="text-base text-gray-500 whitespace-nowrap">Anzeigen:</label>
                <select id="per-page-select"
                        name="per_page"
                        onchange="changePerPage(this.value)"
                        class="block rounded-md border-0 py-2.5 pl-4 pr-10 text-base text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-primary-600">
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            {# Suche #}
            <div class="relative">
                <input type="text"
                       id="candidate-search"
                       name="search"
                       placeholder="Name suchen..."
                       hx-get="/partials/candidates-list"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#candidates-list"
                       hx-include="[name='search'], [name='per_page'], [name='position'], [name='skills'], [name='city'], [name='category']"
                       class="block w-80 rounded-md border-0 py-3 pl-12 pr-4 text-lg text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 leading-6">
                <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                    <svg class="h-6 w-6 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    {# Kategorie-Riegel (Segmented Control) #}
    <div x-data="{ activeCategory: '' }" class="flex items-center justify-center">
        <div class="inline-flex items-center gap-1 bg-gray-100 rounded-lg p-1">
            <button type="button"
                    :class="activeCategory === 'FINANCE' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    @click="activeCategory = 'FINANCE'; $refs.categoryInput.value = 'FINANCE'; htmx.trigger($refs.categoryInput, 'change')"
                    class="rounded-md px-5 py-2.5 text-base font-medium transition-all">
                Finance
            </button>
            <button type="button"
                    :class="activeCategory === '' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    @click="activeCategory = ''; $refs.categoryInput.value = ''; htmx.trigger($refs.categoryInput, 'change')"
                    class="rounded-md px-5 py-2.5 text-base font-medium transition-all">
                Alle
            </button>
            <button type="button"
                    :class="activeCategory === 'ENGINEERING' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    @click="activeCategory = 'ENGINEERING'; $refs.categoryInput.value = 'ENGINEERING'; htmx.trigger($refs.categoryInput, 'change')"
                    class="rounded-md px-5 py-2.5 text-base font-medium transition-all">
                Engineering
            </button>
        </div>
        <input type="hidden" name="category" x-ref="categoryInput" value=""
               hx-get="/partials/candidates-list"
               hx-trigger="change"
               hx-target="#candidates-list"
               hx-include="[name='search'], [name='per_page'], [name='position'], [name='skills'], [name='city'], [name='category']">
    </div>

    {# Erweiterte Filter - automatisch oeffnen wenn URL-Parameter vorhanden #}
    <div x-data="{ filtersOpen: new URLSearchParams(window.location.search).get('position') || new URLSearchParams(window.location.search).get('skills') || new URLSearchParams(window.location.search).get('city') ? true : false }" class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg">
        <button @click="filtersOpen = !filtersOpen"
                type="button"
                class="w-full flex items-center justify-between px-5 py-3 text-left hover:bg-gray-50 transition-colors rounded-lg">
            <div class="flex items-center space-x-2">
                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
                </svg>
                <span class="font-medium text-gray-900">Erweiterte Filter</span>
                <span id="filter-active-badge" class="hidden inline-flex items-center rounded-full bg-primary-100 px-2.5 py-0.5 text-xs font-medium text-primary-700">Aktiv</span>
            </div>
            <svg :class="{ 'rotate-180': filtersOpen }" class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
        </button>
        <div x-show="filtersOpen" x-transition class="border-t border-gray-200 px-5 py-4" style="display: none;">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="candidate-filters">
                {# Position #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                    <input type="text"
                           name="position"
                           placeholder="z.B. Buchhalter, Controller..."
                           hx-get="/partials/candidates-list"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#candidates-list"
                           hx-include="[name='search'], [name='per_page'], [name='position'], [name='skills'], [name='city'], [name='category']"
                           oninput="updateFilterBadge()"
                           class="block w-full rounded-md border-0 py-2.5 pl-4 pr-4 text-base text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600">
                </div>
                {# IT-Kenntnisse / Skills #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">IT-Kenntnisse / Skills</label>
                    <input type="text"
                           name="skills"
                           placeholder="z.B. SAP, DATEV, Python..."
                           hx-get="/partials/candidates-list"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#candidates-list"
                           hx-include="[name='search'], [name='per_page'], [name='position'], [name='skills'], [name='city'], [name='category']"
                           oninput="updateFilterBadge()"
                           class="block w-full rounded-md border-0 py-2.5 pl-4 pr-4 text-base text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600">
                </div>
                {# Stadt #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stadt</label>
                    <input type="text"
                           name="city"
                           placeholder="z.B. Berlin, Hamburg..."
                           hx-get="/partials/candidates-list"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#candidates-list"
                           hx-include="[name='search'], [name='per_page'], [name='position'], [name='skills'], [name='city'], [name='category']"
                           oninput="updateFilterBadge()"
                           class="block w-full rounded-md border-0 py-2.5 pl-4 pr-4 text-base text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600">
                </div>
            </div>
            <div class="mt-3 flex justify-end">
                <button type="button" onclick="resetCandidateFilters()"
                        class="text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">
                    Filter zuruecksetzen
                </button>
            </div>
        </div>
    </div>

    {# Kandidaten-Tabelle #}
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg overflow-hidden">
        <div id="candidates-list"
             hx-swap="innerHTML">
            {# Loading State #}
            <div class="p-10 text-center">
                <div class="inline-flex items-center space-x-3 text-gray-500">
                    <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-lg">Kandidaten werden geladen...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== URL State Management ====================
// Synchronisiert Filter, Seite, Kategorie mit der Browser-URL
// Damit beim Zurueck-Button alles erhalten bleibt

function getUrlParams() {
    return new URLSearchParams(window.location.search);
}

function getCurrentState() {
    var search = document.getElementById('candidate-search');
    var position = document.querySelector('[name="position"]');
    var skills = document.querySelector('[name="skills"]');
    var city = document.querySelector('[name="city"]');
    var category = document.querySelector('[name="category"]');
    var perPage = document.getElementById('per-page-select');
    return {
        search: search ? search.value : '',
        position: position ? position.value : '',
        skills: skills ? skills.value : '',
        city: city ? city.value : '',
        category: category ? category.value : '',
        per_page: perPage ? perPage.value : '25',
    };
}

function buildQueryString(state, page) {
    var params = new URLSearchParams();
    if (page && page > 1) params.set('page', page);
    if (state.per_page && state.per_page !== '25') params.set('per_page', state.per_page);
    if (state.search) params.set('search', state.search);
    if (state.position) params.set('position', state.position);
    if (state.skills) params.set('skills', state.skills);
    if (state.city) params.set('city', state.city);
    if (state.category) params.set('category', state.category);
    var qs = params.toString();
    return qs ? '?' + qs : '';
}

function pushStateToUrl(page) {
    var state = getCurrentState();
    var newUrl = '/kandidaten' + buildQueryString(state, page);
    if (window.location.pathname + window.location.search !== newUrl) {
        history.pushState({ candidatePage: true, page: page }, '', newUrl);
    }
}

// URL-State in Formular-Inputs wiederherstellen
function restoreStateFromUrl() {
    var params = getUrlParams();

    var search = document.getElementById('candidate-search');
    if (search && params.get('search')) search.value = params.get('search');

    var position = document.querySelector('[name="position"]');
    if (position && params.get('position')) position.value = params.get('position');

    var skills = document.querySelector('[name="skills"]');
    if (skills && params.get('skills')) skills.value = params.get('skills');

    var city = document.querySelector('[name="city"]');
    if (city && params.get('city')) city.value = params.get('city');

    var category = document.querySelector('[name="category"]');
    if (category && params.get('category')) category.value = params.get('category');

    var perPage = document.getElementById('per-page-select');
    if (perPage && params.get('per_page')) perPage.value = params.get('per_page');

    // Kategorie-Riegel visuell synchronisieren
    var catVal = params.get('category') || '';
    // Alpine.js activeCategory setzen via DOM-Event
    var catButtons = document.querySelectorAll('[x-data] button[type="button"]');
    // Besser: Alpine direkt ueber $data ansprechen
    var catContainer = document.querySelector('[x-data]');
    if (catContainer && catContainer.__x) {
        catContainer.__x.$data.activeCategory = catVal;
    } else if (catContainer && catContainer._x_dataStack) {
        catContainer._x_dataStack[0].activeCategory = catVal;
    }

    updateFilterBadge();
}

// Aktuelle Seite aus dem HTMX-Response extrahieren
var _currentPage = 1;
var _isInitialLoad = true;

// Nach oben scrollen bei Seitenwechsel + URL updaten
document.body.addEventListener('htmx:afterSettle', function(event) {
    if (event.detail.target && event.detail.target.id === 'candidates-list') {
        // Beim initial-load nicht scrollen (Seite wird gerade erst aufgebaut)
        if (!_isInitialLoad) {
            window.scrollTo(0, 0);
        }
        // Aktuelle Seite aus dem Response extrahieren
        var activePageEl = document.querySelector('#candidates-list .border-primary-500');
        if (activePageEl) {
            _currentPage = parseInt(activePageEl.textContent.trim()) || 1;
        }
        if (_isInitialLoad) {
            // Erster Load: replaceState statt pushState (kein Extra-Eintrag im History)
            var state = getCurrentState();
            var newUrl = '/kandidaten' + buildQueryString(state, _currentPage);
            history.replaceState({ candidatePage: true, page: _currentPage }, '', newUrl);
            _isInitialLoad = false;
        } else {
            pushStateToUrl(_currentPage);
        }
    }
});

// popstate: Wenn Benutzer Zurueck/Vorwaerts klickt
window.addEventListener('popstate', function(event) {
    // Nur reagieren wenn wir auf /kandidaten sind
    if (window.location.pathname === '/kandidaten') {
        restoreStateFromUrl();
        // Liste mit den URL-Parametern neu laden
        var params = getUrlParams();
        var page = params.get('page') || '1';
        var perPage = params.get('per_page') || '25';
        var url = '/partials/candidates-list?page=' + page + '&per_page=' + perPage;
        if (params.get('search')) url += '&search=' + encodeURIComponent(params.get('search'));
        if (params.get('position')) url += '&position=' + encodeURIComponent(params.get('position'));
        if (params.get('skills')) url += '&skills=' + encodeURIComponent(params.get('skills'));
        if (params.get('city')) url += '&city=' + encodeURIComponent(params.get('city'));
        if (params.get('category')) url += '&category=' + encodeURIComponent(params.get('category'));
        htmx.ajax('GET', url, {target:'#candidates-list', swap:'innerHTML'});
    }
});

function changePerPage(perPage) {
    var state = getCurrentState();
    state.per_page = perPage;
    var url = '/partials/candidates-list?page=1&per_page=' + perPage;
    if (state.search) url += '&search=' + encodeURIComponent(state.search);
    if (state.position) url += '&position=' + encodeURIComponent(state.position);
    if (state.skills) url += '&skills=' + encodeURIComponent(state.skills);
    if (state.city) url += '&city=' + encodeURIComponent(state.city);
    if (state.category) url += '&category=' + encodeURIComponent(state.category);
    htmx.ajax('GET', url, {target:'#candidates-list', swap:'innerHTML'});
}

function resetCandidateFilters() {
    document.querySelectorAll('#candidate-filters input').forEach(function(input) {
        input.value = '';
    });
    var search = document.getElementById('candidate-search');
    if (search) search.value = '';
    // Kategorie-Riegel zuruecksetzen
    var category = document.querySelector('[name="category"]');
    if (category) category.value = '';
    // Alpine.js Kategorie-State zuruecksetzen
    var catContainer = document.querySelector('[x-data]');
    if (catContainer && catContainer._x_dataStack) {
        catContainer._x_dataStack[0].activeCategory = '';
    }
    updateFilterBadge();
    var perPage = document.getElementById('per-page-select');
    var perPageVal = perPage ? perPage.value : '25';
    htmx.ajax('GET', '/partials/candidates-list?page=1&per_page=' + perPageVal, {target:'#candidates-list', swap:'innerHTML'});
}

function updateFilterBadge() {
    var badge = document.getElementById('filter-active-badge');
    if (!badge) return;
    var hasFilter = false;
    document.querySelectorAll('#candidate-filters input').forEach(function(input) {
        if (input.value.trim()) hasFilter = true;
    });
    if (hasFilter) {
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// ==================== Initialisierung ====================
// Beim Laden: State aus URL wiederherstellen und Liste laden
(function() {
    function initCandidates() {
        var params = getUrlParams();

        // State aus URL in Formular-Inputs wiederherstellen
        restoreStateFromUrl();

        // Initiale Liste laden (mit URL-Parametern falls vorhanden)
        var page = params.get('page') || '1';
        var perPage = params.get('per_page') || '25';
        var url = '/partials/candidates-list?page=' + page + '&per_page=' + perPage;
        if (params.get('search')) url += '&search=' + encodeURIComponent(params.get('search'));
        if (params.get('position')) url += '&position=' + encodeURIComponent(params.get('position'));
        if (params.get('skills')) url += '&skills=' + encodeURIComponent(params.get('skills'));
        if (params.get('city')) url += '&city=' + encodeURIComponent(params.get('city'));
        if (params.get('category')) url += '&category=' + encodeURIComponent(params.get('category'));
        htmx.ajax('GET', url, {target:'#candidates-list', swap:'innerHTML'});
    }

    // Warten bis DOM + Alpine.js bereit sind
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initCandidates, 50);
        });
    } else {
        setTimeout(initCandidates, 50);
    }
})();
</script>
{% endblock %}
