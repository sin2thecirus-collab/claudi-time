{% extends "base.html" %}

{% block title %}{{ contact.full_name }} - Pulspoint{% endblock %}

{% block content %}
<div x-data="{ editing: false }">

    {# -- Breadcrumb + Header -- #}
    <div class="mb-6">
        <nav class="flex items-center gap-1.5 text-sm text-gray-500 mb-3">
            <a href="/unternehmen" class="hover:text-gray-700">Unternehmen</a>
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
            <a href="/unternehmen/{{ company.id }}" class="hover:text-gray-700">{{ company.name }}</a>
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
            <span class="text-gray-900 font-medium">{{ contact.full_name }}</span>
        </nav>

        <div class="flex items-start justify-between">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-xl bg-primary-100 flex items-center justify-center">
                    <svg class="w-7 h-7 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{{ contact.full_name }}</h1>
                    <div class="flex items-center gap-2 mt-1">
                        {% if contact.position %}
                        <span class="text-sm text-gray-500">{{ contact.position }}</span>
                        <span class="text-gray-300">&middot;</span>
                        {% endif %}
                        <a href="/unternehmen/{{ company.id }}" class="text-sm text-primary-600 hover:text-primary-500">{{ company.name }}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# -- Content Grid -- #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        {# ======== Linke Spalte (2/3) ======== #}
        <div class="lg:col-span-2 space-y-6">

            {# -- Kontaktdaten Card -- #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-gray-900">Kontaktdaten</h3>
                    <button @click="editing = !editing"
                            class="text-xs font-medium px-3 py-1.5 rounded-lg transition-colors"
                            :class="editing ? 'bg-green-50 text-green-700 hover:bg-green-100' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'">
                        <span x-show="!editing">Bearbeiten</span>
                        <span x-show="editing">Fertig</span>
                    </button>
                </div>
                <div class="p-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {# Anrede #}
                        <div>
                            <label class="text-xs text-gray-500">Anrede</label>
                            <div x-show="!editing" class="text-sm text-gray-900 mt-0.5">{{ contact.salutation or '-' }}</div>
                            <select x-show="editing" style="display:none"
                                    onchange="saveContactField('salutation', this.value)"
                                    class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                                <option value="" {% if not contact.salutation %}selected{% endif %}>-- Bitte waehlen --</option>
                                <option value="Herr" {% if contact.salutation == 'Herr' %}selected{% endif %}>Herr</option>
                                <option value="Frau" {% if contact.salutation == 'Frau' %}selected{% endif %}>Frau</option>
                            </select>
                        </div>
                        {# Leer fuer Alignment #}
                        <div></div>
                        {# Vorname #}
                        <div>
                            <label class="text-xs text-gray-500">Vorname</label>
                            <div x-show="!editing" class="text-sm text-gray-900 mt-0.5">{{ contact.first_name or '-' }}</div>
                            <input x-show="editing" style="display:none" type="text"
                                   value="{{ contact.first_name or '' }}"
                                   onblur="saveContactField('first_name', this.value)"
                                   class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        {# Nachname #}
                        <div>
                            <label class="text-xs text-gray-500">Nachname</label>
                            <div x-show="!editing" class="text-sm text-gray-900 mt-0.5">{{ contact.last_name or '-' }}</div>
                            <input x-show="editing" style="display:none" type="text"
                                   value="{{ contact.last_name or '' }}"
                                   onblur="saveContactField('last_name', this.value)"
                                   class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        {# Position #}
                        <div class="sm:col-span-2">
                            <label class="text-xs text-gray-500">Position</label>
                            <div x-show="!editing" class="text-sm text-gray-900 mt-0.5">{{ contact.position or '-' }}</div>
                            <input x-show="editing" style="display:none" type="text"
                                   value="{{ contact.position or '' }}"
                                   onblur="saveContactField('position', this.value)"
                                   class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        {# E-Mail #}
                        <div class="sm:col-span-2">
                            <label class="text-xs text-gray-500">E-Mail</label>
                            <div x-show="!editing" class="flex items-center gap-2 mt-0.5">
                                {% if contact.email %}
                                <a href="mailto:{{ contact.email }}" class="text-sm text-primary-600 hover:text-primary-500">{{ contact.email }}</a>
                                <button onclick="copyToClipboard('{{ contact.email }}', 'E-Mail')"
                                        class="text-gray-400 hover:text-primary-600 transition-colors" title="Kopieren">
                                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                                    </svg>
                                </button>
                                {% else %}
                                <span class="text-sm text-gray-400">-</span>
                                {% endif %}
                            </div>
                            <input x-show="editing" style="display:none" type="email"
                                   value="{{ contact.email or '' }}"
                                   onblur="saveContactField('email', this.value)"
                                   class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        {# Telefon #}
                        <div>
                            <label class="text-xs text-gray-500">Telefon</label>
                            <div x-show="!editing" class="flex items-center gap-2 mt-0.5">
                                {% if contact.phone %}
                                <a href="tel:{{ contact.phone }}" class="text-sm text-gray-900 hover:text-primary-600">{{ contact.phone }}</a>
                                <button onclick="copyToClipboard('{{ contact.phone }}', 'Telefon')"
                                        class="text-gray-400 hover:text-primary-600 transition-colors" title="Kopieren">
                                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                                    </svg>
                                </button>
                                {% else %}
                                <span class="text-sm text-gray-400">-</span>
                                {% endif %}
                            </div>
                            <input x-show="editing" style="display:none" type="text"
                                   value="{{ contact.phone or '' }}"
                                   onblur="saveContactField('phone', this.value)"
                                   class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        {# Mobil #}
                        <div>
                            <label class="text-xs text-gray-500">Mobil</label>
                            <div x-show="!editing" class="flex items-center gap-2 mt-0.5">
                                {% if contact.mobile %}
                                <a href="tel:{{ contact.mobile }}" class="text-sm text-gray-900 hover:text-primary-600">{{ contact.mobile }}</a>
                                <button onclick="copyToClipboard('{{ contact.mobile }}', 'Mobil')"
                                        class="text-gray-400 hover:text-primary-600 transition-colors" title="Kopieren">
                                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                                    </svg>
                                </button>
                                {% else %}
                                <span class="text-sm text-gray-400">-</span>
                                {% endif %}
                            </div>
                            <input x-show="editing" style="display:none" type="text"
                                   value="{{ contact.mobile or '' }}"
                                   onblur="saveContactField('mobile', this.value)"
                                   class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        {# Stadt / Standort #}
                        <div class="sm:col-span-2">
                            <label class="text-xs text-gray-500">Stadt / Standort</label>
                            <div x-show="!editing" class="text-sm text-gray-900 mt-0.5">{{ contact.city or '-' }}</div>
                            <input x-show="editing" style="display:none" type="text"
                                   value="{{ contact.city or '' }}"
                                   onblur="saveContactField('city', this.value)"
                                   class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        {# Notizen #}
                        <div class="sm:col-span-2">
                            <label class="text-xs text-gray-500">Notizen</label>
                            <div x-show="!editing" class="text-sm text-gray-900 mt-0.5 whitespace-pre-line">{{ contact.notes or '-' }}</div>
                            <textarea x-show="editing" style="display:none" rows="3"
                                      onblur="saveContactField('notes', this.value)"
                                      class="mt-0.5 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">{{ contact.notes or '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            {# -- Anrufprotokoll Card -- #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-gray-900">Anrufprotokoll</h3>
                    <button onclick="toggleCallNoteForm()"
                            class="text-xs text-primary-600 hover:text-primary-500 font-medium">
                        + Neuer Anruf
                    </button>
                </div>
                <div class="p-5">
                    <div id="call-notes-container"
                         hx-get="/partials/contact/{{ contact.id }}/call-notes"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="text-sm text-gray-400 animate-skeleton">Lade Anrufprotokoll...</p>
                    </div>
                    {# Inline Add-Form (versteckt) #}
                    <div id="call-note-form" style="display:none" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="space-y-3">
                            <textarea id="cn-summary" placeholder="Zusammenfassung *" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required></textarea>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <select id="cn-call-type" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                                    <option value="acquisition">Akquisition</option>
                                    <option value="qualification">Qualifikation</option>
                                    <option value="followup">Follow-up</option>
                                    <option value="candidate_call">Kandidaten-Anruf</option>
                                </select>
                                <input type="number" id="cn-duration" placeholder="Dauer (Min.)" min="0" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input type="datetime-local" id="cn-called-at" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="saveCallNote()" class="px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700">Speichern</button>
                            <button onclick="toggleCallNoteForm()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Abbrechen</button>
                        </div>
                    </div>
                </div>
            </div>

            {# -- E-Mail-Korrespondenz Card -- #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-gray-900">E-Mail-Korrespondenz</h3>
                    <button onclick="toggleCorrForm()"
                            class="text-xs text-primary-600 hover:text-primary-500 font-medium">
                        + Neue Korrespondenz
                    </button>
                </div>
                <div class="p-5">
                    <div id="correspondence-container"
                         hx-get="/partials/contact/{{ contact.id }}/correspondence"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="text-sm text-gray-400 animate-skeleton">Lade Korrespondenz...</p>
                    </div>
                    {# Inline Add-Form (versteckt) #}
                    <div id="corr-form" style="display:none" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="space-y-3">
                            <div class="flex gap-3">
                                <select id="corr-direction" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                                    <option value="outbound">Ausgehend</option>
                                    <option value="inbound">Eingehend</option>
                                </select>
                                <input type="text" id="corr-subject" placeholder="Betreff *" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <textarea id="corr-body" placeholder="Inhalt / Notizen" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                            <input type="datetime-local" id="corr-sent-at" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="saveCorrespondence()" class="px-4 py-2 bg-primary-600 text-white text-sm rounded-lg hover:bg-primary-700">Speichern</button>
                            <button onclick="toggleCorrForm()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Abbrechen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ======== Rechte Spalte (1/3) ======== #}
        <div class="space-y-6">

            {# -- Firma Card -- #}
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Firma</h3>
                <div class="space-y-3">
                    <div>
                        <a href="/unternehmen/{{ company.id }}" class="text-sm font-medium text-primary-600 hover:text-primary-500">{{ company.name }}</a>
                    </div>
                    {% if company.address or company.city %}
                    <div class="text-sm text-gray-600">
                        {% if company.address %}<span class="whitespace-pre-line">{{ company.address }}</span><br>{% endif %}
                        {% if company.city %}{{ company.city }}{% endif %}
                    </div>
                    {% endif %}
                    {% if company.phone %}
                    <div class="flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                        </svg>
                        <a href="tel:{{ company.phone }}" class="text-sm text-gray-700 hover:text-primary-600">{{ company.phone }}</a>
                        <button onclick="copyToClipboard('{{ company.phone }}', 'Telefon')"
                                class="text-gray-400 hover:text-primary-600 transition-colors" title="Kopieren">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                            </svg>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# -- Aufgaben Card -- #}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-gray-900">Aufgaben</h3>
                    <button onclick="openQuickAdd('aufgabe', {contact_id: '{{ contact.id }}', company_id: '{{ company.id }}'})"
                            class="text-xs text-primary-600 hover:text-primary-500 font-medium">
                        + Neue Aufgabe
                    </button>
                </div>
                <div class="p-5">
                    <div id="todos-container"
                         hx-get="/partials/contact/{{ contact.id }}/todos"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <p class="text-sm text-gray-400 animate-skeleton">Lade Aufgaben...</p>
                    </div>
                </div>
            </div>

            {# -- Details Card -- #}
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Details</h3>
                <dl class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <dt class="text-gray-500">Erstellt</dt>
                        <dd class="text-gray-900">{{ contact.created_at | datetime }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-500">Aktualisiert</dt>
                        <dd class="text-gray-900">{{ contact.updated_at | datetime }}</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-500">ID</dt>
                        <dd class="flex items-center gap-1.5">
                            <span class="text-gray-400 text-xs font-mono">{{ contact.id }}</span>
                            <button onclick="copyToClipboard('{{ contact.id }}', 'ID')"
                                    class="text-gray-400 hover:text-primary-600 transition-colors" title="ID kopieren">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                                </svg>
                            </button>
                        </dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CONTACT_ID = '{{ contact.id }}';
const COMPANY_ID = '{{ company.id }}';

// --- Contact Field Auto-Save ---
function saveContactField(field, value) {
    const data = {};
    data[field] = value || null;
    fetch(`/api/companies/contacts/${CONTACT_ID}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    }).then(() => {
        showToast('Gespeichert', 'success');
    }).catch(() => showToast('Fehler beim Speichern', 'error'));
}

// --- Call Notes ---
function toggleCallNoteForm() {
    const f = document.getElementById('call-note-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveCallNote() {
    const summary = document.getElementById('cn-summary').value;
    if (!summary) { showToast('Zusammenfassung erforderlich', 'error'); return; }
    const data = {
        contact_id: CONTACT_ID,
        company_id: COMPANY_ID,
        call_type: document.getElementById('cn-call-type').value,
        summary: summary,
        duration_minutes: parseInt(document.getElementById('cn-duration').value) || null,
        called_at: document.getElementById('cn-called-at').value || null,
    };
    fetch('/api/ats/call-notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    }).then(() => {
        showToast('Anruf gespeichert', 'success');
        toggleCallNoteForm();
        document.getElementById('cn-summary').value = '';
        document.getElementById('cn-duration').value = '';
        document.getElementById('cn-called-at').value = '';
        htmx.trigger('#call-notes-container', 'load');
    }).catch(() => showToast('Fehler', 'error'));
}

function deleteCallNote(noteId) {
    if (!confirm('Anruf loeschen?')) return;
    fetch(`/api/ats/call-notes/${noteId}`, { method: 'DELETE' })
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(() => { showToast('Geloescht', 'success'); htmx.trigger('#call-notes-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

// --- Correspondence ---
function toggleCorrForm() {
    const f = document.getElementById('corr-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function saveCorrespondence() {
    const subject = document.getElementById('corr-subject').value;
    if (!subject) { showToast('Betreff erforderlich', 'error'); return; }
    const data = {
        contact_id: CONTACT_ID,
        direction: document.getElementById('corr-direction').value,
        subject: subject,
        body: document.getElementById('corr-body').value || null,
        sent_at: document.getElementById('corr-sent-at').value || null,
    };
    fetch(`/api/companies/${COMPANY_ID}/correspondence`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    }).then(() => {
        showToast('Korrespondenz erstellt', 'success');
        toggleCorrForm();
        document.getElementById('corr-subject').value = '';
        document.getElementById('corr-body').value = '';
        document.getElementById('corr-sent-at').value = '';
        htmx.trigger('#correspondence-container', 'load');
    }).catch(() => showToast('Fehler', 'error'));
}

function deleteCorrespondence(corrId) {
    if (!confirm('Korrespondenz loeschen?')) return;
    fetch(`/api/companies/correspondence/${corrId}`, { method: 'DELETE' })
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(() => { showToast('Geloescht', 'success'); htmx.trigger('#correspondence-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}

// --- Todos ---
function deleteTodo(todoId) {
    if (!confirm('Aufgabe loeschen?')) return;
    fetch(`/api/ats/todos/${todoId}`, { method: 'DELETE' })
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(() => { showToast('Geloescht', 'success'); htmx.trigger('#todos-container', 'load'); })
        .catch(() => showToast('Fehler', 'error'));
}
</script>
{% endblock %}
